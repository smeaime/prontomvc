//   http://blogs.msdn.com/b/stuartleeks/archive/2012/04/23/asp-net-mvc-amp-jquery-ui-autocomplete.aspx

//$(document).ready(function () {
//    $('*[data-autocomplete-url]')
//                        .each(function () {
//                            $(this).autocomplete({
//                                source: $(this).data("autocomplete-url")
//                            });
//                        });
//});


"use strict";



////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// formatter generico para columnas SI / NO

// http://www.trirand.com/blog/?page_id=393/help/checkbox-formatting-and-editing

jQuery.extend($.fn.fmatter, {
    SiNoFormatter: function (cellvalue, options, rowdata) {


        var checked;

        //if (cellvalue == undefined) cellvalue = "False";

        switch (cellvalue) {
            case "True":
            case "SI":
                checked = "checked='checked' ";

            case "False":
            case "NO":
                checked = "";
            default:
                checked = "";
        }

        //var checked = cellvalue != 'N' ? "checked='checked' " : "";
        rtn = "<input type='checkbox' onclick=\"ajaxSaveUsers('" + options.rowId + "','" + options.colModel.name + "');\" " + checked + " value='" + cellvalue + "' />";
        return rtn;



    }
});
jQuery.extend($.fn.fmatter.SiNoFormatter, {
    unformat: function (cellvalue, options) {

        switch (cellvalue) {
            case "True":
            case "SI":
                return "SI";

            case "False":
            case "NO":
                return "NO";
            default:
                return "NO";
        }


    }
});








// http://www.trirand.com/blog/?page_id=393/help/problems-with-custom-checkbox-formatter

jQuery.extend($.fn.fmatter, {
    mycheckbox: function (cellvalue, options, rowobject) {
        var checked = cellvalue == '2' ? "checked='checked' " : "";
        var disabled = cellvalue == '0' ? "disabled='disabled' " : "";
        //  rtn = "<input type='checkbox' onclick="mychkclick('" + options.rowId + "','" + options.colModel.name + "');" " + checked + disabled + "value='"+ cellvalue+ "' />";
        return rtn;
    }
});

jQuery.extend($.fn.fmatter.mycheckbox, {
    unformat: function (cellvalue, options, cellobject) {
        var checked = $(cellobject).html().indexOf("checked", 0) != -1 ? "2" : "1";
        return checked;
    }
});

function mychkclick(rowid, colid) {
    val = $("#list4").getCell(rowid, colid);
    newValue = "1";
    if (val == "1") newValue = "2";
    $("#list4").setCell(rowid, colid, newValue);
    val = $("#list4").getCell(rowid, colid);
}
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////







function initDateEdit(elem) {
    setTimeout(function () {
        $(elem).datepicker({
            dateFormat: 'dd/mm/yy',
            autoSize: true,
            showOn: 'button', // it dosn't work in searching dialog
            changeYear: true,
            changeMonth: true,
            showButtonPanel: true,
            showWeek: true
        });
        //$(elem).focus();
    }, 100);
};


function getColumnIndexByName(grid, columnName) {
    var cm = grid.jqGrid('getGridParam', 'colModel'), i, l = cm.length;
    for (i = 0; i < l; i++) {
        if (cm[i].name === columnName) {
            return i; // return the index
        }
    }
    return -1;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//funciones para el Layout
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function panelWestResize() {
    $("#addtree").jqGrid('setGridWidth', pageLayout.west.state.innerWidth - 0, true);
}

function RefrescaAnchoJqgrids() {
    //return;
    // usada por el layout

    // http://stackoverflow.com/questions/875225/resize-jqgrid-when-browser-is-resized

    //poner fijo el ancho de la izquierda por ahora
    //pageLayout.sizePane("west", 190);


    var grid = jQuery("#Lista");


    if (true) {
        //if ($("#panelOeste").css('width')<MARGENLOGO+20)  $("#panelOeste").css('width',MARGENLOGO+20)


        $("#LogoEmpresa").css('width', parseInt($("#panelOeste").css('width')) - MARGENLOGO);
        //$("#SuperBuscador2").show();
    }


    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    // este es el codigo que actualiza (muy tarde) el ancho del arbolito
    /////////////////////////////////////////////////////////////////////////////////////////////////
    // if (grid = $('.ui-jqgrid-btable:visible')) {
    if (grid = $('.ui-jqgrid-btable')) { // le quité el visible para que tambien trabaje sobre el tab que todavía no saltó a la pantalla
        grid.each(function (index) {
            var gridId = $(this).attr('id');
            var gridParentWidth = $('#gbox_' + gridId).parent().width();
            $('#' + gridId).setGridWidth(gridParentWidth);

            //en cuanto a la altura: http://stackoverflow.com/questions/3203402/jqgrid-set-row-height/3204842#3204842

            //                    var height = $('#gbox_' + gridId).parent().height();
            //                    $('#' + gridId).setGridHeight(height);

            //                    jQuery("table.ui-jqgrid-htable", jQuery("#gview_list")).css("height", 30);


            //                    var grid = $("#lista");
            //                    var ids = grid.getDataIDs();
            //                    for (var i = 0; i < ids.length; i++) {
            //                        grid.setRowData(ids[i], false, { height: 20 + i * 2 });
            //                    }
        });
    }
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////


    searchBoxAncho();

}


function PopupCentrar() {
    var grid = $("#Lista");

    //return ;
    var dlgDiv = $("#editmod" + grid[0].id);

    $("#editmod" + grid[0].id).find('.ui-datepicker-trigger').attr("class", "btn btn-primary");

    //            $("#editmod" + grid[0].id + " [type=button]").attr("class", "btn btn-primary");
    //            $(":button").attr("class", "btn btn-primary");
    $("#editmod" + grid[0].id).find('#FechaEntrega').width(160);

    $("#editmod" + grid[0].id).find('.ui-datepicker-trigger').attr("class", "btn btn-primary");
    $("#sData").attr("class", "btn btn-primary");
    $("#sData").css("color", "white");
    $("#sData").css("margin-right", "20px");
    $("#cData").attr("class", "btn");

    //            $("#editmod" + grid[0].id).find(":hr").remove();

    $("#editmod" + grid[0].id).find('.ui-icon-disk').remove();
    $("#editmod" + grid[0].id).find('.ui-icon-close').remove();

    //                    $("#sData").addClass("btn");
    //                    $("#cData").addClass("btn");


    var parentDiv = dlgDiv.parent(); // div#gbox_list
    var dlgWidth = dlgDiv.width();
    var parentWidth = parentDiv.width();
    var dlgHeight = dlgDiv.height();
    var parentHeight = parentDiv.height();

    var left = (screen.width / 2) - (dlgWidth / 2) + "px";
    var top = ((screen.height / 2) - (dlgHeight / 2) + 50) + "px";

    dlgDiv[0].style.top = top; // 500; // Math.round((parentHeight - dlgHeight) / 2) + "px";
    dlgDiv[0].style.left = left; //Math.round((parentWidth - dlgWidth) / 2) + "px";

}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// en este pedazo suelto, se carga el popup de aprobo con la lista de usuarios
function CargarEmpleadosParaAprobar(fcallback) {
    $.post(ROOT + 'Empleado/EmpleadosParaCombo/',
                function (data) {
                    var select = $('#mySelect').empty();
                    for (var i = 0; i < data.length; i++) {
                        select.append('<option value="' + data[i].IdEmpleado + '">' + data[i].Nombre + '</option>');
                    }

                    if (typeof fcallback == "function") fcallback(); //


                }, "json");
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function TodaLaGrillaEnEditMode(grilla) {
    var $this = $(grilla), rows = grilla.rows, l = rows.length, i, row;
    for (i = 0; i < l; i++) {
        row = rows[i];
        if ($.inArray('jqgrow', row.className.split(' ')) >= 0) {
            $this.jqGrid('editRow', row.id, true);
        }
    }
}

function sacarDeEditMode2(grilla) {
    var r, c;
  

    for (r = 0; r < grilla.rows.length; c++) {
        for (c = 0; c < l; c++) {
            grilla.jqGrid('saveCell', r, c);
        }
    }

}

function sacarDeEditMode() {

    // grabando o deshaciendo???
    jQuery('#Lista').jqGrid('restoreCell', lastRowIndex, lastColIndex, true);
    //jQuery('#Lista').jqGrid('saveCell', lastRowIndex, lastColIndex);

    // jQuery('#Lista').jqGrid('editCell', lastRowIndex, lastColIndex);
    // jQuery('#Lista').jqGrid("setCell", rowid, "amount", val, "");



    //         var ids = $('#Lista').getDataIDs();
    //        for (var i = 0, il = ids.length; i < il; i++) {
    //            $('#Lista').jqGrid('restoreRow', ids[i]);

    //        }



    //        var $this = $('#Lista'), ids = $this.jqGrid('getDataIDs'), i, l = ids.length;
    //        for (i = l - 1; i >= 0; i--) {
    //                $('#Lista').jqGrid('restoreRow', ids[i]);
    //        }


}



function RefrescaAnchoGrillaDetalle() {
    // $("#Lista").setGridWidth($(window).width());
    // la zona de drop se te complica si estas arrastrando un renglon muy largo de una grilla ancha sobre una grilla angosta

    $("#Lista").setGridWidth($("#divGrilla").width());

    //        $("#ListaDrag").setGridWidth(jQuery("#ListaDrag").parent().width());
    //        $("#ListaDrag2").setGridWidth(jQuery("#ListaDrag").parent().width());
}



function ReajustarAlto(g) {

    var rows = g.getGridParam("reccount");

    g.jqGrid('setGridHeight', Math.max(140, rows * 45), true);
    //if (rows >= 4) g.jqGrid('setGridHeight', rows * 40, true);

}





function QuitarRenglonDragDrop(idazar, getdata) {
    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////



    ///////////////
    // paso 1: borrar el renglon vacío de yapa que agrega el D&D (pero no el dblClick) -pero cómo sabés que estás en modo D&D?
    ///////////////
    var segundorenglon = $($("#Lista")[0].rows[1]).attr("id")
    // var segundorenglon = $($("#Lista")[0].rows[pos+2]).attr("id") // el segundo renglon
    //alert(segundorenglon);
    if (segundorenglon != undefined) {
        if (segundorenglon.indexOf("dnd") != -1) {
            // tiró el renglon en modo dragdrop, no hizo dobleclic
            $("#Lista").jqGrid('delRowData', segundorenglon);
        }
    }
    //var dataIds = $('#Lista').jqGrid('getDataIDs'); // me traigo los datos
    //var data = $('#Lista').jqGrid('getRowData', dataIds[1]);


    ///////////////
    // paso 2: agregar en el ultimo lugar antes de los renglones vacios
    ///////////////

    //acá hay un problemilla... si el tipo está usando el DnD, se crea un renglon libre arriba de todo...

    var pos = TraerPosicionLibre();
    if (pos == null) {
        $("#Lista").jqGrid('addRowData', idazar, getdata, "first")
    }
    else {
        $("#Lista").jqGrid('addRowData', idazar, getdata, "after", pos); // como hago para escribir en el primer renglon usando 'after'? paso null?
    }
    //$("#Lista").jqGrid('addRowData', idazar, getdata, "last");
    // http: //stackoverflow.com/questions/8517988/how-to-add-new-row-in-jqgrid-in-middle-of-grid
    // $("#Lista").jqGrid('addRowData', grid, getdata, 'first');  // usar por ahora 'first'   'after' : 'before'; 'last' : 'first';

    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////

}


function TraerPosicionLibre() {
    //acá hay un problemilla... si el tipo está usando el DnD, se crea un renglon libre arriba de todo... Y usando solo click, no.

    var grid = jQuery("#Lista")
    var rows = $("#Lista").getGridParam("reccount");
    var dataIds = $('#Lista').jqGrid('getDataIDs');
    for (var i = 0; i < dataIds.length; i++) {

        var data = $('#Lista').jqGrid('getRowData', dataIds[i]);


        var desc = data['Descripcion'];
        // alert(desc);
        if (desc == "") break;


    }

    if (i == 0) return null;
    if (i == dataIds.length) i = dataIds.length - 1;

    return $($("#Lista")[0].rows[i]).attr("id");

}


function ProximoNumeroItem() {
    //  return jQuery("#Lista").jqGrid('getGridParam', 'records')   + 1;

    var totalCantidad = jQuery("#Lista").jqGrid('getCol', 'NumeroItem', false, 'max')
    return (totalCantidad || 0) + 1;
}



function searchBoxAncho() {
    // http://stackoverflow.com/questions/5688158/possible-to-make-jqgrid-search-box-stay-on-page

    var grid = $("#ListaDrag");

    // find the div which contain the searching dialog
    var searchDialog = $("#fbox_" + grid[0].id);

    // make the searching dialog non-popup
    searchDialog.css({ "width": "500px" });


    /*
    You can see the results live here. To make away the border over the searching dialog and grid you can do additionally the following:

    searchDialog.addClass("ui-jqgrid ui-widget ui-widget-content ui-corner-all");
    searchDialog.css({position:"relative", "z-index":"auto", float:"left"})
    var gbox = $("#gbox_"+grid[0].id);
    gbox.before(searchDialog);
    gbox.css({clear:"left"});
    */

    searchDialog = $("#searchmodfbox_ListaDrag");
    searchDialog.css({ "width": "500px" });




}



function AgregarRenglonesEnBlanco(renglonVacio, nombregrilla) {


    nombregrilla = nombregrilla || "#Lista";
    var grid = jQuery(nombregrilla)
    var pageSize = parseInt(grid.jqGrid("getGridParam", "rowNum"))

    var rows = grid.getGridParam("reccount") || 0;


    // jQuery("#Lista").jqGrid('getGridParam', 'records')
    var emptyRows;       // -data.rows.length; // pageSize - data.rows.length;

    //alert(rows)
    if (rows < 3) emptyRows = 3 - rows;
    else emptyRows = 1;


    //pasa q tengo q ver cuántos de los renglones existentes ya están vacíos!!!
    //pasa q tengo q ver cuántos de los renglones existentes ya están vacíos!!!
    //pasa q tengo q ver cuántos de los renglones existentes ya están vacíos!!!
    //pasa q tengo q ver cuántos de los renglones existentes ya están vacíos!!!
    //pasa q tengo q ver cuántos de los renglones existentes ya están vacíos!!!

    var rowsLlenas = 0;

    var dataIds = grid.jqGrid('getDataIDs');
    for (var i = 0; i < dataIds.length; i++) {

        var data = grid.jqGrid('getRowData', dataIds[i]);


        var desc = data['Descripcion'];
        if (desc==undefined)  desc = data['Cuenta'];
        // alert(desc);
        if (desc == "" || desc == undefined) continue;

        if (data['NumeroItem'] == "") {
            data['NumeroItem'] = ProximoNumeroItem();
            grid.jqGrid('setRowData', dataIds[i], data);
        }

        rowsLlenas++;
    }




    // alert(rowsLlenas);
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////


    if (!renglonVacio) {
        //    alert('ssss');
        renglonVacio = {};
    }


    var gridceil

    if (emptyRows > 0 && (rowsLlenas == rows || rows < 3)) {
        //   alert(emptyRows);
        for (var i = 1; i <= emptyRows; i++) {
            //                    // adjust the counts at lower right
            //                    grid.jqGrid("setGridParam", {
            //                        reccount: grid.jqGrid("getGridParam", "reccount") - emptyRows,
            //                        records: grid.jqGrid("getGridParam", "records") - emptyRows
            //                    });
            //                    grid[0].updatepager();




            // grid.jqGrid("addRowData", "empty_" + i, {});



            gridceil = Math.ceil(Math.random() * 1000000); // ojo con esto, si usas el mismo id, la edicion de un renglon se va a pasar a otro al instante!, y no vas a entender q está pasando 


            grid.jqGrid("addRowData", "empty_" + gridceil, renglonVacio);
            //  grid.jqGrid("addRowData", "empty_" + i, { "IdDetalleComprobanteProveedor": "0", "IdCuenta": "0", "Precio": "0", "Descripcion": "" });

        }

    }
    rows = grid.getGridParam("reccount");


    //alert(rows);

   //grid.jqGrid('setGridHeight', Math.max(140, rows * 45), true);

    ReajustarAlto(grid)
}





function padLeft(nr, n, str) {
    return Array(n - String(nr).length + 1).join(str || '0') + nr;
}
//or as a Number prototype method:
Number.prototype.padLeft = function (n, str) {
    return Array(n - String(this).length + 1).join(str || '0') + this;
}
//examples
//console.log(padLeft(23, 5));       //=> '00023'
//console.log((23).padLeft(5));     //=> '00023'
//console.log((23).padLeft(5, ' ')); //=> '   23'
//console.log(padLeft(23, 5, '>>'));  //=> '>>>>>>23'




function escapeRegExp(str) {
    return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}

function replaceAll(find, replace, str) {
    return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
}


//$(document).ready(function () {


function formatNumber(cellvalue, options, rowObject) {
    return cellvalue.replace(".", ",");
}


function unformatNumber(cellvalue, options, rowObject) {
    return cellvalue.replace(",", ".");
}
//});




function numUnformat(cellvalue, options, rowObject) {
    try {
        return cellvalue.replace(",", ".");
    } catch (e) {
        return 0;
    }

}

function numFormat(cellvalue, options, rowObject) {
    try {
        return cellvalue.replace(".", ",");
    } catch (e) {
        return 0;
    }

}





function roundNumber(number, digits) {
    var multiple = Math.pow(10, digits);
    var rndedNum = Math.round(number * multiple) / multiple;
    return rndedNum;
}


function strpad00(s) {
    s = s + '';
    if (s.length === 1) s = '0' + s;
    return s;
}


function FechaIngles(f) {
    var s = $.datepicker.formatDate("yy/mm/dd", $.datepicker.parseDate("dd/mm/yy", f));
    return s;
}



















//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function ShowProgressAnimation() {
    var pleaseWaitDialog = $("#progress").dialog(
    {
        resizable: false,
        height: 'auto',
        width: 150,
        modal: true,
        closeText: '',
        bgiframe: true,
        closeOnEscape: false,
        open: function (type, data) {
            $(this).parent().appendTo($("form:first"));
            $('body').css('overflow', 'auto'); //IE scrollbar fix for long checklist templates
        }
    });
}

/////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////


function LogJavaScript(s, e) {
    $.post(ROOT + "Error/JSErrorHandler", { msg: s + e.message });

}

$(function () {


    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // control de errores
    // http://kitsula.com/Article/MVC-Handling-and-logging-JavaScript-errors
    // http://stackoverflow.com/questions/951791/javascript-global-error-handling
    // http://stackoverflow.com/questions/1171035/asp-net-mvc-custom-error-handling-application-error-global-asax
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////


    // JS stacktraces. The good, the bad, and the ugly.  https://bugsnag.com/blog/js-stacktraces/
    // http://stackoverflow.com/questions/17687410/when-will-proper-stack-traces-be-provided-on-window-onerror-function

    /// JSErrorHandler.js
    // JS error handler





    window.onerror = function (message, file, line, column, errorObj) {


        //qué hacer con los casos de “Script Error.”???? http://danlimerick.wordpress.com/2014/01/18/how-to-catch-javascript-errors-with-window-onerror-even-on-chrome-and-firefox/
        //usar crossorigin
        // -pero no es tan simple http://stackoverflow.com/questions/14124940/how-to-see-what-is-returned-when-a-remote-script-is-blocked?lq=1
        //Cryptic “Script Error.” reported in Javascript in Chrome and Firefox

        //Firefox and Chrome will for security reasons not report exceptions from scripts that are of a different origin. All you get is a cryptic “Script Error.” and nothing else. Totally useless. 
        //Solving the Cryptic “Script Error.”

        //The latest versions of Chrome (see point 3 in the linked post) and Firefox have now provided a way to allow reporting of exceptions from CDNs.

        //There are two steps to be taken to get it working:




        var stack = "";
        if (errorObj !== undefined) //so it won't blow up in the rest of the browsers
        {
            if (errorObj != null) {
                stack = errorObj.stack;
            }
        }


        // alert("linea " + line + " " + file + "     " + message + " stack:" + stack);



        if (encodeURIComponent) {
            return loadXMLDoc(ROOT + "Error/JSErrorHandler", "msg=" + encodeURIComponent(message + " stack:" + stack) + '&url=' + encodeURIComponent(file) + "&line=" + line);
        }
        else {


            return false;
        }
    };













    // Ajax request
    function loadXMLDoc(url, params) {
        var req;
        if (window.XMLHttpRequest) {
            try {
                req = new XMLHttpRequest();
            } catch (e) {
                req = false;
            }
        } else
            if (window.ActiveXObject) {
                try {
                    req = new ActiveXObject("Msxml2.XMLHTTP");
                } catch (e) {
                    try {
                        req = new ActiveXObject("Microsoft.XMLHTTP");
                    } catch (e) {
                        req = false;
                    }
                }
            }

        if (req) {
            req.open("POST", url, true);
            req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            req.send(params);
            return true;
        }
        return false;
    }




    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////////////////




    //    http://stackoverflow.com/questions/1184624/convert-form-data-to-js-object-with-jquery
    // esta funcion es grosa, la unica que encontré que arrancase

    $.fn.serializeObject = function () {

        // si no anda, verificá que el form está declarado con:
        //  @using (Html.BeginForm(null, null, FormMethod.Post, new { id = "formid" }))
        // y no con un tag <form>

        //no funciona con lo oculto (por ejemplo, lo que no está en el tab seleccionado!)
        // Be warned, serializeArray() will not include disabled elements. I often disable input elements that are 
        // sync'd to other elements on the page, but I still want them included in my serialized object. You're 
        //better off using something like $.map( $("#container :input"), function(n, i) { /* n.name and $(n).val() */ } ); 
        // if you need to include disabled elements. – Samuel Meacham Jul 18 '10 at 23:54


        var self = this,
                json = {},
                push_counters = {},
                patterns = {
                    "validate": /^[a-zA-Z][a-zA-Z0-9_]*(?:\[(?:\d*|[a-zA-Z0-9_]+)\])*$/,
                    "key": /[a-zA-Z0-9_]+|(?=\[\])/g,
                    "push": /^$/,
                    "fixed": /^\d+$/,
                    "named": /^[a-zA-Z0-9_]+$/
                };


        this.build = function (base, key, value) {
            base[key] = value;
            return base;
        };

        this.push_counter = function (key) {
            if (push_counters[key] === undefined) {
                push_counters[key] = 0;
            }
            return push_counters[key]++;
        };

        $.each($(this).serializeArray(), function () {

            // skip invalid keys
            if (!patterns.validate.test(this.name)) {
                return;
            }

            var k,
                    keys = this.name.match(patterns.key),
                    merge = this.value,
                    reverse_key = this.name;

            while ((k = keys.pop()) !== undefined) {

                // adjust reverse_key
                reverse_key = reverse_key.replace(new RegExp("\\[" + k + "\\]$"), '');

                // push
                if (k.match(patterns.push)) {
                    merge = self.build([], self.push_counter(reverse_key), merge);
                }

                    // fixed
                else if (k.match(patterns.fixed)) {
                    merge = self.build([], k, merge);
                }

                    // named
                else if (k.match(patterns.named)) {
                    merge = self.build({}, k, merge);
                }
            }

            json = $.extend(true, json, merge);
        });

        return json;
    };
});




/////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

// para grabar el ultimo estado de los paneles colapsables
// http: //stackoverflow.com/questions/13720623/save-to-localstorage-using-twitter-bootstrap


// http: //stackoverflow.com/questions/10523433/how-do-i-keep-the-current-tab-active-with-twitter-bootstrap-after-a-page-reload
$(function () {
    $('a[data-toggle="tab"]').on('shown', function (e) {
        //save the latest tab; use cookies if you like 'em better:
        localStorage.setItem('lastTab', $(e.target).attr('id'));
    });

    //go to the latest tab, if it exists:
    var lastTab = localStorage.getItem('lastTab');
    if (lastTab) {
        $('#' + lastTab).tab('show');
    }

});






function cargarTopPositionDelArbol() {
    //$.removeCookie('scroll');
    if ($.cookie("scroll") !== null) {
        jQuery("#addtree").closest(".ui-jqgrid-bdiv").scrollTop($.cookie("scroll"))
    }
}

function guardarTopPositionDelArbol() {

    //$.cookie("scroll", null);
    //$.removeCookie('scroll');

    //I just had the same problem. I fixed it by always specifying the path when writing the cookie.
    // http://stackoverflow.com/questions/9326620/jquery-cookie-path
    $.cookie("scroll", jQuery("#addtree").closest(".ui-jqgrid-bdiv").scrollTop(), { path: '/' });
    //console.error($.cookie("scroll"));

}

$(function () {
    //config.defaults = { path: '/' };

    // http: //stackoverflow.com/questions/875225/resize-jqgrid-when-browser-is-resized
    // http: //stackoverflow.com/questions/7745009/in-jqgrid-is-it-possible-to-resize-columns-to-fit-the-table-width-original-wid
    // http: //stackoverflow.com/questions/3906300/jqgrid-and-the-autowidth-option-how-does-it-works



    $(window).bind('resize', function () {
        //$("#Lista").setGridWidth($(window).width());
        $("#Lista").jqGrid('setGridWidth', $(window).width());
        // $("#Lista").jqGrid('setGridHeight', $(window).height()-250); // me mata en las grillas de detalle

        //jQuery("#addtree").jqGrid('setGridHeight', 600);
        $("#addtree").jqGrid('setGridHeight', $(window).height() - 150);
        $("#addtree2").jqGrid('setGridHeight', $(window).height() - 250);



    }).trigger('resize');



    //////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////
    //http://stackoverflow.com/questions/18927301/using-jquery-to-store-scroll-position-works-well-how-do-i-allow-only-for-refre
    // If cookie is set, scroll to the position saved in the cookie.
    if ($.cookie("scroll") !== null) {


        cargarTopPositionDelArbol();

        //alert('algo');
    }
    else {

        //alert('nada')
    }

    // When a button is clicked...
    $(':submit').on("click", function () {

        // guardarTopPositionDelArbol();

    });

    window.onbeforeunload = function (e) {
        guardarTopPositionDelArbol();
    }


    //////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////








    function resizeLista() {
        var myGrid = $("#Lista");
        width = myGrid.jqGrid('getGridParam', 'width'); // get current width
        myGrid.jqGrid('setGridWidth', width, true);

    }







});



$(function () {

    //jQuery("#Lista").jqGrid('bindKeys');
});


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



function GrabarGrillaLocal() {



    var $this = $('#Lista')
    var ids = $this.jqGrid('getDataIDs'), i, l = ids.length;

    for (i = 0; i < l; i++) {
        try {
            var rowdata = $('#Lista').jqGrid('saveRow', ids[i]);
        } catch (e) {
            $('#Lista').jqGrid('restoreRow', ids[i]);
            continue;
        }
    }
}




///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



function PonerRenglonesInline() {
    return;


    saveparameters = {
        "successfunc": null,
        "url": 'clientArray',
        "extraparam": {},
        "aftersavefunc": function (response) {
            // alert('saved');
        },
        "errorfunc": function (response) {
            alert('errorfunc');
        },
        "afterrestorefunc": function (response) {
            alert('afterrestorefunc');
        },
        "restoreAfterError": true,
        "mtype": "POST"
    }



    var $this = $('#Lista'), ids = $this.jqGrid('getDataIDs'), i, l = ids.length;
    for (i = l - 1; i >= 0; i--) {
        try {
            var rowdata = $('#Lista').jqGrid('getRowData', ids[i]);
            if (!rowdata.IdArticulo) {
                $('#Lista').jqGrid('restoreRow', ids[i]);
                continue;
            }


            $('#Lista').jqGrid('saveRow', ids[i], saveparameters);
        } catch (e) {
            $('#Lista').jqGrid('restoreRow', ids[i]);
            continue;
        }
        $('#Lista').jqGrid('editRow', ids[i], true);
    }
}






/*
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
*/
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function validatePwd() {
    var pass = $("#password").val();
    //var idusuario = $("#Aux1").val();
    var idusuario = $("#mySelect").val();

    if ($.isNumeric(idusuario)) {

        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: ROOT + 'Empleado/BuscarPass/',
            data: { id: idusuario, pass: pass },
            dataType: "text",
            success: function (data) {

                var combo = $("#Aux0").val();
                var post = $("#Aux10").val();

                if (post == "anularPED") {
                    //alert('eee');
                    //$('#anular2').click();
                    // $("#MotivoAnulacion").val(motivo);
                    //$("#FechaAnulacion").val(Fecha);
                    // $("#Cumplido").val("AN");

                    window.location.href = ROOT + 'Pedido/Anular/' + $("#IdPedido").val();


                    // $.post(  ROOT + 'Pedido/Anular/', href= "Url.Action("Anular", new { id = $("IdPedido") Model.IdPedido })"
                    //                                                       type: "GET",
                    //                    contentType: "application/json; charset=utf-8",
                    //                    url: ROOT + 'Empleado/BuscarPass/',
                    //                    data: { id: idusuario, pass: pass },
                    //                    dataType: "text",

                }

                else if (data.length > 0) {
                    //$("#usuario").html(data);
                    var idusuario = $("#Aux1").val();

                    $('#' + combo).val(idusuario);
                    $("#Aux3").val(idusuario);
                    if (post == "anularRM") {
                        $("#UsuarioAnulacion").val(idusuario);
                        $('#dialog-motivo').dialog('open');
                    }



                    // si usás una funcion de callback, pasale los parametros. Quiero decir: que el dialog no tenga que saber cómo implementarla!
                    // http://stackoverflow.com/questions/939032/jquery-pass-more-parameters-into-callback

                    GrabarFirma();

                    // esperar hasta que vuelva para habilitar la pantalla


                }
                else {
                    alert('Password incorrecta');
                    //jAlert('Password incorrecta', 'Usuarios');
                    $('#' + combo).val("");
                    $("#Aux3").val("");
                }
            }

        });


        //alert('ok');
    }
    else {
        alert('error usuario ' + idusuario);
    }

    $("#dialog-password").dialog('close');
}



function validatePwd2(fCallbackEnExito, fCallbackRechazada) {
    // http://stackoverflow.com/questions/1031674/how-do-i-write-a-jquery-function-that-accepts-a-callback-as-a-parameter
    // http://stackoverflow.com/questions/1031674/how-do-i-write-a-jquery-function-that-accepts-a-callback-as-a-parameter
    // http://stackoverflow.com/questions/1031674/how-do-i-write-a-jquery-function-that-accepts-a-callback-as-a-parameter
    // http://stackoverflow.com/questions/1031674/how-do-i-write-a-jquery-function-that-accepts-a-callback-as-a-parameter
    // http://stackoverflow.com/questions/1031674/how-do-i-write-a-jquery-function-that-accepts-a-callback-as-a-parameter

    var pass = $("#password").val();
    //var idusuario = $("#Aux1").val();
    var idusuario = $("#mySelect").val();

    $("#dialog-password").dialog('close');




    if ($.isNumeric(idusuario)) {

        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: ROOT + 'Empleado/BuscarPass/',
            data: { id: idusuario, pass: pass },
            dataType: "text",
            success: function (data) {


                if (data != "") {
                    var combo = $("#Aux0").val();
                    var post = $("#Aux10").val();

                    // alert("exito, se ejecutará el callback");

                    if (typeof fCallbackEnExito == "function") fCallbackEnExito(); else alert('No se pasó el callback!');
                    return true; // tiene sentido devolver algo en una funcion asíncrona?
                    // ademas, todo lo que hiciese esa funcion debiera ser revalidado: por ejemplo, si llama al método Anular, le debe pasar como parametros la contraseña 
                    // -pero entonces por qué no hacés la validacion de la contraseña solo en la llamada del método? 

                }
                else {
                    if (typeof fCallbackRechazada == "function") fCallbackRechazada(); //
                    return false;
                }

            },
            error: function (data) {
                if (typeof fCallbackRechazada == "function") fCallbackRechazada(); //
                return false;
            }
        });


        //alert('ok');
    }
    else {
        return false;
    }


}













//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function Moneda_Cotizacion(fecha, IdMoneda, funcioncallback) {
    if (IdMoneda != 1) {
        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: ROOT + 'Moneda/Moneda_Cotizacion',
            data: { fecha: fecha, IdMoneda: IdMoneda },
            dataType: "json",
            success: function (data) {
                if (data > 0) {
                    funcioncallback(data);
                }
                else {
                    funcioncallback(0);
                }
            }
        });
    }
    else {
        funcioncallback(1);
    }
}




$("#IdMoneda").change(function () {
    var fecha = $("#FechaIngreso").val();
    var IdMoneda = $("#IdMoneda").val();
    if (IdMoneda != 1) {
        $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: ROOT + 'Moneda/Moneda_Cotizacion',
            data: { fecha: fecha, IdMoneda: IdMoneda },
            dataType: "json",
            success: function (data) {
                if (data > 0) {
                    var Cotizacion = data; // data[0]["Cotizacion"];
                    $("#CotizacionMoneda").val(Cotizacion);
                }
                else {
                    alert('No hay cotizacion');
                    $('#IdMoneda').val("");
                    $('#CotizacionMoneda').val("");
                }
            }
        });
    }
    else {
        $('#CotizacionMoneda').val("1");
    }
});
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////////










// http://stackoverflow.com/questions/538745/how-to-tell-if-a-script-tag-failed-to-load
//http://stackoverflow.com/questions/5683824/detect-and-log-when-external-javascript-or-css-resources-fail-to-load?lq=1

//function jsLoader() {
//    var o = this;

//    o.timer = function (t, i, d, f, fend, b) // simple unstopable repeat timer, when t=-1 means endless, when function f() returns true it can be stopped
//    {
//        if (t == -1 || t > 0)
//        { setTimeout(function () { b = (f()) ? 1 : 0; o.timer((b) ? 0 : (t > 0) ? --t : t, i + ((d) ? d : 0), d, f, fend, b); }, (b || i < 0) ? 0.1 : i); }
//        else if (typeof fend == 'function')
//        { setTimeout(fend, 1); }
//    };

//    o.addEvent = function (el, eventName, eventFunc) {
//        if (typeof el != 'object')
//        { return false; }

//        if (el.addEventListener) {
//            el.addEventListener(eventName, eventFunc, false);
//            return true;
//        }

//        if (el.attachEvent) {
//            el.attachEvent("on" + eventName, eventFunc);
//            return true;
//        }

//        return false;
//    };




//    o.require = function (s, delay, baSync, fCallback, fErr) // add script to dom
//    {
//        var oo = document.createElement('script'),
//     oHead = document.getElementsByTagName('head')[0];
//        if (!oHead)
//        { return false; }

//        setTimeout(function () {
//            var f = (typeof fCallback == 'function') ? fCallback : function () { };
//            fErr = (typeof fErr == 'function') ? fErr : function () { alert('require: Cannot load resource -' + s); },

//            fe = function () { if (!oo.__es) { oo.__es = true; oo.id = 'failed'; fErr(oo); } };

//            oo.onload = function () { oo.id = 'loaded'; f(oo); };
//            oo.type = 'text/javascript';
//            oo.async = (typeof baSync == 'boolean') ? baSync : false;
//            oo.charset = 'utf-8';
//            o.__es = false;
//            o.addEvent(oo, 'error', fe); // when supported
//            // when error event is not supported fall back to timer
//            o.timer(15, 1000, 0, function () { return (oo.id == 'loaded'); }, function () { if (oo.id != 'loaded') { fe(); } });
//            oo.src = s;
//            setTimeout(function () { try { oHead.appendChild(oo); } catch (e) { fe(); } }, 1);
//        }, (typeof delay == 'number') ? delay : 1);
//        return true;
//    };
//};





//$(document).ready(function () {
//    var ol = new jsLoader();
//    ol.require('myscript.js', 800, true, function () { alert('loaded'); }, function () { alert('NOT loaded'); });

//});




//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


$("#grabarNormal").click(function () {
    //  http://stackoverflow.com/questions/10744694/submitting-jqgrid-row-data-from-view-to-controller-what-method
    //  http://stackoverflow.com/questions/6798671/how-to-submit-local-jqgrid-data-and-form-input-elements?answertab=votes#tab-top


    var griddata = $("#Lista").jqGrid('getGridParam', 'data');
    var cabecera = $("#formid").serializeObject(); // .serializeArray(); // serializeArray 
    var name = "DetalleClientes";

    //  var aaa = $.toJSON(formdata);

    var fullData = jQuery("#Lista").jqGrid('getRowData');

    //        var gd = $('#ListaLugaresEntrega').jqGrid('getRowData'); // use preferred interface
    //        for (var i = 0; i < gd.length; ++i) {
    //            for (var f in gd[i]) res.push({ name: '_detail[' + i + '].' + f, value: gd[i][f] });
    //        }

    var grid1 = $("#Lista");
    var colModel = grid1.jqGrid('getGridParam', 'colModel');

    var items = [];

    // cabecera.DetalleFacturas = [];  // el array no existe en el objeto cabecera, lo anexo a lo bestia (ojo que, en verdad, sí hay uno, porque lo creé con HiddenFor)
    cabecera[name] = [];  // http://stackoverflow.com/questions/6302874/declare-variable-while-the-variable-name-is-a-string

    var dataIds = $('#Lista').jqGrid('getDataIDs');
    for (var i = 0; i < dataIds.length; i++) {
        try {
            $('#Lista').jqGrid('saveRow', dataIds[i], false, 'clientArray');
            var data = $('#Lista').jqGrid('getRowData', dataIds[i]);

            data1 = '{"IdFactura":"' + $("#IdFactura").val() + '",'
            for (var j = 0; j < colModel.length; j++) {
                cm = colModel[j]
                if (cm.label === 'TB') {
                    valor = data[cm.name];
                    if (cm.name === 'Cantidad') valor = valor.replace(".", ",")
                    data1 = data1 + '"' + cm.name + '":"' + valor + '",';
                }
            }
            data1 = data1.substring(0, data1.length - 1) + '}';
            data1 = data1.replace(/(\r\n|\n|\r)/gm, "");
            data2 = JSON.parse(data1);

            // items.push(data2);               
            cabecera.DetalleFacturas.push(data2);
        }
        catch (ex) {
            $('#Lista').jqGrid('restoreRow', dataIds[i]);
            alert("No se pudo grabar el comprobante. " + ex);
            return;
        }
    }


    var dataToSend = JSON.stringify(cabecera); // JSON.stringify(griddata);   JSON.parse() ;   $.toJSON();

    $.ajax({
        type: 'POST',
        // contentType: 'application/json; charset=utf-8',
        contentType: 'application/json; charset=utf-8', // http://stackoverflow.com/a/2281875/1054200
        url: ROOT + 'Factura/BatchUpdate',   // 'Factura/UpdateAwesomeGridData',
        dataType: 'json',
        // data:JSON.stringify( {formulario: colData , grilla: dataToSend })
        data: dataToSend,
        //  data: { "formulario": formdata ,"grilla": dataToSend }, // $.toJSON(griddata),
        success: function (result) {
            if (result.Success == 1) {
                $('#Lista').trigger('reloadGrid');
                window.location.replace(ROOT + "Factura/index");
            } else {
                alert('No se pudo grabar el comprobante. ' + result.ex);
            }
        },
        error: function (xhr, textStatus, exceptionThrown) {
            var errorData = $.parseJSON(xhr.responseText);
            var errorMessages = [];
            //this ugly loop is because List<> is serialized to an object instead of an array
            for (var key in errorData) {
                errorMessages.push(errorData[key]);
            }
            $('#result').html(errorMessages.join("<br />"));
            alert(errorMessages.join("<br />"));

        }
    });







});

/////////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////




function PedirFirma(o) {
    var idComparativa = o.attributes.value.nodeValue;


    $("#Aux10").val(idComparativa);

    if (false) {
        //  mientras no sepa cómo traerme los posibles firmantes sin pasar el Orden como parametro, usar el listado completo
        $.post(ROOT + 'Comparativa/Autorizaciones_TX_PorFormulario_Comparativa?idComparativa=' + idComparativa,
            function (data) {
                var select = $('#mySelect').empty();
                for (var i = 0; i < data.length; i++) {
                    select.append('<option value="' + data[i].IdEmpleado + '">' + data[i].Nombre + '</option>');
                }

                $("#mySelect").val(data[0].IdEmpleado);
                $("#Aux0").val(data[0].IdEmpleado);
            }, "json");

    }

    //$("#Aux0").val(data[0].IdEmpleado);
    //$("#Aux1").val(data[0].IdEmpleado);


    $('#dialog-password').dialog('open');


}

function PedirFirma2(IdFormulario, IdComprobante, IdAutorizacion, IdAutoriza) {
    //var idComparativa = o.attributes.value.nodeValue;


    // $("#Aux10").val(idComparativa);

    if (true) {
        //  mientras no sepa cómo traerme los posibles firmantes sin pasar el Orden como parametro, usar el listado completo
        $.post(ROOT + 'Autorizacion/Autorizaciones_TX_PorFormulario_Comparativa?IdComprobante=' + IdComprobante + "&IdFormulario=" + IdFormulario,
            function (data) {
                var select = $('#mySelect').empty();
                for (var i = 0; i < data.length; i++) {
                    select.append('<option value="' + data[i].IdEmpleado + '">' + data[i].Nombre + '</option>');
                }

                $("#mySelect").val(IdAutoriza);
                $("#Aux0").val(IdAutoriza);
            },
             "json");

    }

    //$("#Aux0").val(data[0].IdEmpleado);
    $("#Aux1").val(IdAutoriza);

    $("#Aux5").val(IdFormulario);
    $("#Aux2").val(IdComprobante);
    $("#Aux3").val(IdAutorizacion);


    $('#dialog-password').dialog('open');


}






//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

function GrabarFirma() {
    //alert('GrabarFirma');
    var idusuario = $("#mySelect").val();
    var idComparativa = $("#Aux10").val();
    //var idFormulario = 5; // ojo q es diferente q IdFormulario


    var idFormulario = $("#Aux5").val();
    var IdComprobante = $("#Aux2").val();
    var IdAutorizacion = $("#Aux3").val();
    var IdAutoriza = $("#Aux1").val();


    if ($.isNumeric(idusuario)) {

        //alert('Firmando...');


        if (!$.isNumeric(IdComprobante)) {
            idFormulario = 3; // alta de requerimiento, parche
            IdComprobante = -1;
        }


        var urlpath = ROOT + 'Autorizacion/Firmar' + '?idFormulario=' + idFormulario + '&IdComprobante=' + IdComprobante + '&OrdenAutorizacion=' + 1 + '&IdAutorizo=' + idusuario
        //alert(urlpath);
        //con $.post no me anduvo bien...

        // http: //stackoverflow.com/questions/9416556/jquery-how-to-disable-the-entire-page
        //ShowProgressAnimation();

        //        $("body").on({
        //            ajaxStart: function () {
        //                $(this).addClass("loading");
        //            },
        //            ajaxStop: function () {
        //                $(this).removeClass("loading");
        //            }
        //        });  


        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: urlpath,
            //            beforeSend: function () {
            //                $("#loading").show();
            //            },
            //            complete: function () {
            //                $("#loading").hide();
            //            },
            success: function (data) {
                //$("#Lista").trigger("reloadGrid")
                // alert('Firmado!');


            }
        });



    }
    else {
        // alert('No tengo los datos! ' + urlpath);
    }
}












//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
