VERSION 5.00
Object = "{831FDD16-0C5C-11D2-A9FC-0000F8754DA1}#2.0#0"; "MSCOMCTL.OCX"
Object = "{3B7C8863-D78F-101B-B9B5-04021C009402}#1.2#0"; "richtx32.ocx"
Object = "{86CF1D34-0C5F-11D2-A9FC-0000F8754DA1}#2.0#0"; "mscomct2.ocx"
Object = "{F0D2F211-CCB0-11D0-A316-00AA00688B10}#1.0#0"; "MSDATLST.OCX"
Object = "{12DE615C-8D4B-4936-8801-459AB2EAA3FC}#1.4#0"; "Controles1013.ocx"
Begin VB.Form frmFacturas 
   Caption         =   "Facturacion"
   ClientHeight    =   8445
   ClientLeft      =   60
   ClientTop       =   345
   ClientWidth     =   11880
   Icon            =   "frmFacturas.frx":0000
   LinkTopic       =   "Form1"
   ScaleHeight     =   148.961
   ScaleMode       =   0  'User
   ScaleWidth      =   209.55
   StartUpPosition =   2  'CenterScreen
   Begin VB.CommandButton cmd 
      BackColor       =   &H00C0C0FF&
      Caption         =   "Certificacion obra"
      CausesValidation=   0   'False
      Height          =   285
      Index           =   4
      Left            =   4140
      Style           =   1  'Graphical
      TabIndex        =   114
      Top             =   7830
      Width           =   1740
   End
   Begin VB.Frame Frame3 
      Caption         =   "Permiso de embarque :"
      Height          =   420
      Left            =   2700
      TabIndex        =   109
      Top             =   6930
      Width           =   1950
      Begin VB.OptionButton Option3 
         Caption         =   "NO"
         Height          =   195
         Index           =   1
         Left            =   900
         TabIndex        =   111
         Top             =   180
         Width           =   555
      End
      Begin VB.OptionButton Option3 
         Caption         =   "SI"
         Height          =   195
         Index           =   0
         Left            =   180
         TabIndex        =   110
         Top             =   180
         Width           =   465
      End
   End
   Begin VB.ComboBox Combo1 
      Height          =   315
      Index           =   0
      ItemData        =   "frmFacturas.frx":076A
      Left            =   945
      List            =   "frmFacturas.frx":0774
      TabIndex        =   107
      Top             =   6975
      Visible         =   0   'False
      Width           =   1680
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   12
      Left            =   10440
      TabIndex        =   106
      Top             =   6840
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.Frame Frame2 
      Caption         =   "Devolucion de anticipos : "
      Height          =   1095
      Left            =   5490
      TabIndex        =   96
      Top             =   6255
      Visible         =   0   'False
      Width           =   1950
      Begin VB.CheckBox Check5 
         Caption         =   "Aplicar devolucion"
         Height          =   195
         Left            =   180
         TabIndex        =   100
         Top             =   270
         Width           =   1635
      End
      Begin VB.CommandButton cmdDevolucionAnticipo 
         Caption         =   "Calcular devolucion"
         Height          =   240
         Left            =   135
         TabIndex        =   99
         Top             =   810
         Width           =   1680
      End
      Begin VB.TextBox txtPorcentajeDevolucionAnticipo 
         Alignment       =   2  'Center
         DataField       =   "PorcentajeDevolucionAnticipo"
         Enabled         =   0   'False
         Height          =   285
         Left            =   495
         TabIndex        =   98
         Top             =   495
         Width           =   1260
      End
      Begin VB.Label lblLabels 
         Caption         =   "% :"
         Height          =   195
         Index           =   13
         Left            =   135
         TabIndex        =   97
         Top             =   540
         Width           =   330
      End
   End
   Begin VB.CheckBox Check4 
      Alignment       =   1  'Right Justify
      Caption         =   "Contabilizar segun fecha de vencimiento : "
      Height          =   285
      Left            =   6300
      TabIndex        =   95
      Top             =   2925
      Visible         =   0   'False
      Width           =   3345
   End
   Begin VB.CheckBox Check3 
      Alignment       =   1  'Right Justify
      Caption         =   "Activar recupero de gastos"
      Height          =   420
      Left            =   4680
      TabIndex        =   92
      Top             =   2790
      Visible         =   0   'False
      Width           =   1545
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   11
      Left            =   10125
      TabIndex        =   90
      Top             =   6635
      Width           =   1455
   End
   Begin VB.CheckBox Check2 
      Alignment       =   1  'Right Justify
      Caption         =   "No incluir esta factura en cubos de venta :"
      Height          =   420
      Left            =   2745
      TabIndex        =   89
      Top             =   2790
      Visible         =   0   'False
      Width           =   1860
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   10
      Left            =   10125
      TabIndex        =   36
      Top             =   7460
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.CommandButton cmd 
      Caption         =   "Datos de exportacion"
      Enabled         =   0   'False
      Height          =   285
      Index           =   3
      Left            =   4140
      TabIndex        =   87
      Top             =   7470
      Width           =   1740
   End
   Begin VB.CheckBox Check1 
      Height          =   240
      Index           =   2
      Left            =   7830
      TabIndex        =   84
      Top             =   2565
      Width           =   195
   End
   Begin VB.CheckBox Check1 
      Height          =   240
      Index           =   1
      Left            =   7830
      TabIndex        =   81
      Top             =   2205
      Width           =   195
   End
   Begin VB.CommandButton cmdProvinciasDestino 
      Caption         =   "Distribuir IIBB x provincias"
      Height          =   645
      Left            =   10800
      TabIndex        =   79
      Top             =   2160
      Width           =   915
   End
   Begin VB.TextBox txtNumeroCertificadoPercepcionIIBB 
      Alignment       =   1  'Right Justify
      DataField       =   "NumeroCertificadoPercepcionIIBB"
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   300
      Left            =   5670
      TabIndex        =   75
      Top             =   5850
      Visible         =   0   'False
      Width           =   1815
   End
   Begin VB.CommandButton cmd 
      Caption         =   "Anular"
      Enabled         =   0   'False
      Height          =   645
      Index           =   2
      Left            =   3135
      TabIndex        =   72
      Top             =   7470
      Width           =   930
   End
   Begin VB.CheckBox Check1 
      Height          =   240
      Index           =   0
      Left            =   7830
      TabIndex        =   70
      Top             =   1845
      Width           =   195
   End
   Begin VB.TextBox txtCotizacionMoneda 
      Alignment       =   1  'Right Justify
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   300
      Left            =   4365
      TabIndex        =   64
      Top             =   5490
      Width           =   690
   End
   Begin VB.TextBox txtCotizacionDolar 
      Alignment       =   1  'Right Justify
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   315
      Left            =   6840
      TabIndex        =   63
      Top             =   5490
      Width           =   645
   End
   Begin VB.TextBox txtPorcentajeIva2 
      Alignment       =   1  'Right Justify
      Enabled         =   0   'False
      Height          =   270
      Left            =   7605
      TabIndex        =   60
      Top             =   5940
      Visible         =   0   'False
      Width           =   405
   End
   Begin VB.TextBox txtPorcentajeIva1 
      Alignment       =   1  'Right Justify
      Enabled         =   0   'False
      Height          =   270
      Left            =   9225
      TabIndex        =   58
      Top             =   6120
      Width           =   405
   End
   Begin RichTextLib.RichTextBox rchObservacionesItem 
      Height          =   375
      Left            =   7830
      TabIndex        =   57
      Top             =   7155
      Visible         =   0   'False
      Width           =   150
      _ExtentX        =   265
      _ExtentY        =   661
      _Version        =   393217
      Enabled         =   -1  'True
      TextRTF         =   $"frmFacturas.frx":078B
   End
   Begin VB.TextBox txtPorcentajeBonificacion 
      Alignment       =   1  'Right Justify
      Height          =   240
      Left            =   9225
      TabIndex        =   55
      Top             =   5850
      Width           =   405
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   9
      Left            =   10125
      TabIndex        =   53
      Top             =   5810
      Width           =   1455
   End
   Begin VB.CommandButton cmdImpre 
      Height          =   645
      Index           =   1
      Left            =   2565
      Picture         =   "frmFacturas.frx":0816
      Style           =   1  'Graphical
      TabIndex        =   52
      Top             =   7470
      Width           =   525
   End
   Begin VB.Frame Frame1 
      Caption         =   "Tipo de venta :"
      Enabled         =   0   'False
      Height          =   555
      Left            =   6165
      TabIndex        =   48
      Top             =   7425
      Visible         =   0   'False
      Width           =   1905
      Begin VB.OptionButton Option1 
         Caption         =   "Normal"
         Height          =   195
         Left            =   45
         TabIndex        =   50
         Top             =   270
         Width           =   915
      End
      Begin VB.OptionButton Option2 
         Caption         =   "Muestra"
         Height          =   195
         Left            =   1035
         TabIndex        =   49
         Top             =   270
         Width           =   960
      End
   End
   Begin VB.TextBox txtCotizacion 
      Alignment       =   1  'Right Justify
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Left            =   10935
      TabIndex        =   47
      Top             =   495
      Width           =   900
   End
   Begin VB.TextBox txtCodigoCliente 
      Alignment       =   1  'Right Justify
      Height          =   315
      Left            =   1485
      TabIndex        =   0
      Top             =   630
      Width           =   795
   End
   Begin VB.TextBox txtCondicionIva 
      Enabled         =   0   'False
      Height          =   330
      Left            =   7830
      TabIndex        =   43
      Top             =   555
      Width           =   2970
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   360
      Index           =   8
      Left            =   10125
      TabIndex        =   37
      Top             =   7740
      Width           =   1455
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   7
      Left            =   10125
      TabIndex        =   35
      Top             =   7185
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   6
      Left            =   10125
      TabIndex        =   34
      Top             =   6910
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   5
      Left            =   10125
      TabIndex        =   33
      Top             =   6360
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   4
      Left            =   10125
      TabIndex        =   32
      Top             =   6085
      Width           =   1455
   End
   Begin VB.TextBox txtZona 
      Enabled         =   0   'False
      Height          =   330
      Left            =   10395
      TabIndex        =   9
      Top             =   1305
      Width           =   1440
   End
   Begin VB.TextBox txtCodigoPostal 
      Enabled         =   0   'False
      Height          =   315
      Left            =   1485
      TabIndex        =   7
      Top             =   1350
      Width           =   1395
   End
   Begin VB.TextBox txtProvincia 
      Enabled         =   0   'False
      Height          =   315
      Left            =   1485
      TabIndex        =   6
      Top             =   1710
      Width           =   4095
   End
   Begin VB.TextBox txtLocalidad 
      Enabled         =   0   'False
      Height          =   315
      Left            =   2925
      TabIndex        =   5
      Top             =   1350
      Width           =   2655
   End
   Begin VB.TextBox txtDireccion 
      Enabled         =   0   'False
      Height          =   315
      Left            =   1485
      TabIndex        =   4
      Top             =   990
      Width           =   4095
   End
   Begin VB.TextBox txtNumeroFactura 
      Alignment       =   1  'Right Justify
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   330
      Left            =   2340
      TabIndex        =   2
      Top             =   180
      Width           =   1215
   End
   Begin VB.TextBox txtEmail 
      Enabled         =   0   'False
      Height          =   330
      Left            =   7830
      TabIndex        =   13
      Top             =   1305
      Width           =   1980
   End
   Begin VB.TextBox txtFax 
      Enabled         =   0   'False
      Height          =   330
      Left            =   10395
      TabIndex        =   12
      Top             =   945
      Width           =   1440
   End
   Begin VB.TextBox txtTelefono 
      Enabled         =   0   'False
      Height          =   330
      Left            =   7830
      TabIndex        =   11
      Top             =   930
      Width           =   1980
   End
   Begin VB.CommandButton cmdImpre 
      Height          =   645
      Index           =   0
      Left            =   1995
      Picture         =   "frmFacturas.frx":0DA0
      Style           =   1  'Graphical
      TabIndex        =   17
      Top             =   7470
      UseMaskColor    =   -1  'True
      Width           =   525
   End
   Begin VB.CommandButton cmd 
      Cancel          =   -1  'True
      Caption         =   "&Cancelar"
      CausesValidation=   0   'False
      Height          =   645
      Index           =   1
      Left            =   1020
      TabIndex        =   16
      Top             =   7470
      Width           =   930
   End
   Begin VB.CommandButton cmd 
      Caption         =   "&Aceptar"
      Height          =   645
      Index           =   0
      Left            =   45
      TabIndex        =   15
      Top             =   7470
      Width           =   930
   End
   Begin VB.TextBox txtTotal 
      Alignment       =   1  'Right Justify
      BackColor       =   &H00FFC0C0&
      BeginProperty DataFormat 
         Type            =   0
         Format          =   """$""#,##0.00"
         HaveTrueFalseNull=   0
         FirstDayOfWeek  =   0
         FirstWeekOfYear =   0
         LCID            =   1034
         SubFormatType   =   0
      EndProperty
      Enabled         =   0   'False
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   3
      Left            =   10125
      TabIndex        =   14
      Top             =   5535
      Width           =   1455
   End
   Begin MSComctlLib.StatusBar Estado 
      Align           =   2  'Align Bottom
      Height          =   285
      Left            =   0
      TabIndex        =   19
      Top             =   8160
      Width           =   11880
      _ExtentX        =   20955
      _ExtentY        =   503
      _Version        =   393216
      BeginProperty Panels {8E3867A5-8586-11D1-B16A-00C0F0283628} 
         NumPanels       =   1
         BeginProperty Panel1 {8E3867AB-8586-11D1-B16A-00C0F0283628} 
            Object.Width           =   3854
            MinWidth        =   3854
         EndProperty
      EndProperty
   End
   Begin MSComCtl2.DTPicker DTFields 
      DataField       =   "FechaFactura"
      Height          =   330
      Index           =   0
      Left            =   4365
      TabIndex        =   3
      Top             =   180
      Width           =   1245
      _ExtentX        =   2196
      _ExtentY        =   582
      _Version        =   393216
      Format          =   60489729
      CurrentDate     =   36377
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdCliente"
      Height          =   315
      Index           =   0
      Left            =   2340
      TabIndex        =   1
      Tag             =   "Clientes"
      Top             =   630
      Width           =   3255
      _ExtentX        =   5741
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdCliente"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdCondicionVenta"
      Height          =   315
      Index           =   1
      Left            =   1485
      TabIndex        =   10
      Tag             =   "CondicionesCompra"
      Top             =   2070
      Width           =   2355
      _ExtentX        =   4154
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdCondicionCompra"
      Text            =   ""
   End
   Begin Controles1013.DbListView Lista 
      Height          =   2130
      Left            =   45
      TabIndex        =   46
      Top             =   3330
      Width           =   11805
      _ExtentX        =   20823
      _ExtentY        =   3757
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      MouseIcon       =   "frmFacturas.frx":140A
      OLEDropMode     =   1
      ColumnHeaderIcons=   "ImgColumnas"
   End
   Begin MSComctlLib.ImageList Img16 
      Left            =   7470
      Top             =   6435
      _ExtentX        =   1005
      _ExtentY        =   1005
      BackColor       =   -2147483643
      ImageWidth      =   16
      ImageHeight     =   16
      MaskColor       =   12632256
      _Version        =   393216
      BeginProperty Images {2C247F25-8591-11D1-B16A-00C0F0283628} 
         NumListImages   =   4
         BeginProperty ListImage1 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "frmFacturas.frx":1426
            Key             =   "Eliminado"
         EndProperty
         BeginProperty ListImage2 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "frmFacturas.frx":1538
            Key             =   "Nuevo"
         EndProperty
         BeginProperty ListImage3 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "frmFacturas.frx":198A
            Key             =   "Modificado"
         EndProperty
         BeginProperty ListImage4 {2C247F27-8591-11D1-B16A-00C0F0283628} 
            Picture         =   "frmFacturas.frx":1DDC
            Key             =   "Original"
         EndProperty
      EndProperty
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdMoneda"
      Height          =   315
      Index           =   3
      Left            =   945
      TabIndex        =   61
      Tag             =   "Monedas"
      Top             =   5490
      Width           =   1680
      _ExtentX        =   2963
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdMoneda"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdIBCondicion"
      Height          =   315
      Index           =   4
      Left            =   8100
      TabIndex        =   68
      Tag             =   "IBCondiciones"
      Top             =   1800
      Width           =   3630
      _ExtentX        =   6403
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdIBCondicion"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdPuntoVenta"
      Height          =   315
      Index           =   10
      Left            =   1485
      TabIndex        =   74
      Tag             =   "PuntosVenta"
      Top             =   180
      Width           =   825
      _ExtentX        =   1455
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdPuntoVenta"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdObra"
      Height          =   315
      Index           =   2
      Left            =   1485
      TabIndex        =   77
      Tag             =   "Obras"
      Top             =   2430
      Width           =   2355
      _ExtentX        =   4154
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdObra"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdIBCondicion2"
      Height          =   315
      Index           =   5
      Left            =   8100
      TabIndex        =   82
      Tag             =   "IBCondiciones"
      Top             =   2160
      Width           =   2640
      _ExtentX        =   4657
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdIBCondicion"
      Text            =   ""
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdIBCondicion3"
      Height          =   315
      Index           =   6
      Left            =   8100
      TabIndex        =   85
      Tag             =   "IBCondiciones"
      Top             =   2520
      Width           =   2640
      _ExtentX        =   4657
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdIBCondicion"
      Text            =   ""
   End
   Begin MSComCtl2.DTPicker DTFields 
      DataField       =   "FechaVencimiento"
      Height          =   330
      Index           =   1
      Left            =   4350
      TabIndex        =   93
      Top             =   2070
      Width           =   1245
      _ExtentX        =   2196
      _ExtentY        =   582
      _Version        =   393216
      Format          =   60489729
      CurrentDate     =   36377
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdListaPrecios"
      Height          =   315
      Index           =   7
      Left            =   4365
      TabIndex        =   101
      Tag             =   "ListasPrecios"
      Top             =   2430
      Width           =   1230
      _ExtentX        =   2170
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdListaPrecios"
      Text            =   ""
   End
   Begin VB.TextBox txtCuit 
      Enabled         =   0   'False
      Height          =   315
      Left            =   7830
      TabIndex        =   8
      Top             =   180
      Width           =   1440
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdVendedor"
      Height          =   315
      Index           =   8
      Left            =   10395
      TabIndex        =   104
      Tag             =   "Vendedores"
      Top             =   2925
      Visible         =   0   'False
      Width           =   1410
      _ExtentX        =   2487
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdVendedor"
      Text            =   ""
   End
   Begin RichTextLib.RichTextBox rchObservaciones 
      Height          =   645
      Left            =   90
      TabIndex        =   45
      Top             =   6255
      Width           =   7440
      _ExtentX        =   13123
      _ExtentY        =   1138
      _Version        =   393217
      Enabled         =   -1  'True
      ScrollBars      =   2
      TextRTF         =   $"frmFacturas.frx":222E
   End
   Begin MSDataListLib.DataCombo dcfields 
      DataField       =   "IdCodigoIva"
      Height          =   315
      Index           =   11
      Left            =   7830
      TabIndex        =   112
      Tag             =   "DescripcionIva"
      Top             =   0
      Visible         =   0   'False
      Width           =   2970
      _ExtentX        =   5239
      _ExtentY        =   556
      _Version        =   393216
      ListField       =   "Titulo"
      BoundColumn     =   "IdCodigoIva"
      Text            =   ""
   End
   Begin RichTextLib.RichTextBox rchFacturaElectronica 
      Height          =   645
      Left            =   1350
      TabIndex        =   113
      Top             =   5940
      Visible         =   0   'False
      Width           =   4020
      _ExtentX        =   7091
      _ExtentY        =   1138
      _Version        =   393217
      Enabled         =   -1  'True
      ScrollBars      =   2
      TextRTF         =   $"frmFacturas.frx":22B0
   End
   Begin MSComCtl2.DTPicker DTFields 
      DataField       =   "FechaRecepcionCliente"
      Height          =   330
      Index           =   2
      Left            =   1485
      TabIndex        =   115
      Top             =   2790
      Width           =   1245
      _ExtentX        =   2196
      _ExtentY        =   582
      _Version        =   393216
      Format          =   60489729
      CurrentDate     =   36377
   End
   Begin VB.Label lblLabels 
      Caption         =   "Fecha rec.cliente"
      Height          =   240
      Index           =   19
      Left            =   90
      TabIndex        =   116
      Top             =   2835
      Width           =   1290
   End
   Begin VB.Label lblLabels 
      Caption         =   "Tipo expo:"
      Height          =   195
      Index           =   14
      Left            =   90
      TabIndex        =   108
      Top             =   7020
      Visible         =   0   'False
      Width           =   780
   End
   Begin VB.Label Label5 
      Caption         =   "Vend.:"
      Height          =   240
      Left            =   9855
      TabIndex        =   105
      Top             =   2970
      Visible         =   0   'False
      Width           =   525
   End
   Begin VB.Label lblCAE 
      Alignment       =   2  'Center
      BackColor       =   &H00C0FFFF&
      Caption         =   "Label5"
      Height          =   195
      Left            =   5985
      TabIndex        =   103
      Top             =   5715
      Visible         =   0   'False
      Width           =   2445
   End
   Begin VB.Label lblData 
      Caption         =   "Lista :"
      Height          =   285
      Index           =   3
      Left            =   3870
      TabIndex        =   102
      Top             =   2430
      Width           =   450
   End
   Begin VB.Label lblLabels 
      Caption         =   "Vto. :"
      Height          =   240
      Index           =   9
      Left            =   3915
      TabIndex        =   94
      Top             =   2115
      Width           =   375
   End
   Begin VB.Label Label4 
      Caption         =   "Percepcion IVA : "
      Height          =   195
      Left            =   8145
      TabIndex        =   91
      Top             =   6705
      Width           =   1905
   End
   Begin VB.Label lblOtrasPercepciones3 
      Height          =   195
      Left            =   8145
      TabIndex        =   88
      Top             =   7515
      Visible         =   0   'False
      Width           =   1905
   End
   Begin VB.Line Line9 
      BorderColor     =   &H00FFFFFF&
      Index           =   3
      X1              =   207.962
      X2              =   111.125
      Y1              =   50.8
      Y2              =   50.8
   End
   Begin VB.Line Line9 
      BorderColor     =   &H00FFFFFF&
      Index           =   2
      X1              =   207.962
      X2              =   111.125
      Y1              =   30.163
      Y2              =   30.163
   End
   Begin VB.Line Line9 
      BorderColor     =   &H00FFFFFF&
      Index           =   1
      X1              =   207.962
      X2              =   207.962
      Y1              =   30.163
      Y2              =   50.8
   End
   Begin VB.Line Line9 
      BorderColor     =   &H00FFFFFF&
      Index           =   0
      X1              =   111.125
      X2              =   111.125
      Y1              =   30.163
      Y2              =   50.8
   End
   Begin VB.Label lblData 
      Caption         =   "Categoria IIBB 3 :"
      Height          =   285
      Index           =   2
      Left            =   6390
      TabIndex        =   86
      Top             =   2520
      Width           =   1350
   End
   Begin VB.Label lblData 
      Caption         =   "Categoria IIBB 2 :"
      Height          =   285
      Index           =   1
      Left            =   6390
      TabIndex        =   83
      Top             =   2160
      Width           =   1350
   End
   Begin VB.Label lblLabels 
      Caption         =   "Detalle facturado :"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   195
      Index           =   5
      Left            =   90
      TabIndex        =   80
      Top             =   3150
      Width           =   1635
   End
   Begin VB.Label lblData 
      Caption         =   "Obra (opcional) :"
      Height          =   285
      Index           =   0
      Left            =   90
      TabIndex        =   78
      Top             =   2430
      Width           =   1305
   End
   Begin VB.Label lblNumeroCertificadoPercepcionIIBB 
      Caption         =   "Numero de certificado percepcion IIBB :"
      Height          =   240
      Left            =   2790
      TabIndex        =   76
      Top             =   5895
      Visible         =   0   'False
      Width           =   2835
   End
   Begin VB.Line Line5 
      BorderWidth     =   2
      X1              =   100.806
      X2              =   100.806
      Y1              =   0.794
      Y2              =   7.144
   End
   Begin VB.Line Line6 
      BorderWidth     =   2
      X1              =   108.744
      X2              =   108.744
      Y1              =   0.794
      Y2              =   7.144
   End
   Begin VB.Line Line7 
      BorderWidth     =   2
      X1              =   100.806
      X2              =   108.744
      Y1              =   7.144
      Y2              =   7.144
   End
   Begin VB.Line Line8 
      BorderWidth     =   2
      X1              =   100.806
      X2              =   108.744
      Y1              =   0.794
      Y2              =   0.794
   End
   Begin VB.Label lblLetra 
      Alignment       =   2  'Center
      BackColor       =   &H00FF8080&
      Caption         =   "A"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   13.5
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   375
      Left            =   5715
      TabIndex        =   73
      Top             =   45
      Width           =   465
   End
   Begin VB.Label lblEstado 
      Alignment       =   2  'Center
      BackColor       =   &H00C0C0FF&
      Caption         =   "Label1"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Left            =   9360
      TabIndex        =   71
      Top             =   180
      Visible         =   0   'False
      Width           =   1455
   End
   Begin VB.Label lblData 
      Caption         =   "Categoria IIBB 1 :"
      Height          =   285
      Index           =   10
      Left            =   6390
      TabIndex        =   69
      Top             =   1800
      Width           =   1350
   End
   Begin VB.Label lblOtrasPercepciones1 
      Height          =   195
      Left            =   8145
      TabIndex        =   67
      Top             =   6975
      Visible         =   0   'False
      Width           =   1905
   End
   Begin VB.Label lblLabels 
      Caption         =   "Conversion a Pesos :"
      Height          =   240
      Index           =   15
      Left            =   2790
      TabIndex        =   66
      Top             =   5535
      Width           =   1530
   End
   Begin VB.Label lblLabels 
      Caption         =   "Cotizacion dolar :"
      Height          =   240
      Index           =   18
      Left            =   5220
      TabIndex        =   65
      Top             =   5535
      Width           =   1530
   End
   Begin VB.Label lblLabels 
      Caption         =   "Moneda :"
      Height          =   240
      Index           =   1
      Left            =   90
      TabIndex        =   62
      Top             =   5535
      Width           =   780
   End
   Begin VB.Label Label7 
      Caption         =   " % "
      Height          =   195
      Left            =   9675
      TabIndex        =   59
      Top             =   6165
      Width           =   375
   End
   Begin VB.Label Label3 
      Caption         =   " % "
      Height          =   195
      Left            =   9675
      TabIndex        =   56
      Top             =   5895
      Width           =   375
   End
   Begin VB.Label Label2 
      Caption         =   "Bonificacion :"
      Height          =   195
      Left            =   8145
      TabIndex        =   54
      Top             =   5895
      Width           =   1050
   End
   Begin VB.Line Line4 
      BorderWidth     =   2
      X1              =   192.087
      X2              =   192.087
      Y1              =   0
      Y2              =   15.081
   End
   Begin VB.Label lblLabels 
      Alignment       =   2  'Center
      Caption         =   "Cotizacion u$s del dia"
      Height          =   420
      Index           =   23
      Left            =   10935
      TabIndex        =   51
      Top             =   45
      Width           =   915
   End
   Begin VB.Line Line3 
      BorderWidth     =   2
      X1              =   209.55
      X2              =   192.087
      Y1              =   15.081
      Y2              =   15.081
   End
   Begin VB.Label lblLabels 
      AutoSize        =   -1  'True
      Caption         =   "Observaciones :"
      Height          =   195
      Index           =   17
      Left            =   135
      TabIndex        =   44
      Top             =   6075
      Width           =   1155
   End
   Begin VB.Label lblLabels 
      Caption         =   "Condicion IVA :"
      Height          =   285
      Index           =   4
      Left            =   6345
      TabIndex        =   18
      Top             =   585
      Width           =   1395
   End
   Begin VB.Line Line2 
      BorderColor     =   &H80000005&
      BorderWidth     =   3
      X1              =   178.594
      X2              =   198.702
      Y1              =   136.437
      Y2              =   136.437
   End
   Begin VB.Label Label6 
      BackColor       =   &H00FFFFFF&
      Caption         =   "TOT. FACTURA :"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   9.75
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   -1  'True
         Strikethrough   =   0   'False
      EndProperty
      ForeColor       =   &H80000010&
      Height          =   285
      Left            =   8145
      TabIndex        =   42
      Top             =   7785
      Width           =   1905
   End
   Begin VB.Label lblOtrasPercepciones2 
      Height          =   195
      Left            =   8145
      TabIndex        =   41
      Top             =   7245
      Visible         =   0   'False
      Width           =   1905
   End
   Begin VB.Label lblPercIBB 
      Caption         =   "Percepcion I.Brutos :"
      Height          =   195
      Left            =   8145
      TabIndex        =   40
      Top             =   6435
      Visible         =   0   'False
      Width           =   1905
   End
   Begin VB.Label lblIVA1 
      Caption         =   "IVA"
      Height          =   195
      Left            =   8145
      TabIndex        =   39
      Top             =   6165
      Width           =   1050
   End
   Begin VB.Label Label1 
      Caption         =   "Subtotal :"
      Height          =   240
      Left            =   8145
      TabIndex        =   38
      Top             =   5580
      Width           =   1905
   End
   Begin VB.Label lblLabels 
      Caption         =   "Cond. de Venta :"
      Height          =   285
      Index           =   16
      Left            =   90
      TabIndex        =   31
      Top             =   2070
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "Zona :"
      Height          =   285
      Index           =   8
      Left            =   9855
      TabIndex        =   30
      Top             =   1305
      Width           =   495
   End
   Begin VB.Label lblLabels 
      Caption         =   "Provincia :"
      Height          =   285
      Index           =   12
      Left            =   90
      TabIndex        =   29
      Top             =   1710
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "Localidad :"
      Height          =   285
      Index           =   11
      Left            =   90
      TabIndex        =   28
      Top             =   1350
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "Dirección :"
      Height          =   285
      Index           =   10
      Left            =   90
      TabIndex        =   27
      Top             =   975
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "Cliente:"
      Height          =   285
      Index           =   2
      Left            =   90
      TabIndex        =   26
      Top             =   600
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "C.U.I.T. :"
      Height          =   285
      Index           =   6
      Left            =   6345
      TabIndex        =   25
      Top             =   225
      Width           =   1395
   End
   Begin VB.Label lblLabels 
      AutoSize        =   -1  'True
      Caption         =   "Fecha :"
      Height          =   285
      Index           =   22
      Left            =   3645
      TabIndex        =   24
      Top             =   225
      Width           =   630
   End
   Begin VB.Label lblLabels 
      Caption         =   "Factura :"
      BeginProperty Font 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   700
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      Height          =   285
      Index           =   21
      Left            =   90
      TabIndex        =   23
      Top             =   225
      Width           =   1305
   End
   Begin VB.Label lblLabels 
      Caption         =   "Email :"
      Height          =   285
      Index           =   7
      Left            =   6345
      TabIndex        =   22
      Top             =   1305
      Width           =   1395
   End
   Begin VB.Label lblLabels 
      Caption         =   "Fax :"
      Height          =   285
      Index           =   3
      Left            =   9855
      TabIndex        =   21
      Top             =   945
      Width           =   495
   End
   Begin VB.Label lblLabels 
      Caption         =   "Telefono :"
      Height          =   330
      Index           =   0
      Left            =   6345
      TabIndex        =   20
      Top             =   930
      Width           =   1395
   End
   Begin VB.Line Line1 
      BorderColor     =   &H80000005&
      BorderWidth     =   3
      X1              =   142.875
      X2              =   203.994
      Y1              =   96.838
      Y2              =   96.838
   End
   Begin VB.Menu MnuDet 
      Caption         =   "Detalles"
      Visible         =   0   'False
      Begin VB.Menu MnuDetA 
         Caption         =   "Insertar"
         Index           =   0
      End
      Begin VB.Menu MnuDetA 
         Caption         =   "Modificar"
         Index           =   1
      End
      Begin VB.Menu MnuDetA 
         Caption         =   "Eliminar"
         Index           =   2
      End
      Begin VB.Menu MnuDetA 
         Caption         =   "Ingresar precio unitario"
         Index           =   3
      End
   End
End
Attribute VB_Name = "frmFacturas"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Option Explicit
Dim WithEvents origen As ComPronto.Factura
Attribute origen.VB_VarHelpID = -1
Dim WithEvents oBind As BindingCollection
Attribute oBind.VB_VarHelpID = -1
Private mvarId As Long, mvarIdCliente As Long
Dim actL2 As ControlForm
Private cALetra As New clsNum2Let
'Variables de calculo de totales de factura
Private mvarIBrutosC As String, mvarIBrutosB As String, mvarMultilateral As String, mvarTipoABC As String, mvarAclaracionAlPie As String, mvarPercepcionIIBB As String
Private mvarOtrasPercepciones1 As String, mvarOtrasPercepciones1Desc As String, mvarOtrasPercepciones2 As String, mvarOtrasPercepciones2Desc As String
Private mvarOtrasPercepciones3 As String, mvarOtrasPercepciones3Desc As String, mvarConfirmarClausulaDolar As String, mvarAnulada As String, mvarEsAgenteRetencionIVA As String
Private mvarPorc_IBrutos_Cap As Double, mvarTope_IBrutos_Cap As Double, mvarP_IVA1_Tomado As Double, mvar_IBrutos_Cap As Double, mvarPorc_IBrutos_BsAs As Double
Private mvarTope_IBrutos_BsAs As Double, mvarIBrutos As Double, mvarIBrutos2 As Double, mvarIBrutos3 As Double, mvarPercepcionIVA As Double, mvarPorc_IBrutos_BsAsM As Double
Private mvarTope_IBrutos_BsAsM As Double, mvarPorcentajeIBrutos As Double, mvarPorcentajeIBrutos2 As Double, mvarPorcentajeIBrutos3 As Double, mvar_IBrutos_BsAs As Double
Private mvar_IBrutos_BsAsM As Double, mvarP_IVA1 As Double, mvarP_IVA2 As Double, mvarIVA1 As Double, mvarIVA2 As Double, mvarDecimales As Double, mvarNetoGravado As Double
Private mvarTotalFactura As Double, mvarPorcentajeBonificacion As Double, mvarImporteBonificacion As Double, mvarRecargoMora As Double, mvarSubTotal As Double, mvarCotizacion As Double
Private mvarCotizacionDolar As Double, mvarParteDolares As Double, mvarPartePesos As Double, mvarIVANoDiscriminado As Double, mvarBaseMinimaParaPercepcionIVA As Double
Private mvarAjusteIVA As Double
Private mvarPorcentajeMaximoBonificacion As Single, mvarPorcentajePercepcionIVA As Single, mAlicuotaDirecta As Single, mAlicuotaDirectaCapital As Single
Private mvarPuntoVenta As Integer, mvarIdMonedaPesos As Integer, mvarIdMonedaDolar As Integer, mvarTipoIVA As Integer, mvarIBCondicion As Integer, mvarItemsMaximo As Integer
Private mvarIdRubroDevolucionAnticipos As Integer
Private mFechaInicioVigenciaIBDirecto As Date, mFechaFinVigenciaIBDirecto As Date, mFechaInicioVigenciaIBDirectoCapital As Date, mFechaFinVigenciaIBDirectoCapital As Date
Private mvarGrabado As Boolean, mvarNumeracionUnica As Boolean, mvarFijarDatos As Boolean, mvarModificacionHabilitada As Boolean
Const mvarPuntoVentaDefault As Integer = 1
Private mNivelAcceso As Integer, mOpcionesAcceso As String

Public Property Let NivelAcceso(ByVal mNivelA As EnumAccesos)
   
   mNivelAcceso = mNivelA
   
End Property

Public Property Get NivelAcceso() As EnumAccesos

   NivelAcceso = mNivelAcceso
   
End Property

Public Property Let OpcionesAcceso(ByVal mOpcionesA As String)
   
   mOpcionesAcceso = mOpcionesA
   
End Property

Public Property Get OpcionesAcceso() As String

   OpcionesAcceso = mOpcionesAcceso
   
End Property

Sub Editar(ByVal Cual As Long)

'   If mvarId > 0 Then
'      MsgBox "No puede modificar una Factura ya registrada!", vbExclamation
'      Exit Sub
'   End If
   
   If mvarId > 0 And Cual < 0 Then
      MsgBox "No puede modificar una Factura ya registrada!", vbExclamation
      Exit Sub
   End If
   
   If Not IsNumeric(dcfields(0).BoundText) Then
      MsgBox "Debe ingresar el clientes antes de ingresar los items", vbExclamation
      Exit Sub
   End If
   
   If mvarItemsMaximo > 0 And mvarItemsMaximo <= origen.DetFacturas.CantidadRegistrosResumido Then
      MsgBox "La cantidad maxima de items por factura es de " & mvarItemsMaximo, vbExclamation
      Exit Sub
   End If
   
   Dim oF As frmDetFacturas
   Dim oL As ListItem
   
   Set oF = New frmDetFacturas
   
   With oF
      Set .Factura = origen
      .Id = Cual
      .Cotizacion = mvarCotizacion
      .TipoIVA = mvarTipoIVA
      .TipoABC = mvarTipoABC
      .AlicuotaIVA = mvarP_IVA1_Tomado
      .PorcentajeBonificacionOC = Val(txtPorcentajeBonificacion.Text)
      If Option1.Value Then
         .EsMuestra = "NO"
      Else
         .EsMuestra = "SI"
      End If
      .Show vbModal, Me
      If .Aceptado Then
         mvarP_IVA1_Tomado = IIf(.AlicuotaIVA < 0, 0, .AlicuotaIVA)
         txtPorcentajeIva1.Text = mvarP_IVA1_Tomado
         txtPorcentajeBonificacion.Text = .PorcentajeBonificacionOC
         If Cual = -1 Then
            Set oL = Lista.ListItems.Add
            oL.Tag = .IdNuevo
         Else
            Set oL = Lista.SelectedItem
         End If
         With oL
            If Cual = -1 Then
               .SmallIcon = "Nuevo"
            Else
               .SmallIcon = "Modificado"
            End If
            .Text = oF.txtCodigoArticulo.Text
            .SubItems(1) = "" & oF.DataCombo1(1).Text & " " & oF.lblColor.Caption
            .SubItems(4) = "" & Format(Val(oF.txtCantidad.Text), "Fixed")
            .SubItems(5) = "" & oF.DataCombo1(0).Text
            .SubItems(6) = "" & Format(Val(oF.txtCosto.Text), "#,##0.00")
            .SubItems(7) = "" & Format(Val(oF.txtPrecioUnitario.Text), "#,##0.00")
            .SubItems(8) = "" & Format(Val(oF.txtBonificacion.Text) / 100, "Percent")
            .SubItems(9) = "" & Format(Val(oF.txtImporte.Text), "#,##0.00")
         End With
         If mvarId < 0 Then
            If .IdCondicionVenta <> 0 Then
               origen.Registro.Fields("IdCondicionVenta").Value = .IdCondicionVenta
            End If
            If .IdMoneda <> 0 Then
               origen.Registro.Fields("IdMoneda").Value = .IdMoneda
            End If
            If IsNull(origen.Registro.Fields("IdObra").Value) And .IdObra <> 0 Then
               origen.Registro.Fields("IdObra").Value = .IdObra
            End If
         End If
      End If
   End With
   
   Unload oF
   
   Set oF = Nothing

   CalculaFactura

End Sub

Private Sub Check1_Click(Index As Integer)

   If Check1(Index).Value = 0 Then
      With origen.Registro
         If Index = 0 Then
            .Fields("IdIBCondicion").Value = Null
            dcfields(4).Enabled = False
         ElseIf Index = 1 Then
            .Fields("IdIBCondicion2").Value = Null
            dcfields(5).Enabled = False
         ElseIf Index = 2 Then
            .Fields("IdIBCondicion3").Value = Null
            dcfields(6).Enabled = False
         End If
      End With
   Else
      If Index = 0 Then
         dcfields(4).Enabled = True
      ElseIf Index = 1 Then
         dcfields(5).Enabled = True
      ElseIf Index = 2 Then
         dcfields(6).Enabled = True
      End If
   End If
   CalculaFactura
   
End Sub

Private Sub Check3_Click()

   If Check3.Value = 1 Then
      If mvarId <= 0 Then
         If Len(txtCuit.Text) > 0 Then
            Dim mIdAutorizo As Long
            Dim mOk As Boolean
            Dim s As String
            Dim oF As frmAutorizacion
            s = BuscarClaveINI("IdEmpleados para autorizar recupero de gastos")
            Set oF = New frmAutorizacion
            With oF
               .Empleado = 0
               If Len(Trim(s)) > 0 Then
                  .IdEmpleados = s
               Else
                  .Administradores = True
               End If
               .Show vbModal
               mOk = .Ok
               mIdAutorizo = .IdAutorizo
            End With
            Unload oF
            Set oF = Nothing
            If mOk Then
               Dim oRs As ADOR.Recordset
               Set oRs = Aplicacion.Proveedores.TraerFiltrado("_PorCuit", txtCuit.Text)
               If oRs.RecordCount = 0 Then
                  MsgBox "No existe un proveedor con el mismo cuit del cliente", vbExclamation
                  Check3.Value = 0
               Else
                  origen.Registro.Fields("IdAutorizoRecuperoGastos").Value = mIdAutorizo
               End If
               oRs.Close
               Set oRs = Nothing
            Else
               Check3.Value = 0
            End If
         Else
            Check3.Value = 0
            origen.Registro.Fields("IdAutorizoRecuperoGastos").Value = Null
         End If
      End If
   End If

End Sub

Private Sub Check5_Click()

   If Check5.Value = 1 Then
      txtPorcentajeDevolucionAnticipo.Enabled = True
      cmdDevolucionAnticipo.Enabled = True
   Else
      With txtPorcentajeDevolucionAnticipo
         .Text = ""
         .Enabled = False
      End With
      cmdDevolucionAnticipo.Enabled = False
   End If

End Sub

Private Sub cmd_Click(Index As Integer)

   Select Case Index
      Case 0
         Dim dc As DataCombo
         Dim dtp As DTPicker
         Dim est As EnumAcciones
         Dim mvarImprime As Integer, i As Integer, mNumeroItem As Integer, mCantidadItem As Integer, mCodigoMoneda As Integer, mTipoComprobante As Integer, mTipoIvaAFIP As Integer
         Dim mDetalleTributoItemCantidad As Integer, mIndiceItem As Integer, mIdIBCondicion As Integer, mIdIBCondicion2 As Integer, mIdIBCondicion3 As Integer, mIdVendedor As Integer
         Dim mIdObra As Integer, mIdProvinciaDestino As Integer
         Dim mvarNumero As Long, mNum As Long, mIdConceptoRecuperoGastos As Long, mIdCtaCte As Long, mIdCtaCteNC As Long, mIdProveedor As Long, mIdCuenta As Long
         Dim mCodigo As Long, mIdCuentaIvaCompras As Long, mIdentificador As Long, mNumeroFacturaElectronica As Long, mNumeroProyecto As Long, mIdCertificacionObras As Long
         Dim mIdCertificacionObraDatos As Long, mCuentaVentaPuntoVenta As Long, mCuentaVentaNumero As Long
         Dim mImporteTotalPesos As Double, mImporteTotalDolar As Double
         Dim mResult As String, mFecha As String, mWS As String, mDescripcion As String, mNCM As String, mCAE As String, mModoTest As String, mPaisDestino As String
         Dim mCliente As String, mCuitPais As String, mDomicilio As String, mUnidadesCodigoAFIP As String, mCodigoMoneda1 As String, mCAEManual As String, mArchivo As String
         Dim mNumeroFacturaElectronica2 As String, mCuentaVentaLetra As String
         Dim mvarFechaVencimiento As Date, mvarFechaVencimientoCAE As Date
         Dim mResul As Boolean
         Dim oRs As ADOR.Recordset
         Dim oRs1 As ADOR.Recordset
         Dim oPto As ComPronto.PuntoVenta
         Dim oF As frm_Aux
     
         If DTFields(0).Value <= gblFechaUltimoCierre And Not AccesoHabilitado(Me.OpcionesAcceso, DTFields(0).Value) Then
            MsgBox "La fecha no puede ser anterior al ultimo cierre : " & gblFechaUltimoCierre, vbInformation
            Exit Sub
         End If

         If EstadoEntidad("Clientes", mvarIdCliente) = "INACTIVO" Then
            MsgBox "Cliente inhabilitado", vbExclamation
            Exit Sub
         End If
         
         If mvarId <= 0 And Combo1(0).Visible And Combo1(0).ListIndex < 0 Then
            MsgBox "Debe ingresar el tipo de exportacion", vbExclamation
            Exit Sub
         End If
         
         If Frame3.Visible Then
            If Not Option3(0).Value And Not Option3(1).Value Then
               MsgBox "Debe indicar si hay permiso de embarque", vbExclamation
               Exit Sub
            End If
         End If
         
         With origen.Registro
            If IIf(IsNull(.Fields("NumeroCertificadoObra").Value), 0, .Fields("NumeroCertificadoObra").Value) <> 0 Then
               If Round(IIf(IsNull(.Fields("ImporteCertificacionObra").Value), 0, .Fields("ImporteCertificacionObra").Value) + _
                        IIf(IsNull(.Fields("FondoReparoCertificacionObra").Value), 0, .Fields("FondoReparoCertificacionObra").Value), 2) <> mvarTotalFactura Then
                  MsgBox "El importe del certificado mas el fondo de reparo debe ser igual al total de la factura", vbExclamation
                  Exit Sub
               End If
            End If
         
            If BuscarClaveINI("Requerir cuenta de venta en facturacion") = "SI" Then
               mCuentaVentaLetra = IIf(IsNull(.Fields("CuentaVentaLetra").Value), "A", .Fields("CuentaVentaLetra").Value)
               mCuentaVentaPuntoVenta = IIf(IsNull(.Fields("CuentaVentaPuntoVenta").Value), 1, .Fields("CuentaVentaPuntoVenta").Value)
               mCuentaVentaNumero = IIf(IsNull(.Fields("CuentaVentaNumero").Value), 0, .Fields("CuentaVentaNumero").Value)
               Set oF = New frm_Aux
               With oF
                  .Caption = "Ingresar cuenta de venta"
                  With .Label1
                     .Caption = "Numero de CV :"
                     .Visible = True
                  End With
                  With .Text1
                     .Width = oF.DTFields(0).Width / 4
                     .Text = mCuentaVentaLetra
                     .TabIndex = 1
                     .Alignment = 1
                     .Visible = True
                  End With
                  With .Text2
                     .Top = oF.Text1.Top
                     .Left = oF.Text1.Left + oF.Text1.Width + 10
                     .Width = oF.DTFields(0).Width / 2
                     .Text = mCuentaVentaPuntoVenta
                     .TabIndex = 2
                     .Alignment = 1
                     .Visible = True
                  End With
                  With .Text3
                     .Top = oF.Text2.Top
                     .Left = oF.Text2.Left + oF.Text2.Width + 10
                     .Width = oF.DTFields(0).Width
                     .Text = mCuentaVentaNumero
                     .TabIndex = 3
                     .Alignment = 1
                     .Visible = True
                  End With
                  .Width = .Width * 1.2
                  .Show vbModal, Me
                  mCuentaVentaLetra = .Text1.Text
                  mCuentaVentaPuntoVenta = Val(.Text2.Text)
                  mCuentaVentaNumero = Val(.Text3.Text)
               End With
               Unload oF
               Set oF = Nothing
               If Len(mCuentaVentaLetra) > 1 Then
                  Me.MousePointer = vbDefault
                  MsgBox "La letra debe ser de longitud 1", vbExclamation
                  Exit Sub
               End If
               If mCuentaVentaPuntoVenta > 9999 Then
                  Me.MousePointer = vbDefault
                  MsgBox "El punto de venta debe ser un numero entre 1 y 9999", vbExclamation
                  Exit Sub
               End If
               With origen.Registro
                  If mCuentaVentaNumero > 0 Then
                     .Fields("CuentaVentaLetra").Value = mCuentaVentaLetra
                     .Fields("CuentaVentaPuntoVenta").Value = mCuentaVentaPuntoVenta
                     .Fields("CuentaVentaNumero").Value = mCuentaVentaNumero
                  Else
                     .Fields("CuentaVentaLetra").Value = Null
                     .Fields("CuentaVentaPuntoVenta").Value = Null
                     .Fields("CuentaVentaNumero").Value = Null
                  End If
               End With
            End If
         End With
         
         If mvarId > 0 Then
            mIdProvinciaDestino = -1
            If Len(dcfields(2).Text) = 0 Or Not IsNumeric(dcfields(2).BoundText) Then
               mIdObra = -1
            Else
               mIdObra = dcfields(2).BoundText
            End If
            If Len(dcfields(4).Text) = 0 Or Not IsNumeric(dcfields(4).BoundText) Then
               mIdIBCondicion = -1
            Else
               mIdIBCondicion = dcfields(4).BoundText
            End If
            If Len(dcfields(5).Text) = 0 Or Not IsNumeric(dcfields(5).BoundText) Then
               mIdIBCondicion2 = -1
            Else
               mIdIBCondicion2 = dcfields(5).BoundText
            End If
            If Len(dcfields(6).Text) = 0 Or Not IsNumeric(dcfields(6).BoundText) Then
               mIdIBCondicion3 = -1
            Else
               mIdIBCondicion3 = dcfields(6).BoundText
            End If
            If Len(dcfields(8).Text) = 0 Or Not IsNumeric(dcfields(8).BoundText) Then
               mIdVendedor = -1
            Else
               mIdVendedor = dcfields(8).BoundText
            End If
            With origen.Registro
               If Check2.Value = 1 Then
                  .Fields("NoIncluirEnCubos").Value = "SI"
               Else
                  .Fields("NoIncluirEnCubos").Value = Null
               End If
               mNumeroProyecto = IIf(IsNull(.Fields("NumeroProyecto").Value), 0, .Fields("NumeroProyecto").Value)
               mIdCertificacionObras = IIf(IsNull(.Fields("IdCertificacionObras").Value), 0, .Fields("IdCertificacionObras").Value)
               mIdCertificacionObraDatos = IIf(IsNull(.Fields("IdCertificacionObraDatos").Value), 0, .Fields("IdCertificacionObraDatos").Value)
               Aplicacion.Tarea "Facturas_ActualizarCampos", _
                     Array(mvarId, mIdProvinciaDestino, mIdObra, rchObservaciones.Text, _
                           IIf(IsNull(.Fields("Exportacion_FOB").Value), 0, .Fields("Exportacion_FOB").Value), _
                           IIf(IsNull(.Fields("Exportacion_PosicionAduana").Value), "", .Fields("Exportacion_PosicionAduana").Value), _
                           IIf(IsNull(.Fields("Exportacion_Despacho").Value), "", .Fields("Exportacion_Despacho").Value), _
                           IIf(IsNull(.Fields("Exportacion_Guia").Value), "", .Fields("Exportacion_Guia").Value), _
                           IIf(IsNull(.Fields("Exportacion_IdPaisDestino").Value), 0, .Fields("Exportacion_IdPaisDestino").Value), _
                           IIf(IsNull(.Fields("Exportacion_FechaEmbarque").Value), 0, .Fields("Exportacion_FechaEmbarque").Value), _
                           IIf(IsNull(.Fields("Exportacion_FechaOficializacion").Value), 0, .Fields("Exportacion_FechaOficializacion").Value), _
                           mIdIBCondicion, mIdIBCondicion2, mIdIBCondicion3, IIf(IsNull(.Fields("NoIncluirEnCubos").Value), "", .Fields("NoIncluirEnCubos").Value), _
                           mIdVendedor, dcfields(10).BoundText, DTFields(0).Value, Val(txtNumeroFactura.Text), _
                           IIf(IsNull(.Fields("NumeroCertificadoObra").Value), 0, .Fields("NumeroCertificadoObra").Value), _
                           IIf(IsNull(.Fields("ImporteCertificacionObra").Value), 0, .Fields("ImporteCertificacionObra").Value), _
                           IIf(IsNull(.Fields("FondoReparoCertificacionObra").Value), 0, .Fields("FondoReparoCertificacionObra").Value), _
                           IIf(IsNull(.Fields("PorcentajeRetencionesEstimadasCertificacionObra").Value), 0, .Fields("PorcentajeRetencionesEstimadasCertificacionObra").Value), _
                           IIf(IsNull(.Fields("NumeroExpedienteCertificacionObra").Value), 0, .Fields("NumeroExpedienteCertificacionObra").Value), _
                           DTFields(2).Value, mNumeroProyecto, mIdCertificacionObras, mIdCertificacionObraDatos, _
                           IIf(IsNull(.Fields("CuentaVentaLetra").Value), "", .Fields("CuentaVentaLetra").Value), _
                           IIf(IsNull(.Fields("CuentaVentaPuntoVenta").Value), 0, .Fields("CuentaVentaPuntoVenta").Value), _
                           IIf(IsNull(.Fields("CuentaVentaNumero").Value), 0, .Fields("CuentaVentaNumero").Value))
            End With
            With origen.DetFacturas.Registros
               If .Fields.Count > 0 Then
                  If .RecordCount > 0 Then
                     .MoveFirst
                     Do While Not .EOF
                        If Not .Fields("Eliminado").Value Then
                           Aplicacion.Tarea "Facturas_ActualizarCamposDetalle", _
                                 Array(.Fields(0).Value, IIf(IsNull(.Fields("OrigenDescripcion").Value), 1, .Fields("OrigenDescripcion").Value), .Fields("Observaciones").Value)
                        End If
                        .MoveNext
                     Loop
                  End If
               End If
            End With
            With origen.DetFacturasProvincias.Registros
               If .Fields.Count > 0 Then
                  If .RecordCount > 0 Then
                     .MoveFirst
                     Do While Not .EOF
                        If Not .Fields("Eliminado").Value Then
                           If .Fields(0).Value > 0 Then
                              Aplicacion.Tarea "DetFacturasProvincias_M", _
                                 Array(.Fields(0).Value, mvarId, .Fields("IdProvinciaDestino").Value, .Fields("Porcentaje").Value)
                           Else
                              Aplicacion.Tarea "DetFacturasProvincias_A", _
                                 Array(.Fields(0).Value, mvarId, .Fields("IdProvinciaDestino").Value, .Fields("Porcentaje").Value)
                           End If
                        Else
                           Aplicacion.Tarea "DetFacturasProvincias_E", .Fields(0).Value
                        End If
                        .MoveNext
                     Loop
                  End If
               End If
            End With
            Unload Me
            Exit Sub
         End If
         
         If Lista.ListItems.Count = 0 Then
            MsgBox "No se puede almacenar una Factura sin detalles"
            Exit Sub
         End If
         
         If origen.DetFacturas.Registros.RecordCount = 0 Then
            MsgBox "No determino ningun producto a facturar"
            Exit Sub
         End If
         
         If Round(mvarSubTotal, 2) < 0 Then
            MsgBox "La suma de los items facturados debe ser positiva (" & Round(mvarSubTotal, 2) & ")"
            Exit Sub
         End If
         
         If Len(txtCotizacionMoneda.Text) = 0 Then
            MsgBox "No ingreso la cotizacion", vbInformation
            Exit Sub
         End If
         
         If Val(txtCotizacionMoneda.Text) <= 0 Then
            MsgBox "La cotizacion debe ser mayor a cero", vbInformation
            Exit Sub
         End If
         
         If Len(txtCotizacionDolar.Text) = 0 Then
            MsgBox "No ingreso la cotizacion", vbInformation
            Exit Sub
         End If
         
         If Val(txtCotizacionDolar.Text) <= 0 Then
            MsgBox "La cotizacion debe ser mayor a cero", vbInformation
            Exit Sub
         End If
         
         If mvarIBrutos <> 0 And txtNumeroCertificadoPercepcionIIBB.Visible And Len(txtNumeroCertificadoPercepcionIIBB.Text) = 0 Then
            MsgBox "Debe ingresar el numero de certificado de percepcion IIBB", vbInformation
            Exit Sub
         End If
         
         If mvarId < 0 And IsNumeric(dcfields(10).BoundText) And Not BuscarClaveINI("Validar fecha de facturas nuevas") = "NO" Then
            Set oRs = Aplicacion.Facturas.TraerFiltrado("_UltimaPorIdPuntoVenta", dcfields(10).BoundText)
            If oRs.RecordCount > 0 Then
               If oRs.Fields("FechaFactura").Value > DTFields(0).Value Then
                  MsgBox "La fecha de la ultima factura es " & oRs.Fields("FechaFactura").Value & ", modifiquela", vbExclamation
                  oRs.Close
                  Set oRs = Nothing
                  Exit Sub
               End If
            End If
            oRs.Close
            Set oRs = Nothing
         End If
         
         With origen.Registro
            For Each dtp In DTFields
               If ExisteCampo(origen.Registro, dtp.DataField) Then .Fields(dtp.DataField).Value = dtp.Value
            Next
            For Each dc In dcfields
               If dc.Visible And ExisteCampo(origen.Registro, dc.DataField) Then
                  If Not IsNumeric(dc.BoundText) And dc.Enabled And Not dc.Index = 2 And Not dc.Index = 7 Then
                     MsgBox "Falta completar el campo " & dc.Tag, vbCritical
                     Exit Sub
                  End If
                  If IsNumeric(dc.BoundText) Then .Fields(dc.DataField).Value = dc.BoundText
               End If
            Next
         End With
         
         Dim mvarCAI As String, mvarCAI_v As String, mvarFechaCAI_v As String
         Dim mvarFechaCAI As Date
         Set oRs = Aplicacion.PuntosVenta.TraerFiltrado("_PorId", dcfields(10).BoundText)
         Select Case mvarTipoABC
            Case "A", "M"
               mvarCAI_v = "NumeroCAI_F_A"
               mvarFechaCAI_v = "FechaCAI_F_A"
            Case "B"
               mvarCAI_v = "NumeroCAI_F_B"
               mvarFechaCAI_v = "FechaCAI_F_B"
            Case "E"
               mvarCAI_v = "NumeroCAI_F_E"
               mvarFechaCAI_v = "FechaCAI_F_E"
         End Select
         mvarCAI = ""
         mvarFechaCAI = DateSerial(2000, 1, 1)
         If Len(mvarCAI_v) > 0 Then
            If Not IsNull(oRs.Fields(mvarCAI_v).Value) Then mvarCAI = oRs.Fields(mvarCAI_v).Value
            If Not IsNull(oRs.Fields(mvarFechaCAI_v).Value) Then mvarFechaCAI = oRs.Fields(mvarFechaCAI_v).Value
         End If
         mWS = IIf(IsNull(oRs.Fields("WebService").Value), "", oRs.Fields("WebService").Value)
         mModoTest = IIf(IsNull(oRs.Fields("WebServiceModoTest").Value), "", oRs.Fields("WebServiceModoTest").Value)
         mCAEManual = IIf(IsNull(oRs.Fields("CAEManual").Value), "", oRs.Fields("CAEManual").Value)
         oRs.Close
         If (mvarTipoABC = "A" Or mvarTipoABC = "M") And Len(mvarCAI) = 0 And Len(mWS) = 0 Then
            MsgBox "No existe numero de CAI", vbExclamation
            Exit Sub
         End If
         If Len(mvarCAI_v) > 0 And DTFields(0).Value > mvarFechaCAI And Len(mWS) = 0 Then
            MsgBox "El CAI vencio el " & mvarFechaCAI & ", no puede grabar el comprobante", vbExclamation
            Exit Sub
         End If
         
         VerificarProvinciasDestino
         
         With origen.Registro
            .Fields("TipoABC").Value = mvarTipoABC
            .Fields("PuntoVenta").Value = Val(dcfields(10).Text)
            .Fields("ImporteTotal").Value = mvarTotalFactura
            .Fields("ImporteIva1").Value = mvarIVA1
            .Fields("ImporteIva2").Value = mvarIVA2
            .Fields("RetencionIBrutos1").Value = mvarIBrutos
            .Fields("PorcentajeIBrutos1").Value = mvarPorcentajeIBrutos
            .Fields("RetencionIBrutos2").Value = mvarIBrutos2
            .Fields("PorcentajeIBrutos2").Value = mvarPorcentajeIBrutos2
            .Fields("ConvenioMultilateral").Value = mvarMultilateral
            .Fields("RetencionIBrutos3").Value = mvarIBrutos3
            .Fields("PorcentajeIBrutos3").Value = mvarPorcentajeIBrutos3
            .Fields("ImporteParteEnDolares").Value = mvarParteDolares
            .Fields("ImporteParteEnPesos").Value = mvarPartePesos
            .Fields("PorcentajeIva1").Value = mvarP_IVA1_Tomado
            .Fields("PorcentajeIva2").Value = Val(txtPorcentajeIva2.Text)
            .Fields("PorcentajeBonificacion").Value = mvarPorcentajeBonificacion
            .Fields("ImporteBonificacion").Value = mvarImporteBonificacion
            .Fields("IVANoDiscriminado").Value = mvarIVANoDiscriminado
            .Fields("CotizacionMoneda").Value = txtCotizacionMoneda.Text
            .Fields("CotizacionDolar").Value = txtCotizacionDolar.Text
            .Fields("OtrasPercepciones1").Value = Val(txtTotal(6).Text)
            .Fields("OtrasPercepciones1Desc").Value = mvarOtrasPercepciones1Desc
            .Fields("OtrasPercepciones2").Value = Val(txtTotal(7).Text)
            .Fields("OtrasPercepciones2Desc").Value = mvarOtrasPercepciones2Desc
            .Fields("OtrasPercepciones3").Value = Val(txtTotal(10).Text)
            .Fields("OtrasPercepciones3Desc").Value = mvarOtrasPercepciones3Desc
            .Fields("PercepcionIVA").Value = mvarPercepcionIVA
            .Fields("PorcentajePercepcionIVA").Value = mvarPorcentajePercepcionIVA
            .Fields("NumeroCAI").Value = Val(mvarCAI)
            .Fields("FechaVencimientoCAI").Value = mvarFechaCAI
            .Fields("IdCodigoIva").Value = mvarTipoIVA
            .Fields("AjusteIva").Value = mvarAjusteIVA
            If Check2.Value = 1 Then
               .Fields("NoIncluirEnCubos").Value = "SI"
            Else
               .Fields("NoIncluirEnCubos").Value = Null
            End If
            If mvarId < 0 Then
               .Fields("IdUsuarioIngreso").Value = glbIdUsuario
               .Fields("FechaIngreso").Value = Now
            End If
            .Fields("Observaciones").Value = rchObservaciones.Text
            If Check3.Value = 1 Then
               .Fields("ActivarRecuperoGastos").Value = "SI"
            Else
               .Fields("ActivarRecuperoGastos").Value = Null
            End If
            If Check4.Value = 1 Then
               .Fields("ContabilizarAFechaVencimiento").Value = "SI"
            Else
               .Fields("ContabilizarAFechaVencimiento").Value = Null
            End If
            If Frame2.Visible And Check5.Value = 1 Then
               .Fields("DevolucionAnticipo").Value = "SI"
            Else
               .Fields("DevolucionAnticipo").Value = Null
            End If
            .Fields("TipoExportacion").Value = Combo1(0).ListIndex + 1
            If Frame3.Visible Then
               If Option3(0).Value Then
                  .Fields("PermisoEmbarque").Value = "SI"
               Else
                  .Fields("PermisoEmbarque").Value = "NO"
               End If
            End If
         End With
         
         mResult = origen.RegistroContableOk
         If Len(mResult) > 0 Then
            MsgBox "El registro contable de la factura registra los siguientes errores :" & mResult, vbExclamation
            Exit Sub
         End If
            
         Me.MousePointer = vbHourglass
         DoEvents
      
         Set oPto = Aplicacion.PuntosVenta.Item(dcfields(10).BoundText)
         With oPto.Registro
            mvarNumero = .Fields("ProximoNumero").Value
         End With
         Set oPto = Nothing
      
         mCodigoMoneda1 = ""
         Set oRs = Aplicacion.Monedas.TraerFiltrado("_PorId", dcfields(3).BoundText)
         If oRs.RecordCount > 0 Then
            If Not IsNull(oRs.Fields("CodigoAFIP").Value) Then
               If IsNumeric(oRs.Fields("CodigoAFIP").Value) Then
                  mCodigoMoneda1 = oRs.Fields("CodigoAFIP").Value
               End If
            End If
         End If
         oRs.Close
         If Len(mCodigoMoneda1) = 0 Then
            If dcfields(3).BoundText = glbIdMonedaPesos Then mCodigoMoneda1 = "PES"
            If dcfields(3).BoundText = glbIdMonedaDolar Then mCodigoMoneda1 = "DOL"
         End If
         
         Select Case Val(txtPorcentajeIva1.Text)
            Case 21
               mTipoIvaAFIP = 5
            Case 10.5
               mTipoIvaAFIP = 4
            Case 27
               mTipoIvaAFIP = 6
            Case Else
               mTipoIvaAFIP = 0
         End Select

         mNumeroFacturaElectronica = 0
         'Dim FE As SCFE9.Factura
         Dim FE As WSAFIPFE.Factura
         Dim FEx As WSAFIPFE.Factura

         If glbDebugFacturaElectronica And Not rchFacturaElectronica.Visible Then
            rchObservaciones.Width = rchObservaciones.Width / 2
            With rchFacturaElectronica
               .Top = rchObservaciones.Top
               .Left = rchObservaciones.Left + rchObservaciones.Width
               .Height = rchObservaciones.Height
               .Visible = True
            End With
         End If
         
         If mWS = "WSFE" And (mvarTipoABC = "A" Or mvarTipoABC = "B") Then
            If Len(Trim(glbArchivoAFIP)) = 0 Then
               Me.MousePointer = vbDefault
               MsgBox "No ha definido el archivo con el certificado AFIP, ingrese a los datos de la empresa y registrelo", vbInformation
               Exit Sub
            End If

            mCodigoMoneda = 0
            Set oRs = Aplicacion.Monedas.TraerFiltrado("_PorId", dcfields(3).BoundText)
            If oRs.RecordCount > 0 Then
               If Not IsNull(oRs.Fields("CodigoAFIP").Value) Then
                  If IsNumeric(oRs.Fields("CodigoAFIP").Value) Then mCodigoMoneda = oRs.Fields("CodigoAFIP").Value
               End If
            End If
            oRs.Close
            If mCodigoMoneda = 0 Then
               If dcfields(3).BoundText = glbIdMonedaPesos Then mCodigoMoneda = 1
               If dcfields(3).BoundText = glbIdMonedaDolar Then mCodigoMoneda = 2
               If dcfields(3).BoundText = glbIdMonedaEuro Then mCodigoMoneda = 60
            End If

            'Set FE = CreateObject("SCFE9.Factura")
            Set FE = CreateObject("WSAFIPFE.Factura")

            mResul = FE.ActivarLicenciaSiNoExiste(Replace(glbCuit, "-", ""), glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic", "pronto.wsfex@gmail.com", "bdlconsultores")
            If glbDebugFacturaElectronica Then
               MsgBox "ActivarLicencia : " & glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic" & " - UltimoMensajeError : " & FE.UltimoMensajeError
            End If
            
            'FE.ProxyConfigurar False
            mFecha = "" & Year(DTFields(0).Value) & Format(Month(DTFields(0).Value), "00") & Format(Day(DTFields(0).Value), "00")
            If mModoTest = "SI" Then
               mResul = FE.iniciar(0, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
            Else
               'If Len(Dir(glbPathPlantillas & "\SCFE9.lic")) > 0 Then
                  'mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\SCFE9.lic")
                  mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic")
               'Else
                  'mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
               'End If
            End If
            If mResul Then mResul = FE.ObtenerTicketAcceso()
            With FE
               If glbDebugFacturaElectronica Then
                  MsgBox "ObtenerTicketAcceso : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
                  mResul = .Dummy
                  MsgBox "Dummy : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
               End If
               If mResul Then
                  .FECabeceraCantReg = 1
                  .FECabeceraPresta_serv = 1
                  .indice = 0
                  .FEDetalleFecha_vence_pago = mFecha
                  .FEDetalleFecha_serv_desde = mFecha
                  .FEDetalleFecha_serv_hasta = mFecha
                  .FEDetalleFecha_vence_pago = mFecha
                  .FEDetalleImp_neto = mvarSubTotal - mvarImporteBonificacion
                  .FEDetalleImp_total = mvarTotalFactura
                  .FEDetalleFecha_cbte = mFecha
                  .FEDetalleNro_doc = Replace(txtCuit.Text, "-", "")
                  .FEDetalleTipo_doc = 80

                  Randomize
                  mIdentificador = CLng(Rnd * 100000000)
                  
                  Set oRs = Aplicacion.Clientes.TraerFiltrado("_BuscarComprobantePorIdIdentificacionCAE", mIdentificador)
                  If oRs.RecordCount > 0 Then
                     MsgBox "Ya existe el comprobante " & oRs.Fields("Comprobante").Value & " con el identificador " & mIdentificador & ". Intente grabar nuevamente.", vbInformation
                     oRs.Close
                     Set oRs = Nothing
                     Me.MousePointer = vbDefault
                     Exit Sub
                  End If
                  oRs.Close
                  
                  mArchivo = glbPathTemp & "\XMLEnviado.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLEnviado = mArchivo
                  mArchivo = glbPathTemp & "\XMLRecibido.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLRecibido = mArchivo
                  
                  On Error Resume Next
                  If mvarTipoABC = "A" Then
                     mResul = .Registrar(dcfields(10).Text, 1, "" & mIdentificador)
                     'mResul = .RegistrarConNumero(dcfields(10).Text, 1, "" & mIdentificador, txtNumeroFactura.Text)
                  Else
                     mResul = .Registrar(dcfields(10).Text, 6, "" & mIdentificador)
                  End If
                  If glbDebugFacturaElectronica Then
                     MsgBox "Registrar : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError & " - Motivo : " & .FERespuestaMotivo & " - CAE : " & .FERespuestaDetalleCae
                     rchFacturaElectronica.Text = "Request : " & FE.XMLRequest & vbCrLf & vbCrLf & "Response : " & FE.XMLResponse
                  End If

                  If mResul Then
                     mCAE = .FERespuestaDetalleCae
                     mNumeroFacturaElectronica = .FERespuestaDetalleCbt_desde
                     mDescripcion = Chr(10) + "CAE: " + .FERespuestaDetalleCae + Chr(10) + "MOTIVO " + .FERespuestaDetalleMotivo + _
                                    Chr(10) + "PROCESO " + .FERespuestaReproceso + Chr(10) + "NUMERO: " + Str(.FERespuestaDetalleCbt_desde)
                     With origen.Registro
                        .Fields("CAE").Value = mCAE
                        .Fields("IdIdentificacionCAE").Value = mIdentificador
                        If IsDate(FE.FERespuestaDetalleFecha_vto) Then .Fields("FechaVencimientoORechazoCAE").Value = FE.FERespuestaDetalleFecha_vto
                     End With
                     Aplicacion.Tarea "LogComprobantesElectronicos_InsertarRegistro", Array("FA", mvarTipoABC, Val(dcfields(10).Text), mNumeroFacturaElectronica, mIdentificador, _
                              LeerArchivoSecuencial1(glbPathTemp & "\XMLEnviado.xml"), LeerArchivoSecuencial1(glbPathTemp & "\XMLRecibido.xml"))
                  Else
                     Me.MousePointer = vbDefault
                     MsgBox "Error al obtener CAE : " + .UltimoMensajeError, vbExclamation
                     Exit Sub
                  End If
               Else
                  Me.MousePointer = vbDefault
                  MsgBox "Error al obtener CAE : " + .UltimoMensajeError, vbExclamation
                  Exit Sub
               End If
            End With
            Set FE = Nothing

         ElseIf mWS = "WSFE1" And (mvarTipoABC = "A" Or mvarTipoABC = "B") Then
            If Len(Trim(glbArchivoAFIP)) = 0 Then
               Me.MousePointer = vbDefault
               MsgBox "No ha definido el archivo con el certificado AFIP, ingrese a los datos de la empresa y registrelo", vbInformation
               Exit Sub
            End If

            mCodigoMoneda = 0
            Set oRs = Aplicacion.Monedas.TraerFiltrado("_PorId", dcfields(3).BoundText)
            If oRs.RecordCount > 0 Then
               If Not IsNull(oRs.Fields("CodigoAFIP").Value) Then
                  If IsNumeric(oRs.Fields("CodigoAFIP").Value) Then
                     mCodigoMoneda = oRs.Fields("CodigoAFIP").Value
                  End If
               End If
            End If
            oRs.Close
            If mCodigoMoneda = 0 Then
               If dcfields(3).BoundText = glbIdMonedaPesos Then mCodigoMoneda = 1
               If dcfields(3).BoundText = glbIdMonedaDolar Then mCodigoMoneda = 2
               If dcfields(3).BoundText = glbIdMonedaEuro Then mCodigoMoneda = 60
            End If

            Set FE = CreateObject("WSAFIPFE.Factura")

            mResul = FE.ActivarLicenciaSiNoExiste(Replace(glbCuit, "-", ""), glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic", "pronto.wsfex@gmail.com", "bdlconsultores")
            If glbDebugFacturaElectronica Then
               MsgBox "ActivarLicencia : " & glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic" & " - UltimoMensajeError : " & FE.UltimoMensajeError
            End If
            
            mFecha = "" & Year(DTFields(0).Value) & Format(Month(DTFields(0).Value), "00") & Format(Day(DTFields(0).Value), "00")
            If mModoTest = "SI" Then
               mResul = FE.iniciar(0, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
            Else
               mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic")
            End If
            If mResul Then mResul = FE.f1ObtenerTicketAcceso()
            With FE
               If glbDebugFacturaElectronica Then
                  MsgBox "ObtenerTicketAcceso : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
                  mResul = .f1Dummy
                  MsgBox "Dummy : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
               End If
               If mResul Then
                  .F1CabeceraCantReg = 1
                  .indice = 0
                  .F1CabeceraPtoVta = dcfields(10).Text
                  If mvarTipoABC = "A" Then
                     .F1CabeceraCbteTipo = 1
                  Else
                     .F1CabeceraCbteTipo = 6
                  End If
                  
                  .f1Indice = 0
                  .F1DetalleConcepto = 3
                  .F1DetalleDocTipo = 80
                  .F1DetalleDocNro = Replace(txtCuit.Text, "-", "")
                  .F1DetalleCbteDesde = mvarNumero
                  .F1DetalleCbteHasta = mvarNumero
                  .F1DetalleCbteFch = mFecha
                  .F1DetalleImpTotal = Round(mvarTotalFactura, 2)
                  .F1DetalleImpTotalConc = 0
                  .F1DetalleImpNeto = Round(mvarSubTotal - mvarIVANoDiscriminado, 2)
                  .F1DetalleImpOpEx = 0
                  .F1DetalleImpTrib = Round(mvarIBrutos + mvarIBrutos2 + mvarIBrutos3 + Val(txtTotal(6).Text) + Val(txtTotal(7).Text) + Val(txtTotal(10).Text) + Val(txtTotal(11).Text), 2)
                  .F1DetalleImpIva = mvarIVA1 + mvarIVANoDiscriminado
                  .F1DetalleFchServDesde = mFecha
                  .F1DetalleFchServHasta = mFecha
                  .F1DetalleFchVtoPago = mFecha
                  .F1DetalleMonIdS = mCodigoMoneda1
                  .F1DetalleMonCotiz = txtCotizacionMoneda.Text

                  mDetalleTributoItemCantidad = 0
                  If mvarIBrutos <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If mvarIBrutos2 <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If mvarIBrutos3 <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If Val(txtTotal(6).Text) <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If Val(txtTotal(7).Text) <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If Val(txtTotal(10).Text) <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1
                  If Val(txtTotal(11).Text) <> 0 Then mDetalleTributoItemCantidad = mDetalleTributoItemCantidad + 1

                  If mDetalleTributoItemCantidad > 0 Then
                     mIndiceItem = 0
                     FE.F1DetalleTributoItemCantidad = mDetalleTributoItemCantidad
                     If mvarIBrutos <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = "Ingresos Brutos"
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = mvarPorcentajeIBrutos
                        .F1DetalleTributoImporte = mvarIBrutos
                     End If
                     If mvarIBrutos2 <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = "Ingresos Brutos"
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = mvarPorcentajeIBrutos2
                        .F1DetalleTributoImporte = mvarIBrutos2
                     End If
                     If mvarIBrutos3 <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = "Ingresos Brutos"
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = mvarPorcentajeIBrutos3
                        .F1DetalleTributoImporte = mvarIBrutos3
                     End If
                     If Val(txtTotal(6).Text) <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = mvarOtrasPercepciones1Desc
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = 0
                        .F1DetalleTributoImporte = Val(txtTotal(6).Text)
                     End If
                     If Val(txtTotal(7).Text) <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = mvarOtrasPercepciones2Desc
                        .F1DetalleTributoBaseImp = mvarSubTotal
                        .F1DetalleTributoAlic = 0
                        .F1DetalleTributoImporte = Val(txtTotal(7).Text)
                     End If
                     If Val(txtTotal(10).Text) <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = mvarOtrasPercepciones3Desc
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = 0
                        .F1DetalleTributoImporte = Val(txtTotal(10).Text)
                     End If
                     If Val(txtTotal(11).Text) <> 0 Then
                        mIndiceItem = mIndiceItem + 1
                        .f1IndiceItem = mIndiceItem - 1
                        .F1DetalleTributoId = 2
                        .F1DetalleTributoDesc = "Percepcion IVA"
                        .F1DetalleTributoBaseImp = Round(mvarSubTotal, 2)
                        .F1DetalleTributoAlic = 0
                        .F1DetalleTributoImporte = Val(txtTotal(11).Text)
                     End If
                  End If

                  If mvarIVA1 + mvarIVANoDiscriminado <> 0 Then
                     .F1DetalleIvaItemCantidad = 1
                     .f1IndiceItem = 0
                     .F1DetalleIvaId = mTipoIvaAFIP
                     .F1DetalleIvaBaseImp = Round(mvarSubTotal - mvarIVANoDiscriminado, 2)
                     .F1DetalleIvaImporte = Round(mvarIVA1 + mvarIVANoDiscriminado, 2)
                  End If

                  .F1DetalleCbtesAsocItemCantidad = 0
                  .F1DetalleOpcionalItemCantidad = 0

                  mArchivo = glbPathTemp & "\XMLEnviado.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLEnviado = mArchivo
                  mArchivo = glbPathTemp & "\XMLRecibido.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLRecibido = mArchivo
                  
                  On Error Resume Next
                  mResul = .F1CAESolicitar()
                  If glbDebugFacturaElectronica Then
                     MsgBox "Registrar : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError & " - CAE : " & .F1RespuestaDetalleCae
                  End If

                  If mResul Then
                     mCAE = .F1RespuestaDetalleCae
                     If Len(Trim(mCAE)) = 0 Then
                        Me.MousePointer = vbDefault
                        MsgBox "Error al obtener CAE : " & .UltimoMensajeError & " - Ultimo numero " & .F1CompUltimoAutorizado(.F1CabeceraPtoVta, .F1CabeceraCbteTipo), vbExclamation
                        Exit Sub
                     End If
                     mNumeroFacturaElectronica = .F1RespuestaDetalleCbteDesdeS
                     With origen.Registro
                        .Fields("CAE").Value = mCAE
                        .Fields("IdIdentificacionCAE").Value = 0
                        .Fields("FechaVencimientoORechazoCAE").Value = FE.F1RespuestaDetalleCAEFchVto
                     End With
                     Aplicacion.Tarea "LogComprobantesElectronicos_InsertarRegistro", Array("FA", mvarTipoABC, Val(dcfields(10).Text), mNumeroFacturaElectronica, mIdentificador, _
                              LeerArchivoSecuencial1(glbPathTemp & "\XMLEnviado.xml"), LeerArchivoSecuencial1(glbPathTemp & "\XMLRecibido.xml"))
                  Else
                     Me.MousePointer = vbDefault
                     MsgBox "Error al obtener CAE : " + .UltimoMensajeError, vbExclamation
                     Exit Sub
                  End If
               Else
                  Me.MousePointer = vbDefault
                  MsgBox "Error al obtener CAE : " + .UltimoMensajeError, vbExclamation
                  Exit Sub
               End If
            End With
            Set FE = Nothing

         ElseIf mWS = "WSBFE" And (mvarTipoABC = "A" Or mvarTipoABC = "B") Then
            If Len(Trim(glbArchivoAFIP)) = 0 Then
               Me.MousePointer = vbDefault
               MsgBox "No ha definido el archivo con el certificado AFIP, ingrese a los datos de la empresa y registrelo", vbInformation
               Exit Sub
            End If

            If mvarTipoABC = "A" Then
               mTipoComprobante = 1
            Else
               mTipoComprobante = 6
            End If

            mCodigoMoneda = 0
            Set oRs = Aplicacion.Monedas.TraerFiltrado("_PorId", dcfields(3).BoundText)
            If oRs.RecordCount > 0 Then
               If Not IsNull(oRs.Fields("CodigoAFIP").Value) Then
                  If IsNumeric(oRs.Fields("CodigoAFIP").Value) Then
                     mCodigoMoneda = oRs.Fields("CodigoAFIP").Value
                  End If
               End If
            End If
            oRs.Close
            If mCodigoMoneda = 0 Then
               If dcfields(3).BoundText = glbIdMonedaPesos Then mCodigoMoneda = 1
               If dcfields(3).BoundText = glbIdMonedaDolar Then mCodigoMoneda = 2
               If dcfields(3).BoundText = glbIdMonedaEuro Then mCodigoMoneda = 60
            End If

            'Set FE = CreateObject("SCFE9.Factura")
            Set FE = CreateObject("WSAFIPFE.Factura")

            mResul = FE.ActivarLicenciaSiNoExiste(Replace(glbCuit, "-", ""), glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic", "pronto.wsfex@gmail.com", "bdlconsultores")
            If glbDebugFacturaElectronica Then
               MsgBox "ActivarLicencia : " & glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic" & " - UltimoMensajeError : " & FE.UltimoMensajeError
            End If
            
            'FE.ProxyConfigurar False
            mFecha = "" & Year(DTFields(0).Value) & Format(Month(DTFields(0).Value), "00") & Format(Day(DTFields(0).Value), "00")
            If mModoTest = "SI" Then
               mResul = FE.iniciar(0, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
            Else
               'If Len(Dir(glbPathPlantillas & "\SCFE9.lic")) > 0 Then
                  'mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\SCFE9.lic")
                  mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\FE_" & Replace(glbCuit, "-", "") & ".lic")
               'Else
                  'mResul = FE.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
               'End If
            End If
            If mResul Then mResul = FE.bObtenerTicketAcceso()
            With FE
               If glbDebugFacturaElectronica Then
                  MsgBox "ObtenerTicketAcceso : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
                  mResul = .Dummy
                  MsgBox "Dummy : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
               End If
               If mResul Then
                  .bTipo_Doc = 80
                  .bNro_doc = Replace(txtCuit.Text, "-", "")
                  .bTipo_cbte = mTipoComprobante
                  .bPunto_vta = dcfields(10).Text
                  .bImp_total = mvarTotalFactura
                  .bImp_neto = mvarSubTotal - mvarImporteBonificacion
                  .bimpto_liq = 0
                  .bimpto_liq_rni = 0
                  .bimp_op_ex = 0
                  .bImp_perc = Val(txtTotal(6).Text) + Val(txtTotal(7).Text) + Val(txtTotal(10).Text)
                  .bImp_iibb = mvarPorcentajeIBrutos + mvarPorcentajeIBrutos2 + mvarPorcentajeIBrutos3
                  .bImp_internos = 0
                  .bImp_moneda_id = mCodigoMoneda
                  .bImp_moneda_ctz = Val(txtCotizacionMoneda.Text)
                  .bFecha_cbte = mFecha
                  .bZona = 1

                  Set oRs = origen.DetFacturas.TodosLosRegistros
                  If oRs.Fields.Count > 0 Then
                     If oRs.RecordCount > 0 Then
                        mCantidadItem = 0
                        oRs.MoveFirst
                        Do While Not oRs.EOF
                           If oRs.Fields("Eliminado").Value <> "SI" Then mCantidadItem = mCantidadItem + 1
                           oRs.MoveNext
                        Loop
                        .bItemCantidad = mCantidadItem
                        mNumeroItem = 0
                        oRs.MoveFirst
                        Do While Not oRs.EOF
                           If oRs.Fields("Eliminado").Value <> "SI" Then
                              mDescripcion = ""
                              mNCM = ""
                              Set oRs1 = Aplicacion.Articulos.TraerFiltrado("_PorId", oRs.Fields("IdArticulo").Value)
                              If oRs1.RecordCount > 0 Then
                                 mDescripcion = IIf(IsNull(oRs1.Fields("Descripcion").Value), "", oRs1.Fields("Descripcion").Value)
                                 mNCM = IIf(IsNull(oRs1.Fields("AuxiliarString10").Value), "", oRs1.Fields("AuxiliarString10").Value)
                              End If
                              If Len(mNCM) = 0 Then mNCM = "99.99.99.99"
                              oRs1.Close
                              .bIndiceItem = mNumeroItem
                              .bITEMpro_codigo_sec = "0"
                              .bITEMpro_codigo_ncm = mNCM
                              .bITEMpro_ds = mDescripcion
                              .bITEMpro_precio_uni = oRs.Fields("PrecioUnitario").Value
                              .bITEMpro_qty = oRs.Fields("Cantidad").Value
                              .bITEMpro_umed = 7
                              .bITEMIva_id = 1
                              .bITEMimp_total = Round(IIf(IsNull(oRs.Fields("Cantidad").Value), 0, oRs.Fields("Cantidad").Value) * _
                                                            IIf(IsNull(oRs.Fields("PrecioUnitario").Value), 0, oRs.Fields("PrecioUnitario").Value) * _
                                                            (1 - (IIf(IsNull(oRs.Fields("Bonificacion").Value), 0, oRs.Fields("Bonificacion").Value) / 100)), 2)
                              .bITEMimp_bonif = Round(IIf(IsNull(oRs.Fields("Cantidad").Value), 0, oRs.Fields("Cantidad").Value) * _
                                                            IIf(IsNull(oRs.Fields("PrecioUnitario").Value), 0, oRs.Fields("PrecioUnitario").Value) * _
                                                            IIf(IsNull(oRs.Fields("Bonificacion").Value), 0, oRs.Fields("Bonificacion").Value) / 100, 2)
                              mNumeroItem = mNumeroItem + 1
                           End If
                           oRs.MoveNext
                        Loop
                     End If
                  End If
                  Set oRs = Nothing

                  Randomize
                  mIdentificador = CLng(Rnd * 100000000)
                  
                  Set oRs = Aplicacion.Clientes.TraerFiltrado("_BuscarComprobantePorIdIdentificacionCAE", mIdentificador)
                  If oRs.RecordCount > 0 Then
                     MsgBox "Ya existe el comprobante " & oRs.Fields("Comprobante").Value & " con el identificador " & mIdentificador & ". Intente grabar nuevamente.", vbInformation
                     oRs.Close
                     Set oRs = Nothing
                     Me.MousePointer = vbDefault
                     Exit Sub
                  End If
                  oRs.Close
                  
                  mArchivo = glbPathTemp & "\XMLEnviado.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLEnviado = mArchivo
                  mArchivo = glbPathTemp & "\XMLRecibido.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLRecibido = mArchivo
                  
                  On Error Resume Next
                  mResul = .bRegistrar(dcfields(10).Text, mTipoComprobante, "" & mIdentificador)
                  'mResul = .bRegistrarConNumero(dcfields(10).Text, mTipoComprobante, "" & mvarId, 1)
                  If glbDebugFacturaElectronica Then
                     MsgBox "Registrar : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError & " - Motivo : " & .FERespuestaMotivo & " - CAE : " & .bRespuestaCAE
                     rchFacturaElectronica.Text = "Request : " & FE.XMLRequest & vbCrLf & vbCrLf & "Response : " & FE.XMLResponse
                  End If
                  
                  If mResul Then
                     mCAE = .bRespuestaCAE
                     mNumeroFacturaElectronica = .bRespuestaCbte_numero
                     mDescripcion = Chr(10) + "CAE: " + .bRespuestaCAE + Chr(10) + "REPROCESO " + .bRespuestaReproceso + _
                                    Chr(10) + "Evento " + .bEventMsg + Chr(10) + "Observacion: " + .bRespuestaOBS
                     With origen.Registro
                        .Fields("CAE").Value = mCAE
                        .Fields("IdIdentificacionCAE").Value = mIdentificador
                        If IsDate(FE.bRespuestaFch_venc_cae) Then
                           .Fields("FechaVencimientoORechazoCAE").Value = FE.bRespuestaFch_venc_cae
                        End If
                        '.Fields("Observaciones").Value = .Fields("Observaciones").Value + Chr(10) + mDescripcion
                     End With
                     Aplicacion.Tarea "LogComprobantesElectronicos_InsertarRegistro", Array("FA", mvarTipoABC, Val(dcfields(10).Text), mNumeroFacturaElectronica, mIdentificador, _
                              LeerArchivoSecuencial1(glbPathTemp & "\XMLEnviado.xml"), LeerArchivoSecuencial1(glbPathTemp & "\XMLRecibido.xml"))
                  Else
                     Me.MousePointer = vbDefault
                     MsgBox "Error al obtener CAE : " + .Permsg + "Detalle: " + .UltimoMensajeError, vbExclamation
                     Exit Sub
                  End If
               Else
                  Me.MousePointer = vbDefault
                  MsgBox "Error al obtener CAE : " + .Permsg + "Detalle: " + .UltimoMensajeError, vbExclamation
                  Exit Sub
               End If
            End With
            Set FE = Nothing
         
         ElseIf Len(mWS) > 0 And mvarTipoABC = "E" Then
            If Len(Trim(glbArchivoAFIP)) = 0 Then
               Me.MousePointer = vbDefault
               MsgBox "No ha definido el archivo con el certificado AFIP, ingrese a los datos de la empresa y registrelo", vbInformation
               Exit Sub
            End If

            mTipoComprobante = 19

            Set oRs = Aplicacion.Clientes.TraerFiltrado("_PorIdConDatos", dcfields(0).BoundText)
            If oRs.RecordCount > 0 Then
               mPaisDestino = oRs.Fields("PaisCodigo2").Value
               mCuitPais = oRs.Fields("CuitPais").Value
               mCliente = IIf(IsNull(oRs.Fields("RazonSocial").Value), "", oRs.Fields("RazonSocial").Value)
               mDomicilio = IIf(IsNull(oRs.Fields("Direccion").Value), "", oRs.Fields("Direccion").Value & " ") & _
                           IIf(IsNull(oRs.Fields("Localidad").Value), "", oRs.Fields("Localidad").Value & " ") & _
                           IIf(IsNull(oRs.Fields("Provincia").Value), "", oRs.Fields("Provincia").Value & " ") & _
                           IIf(IsNull(oRs.Fields("Pais").Value), "", oRs.Fields("Pais").Value)
            End If
            oRs.Close
            Set oRs = Nothing
            
            If Len(mPaisDestino) = 0 Then
               MsgBox "Para el registro electronico de la factura, el pais del destinatario debe tener el codigo 2", vbExclamation
               Exit Sub
            End If
            If Len(mCuitPais) = 0 Then
               MsgBox "Para el registro electronico de la factura, el pais del destinatario debe tener el cuit-pais", vbExclamation
               Exit Sub
            End If
            
            Set FEx = CreateObject("WSAFIPFE.Factura")
            If glbDebugFacturaElectronica Then
               MsgBox "CreateObject('WSAFIPFE.Factura') ok - UltimoMensajeError : " & FEx.UltimoMensajeError
            End If

            mFecha = "" & Year(DTFields(0).Value) & Format(Month(DTFields(0).Value), "00") & Format(Day(DTFields(0).Value), "00")
            
            mResul = FEx.ActivarLicencia(Replace(glbCuit, "-", ""), glbPathPlantillas & "\FEX_" & Replace(glbCuit, "-", "") & ".lic", "pronto.wsfex@gmail.com", "bdlconsultores")
            If glbDebugFacturaElectronica Then
               MsgBox "ActivarLicencia : " & glbPathPlantillas & "\FEX_" & Replace(glbCuit, "-", "") & ".lic" & " - UltimoMensajeError : " & FEx.UltimoMensajeError
            End If
            
            If mModoTest = "SI" Then
               mResul = FEx.iniciar(0, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
            Else
               If Len(Dir(glbPathPlantillas & "\SCFE9.lic")) > 0 Then
                  mResul = FEx.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", glbPathPlantillas & "\FEX_" & Replace(glbCuit, "-", "") & ".lic")
               Else
                  mResul = FEx.iniciar(1, Replace(glbCuit, "-", ""), glbPathPlantillas & "\" & glbArchivoAFIP & ".pfx", "")
               End If
            End If
            If glbDebugFacturaElectronica Then MsgBox "Iniciar : " & mResul & " - UltimoMensajeError : " & FEx.UltimoMensajeError
            If mResul Then mResul = FEx.xObtenerTicketAcceso()
            With FEx
               If glbDebugFacturaElectronica Then
                  MsgBox "ObtenerTicketAcceso : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
                  mResul = .Dummy
                  MsgBox "Dummy : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError
               End If
               If mResul Then
                  .xPunto_vta = dcfields(10).Text
                  .xFecha_cbte = mFecha
                  .xtipo_expo = Combo1(0).ListIndex + 1
                  .xDst_cmp = mPaisDestino
'                  If Option3(0).Value Then
'                     .xPermiso_existente = "S"
'                  Else
                     .xPermiso_existente = "N"
'                  End If
                  .xPermisoNoInformar = 1
                  .xCliente = mCliente
                  .xCuit_pais_clienteS = mCuitPais
                  .xDomicilio_cliente = mDomicilio
                  .xId_impositivo = ""
                  .xMoneda_id = mCodigoMoneda1
                  .xMoneda_ctz = Val(txtCotizacionMoneda.Text)
                  .xObs_comerciales = ""
                  .xImp_total = mvarTotalFactura
                  .xForma_pago = dcfields(1).Text
                  .xIncoTerms = "CIF"
                  .xIncoTerms_ds = ""
                  .xIdioma_cbte = 1

                  Set oRs = origen.DetFacturas.TodosLosRegistros
                  If oRs.Fields.Count > 0 Then
                     If oRs.RecordCount > 0 Then
                        mCantidadItem = 0
                        oRs.MoveFirst
                        Do While Not oRs.EOF
                           If oRs.Fields("Eliminado").Value <> "SI" Then mCantidadItem = mCantidadItem + 1
                           oRs.MoveNext
                        Loop
                        .xItemCantidad = mCantidadItem
                        mNumeroItem = 0
                        oRs.MoveFirst
                        Do While Not oRs.EOF
                           If oRs.Fields("Eliminado").Value <> "SI" Then
                              mDescripcion = ""
                              mNCM = ""
                              Set oRs1 = Aplicacion.Articulos.TraerFiltrado("_PorId", oRs.Fields("IdArticulo").Value)
                              If oRs1.RecordCount > 0 Then
                                 mDescripcion = IIf(IsNull(oRs1.Fields("Descripcion").Value), "", oRs1.Fields("Descripcion").Value)
                                 mNCM = IIf(IsNull(oRs1.Fields("AuxiliarString10").Value), "", oRs1.Fields("AuxiliarString10").Value)
                              End If
                              If Len(mNCM) = 0 Then mNCM = "99.99.99.99"
                              oRs1.Close
                              
                              mUnidadesCodigoAFIP = ""
                              Set oRs1 = Aplicacion.Unidades.TraerFiltrado("_PorId", oRs.Fields("IdUnidad").Value)
                              If oRs1.RecordCount > 0 Then
                                 mUnidadesCodigoAFIP = IIf(IsNull(oRs1.Fields("CodigoAFIP").Value), "", oRs1.Fields("CodigoAFIP").Value)
                              End If
                              If Len(mUnidadesCodigoAFIP) = 0 Then mUnidadesCodigoAFIP = "7"
                              oRs1.Close
                              
                              .xIndiceItem = mNumeroItem
                              .xITEMPro_codigo = mNCM
                              .xITEMPro_ds = mDescripcion
                              .xITEMPro_qty = oRs.Fields("Cantidad").Value
                              .xITEMPro_umed = mUnidadesCodigoAFIP
                              .xITEMPro_precio_uni = oRs.Fields("PrecioUnitario").Value
                              .xITEMPro_precio_item = Round(IIf(IsNull(oRs.Fields("Cantidad").Value), 0, oRs.Fields("Cantidad").Value) * _
                                                            IIf(IsNull(oRs.Fields("PrecioUnitario").Value), 0, oRs.Fields("PrecioUnitario").Value) * _
                                                            (1 - (IIf(IsNull(oRs.Fields("Bonificacion").Value), 0, oRs.Fields("Bonificacion").Value) / 100)), 2)
                              mNumeroItem = mNumeroItem + 1
                           End If
                           oRs.MoveNext
                        Loop
                     End If
                  End If
                  Set oRs = Nothing

                  Randomize
                  mIdentificador = CLng(Rnd * 100000000)
                  
                  Set oRs = Aplicacion.Clientes.TraerFiltrado("_BuscarComprobantePorIdIdentificacionCAE", mIdentificador)
                  If oRs.RecordCount > 0 Then
                     MsgBox "Ya existe el comprobante " & oRs.Fields("Comprobante").Value & " con el identificador " & mIdentificador & ". Intente grabar nuevamente.", vbInformation
                     oRs.Close
                     Set oRs = Nothing
                     Me.MousePointer = vbDefault
                     Exit Sub
                  End If
                  oRs.Close
                  
                  mArchivo = glbPathTemp & "\XMLEnviado.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLEnviado = mArchivo
                  mArchivo = glbPathTemp & "\XMLRecibido.xml"
                  If Dir(mArchivo) <> "" Then Kill mArchivo
                  .ArchivoXMLRecibido = mArchivo
                  
                  On Error Resume Next
                  mResul = .xRegistrar(dcfields(10).Text, mTipoComprobante, "" & mIdentificador)
                  If glbDebugFacturaElectronica Then MsgBox "Registrar : " & mResul & " - UltimoMensajeError : " & .UltimoMensajeError & " - CAE : " & .xRespuestaCAE

                  If mResul Then
                     mCAE = .xRespuestaCAE
                     mNumeroFacturaElectronica2 = .xRespuestacbte_numeroS
                     mNumeroFacturaElectronica = Val(mNumeroFacturaElectronica2)
                     mDescripcion = Chr(10) + "CAE: " + .xRespuestaCAE + Chr(10) + "REPROCESO " + .xRespuestaReproceso + _
                                    Chr(10) + "Evento " + .xEventMsg + Chr(10) + "Observacion: " + .xRespuestaMotivos_obs
                     With origen.Registro
                        .Fields("CAE").Value = mCAE
                        .Fields("IdIdentificacionCAE").Value = mIdentificador
                        If IsDate(mId(FEx.xRespuestaFch_venc_cae, 7, 2) & "/" & mId(FEx.xRespuestaFch_venc_cae, 5, 2) & "/" & mId(FEx.xRespuestaFch_venc_cae, 1, 4)) Then
                           .Fields("FechaVencimientoORechazoCAE").Value = CDate(mId(FEx.xRespuestaFch_venc_cae, 7, 2) & "/" & mId(FEx.xRespuestaFch_venc_cae, 5, 2) & "/" & mId(FEx.xRespuestaFch_venc_cae, 1, 4))
                        End If
                     End With
                     Aplicacion.Tarea "LogComprobantesElectronicos_InsertarRegistro", Array("FA", mvarTipoABC, Val(dcfields(10).Text), mNumeroFacturaElectronica, mIdentificador, _
                              LeerArchivoSecuencial1(glbPathTemp & "\XMLEnviado.xml"), LeerArchivoSecuencial1(glbPathTemp & "\XMLRecibido.xml"))
                  Else
                     Me.MousePointer = vbDefault
                     MsgBox "Error al obtener CAE : " + .xerrmsg + "Detalle: " + .UltimoMensajeError, vbExclamation
                     Exit Sub
                  End If
               Else
                  Me.MousePointer = vbDefault
                  MsgBox "Error al obtener CAE : " + .xerrmsg + "Detalle: " + .UltimoMensajeError, vbExclamation
                  Exit Sub
               End If
            End With
            Set FEx = Nothing
         End If
         
         On Error GoTo 0
         
         If mvarId < 0 Then
            If mCAEManual = "SI" Then
               mCAE = ""
               Set oF = New frm_Aux
               With oF
                  .Caption = "Ingresar numero de CAE"
                  With .Label2(0)
                     .Caption = "Numero de CAE :"
                     .Visible = True
                  End With
                  With .Text1
                     .Text = ""
                     .Top = oF.DTFields(0).Top
                     .Left = oF.DTFields(0).Left
                     .Width = .Width * 2
                  End With
                  With .Label1
                     .Caption = "Fecha vto. CAE :"
                     .Visible = True
                  End With
                  With .DTFields(0)
                     .Top = oF.Label1.Top
                     .Value = Date
                     .Visible = True
                  End With
                  .Width = .Width * 1.5
                  .Height = .Height * 0.7
                  .cmd(0).Top = .Label1.Top + .Label1.Height + 100
                  .cmd(0).Left = .Width / 2 - (.cmd(0).Width / 2)
                  .cmd(0).Height = .cmd(0).Height * 0.75
                  .cmd(1).Visible = False
                  .Show vbModal, Me
                  If .Ok Then
                     mCAE = Val(.Text1.Text)
                     mvarFechaVencimientoCAE = .DTFields(0).Value
                  End If
               End With
               Unload oF
               Set oF = Nothing
               If Len(mCAE) < 14 Then
                  Me.MousePointer = vbDefault
                  MsgBox "Debe ingresar el numero de CAE", vbExclamation
                  Exit Sub
               End If
               With origen.Registro
                  .Fields("CAE").Value = mCAE
                  .Fields("FechaVencimientoORechazoCAE").Value = mvarFechaVencimientoCAE
               End With
            End If
         
            Set oPto = Aplicacion.PuntosVenta.Item(dcfields(10).BoundText)
            With oPto.Registro
               If mNumeroFacturaElectronica = 0 Then
                  mvarNumero = .Fields("ProximoNumero").Value
               Else
                  mvarNumero = mNumeroFacturaElectronica
               End If
               .Fields("ProximoNumero").Value = mvarNumero + 1
               origen.Registro.Fields("NumeroFactura").Value = mvarNumero
            End With
            oPto.Guardar
            Set oPto = Nothing
         
            Set oRs = Aplicacion.Facturas.TraerFiltrado("_PorNumeroComprobante", Array(mvarTipoABC, Val(dcfields(10).Text), mvarNumero))
            If oRs.RecordCount > 0 Then
               oRs.Close
               Set oRs = Nothing
               Me.MousePointer = vbDefault
               If mNumeroFacturaElectronica = 0 Then
                  MsgBox "Ya existe esta factura!", vbExclamation
                  Exit Sub
               Else
                  MsgBox "Ya existe esta factura!, igual se registra, verifique el numerador en el punto de venta", vbExclamation
               End If
            End If
            oRs.Close
            
            If dcfields(4).Enabled And Check1(0).Value = 1 Then
               Dim oPrv As ComPronto.Provincia
               Set oRs = Aplicacion.IBCondiciones.TraerFiltrado("_PorId", origen.Registro.Fields("IdIBCondicion").Value)
               If oRs.RecordCount > 0 Then
                  If Not IsNull(oRs.Fields("IdProvincia").Value) Then
                     Set oPrv = Aplicacion.Provincias.Item(oRs.Fields("IdProvincia").Value)
                     With oPrv.Registro
                        mNum = IIf(IsNull(.Fields("ProximoNumeroCertificadoPercepcionIIBB").Value), 1, .Fields("ProximoNumeroCertificadoPercepcionIIBB").Value)
                        origen.Registro.Fields("NumeroCertificadoPercepcionIIBB").Value = mNum
                        .Fields("ProximoNumeroCertificadoPercepcionIIBB").Value = mNum + 1
                     End With
                     oPrv.Guardar
                     Set oPrv = Nothing
                  End If
               End If
               oRs.Close
               Set oRs = Nothing
            End If
         End If
         
         Select Case origen.Guardar
            Case ComPronto.MisEstados.Correcto
            Case ComPronto.MisEstados.ModificadoPorOtro
               MsgBox "El registro ha sido modificado"
            Case ComPronto.MisEstados.NoExiste
               MsgBox "El registro ha sido eliminado"
            Case ComPronto.MisEstados.ErrorDeDatos
               MsgBox "Error de ingreso de datos"
         End Select
         
         'Recupero de gastos
         If mvarId < 0 And Check3.Value = 1 Then
            'NC Deudores
            Dim oPar As ComPronto.Parametro
            Set oPar = Aplicacion.Parametros.Item(1)
            With oPar
               With .Registro
                  mvarNumero = IIf(IsNull(.Fields("ProximaNotaCreditoInterna").Value), 1, .Fields("ProximaNotaCreditoInterna").Value)
                  .Fields("ProximaNotaCreditoInterna").Value = mvarNumero + 1
                  mIdCuentaIvaCompras = 0
                  For i = 1 To 10
                     If .Fields("IVAComprasPorcentaje" & i).Value = mvarP_IVA1_Tomado Then
                        mIdCuentaIvaCompras = .Fields("IdCuentaIvaCompras" & i).Value
                        Exit For
                     End If
                  Next
               End With
               .Guardar
            End With
            Set oPar = Nothing
            
            Dim oNC As ComPronto.NotaCredito
            Set oNC = Aplicacion.NotasCredito.Item(-1)
            With oNC
               With .Registro
                  .Fields("NumeroNotaCredito").Value = mvarNumero
                  .Fields("IdCliente").Value = dcfields(0).BoundText
                  .Fields("FechaNotaCredito").Value = DTFields(0).Value
                  .Fields("TipoABC").Value = mvarTipoABC
                  .Fields("PuntoVenta").Value = 0
                  .Fields("ImporteTotal").Value = mvarTotalFactura
                  .Fields("ImporteIva1").Value = mvarIVA1
                  .Fields("ImporteIva2").Value = mvarIVA2
                  .Fields("CtaCte").Value = "SI"
                  .Fields("IdVendedor").Value = origen.Registro.Fields("IdVendedor").Value
                  .Fields("RetencionIBrutos1").Value = mvarIBrutos
                  .Fields("PorcentajeIBrutos1").Value = mvarPorcentajeIBrutos
                  .Fields("RetencionIBrutos2").Value = mvarIBrutos2
                  .Fields("PorcentajeIBrutos2").Value = mvarPorcentajeIBrutos2
                  .Fields("IdCodigoIva").Value = mvarTipoIVA
                  .Fields("PorcentajeIva1").Value = mvarP_IVA1_Tomado
                  .Fields("PorcentajeIva2").Value = Val(txtPorcentajeIva2.Text)
                  .Fields("Observaciones").Value = "Recupero gastos"
                  .Fields("CotizacionDolar").Value = txtCotizacionDolar.Text
                  .Fields("IdMoneda").Value = dcfields(3).BoundText
                  .Fields("CotizacionMoneda").Value = txtCotizacionMoneda.Text
                  .Fields("IVANoDiscriminado").Value = mvarIVANoDiscriminado
                  .Fields("ConvenioMultilateral").Value = mvarMultilateral
                  .Fields("OtrasPercepciones1").Value = Val(txtTotal(6).Text)
                  .Fields("OtrasPercepciones1Desc").Value = mvarOtrasPercepciones1Desc
                  .Fields("OtrasPercepciones2").Value = Val(txtTotal(7).Text)
                  .Fields("OtrasPercepciones2Desc").Value = mvarOtrasPercepciones2Desc
                  .Fields("IdProvinciaDestino").Value = origen.Registro.Fields("IdProvinciaDestino").Value
                  .Fields("IdIBCondicion").Value = origen.Registro.Fields("IdIBCondicion").Value
                  .Fields("IdPuntoVenta").Value = 0
                  .Fields("NumeroCAI").Value = 0
                  If IsNumeric(dcfields(2).BoundText) Then
                     .Fields("IdObra").Value = dcfields(2).BoundText
                  End If
                  .Fields("IdUsuarioIngreso").Value = glbIdUsuario
                  .Fields("FechaIngreso").Value = Now
                  .Fields("IdIBCondicion2").Value = origen.Registro.Fields("IdIBCondicion2").Value
                  .Fields("OtrasPercepciones3").Value = Val(txtTotal(10).Text)
                  .Fields("OtrasPercepciones3Desc").Value = mvarOtrasPercepciones3Desc
                  .Fields("NoIncluirEnCubos").Value = "SI"
                  .Fields("PercepcionIVA").Value = mvarPercepcionIVA
                  .Fields("PorcentajePercepcionIVA").Value = mvarPorcentajePercepcionIVA
                  .Fields("IdFacturaVenta_RecuperoGastos").Value = origen.Registro.Fields(0).Value
               End With
               
               Set oRs = Aplicacion.Parametros.TraerFiltrado("_PorId", 1)
               mIdConceptoRecuperoGastos = IIf(IsNull(oRs.Fields("IdConceptoRecuperoGastos").Value), 0, oRs.Fields("IdConceptoRecuperoGastos").Value)
               oRs.Close
               
               With .DetNotasCredito.Item(-1)
                  With .Registro
                     .Fields("IdConcepto").Value = mIdConceptoRecuperoGastos
                     .Fields("Importe").Value = mvarSubTotal
                     .Fields("IVANoDiscriminado").Value = mvarIVANoDiscriminado
                     If Val(txtPorcentajeIva1.Text) <> 0 Then
                        .Fields("Gravado").Value = "SI"
                     End If
                  End With
                  .Modificado = True
               End With
               
               mIdCtaCte = 0
               mImporteTotalPesos = 0
               mImporteTotalDolar = 0
               Set oRs = Aplicacion.CtasCtesD.TraerFiltrado("_BuscarComprobante", Array(origen.Registro.Fields(0).Value, 1))
               If oRs.RecordCount > 0 Then
                  mIdCtaCte = oRs.Fields(0).Value
                  mImporteTotalPesos = oRs.Fields("ImporteTotal").Value
                  mImporteTotalDolar = oRs.Fields("ImporteTotalDolar").Value
               End If
               oRs.Close
               
               With .DetNotasCreditoImp.Item(-1)
                  With .Registro
                     .Fields("IdImputacion").Value = mIdCtaCte
                     .Fields("Importe").Value = mvarTotalFactura
                  End With
                  .Modificado = True
               End With
               .Guardar
            End With
            
            Set oRs = Aplicacion.CtasCtesD.TraerFiltrado("_BuscarComprobante", Array(oNC.Registro.Fields(0).Value, 4))
            mIdCtaCteNC = 0
            If oRs.RecordCount > 0 Then mIdCtaCteNC = oRs.Fields(0).Value
            oRs.Close
            
            Set oNC = Nothing
            
            Aplicacion.Tarea "CtasCtesD_ReimputarComprobante", _
                  Array(mIdCtaCteNC, mImporteTotalPesos, mImporteTotalDolar, mIdCtaCte, mImporteTotalPesos, mImporteTotalDolar)
         
            'NC Proveedores
            Set oRs = Aplicacion.Proveedores.TraerFiltrado("_PorCuit", txtCuit.Text)
            mIdProveedor = 0
            mIdProvinciaDestino = 0
            If oRs.RecordCount > 0 Then
               mIdProveedor = oRs.Fields(0).Value
               mIdProvinciaDestino = IIf(IsNull(oRs.Fields("IdProvincia").Value), 0, oRs.Fields("IdProvincia").Value)
            End If
            oRs.Close
            
            Set oRs = Aplicacion.Conceptos.TraerFiltrado("_PorIdConDatos", mIdConceptoRecuperoGastos)
            mIdCuenta = 0
            mCodigo = 0
            If oRs.RecordCount > 0 Then
               mIdCuenta = IIf(IsNull(oRs.Fields("IdCuenta").Value), 0, oRs.Fields("IdCuenta").Value)
               mCodigo = IIf(IsNull(oRs.Fields("Codigo").Value), 0, oRs.Fields("Codigo").Value)
            End If
            oRs.Close
            
            Dim oCP As ComPronto.ComprobanteProveedor
            Set oCP = Aplicacion.ComprobantesProveedores.Item(-1)
            With oCP
               With .Registro
                  .Fields("IdProveedor").Value = mIdProveedor
                  .Fields("IdTipoComprobante").Value = 13
                  .Fields("FechaComprobante").Value = DTFields(0).Value
                  .Fields("Letra").Value = mvarTipoABC
                  .Fields("NumeroComprobante1").Value = 0
                  .Fields("NumeroComprobante2").Value = mvarNumero
                  .Fields("FechaRecepcion").Value = DTFields(0).Value
                  .Fields("FechaVencimiento").Value = DTFields(0).Value
                  .Fields("TotalBruto").Value = mvarTotalFactura - (mvarIVA1 + mvarIVA2)
                  .Fields("TotalIva1").Value = mvarIVA1
                  .Fields("TotalIva2").Value = mvarIVA2
                  .Fields("TotalComprobante").Value = mvarTotalFactura
                  .Fields("Observaciones").Value = "Recupero de gastos"
                  If IsNumeric(dcfields(2).BoundText) Then
                     .Fields("IdObra").Value = dcfields(2).BoundText
                  End If
                  .Fields("IdMoneda").Value = dcfields(3).BoundText
                  .Fields("CotizacionMoneda").Value = txtCotizacionMoneda.Text
                  .Fields("CotizacionDolar").Value = txtCotizacionDolar.Text
                  .Fields("TotalIvaNoDiscriminado").Value = mvarIVANoDiscriminado
                  .Fields("AjusteIVA").Value = 0
                  .Fields("BienesOServicios").Value = "B"
                  .Fields("Confirmado").Value = "SI"
                  .Fields("NumeroCAI").Value = 0
                  .Fields("IdUsuarioIngreso").Value = glbIdUsuario
                  .Fields("FechaIngreso").Value = Now
                  .Fields("IdCodigoIva").Value = mvarTipoIVA
                  .Fields("CotizacionEuro").Value = Cotizacion(DTFields(0).Value, glbIdMonedaEuro)
                  .Fields("IdFacturaVenta_RecuperoGastos").Value = origen.Registro.Fields(0).Value
               End With
               With .DetComprobantesProveedores.Item(-1)
                  With .Registro
                     .Fields("IdCuenta").Value = mIdCuenta
                     .Fields("CodigoCuenta").Value = mCodigo
                     .Fields("Importe").Value = mvarTotalFactura - (mvarIVA1 + mvarIVA2)
                     If (mvarIVA1 + mvarIVA2) <> 0 Then
                        .Fields("IdCuentaIvaCompras1").Value = mIdCuentaIvaCompras
                        .Fields("IVAComprasPorcentaje1").Value = mvarP_IVA1_Tomado
                        .Fields("ImporteIVA1").Value = (mvarIVA1 + mvarIVA2)
                        .Fields("AplicarIVA1").Value = "SI"
                     Else
                        .Fields("IVAComprasPorcentaje1").Value = 0
                        .Fields("ImporteIVA1").Value = 0
                        .Fields("AplicarIVA1").Value = "NO"
                     End If
                     .Fields("IVAComprasPorcentaje2").Value = 0
                     .Fields("ImporteIVA2").Value = 0
                     .Fields("AplicarIVA2").Value = "NO"
                     .Fields("IVAComprasPorcentaje3").Value = 0
                     .Fields("ImporteIVA3").Value = 0
                     .Fields("AplicarIVA3").Value = "NO"
                     .Fields("IVAComprasPorcentaje4").Value = 0
                     .Fields("ImporteIVA4").Value = 0
                     .Fields("AplicarIVA4").Value = "NO"
                     .Fields("IVAComprasPorcentaje5").Value = 0
                     .Fields("ImporteIVA5").Value = 0
                     .Fields("AplicarIVA5").Value = "NO"
                     .Fields("IVAComprasPorcentaje6").Value = 0
                     .Fields("ImporteIVA6").Value = 0
                     .Fields("AplicarIVA6").Value = "NO"
                     .Fields("IVAComprasPorcentaje7").Value = 0
                     .Fields("ImporteIVA7").Value = 0
                     .Fields("AplicarIVA7").Value = "NO"
                     .Fields("IVAComprasPorcentaje8").Value = 0
                     .Fields("ImporteIVA8").Value = 0
                     .Fields("AplicarIVA8").Value = "NO"
                     .Fields("IVAComprasPorcentaje9").Value = 0
                     .Fields("ImporteIVA9").Value = 0
                     .Fields("AplicarIVA9").Value = "NO"
                     .Fields("IVAComprasPorcentaje10").Value = 0
                     .Fields("ImporteIVA10").Value = 0
                     .Fields("AplicarIVA10").Value = "NO"
                     .Fields("IdProvinciaDestino1").Value = mIdProvinciaDestino
                     .Fields("PorcentajeProvinciaDestino1").Value = 100
                  End With
                  .Modificado = True
               End With
               .Guardar
            End With
            Set oCP = Nothing
         End If
         
         If mvarId < 0 Then
            est = alta
            mvarId = origen.Registro.Fields(0).Value
            mvarGrabado = True
         Else
            est = Modificacion
         End If
            
         With actL2
            .ListaEditada = "FacturasTodas, FacturasAgrupadas, +SubFA2"
            .AccionRegistro = est
            .Disparador = mvarId
         End With
      
         Set oRs = Nothing
         Set oRs1 = Nothing
         
         Me.MousePointer = vbDefault
   
         mvarImprime = MsgBox("Desea imprimir ahora ?", vbYesNo, "Impresion de la Factura")
         If mvarImprime = vbYes Then cmdImpre_Click 0
      
         Unload Me

      Case 1
         Unload Me

      Case 2
         AnularFactura
         
      Case 3
         DatosExportacion
   
      Case 4
         CertificacionObra1
   End Select
   
   Set cALetra = Nothing
   
End Sub

Public Property Let Id(ByVal vnewvalue As Long)

   Dim oControl As Control
   Dim oAp As ComPronto.Aplicacion
   Dim oDet As ComPronto.DetFactura
   Dim oDetPrv As ComPronto.DetFacturaProvincias
   Dim oRs As ADOR.Recordset
   Dim dtf As DTPicker
   Dim ListaVacia As Boolean, mvarMostrarAjusteIva As Boolean, mvarConCertificadoObra As Boolean
   
   mvarId = vnewvalue
   ListaVacia = False
   mvarFijarDatos = False
   mvarModificacionHabilitada = False
   mvarConCertificadoObra = False
   
   If BuscarClaveINI("Consultar inclusion en cubos para comprobantes de venta") = "SI" Then
      Check2.Visible = True
   End If
   If BuscarClaveINI("Activar recupero de gastos") = "SI" Then
      Check3.Visible = True
   End If
   If BuscarClaveINI("Consultar fecha de contabilizacion en comprobantes de venta") = "SI" Then
      Check4.Visible = True
   End If
   If BuscarClaveINI("Activar anticipos de venta") = "SI" Then
      rchObservaciones.Width = rchObservaciones.Width * 0.7
      Frame2.Visible = True
   End If
   mvarItemsMaximo = Val(BuscarClaveINI("Maxima cantidad de items en factura de venta"))
   If BuscarClaveINI("Mostrar vendedor/cobrador en recibo") = "SI" Then
      Label5.Visible = True
      dcfields(8).Visible = True
   End If
   mvarMostrarAjusteIva = False
   If BuscarClaveINI("Habilitar ajuste de iva en comprobantes de venta") = "SI" Then mvarMostrarAjusteIva = True
   If BuscarClaveINI("Habilitar modificacion tipo de iva en comprobantes de venta") = "SI" Then
      Me.txtCondicionIva.Visible = False
      With dcfields(11)
         .Left = Me.txtCondicionIva.Left
         .Top = Me.txtCondicionIva.Top
         .Width = Me.txtCondicionIva.Width
         .Visible = True
      End With
   End If
   
   Set oAp = Aplicacion
   Set origen = oAp.Facturas.Item(vnewvalue)
   
   Set oRs = oAp.Parametros.Item(1).Registro
   With oRs
      mvarP_IVA1 = .Fields("Iva1").Value
      mvarP_IVA2 = .Fields("Iva2").Value
      mvarPorc_IBrutos_Cap = .Fields("Porc_IBrutos_Cap").Value
      mvarTope_IBrutos_Cap = .Fields("Tope_IBrutos_Cap").Value
      mvarPorc_IBrutos_BsAs = .Fields("Porc_IBrutos_BsAs").Value
      mvarTope_IBrutos_BsAs = .Fields("Tope_IBrutos_BsAs").Value
      mvarPorc_IBrutos_BsAsM = .Fields("Porc_IBrutos_BsAsM").Value
      mvarTope_IBrutos_BsAsM = .Fields("Tope_IBrutos_BsAsM").Value
      mvarDecimales = .Fields("Decimales").Value
      mvarAclaracionAlPie = .Fields("AclaracionAlPieDeFactura").Value
      mvarIdMonedaPesos = .Fields("IdMoneda").Value
      mvarIdMonedaDolar = .Fields("IdMonedaDolar").Value
      mvarPercepcionIIBB = IIf(IsNull(.Fields("PercepcionIIBB").Value), "NO", .Fields("PercepcionIIBB").Value)
      mvarOtrasPercepciones1 = IIf(IsNull(.Fields("OtrasPercepciones1").Value), "NO", .Fields("OtrasPercepciones1").Value)
      mvarOtrasPercepciones1Desc = IIf(IsNull(.Fields("OtrasPercepciones1Desc").Value), "", .Fields("OtrasPercepciones1Desc").Value)
      mvarOtrasPercepciones2 = IIf(IsNull(.Fields("OtrasPercepciones2").Value), "NO", .Fields("OtrasPercepciones2").Value)
      mvarOtrasPercepciones2Desc = IIf(IsNull(.Fields("OtrasPercepciones2Desc").Value), "", .Fields("OtrasPercepciones2Desc").Value)
      mvarOtrasPercepciones3 = IIf(IsNull(.Fields("OtrasPercepciones3").Value), "NO", .Fields("OtrasPercepciones3").Value)
      mvarOtrasPercepciones3Desc = IIf(IsNull(.Fields("OtrasPercepciones3Desc").Value), "", .Fields("OtrasPercepciones3Desc").Value)
      mvarConfirmarClausulaDolar = IIf(IsNull(.Fields("ConfirmarClausulaDolar").Value), "NO", .Fields("ConfirmarClausulaDolar").Value)
      mvarNumeracionUnica = False
      If .Fields("NumeracionUnica").Value = "SI" Then mvarNumeracionUnica = True
      gblFechaUltimoCierre = IIf(IsNull(.Fields("FechaUltimoCierre").Value), DateSerial(1980, 1, 1), .Fields("FechaUltimoCierre").Value)
   End With
   oRs.Close
   mvarIdRubroDevolucionAnticipos = 0
   Set oRs = oAp.Parametros.TraerFiltrado("_Parametros2BuscarClave", "IdRubroDevolucionAnticipos")
   If oRs.RecordCount > 0 Then
      mvarIdRubroDevolucionAnticipos = IIf(IsNull(oRs.Fields("Valor").Value), 0, Val(oRs.Fields("Valor").Value))
   End If
   oRs.Close
   
   If mvarId = -1 Then
      'origen.Registro.Fields(7).Value = 1
      mvarIdCliente = 0
   Else
      If Not IsNull(origen.Registro.Fields("IdCliente").Value) Then
         mvarIdCliente = origen.Registro.Fields("IdCliente").Value
      End If
   End If
   
   mvarAnulada = "NO"
   
   Set oBind = New BindingCollection
   With oBind
      Set .DataSource = origen
      For Each oControl In Me.Controls
         If TypeOf oControl Is CommandButton Then
         ElseIf TypeOf oControl Is DbListView Then
            If oControl.Name = "Lista" Then
               If vnewvalue < 0 Then
                  Set oControl.DataSource = origen.DetFacturas.TraerMascara
               Else
                  Set oRs = origen.DetFacturas.TraerTodos
                  If oRs.RecordCount <> 0 Then
                     Set oControl.DataSource = oRs
                     oRs.MoveFirst
                     Do While Not oRs.EOF
                        Set oDet = origen.DetFacturas.Item(oRs.Fields(0).Value)
                        oDet.Modificado = True
                        Set oDet = Nothing
                        oRs.MoveNext
                     Loop
                     ListaVacia = False
                  Else
                     Set oControl.DataSource = origen.DetFacturas.TraerMascara
                     ListaVacia = True
                  End If
               End If
            End If
         ElseIf TypeOf oControl Is Label Then
            If Len(oControl.DataField) Then .Add oControl, "Caption", oControl.DataField
         ElseIf TypeOf oControl Is RichTextBox Then
            If Len(oControl.DataField) Then .Add oControl, "textRTF", oControl.DataField
         ElseIf TypeOf oControl Is DataCombo Then
            If Len(oControl.DataField) Then Set oControl.DataSource = origen
            If Len(oControl.Tag) Then
               If oControl.Tag = "PuntosVenta" Then
                  Set oControl.RowSource = oAp.PuntosVenta.TraerFiltrado("_PuntosVentaTodos")
               ElseIf oControl.Tag = "Obras" Then
                  If glbSeñal1 Then
                     Set oControl.RowSource = oAp.Obras.TraerFiltrado("_TodasActivasParaCombo", Array("SI", Date))
                  Else
                     Set oControl.RowSource = oAp.Obras.TraerFiltrado("_TodasActivasParaCombo")
                  End If
               Else
                  Set oControl.RowSource = oAp.CargarLista(oControl.Tag)
               End If
            End If
         Else
            On Error Resume Next
            Set oControl.DataSource = origen
         End If
      Next
   End With
   
   If mvarId = -1 Then
      For Each dtf In DTFields
         dtf.Value = Date
      Next
      With origen.Registro
         .Fields("IdMoneda").Value = mvarIdMonedaPesos
      End With
      Lista.ListItems.Clear
      Option1.Value = True
      mvarGrabado = False
      mvarP_IVA1_Tomado = -1
      txtPorcentajeIva1.Text = 0
      txtPorcentajeIva2.Text = mvarP_IVA2
      mvarCotizacion = Cotizacion(Date, glbIdMonedaDolar)
      txtCotizacionDolar.Text = mvarCotizacion
      mvarAjusteIVA = 0
   Else
      With origen.Registro
         If IsNull(.Fields("EsMuestra").Value) Then
            Option1.Value = True
         Else
            If Not .Fields("EsMuestra").Value = "SI" Then
               Option1.Value = True
            Else
               Option2.Value = True
            End If
         End If
         txtPorcentajeBonificacion.Text = .Fields("PorcentajeBonificacion").Value
         mvarP_IVA1_Tomado = .Fields("PorcentajeIva1").Value
         txtPorcentajeIva1.Text = mvarP_IVA1_Tomado
         txtPorcentajeIva2.Text = .Fields("PorcentajeIva2").Value
         mvarCotizacion = IIf(IsNull(.Fields("CotizacionDolar").Value), 0, .Fields("CotizacionDolar").Value)
         txtCotizacionDolar.Text = mvarCotizacion
         txtCotizacionMoneda.Text = IIf(IsNull(.Fields("CotizacionMoneda").Value), 0, .Fields("CotizacionMoneda").Value)
         mvarAjusteIVA = IIf(IsNull(.Fields("AjusteIVA").Value), 0, .Fields("AjusteIVA").Value)
         If Not IsNull(.Fields("OtrasPercepciones1Desc").Value) And Len(.Fields("OtrasPercepciones1Desc").Value) > 0 Then
            mvarOtrasPercepciones1Desc = .Fields("OtrasPercepciones1Desc").Value
         End If
         If Not IsNull(.Fields("OtrasPercepciones2Desc").Value) And Len(.Fields("OtrasPercepciones2Desc").Value) > 0 Then
            mvarOtrasPercepciones2Desc = .Fields("OtrasPercepciones2Desc").Value
         End If
         If Not IsNull(.Fields("OtrasPercepciones3Desc").Value) And Len(.Fields("OtrasPercepciones3Desc").Value) > 0 Then
            mvarOtrasPercepciones3Desc = .Fields("OtrasPercepciones3Desc").Value
         End If
         If Not IsNull(.Fields("NoIncluirEnCubos").Value) And .Fields("NoIncluirEnCubos").Value = "SI" Then
            Check2.Value = 1
         End If
         If Not IsNull(.Fields("ActivarRecuperoGastos").Value) And .Fields("ActivarRecuperoGastos").Value = "SI" Then
            Check3.Value = 1
         End If
         If Not IsNull(.Fields("ContabilizarAFechaVencimiento").Value) And .Fields("ContabilizarAFechaVencimiento").Value = "SI" Then
            Check4.Value = 1
         End If
         If Not IsNull(.Fields("Anulada").Value) And .Fields("Anulada").Value = "SI" Then
            With lblEstado
               .Caption = "ANULADA"
               .Visible = True
            End With
            mvarAnulada = "SI"
         End If
         If Not IsNull(.Fields("DevolucionAnticipo").Value) And .Fields("DevolucionAnticipo").Value = "SI" Then
            txtPorcentajeDevolucionAnticipo.Enabled = True
            cmdDevolucionAnticipo.Enabled = True
         End If
         rchObservaciones.TextRTF = IIf(IsNull(.Fields("Observaciones").Value), "", .Fields("Observaciones").Value)
         If Not IsNull(.Fields("CAE").Value) Then
            rchObservaciones.Height = rchObservaciones.Height - lblCAE.Height
            lblCAE.Caption = "CAE : " & .Fields("CAE").Value
            With lblCAE
               .Top = rchObservaciones.Top + rchObservaciones.Height
               .Left = rchObservaciones.Left
               .Width = rchObservaciones.Width
               .Visible = True
            End With
         End If
         Combo1(0).ListIndex = IIf(IsNull(.Fields("TipoExportacion").Value), -1, .Fields("TipoExportacion").Value - 1)
         If IIf(IsNull(.Fields("PermisoEmbarque").Value), "", .Fields("PermisoEmbarque").Value) = "SI" Then
            Option3(0).Value = True
         Else
            Option3(1).Value = True
         End If
      
         Set dcfields(10).RowSource = Aplicacion.PuntosVenta.TraerFiltrado("_PuntosVentaPorIdTipoComprobanteLetra", Array(1, .Fields("TipoABC").Value))
         dcfields(10).BoundText = .Fields("IdPuntoVenta").Value
         
         If IIf(IsNull(.Fields("NumeroCertificadoObra").Value), 0, .Fields("NumeroCertificadoObra").Value) <> 0 Or _
            IIf(IsNull(.Fields("IdCertificacionObraDatos").Value), 0, .Fields("IdCertificacionObraDatos").Value) <> 0 Then
            mvarConCertificadoObra = True
         End If
         If IsNull(.Fields("FechaRecepcionCliente").Value) Then
            .Fields("FechaRecepcionCliente").Value = .Fields("FechaFactura").Value
            DTFields(2).Value = .Fields("FechaFactura").Value
         End If
      End With

      Set oRs = origen.DetFacturasProvincias.TraerTodos
      If oRs.Fields.Count > 0 Then
         If oRs.RecordCount <> 0 Then
            oRs.MoveFirst
            Do While Not oRs.EOF
               Set oDetPrv = origen.DetFacturasProvincias.Item(oRs.Fields(0).Value)
               oDetPrv.Modificado = True
               Set oDetPrv = Nothing
               oRs.MoveNext
            Loop
         End If
      End If
      Set oRs = Nothing
      
      For Each oControl In Me.Controls
         If TypeOf oControl Is CommandButton Or TypeOf oControl Is DTPicker Or TypeOf oControl Is DataCombo Or _
               TypeOf oControl Is TextBox Or TypeOf oControl Is OptionButton Or TypeOf oControl Is CheckBox Or _
               TypeOf oControl Is ComboBox Then
            oControl.Enabled = False
         End If
      Next
      cmd(1).Enabled = True
      cmd(4).Enabled = True
      dcfields(2).Enabled = True
      dcfields(4).Enabled = True
      dcfields(5).Enabled = True
      dcfields(6).Enabled = True
      dcfields(8).Enabled = True
      Check1(0).Enabled = True
      Check1(1).Enabled = True
      Check1(2).Enabled = True
      Check2.Enabled = True
      cmdImpre(0).Enabled = True
      cmdImpre(1).Enabled = True
      cmdProvinciasDestino.Enabled = True
      If InStr(1, BuscarClaveINI("Usuarios habilitados para modificacion de datos en comprobantes de venta"), "(" & glbIdUsuario & ")") > 0 Then
         mvarModificacionHabilitada = True
         dcfields(10).Enabled = True
         txtNumeroFactura.Enabled = True
         DTFields(0).Enabled = True
         DTFields(2).Enabled = True
      End If
      
      mvarGrabado = True
   End If
   
   If mvarPercepcionIIBB = "SI" Or origen.Registro.Fields("RetencionIBrutos1").Value <> 0 Then
      lblPercIBB.Visible = True
      lblNumeroCertificadoPercepcionIIBB.Visible = True
      txtNumeroCertificadoPercepcionIIBB.Visible = True
      With txtTotal(5)
         .Text = origen.Registro.Fields("RetencionIBrutos1").Value
         .Visible = True
      End With
   End If
   
   If mvarOtrasPercepciones1 = "SI" Or origen.Registro.Fields("OtrasPercepciones1").Value <> 0 Then
      With lblOtrasPercepciones1
         .Caption = mvarOtrasPercepciones1Desc & " :"
         .Visible = True
      End With
      With txtTotal(6)
         .Text = origen.Registro.Fields("OtrasPercepciones1").Value
         .Visible = True
      End With
   End If
   
   If mvarOtrasPercepciones2 = "SI" Or origen.Registro.Fields("OtrasPercepciones2").Value <> 0 Then
      With lblOtrasPercepciones2
         .Caption = mvarOtrasPercepciones2Desc & " :"
         .Visible = True
      End With
      With txtTotal(7)
         .Text = origen.Registro.Fields("OtrasPercepciones2").Value
         .Visible = True
      End With
   End If
   
   If mvarOtrasPercepciones3 = "SI" Or origen.Registro.Fields("OtrasPercepciones3").Value <> 0 Then
      With lblOtrasPercepciones3
         .Caption = mvarOtrasPercepciones3Desc & " :"
         .Visible = True
      End With
      With txtTotal(10)
         .Text = origen.Registro.Fields("OtrasPercepciones3").Value
         .Visible = True
      End With
   End If
   
   If mvarMostrarAjusteIva Then
      With lblOtrasPercepciones3
         .Caption = "Ajuste iva :"
         .Visible = True
      End With
      txtTotal(10).Visible = False
      With txtTotal(12)
         .Left = txtTotal(10).Left
         .Top = txtTotal(10).Top
         .Text = mvarAjusteIVA
         .Visible = True
      End With
   End If
   
   txtCotizacion.Text = mvarCotizacion
   
   If mvarConCertificadoObra Then
      cmd(4).BackColor = &HC0FFC0
   Else
      cmd(4).BackColor = &HC0C0FF
   End If
   
   If ListaVacia Then Lista.ListItems.Clear
   
   Set oRs = Nothing
   Set oAp = Nothing

   cmd(0).Enabled = False
   cmd(2).Enabled = False
   If Me.NivelAcceso = Medio Then
      If mvarId <= 0 Then cmd(0).Enabled = True
   ElseIf Me.NivelAcceso = Alto Then
      cmd(0).Enabled = True
      cmd(2).Enabled = True
   End If
   If mvarId > 0 Then
'      cmd(0).Enabled = False
   Else
      cmd(2).Enabled = False
   End If
   
   If mvarAnulada = "SI" Then
      cmd(0).Enabled = False
      cmd(2).Enabled = False
   Else
      If DTFields(0).Value <= gblFechaUltimoCierre And Not AccesoHabilitado(Me.OpcionesAcceso, DTFields(0).Value) Then
         cmd(0).Enabled = False
         cmd(2).Enabled = False
      End If
   End If

End Property

Private Sub cmdDevolucionAnticipo_Click()

   AgregarDevolucionAnticipo

End Sub

Private Sub cmdImpre_Click(Index As Integer)

   If Not mvarGrabado Then
      MsgBox "Antes de imprimir debe grabar el comprobante!", vbCritical
      Exit Sub
   End If
   
   Dim mPlantilla As String, mPlantilla1 As String, mCampo As String, mAgrupar As String, mArgL1 As String, mFuncionClausula As String
   Dim oRs As ADOR.Recordset
   
   mPlantilla = "N/A"
   Set oRs = Aplicacion.Parametros.TraerFiltrado("_PorId", 1)
   If oRs.RecordCount > 0 Then
      mCampo = "Plantilla_Factura_" & IIf(mvarTipoABC = "C" Or mvarTipoABC = "M", "A", mvarTipoABC)
      If Not IsNull(oRs.Fields(mCampo).Value) And Len(oRs.Fields(mCampo).Value) > 0 Then
         mPlantilla = oRs.Fields(mCampo).Value
      End If
   End If
   oRs.Close
   Set oRs = Nothing
   
   If Not Len(Trim(Dir(glbPathPlantillas & "\" & mPlantilla))) <> 0 Then
      MsgBox "No existe la plantilla de impresion, definala en la tabla de parametros.", vbExclamation
      Exit Sub
   End If
   
   mFuncionClausula = BuscarClaveINI("Asignar clausula dolar segun moneda")
   mAgrupar = BuscarClaveINI("Agrupar items en factura")
   
   Dim mvarClausula As Boolean, mOk As Boolean
   mvarClausula = False
   If (mvarConfirmarClausulaDolar = "SI" And mFuncionClausula <> "SI") Or Len(mAgrupar) <> 0 Then
      Dim oF1 As frm_Aux
      Set oF1 = New frm_Aux
      With oF1
         .Caption = "Emision de factura"
         .Label1.Visible = False
         .Text1.Visible = False
         If mFuncionClausula <> "SI" Then
            With .Frame1
               .Caption = "Emite clausula dolar ? : "
               .Top = oF1.Label1.Top
               .Visible = True
            End With
            .Option1.Caption = "SI"
            .Option1.Value = True
            .Option2.Caption = "NO"
         End If
         If Len(mAgrupar) <> 0 Then
            With .Check1
               .Top = 1000
               .Left = oF1.Frame1.Left
               .Width = oF1.Frame1.Width / 2
               .Caption = "Agrupar items"
               If mAgrupar = "SI" Then
                  .Value = 1
               Else
                  .Value = 0
               End If
               .Visible = True
            End With
         End If
         .Show vbModal, Me
         mOk = .Ok
         mvarClausula = .Option1.Value
         If Len(mAgrupar) <> 0 Then
            If .Check1.Value = 1 Then
               mAgrupar = "SI"
            Else
               mAgrupar = "NO"
            End If
         End If
      End With
      Unload oF1
      Set oF1 = Nothing
      Me.Refresh
      If Not mOk Then Exit Sub
   End If
   
   If mFuncionClausula = "SI" Then
      If origen.Registro.Fields("IdMoneda").Value = mvarIdMonedaPesos Then
         mvarClausula = False
      Else
         mvarClausula = True
      End If
   End If
   
   Dim mCopias As Integer
   Dim mPrinter As String, mPrinterAnt As String
   
   mPrinterAnt = Printer.DeviceName & " on " & Printer.Port
   
   If Index = 0 Then
      mCopias = Val(BuscarClaveINI("CopiasFacturas", -1))
      If mCopias = 0 Then mCopias = 1
      
      Dim oF As frmImpresion
      Set oF = New frmImpresion
      With oF
         .txtCopias.Text = mCopias
         .Show vbModal, Me
      End With
      mOk = oF.Ok
      mCopias = Val(oF.txtCopias.Text)
      mPrinter = oF.Combo1.Text
      Unload oF
      Set oF = Nothing
      If Not mOk Then Exit Sub
      Me.Refresh
   Else
      mCopias = 1
   End If
   
   mArgL1 = BuscarClaveINI("Conceptos para detallar dominios en factura")
   
   Dim oW As Word.Application
   Dim mPID As String
      
   On Error GoTo Mal
   
   If Index = 0 Then CargaProcesosEnEjecucion
   Set oW = CreateObject("Word.Application")
   If Index = 0 Then mPID = ObtenerPIDProcesosLanzados
   
   With oW
      .Visible = True
      If Not IsNull(origen.Registro.Fields("CAE").Value) Then
         mPlantilla = mId(mPlantilla, 1, Len(mPlantilla) - 4) & "_FA" & mId(mPlantilla, Len(mPlantilla) - 3, 4)
      End If
      
      mPlantilla1 = mId(mPlantilla, 1, Len(mPlantilla) - 4) & "_" & Format(origen.Registro.Fields("PuntoVenta").Value, "0000") & mId(mPlantilla, Len(mPlantilla) - 3, 4)
      If Len(Trim(Dir(glbPathPlantillas & "\" & mPlantilla1))) <> 0 Then mPlantilla = mPlantilla1
      
      .Documents.Add (glbPathPlantillas & "\" & mPlantilla)
      If Len(mAgrupar) <> 0 Then
         .Application.Run MacroName:="Emision", varg1:=glbStringConexion, varg2:=mvarId, varg3:=mvarClausula, varg4:=mPrinter, varg5:=mCopias, varg6:=mAgrupar & "|" & mArgL1 & "|" & glbEmpresaSegunString & "|" & glbPathPlantillas & "\.."
      Else
         .Application.Run MacroName:="Emision", varg1:=glbStringConexion, varg2:=mvarId, varg3:=mvarClausula, varg4:=mPrinter, varg5:=mCopias
      End If
      If Index = 0 Then
         oW.Documents(1).Close False
         If glbTerminarProcesosOffice Then
            TerminarProceso mPID
         Else
            oW.Quit
         End If
      End If
   End With
   
   GoTo Salida
   
Mal:
   Me.MousePointer = vbDefault
   MsgBox "Se ha producido un error al imprimir ..." & vbCrLf & Err.Number & " " & Err.Description, vbCritical

Salida:
   Set oW = Nothing
   Me.MousePointer = vbDefault
   
End Sub

Private Sub cmdProvinciasDestino_Click()

   Dim oF As frmDetFacturasProvincias
   
   VerificarProvinciasDestino
   
   Set oF = New frmDetFacturasProvincias
   With oF
      Set .Factura = origen
      .Show vbModal, Me
   End With
   Unload oF
   Set oF = Nothing

End Sub

Private Sub dcfields_Change(Index As Integer)
      
   If Len(dcfields(Index).BoundText) = 0 Or Not IsNumeric(dcfields(Index).BoundText) Then Exit Sub
   
   Dim oRs As ADOR.Recordset
   
   origen.Registro.Fields(dcfields(Index).DataField).Value = dcfields(Index).BoundText
   
   Select Case Index
      Case 0
         MostrarDatos (0)
      Case 1
         If mvarId <= 0 And IsNumeric(dcfields(Index).BoundText) Then
            Set oRs = Aplicacion.CondicionesCompra.TraerFiltrado("_PorId", dcfields(Index).BoundText)
            DTFields(1).Value = DTFields(0).Value
            If oRs.RecordCount > 0 Then
               DTFields(1).Value = DTFields(0).Value + IIf(IsNull(oRs.Fields("CantidadDias1").Value), 0, oRs.Fields("CantidadDias1").Value)
            End If
            oRs.Close
         End If
      Case 3
         If dcfields(Index).BoundText = 1 Then
            txtCotizacionMoneda.Text = 1
         Else
            Set oRs = Aplicacion.Cotizaciones.TraerFiltrado("_PorFechaMoneda", Array(DTFields(0).Value, dcfields(Index).BoundText))
            If oRs.RecordCount > 0 Then
               txtCotizacionMoneda.Text = oRs.Fields("CotizacionLibre").Value
               If dcfields(Index).BoundText = mvarIdMonedaDolar Then
                  txtCotizacionDolar = oRs.Fields("CotizacionLibre").Value
               End If
            Else
               MsgBox "No hay cotizacion, ingresela manualmente"
               txtCotizacionMoneda.Text = ""
            End If
            oRs.Close
         End If
      Case 4
         Check1(0).Value = 1
         CalculaFactura
      Case 5
         Check1(1).Value = 1
         CalculaFactura
      Case 6
         Check1(2).Value = 1
         CalculaFactura
      Case 10
         If mvarId <= 0 And Len(dcfields(Index).BoundText) > 0 Then
            Set oRs = Aplicacion.PuntosVenta.TraerFiltrado("_PorId", dcfields(Index).BoundText)
            If oRs.RecordCount > 0 Then
               origen.Registro.Fields("NumeroFactura").Value = oRs.Fields("ProximoNumero").Value
               txtNumeroFactura.Text = oRs.Fields("ProximoNumero").Value
            End If
            oRs.Close
         End If
      Case 11
         mvarTipoIVA = dcfields(Index).BoundText
         CalculaFactura
   End Select
   
   Set oRs = Nothing
   
End Sub

Private Sub DTFields_KeyDown(Index As Integer, KeyCode As Integer, Shift As Integer)

   If KeyCode = vbKeyReturn Then PostMessage DTFields(Index).hwnd, WM_KEYDOWN, VK_TAB, 0

End Sub

Private Sub DTFields_Validate(Index As Integer, Cancel As Boolean)

   If glbSeñal1 And Index = 0 Then
      Dim mIdObra As Long
      mIdObra = 0
      If IsNumeric(dcfields(2).BoundText) Then mIdObra = dcfields(2).BoundText
      Set dcfields(2).RowSource = Aplicacion.Obras.TraerFiltrado("_TodasActivasParaCombo", Array("SI", DTFields(0).Value))
      dcfields(2).BoundText = mIdObra
   End If

End Sub

Private Sub Form_Activate()
   
   If mvarId <= 0 And mvarCotizacion = 0 Then
      Me.Refresh
      MsgBox "No hay cotizacion, ingresela primero", vbExclamation
      Unload Me
   End If
   
   If Not origen Is Nothing Then CalculaFactura
   
'   lblIVA1.Caption = "IVA " & Format(mvarP_IVA1, "##0.00") & " %"
'   lblIVA2.Caption = "IVA " & Format(mvarP_IVA2, "##0.00") & " %"
   
'   mvarPuntoVenta = mvarPuntoVentaDefault

End Sub

Private Sub Form_Load()

   Dim oI As ListImage
   
   With Lista
      Set .SmallIcons = Img16
      .IconoPequeño = "Original"
   End With
   
   For Each oI In Img16.ListImages
      With Estado.Panels.Add(, , oI.Key)
         .Picture = oI.Picture
      End With
   Next

   CambiarLenguaje Me, "esp", glbIdiomaActual

End Sub

Private Sub Form_Paint()

   Degradado Me
   
End Sub

Private Sub Lista_DblClick()

   If Lista.ListItems.Count = 0 Then
      Editar -1
   Else
      Editar Lista.SelectedItem.Tag
   End If

End Sub

Private Sub Lista_FinCarga()

   CambiarLenguaje Me, "esp", glbIdiomaActual, "DbListView"
   
End Sub

Private Sub Lista_KeyUp(KeyCode As Integer, Shift As Integer)
   
   If KeyCode = vbKeyDelete Then
      MnuDetA_Click 2
   ElseIf KeyCode = vbKeyInsert Then
      MnuDetA_Click 0
'   ElseIf KeyCode = vbKeyReturn Then
'      MnuDetA_Click 1
   End If

End Sub

Private Sub Lista_MouseUp(Button As Integer, Shift As Integer, x As Single, y As Single)

   If Button = vbRightButton Then
      If Lista.ListItems.Count = 0 Then
         MnuDetA(1).Enabled = False
         MnuDetA(2).Enabled = False
         PopupMenu MnuDet, , , , MnuDetA(0)
      Else
         MnuDetA(1).Enabled = True
         MnuDetA(2).Enabled = True
         PopupMenu MnuDet, , , , MnuDetA(1)
      End If
   End If

End Sub

Private Sub Lista_OLEDragDrop(Data As MSComctlLib.IVBDataObject, Effect As Long, Button As Integer, Shift As Integer, x As Single, y As Single)

   Dim s As String
   Dim Filas
   Dim Columnas
   Dim iFilas As Long, iColumnas As Long, i As Long, idDet As Long
   Dim mvarImporte As Double, mvarPrecio As Double, mvarCant As Double, mPorcB As Double
   Dim mError As Boolean, mItemsNoTomados As Boolean
   Dim mColor As String
   Dim oL As ListItem
   Dim oAp As ComPronto.Aplicacion
   Dim oRs As ADOR.Recordset
   Dim oRsDet As ADOR.Recordset

   If Data.GetFormat(ccCFText) Then
      s = Data.GetData(ccCFText)
      
      Filas = Split(s, vbCrLf)
      Columnas = Split(Filas(LBound(Filas)), vbTab)
      
      If UBound(Columnas) < 2 Then
         MsgBox "No hay informacion para copiar", vbCritical
         Exit Sub
      End If
      
'      If UBound(Filas) > 1 Then
'         MsgBox "No puede arrastrar mas de un item", vbCritical
'         Exit Sub
'      End If
      
      If mvarItemsMaximo > 0 And mvarItemsMaximo <= origen.DetFacturas.CantidadRegistrosResumido Then
         MsgBox "La cantidad maxima de items por factura es de " & mvarItemsMaximo, vbExclamation
         Exit Sub
      End If
      
      'Orden de compra
      If InStr(1, Columnas(LBound(Columnas) + 3), "Nro. interno") <> 0 Then
         Set oAp = Aplicacion
         
         mItemsNoTomados = False
         
         For iFilas = LBound(Filas) + 1 To UBound(Filas)
            Columnas = Split(Filas(iFilas), vbTab)
            
            Set oRsDet = oAp.OrdenesCompra.TraerFiltrado("_ItemsPendientesDeFacturarPorIdOrdenCompra", Columnas(2))
            
            If oRsDet.RecordCount = 0 Then
               MsgBox "Esta orden de compra no tiene items pendientes de facturar", vbExclamation
               oRsDet.Close
               GoTo Salida
            End If
            
            If Not IsNull(oRsDet.Fields("Anulada").Value) And _
                  oRsDet.Fields("Anulada").Value = "SI" Then
               MsgBox "Esta orden de compra ha sido anulada", vbExclamation
               oRsDet.Close
               GoTo Salida
            End If
            
            mPorcB = IIf(IsNull(oRsDet.Fields("PorcentajeBonificacionOC").Value), 0, oRsDet.Fields("PorcentajeBonificacionOC").Value)
            With origen.Registro
               .Fields("IdCliente").Value = oRsDet.Fields("IdCliente").Value
               .Fields("IdCondicionVenta").Value = oRsDet.Fields("IdCondicionVenta").Value
               .Fields("IdMoneda").Value = oRsDet.Fields("IdMoneda").Value
               .Fields("IdObra").Value = oRsDet.Fields("IdObra").Value
               If Not IsNull(oRsDet.Fields("IdListaPrecios").Value) Then
                  mvarFijarDatos = True
                  .Fields("IdListaPrecios").Value = oRsDet.Fields("IdListaPrecios").Value
               End If
               txtPorcentajeBonificacion.Text = mPorcB
            End With
            
            Do While Not oRsDet.EOF
               mError = False
               If Lista.ListItems.Count <> 0 And mvarP_IVA1_Tomado <> oRsDet.Fields("AlicuotaIVA").Value Then
                  mError = True
                  mItemsNoTomados = True
               End If
               If mvarItemsMaximo > 0 And mvarItemsMaximo <= origen.DetFacturas.CantidadRegistrosResumido Then
                  mError = True
                  mItemsNoTomados = True
               End If
               If Not mError Then
                  mvarP_IVA1_Tomado = IIf(IsNull(oRsDet.Fields("AlicuotaIVA").Value), 0, oRsDet.Fields("AlicuotaIVA").Value)
                  txtPorcentajeIva1.Text = mvarP_IVA1_Tomado
                  mvarPrecio = IIf(IsNull(oRsDet.Fields("Precio").Value), 0, oRsDet.Fields("Precio").Value)
                  mvarCant = IIf(IsNull(oRsDet.Fields("CantidadPendienteDeFacturar").Value), 0, oRsDet.Fields("CantidadPendienteDeFacturar").Value)
                  mPorcB = IIf(IsNull(oRsDet.Fields("PorcentajeBonificacion").Value), 0, oRsDet.Fields("PorcentajeBonificacion").Value)
                  If mvarTipoABC = "B" And mvarTipoIVA <> 8 And BuscarClaveINI("Ordenes de compra iva incluido") <> "SI" Then
                     mvarPrecio = mvarPrecio + Round(mvarPrecio * mvarP_IVA1_Tomado / 100, 2)
                  End If
                  With origen.DetFacturas.Item(-1)
                     .Registro.Fields("IdArticulo").Value = oRsDet.Fields("IdArticulo").Value
                     .Registro.Fields("CodigoArticulo").Value = oRsDet.Fields("CodigoArticulo").Value
                     .Registro.Fields("Cantidad").Value = mvarCant
                     .Registro.Fields("PrecioUnitario").Value = mvarPrecio
                     .Registro.Fields("PorcentajeCertificacion").Value = oRsDet.Fields("PorcentajePendienteDeFacturar").Value
                     .Registro.Fields("OrigenDescripcion").Value = oRsDet.Fields("OrigenDescripcion").Value
                     .Registro.Fields("TipoCancelacion").Value = oRsDet.Fields("TipoCancelacion").Value
                     .Registro.Fields("IdUnidad").Value = oRsDet.Fields("IdUnidad").Value
                     .Registro.Fields("Observaciones").Value = oRsDet.Fields("Observaciones").Value
                     .Registro.Fields("PrecioUnitarioTotal").Value = mvarPrecio
                     .Registro.Fields("Bonificacion").Value = mPorcB
                     .Registro.Fields("Costo").Value = oRsDet.Fields("CostoPPP").Value
                     .Modificado = True
                     idDet = .Id
                     With .DetFacturasOrdenesCompra.Item(-1)
                        .Registro.Fields("IdDetalleFactura").Value = idDet
                        .Registro.Fields("IdDetalleOrdenCompra").Value = oRsDet.Fields("IdDetalleOrdenCompra").Value
                        .Modificado = True
                     End With
                     mColor = .Color
                     If mColor = "" Then mColor = IIf(IsNull(oRsDet.Fields("Color").Value), "", oRsDet.Fields("Color").Value)
                  End With
                  Set oL = Lista.ListItems.Add
                  oL.Tag = idDet
                  With oL
                     .SmallIcon = "Nuevo"
                     .Text = IIf(IsNull(oRsDet.Fields("CodigoArticulo").Value), "", oRsDet.Fields("CodigoArticulo").Value)
                     .SubItems(1) = "" & IIf(IsNull(oRsDet.Fields("Articulo").Value), "", oRsDet.Fields("Articulo").Value) & " " & mColor
                     .SubItems(4) = "" & Format(mvarCant, "Fixed")
                     .SubItems(5) = "" & oRsDet.Fields("Unidad").Value
                     .SubItems(6) = "" & Format(oRsDet.Fields("CostoPPP").Value, "#,##0.00")
                     .SubItems(7) = "" & Format(mvarPrecio, "#,##0.00")
                     .SubItems(8) = "" & Format(mPorcB / 100, "Percent")
                     .SubItems(9) = "" & Format(mvarPrecio * mvarCant * (1 - mPorcB / 100), "#,##0.00")
                  End With
               End If
               oRsDet.MoveNext
            Loop
            Set oRsDet = Nothing
            
            MostrarDatos (0)
            CalculaFactura
         Next
         
         If mItemsNoTomados Then
            MsgBox "Hay uno o mas items no tomados por tener alicuotas de iva distintas", vbExclamation
         End If
         
         Clipboard.Clear
      
      ElseIf InStr(1, Columnas(LBound(Columnas) + 1), "Remito") <> 0 Then
         Set oAp = Aplicacion
         
         mItemsNoTomados = False
         
         For iFilas = LBound(Filas) + 1 To UBound(Filas)
            Columnas = Split(Filas(iFilas), vbTab)
            
            Set oRs = oAp.Remitos.TraerFiltrado("_PorId", Columnas(2))
            
            If IsNull(oRs.Fields("IdCliente").Value) Then
               MsgBox "El remito debe ser a un cliente", vbExclamation
               GoTo Proximo1
            End If
            
            If Not IsNull(oRs.Fields("Anulado").Value) And oRs.Fields("Anulado").Value = "SI" Then
               MsgBox "El remito " & Columnas(1) & " ha sido anulado", vbExclamation
               GoTo Proximo1
            End If
            
            With origen.Registro
               If Not IsNull(.Fields("IdCliente").Value) And .Fields("IdCliente").Value <> oRs.Fields("IdCliente").Value Then
                  MsgBox "El remito " & Columnas(1) & " no corresponde al cliente seleccionado", vbExclamation
                  GoTo Proximo1
               End If
               .Fields("IdCliente").Value = oRs.Fields("IdCliente").Value
               .Fields("IdCondicionVenta").Value = oRs.Fields("IdCondicionVenta").Value
   '            .Fields("IdMoneda").Value = oRs.Fields("IdMoneda").Value
               .Fields("Observaciones").Value = oRs.Fields("Observaciones").Value
               If Not IsNull(oRs.Fields("IdListaPrecios").Value) Then
                  mvarFijarDatos = True
                  .Fields("IdListaPrecios").Value = oRs.Fields("IdListaPrecios").Value
               End If
            End With
            oRs.Close
            
            Set oRs = oAp.Remitos.TraerFiltrado("_DetallesPorIdRemito", Columnas(2))
            mPorcB = IIf(IsNull(oRs.Fields("PorcentajeBonificacionOC").Value), 0, oRs.Fields("PorcentajeBonificacionOC").Value)
            txtPorcentajeBonificacion.Text = mPorcB
            Do While Not oRs.EOF
               If mvarItemsMaximo > 0 And mvarItemsMaximo <= origen.DetFacturas.CantidadRegistrosResumido Then
                  MsgBox "La cantidad maxima de items por factura es de " & mvarItemsMaximo, vbExclamation
                  Exit Sub
               End If
               
               With origen.DetFacturas.Item(-1)
                  mvarP_IVA1_Tomado = IIf(IsNull(oRs.Fields("AlicuotaIVA").Value), 0, oRs.Fields("AlicuotaIVA").Value)
                  mvarPrecio = IIf(IsNull(oRs.Fields("PrecioOrdenCompra").Value), IIf(IsNull(oRs.Fields("Precio").Value), 0, oRs.Fields("Precio").Value), oRs.Fields("PrecioOrdenCompra").Value)
                  If mvarTipoABC = "B" And mvarTipoIVA <> 8 And BuscarClaveINI("Ordenes de compra iva incluido") <> "SI" Then
                     mvarPrecio = mvarPrecio + Round(mvarPrecio * mvarP_IVA1_Tomado / 100, 2)
                  End If
                  mvarCant = IIf(IsNull(oRs.Fields("AFacturar").Value), 0, oRs.Fields("AFacturar").Value)
                  mPorcB = IIf(IsNull(oRs.Fields("PorcentajeBonificacion").Value), 0, oRs.Fields("PorcentajeBonificacion").Value)
                  If Not IsNull(oRs.Fields("IdMoneda").Value) Then
                     origen.Registro.Fields("IdMoneda").Value = oRs.Fields("IdMoneda").Value
                  End If
                  With .Registro
                     .Fields("IdArticulo").Value = oRs.Fields("IdArticulo").Value
                     .Fields("CodigoArticulo").Value = oRs.Fields("CodigoArticulo").Value
                     .Fields("Cantidad").Value = mvarCant
                     .Fields("PrecioUnitario").Value = mvarPrecio
                     .Fields("PorcentajeCertificacion").Value = oRs.Fields("PorcentajeCertificacion").Value
                     .Fields("OrigenDescripcion").Value = oRs.Fields("OrigenDescripcion").Value
                     .Fields("TipoCancelacion").Value = oRs.Fields("TipoCancelacion").Value
                     .Fields("IdUnidad").Value = oRs.Fields("IdUnidad").Value
                     .Fields("Observaciones").Value = oRs.Fields("Observaciones").Value
                     .Fields("PrecioUnitarioTotal").Value = mvarPrecio
                     .Fields("Bonificacion").Value = mPorcB
                     .Fields("Costo").Value = oRs.Fields("CostoPPP").Value
                  End With
                  .Modificado = True
                  idDet = .Id
                  mvarP_IVA1_Tomado = IIf(IsNull(oRs.Fields("AlicuotaIVA").Value), 0, oRs.Fields("AlicuotaIVA").Value)
                  txtPorcentajeIva1.Text = IIf(IsNull(oRs.Fields("AlicuotaIVA").Value), 0, oRs.Fields("AlicuotaIVA").Value)
                  With .DetFacturasOrdenesCompra.Item(-1)
                     .Registro.Fields("IdDetalleFactura").Value = idDet
                     .Registro.Fields("IdDetalleOrdenCompra").Value = oRs.Fields("IdDetalleOrdenCompra").Value
                     .Modificado = True
                  End With
                  With .DetFacturasRemitos.Item(-1)
                     .Registro.Fields("IdDetalleFactura").Value = idDet
                     .Registro.Fields("IdDetalleRemito").Value = oRs.Fields("IdDetalleRemito").Value
                     .Modificado = True
                  End With
                  mColor = .Color
                  If mColor = "" Then mColor = IIf(IsNull(oRs.Fields("Color").Value), "", oRs.Fields("Color").Value)
               End With
               Set oL = Lista.ListItems.Add
               oL.Tag = idDet
               With oL
                  .SmallIcon = "Nuevo"
                  .Text = IIf(IsNull(oRs.Fields("CodigoArticulo").Value), "", oRs.Fields("CodigoArticulo").Value)
                  .SubItems(1) = "" & oRs.Fields("Articulo").Value & " " & mColor
                  .SubItems(4) = "" & Format(mvarCant, "Fixed")
                  .SubItems(5) = "" & oRs.Fields("Unidad").Value
                  .SubItems(6) = "" & Format(oRs.Fields("CostoPPP").Value, "#,##0.00")
                  .SubItems(7) = "" & Format(mvarPrecio, "#,##0.00")
                  .SubItems(8) = "" & Format(mPorcB / 100, "Percent")
                  .SubItems(9) = "" & Format(mvarCant * mvarPrecio * (1 - mPorcB / 100), "#,##0.00")
               End With
               oRs.MoveNext
            Loop
            oRs.Close
Proximo1:
         Next
         Set oRs = Nothing
         
         MostrarDatos (0)
         CalculaFactura
         
         Clipboard.Clear
      Else
         MsgBox "Objeto invalido!"
      End If
   End If
   
Salida:
   Set oRs = Nothing
   Set oRsDet = Nothing
   Set oAp = Nothing
            
End Sub

Private Sub Lista_OLEDragOver(Data As MSComctlLib.IVBDataObject, Effect As Long, Button As Integer, Shift As Integer, x As Single, y As Single, State As Integer)

   Dim s As String
   Dim Filas
   Dim Columnas
   Dim iFilas As Long
   Dim iColumnas As Long
   Dim oL As ListItem

   If State = vbEnter Then
      If Data.GetFormat(ccCFText) Then
         s = Data.GetData(ccCFText)
         Filas = Split(s, vbCrLf)
         Columnas = Split(Filas(LBound(Filas)), vbTab)
         Effect = vbDropEffectCopy
      End If
   End If

End Sub

Private Sub Lista_OLEGiveFeedback(Effect As Long, DefaultCursors As Boolean)

   If Effect = vbDropEffectNone Then
      DefaultCursors = False
   End If

End Sub

Private Sub MnuDetA_Click(Index As Integer)

   Select Case Index
      Case 0 ' Agregar
         Editar -1
      Case 1
         Editar Lista.SelectedItem.Tag
      Case 2
         If mvarId > 0 Then
            MsgBox "No puede modificar una Factura ya registrada!", vbExclamation
            Exit Sub
         End If
'         MsgBox "No puede modificar en el esquema remito-factura!", vbExclamation
'         Exit Sub
         With Lista.SelectedItem
            origen.DetFacturas.Item(.Tag).Eliminado = True
            .SmallIcon = "Eliminado"
            .ToolTipText = .SmallIcon
            If origen.DetFacturas.CantidadRegistrosResumido = 0 Then
               mvarP_IVA1_Tomado = -1
            End If
         End With
         CalculaFactura
      Case 3
         If mvarId > 0 Then
            MsgBox "No puede modificar una Factura ya registrada!", vbExclamation
            Exit Sub
         End If
         AsignaPrecio
   End Select

End Sub

Public Property Let Disparar(ByVal actl1 As ControlForm)
   
   Set Disparar = actl1
   
End Property

Public Property Set Disparar(ByVal actl1 As ControlForm)
   
   Set actL2 = actl1
   
End Property

Private Sub Form_Unload(Cancel As Integer)

   Set cALetra = Nothing
   Set actL2 = Nothing
   Set origen = Nothing
   Set oBind = Nothing
   
End Sub

Private Sub MostrarDatos(Index As Integer)

   Dim mvarLocalidad As Integer, mvarZona As Integer, mvarVendedor As Integer, mvarTransportista As Integer
   Dim mvarProvincia As Integer, mvarTipoVentaC As Integer, mvarCondicionVenta As Integer, mvarIdIBCondicion As Integer
   Dim mvarIdIBCondicion2 As Integer, mvarIdIBCondicion3 As Integer, mSeguro As Integer
   Dim Cambio As Boolean
   Dim oRs As ADOR.Recordset
   
   ' Cargo los datos del Cliente
   
   If mvarIdCliente <> dcfields(0).BoundText Then
      Cambio = True
      mvarIdCliente = dcfields(0).BoundText
   Else
      Cambio = False
   End If
   
   Set oRs = Aplicacion.Clientes.TraerFiltrado("_PorId", dcfields(0).BoundText)
   With oRs
      txtCodigoCliente.Text = IIf(IsNull(.Fields("Codigo").Value), "", .Fields("Codigo").Value)
      txtDireccion.Text = IIf(IsNull(.Fields("Direccion").Value), "", .Fields("Direccion").Value)
      txtCodigoPostal.Text = IIf(IsNull(.Fields("CodigoPostal").Value), "", .Fields("CodigoPostal").Value)
      txtCuit.Text = IIf(IsNull(.Fields("Cuit").Value), "", .Fields("Cuit").Value)
      txtTelefono.Text = IIf(IsNull(.Fields("Telefono").Value), "", .Fields("Telefono").Value)
      txtFax.Text = IIf(IsNull(.Fields("Fax").Value), "", .Fields("Fax").Value)
      txtEmail.Text = IIf(IsNull(.Fields("Email").Value), "", .Fields("Email").Value)
'      txtConsignatario.Text = IIf(IsNull(.Fields("Consignatario").Value), "", .Fields("Consignatario").Value)
      mvarLocalidad = IIf(IsNull(.Fields("IdLocalidad").Value), 0, .Fields("IdLocalidad").Value)
'      mvarZona = IIf(IsNull(oRs.Fields("IdZona").Value), 0, oRs.Fields("IdZona").Value)
      mvarZona = 0
      mvarProvincia = IIf(IsNull(.Fields("IdProvincia").Value), 0, .Fields("IdProvincia").Value)
'      mvarIBrutosC = .Fields("CodigoRetencionIBC").Value
'      mvarIBrutosB = .Fields("CodigoRetencionIBB").Value
'      mvarMultilateral = .Fields("EnConvenioMultilateral").Value
      mvarTipoIVA = IIf(IsNull(.Fields("IdCodigoIva").Value), 0, .Fields("IdCodigoIva").Value)
      mvarCondicionVenta = IIf(IsNull(.Fields("IdCondicionVenta").Value), 0, .Fields("IdCondicionVenta").Value)
      mvarIBCondicion = IIf(IsNull(.Fields("IBCondicion").Value), 1, .Fields("IBCondicion").Value)
      mvarIdIBCondicion = IIf(IsNull(.Fields("IdIBCondicionPorDefecto").Value), 0, .Fields("IdIBCondicionPorDefecto").Value)
      mvarIdIBCondicion2 = IIf(IsNull(.Fields("IdIBCondicionPorDefecto2").Value), 0, .Fields("IdIBCondicionPorDefecto2").Value)
      mvarIdIBCondicion3 = IIf(IsNull(.Fields("IdIBCondicionPorDefecto3").Value), 0, .Fields("IdIBCondicionPorDefecto3").Value)
      mvarEsAgenteRetencionIVA = IIf(IsNull(.Fields("EsAgenteRetencionIVA").Value), "NO", .Fields("EsAgenteRetencionIVA").Value)
      mvarPorcentajePercepcionIVA = IIf(IsNull(.Fields("PorcentajePercepcionIVA").Value), 0, .Fields("PorcentajePercepcionIVA").Value)
      mvarBaseMinimaParaPercepcionIVA = IIf(IsNull(.Fields("BaseMinimaParaPercepcionIVA").Value), 0, .Fields("BaseMinimaParaPercepcionIVA").Value)
      mAlicuotaDirecta = IIf(IsNull(.Fields("PorcentajeIBDirecto").Value), 0, .Fields("PorcentajeIBDirecto").Value)
      mFechaInicioVigenciaIBDirecto = IIf(IsNull(.Fields("FechaInicioVigenciaIBDirecto").Value), 0, .Fields("FechaInicioVigenciaIBDirecto").Value)
      mFechaFinVigenciaIBDirecto = IIf(IsNull(.Fields("FechaFinVigenciaIBDirecto").Value), 0, .Fields("FechaFinVigenciaIBDirecto").Value)
      mAlicuotaDirectaCapital = IIf(IsNull(.Fields("PorcentajeIBDirectoCapital").Value), 0, .Fields("PorcentajeIBDirectoCapital").Value)
      mFechaInicioVigenciaIBDirectoCapital = IIf(IsNull(.Fields("FechaInicioVigenciaIBDirectoCapital").Value), 0, .Fields("FechaInicioVigenciaIBDirectoCapital").Value)
      mFechaFinVigenciaIBDirectoCapital = IIf(IsNull(.Fields("FechaFinVigenciaIBDirectoCapital").Value), 0, .Fields("FechaFinVigenciaIBDirectoCapital").Value)
      If Not IsNull(.Fields("IdListaPrecios").Value) And mvarId <= 0 And Not mvarFijarDatos Then 'And Len(dcfields(7).Text) = 0 Then
         dcfields(7).BoundText = .Fields("IdListaPrecios").Value
      End If
      If dcfields(11).Visible Then dcfields(11).BoundText = mvarTipoIVA
   End With
   
   If Cambio Then
      mvarVendedor = IIf(IsNull(oRs.Fields("Vendedor1").Value), 0, oRs.Fields("Vendedor1").Value)
'      mvarTransportista = oRs.Fields("CodigoTransportista1").Value
'      mvarCondicionVenta = oRs.Fields("IdCondicionVenta").Value
   Else
      mvarVendedor = IIf(IsNull(origen.Registro.Fields("IdVendedor").Value), 0, origen.Registro.Fields("IdVendedor").Value)
      mvarTransportista = IIf(IsNull(origen.Registro.Fields("Idtransportista1").Value), 0, origen.Registro.Fields("Idtransportista1").Value)
   End If
   
   oRs.Close
   
   With origen.Registro
      .Fields("IdVendedor").Value = mvarVendedor
      If mvarId < 0 Then
         If Not IsNull(.Fields("IdCondicionVenta").Value) Then
            If .Fields("IdCondicionVenta").Value <> mvarCondicionVenta Then
               mSeguro = MsgBox("La condicion de venta del cliente es diferente a la actual," & vbCrLf & _
                                 "desea poner la del cliente?", vbYesNo, "Cambio de condicion de venta")
               If mSeguro = vbYes Then .Fields("IdCondicionVenta").Value = mvarCondicionVenta
            End If
         Else
            .Fields("IdCondicionVenta").Value = mvarCondicionVenta
         End If
'         .Fields(dcfields(5).DataField).Value = mvarProvincia
         If mvarIBCondicion = 1 Or mvarIBCondicion = 4 Or (mvarId < 0 And mvarPercepcionIIBB <> "SI") Then
            dcfields(4).Enabled = False
            dcfields(5).Enabled = False
            dcfields(6).Enabled = False
            .Fields("IdIBCondicion").Value = Null
            .Fields("IdIBCondicion2").Value = Null
            .Fields("IdIBCondicion3").Value = Null
            With Check1(0)
               .Value = 0
               .Enabled = False
            End With
            With Check1(1)
               .Value = 0
               .Enabled = False
            End With
            With Check1(2)
               .Value = 0
               .Enabled = False
            End With
         Else
            Check1(0).Enabled = True
            If IsNull(.Fields("IdIBCondicion").Value) Then
               .Fields("IdIBCondicion").Value = mvarIdIBCondicion
               If mvarIdIBCondicion <> 0 Then Check1(0).Value = 1
            End If
            If Check1(0).Value = 1 Then dcfields(4).Enabled = True Else dcfields(4).Enabled = False
            Check1(1).Enabled = True
            If IsNull(.Fields("IdIBCondicion2").Value) And mvarIdIBCondicion2 <> 0 Then
               .Fields("IdIBCondicion2").Value = mvarIdIBCondicion2
               If mvarIdIBCondicion2 <> 0 Then Check1(1).Value = 1
            End If
            If Check1(1).Value = 1 Then dcfields(5).Enabled = True Else dcfields(5).Enabled = False
            Check1(2).Enabled = True
            If IsNull(.Fields("IdIBCondicion3").Value) And mvarIdIBCondicion3 <> 0 Then
               .Fields("IdIBCondicion3").Value = mvarIdIBCondicion3
               If mvarIdIBCondicion3 <> 0 Then Check1(2).Value = 1
            End If
            If Check1(2).Value = 1 Then dcfields(6).Enabled = True Else dcfields(6).Enabled = False
         End If
      End If
   End With

   Set oRs = Aplicacion.Localidades.TraerFiltrado("_PorId", mvarLocalidad)
   If oRs.RecordCount > 0 Then txtLocalidad.Text = IIf(IsNull(oRs.Fields("Nombre").Value), "", oRs.Fields("Nombre").Value)
   oRs.Close
   
   Set oRs = Aplicacion.Provincias.TraerFiltrado("_PorId", mvarProvincia)
   If oRs.RecordCount > 0 Then txtProvincia.Text = IIf(IsNull(oRs.Fields("Nombre").Value), "", oRs.Fields("Nombre").Value)
   oRs.Close
   
   Set oRs = Aplicacion.TablasGenerales.TraerFiltrado("DescripcionIva", "_PorId", mvarTipoIVA)
   If oRs.RecordCount > 0 Then txtCondicionIva.Text = IIf(IsNull(oRs.Fields("Descripcion").Value), "", oRs.Fields("Descripcion").Value)
   oRs.Close
   
   If EstadoEntidad("Clientes", mvarIdCliente) = "INACTIVO" Then
      MsgBox "Cliente inhabilitado, no podra registrar este comprobante", vbExclamation
   End If
   
'   If Not IsNull(origen.Registro.Fields("IdPedido").Value) Then
'      Set oRs = oAp.Pedidos.Item(origen.Registro.Fields("IdPedido").Value).Registro
'      txtNumeroPedido.Text = "Nro. " & oRs.Fields("NumeroPedido").Value & " del " & oRs.Fields("FechaPedido").Value
'      oRs.Close
'   End If
   
   Set oRs = Nothing
   
   If mvarId > 0 And Not mvarModificacionHabilitada Then txtNumeroFactura.Text = origen.Registro.Fields("NumeroFactura").Value
   
   CalculaFactura
   
End Sub

Private Sub txtCodigoCliente_Change()

'   If Len(txtCodigoCliente.Text) > 0 Then
''      If Not IsNumeric(txtCodigoCliente.Text) Then
''         MsgBox "El codigo de cliente debe ser un numero", vbExclamation
''         Exit Sub
''      End If
'      Dim oRs As ADOR.Recordset
'      Set oRs = Aplicacion.Clientes.TraerFiltrado("_PorCodigo", txtCodigoCliente.Text)
'      If oRs.RecordCount > 0 Then
'         origen.Registro.Fields("IdCliente").Value = oRs.Fields(0).Value
'      Else
'         origen.Registro.Fields("IdCliente").Value = Null
'      End If
'      oRs.Close
'      Set oRs = Nothing
'   End If

End Sub

Private Sub txtCodigoCliente_GotFocus()

   With txtCodigoCliente
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtCodigoCliente_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtCodigoCliente_Validate(Cancel As Boolean)

   If Len(txtCodigoCliente.Text) > 0 Then
      Dim oRs As ADOR.Recordset
      Set oRs = Aplicacion.Clientes.TraerFiltrado("_PorCodigo", txtCodigoCliente.Text)
      If oRs.RecordCount > 0 Then
         origen.Registro.Fields("IdCliente").Value = oRs.Fields(0).Value
      Else
         MsgBox "Codigo de cliente inexistente", vbExclamation
         Cancel = True
      End If
      oRs.Close
      Set oRs = Nothing
   End If
   
End Sub

Private Sub txtCotizacionDolar_GotFocus()

   With txtCotizacionDolar
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtCotizacionDolar_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtCotizacionDolar_Validate(Cancel As Boolean)

   If origen.Registro.Fields("IdMoneda").Value = mvarIdMonedaDolar Then
      txtCotizacionMoneda.Text = txtCotizacionDolar.Text
   End If

End Sub

Private Sub txtCotizacionMoneda_GotFocus()

   With txtCotizacionMoneda
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtCotizacionMoneda_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtCotizacionMoneda_Validate(Cancel As Boolean)

   If origen.Registro.Fields("IdMoneda").Value = mvarIdMonedaDolar Then
      txtCotizacionDolar.Text = txtCotizacionMoneda.Text
   End If

End Sub

Private Sub txtNumeroFactura_Change()
   
   If mvarId > 0 Then MostrarDatos (0)

End Sub

Private Sub txtNumeroFactura_Validate(Cancel As Boolean)
   
   Dim oRs As ADOR.Recordset
   Set oRs = Aplicacion.Facturas.TraerFiltrado("_PorNumeroComprobante", Array(mvarTipoABC, Val(dcfields(10).Text), Val(txtNumeroFactura.Text)))
   If oRs.RecordCount > 0 Then
      If oRs.Fields(0).Value <> mvarId Then
         MsgBox "Factura ya ingresada el " & oRs.Fields("FechaFactura").Value & ". Reingrese.", vbCritical
         Cancel = True
      End If
   End If
   oRs.Close
   Set oRs = Nothing

End Sub

Private Sub txtPorcentajeBonificacion_Change()

   CalculaFactura
   
End Sub

Private Sub txtPorcentajeBonificacion_GotFocus()

   With txtPorcentajeBonificacion
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtPorcentajeBonificacion_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtPorcentajeBonificacion_Validate(Cancel As Boolean)

'   If Val(txtPorcentajeBonificacion.Text) > mvarPorcentajeMaximoBonificacion Then
'      MsgBox "El porcentaje de bonificacion no puede superar el " & mvarPorcentajeMaximoBonificacion & " %", vbExclamation
'      Cancel = True
'   End If

End Sub

Private Sub CalculaFactura()

   Dim oRs As ADOR.Recordset
   Dim oRs1 As ADOR.Recordset
   Dim oL As ListItem
   Dim i As Integer, mIdProvinciaIIBB As Integer, mIdProvinciaRealIIBB As Integer
   Dim mNumeroCertificadoPercepcionIIBB As Long
   Dim t0 As Double, t1 As Double, t2 As Double, t3 As Double, mParteDolar As Double, mPartePesos As Double, mKilos As Double
   Dim mBonificacion As Double, mPrecioUnitario As Double, mCantidad As Double, mTopeIIBB As Double
   Dim mCodigoProvincia As String, mPuntoVentaActivo As String
   Dim mFecha1 As Date
   
   t0 = 0
   t1 = 0
   t2 = 0
   t3 = 0
   mvarSubTotal = 0
   mvarIBrutos = 0
   mvarIBrutos2 = 0
   mvarIBrutos3 = 0
   mvarPorcentajeIBrutos = 0
   mvarPorcentajeIBrutos2 = 0
   mvarPorcentajeIBrutos3 = 0
   mvar_IBrutos_Cap = 0
   mvar_IBrutos_BsAs = 0
   mvar_IBrutos_BsAsM = 0
   mvarMultilateral = "NO"
   mvarIVA1 = 0
   mvarIVA2 = 0
   mvarTotalFactura = 0
   mvarParteDolares = 0
   mvarPartePesos = 0
   mvarImporteBonificacion = 0
   mvarNetoGravado = 0
   mvarPorcentajeBonificacion = 0
   mvarIVANoDiscriminado = 0
   mIdProvinciaIIBB = 0
   mNumeroCertificadoPercepcionIIBB = 0
   mvarPercepcionIVA = 0
   mvarAjusteIVA = 0
   mPuntoVentaActivo = ""
   
   If IsNumeric(txtPorcentajeBonificacion.Text) Then mvarPorcentajeBonificacion = Val(txtPorcentajeBonificacion.Text)
   
   For Each oL In Lista.ListItems
      With origen.DetFacturas.Item(oL.Tag)
         If Not .Eliminado Then
            mPrecioUnitario = IIf(IsNull(.Registro.Fields("PrecioUnitario").Value), 0, .Registro.Fields("PrecioUnitario").Value)
            mCantidad = IIf(IsNull(.Registro.Fields("Cantidad").Value), 0, .Registro.Fields("Cantidad").Value)
            mBonificacion = IIf(IsNull(.Registro.Fields("Bonificacion").Value), 0, .Registro.Fields("Bonificacion").Value)
            t0 = t0 + Val(oL.ListSubItems(2))
            t1 = t1 + Val(oL.ListSubItems(3))
            t2 = t2 + mCantidad
            t3 = t3 + Round(mCantidad * mPrecioUnitario * (1 - mBonificacion / 100) + 0.0001, 2)
'Debug.Print Round(mCantidad * mPrecioUnitario * (1 - mBonificacion / 100) + 0.0001, 2)
         End If
      End With
   Next
   
   mvarSubTotal = t3
   
   If mvarId > 0 Then
      With origen.Registro
         mvarTipoABC = IIf(IsNull(.Fields("TipoABC").Value), "", .Fields("TipoABC").Value)
         mvarPuntoVenta = IIf(IsNull(.Fields("PuntoVenta").Value), mvarPuntoVentaDefault, .Fields("PuntoVenta").Value)
         mvarTotalFactura = .Fields("ImporteTotal").Value
         mvarIVA1 = IIf(IsNull(.Fields("ImporteIva1").Value), 0, .Fields("ImporteIva1").Value)
         mvarIVA2 = IIf(IsNull(.Fields("ImporteIva2").Value), 0, .Fields("ImporteIva2").Value)
         mvarIVANoDiscriminado = IIf(IsNull(.Fields("IVANoDiscriminado").Value), 0, .Fields("IVANoDiscriminado").Value)
         mvarIBrutos = IIf(IsNull(.Fields("RetencionIBrutos1").Value), 0, .Fields("RetencionIBrutos1").Value)
         mvarPorcentajeIBrutos = IIf(IsNull(.Fields("PorcentajeIBrutos1").Value), 0, .Fields("PorcentajeIBrutos1").Value)
         mvarIBrutos2 = IIf(IsNull(.Fields("RetencionIBrutos2").Value), 0, .Fields("RetencionIBrutos2").Value)
         mvarPorcentajeIBrutos2 = IIf(IsNull(.Fields("PorcentajeIBrutos2").Value), 0, .Fields("PorcentajeIBrutos2").Value)
         mvarMultilateral = IIf(IsNull(.Fields("ConvenioMultilateral").Value), 0, .Fields("ConvenioMultilateral").Value)
         mvarIBrutos3 = IIf(IsNull(.Fields("RetencionIBrutos3").Value), 0, .Fields("RetencionIBrutos3").Value)
         mvarPorcentajeIBrutos3 = IIf(IsNull(.Fields("PorcentajeIBrutos3").Value), 0, .Fields("PorcentajeIBrutos3").Value)
         mvarParteDolares = IIf(IsNull(.Fields("ImporteParteEnDolares").Value), 0, .Fields("ImporteParteEnDolares").Value)
         mvarPartePesos = IIf(IsNull(.Fields("ImporteParteEnPesos").Value), 0, .Fields("ImporteParteEnPesos").Value)
         mvarImporteBonificacion = IIf(IsNull(.Fields("ImporteBonificacion").Value), 0, .Fields("ImporteBonificacion").Value)
         mvarPorcentajeBonificacion = IIf(IsNull(.Fields("PorcentajeBonificacion").Value), 0, .Fields("PorcentajeBonificacion").Value)
         mvarPercepcionIVA = IIf(IsNull(.Fields("PercepcionIVA").Value), 0, .Fields("PercepcionIVA").Value)
         mvarAjusteIVA = IIf(IsNull(.Fields("AjusteIVA").Value), 0, .Fields("AjusteIVA").Value)
      End With
   Else
      mvarImporteBonificacion = Round(mvarSubTotal * mvarPorcentajeBonificacion / 100, 2)
      mvarNetoGravado = mvarSubTotal - mvarImporteBonificacion
      mPuntoVentaActivo = "SI"
      
'      If mvarIBrutosC = "S" And mvarPorc_IBrutos_Cap <> 0 And mvarNetoGravado > mvarTope_IBrutos_Cap Then
'         mvar_IBrutos_Cap = Round(mvarPorc_IBrutos_Cap * mvarNetoGravado / 100, mvarDecimales)
'      End If
'
'      If mvarIBrutosB = "S" Then
'         If mvarMultilateral = "S" Then
'            If mvarPorc_IBrutos_BsAs <> 0 And mvarNetoGravado > mvarTope_IBrutos_BsAs Then
'               mvar_IBrutos_BsAs = Round(mvarPorc_IBrutos_BsAs * mvarNetoGravado / 100, mvarDecimales)
'            End If
'         Else
'            If mvarPorc_IBrutos_BsAsM <> 0 And mvarNetoGravado > mvarTope_IBrutos_BsAsM Then
'               mvar_IBrutos_BsAsM = Round(mvarPorc_IBrutos_BsAsM * mvarNetoGravado / 100, mvarDecimales)
'            End If
'         End If
'      End If
      
      If glbIdCodigoIva = 1 Then
         Select Case mvarTipoIVA
            Case 1
               mvarIVA1 = Round(mvarNetoGravado * Val(txtPorcentajeIva1.Text) / 100, mvarDecimales)
               mvarPartePesos = mvarPartePesos + Round((mvarPartePesos + (mvarParteDolares * mvarCotizacion)) * Val(txtPorcentajeIva1.Text) / 100, mvarDecimales)
               mvarTipoABC = "A"
            Case 2
               mvarIVA1 = Round(mvarNetoGravado * Val(txtPorcentajeIva1.Text) / 100, mvarDecimales)
               mvarIVA2 = Round(mvarNetoGravado * Val(txtPorcentajeIva2.Text) / 100, mvarDecimales)
               mvarPartePesos = mvarPartePesos + Round((mvarPartePesos + (mvarParteDolares * mvarCotizacion)) * Val(txtPorcentajeIva1.Text) / 100, mvarDecimales) + _
                                                 Round((mvarPartePesos + (mvarParteDolares * mvarCotizacion)) * Val(txtPorcentajeIva2.Text) / 100, mvarDecimales)
               mvarTipoABC = "A"
            Case 3
               mvarTipoABC = "E"
            Case 8
               mvarTipoABC = "B"
            Case 9
               mvarTipoABC = "A"
            Case Else
               mvarIVANoDiscriminado = Round(mvarNetoGravado - (mvarNetoGravado / (1 + (Val(txtPorcentajeIva1.Text) / 100))), mvarDecimales)
               mvarTipoABC = "B"
         End Select
      Else
         mvarTipoABC = "C"
      End If
      If mvarTipoABC = "A" And glbModalidadFacturacionAPrueba Then mvarTipoABC = "M"
   
      origen.Registro.Fields("NumeroCertificadoPercepcionIIBB").Value = Null
      If dcfields(4).Enabled And Check1(0).Value = 1 And IsNumeric(dcfields(4).BoundText) Then
         Set oRs = Aplicacion.IBCondiciones.TraerFiltrado("_PorId", dcfields(4).BoundText)
         If oRs.RecordCount > 0 Then
            mTopeIIBB = IIf(IsNull(oRs.Fields("ImporteTopeMinimoPercepcion").Value), 0, oRs.Fields("ImporteTopeMinimoPercepcion").Value)
            mIdProvinciaIIBB = IIf(IsNull(oRs.Fields("IdProvincia").Value), 0, oRs.Fields("IdProvincia").Value)
            mIdProvinciaRealIIBB = IIf(IsNull(oRs.Fields("IdProvinciaReal").Value), oRs.Fields("IdProvincia").Value, oRs.Fields("IdProvinciaReal").Value)
            mFecha1 = IIf(IsNull(oRs.Fields("FechaVigencia").Value), Date, oRs.Fields("FechaVigencia").Value)
            mCodigoProvincia = ""
            Set oRs1 = Aplicacion.Provincias.TraerFiltrado("_PorId", mIdProvinciaRealIIBB)
            If oRs1.RecordCount > 0 Then mCodigoProvincia = IIf(IsNull(oRs1.Fields("InformacionAuxiliar").Value), "", oRs1.Fields("InformacionAuxiliar").Value)
            oRs1.Close
            If mCodigoProvincia = "902" And DTFields(0).Value >= mFechaInicioVigenciaIBDirecto And DTFields(0).Value <= mFechaFinVigenciaIBDirecto Then
               mvarPorcentajeIBrutos = mAlicuotaDirecta
            ElseIf mCodigoProvincia = "901" And DTFields(0).Value >= mFechaInicioVigenciaIBDirectoCapital And DTFields(0).Value <= mFechaFinVigenciaIBDirectoCapital Then
               mvarPorcentajeIBrutos = mAlicuotaDirectaCapital
            Else
               If mvarNetoGravado > mTopeIIBB And DTFields(0).Value >= mFecha1 Then
                  If mvarIBCondicion = 2 Then
                     mvarPorcentajeIBrutos = IIf(IsNull(oRs.Fields("AlicuotaPercepcionConvenio").Value), 0, oRs.Fields("AlicuotaPercepcionConvenio").Value)
                     mvarMultilateral = "SI"
                  Else
                     mvarPorcentajeIBrutos = IIf(IsNull(oRs.Fields("AlicuotaPercepcion").Value), 0, oRs.Fields("AlicuotaPercepcion").Value)
                  End If
               End If
            End If
            mvarIBrutos = Round(mvarNetoGravado * mvarPorcentajeIBrutos / 100, 2) 'Round((mvarNetoGravado - mvarIVANoDiscriminado) * mvarPorcentajeIBrutos / 100, 2)
         End If
         oRs.Close
         If mvarIBrutos <> 0 Then
            Set oRs = Aplicacion.Provincias.TraerFiltrado("_PorId", mIdProvinciaIIBB)
            If oRs.RecordCount > 0 Then
               mNumeroCertificadoPercepcionIIBB = IIf(IsNull(oRs.Fields("ProximoNumeroCertificadoPercepcionIIBB").Value), 1, oRs.Fields("ProximoNumeroCertificadoPercepcionIIBB").Value)
            End If
            oRs.Close
            origen.Registro.Fields("NumeroCertificadoPercepcionIIBB").Value = mNumeroCertificadoPercepcionIIBB
         End If
         Set oRs = Nothing
      End If
      
      If dcfields(5).Enabled And Check1(1).Value = 1 And IsNumeric(dcfields(5).BoundText) Then
         Set oRs = Aplicacion.IBCondiciones.TraerFiltrado("_PorId", dcfields(5).BoundText)
         If oRs.RecordCount > 0 Then
            mTopeIIBB = IIf(IsNull(oRs.Fields("ImporteTopeMinimoPercepcion").Value), 0, oRs.Fields("ImporteTopeMinimoPercepcion").Value)
            mIdProvinciaIIBB = IIf(IsNull(oRs.Fields("IdProvincia").Value), 0, oRs.Fields("IdProvincia").Value)
            mIdProvinciaRealIIBB = IIf(IsNull(oRs.Fields("IdProvinciaReal").Value), oRs.Fields("IdProvincia").Value, oRs.Fields("IdProvinciaReal").Value)
            mCodigoProvincia = ""
            Set oRs1 = Aplicacion.Provincias.TraerFiltrado("_PorId", mIdProvinciaRealIIBB)
            If oRs1.RecordCount > 0 Then mCodigoProvincia = IIf(IsNull(oRs1.Fields("InformacionAuxiliar").Value), "", oRs1.Fields("InformacionAuxiliar").Value)
            oRs1.Close
            If mCodigoProvincia = "902" And DTFields(0).Value >= mFechaInicioVigenciaIBDirecto And DTFields(0).Value <= mFechaFinVigenciaIBDirecto Then
               mvarPorcentajeIBrutos2 = mAlicuotaDirecta
            ElseIf mCodigoProvincia = "901" And DTFields(0).Value >= mFechaInicioVigenciaIBDirectoCapital And DTFields(0).Value <= mFechaFinVigenciaIBDirectoCapital Then
               mvarPorcentajeIBrutos2 = mAlicuotaDirectaCapital
            Else
               If mvarNetoGravado > mTopeIIBB And DTFields(0).Value >= mFecha1 Then
                  If mvarIBCondicion = 2 Then
                     mvarPorcentajeIBrutos2 = IIf(IsNull(oRs.Fields("AlicuotaPercepcionConvenio").Value), 0, oRs.Fields("AlicuotaPercepcionConvenio").Value)
                     mvarMultilateral = "SI"
                  Else
                     mvarPorcentajeIBrutos2 = IIf(IsNull(oRs.Fields("AlicuotaPercepcion").Value), 0, oRs.Fields("AlicuotaPercepcion").Value)
                  End If
               End If
            End If
            mvarIBrutos2 = Round(mvarNetoGravado * mvarPorcentajeIBrutos2 / 100, 2)  'Round((mvarNetoGravado - mvarIVANoDiscriminado) * mvarPorcentajeIBrutos2 / 100, 2)
         End If
         oRs.Close
         Set oRs = Nothing
      End If
      
      If dcfields(6).Enabled And Check1(2).Value = 1 And IsNumeric(dcfields(6).BoundText) Then
         Set oRs = Aplicacion.IBCondiciones.TraerFiltrado("_PorId", dcfields(6).BoundText)
         If oRs.RecordCount > 0 Then
            mTopeIIBB = IIf(IsNull(oRs.Fields("ImporteTopeMinimoPercepcion").Value), 0, oRs.Fields("ImporteTopeMinimoPercepcion").Value)
            mIdProvinciaIIBB = IIf(IsNull(oRs.Fields("IdProvincia").Value), 0, oRs.Fields("IdProvincia").Value)
            mIdProvinciaRealIIBB = IIf(IsNull(oRs.Fields("IdProvinciaReal").Value), oRs.Fields("IdProvincia").Value, oRs.Fields("IdProvinciaReal").Value)
            mCodigoProvincia = ""
            Set oRs1 = Aplicacion.Provincias.TraerFiltrado("_PorId", mIdProvinciaRealIIBB)
            If oRs1.RecordCount > 0 Then mCodigoProvincia = IIf(IsNull(oRs1.Fields("InformacionAuxiliar").Value), "", oRs1.Fields("InformacionAuxiliar").Value)
            oRs1.Close
            If mCodigoProvincia = "902" And DTFields(0).Value >= mFechaInicioVigenciaIBDirecto And DTFields(0).Value <= mFechaFinVigenciaIBDirecto Then
               mvarPorcentajeIBrutos3 = mAlicuotaDirecta
            ElseIf mCodigoProvincia = "901" And DTFields(0).Value >= mFechaInicioVigenciaIBDirectoCapital And DTFields(0).Value <= mFechaFinVigenciaIBDirectoCapital Then
               mvarPorcentajeIBrutos3 = mAlicuotaDirectaCapital
            Else
               If mvarNetoGravado > mTopeIIBB And DTFields(0).Value >= mFecha1 Then
                  If mvarIBCondicion = 2 Then
                     mvarPorcentajeIBrutos3 = IIf(IsNull(oRs.Fields("AlicuotaPercepcionConvenio").Value), 0, oRs.Fields("AlicuotaPercepcionConvenio").Value)
                     mvarMultilateral = "SI"
                  Else
                     mvarPorcentajeIBrutos3 = IIf(IsNull(oRs.Fields("AlicuotaPercepcion").Value), 0, oRs.Fields("AlicuotaPercepcion").Value)
                  End If
               End If
            End If
            mvarIBrutos3 = Round(mvarNetoGravado * mvarPorcentajeIBrutos3 / 100, 2)  'Round((mvarNetoGravado - mvarIVANoDiscriminado) * mvarPorcentajeIBrutos3 / 100, 2)
         End If
         oRs.Close
         Set oRs = Nothing
      End If
      
      If mvarEsAgenteRetencionIVA = "NO" And mvarNetoGravado >= mvarBaseMinimaParaPercepcionIVA Then
         mvarPercepcionIVA = Round(mvarNetoGravado * mvarPorcentajePercepcionIVA / 100, mvarDecimales)
      End If
      
      mvarPuntoVenta = 0
      If IsNumeric(dcfields(10).BoundText) Then mvarPuntoVenta = dcfields(10).BoundText
      If mvarNumeracionUnica And mvarTipoABC <> "E" Then
         Set oRs = Aplicacion.PuntosVenta.TraerFiltrado("_PuntosVentaPorIdTipoComprobanteLetra", Array(1, mvarTipoABC, mPuntoVentaActivo))
      Else
         Set oRs = Aplicacion.PuntosVenta.TraerFiltrado("_PuntosVentaPorIdTipoComprobanteLetra", Array(1, mvarTipoABC, mPuntoVentaActivo))
      End If
      If oRs.RecordCount = 1 Then
         oRs.MoveFirst
         mvarPuntoVenta = oRs.Fields(0).Value
         If mvarId <= 0 Then
            origen.Registro.Fields("NumeroFactura").Value = oRs.Fields("ProximoNumero").Value
            txtNumeroFactura.Text = oRs.Fields("ProximoNumero").Value
         End If
      End If
      Set dcfields(10).RowSource = oRs
      dcfields(10).BoundText = mvarPuntoVenta
      Set oRs = Nothing
      If Len(dcfields(10).Text) = 0 Then
         origen.Registro.Fields("NumeroFactura").Value = Null
         txtNumeroFactura.Text = ""
      End If
      
      mvarAjusteIVA = Val(txtTotal(12).Text)
      
      mvarTotalFactura = mvarNetoGravado + mvarIVA1 + mvarIVA2 + mvarIBrutos + mvarIBrutos2 + mvarIBrutos3 + mvarPercepcionIVA + _
               Val(txtTotal(6).Text) + Val(txtTotal(7).Text) + Val(txtTotal(10).Text) + mvarAjusteIVA
   End If
   
   If mvarTipoABC = "E" Then
      If Not cmd(3).Enabled Then cmd(3).Enabled = True
      lblLabels(14).Visible = True
      Combo1(0).Visible = True
      Frame3.Visible = True
   Else
      If cmd(3).Enabled Then cmd(3).Enabled = False
      lblLabels(14).Visible = False
      Combo1(0).Visible = False
      Frame3.Visible = False
   End If
   lblLetra.Caption = mvarTipoABC
   
   txtTotal(3).Text = Format(mvarSubTotal, "#,##0.00")
   txtTotal(9).Text = Format(mvarImporteBonificacion, "#,##0.00")
   txtTotal(4).Text = Format(mvarIVA1, "#,##0.00")
   txtTotal(5).Text = Format(mvarIBrutos + mvarIBrutos2 + mvarIBrutos3, "#,##0.00")
   txtTotal(11).Text = Format(mvarPercepcionIVA, "#,##0.00")
   txtTotal(8).Text = Format(mvarTotalFactura, "#,##0.00")

   MostrarTotales
   
   Set oRs = Nothing
   Set oRs1 = Nothing
   
End Sub

Private Sub txtPorcentajeDevolucionAnticipo_Validate(Cancel As Boolean)

   If Len(txtPorcentajeDevolucionAnticipo) > 0 Then
      If Not IsNumeric(txtPorcentajeDevolucionAnticipo.Text) Then
         MsgBox "El porcentaje de devolucion de anticipo debe ser un numero positivo", vbExclamation
         Cancel = True
         Exit Sub
      Else
         If Val(txtPorcentajeDevolucionAnticipo.Text) < 0 Then
            MsgBox "El porcentaje de devolucion de anticipo debe ser un numero positivo", vbExclamation
            Cancel = True
            Exit Sub
         End If
      End If
   End If

End Sub

Private Sub txtPorcentajeIva1_Change()

   CalculaFactura
   
End Sub

Private Sub txtPorcentajeIva1_GotFocus()

   With txtPorcentajeIva1
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtPorcentajeIva1_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtPorcentajeIva2_Change()

   CalculaFactura
   
End Sub

Private Sub txtPorcentajeIva2_GotFocus()

   With txtPorcentajeIva2
      .SelStart = 0
      .SelLength = Len(.Text)
   End With

End Sub

Private Sub txtPorcentajeIva2_KeyPress(KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtTotal_GotFocus(Index As Integer)

   If txtTotal(Index).Enabled Then
      With txtTotal(Index)
         .SelStart = 0
         .SelLength = Len(.Text)
      End With
   End If

End Sub

Private Sub txtTotal_KeyPress(Index As Integer, KeyAscii As Integer)

   If KeyAscii = Asc(vbCr) Then SendKeys "{TAB}", True

End Sub

Private Sub txtTotal_LostFocus(Index As Integer)

   If txtTotal(Index).Enabled Then CalculaFactura
   
End Sub

Private Sub AnularFactura()

   Dim oRs As ADOR.Recordset
   Dim oRs1 As ADOR.Recordset
   
   Set oRs = Aplicacion.PuntosVenta.TraerFiltrado("_PorId", dcfields(10).BoundText)
   If oRs.RecordCount > 0 Then
      If Len(IIf(IsNull(oRs.Fields("WebService").Value), "", oRs.Fields("WebService").Value)) > 0 Then
         Set oRs = Nothing
         MsgBox "No puede anular un comprobante electronico (CAE)", vbExclamation
         Exit Sub
      End If
   End If
   oRs.Close
   
   Set oRs = Aplicacion.CtasCtesD.TraerFiltrado("_BuscarComprobante", Array(mvarId, 1))
   If oRs.RecordCount > 0 Then
      If oRs.Fields("ImporteTotal").Value <> oRs.Fields("Saldo").Value Then
         oRs.Close
         Set oRs = Nothing
         MsgBox "La factura ha sido cancelada parcial o totalmente y no puede anularse", vbExclamation
         Exit Sub
      End If
   End If
   oRs.Close
   Set oRs = Nothing
   
   Dim oF As frmAutorizacion
   Dim mOk As Boolean
   Dim mIdAutorizaAnulacion As Integer
   Set oF = New frmAutorizacion
   With oF
      .Empleado = 0
      .IdFormulario = EnumFormularios.Facturas
      '.Administradores = True
      .Show vbModal, Me
      mOk = .Ok
      mIdAutorizaAnulacion = .IdAutorizo
   End With
   Unload oF
   Set oF = Nothing
   If Not mOk Then
      Exit Sub
   End If
   
   Me.Refresh
   
   Dim mSeguro As Integer
   mSeguro = MsgBox("Esta seguro de anular la factura?", vbYesNo, "Anulacion de factura")
   If mSeguro = vbNo Then
      Exit Sub
   End If

   With origen
      .Registro.Fields("Anulada").Value = "SI"
      .Registro.Fields("FechaAnulacion").Value = Now
      .Registro.Fields("IdAutorizaAnulacion").Value = mIdAutorizaAnulacion
      .Guardar
   End With

   If Check3.Value = 1 Then
      Set oRs = Aplicacion.Facturas.TraerFiltrado("_NCs_RecuperoGastos", mvarId)
      If oRs.RecordCount > 0 Then
         If oRs.Fields("IdNotaCredito").Value <> 0 Then
            Dim oNC As ComPronto.NotaCredito
            Set oNC = Aplicacion.NotasCredito.Item(oRs.Fields("IdNotaCredito").Value)
            With oNC
               With .Registro
                  .Fields("Anulada").Value = "OK"
                  .Fields("IdUsuarioAnulacion").Value = mIdAutorizaAnulacion
                  .Fields("FechaAnulacion").Value = Now
               End With
               .Guardar
            End With
            Set oNC = Nothing
         End If
         If oRs.Fields("IdComprobanteProveedor").Value <> 0 Then
            Dim oCP As ComPronto.ComprobanteProveedor
            Set oCP = Aplicacion.ComprobantesProveedores.Item(oRs.Fields("IdComprobanteProveedor").Value)
            With oCP
               With .Registro
                  .Fields("TotalBruto").Value = 0
                  .Fields("TotalIva1").Value = 0
                  .Fields("TotalIva2").Value = 0
                  .Fields("TotalComprobante").Value = 0
               End With
               Set oRs1 = .DetComprobantesProveedores.TraerTodos
               If oRs1.RecordCount > 0 Then
                  oRs1.MoveFirst
                  Do While Not oRs1.EOF
                     With .DetComprobantesProveedores.Item(oRs1.Fields(0).Value)
                        With .Registro
                           .Fields("Importe").Value = 0
                           .Fields("IdCuentaIvaCompras1").Value = Null
                           .Fields("IVAComprasPorcentaje1").Value = 0
                           .Fields("ImporteIVA1").Value = 0
                           .Fields("AplicarIVA1").Value = "NO"
                        End With
                        .Modificado = True
                     End With
                     oRs1.MoveNext
                  Loop
               End If
               .Guardar
               Set oRs1 = Nothing
            End With
            Set oCP = Nothing
         End If
      End If
      oRs.Close
      Set oRs = Nothing
   End If
   
   Unload Me

End Sub

Private Sub VerificarProvinciasDestino()

   Dim oRs As ADOR.Recordset
   Dim mVacio As Boolean
   Dim mIdCliente As Long
   Dim mIdProvincia As Integer
   
   Set oRs = origen.DetFacturasProvincias.Registros
   mVacio = True
   With oRs
      If .Fields.Count > 0 Then
         If .RecordCount > 0 Then
            .MoveFirst
            Do While Not .EOF
               If Not .Fields("Eliminado").Value Then
                  mVacio = False
                  Exit Do
               End If
               .MoveNext
            Loop
         End If
      End If
   End With
   Set oRs = Nothing
   
   If mVacio Then
      mIdCliente = 0
      mIdProvincia = 0
      If Not IsNull(origen.Registro.Fields("IdCliente").Value) Then
         mIdCliente = origen.Registro.Fields("IdCliente").Value
      End If
      Set oRs = Aplicacion.Clientes.TraerFiltrado("_PorId", mIdCliente)
      If oRs.RecordCount > 0 Then
         mIdProvincia = IIf(IsNull(oRs.Fields("IdProvincia").Value), 0, oRs.Fields("IdProvincia").Value)
      End If
      oRs.Close
      
      With origen.DetFacturasProvincias.Item(-1)
         With .Registro
            .Fields("IdProvinciaDestino").Value = mIdProvincia
            .Fields("Porcentaje").Value = 100
         End With
         .Modificado = True
      End With
   End If

   Set oRs = Nothing

End Sub

Private Sub DatosExportacion()

   On Error GoTo Mal
   
   Dim oF As frm_Aux
   Dim mOk As Boolean
   
   Set oF = New frm_Aux
   With oF
      .Caption = "Datos para exportaciones"
      With .Label2(0)
         .Caption = "Valor FOB :"
         .Visible = True
      End With
      With .Text2
         .Top = oF.Label2(0).Top
         .Left = oF.Text1.Left
         .Text = IIf(IsNull(origen.Registro.Fields("Exportacion_FOB").Value), "", _
                           origen.Registro.Fields("Exportacion_FOB").Value)
         .Visible = True
      End With
      .Label1.Caption = "Posicion aduana : "
      With .Text1
         .Text = IIf(IsNull(origen.Registro.Fields("Exportacion_PosicionAduana").Value), "", _
                           origen.Registro.Fields("Exportacion_PosicionAduana").Value)
         .Width = .Width * 2
      End With
      With .Label2(1)
         .Caption = "Despacho : "
         .Visible = True
      End With
      With .Text3
         .Top = oF.Label2(1).Top
         .Left = oF.Text1.Left
         .Text = IIf(IsNull(origen.Registro.Fields("Exportacion_Despacho").Value), "", _
                           origen.Registro.Fields("Exportacion_Despacho").Value)
         .Width = .Width * 2.5
         .Visible = True
      End With
      With .Label2(2)
         .Top = oF.Label2(1).Top + oF.Label2(1).Height + 100
         .Left = oF.Label2(1).Left
         .Caption = "Guia :"
         .Visible = True
      End With
      With .Text4
         .Top = oF.Label2(2).Top
         .Left = oF.Text3.Left
         .Text = IIf(IsNull(origen.Registro.Fields("Exportacion_Guia").Value), "", _
                           origen.Registro.Fields("Exportacion_Guia").Value)
         .Width = .Width * 1.5
         .Visible = True
      End With
      With .Label2(3)
         .Top = oF.Label2(2).Top + oF.Label2(2).Height + 100
         .Left = oF.Label2(2).Left
         .Caption = "Pais de origen :"
         .Visible = True
      End With
      With .dcfields(0)
         .Top = oF.Label2(3).Top
         .Left = oF.Text4.Left
         .BoundColumn = "IdPais"
         Set .RowSource = Aplicacion.Paises.TraerLista
         .BoundText = IIf(IsNull(origen.Registro.Fields("Exportacion_IdPaisDestino").Value), 0, _
                           origen.Registro.Fields("Exportacion_IdPaisDestino").Value)
         .Visible = True
      End With
      With .Label2(4)
         .Top = oF.Label2(3).Top + oF.Label2(3).Height + 100
         .Left = oF.Label2(3).Left
         .Caption = "Fecha embarque :"
         .Visible = True
      End With
      With .DTFields(0)
         .Top = oF.Label2(4).Top
         .Left = oF.dcfields(0).Left
         .Value = IIf(IsNull(origen.Registro.Fields("Exportacion_FechaEmbarque").Value), Date, _
                           origen.Registro.Fields("Exportacion_FechaEmbarque").Value)
         .Visible = True
      End With
      With .Label2(5)
         .Top = oF.Label2(4).Top
         .Left = oF.DTFields(0).Left + oF.DTFields(0).Width * 1.2
         .Width = .Width * 1.5
         .Caption = "Fecha de oficializacion :"
         .Visible = True
      End With
      With .DTFields(1)
         .Top = oF.DTFields(0).Top
         .Left = oF.Label2(5).Left + oF.Label2(5).Width + 100
         .Value = IIf(IsNull(origen.Registro.Fields("Exportacion_FechaOficializacion").Value), Date, _
                           origen.Registro.Fields("Exportacion_FechaOficializacion").Value)
         .Visible = True
      End With
      .cmd(0).Top = .Label2(5).Top + (oF.Label2(5).Height * 2)
      .cmd(1).Top = .cmd(0).Top
      .Width = .Width * 2
      .Height = .Height * 1.4
      .Show vbModal, Me
      
      mOk = True
      If .Ok Then
         If Val(.Text1) = 0 Then
            mOk = False
            MsgBox "Falta ingresar el valor FOB"
         End If
         If Len(.Text2) = 0 Then
            mOk = False
            MsgBox "Falta ingresar el numero de despacho"
         End If
         If Not IsNumeric(.dcfields(0).BoundText) Then
            mOk = False
            MsgBox "Falta ingresar el pais destino"
         End If
         If mOk Then
            With origen.Registro
               .Fields("Exportacion_FOB").Value = oF.Text2.Text
               .Fields("Exportacion_PosicionAduana").Value = oF.Text1.Text
               .Fields("Exportacion_Despacho").Value = oF.Text3.Text
               .Fields("Exportacion_Guia").Value = oF.Text4.Text
               .Fields("Exportacion_IdPaisDestino").Value = oF.dcfields(0).BoundText
               .Fields("Exportacion_FechaEmbarque").Value = oF.DTFields(0).Value
               .Fields("Exportacion_FechaOficializacion").Value = oF.DTFields(1).Value
            End With
         End If
      End If
   End With
   
   Unload oF

Salida:
   Set oF = Nothing
   Exit Sub
   
Mal:
   MsgBox "Se ha producido un error al registrar los datos ..." & vbCrLf & _
            Err.Number & " " & Err.Description, vbCritical
   Resume Salida

End Sub

Public Sub AgregarDevolucionAnticipo()

   Dim oRs As ADOR.Recordset
   Dim mEsta As Boolean, mOk As Boolean
   Dim s As String
   Dim mIdArticulo As Long, mIdDetalleOrdenCompra As Long, mIdDetFac As Long
   Dim mImporte As Double, mPorcentajeCertificacion As Single
   Dim oF As frm_Aux
   Dim oDetOC As DetFacturaOrdenesCompra
   
   If mvarIdRubroDevolucionAnticipos <> 0 And Val(txtPorcentajeDevolucionAnticipo.Text) <> 0 Then
'      s = ""
'      Set oRs = Aplicacion.Articulos.TraerFiltrado("_PorIdRubro", mvarIdRubroDevolucionAnticipos)
'      If oRs.RecordCount > 0 Then
'         oRs.MoveFirst
'         Do While Not oRs.EOF
'            s = s & "(" & oRs.Fields("IdArticulo").Value & ")"
'            oRs.MoveNext
'         Loop
'      End If
'      oRs.Close
      
      mEsta = False
'      Set oRs = origen.DetFacturas.Registros
'      With oRs
'         If .Fields.Count > 0 Then
'            If .RecordCount > 0 Then
'               .MoveFirst
'               Do While Not .EOF
'                  If Not .Fields("Eliminado").Value Then
'                     If InStr(1, "(" & .Fields("IdArticulo").Value & ")", s) <> 0 Then
'                        mEsta = True
'                        Exit Do
'                     End If
'                  End If
'                  .MoveNext
'               Loop
'            End If
'         End If
'      End With
'      Set oRs = Nothing
      
      If mEsta Then Exit Sub
      
      Set oF = New frm_Aux
      With oF
         .Text1.Visible = False
         With .Label1
            .Caption = "Articulo :"
            .Width = .Width / 2
         End With
         With .dcfields(0)
            .Top = oF.Text1.Top
            .Left = oF.Label1.Left + oF.Label1.Width + 20
            .Width = .Width * 2
            .BoundColumn = "IdArticulo"
            Set .RowSource = Aplicacion.Articulos.TraerFiltrado("_PorIdRubroParaCombo", mvarIdRubroDevolucionAnticipos)
            .Visible = True
         End With
         .Show vbModal, Me
         mOk = .Ok
         mIdArticulo = 0
         If IsNumeric(.dcfields(0).BoundText) Then mIdArticulo = .dcfields(0).BoundText
      End With
      Unload oF
      Set oF = Nothing
      If Not mOk Or mIdArticulo = 0 Then Exit Sub
         
      mIdDetalleOrdenCompra = 0
      Set oRs = origen.DetFacturas.RegistrosOrdenesCompra
      With oRs
         If .Fields.Count > 0 Then
            If .RecordCount > 0 Then
               .MoveFirst
               Do While Not .EOF
                  If Not .Fields("Eliminado").Value Then
                     mIdDetalleOrdenCompra = IIf(IsNull(.Fields("IdDetalleOrdenCompra").Value), 0, .Fields("IdDetalleOrdenCompra").Value)
                     
                     mImporte = 0
                     mPorcentajeCertificacion = 0
                     Set oRs = Aplicacion.Facturas.TraerFiltrado("_DevolucionAnticipo", mIdDetalleOrdenCompra)
                     If oRs.RecordCount > 0 Then
                        mImporte = IIf(IsNull(oRs.Fields("Importe").Value), 0, oRs.Fields("Importe").Value)
                        mPorcentajeCertificacion = IIf(IsNull(oRs.Fields("PorcentajeCertificacion").Value), 0, oRs.Fields("PorcentajeCertificacion").Value)
                     End If
                     oRs.Close
                     Set oRs = Nothing
                     
                     With origen.DetFacturas.Item(-1)
                        With .Registro
                           .Fields("IdArticulo").Value = mIdArticulo
                           .Fields("Cantidad").Value = -1
                           .Fields("PorcentajeCertificacion").Value = mPorcentajeCertificacion * Val(txtPorcentajeDevolucionAnticipo.Text) / 100 * -1
                           .Fields("PrecioUnitario").Value = mImporte * Val(txtPorcentajeDevolucionAnticipo.Text) / 100
                        End With
                        .Modificado = True
                        mIdDetFac = .Id
                        With .DetFacturasOrdenesCompra
                           Set oDetOC = .Item(-1)
                           With oDetOC
                              .Registro.Fields("IdDetalleFactura").Value = mIdDetFac
                              .Registro.Fields("IdDetalleOrdenCompra").Value = mIdDetalleOrdenCompra
                              .Modificado = True
                           End With
                           Set oDetOC = Nothing
                        End With
                     End With
                     
                  End If
                  .MoveNext
               Loop
            End If
         End If
      End With
      Set oRs = Nothing
         
      Set Lista.DataSource = origen.DetFacturas.RegistrosConFormato
      CalculaFactura
   End If

End Sub

Public Sub MostrarTotales()

   Estado.Panels(1).Text = " " & origen.DetFacturas.CantidadRegistros & " Items - " & origen.DetFacturas.TotalCantidad & " Unidades"

End Sub

Private Sub AsignaPrecio()

   Dim mvarOK As Boolean
   Dim mPrecio As Double
   Dim oF As frmAsignaNumero
   
   Set oF = New frmAsignaNumero
   With oF
      .Caption = "Ingreso de precios"
      .lblEti.Caption = "Ingrese el precio :"
      .Show vbModal, Me
      mvarOK = .Ok
      mPrecio = Val(.txtNumero.Text)
   End With
   Unload oF
   Set oF = Nothing
   If Not mvarOK Then Exit Sub
   
   Dim mImporte As Double, mBonificacion As Double
   Dim mIdDet As Long
   Dim oL As ListItem
   
   For Each oL In Lista.ListItems
      If oL.Selected Then
         mIdDet = oL.Tag
         With origen.DetFacturas.Item(mIdDet)
            .Registro.Fields("PrecioUnitario").Value = mPrecio
            mImporte = (.Registro.Fields("PrecioUnitario").Value * .Registro.Fields("Cantidad").Value)
            mBonificacion = Round(mImporte * IIf(IsNull(.Registro.Fields("Bonificacion").Value), 0, .Registro.Fields("Bonificacion").Value) / 100, 4)
            .Modificado = True
            oL.SubItems(5) = "" & Format(mPrecio, "#,##0.00")
            oL.SubItems(7) = "" & Format(mImporte - mBonificacion, "#,##0.00")
         End With
         oL.SmallIcon = "Modificado"
      End If
   Next
   
   CalculaFactura
   
End Sub

Public Sub CertificacionObra()

   Dim oF As frm_Aux
   Dim mNumeroCertificadoObra As Long
   Dim mImporteCertificacionObra As Double, mFondoReparoCertificacionObra As Double
   Dim mPorcentajeRetencionesEstimadasCertificacionObra As Single
   Dim mNumeroExpedienteCertificacionObra As String
   Dim mOk As Boolean
   
   With origen.Registro
      If IsNull(.Fields("IdObra").Value) Then
         MsgBox "Debe indicar la obra antes de acceder a esta opcion", vbExclamation
         Exit Sub
      End If
      mNumeroCertificadoObra = IIf(IsNull(.Fields("NumeroCertificadoObra").Value), 0, .Fields("NumeroCertificadoObra").Value)
      mImporteCertificacionObra = IIf(IsNull(.Fields("ImporteCertificacionObra").Value), 0, .Fields("ImporteCertificacionObra").Value)
      mFondoReparoCertificacionObra = IIf(IsNull(.Fields("FondoReparoCertificacionObra").Value), 0, .Fields("FondoReparoCertificacionObra").Value)
      mPorcentajeRetencionesEstimadasCertificacionObra = IIf(IsNull(.Fields("PorcentajeRetencionesEstimadasCertificacionObra").Value), 0, .Fields("PorcentajeRetencionesEstimadasCertificacionObra").Value)
      mNumeroExpedienteCertificacionObra = IIf(IsNull(.Fields("NumeroExpedienteCertificacionObra").Value), "", .Fields("NumeroExpedienteCertificacionObra").Value)
   End With
   
   Set oF = New frm_Aux
   With oF
      .Caption = "Certificacion obra"
      .Height = .Label1.Height * 14
      .Label1.Caption = "Nro.Certificado :"
      .Text1.Text = mNumeroCertificadoObra
      With .Label2(0)
         .Top = oF.Label1.Top + oF.Label1.Height + 100
         .Left = oF.Label1.Left
         .Width = oF.Label1.Width
         .Caption = "Importe (s/fdo):"
         .Visible = True
      End With
      With .Text2
         .Top = oF.Label2(0).Top
         .Left = oF.Text1.Left
         .Width = oF.Text1.Width
         .Text = mImporteCertificacionObra
         .Visible = True
      End With
      With .Label2(1)
         .Top = oF.Label2(0).Top + oF.Label2(0).Height + 100
         .Left = oF.Label1.Left
         .Width = oF.Label1.Width
         .Caption = "Fondo reparo :"
         .Visible = True
      End With
      With .Text3
         .Top = oF.Label2(1).Top
         .Left = oF.Text1.Left
         .Width = oF.Text1.Width
         .Text = mFondoReparoCertificacionObra
         .Visible = True
      End With
      With .Label2(2)
         .Top = oF.Label2(1).Top + oF.Label2(1).Height + 100
         .Left = oF.Label1.Left
         .Width = oF.Label1.Width
         .Caption = "% Ret.estimadas :"
         .Visible = True
      End With
      With .Text4
         .Top = oF.Label2(2).Top
         .Left = oF.Text1.Left
         .Width = oF.Text1.Width
         .Text = mPorcentajeRetencionesEstimadasCertificacionObra
         .Visible = True
      End With
      With .Label2(3)
         .Top = oF.Label2(2).Top + oF.Label2(2).Height + 100
         .Left = oF.Label1.Left
         .Width = oF.Label1.Width
         .Caption = "Nro.Expediente :"
         .Visible = True
      End With
      With .Text5
         .Top = oF.Label2(3).Top
         .Left = oF.Text1.Left
         .Width = oF.Text1.Width
         .Text = mNumeroExpedienteCertificacionObra
         .Visible = True
      End With
      With .cmd(0)
         .Top = oF.Label2(3).Top + oF.Label2(3).Height + 300
         'If mvarId > 0 Then .Enabled = False
      End With
      .cmd(1).Top = .cmd(0).Top
      .Show vbModal, Me
      mOk = .Ok
      mNumeroCertificadoObra = Val(.Text1.Text)
      mImporteCertificacionObra = Val(.Text2.Text)
      mFondoReparoCertificacionObra = Val(.Text3.Text)
      mPorcentajeRetencionesEstimadasCertificacionObra = Val(.Text4.Text)
      mNumeroExpedienteCertificacionObra = .Text5.Text
   End With
   Unload oF
   Set oF = Nothing
   
   If Not mOk Then Exit Sub
   
   If mNumeroCertificadoObra <= 0 Then
      MsgBox "Debe ingresar el numero de certificado", vbExclamation
      Exit Sub
   End If
   If mImporteCertificacionObra <= 0 Then
      MsgBox "Debe ingresar el importe del certificado", vbExclamation
      Exit Sub
   End If
   If Len(mNumeroExpedienteCertificacionObra) = 0 Then
      MsgBox "Debe ingresar el numero de expediente", vbExclamation
      Exit Sub
   End If
   
   With origen.Registro
      .Fields("NumeroCertificadoObra").Value = mNumeroCertificadoObra
      .Fields("ImporteCertificacionObra").Value = mImporteCertificacionObra
      .Fields("FondoReparoCertificacionObra").Value = mFondoReparoCertificacionObra
      .Fields("PorcentajeRetencionesEstimadasCertificacionObra").Value = mPorcentajeRetencionesEstimadasCertificacionObra
      .Fields("NumeroExpedienteCertificacionObra").Value = mNumeroExpedienteCertificacionObra
   End With

   If mNumeroCertificadoObra <> 0 Then
      cmd(4).BackColor = &HC0FFC0
   Else
      cmd(4).BackColor = &HC0C0FF
   End If

End Sub

Public Sub CertificacionObra1()

   Dim mNumeroProyecto As Long, mIdCertificacionObras As Long, mIdCertificacionObraDatos As Long
   Dim mOk As Boolean
   Dim oF As frm_Aux

   With origen.Registro
      mNumeroProyecto = IIf(IsNull(.Fields("NumeroProyecto").Value), 0, .Fields("NumeroProyecto").Value)
      mIdCertificacionObras = IIf(IsNull(.Fields("IdCertificacionObras").Value), 0, .Fields("IdCertificacionObras").Value)
      mIdCertificacionObraDatos = IIf(IsNull(.Fields("IdCertificacionObraDatos").Value), 0, .Fields("IdCertificacionObraDatos").Value)
   End With

   Set oF = New frm_Aux
   With oF
      .Id = 23
      .Text1.Visible = False
      .Label1.Caption = "Etapa :"
      With .Label2(0)
         .Caption = "Proyecto :"
         .Visible = True
      End With
      With .Label2(1)
         .Caption = "Nro.Certificado :"
         .Visible = True
      End With
      With .dcfields(0)
         .Top = oF.DTFields(0).Top
         .Left = oF.DTFields(0).Left
         .Width = oF.DTFields(0).Width * 3
         .BoundColumn = "NumeroProyecto"
         Set .RowSource = Aplicacion.CertificacionesObras.TraerFiltrado("_DatosParaCombo")
         .BoundText = mNumeroProyecto
         .Visible = True
      End With
      With .dcfields(1)
         .Top = oF.Text1.Top
         .Left = oF.Text1.Left
         .Width = oF.dcfields(0).Width
         .BoundColumn = "IdCertificacionObras"
         If mNumeroProyecto <> 0 Then
            Set .RowSource = Aplicacion.CertificacionesObras.TraerFiltrado("_EtapasParaCombo", mNumeroProyecto)
            .BoundText = mIdCertificacionObras
         End If
         .Visible = True
      End With
      With .dcfields(2)
         .Top = oF.DTFields(1).Top
         .Left = oF.DTFields(1).Left
         .Width = oF.DTFields(1).Width * 3
         .BoundColumn = "IdCertificacionObraDatos"
         If mNumeroProyecto <> 0 Then
            Set .RowSource = Aplicacion.CertificacionesObrasDatos.TraerFiltrado("_PorNumeroProyecto", mNumeroProyecto)
            .BoundText = mIdCertificacionObraDatos
         End If
         .Visible = True
      End With
      .Width = .Width * 2
      .Show vbModal, Me
      mOk = .Ok
      mNumeroProyecto = 0
      If IsNumeric(.dcfields(0).BoundText) Then mNumeroProyecto = .dcfields(0).BoundText
      mIdCertificacionObras = 0
      If IsNumeric(.dcfields(1).BoundText) Then mIdCertificacionObras = .dcfields(1).BoundText
      mIdCertificacionObraDatos = 0
      If IsNumeric(.dcfields(2).BoundText) Then mIdCertificacionObraDatos = .dcfields(2).BoundText
   End With
   Unload oF
   Set oF = Nothing
   If Not mOk Then Exit Sub

   With origen.Registro
      If mNumeroProyecto = 0 Or mIdCertificacionObras = 0 Or mIdCertificacionObraDatos = 0 Then
         DoEvents
         If mNumeroProyecto = 0 Then MsgBox "No se ingreso el numero de proyecto, los datos no fueron registrados", vbInformation
         If mIdCertificacionObras = 0 Then MsgBox "No se ingreso la etapa del proyecto, los datos no fueron registrados", vbInformation
         If mIdCertificacionObraDatos = 0 Then MsgBox "No se ingreso el numero de certificado, los datos no fueron registrados", vbInformation
         .Fields("NumeroProyecto").Value = Null
         .Fields("IdCertificacionObras").Value = Null
         .Fields("IdCertificacionObraDatos").Value = Null
      Else
         .Fields("NumeroProyecto").Value = mNumeroProyecto
         If mIdCertificacionObras = 0 Then
            .Fields("IdCertificacionObras").Value = Null
         Else
            .Fields("IdCertificacionObras").Value = mIdCertificacionObras
         End If
         If mIdCertificacionObraDatos = 0 Then
            .Fields("IdCertificacionObraDatos").Value = Null
         Else
            .Fields("IdCertificacionObraDatos").Value = mIdCertificacionObraDatos
         End If
      End If
      If Not IsNull(.Fields("NumeroProyecto").Value) Then
         cmd(4).BackColor = &HC0FFC0
      Else
         cmd(4).BackColor = &HC0C0FF
      End If
   End With

End Sub
