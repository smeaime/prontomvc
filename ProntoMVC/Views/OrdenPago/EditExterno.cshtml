@model ProntoMVC.Data.Models.OrdenPago
@{
    ViewBag.Title = "Orden de Pago";
}
@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "formid" }))
{
    @Html.ValidationSummary(true)

    <script src="@Url.Content("~/Scripts/ScriptOrdenPago.js")"  type="text/javascript"></script>

    <div class="container-fluid">
        <form class="form-horizontal">
            <legend>Orden de pago</legend>
            <div>@Html.Hidden("IdOrdenPago", Model.IdOrdenPago)</div>
            <div>@Html.Hidden("IdProveedor", Model.IdProveedor)</div>
            <div class="row-fluid">
                <div class="span1 lightblue">
                    @Html.LabelFor(model => model.NumeroOrdenPago, "Numero")
                    @Html.TextBoxFor(model => model.NumeroOrdenPago, new { style = "font-weight: bold; font-size: 18px;", @class = "span12", @readonly = "readonly" })
                    @Html.ValidationMessageFor(model => model.NumeroOrdenPago)
                </div>
                <div class="span2 lightblue">
                    @Html.LabelFor(model => model.FechaOrdenPago, "Fecha")
                    @Html.TextBoxFor(model => model.FechaOrdenPago, new Dictionary<string, object> { { "class", "span12" }, { "placeholder", "dd/mm/yyyy" } })
                    @Html.ValidationMessageFor(model => model.FechaOrdenPago)
                    <script>
                        $("#FechaOrdenPago").datepicker({
                            changeMonth: true,
                            changeYear: true,
                            dateFormat: 'dd/mm/yy'
                            //numberOfMonths: 2,
                        });
                    </script>
                </div>
                <div class="span5 lightblue">
                    @Html.HiddenFor(model => model.IdProveedor)
                    @Html.LabelFor(model => model.IdProveedor, "Proveedor")
                    @Html.TextBoxFor(m => m.Proveedore.RazonSocial, new { id = "DescripcionProveedor", @class = "span12" })
                    <script type="text/jscript">
                        $("#CodigoProveedor").autocomplete({
                            source: '@Url.Action("GetCodigosProveedorAutocomplete", "Proveedor")', minLength: 0,
                            messages: { noResults: "", results: function () { } },
                            select: proveedorSeleccionado,
                            autoFocus: true
                        })

                        $("#DescripcionProveedor").autocomplete({
                            source: '@Url.Action("GetCodigosProveedorAutocomplete", "Proveedor")',
                            minLength: 0,
                            messages: { noResults: "", results: function () { } },
                            select: proveedorSeleccionado,
                            autoFocus: true
                        });

                        function proveedorSeleccionado(event, ui) {
                            ActualizarProveedor(ui.item);
                            ///////////////////////
                            event.preventDefault();
                        }

                        function ActualizarProveedor(item) {
                            $("#IdProveedor").val(item.id);
                            $("#CodigoProveedor").val(item.codigo || "");
                            $("#DescripcionProveedor").val(item.value || "");
                            $("#IdCodigoIva").val(item.idCodigoIva);

                            $("#Proveedor_Email").val(item.Email || "");
                            $("#Proveedor_Telefono").val(item.Telefono || "");
                            $("#Proveedor_Direccion").val(item.Direccion || "");
                            $("#Proveedor_Provincia_Nombre").val(item.Provincia || "");
                            $("#Proveedor_Localidad_Nombre").val(item.Localidad || "");
                            $("#Proveedor_Fax").val(item.Fax || "");
                            $("#Proveedor_Cuit").val(item.Cuit) || "";
                            $("#IdCondicionVenta").val(item.IdCondicionVenta);
                            $("#IdListaPrecios").val(item.IdListaPrecios);

                            $("#Proveedor_EsAgenteRetencionIVA").val(item.EsAgenteRetencionIVA || "");
                            $("#Proveedor_BaseMinimaParaPercepcionIVA").val(item.BaseMinimaParaPercepcionIVA) || "";
                            $("#Proveedor_PorcentajePercepcionIVA").val(item.PorcentajePercepcionIVA) || "";

                            $("#IdIBCondicionPorDefecto").val(item.IdIBCondicionPorDefecto);
                            $("#IdIBCondicionPorDefecto2").val(item.IdIBCondicionPorDefecto2);
                            $("#IdIBCondicionPorDefecto3").val(item.IdIBCondicionPorDefecto3);
                            var someNumericValue = '@(ViewBag.someStringValue)'; //http://stackoverflow.com/questions/10389649/possible-to-access-mvc-viewbag-object-from-javascript-file
                            $("#Proveedor_PercepcionIIBB").val(someNumericValue);
                            $('#Proveedor_IBCondicionCat1_AlicuotaPercepcion').val(item.AlicuotaPercepcion1);
                            $('#Proveedor_IBCondicionCat2_AlicuotaPercepcion').val(item.AlicuotaPercepcion2);
                            $('#Proveedor_IBCondicionCat3_AlicuotaPercepcion').val(item.AlicuotaPercepcion3);

                            ActualizarPercepcionIIBB();
                            // ActualizarListaPuntoVenta();
                            // ActualizarPuntoVenta();
                        }

                        function ActualizarPercepcionIIBB() {
                            var mvarIBCondicion, mvarPercepcionIIBB, mvarId;

                            mvarIBCondicion = $("#Proveedor_IBCondicion"); // IBCondicion del Proveedor elegido
                            mvarPercepcionIIBB = $("#PercepcionIIBB"); // PercepcionIIBB de parametros generales -los parametros generales los debo incluir en el model, o en el viewmodel? -agregalos al viewbag...

                            if (mvarIBCondicion == 1 || mvarIBCondicion == 4 || (mvarId < 0 && mvarPercepcionIIBB != "SI")) {
                                $("#IdIBCondicionPorDefecto").prop('disabled', true);
                                $("#IdIBCondicionPorDefecto2").prop('disabled', true);
                                $("#IdIBCondicionPorDefecto3").prop('disabled', true);
                            } else {
                                $("#IdIBCondicionPorDefecto").prop('disabled', false);
                                $("#IdIBCondicionPorDefecto2").prop('disabled', false);
                                $("#IdIBCondicionPorDefecto3").prop('disabled', false);
                            }
                        }

                        function AutocompleteManual(term) {
                            $.ajax({
                                type: 'POST',
                                contentType: 'application/json; charset=utf-8',
                                url: ROOT + 'Proveedor/GetCodigosProveedorAutocomplete',
                                dataType: 'json',
                                // data:JSON.stringify( {formulario: colData , grilla: dataToSend })
                                data: JSON.stringify({ term: term }),
                                success: function (result) {
                                    var item = result[0];
                                    ActualizarProveedor(item);
                                }
                            })
                        }

                        function ActualizarDatosProveedor(cadenaAutoComplete) {
                            // var code = "OPELMEC";
                            // simulo un ingreso y clic en el autocomplete (tiene que tener puesto el autofocus: true)
                            // http: //stackoverflow.com/questions/8036143/jquery-autocomplete-select-first-item
                            AutocompleteManual(cadenaAutoComplete);
                            return;
                            $("#DescripcionProveedor").val(cadenaAutoComplete);
                            $("#DescripcionProveedor").autocomplete('search', cadenaAutoComplete);
                            $(".ui-menu-item:first a").click();
                            // '@Url.Action("GetCodigosProveedorAutocomplete", "Proveedor")'
                        };
                    </script>
                </div>
            </div>

            <br />

            <div class="row-fluid">
                <div class="span7 lightblue">
                    <table id="Lista" class="scroll" cellpadding="0" cellspacing="0"></table>
                    <div id="ListaPager1" class="scroll" style="text-align: center; height: 30px"></div>
                </div>
                <div class="span5 lightblue">
                    <table id="ListaContable" class="scroll" cellpadding="0" cellspacing="0"></table>
                    <div id="ListaPager2" class="scroll" style="text-align: center; height: 30px"></div>
                </div>
            </div>
            <br />
            <div class="row-fluid">
                <div class="span7 lightblue">
                    <table id="ListaValores" class="scroll" cellpadding="0" cellspacing="0"></table>
                    <div id="ListaPager3" class="scroll" style="text-align: center; height: 30px"></div>
                </div>
                <div class="span5 lightblue">
                    <style>
                        .subtotales input {
                            /*height: 16px;*/
                            min-height: 18px !important;
                            line-height: 18px;
                            padding: 0;
                            margin: 0;
                            font-size: 12px;
                            text-align: right;
                            font-weight: bold;
                            background-color: #e8eef4;
                        }
                        .subtotales input[readonly] {
                            background: transparent;
                            border: 0;
                        }
                        .subtotales select {
                            /* height : 16px; */
                            min-height: 18px !important;
                            line-height: 18px;
                            padding: 0;
                            margin: 0;
                            font-size: 10px;
                        }
                        table td {
                            padding: 0px;
                            border: solid 1px;
                            border-color: transparent;
                        }
                    </style>
                    <table id="Totales" class="subtotales span12" width="" border="0" cellspacing="0" cellpadding="0" style="margin: 0px 0px 0px 0px; height: ; padding: 0px; border-style: none; border-width: thin; border-spacing: 0px; font-size: xx-small">
                        <tr class="">
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">SUBTOTAL</td>
                            <td width="100"><input type="text" name="Subtotal" id="Subtotal" style="width: 83%; text-align: right; font-size: 12px; font-weight: bold; background-color: #e8eef4; " readonly="readonly" /></td>
                            <td width="100">MONEDA</td>
                            <td width="100">Moneda</td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">RETENCION IVA</td>
                            <td width="100">@Html.TextBoxFor(model => model.RetencionIVA, new { @class = "span10 subtotales" })</td>
                            <td width="100">CONV.PESOS</td>
                            <td width="100">@Html.TextBoxFor(model => model.CotizacionMoneda, new { @class = "span8 subtotales" })</td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">RETENCON GANANCIAS</td>
                            <td width="100">@Html.TextBoxFor(model => model.RetencionGanancias, new { @class = "span10 subtotales" })</td>
                            <td width="100">COTIZ DOLAR</td>
                            <td width="100">@Html.TextBoxFor(model => model.CotizacionDolar, new { @class = "span8 subtotales" })</td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">RETENCON IIBB</td>
                            <td width="100">@Html.TextBoxFor(model => model.RetencionIBrutos, new { @class = "span10 subtotales" })</td>
                            <td width="100">COTIZ EURO</td>
                            <td width="100">@Html.TextBoxFor(model => model.CotizacionEuro, new { @class = "span8 subtotales" })</td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">RETENCON SUSS</td>
                            <td width="100">@Html.TextBoxFor(model => model.RetencionSUSS, new { @class = "span10 subtotales" })</td>
                            <td width="100"></td>
                            <td width="100"></td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">DESCUENTOS</td>
                            <td width="100">@Html.TextBoxFor(model => model.Descuentos, new { @class = "span10 subtotales" })</td>
                            <td width="100"></td>
                            <td width="100"></td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">OP COMPLEMENTARIA</td>
                            <td width="100"><input type="text" name="OPComplementaria" id="OPComplementaria" style="width: 83%; text-align: right; font-size: 12px; font-weight: bold; background-color: #e8eef4; " readonly="readonly" /></td>
                            <td width="100"></td>
                            <td width="100"></td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">TOTAL OP COMPLEM.</td>
                            <td width="100"><input type="text" name="TotalOPComplementaria" id="TotalOPComplementaria" style="width: 83%; text-align: right; font-size: 12px; font-weight: bold; background-color: #e8eef4; " readonly="readonly" /></td>
                            <td width="100"></td>
                            <td width="100"></td>
                        </tr>
                        <tr>
                            <td width="150" colspan="2" style="font-size: 12px; font-weight: bold; ">DIFERENCIA</td>
                            <td width="100"><input type="text" name="Diferencia" id="Diferencia" style="width: 83%; text-align: right; font-size: 12px; font-weight: bold; background-color: #e8eef4; " readonly="readonly" /></td>
                            <td width="100"></td>
                            <td width="100"></td>
                        </tr>
                    </table>
                </div>
            </div>
            <br />
            <div class="row-fluid">
                <div class="span3 lightblue">
                    <table id="ListaRubrosContables" class="scroll" cellpadding="0" cellspacing="0"></table>
                    <div id="ListaPager5" class="scroll" style="text-align: center; height: 30px"></div>
                </div>
                <div class="span9 lightblue">
                    <table id="ListaImpuestos" class="scroll" cellpadding="0" cellspacing="0"></table>
                    <div id="ListaPager4" class="scroll" style="text-align: center; height: 30px"></div>
                </div>
            </div>
            <br />

            <div class="row-fluid">
                <div class="span10 lightblue">
                    @Html.LabelFor(model => model.Observaciones)
                    @Html.TextAreaFor(model => model.Observaciones, new { @class = "span12" })
                    @Html.ValidationMessageFor(model => model.Observaciones)
                </div>
                <!--/span-->
            </div>
            <br />
            <br />
            @if (Model.FechaAnulacion == null)
            {
            
            }
            else
            {
                <span class="label error-info">ANULADA</span>
            }
            @Html.ActionLink("Volver al listado", "Index", null, new { @class = "btn btn-link span2" })
        </form>
    </div>

    <script type="text/javascript">
        $(function () {
            //pageLayout.hide('east');
            pageLayout.show('east');
            Aprobado();
            function Aprobado() {
                if ($('#Aprobo').val() != "") {
                    //if ($('#FechaAprobacion').val() != null) {
                    $("#chk0").attr('checked', true);
                    var Aprobo = $("#Aprobo > option:selected").html();
                    $("#chk0").attr('title', Aprobo);
                }
                else {
                    $("#chk0").attr('checked', false);
                    $("#chk0").attr('title', "");
                }
            }
        })
    </script>
}