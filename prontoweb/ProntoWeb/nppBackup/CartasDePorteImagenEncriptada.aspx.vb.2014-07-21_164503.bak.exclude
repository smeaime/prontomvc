Imports System
Imports System.Data.SqlClient
Imports System.Reflection
Imports System.IO
Imports System.Web.UI.WebControls
Imports Pronto.ERP.Bll
Imports Pronto.ERP.BO
Imports Pronto.ERP.Bll.EntidadManager
Imports Microsoft.Office.Interop.Excel
Imports System.Text
Imports System.Data
Imports System.Diagnostics
Imports System.Web.UI
Imports Excel = Microsoft.Office.Interop.Excel

Imports CartasDePorteImportador.FormatosDeExcel
Imports DocumentFormat.OpenXml
Imports DocumentFormat.OpenXml.Packaging
Imports ExcelImportadorManager
Imports ExcelImportadorManager.FormatosDeExcel
Imports ClaseMigrar.SQLdinamico
Imports System.Linq

Imports Microsoft.Reporting.WebForms

Imports Pronto.ERP.Bll.CDPMailFiltrosManager

Imports iTextSharp.text
Imports iTextSharp.text.pdf


Partial Class CartasDePorteImagenEncriptada
    Inherits System.Web.UI.Page


    Private IdCartaDePorte As Integer = -1
    Private mKey As String, SC As String
    Private mAltaItem As Boolean
    Private usuario As Usuario = Nothing
    Private _linkImagen2 As Object

    Public Property IdEntity() As Integer
        Get
            Return DirectCast(ViewState("IdCartaDePorte"), Integer)
        End Get
        Set(ByVal Value As Integer)
            ViewState("IdCartaDePorte") = Value
        End Set
    End Property




    Dim sDirFTP As String = Nothing


    Protected Sub Page_Load(ByVal sender As Object, ByVal e As EventArgs) Handles Me.Load

        'sDirFTP = HttpContext.Current.Server.MapPath("~/" + ConfigurationManager.AppSettings("sDirFTP")) 'no necesito usar MapPath, porque no estoy usando un dir virtual
        'sDirFTP = ConfigurationManager.AppSettings("sDirFTP")
        'sDirFTP = HttpContext.Current.Server.MapPath("~/") + "..\Pronto\DataBackupear\"
        'sDirFTP = HttpContext.Current.Server.MapPath("~/") + "..\ProntoWeb\DataBackupear\"
        'sDirFTP = "http://localhost:48391/ProntoWeb/DataBackupear/"
        'sDirFTP = HttpContext.Current.Server.MapPath("~/") + "..\ProntoWeb\DataBackupear\"
        sDirFTP = "~/" + "..\Pronto\DataBackupear\" ' Cannot use a leading .. to exit above the top directory..

        If System.Diagnostics.Debugger.IsAttached() Then
            SC = EncriptarParaCSharp("Data Source=MARIANO-PC\MSSQLSERVER2;Initial Catalog=Williams;Uid=sa; PWD=ok;")
            sDirFTP = "~/" + "..\ProntoWeb\DataBackupear\"
            'sDirFTP = "http://localhost:48391/ProntoWeb/DataBackupear/"
        Else
            SC = EncriptarParaCSharp("Data Source=osvm21;Initial catalog=Williams;User ID=sa; Password=Zeekei3quo;Connect Timeout=90")
            'sDirFTP = "https://prontoweb.williamsentregas.com.ar/DataBackupear/"
        End If




        'http://stackoverflow.com/questions/240713/how-can-i-encrypt-a-querystring-in-asp-net?lq=1
        'http://madskristensen.net/post/HttpModule-for-query-string-encryption.aspx

        Try

            If Not (Request.QueryString.Get("Id") Is Nothing) Then
                Dim strScramble = Request.QueryString.Get("Id")

                IdCartaDePorte = EntidadManager.decryptQueryString(strScramble.Replace(" ", "+"))
                Me.IdEntity = IdCartaDePorte
                ErrHandler2.WriteError("Viendo Encriptacion del ID " & IdCartaDePorte)
            Else
                ErrHandler2.WriteError("Página no autorizada")
                MsgBoxAjax(Me, "Página no autorizada")
                Exit Sub
            End If

        Catch ex As Exception
            ErrHandler2.WriteError(ex)
            MsgBoxAjax(Me, "Página no autorizada")
            Exit Sub

        End Try



        'mKey = "CartaDePorte_" & Me.IdEntity.ToString
        'mAltaItem = False
        'usuario = New Usuario
        'usuario = Session(SESSIONPRONTO_USUARIO)

        ''que pasa si el usuario es Nothing? Qué se rompió?
        'If usuario Is Nothing Then Response.Redirect(String.Format("../Login.aspx"))







        If True Then


            Dim iMinAircraftImgWidth As Integer = 500
            Dim iMinAircraftImgHeight As Integer = 372
            '  ResizeImage(imagename, "imagepath", "imagepath", iMinAircraftImgWidth, iMinAircraftImgHeight, strNewFileName)
        Else
            'Dim img As Image
            'img.GetThumbnailImage(400, 400, null, IntPtr.Zero)

        End If


        If Not IsPostBack Then

            Dim myCartaDePorte As CartaDePorte


            If System.Diagnostics.Debugger.IsAttached() And False Then
                myCartaDePorte = New CartaDePorte
                myCartaDePorte.PathImagen = "9675224abr2013_071802_30868007-CP.jpg"
                myCartaDePorte.PathImagen2 = "4088624abr2013_071803_30868007-TK.jpg"
            Else
                myCartaDePorte = CartaDePorteManager.GetItem(SC, IdCartaDePorte, True)
                If True Then
                    reloadimagen()
                    'refrescaIdEncriptados(SC)
                End If

            End If

            If myCartaDePorte.PathImagen = "" And myCartaDePorte.PathImagen2 = "" Then
                Dim s = "La carta " & myCartaDePorte.NumeroCartaDePorte.ToString & " fue modificada y ya no tiene imágenes adjuntas (" & IdCartaDePorte.ToString & ")"
                MsgBoxAjax(Me, s)
                btnDescargaPDF.Enabled = False
                btnDescargaPDF.Text = s
            End If
        End If


     






    End Sub


    Protected Sub btnDescargaPDF_Click(sender As Object, e As System.EventArgs) Handles btnDescargaPDF.Click

        'If True Then
        '    MsgBoxAlert(output)
        '    Return
        'End If

        'ssss btn pdf


        Dim myCartaDePorte As CartaDePorte


        If System.Diagnostics.Debugger.IsAttached() And False Then
            myCartaDePorte = New CartaDePorte
            myCartaDePorte.PathImagen = "9675224abr2013_071802_30868007-CP.jpg"
            myCartaDePorte.PathImagen2 = "4088624abr2013_071803_30868007-TK.jpg"
        Else
            myCartaDePorte = CartaDePorteManager.GetItem(SC, IdCartaDePorte, True)
            If True Then
                reloadimagen()
                'refrescaIdEncriptados(SC)
            End If

        End If


        Dim output As String
        If True Then
            'myCartaDePorte.PathImagen = "4225mar2013_111151_29950530 104 TK.jpg"
            'myCartaDePorte.PathImagen2 = "91408abr2013_164618_Tulips.jpg"

            output = Path.GetTempPath & "ImagenesCartaPorte " & Now.ToString("ddMMMyyyy_HHmmss") & GenerarSufijoRand() & ".pdf" 'http://stackoverflow.com/questions/581570/how-can-i-create-a-temp-file-with-a-specific-extension-with-net






            If System.Diagnostics.Debugger.IsAttached() Then
                PDFcon_iTextSharp(output, _
                                   HttpContext.Current.Server.MapPath(IIf(myCartaDePorte.PathImagen <> "", sDirFTP, "")) + myCartaDePorte.PathImagen, _
                                 HttpContext.Current.Server.MapPath(IIf(myCartaDePorte.PathImagen2 <> "", sDirFTP, "")) + myCartaDePorte.PathImagen2 _
                                  )
            Else

                sDirFTP = AppDomain.CurrentDomain.BaseDirectory & "\..\Pronto\DataBackupear\"

                Try
                    PDFcon_iTextSharp(output, _
                                      IIf(myCartaDePorte.PathImagen <> "", sDirFTP + myCartaDePorte.PathImagen, ""), _
                                    IIf(myCartaDePorte.PathImagen2 <> "", sDirFTP + myCartaDePorte.PathImagen2, "") _
                                      )

                Catch ex As Exception

                    ErrHandler2.WriteError(ex)
                    'MsgBoxAjax(Me, "La carta " & myCartaDePorte.Numero & " fue modificada y ya no tiene imágenes adjuntas")
                    MsgBoxAjax(Me, "La carta " & myCartaDePorte.NumeroCartaDePorte & " fue modificada y ya no tiene imágenes adjuntas")
                    Return

                End Try

            End If





        Else
            ' output = generarInformeFotosConReportViewerPDF(SC, pa + myCartaDePorte.PathImagen, pa + myCartaDePorte.PathImagen2)
        End If





            Try
                Dim MyFile1 = New FileInfo(output) 'quizás si me fijo de nuevo, ahora verifica que el archivo existe...
                If MyFile1.Exists Then
                    Response.ContentType = "application/octet-stream"
                    Response.AddHeader("Content-Disposition", "attachment; filename=" & MyFile1.Name)
                    'problema: UpdatePanel and Response.Write / Response.TransmitFile http://forums.asp.net/t/1090634.aspx
                    'TENES QUE AGREGAR EN EL Page_Load (AUN CUADO ES POSTBACK)!!!!!
                    'AjaxControlToolkit.ToolkitScriptManager.GetCurrent(Me.Page).RegisterPostBackControl(Button6)
                    Response.TransmitFile(output) 'problema: UpdatePanel and Response.Write / Response.TransmitFile http://forums.asp.net/t/1090634.aspx
                    Response.End()
                Else
                    MandarMailDeError("PDF de imágenes de cartaporte. Probablemente por la memoria. Reiniciar el IIS. " & MyFile1.Name)
                    MsgBoxAjax(Me, "No se pudo generar el pdf. Consulte al administrador")
                End If
            Catch ex As Exception
            'ErrHandler2.WriteAndRaiseError(ex.ToString)
            ErrHandler2.WriteError(ex.ToString)
            'MsgBoxAjax(Me, ex.ToString)
            Return
        End Try
    End Sub


 

    Sub reloadimagen()

        If System.Diagnostics.Debugger.IsAttached() Then
        Else
            sDirFTP = "https://prontoweb.williamsentregas.com.ar/DataBackupear/"


        End If


        Try

            Using db As New LinqCartasPorteDataContext(Encriptar(SC))
                Dim oCarta = (From i In db.CartasDePortes Where i.IdCartaDePorte = IdCartaDePorte).SingleOrDefault

                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                If False And linkImagen.NavigateUrl <> "" Then
                    'linkimagenlabel.HRef = "..\DataBackupear\" & linkImagen.NavigateUrl

                    'http://stackoverflow.com/questions/6826478/asp-net-asyncfileupload-show-list-of-uploaded-files/6826681#6826681

                    'UpdatePanel7.UpdateMode = UpdatePanelUpdateMode.Conditional
                    'imgFotoCarta.Src = "..\DataBackupear\" & linkImagen.NavigateUrl
                    'UpdatePanel7.Update()
                ElseIf oCarta.PathImagen <> "" Then
                    If True Then
                        ResizeImage(oCarta.PathImagen, sDirFTP, sDirFTP, 400, 400, "temp_" + oCarta.PathImagen, sDirFTP)
                        'oCarta.PathImagen = "temp_" + oCarta.PathImagen
                    End If



                    linkimagenlabel.HRef = sDirFTP & "" & oCarta.PathImagen
                    linkImagen.Text = "ampliar"
                    linkImagen.NavigateUrl = sDirFTP & oCarta.PathImagen
                    linkImagen.Visible = False 'True
                    imgFotoCarta.ImageUrl = sDirFTP & "temp_" & oCarta.PathImagen ' oCarta.PathImagen

                    'ResizeImage(linkImagen.NavigateUrl, "", , , )

                    'http://www.aspsnippets.com/Articles/Displaying-images-that-are-stored-outside-the-Website-Root-Folder.aspx
                    'btnDesfacturar.Visible = True
                Else
                    linkImagen.Visible = False
                    ' btnadjuntarimagen.Visible = False
                End If
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////
                '//////////////////////////////////////////////////

                If oCarta.PathImagen2 <> "" Then

                    If True Then
                        ResizeImage(oCarta.PathImagen2, sDirFTP, sDirFTP, 400, 400, "temp_" + oCarta.PathImagen2, sDirFTP)
                        'oCarta.PathImagen2 = "temp_" + oCarta.PathImagen2
                    End If

                    linkimagenlabel2.HRef = sDirFTP & "" & oCarta.PathImagen2 'lo que se ve es la ajustada
                    linkImagen_2.Text = "ampliar"
                    linkImagen_2.NavigateUrl = sDirFTP & oCarta.PathImagen2   ' al hacer click, deberia usar la imagen NO-ajustada
                    linkImagen_2.Visible = False 'True
                    imgFotoCarta2.ImageUrl = sDirFTP & "temp_" & oCarta.PathImagen2 ' oCarta.PathImagen




                    'http://www.aspsnippets.com/Articles/Displaying-images-that-are-stored-outside-the-Website-Root-Folder.aspx
                    'btnDesfacturar.Visible = True
                Else
                    linkImagen_2.Visible = False
                    ' btnadjuntarimagen.Visible = False
                End If

            End Using

        Catch ex As Exception

            'http://stackoverflow.com/questions/16055667/graphics-drawimage-out-of-memory-exception

            'http://stackoverflow.com/questions/5288204/help-to-resolve-out-of-memory-exception-when-calling-drawimage

            ErrHandler2.WriteError(ex)
        End Try

    End Sub








    Function PDFcon_iTextSharp(filepdf As String, filejpg As String, filejpg2 As String)


        ErrHandler2.WriteError("PDFcon_iTextSharp " & filejpg & "   " & filejpg2)

       

        Dim document As Document = New Document()

        Using stream = New FileStream(filepdf, FileMode.Create, FileAccess.Write, FileShare.None)

            iTextSharp.text.pdf.PdfWriter.GetInstance(document, stream)
            document.Open()


            If filejpg <> "" Then
                Using imageStream = New FileStream(filejpg, FileMode.Open, FileAccess.Read, FileShare.ReadWrite)
                    Dim Image = iTextSharp.text.Image.GetInstance(imageStream)
                    'Image.SetAbsolutePosition(0, 0)
                    'Image.ScaleToFit(document.PageSize.Width, document.PageSize.Height)
                    Dim percentage As Decimal = 0.0F
                    percentage = 540 / Image.Width
                    Image.ScalePercent(percentage * 100)
                    document.Add(Image)
                End Using
            End If
            If filejpg2 <> "" Then
                Using imageStream = New FileStream(filejpg2, FileMode.Open, FileAccess.Read, FileShare.ReadWrite)
                    Dim Image = iTextSharp.text.Image.GetInstance(imageStream)
                    Image.ScaleToFit(document.PageSize.Width, document.PageSize.Height)
                    Dim percentage As Decimal = 0.0F
                    percentage = 540 / Image.Width
                    Image.ScalePercent(percentage * 100)
                    document.Add(Image)
                End Using
            End If


            Try
                document.Close()
            Catch ex As Exception
                ' The document has no pages.
                'Stack(Trace) : at(iTextSharp.text.pdf.PdfPages.WritePageTree())
                'at(iTextSharp.text.pdf.PdfWriter.Close())
                'at(iTextSharp.text.pdf.PdfDocument.Close())
                'at(iTextSharp.text.Document.Close())

                MandarMailDeError(ex.ToString + " " + filejpg + " " + filejpg2)
                ErrHandler2.WriteError(ex)
                'MsgBoxAjax(Me, "No se pudo generar el documento PDF. Quizas las cartas fueron modificadas y ya no tienen imágenes adjuntas")
                Throw
            End Try



            

        End Using

    End Function



    'http://www.codeproject.com/Questions/362618/How-to-reduce-image-size-in-asp-net-with-same-clar
    Public Shared Sub ResizeImage(image As String, Okey As String, key As String, width As Integer, height As Integer, newimagename As String, sDirVirtual As String)
        'Dim sDir = AppDomain.CurrentDomain.BaseDirectory & "DataBackupear\"
        'Dim sDir = ConfigurationManager.AppSettings("sDirFTP") ' & "DataBackupear\"


        Dim sDir As String

        If System.Diagnostics.Debugger.IsAttached() Then
            sDir = HttpContext.Current.Server.MapPath(sDirVirtual)
        Else
            sDir = "C:\Inetpub\wwwroot\Pronto\DataBackupear\"
        End If


        ErrHandler2.WriteError("ResizeImage " & sDir & image)



        'Dim oImg As System.Drawing.Image = System.Drawing.Image.FromFile(HttpContext.Current.Server.MapPath("~/" + ConfigurationManager.AppSettings(Okey) & image))
        Dim oImg As System.Drawing.Image = System.Drawing.Image.FromFile(sDir & image)

        'http://siderite.blogspot.com/2009/09/outofmemoryexception-in.html
        oImg = oImg.GetThumbnailImage(oImg.Width, oImg.Height, Nothing, IntPtr.Zero)


        Dim oThumbNail As System.Drawing.Image = New System.Drawing.Bitmap(width, height)
        ', System.Drawing.Imaging.PixelFormat.Format24bppRgb
        Dim oGraphic As System.Drawing.Graphics = System.Drawing.Graphics.FromImage(oThumbNail)

        oGraphic.CompositingQuality = System.Drawing.Drawing2D.CompositingQuality.HighQuality

        'set smoothing mode to high quality
        oGraphic.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.HighQuality
        'set the interpolation mode
        oGraphic.InterpolationMode = System.Drawing.Drawing2D.InterpolationMode.HighQualityBicubic
        'set the offset mode
        oGraphic.PixelOffsetMode = System.Drawing.Drawing2D.PixelOffsetMode.HighQuality

        Dim oRectangle As New System.Drawing.Rectangle(0, 0, width, height)

        oGraphic.DrawImage(oImg, oRectangle)


        


        If newimagename = "" Then
            If image.Substring(image.LastIndexOf(".")) <> ".png" Then
                oThumbNail.Save(sDir & image, System.Drawing.Imaging.ImageFormat.Jpeg)
            Else
                oThumbNail.Save(sDir & image, System.Drawing.Imaging.ImageFormat.Png)
            End If
        Else
            If newimagename.Substring(newimagename.LastIndexOf(".")) <> ".png" Then
                oThumbNail.Save(sDir & newimagename, System.Drawing.Imaging.ImageFormat.Jpeg)
            Else
                oThumbNail.Save(sDir & newimagename, System.Drawing.Imaging.ImageFormat.Png)
            End If
        End If
        oImg.Dispose()
    End Sub


End Class
