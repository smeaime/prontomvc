
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0" />
    <style type="text/css">
        /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
        #map {
            height: 100%;
        }
        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body id="map-container">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>


    <!--<script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWNbUasHY_ay5SMIpz02pu534Y1cif72k&libraries=visualization&callback=initMap">
    </script>-->

    <div id="floating-panel">
        <input onclick="clearMarkers();" type=button value="Ocultar">
        <input onclick="showMarkers();" type=button value="Ver Nombres">
        <!--<input onclick="deleteMarkers();" type=button value="Delete Markers">-->
    </div>

    <div id="map"></div>



    <script>

        //https://developers.google.com/maps/documentation/javascript/shapes#circle_add
        //https://developers.google.com/maps/documentation/javascript/heatmaplayer


        var map
        var markers = [];





        function initMap() {


            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -32, lng: -60 },
                zoom: 6
            });


            datos();
        }






        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Shows any markers currently in the array.
        function showMarkers() {
            setMapOnAll(map);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }



        function datos() {


            var infowindow = new google.maps.InfoWindow(
              {
                  content: 'safasdfasgasg',
                  size: new google.maps.Size(150, 50)
              });




            var dataRows;
            //var dataRows = [{
            //    id: 1,
            //    geom: "LINESTRING(-1.131510412 52.65531, -1.13286 52.65559)"
            //}];

            var url_string = document.location.href  // "http://www.example.com/t.html?a=1&b=3&c=m2-m3-m4-m5";
            var url = new URL(url_string);
            var c = url.searchParams.get("modoExportacion");
            console.log(c);



            $.ajax({
                type: 'POST',
                contentType: 'application/json; charset=utf-8',
                url: "WebServiceCartas.asmx/MapaGeoJSON",
                dataType: 'json',
                data: JSON.stringify({
                    modoExportacion: url.searchParams.get("modoExportacion"),
                    fechadesde: url.searchParams.get("fechadesde"),
                    fechahasta: url.searchParams.get("fechahasta"),
                    idprocedencia: url.searchParams.get("idprocedencia"),
                    idarticulo: url.searchParams.get("idarticulo"),
                    idclientefacturado: url.searchParams.get("idclientefacturado"),
                    tonsdesde: url.searchParams.get("tonsdesde"),
                    tonshasta: url.searchParams.get("tonshasta")
                }),
                success: function (result) {
                    var dat = JSON.parse(result.d);
                    var heatMapData = [];// [ { location: new google.maps.LatLng(0, 0), weight: 0 } ] ;
                    var hcont = 0;
                    var i = 0;

                    var maxtotal = Math.max.apply(Math, dat.map(function (o) { return o.total; }))


                    for (var city in dat) {
                        // Add the circle for this city to the map.
                        if (dat[city].lat == null) continue;




                        var pos = { lat: dat[city].lat, lng: dat[city].lng }

                        if (true) {
                            //var mapLabel = new MapLabel({
                            //    text: dat[city].ProcedenciaDesc,
                            //    position: new google.maps.LatLng(dat[city].lat, dat[city].lng),
                            //    map: map,
                            //    fontSize: 35,
                            //    align: 'right'
                            //});
                            //mapLabel.set('position', new google.maps.LatLng(dat[city].lat, dat[city].lng));







                            var marker = new google.maps.Marker({
                                position: pos,
                                label: {
                                    text: ' ', //dat[city].ProcedenciaDesc + ' ' + parseInt(dat[city].total / 1000) + 'Tn',
                                    color: 'blue',
                                    fontSize: "14px",
                                },
                                map: map,
                                

                                name: dat[city].ProcedenciaDesc + ' ' + parseInt(dat[city].total / 1000) + 'Tn',
                                address: '   ', //dat[city].ProcedenciaDesc + ' ' + parseInt(dat[city].total / 1000) + 'Tn',


                                // icon: "/imagenes/vacio.png",
                                icon: {
                                    strokeColor: '#FF0000',
                                    strokeOpacity: 1.0,
                                    strokeWeight: 2,
                                    fillColor: '#FF0000',
                                    fillOpacity: 0.5,
                                    path: google.maps.SymbolPath.CIRCLE,
                                    scale: Math.sqrt(dat[city].total / maxtotal) * 25,
                                    anchor: new google.maps.Point(0, 0),
                                },

                                zIndex: Math.round(dat[city].lat * -100000) << 5

                            });





                            var circle = new google.maps.Circle({

                                strokeColor: '#FF0000',
                                strokeOpacity: 0.8,
                                strokeWeight: 2,
                                fillColor: '#FF0000',
                                fillOpacity: 0.35,
                                map: map,
                                clickable: true,
                                center: pos,
                                radius: Math.sqrt(dat[city].total / maxtotal) * 50000  //Math.sqrt(

                            });

                            circle.bindTo('center', marker, 'position');





                            //var infowindow = new google.maps.InfoWindow({
                            //    content: dat[city].ProcedenciaDesc + ' ' + parseInt(dat[city].total / 1000) + 'Tn'
                            //});


                            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                                return function () {
                                    var name = markers[i].name;
                                    var address = markers[i].address;
                                    var html = "<b>" + name + "</b> <br/>" + address;
                                    infowindow.setContent(html);
                                    infowindow.open(map, marker, html);
                                    // infowindow.setContent(html);
                                    // infowindow.open(map, marker);
                                }
                            })(marker, i));


                            //google.maps.event.addListener(circle, 'click', function (ev) {
                            //    infoWindow.setPosition(pos);
                            //    infoWindow.open(map);
                            //});

                            //marker.addListener('mouseover', function () {
                            //    infowindow.open(map, this);
                            //});

                            //// assuming you also want to hide the infowindow when user mouses-out
                            //marker.addListener('mouseout', function () {
                            //    infowindow.close();
                            //});

                      


                            marker.setVisible(true);
                            circle.setVisible(false);




                      




                            markers.push(marker); i++;


                            if (false) {
                                var labelText = "1";
                                var myOptions = {
                                    content: dat[city].ProcedenciaDesc,
                                    boxStyle: {
                                        border: "none",
                                        textAlign: "center",
                                        fontSize: "10pt",
                                        width: "50px"
                                    },
                                    disableAutoPan: true,
                                    pixelOffset: new google.maps.Size(-25, -5),
                                    position: pos,
                                    closeBoxURL: "",
                                    isHidden: false,
                                    pane: "floatPane",
                                    enableEventPropagation: true
                                };

                                var ibLabel = new InfoBox(myOptions);
                                ibLabel.open(map);
                            }


                        }
                        else {

                            var h = { location: new google.maps.LatLng(dat[city].lat, dat[city].lng), weight: Math.sqrt(dat[city].total) * 100000 };
                            heatMapData[hcont] = h;
                            hcont++;
                        }
                    }


                    var heatmap = new google.maps.visualization.HeatmapLayer({
                        data: heatMapData
                    });
                    heatmap.setMap(map);



                    //clearMarkers();

                },
                error: function (xhr, textStatus, exceptionThrown) {
                },
            });



        }







        function geocode() {
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ 'address': 'miami, us' }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    alert("location : " + results[0].geometry.location.lat() + " " + results[0].geometry.location.lng());
                } else {
                    alert("Something got wrong " + status);
                }
            });
        }




    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWNbUasHY_ay5SMIpz02pu534Y1cif72k&libraries=visualization&callback=initMap"></script>
    <!--<script src="https://github.com/googlemaps/js-map-label/blob/gh-pages/src/maplabel-compiled.js"></script>-->
    <!--<script async defer  src="https://cdn.rawgit.com/googlemaps/v3-utility-library/master/infobox/src/infobox.js"></script>-->

</body>
</html>





<!--


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0" />
    <style type="text/css">
         /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
         #map {
             height: 100%;
         }
         /* Optional: Makes the sample page fill the window. */
         html, body {
             height: 100%;
             margin: 0;
             padding: 0;
         }
    </style>
</head>
<body id="map-container">
    <div id="map"></div>
    <script>
      var map;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 20, lng: -160 },
          zoom: 2,
          styles: mapStyle
        });

        map.data.setStyle(styleFeature);

        // Get the earthquake data (JSONP format)
        // This feed is a copy from the USGS feed, you can find the originals here:
        //   http://earthquake.usgs.gov/earthquakes/feed/v1.0/geojson.php
        var script = document.createElement('script');
        script.setAttribute(
            'src',
            'https://storage.googleapis.com/mapsdevsite/json/quakes.geo.json');
        document.getElementsByTagName('head')[0].appendChild(script);
      }

      // Defines the callback function referenced in the jsonp file.
      function eqfeed_callback(data) {
        map.data.addGeoJson(data);
      }

      function styleFeature(feature) {
        var low = [151, 83, 34];   // color of mag 1.0
        var high = [5, 69, 54];  // color of mag 6.0 and above
        var minMag = 1.0;
        var maxMag = 6.0;

        // fraction represents where the value sits between the min and max
        var fraction = (Math.min(feature.getProperty('mag'), maxMag) - minMag) /
            (maxMag - minMag);

        var color = interpolateHsl(low, high, fraction);

        return {
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            strokeWeight: 0.5,
            strokeColor: '#fff',
            fillColor: color,
            fillOpacity: 2 / feature.getProperty('mag'),
            // while an exponent would technically be correct, quadratic looks nicer
            scale: Math.pow(feature.getProperty('mag'), 2)
          },
          zIndex: Math.floor(feature.getProperty('mag'))
        };
      }

      function interpolateHsl(lowHsl, highHsl, fraction) {
        var color = [];
        for (var i = 0; i < 3; i++) {
          // Calculate color based on the fraction.
          color[i] = (highHsl[i] - lowHsl[i]) * fraction + lowHsl[i];
        }

        return 'hsl(' + color[0] + ',' + color[1] + '%,' + color[2] + '%)';
      }

      var mapStyle = [{
        'featureType': 'all',
        'elementType': 'all',
        'stylers': [{'visibility': 'off'}]
      }, {
        'featureType': 'landscape',
        'elementType': 'geometry',
        'stylers': [{'visibility': 'on'}, {'color': '#fcfcfc'}]
      }, {
        'featureType': 'water',
        'elementType': 'labels',
        'stylers': [{'visibility': 'off'}]
      }, {
        'featureType': 'water',
        'elementType': 'geometry',
        'stylers': [{'visibility': 'on'}, {'hue': '#5f94ff'}, {'lightness': 60}]
      }];
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWNbUasHY_ay5SMIpz02pu534Y1cif72k&callback=initMap">
    </script>
</body>
</html>




 -->
