/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_Pendientes1]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TX_Pendientes1]
GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetProveedoresContactos_T]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_Pendientes1_SubRecalculoRM]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TX_Pendientes1_SubRecalculoRM]
GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetProveedoresContactos_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetProveedoresContactos_A]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_T]
GO
/****** Object:  StoredProcedure [dbo].[wBusqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wBusqueda]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TXFecha]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TXFecha]
GO
/****** Object:  StoredProcedure [dbo].[wUltimosComprobantesCreados]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wUltimosComprobantesCreados]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TTpaginadoTotalCount]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TTpaginadoTotalCount]
GO
/****** Object:  StoredProcedure [dbo].[wActividadesProveedores_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wActividadesProveedores_TL]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TTpaginado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TTpaginado]
GO
/****** Object:  StoredProcedure [dbo].[wAjustesStock_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wAjustesStock_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRequerimientos_A]
GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRequerimientos_E]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRequerimientos_T]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_PorCodigo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_PorCodigo]
GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRequerimientos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_PorId]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_PorId]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_T_ByEmployee]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_T_ByEmployee]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_A]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_M]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_M]
GO
/****** Object:  StoredProcedure [dbo].[wAutorizacionesPorComprobante_TX_DocumentosPorAutoriza]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wAutorizacionesPorComprobante_TX_DocumentosPorAutoriza]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_A]
GO
/****** Object:  StoredProcedure [dbo].[wBancos_TX_PosicionFinancieraAFecha]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wBancos_TX_PosicionFinancieraAFecha]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_T]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_FondosFijos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_TX_FondosFijos]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedores_A]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedores_T]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedores_TT]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedores_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_A]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_T]
GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesA_TX_SaldosAFechaDetallado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCtasCtesA_TX_SaldosAFechaDetallado]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_T_ByEmployee]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_T_ByEmployee]
GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesD_TX_SaldosAFechaDetallado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCtasCtesD_TX_SaldosAFechaDetallado]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TL]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorObraCuentaGasto]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TX_PorObraCuentaGasto]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_CuentasGastoPorObraParaCombo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TX_CuentasGastoPorObraParaCombo]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_FondosFijos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TX_FondosFijos]
GO
/****** Object:  StoredProcedure [dbo].[wCuentasGastos_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentasGastos_TL]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorCodigo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TX_PorCodigo]
GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEmpleados_A]
GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEmpleados_E]
GO
/****** Object:  StoredProcedure [dbo].[wDepositosBancarios_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDepositosBancarios_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEmpleados_T]
GO
/****** Object:  StoredProcedure [dbo].[wDescripcionIva_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDescripcionIva_TL]
GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEmpleados_TL]
GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_TX_UsuarioNT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEmpleados_TX_UsuarioNT]
GO
/****** Object:  StoredProcedure [dbo].[wSectores_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wSectores_TL]
GO
/****** Object:  StoredProcedure [dbo].[wUnidades_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wUnidades_TL]
GO
/****** Object:  StoredProcedure [dbo].[wParametros_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wParametros_T]
GO
/****** Object:  StoredProcedure [dbo].[wTiposComprobante_TX_ParaComboProveedores]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wTiposComprobante_TX_ParaComboProveedores]
GO
/****** Object:  StoredProcedure [dbo].[wObras_TX_DestinosParaComboPorIdObra]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_TX_DestinosParaComboPorIdObra]
GO
/****** Object:  StoredProcedure [dbo].[wObras_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_TL]
GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPedidos_A]
GO
/****** Object:  StoredProcedure [dbo].[wObras_TX_PorIdCuentaFFParaCombo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_TX_PorIdCuentaFFParaCombo]
GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPedidos_E]
GO
/****** Object:  StoredProcedure [dbo].[wCotizaciones_TX_PorFechaMoneda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCotizaciones_TX_PorFechaMoneda]
GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPedidos_T]
GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorId]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCuentas_TX_PorId]
GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPedidos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_UltimoComprobantePorIdProveedor]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_TX_UltimoComprobantePorIdProveedor]
GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_TX_ResumenPorIdCuenta]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFondosFijos_TX_ResumenPorIdCuenta]
GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_TX_RendicionesPorIdCuentaParaCombo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFondosFijos_TX_RendicionesPorIdCuentaParaCombo]
GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPresupuestos_A]
GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPresupuestos_E]
GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPresupuestos_T]
GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPresupuestos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPresupuestos_A]
GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPresupuestos_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPresupuestos_T]
GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetPresupuestos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wCondicionesCompra_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCondicionesCompra_TL]
GO
/****** Object:  StoredProcedure [dbo].[wMonedas_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wMonedas_TL]
GO
/****** Object:  StoredProcedure [dbo].[wPlazosEntrega_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPlazosEntrega_TL]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TX_PorCuit]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_TX_PorCuit]
GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_TX_PorNumero]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPresupuestos_TX_PorNumero]
GO
/****** Object:  StoredProcedure [dbo].[wEstadosProveedores_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wEstadosProveedores_TL]
GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFacturas_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFondosFijos_A]
GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFondosFijos_E]
GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFondosFijos_T]
GO
/****** Object:  StoredProcedure [dbo].[wIBCondiciones_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wIBCondiciones_TL]
GO
/****** Object:  StoredProcedure [dbo].[wImpuestosDirectos_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wImpuestosDirectos_TL]
GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wLocalidades_E]
GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wLocalidades_T]
GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wLocalidades_TL]
GO
/****** Object:  StoredProcedure [dbo].[wOrdenesPago_TX_EnCajaPorProveedor]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wOrdenesPago_TX_EnCajaPorProveedor]
GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesA_TXPorMayorParaInfoProv]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCtasCtesA_TXPorMayorParaInfoProv]
GO
/****** Object:  StoredProcedure [dbo].[wNotasCredito_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wNotasCredito_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_A]
GO
/****** Object:  StoredProcedure [dbo].[wNotasDebito_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wNotasDebito_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wComparativas_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComparativas_A]
GO
/****** Object:  StoredProcedure [dbo].[wObras_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_A]
GO
/****** Object:  StoredProcedure [dbo].[wComparativas_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComparativas_E]
GO
/****** Object:  StoredProcedure [dbo].[wObras_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_E]
GO
/****** Object:  StoredProcedure [dbo].[wComparativas_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComparativas_T]
GO
/****** Object:  StoredProcedure [dbo].[wObras_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wObras_T]
GO
/****** Object:  StoredProcedure [dbo].[wComparativas_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComparativas_TL]
GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComparativas_A]
GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComparativas_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComparativas_T]
GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetComparativas_TT]
GO
/****** Object:  StoredProcedure [dbo].[wOrdenesPago_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wOrdenesPago_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_A]
GO
/****** Object:  StoredProcedure [dbo].[wPaises_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPaises_A]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_T]
GO
/****** Object:  StoredProcedure [dbo].[wPaises_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPaises_E]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_A]
GO
/****** Object:  StoredProcedure [dbo].[wPaises_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPaises_T]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_T]
GO
/****** Object:  StoredProcedure [dbo].[wPaises_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPaises_TL]
GO
/****** Object:  StoredProcedure [dbo].[wCartasPorte_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasPorte_TTpaginadoYfiltrado]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_E]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_FacturacionAutomatica]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_FacturacionAutomatica]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_TX_DetPendientesTodos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_TX_DetPendientesTodos]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorteMovimientos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorteMovimientos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wPedidos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wPedidos_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_InformesLiviano]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_InformesLiviano]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Informes]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_Informes]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Todas]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_Todas]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Posiciones]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_Posiciones]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_DescargasDeHoyMasTodasLasPosiciones]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_DescargasDeHoyMasTodasLasPosiciones]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_PorIdFactura]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_PorIdFactura]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_InformesCorregido]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_InformesCorregido]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_E]
GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_PorNumero]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wCartasDePorte_TX_PorNumero]
GO
/****** Object:  StoredProcedure [dbo].[wMailsFiltros_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wMailsFiltros_TTpaginadoYfiltrado]
GO
/****** Object:  StoredProcedure [dbo].[wMailsFiltros_TTpaginadoTotalCount]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wMailsFiltros_TTpaginadoTotalCount]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_TTpaginadoYfiltrado]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_TTprimerapagina]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_TTprimerapagina]
GO
/****** Object:  StoredProcedure [dbo].[wProvincias_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProvincias_A]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_TT]
GO
/****** Object:  StoredProcedure [dbo].[wProvincias_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProvincias_E]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_TX_Busqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_TX_Busqueda]
GO
/****** Object:  StoredProcedure [dbo].[wProvincias_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProvincias_T]
GO
/****** Object:  StoredProcedure [dbo].[wClientes_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wClientes_TX_BusquedaConCUIT]
GO
/****** Object:  StoredProcedure [dbo].[wProvincias_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProvincias_TL]
GO
/****** Object:  StoredProcedure [dbo].[wVendedores_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wVendedores_TX_BusquedaConCUIT]
GO
/****** Object:  StoredProcedure [dbo].[wRecibos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRecibos_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wTransportistas_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wTransportistas_TX_BusquedaConCUIT]
GO
/****** Object:  StoredProcedure [dbo].[wChoferes_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wChoferes_TX_BusquedaConCUIT]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_E]
GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TX_Busqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wLocalidades_TX_Busqueda]
GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TXFecha]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFacturas_TXFecha]
GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFacturas_TT]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TX_PorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wFacturas_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFacturas_A]
GO
/****** Object:  StoredProcedure [dbo].[wFacturas_M]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wFacturas_M]
GO
/****** Object:  StoredProcedure [dbo].[wRubros_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRubros_A]
GO
/****** Object:  StoredProcedure [dbo].[wNotasCredito_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wNotasCredito_TT]
GO
/****** Object:  StoredProcedure [dbo].[wRubros_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRubros_E]
GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wLocalidades_TT]
GO
/****** Object:  StoredProcedure [dbo].[wRubros_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRubros_T]
GO
/****** Object:  StoredProcedure [dbo].[wDetOrdenesCompra_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetOrdenesCompra_T]
GO
/****** Object:  StoredProcedure [dbo].[wRubros_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRubros_TL]
GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TXFecha]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wComprobantesProveedores_TXFecha]
GO
/****** Object:  StoredProcedure [dbo].[wRemitos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRemitos_A]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_A]
GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wSubrubros_A]
GO
/****** Object:  StoredProcedure [dbo].[wRemitos_M]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRemitos_M]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_T]
GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wSubrubros_E]
GO
/****** Object:  StoredProcedure [dbo].[wDetRemitos_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRemitos_A]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_TL]
GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wSubrubros_T]
GO
/****** Object:  StoredProcedure [dbo].[wDetRemitos_M]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetRemitos_M]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_N]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_N]
GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wSubrubros_TL]
GO
/****** Object:  StoredProcedure [dbo].[wOrdenesCompra_TX_DetallesPendientesDeFacturarPorIdCliente]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wOrdenesCompra_TX_DetallesPendientesDeFacturarPorIdCliente]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_A]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_A]
GO
/****** Object:  StoredProcedure [dbo].[wTablasGenerales_ParaCombo]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wTablasGenerales_ParaCombo]
GO
/****** Object:  StoredProcedure [dbo].[wRemitos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRemitos_TT]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_E]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_E]
GO
/****** Object:  StoredProcedure [dbo].[wOrdenesCompra_TX_ItemsPendientesDeRemitirPorIdCliente]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wOrdenesCompra_TX_ItemsPendientesDeRemitirPorIdCliente]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_T]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_T]
GO
/****** Object:  StoredProcedure [dbo].[wTiposRetencionGanancia_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wTiposRetencionGanancia_TL]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TX_Busqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_TX_Busqueda]
GO
/****** Object:  StoredProcedure [dbo].[wAnticiposAlPersonal_TX_Asiento]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wAnticiposAlPersonal_TX_Asiento]
GO
/****** Object:  StoredProcedure [dbo].[wArticulos_TX_Busqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wArticulos_TX_Busqueda]
GO
/****** Object:  StoredProcedure [dbo].[wValores_TX_GastosPorIdConDatos]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wValores_TX_GastosPorIdConDatos]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PendientesDeAsignacion]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TX_PendientesDeAsignacion]
GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TL]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wProveedores_TL]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PendientesDeAsignacion_SubRecalculoRM]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wRequerimientos_TX_PendientesDeAsignacion_SubRecalculoRM]
GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_TT]    Script Date: 10/17/2012 11:13:41 ******/
DROP PROCEDURE [dbo].[wDetProveedoresContactos_TT]
GO
/****** Object:  View [dbo].[wVistaPedidos]    Script Date: 10/17/2012 11:13:41 ******/
DROP VIEW [dbo].[wVistaPedidos]
GO
/****** Object:  UserDefinedFunction [dbo].[wExistenciasCartaPorteMovimientos]    Script Date: 10/17/2012 11:13:41 ******/
DROP FUNCTION [dbo].[wExistenciasCartaPorteMovimientos]
GO
/****** Object:  UserDefinedFunction [dbo].[wFuncionBusqueda]    Script Date: 10/17/2012 11:13:41 ******/
DROP FUNCTION [dbo].[wFuncionBusqueda]
GO
/****** Object:  UserDefinedFunction [dbo].[wTarifaWilliams]    Script Date: 10/17/2012 11:13:41 ******/
DROP FUNCTION [dbo].[wTarifaWilliams]
GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_Pendientes1]    Script Date: 10/17/2012 11:13:37 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRequerimientos_TX_Pendientes1
    @TiposComprobante VARCHAR(1)
AS --DECLARE @TiposComprobante varchar(1)
--SET @TiposComprobante ='P'




    SET NOCOUNT ON


    SELECT  T.IdDetalleRequerimiento,
            Requerimientos.NumeroRequerimiento AS [Req.Nro.],
            DetReq.NumeroItem AS [Item],
            DetReq.Cantidad AS [Cant.],
            Unidades.Abreviatura AS [Un.],
            Articulos.Descripcion AS Articulo,
-- #Auxiliar1.CantidadPedida as [Cant.Ped.],
-- #Auxiliar1.CantidadRecibida as [Recibido],
-- #Auxiliar1.CantidadVales as [Vales],
-- Requerimientos.MontoPrevisto as [Monto prev.],
-- Requerimientos.MontoParaCompra as [Monto comp.],
-- E1.Nombre as [Comprador],
-- DetReq.IdDetalleLMateriales,
-- LMateriales.NumeroLMateriales as [L.Mat.],
-- DetalleLMateriales.NumeroOrden as [Itm.LM],
-- #Auxiliar1.CantidadEnStock as [En stock],
            DetReq.IdArticulo,
-- Articulos.StockMinimo as [Stk.min.],
            DetReq.FechaEntrega AS [F.entrega],
            DetReq.IdDetalleRequerimiento AS [IdAux],
            DetReq.IdRequerimiento,
            E2.Nombre AS [Solicito],
            Obras.NumeroObra + ' ' + Obras.Descripcion AS [Obra],
-- Equipos.Tag as [Equipo],
-- Cuentas.Descripcion as [Cuenta contable],
-- DetReq.Cumplido as [Cump.],
            DetReq.Observaciones,
-- DetReq.IdDetalleRequerimiento as [IdAux1],
            DetReq.Observaciones AS [Observaciones item]
-- DetReq.FechaAsignacionComprador as [Fec.Asig.Comprador],
-- TiposCompra.Descripcion as [Tipo compra],
-- E3.Nombre as [2da.Firma],
-- Aut.FechaAutorizacion as [Fecha 2da.Firma],
-- Sectores.Descripcion as [Sector],
-- @Vector_T as Vector_T,
-- @Vector_X as Vector_X
    FROM    _Temp_Requerimientos_TX_Pendientes1 T
            LEFT OUTER JOIN DetalleRequerimientos DetReq ON T.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
            LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            LEFT OUTER JOIN DetalleLMateriales ON DetReq.IdDetalleLMateriales = DetalleLMateriales.IdDetalleLMateriales
            LEFT OUTER JOIN LMateriales ON DetalleLMateriales.IdLMateriales = LMateriales.IdLMateriales
            LEFT OUTER JOIN AutorizacionesPorComprobante Aut ON T.IdAutorizacionPorComprobante = Aut.IdAutorizacionPorComprobante
            LEFT OUTER JOIN Empleados E1 ON DetReq.IdComprador = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
            LEFT OUTER JOIN Empleados E3 ON Aut.IdAutorizo = E3.IdEmpleado
            LEFT OUTER JOIN Cuentas ON DetReq.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN Unidades ON DetReq.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
            LEFT OUTER JOIN Obras ON ISNULL(Requerimientos.IdObra,
                                            LMateriales.IdObra) = Obras.IdObra
            LEFT OUTER JOIN Equipos ON LMateriales.IdEquipo = Equipos.IdEquipo
            LEFT OUTER JOIN Sectores ON Requerimientos.IdSector = Sectores.IdSector
    WHERE   ISNULL(DetReq.TipoDesignacion, 'CMP') <> 'S/D'
            AND ( ISNULL(DetReq.TipoDesignacion, 'CMP') <> 'STK'
                  OR ( ISNULL(DetReq.TipoDesignacion, 'CMP') = 'STK'
                       AND ISNULL(T.CantidadPedida, 0) > 0
                       AND DetReq.Cantidad > ISNULL(T.CantidadPedida, 0)
                     )
                )
            AND DetReq.Cantidad > ISNULL(T.CantidadVales, 0)
    ORDER BY Requerimientos.NumeroRequerimiento,
            DetReq.NumeroItem


GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_T]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetProveedoresContactos_T]
    @IdDetalleProveedor INT
AS 
    SELECT  *
    FROM    [DetalleProveedores]
    WHERE   ( IdDetalleProveedor = @IdDetalleProveedor )


GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_Pendientes1_SubRecalculoRM]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRequerimientos_TX_Pendientes1_SubRecalculoRM
AS 
    SET NOCOUNT ON

    DECLARE @TiposComprobante VARCHAR(1)
    SET @TiposComprobante = 'P'

    DECLARE @CantidadFirmasRM INT,
        @LiberarCircuito VARCHAR(2),
        @FirmasLiberacion INT

    SET @CantidadFirmasRM = ISNULL(( SELECT COUNT(*)
                                     FROM   DetalleAutorizaciones
                                            LEFT OUTER JOIN Autorizaciones ON DetalleAutorizaciones.IdAutorizacion = Autorizaciones.IdAutorizacion
                                     WHERE  Autorizaciones.IdFormulario = 3
                                   ), 0)
    SET @FirmasLiberacion = ISNULL(( SELECT TOP 1
                                            CONVERT(INTEGER, Valor)
                                     FROM   Parametros2
                                     WHERE  Campo = 'AprobacionesRM'
                                   ), 1)
    SET @LiberarCircuito = ISNULL(( SELECT TOP 1
                                            Valor
                                    FROM    Parametros2
                                    WHERE   Campo = 'LiberarRMCircuito'
                                  ), 'NO')


    DELETE  _Temp_Requerimientos_TX_Pendientes1


    INSERT  INTO _Temp_Requerimientos_TX_Pendientes1
            SELECT  DetReq.IdDetalleRequerimiento,


--En pedidos
                    ( SELECT    SUM(ISNULL(DetallePedidos.Cantidad, 0))
                      FROM      DetallePedidos
                      WHERE     DetallePedidos.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( DetallePedidos.Cumplido IS NULL
                                      OR DetallePedidos.Cumplido <> 'AN'
                                    )
                    ), 


--Recibidos
                    ( SELECT    SUM(ISNULL(DetalleRecepciones.CantidadCC, 0))
                      FROM      DetalleRecepciones
                                LEFT OUTER JOIN Recepciones ON Recepciones.IdRecepcion = DetalleRecepciones.IdRecepcion
                      WHERE     DetalleRecepciones.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( Recepciones.Anulada IS NULL
                                      OR Recepciones.Anulada <> 'SI'
                                    )
                    ), 


--En Vales
                    ( SELECT    SUM(ISNULL(DetalleValesSalida.Cantidad, 0))
                      FROM      DetalleValesSalida
                      WHERE     DetalleValesSalida.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( DetalleValesSalida.Estado IS NULL
                                      OR DetalleValesSalida.Estado <> 'AN'
                                    )
                    ), 


--
                    CASE WHEN ISNULL(Articulos.RegistrarStock, 'SI') = 'SI'
                         THEN ( SELECT  SUM(ISNULL(Stock.CantidadUnidades, 0))
                                FROM    Stock
                                WHERE   DetReq.IdArticulo = Stock.IdArticulo
                              )
                         ELSE NULL
                    END, 


--
                    ( SELECT TOP 1
                                Aut.IdAutorizacionPorComprobante
                      FROM      AutorizacionesPorComprobante Aut
                      WHERE     Aut.IdFormulario = 3
                                AND Aut.OrdenAutorizacion = 1
                                AND Aut.IdComprobante = DetReq.IdRequerimiento
                    )
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo
            WHERE   ( ( @FirmasLiberacion = 1
                        AND Requerimientos.Aprobo IS NOT NULL
                      )
                      OR ( @FirmasLiberacion > 1
                           AND Requerimientos.Aprobo2 IS NOT NULL
                         )
                    )
                    AND ( @TiposComprobante = 'T'
                          OR DetReq.Cumplido IS NULL
                          OR ( DetReq.Cumplido <> 'SI'
                               AND DetReq.Cumplido <> 'AN'
                             )
                        )
                    AND ( @TiposComprobante = 'T'
                          OR Requerimientos.Cumplido IS NULL
                          OR ( Requerimientos.Cumplido <> 'SI'
                               AND Requerimientos.Cumplido <> 'AN'
                             )
                        )
                    AND 
/*	 (@TiposComprobante='T' or DetReq.IdProveedor is null) AND 	*/ ( @TiposComprobante = 'T'
                                                                       OR ( DetReq.IdAproboAlmacen IS NOT NULL
                                                                            OR ( Requerimientos.DirectoACompras IS NOT NULL
                                                                                 AND Requerimientos.DirectoACompras = 'SI'
                                                                               )
                                                                          )
                                                                     )
                    AND ISNULL(Requerimientos.Confirmado, 'SI') <> 'NO'
                    AND ( @LiberarCircuito = 'NO'
                          OR ( @LiberarCircuito = 'SI'
                               AND ISNULL(( SELECT  COUNT(*)
                                            FROM    AutorizacionesPorComprobante Aut
                                            WHERE   Aut.IdFormulario = 3
                                                    AND Aut.IdComprobante = Requerimientos.IdRequerimiento
                                          ), 0) >= @CantidadFirmasRM
                             )
                        )  




GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_E]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetProveedoresContactos_E]
    @IdDetalleProveedor INT
AS 
    DELETE  [DetalleProveedores]
    WHERE   ( IdDetalleProveedor = @IdDetalleProveedor )


GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_A]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetProveedoresContactos_A]
    @IdDetalleProveedor INT,
    @IdProveedor INT,
    @Contacto VARCHAR(50),
    @Puesto VARCHAR(50),
    @Telefono VARCHAR(50),
    @Email VARCHAR(50)
AS 
    IF ISNULL(@IdDetalleProveedor, 0) <= 0 
        BEGIN
            INSERT  INTO DetalleProveedores
                    (
                      IdProveedor,
                      Contacto,
                      Puesto,
                      Telefono,
                      Email
	              )
            VALUES  (
                      @IdProveedor,
                      @Contacto,
                      @Puesto,
                      @Telefono,
                      @Email
	              )
	
            SELECT  @IdDetalleProveedor = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  DetalleProveedores
            SET     IdProveedor = @IdProveedor,
                    Contacto = @Contacto,
                    Puesto = @Puesto,
                    Telefono = @Telefono,
                    Email = @Email
            WHERE   ( IdDetalleProveedor = @IdDetalleProveedor )
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdDetalleProveedor


GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_T]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wRequerimientos_T]
    @IdRequerimiento INT = NULL
AS 
    SET NOCOUNT ON

    SET @IdRequerimiento = ISNULL(@IdRequerimiento, -1)

    DECLARE @ActivarSolicitudMateriales VARCHAR(2)
    SET @ActivarSolicitudMateriales = ISNULL(( SELECT TOP 1
                                                        P.ActivarSolicitudMateriales
                                               FROM     Parametros P
                                               WHERE    P.IdParametro = 1
                                             ), 'NO')




-----------------------------
--MARIANO: simplificacion del sp
-----------------------------

    SELECT  Requerimientos.IdRequerimiento,
            Requerimientos.*,
            Requerimientos.NumeroRequerimiento AS [Nro. Req. a Conf.],
            Requerimientos.IdRequerimiento AS [IdReq],
            Requerimientos.FechaRequerimiento AS [Fecha],
            Requerimientos.Cumplido AS [Cump.],
            Requerimientos.Impresa AS [Impresa],
            Requerimientos.Detalle AS [Detalle],
            Obras.NumeroObra AS [Obra],
            ( SELECT    COUNT(*)
              FROM      DetalleRequerimientos Det
              WHERE     Det.IdRequerimiento = Requerimientos.IdRequerimiento
            ) AS [Items],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.Aprobo = E.IdEmpleado
            ) AS [Libero],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdSolicito = E.IdEmpleado
            ) AS [Solicito],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdComprador = E.IdEmpleado
            ) AS [Comprador],
            Sectores.Descripcion AS [Sector],
            ArchivosATransmitirDestinos.Descripcion AS [Origen],
            Requerimientos.IdRequerimiento AS [IdAux],
            ( SELECT    COUNT(*)
              FROM      DetalleRequerimientos
              WHERE     DetalleRequerimientos.IdRequerimiento = Requerimientos.IdRequerimiento
            ) AS [Cant.Items]
    FROM    Requerimientos
            LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
            LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto = CentrosCosto.IdCentroCosto
            LEFT OUTER JOIN Sectores ON Requerimientos.IdSector = Sectores.IdSector
            LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
    WHERE   --IsNull(Confirmado,'SI')='NO' and 
            ( @IdRequerimiento = -1
              OR Requerimientos.IdRequerimiento = @IdRequerimiento
            )
    ORDER BY NumeroRequerimiento DESC


-----------------------------
-----------------------------
-----------------------------







/*


-- PRESUPUESTOS 
CREATE TABLE #Auxiliar0 
			(
			 IdRequerimiento INTEGER,
			 Presupuestos VARCHAR(100)
			)

CREATE TABLE #Auxiliar1 
			(
			 IdRequerimiento INTEGER,
			 Presupuesto VARCHAR(13)
			)
INSERT INTO #Auxiliar1 
 SELECT 
  DetReq.IdRequerimiento,
  Convert(varchar,Presupuestos.Numero)+
	Case When Presupuestos.Subnumero is not null
		Then '/'+Convert(varchar,Presupuestos.Subnumero)
		Else ''
	End
 FROM DetalleRequerimientos DetReq
 LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
 LEFT OUTER JOIN Presupuestos ON DetallePresupuestos.IdPresupuesto = Presupuestos.IdPresupuesto
 WHERE @IdRequerimiento=-1 or DetReq.IdRequerimiento=@IdRequerimiento

CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 (IdRequerimiento,Presupuesto) ON [PRIMARY]

INSERT INTO #Auxiliar0 
 SELECT IdRequerimiento, ''
 FROM #Auxiliar1
 GROUP BY IdRequerimiento


PRINT '1'

--  CURSOR  
DECLARE @IdRequerimiento1 int, @Presupuesto varchar(13), @P varchar(100), @Corte int
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRequerimiento, Presupuesto
		FROM #Auxiliar1
		ORDER BY IdRequerimiento
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRequerimiento1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar0
			SET Presupuestos = SUBSTRING(@P,1,100)
			WHERE #Auxiliar0.IdRequerimiento=@Corte
		   END
		SET @P=''
		SET @Corte=@IdRequerimiento1
	   END
	IF NOT @Presupuesto IS NULL
		IF PATINDEX('%'+@Presupuesto+' '+'%', @P)=0
			SET @P=@P+@Presupuesto+' '
	FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
   END
   IF @Corte<>0
      BEGIN
	UPDATE #Auxiliar0
	SET Presupuestos = SUBSTRING(@P,1,100)
	WHERE #Auxiliar0.IdRequerimiento=@Corte
      END
CLOSE Cur
DEALLOCATE Cur

PRINT '2'


--COMPARATIVAS
CREATE TABLE #Auxiliar2 
			(
			 IdRequerimiento INTEGER,
			 Comparativas VARCHAR(100)
			)

CREATE TABLE #Auxiliar3 
			(
			 IdRequerimiento INTEGER,
			 Comparativa INTEGER
			)
INSERT INTO #Auxiliar3 
 SELECT DetReq.IdRequerimiento, Comparativas.Numero
 FROM DetalleRequerimientos DetReq
 LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
 LEFT OUTER JOIN DetalleComparativas ON DetallePresupuestos.IdDetallePresupuesto = DetalleComparativas.IdDetallePresupuesto
 LEFT OUTER JOIN Comparativas ON DetalleComparativas.IdComparativa = Comparativas.IdComparativa
 WHERE @IdRequerimiento=-1 or DetReq.IdRequerimiento=@IdRequerimiento

CREATE NONCLUSTERED INDEX IX__Auxiliar3 ON #Auxiliar3 (IdRequerimiento,Comparativa) ON [PRIMARY]

INSERT INTO #Auxiliar2 
 SELECT IdRequerimiento, ''
 FROM #Auxiliar3
 GROUP BY IdRequerimiento

PRINT '3'


--  CURSOR  
DECLARE @Comparativa int, @C varchar(100)
SET @Corte=0
SET @C=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRequerimiento, Comparativa
		FROM #Auxiliar3
		ORDER BY IdRequerimiento
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRequerimiento1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar2
			SET Comparativas = SUBSTRING(@C,1,100)
			WHERE #Auxiliar2.IdRequerimiento=@Corte
		   END
		SET @C=''
		SET @Corte=@IdRequerimiento1
	   END
	IF NOT @Comparativa IS NULL
		IF PATINDEX('%'+Convert(varchar,@Comparativa)+' '+'%', @C)=0
			SET @C=@C+Convert(varchar,@Comparativa)+' '
	FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
   END
   IF @Corte<>0
      BEGIN
	UPDATE #Auxiliar2
	SET Comparativas = SUBSTRING(@C,1,100)
	WHERE #Auxiliar2.IdRequerimiento=@Corte
      END
CLOSE Cur
DEALLOCATE Cur


PRINT '4'



-- PEDIDOS --
CREATE TABLE #Auxiliar4 
			(
			 IdRequerimiento INTEGER,
			 Pedidos VARCHAR(100)
			)

CREATE TABLE #Auxiliar5 
			(
			 IdRequerimiento INTEGER,
			 Pedido VARCHAR(13)
			)
INSERT INTO #Auxiliar5 
 SELECT 
  DetReq.IdRequerimiento,
  Convert(varchar,Pedidos.NumeroPedido)+
	Case When Pedidos.Subnumero is not null
		Then '/'+Convert(varchar,Pedidos.Subnumero)
		Else ''
	End
 FROM DetalleRequerimientos DetReq
 LEFT OUTER JOIN DetallePedidos ON DetReq.IdDetalleRequerimiento = DetallePedidos.IdDetalleRequerimiento
 LEFT OUTER JOIN Pedidos ON DetallePedidos.IdPedido = Pedidos.IdPedido
 WHERE @IdRequerimiento=-1 or DetReq.IdRequerimiento=@IdRequerimiento

CREATE NONCLUSTERED INDEX IX__Auxiliar5 ON #Auxiliar5 (IdRequerimiento,Pedido) ON [PRIMARY]

INSERT INTO #Auxiliar4 
 SELECT IdRequerimiento, ''
 FROM #Auxiliar5
 GROUP BY IdRequerimiento


PRINT '5'


--  CURSOR  --
DECLARE @Pedido varchar(13)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRequerimiento, Pedido
		FROM #Auxiliar5
		ORDER BY IdRequerimiento
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRequerimiento1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar4
			SET Pedidos = SUBSTRING(@P,1,100)
			WHERE #Auxiliar4.IdRequerimiento=@Corte
		   END
		SET @P=''
		SET @Corte=@IdRequerimiento1
	   END
	IF NOT @Pedido IS NULL
		IF PATINDEX('%'+@Pedido+' '+'%', @P)=0
			SET @P=@P+@Pedido+' '
	FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
   END
   IF @Corte<>0
      BEGIN
	UPDATE #Auxiliar4
	SET Pedidos = SUBSTRING(@P,1,100)
	WHERE #Auxiliar4.IdRequerimiento=@Corte
      END
CLOSE Cur
DEALLOCATE Cur


PRINT '6'



-- RECEPCION DE MATERIALES --
CREATE TABLE #Auxiliar6 
			(
			 IdRequerimiento INTEGER,
			 Recepciones VARCHAR(100)
			)

CREATE TABLE #Auxiliar7 
			(
			 IdRequerimiento INTEGER,
			 Recepcion VARCHAR(20)
			)
INSERT INTO #Auxiliar7 
 SELECT 
  DetReq.IdRequerimiento,
  Case When Recepciones.SubNumero is not null 
	 Then Substring(Substring('0000',1,4-Len(Convert(varchar,Recepciones.NumeroRecepcion1)))+
			Convert(varchar,Recepciones.NumeroRecepcion1)+'-'+
			Substring('00000000',1,8-Len(Convert(varchar,Recepciones.NumeroRecepcion2)))+
			Convert(varchar,Recepciones.NumeroRecepcion2)+'/'+
			Convert(varchar,Recepciones.SubNumero) ,1,20) 
	 Else Substring(Substring('0000',1,4-Len(Convert(varchar,Recepciones.NumeroRecepcion1)))+
			Convert(varchar,Recepciones.NumeroRecepcion1)+'-'+
			Substring('00000000',1,8-Len(Convert(varchar,Recepciones.NumeroRecepcion2)))+
			Convert(varchar,Recepciones.NumeroRecepcion2),1,20) 
  End
 FROM DetalleRequerimientos DetReq
 LEFT OUTER JOIN DetalleRecepciones ON DetReq.IdDetalleRequerimiento = DetalleRecepciones.IdDetalleRequerimiento
 LEFT OUTER JOIN Recepciones ON DetalleRecepciones.IdRecepcion = Recepciones.IdRecepcion
 WHERE @IdRequerimiento=-1 or DetReq.IdRequerimiento=@IdRequerimiento

CREATE NONCLUSTERED INDEX IX__Auxiliar7 ON #Auxiliar7 (IdRequerimiento,Recepcion) ON [PRIMARY]

INSERT INTO #Auxiliar6 
 SELECT IdRequerimiento, ''
 FROM #Auxiliar7
 GROUP BY IdRequerimiento


PRINT '7'



--  CURSOR  --
DECLARE @Recepcion varchar(20)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRequerimiento, Recepcion
		FROM #Auxiliar7
		ORDER BY IdRequerimiento
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRequerimiento1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar6
			SET Recepciones = SUBSTRING(@P,1,100)
			WHERE IdRequerimiento=@Corte
		   END
		SET @P=''
		SET @Corte=@IdRequerimiento1
	   END
	IF NOT @Recepcion IS NULL
		IF PATINDEX('%'+@Recepcion+' '+'%', @P)=0
			SET @P=@P+@Recepcion+' '
	FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
   END
   IF @Corte<>0
      BEGIN
	UPDATE #Auxiliar6
	SET Recepciones = SUBSTRING(@P,1,100)
	WHERE IdRequerimiento=@Corte
      END
CLOSE Cur
DEALLOCATE Cur


PRINT '8'



-- SALIDAS DE MATERIALES --
CREATE TABLE #Auxiliar8 
			(
			 IdRequerimiento INTEGER,
			 Salidas VARCHAR(100)
			)

CREATE TABLE #Auxiliar9 
			(
			 IdRequerimiento INTEGER,
			 Salida VARCHAR(13)
			)
INSERT INTO #Auxiliar9 
 SELECT 
  DetReq.IdRequerimiento,
  Substring(Substring('0000',1,4-Len(Convert(varchar,IsNull(SalidasMateriales.NumeroSalidaMateriales2,0))))+
	Convert(varchar,IsNull(SalidasMateriales.NumeroSalidaMateriales2,0))+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,SalidasMateriales.NumeroSalidaMateriales)))+
	Convert(varchar,SalidasMateriales.NumeroSalidaMateriales),1,13)
 FROM DetalleRequerimientos DetReq
 LEFT OUTER JOIN DetalleValesSalida ON DetReq.IdDetalleRequerimiento = DetalleValesSalida.IdDetalleRequerimiento
 LEFT OUTER JOIN DetalleSalidasMateriales ON DetalleValesSalida.IdDetalleValeSalida = DetalleSalidasMateriales.IdDetalleValeSalida
 LEFT OUTER JOIN SalidasMateriales ON DetalleSalidasMateriales.IdSalidaMateriales = SalidasMateriales.IdSalidaMateriales
 WHERE @IdRequerimiento=-1 or DetReq.IdRequerimiento=@IdRequerimiento

CREATE NONCLUSTERED INDEX IX__Auxiliar9 ON #Auxiliar9 (IdRequerimiento,Salida) ON [PRIMARY]

INSERT INTO #Auxiliar8 
 SELECT IdRequerimiento, ''
 FROM #Auxiliar9
 GROUP BY IdRequerimiento


PRINT '9'


--  CURSOR  --
DECLARE @Salida varchar(13)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRequerimiento, Salida
		FROM #Auxiliar9
		ORDER BY IdRequerimiento
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRequerimiento1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar8
			SET Salidas = SUBSTRING(@P,1,100)
			WHERE IdRequerimiento=@Corte
		   END
		SET @P=''
		SET @Corte=@IdRequerimiento1
	   END
	IF NOT @Salida IS NULL
		IF PATINDEX('%'+@Salida+' '+'%', @P)=0
			SET @P=@P+@Salida+' '
	FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
   END
   IF @Corte<>0
      BEGIN
	UPDATE #Auxiliar8
	SET Salidas = SUBSTRING(@P,1,100)
	WHERE IdRequerimiento=@Corte
      END
CLOSE Cur
DEALLOCATE Cur


PRINT '10'



SET NOCOUNT OFF

SELECT 
 Requerimientos.*,
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 #Auxiliar0.Presupuestos as [Presupuestos],
 #Auxiliar2.Comparativas as [Comparativas],
 #Auxiliar4.Pedidos as [Pedidos],
 #Auxiliar6.Recepciones as [Recepciones],
 #Auxiliar8.Salidas as [Salidas],
 (Select Count(*) From DetalleRequerimientos Det 
	Where Det.IdRequerimiento=Requerimientos.IdRequerimiento) as [Items],
 (Select Top 1 E.Nombre From Empleados E 
	Where Requerimientos.Aprobo=E.IdEmpleado) as [Libero],
 (Select Top 1 E.Nombre From Empleados E 
	Where Requerimientos.IdSolicito=E.IdEmpleado) as [Solicito],
 (Select Top 1 E.Nombre From Empleados E 
	Where Requerimientos.IdComprador=E.IdEmpleado) as [Comprador],
 Sectores.Descripcion as [Sector],
 ArchivosATransmitirDestinos.Descripcion as [Origen],
 Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS+' '+
	Articulos.Descripcion as [EquipoDestino],
 TiposCompra.Descripcion as [TipoCompra],
 (Select Top 1 E.Nombre From Empleados E 
  Where E.IdEmpleado=(Select Top 1 Aut.IdAutorizo 
			From AutorizacionesPorComprobante Aut 
			Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and 
				Aut.IdComprobante=Requerimientos.IdRequerimiento)) as [SegundaFirma],
 (Select Top 1 Aut.FechaAutorizacion 
	From AutorizacionesPorComprobante Aut 
	Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and 
		Aut.IdComprobante=Requerimientos.IdRequerimiento) as [FechaSegundaFirma],
 (Select Top 1 E.Nombre From Empleados E 
  Where E.IdEmpleado=(Select Top 1 Det.IdComprador 
			From DetalleRequerimientos Det 
			Where Det.IdRequerimiento=Requerimientos.IdRequerimiento and Det.IdComprador  is not null)) as [CompradorItem]
FROM Requerimientos
LEFT OUTER JOIN Obras ON Requerimientos.IdObra=Obras.IdObra
LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto=CentrosCosto.IdCentroCosto
LEFT OUTER JOIN Sectores ON Requerimientos.IdSector=Sectores.IdSector
LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino=Articulos.IdArticulo
LEFT OUTER JOIN #Auxiliar0 ON Requerimientos.IdRequerimiento=#Auxiliar0.IdRequerimiento
LEFT OUTER JOIN #Auxiliar2 ON Requerimientos.IdRequerimiento=#Auxiliar2.IdRequerimiento
LEFT OUTER JOIN #Auxiliar4 ON Requerimientos.IdRequerimiento=#Auxiliar4.IdRequerimiento
LEFT OUTER JOIN #Auxiliar6 ON Requerimientos.IdRequerimiento=#Auxiliar6.IdRequerimiento
LEFT OUTER JOIN #Auxiliar8 ON Requerimientos.IdRequerimiento=#Auxiliar8.IdRequerimiento
LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
WHERE (@IdRequerimiento=-1 or Requerimientos.IdRequerimiento=@IdRequerimiento) and 
	(Confirmado is null or Confirmado<>'NO')
ORDER BY Requerimientos.FechaRequerimiento Desc, Requerimientos.NumeroRequerimiento Desc


PRINT '11'



DROP TABLE #Auxiliar0
DROP TABLE #Auxiliar1
DROP TABLE #Auxiliar2
DROP TABLE #Auxiliar3
DROP TABLE #Auxiliar4
DROP TABLE #Auxiliar5
DROP TABLE #Auxiliar6
DROP TABLE #Auxiliar7
DROP TABLE #Auxiliar8
DROP TABLE #Auxiliar9
*/






GO
/****** Object:  StoredProcedure [dbo].[wBusqueda]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wBusqueda
    @q VARCHAR(50)
AS

	SELECT * 
	FROM dbo.wFuncionBusqueda(@q) 
--	group by Numero
	order by Fecha desc


GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TXFecha]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE Procedure [dbo].[wRequerimientos_TXFecha]

@Desde datetime,
@Hasta datetime,
@IdObraAsignadaUsuario int = Null

AS 

SET NOCOUNT ON

DECLARE @ActivarSolicitudMateriales varchar(2)

SET @ActivarSolicitudMateriales=IsNull((Select Top 1 P.ActivarSolicitudMateriales From Parametros P Where P.IdParametro=1),'NO')
SET @IdObraAsignadaUsuario=IsNull(@IdObraAsignadaUsuario,-1)

SET NOCOUNT OFF

DECLARE @vector_X varchar(50),@vector_T varchar(50)
SET @vector_X='01111111111111111111111111111111111133'
IF @ActivarSolicitudMateriales='SI'
	SET @vector_T='0494D922200FFFFF511235D143E16205525500'
ELSE
	SET @vector_T='0494D122200FFFFF511235D143E16205525500'

SELECT 
 Requerimientos.IdRequerimiento,
 Requerimientos.NumeroRequerimiento as [Numero Req.],
 Requerimientos.IdRequerimiento as [IdReq],
 Requerimientos.FechaRequerimiento as [Fecha],

''  as [Vs],
--'' IsNull('/'+Convert(varchar,Requerimientos.NumeradorEliminacionesFirmas),'') as [Vs],

 Requerimientos.Cumplido as [Cump.],
 Requerimientos.Recepcionado as [Recibido],
 Requerimientos.Entregado as [Entregado],
 Requerimientos.Impresa as [Impresa],
 Requerimientos.Detalle as [Detalle],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 dbo.Requerimientos_Presupuestos(Requerimientos.IdRequerimiento)as [Presupuestos],
 dbo.Requerimientos_Comparativas(Requerimientos.IdRequerimiento)as [Comparativas],
 dbo.Requerimientos_Pedidos(Requerimientos.IdRequerimiento)as [Pedidos],
 dbo.Requerimientos_Recepciones(Requerimientos.IdRequerimiento)as [Recepciones],
 dbo.Requerimientos_SalidasMateriales(Requerimientos.IdRequerimiento)as [Salidas], 
 (Select Count(*) From DetalleRequerimientos Where DetalleRequerimientos.IdRequerimiento=Requerimientos.IdRequerimiento) as [Cant.Items],
 E1.Nombre as [Liberada por],
 E2.Nombre as [Solicitada por],
 Sectores.Descripcion as [Sector],
 ArchivosATransmitirDestinos.Descripcion as [Origen],
 Requerimientos.FechaImportacionTransmision as [Fecha imp.transm,],
 Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS+' '+Articulos.Descripcion as [Equipo destino],
 Requerimientos.UsuarioAnulacion as [Anulo],
 Requerimientos.FechaAnulacion as [Fecha anulacion],
 Requerimientos.MotivoAnulacion as [Motivo anulacion],
 TiposCompra.Descripcion as [Tipo compra],
 (Select Top 1 Empleados.Nombre From Empleados 
  Where Empleados.IdEmpleado=(Select Top 1 Aut.IdAutorizo From AutorizacionesPorComprobante Aut 
				Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and Aut.IdComprobante=Requerimientos.IdRequerimiento)) as [2da.Firma],
 (Select Top 1 Aut.FechaAutorizacion 
  From AutorizacionesPorComprobante Aut 
  Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and Aut.IdComprobante=Requerimientos.IdRequerimiento) as [Fecha 2da.Firma],
 (Select Top 1 Empleados.Nombre From Empleados 
  Where Empleados.IdEmpleado=(Select Top 1 Det.IdComprador From DetalleRequerimientos Det 
				Where Det.IdRequerimiento=Requerimientos.IdRequerimiento and Det.IdComprador  is not null)) as [Comprador],
 E3.Nombre as [Importada por],
 Requerimientos.FechaLlegadaImportacion as [Fec.llego SAT],
 dbo.Requerimientos_FechasLiberacion(Requerimientos.IdRequerimiento) as [Fechas de liberacion para compras por item],
 Requerimientos.DetalleImputacion as [Detalle imputacion],
 Requerimientos.Observaciones as [Observaciones],
 Requerimientos.NumeradorEliminacionesFirmas as [Elim.Firmas],
 @Vector_T as Vector_T,
 @Vector_X as Vector_X
FROM Requerimientos
LEFT OUTER JOIN Obras ON Requerimientos.IdObra=Obras.IdObra
LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto=CentrosCosto.IdCentroCosto
LEFT OUTER JOIN Sectores ON Requerimientos.IdSector=Sectores.IdSector
LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino=Articulos.IdArticulo
LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
LEFT OUTER JOIN Empleados E1 ON E1.IdEmpleado = Requerimientos.Aprobo
LEFT OUTER JOIN Empleados E2 ON E2.IdEmpleado = Requerimientos.IdSolicito
LEFT OUTER JOIN Empleados E3 ON E3.IdEmpleado = Requerimientos.IdImporto
WHERE (Requerimientos.FechaRequerimiento Between @Desde And @Hasta) 
	--and isNull(Requerimientos.Confirmado,'SI')<>'NO' 
	--and IsNull(Requerimientos.ConfirmadoPorWeb,'SI')<>'NO' 
	and	(@IdObraAsignadaUsuario=-1 or Requerimientos.IdObra=@IdObraAsignadaUsuario)
ORDER BY Requerimientos.FechaRequerimiento Desc, Requerimientos.NumeroRequerimiento Desc


GO
/****** Object:  StoredProcedure [dbo].[wUltimosComprobantesCreados]    Script Date: 10/17/2012 11:13:38 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wUltimosComprobantesCreados
    @q VARCHAR(50)
AS



select top 20 *
	FROM dbo.wFuncionBusqueda(@q)

	WHERE Numero LIKE @q+'%'
	order by fecha desc




GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TTpaginadoTotalCount]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wRequerimientos_TTpaginadoTotalCount
(
	@ColumnaParaFiltrar  nvarchar(50)=null,
	@TextoParaFiltrar    nvarchar(50)=null,
	
	@fechadesde date,
	@fechahasta date
)
AS
SELECT COUNT(*) FROM dbo.Requerimientos
WHERE
  FechaRequerimiento between @fechadesde and @fechahasta
and
	CASE @ColumnaParaFiltrar
		WHEN 'Numero' THEN NumeroRequerimiento
	END
		LIKE '%'+@TextoParaFiltrar+'%'


GO
/****** Object:  StoredProcedure [dbo].[wActividadesProveedores_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wActividadesProveedores_TL]
AS 
SELECT IdActividad, Descripcion as [Titulo]
FROM [Actividades Proveedores]
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TTpaginado]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wRequerimientos_TTpaginado
(
    @startRowIndex int,
    @maximumRows int,
	
	@ColumnaParaFiltrar  nvarchar(50)=null,
	@TextoParaFiltrar    nvarchar(50)=null,
	
	@sortExpression      nvarchar(50),

	@fechadesde datetime,
	@fechahasta datetime

)
AS

-- http://www.4guysfromrolla.com/webtech/042606-1.shtml acá explican cómo paginar 
-- http://www.4guysfromrolla.com/articles/040407-1.aspx y acá explican cómo paginar Y filtrar. Naturalmente, necesitas los (fastidiosos) parametros de filtrado


DECLARE @first_id int, @startRow int
	
-- A check can be added to make sure @startRowIndex isn't > count(1)
-- from employees before doing any actual work unless it is guaranteed
-- the caller won't do that

-- Get the first employeeID for our page of records
SET ROWCOUNT @startRowIndex

SELECT @first_id = IdRequerimiento 
FROM Requerimientos 

WHERE FechaRequerimiento between @fechadesde and @fechahasta
and
	CASE @ColumnaParaFiltrar
		WHEN 'Numero' THEN NumeroRequerimiento
	END
		LIKE '%'+@TextoParaFiltrar+'%'

ORDER BY IdRequerimiento DESC

-- Now, set the row count to MaximumRows and get
-- all records >= @first_id
SET ROWCOUNT @maximumRows






--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------

    DECLARE @ActivarSolicitudMateriales VARCHAR(2)
    SET @ActivarSolicitudMateriales = ISNULL(( SELECT TOP 1
                                                        P.ActivarSolicitudMateriales
                                               FROM     Parametros P
                                               WHERE    P.IdParametro = 1
                                             ), 'NO')




SELECT 
 Requerimientos.IdRequerimiento,
 Requerimientos.IdRequerimiento as id,
 Requerimientos.NumeroRequerimiento as [Numero Req.],
 Requerimientos.NumeroRequerimiento as [Numero],
 Requerimientos.IdRequerimiento as [IdReq],
 Requerimientos.FechaRequerimiento as [Fecha],
 
 '' as [Vs],
 --IsNull('/'+Convert(varchar,Requerimientos.NumeradorEliminacionesFirmas),'') as [Vs],
 
 
 Requerimientos.Cumplido as [Cump.],
 Requerimientos.Recepcionado as [Recibido],
 Requerimientos.Entregado as [Entregado],
 Requerimientos.Impresa as [Impresa],
 Requerimientos.Detalle as [Detalle],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 dbo.Requerimientos_Presupuestos(Requerimientos.IdRequerimiento)as [Presupuestos],
 dbo.Requerimientos_Comparativas(Requerimientos.IdRequerimiento)as [Comparativas],
 dbo.Requerimientos_Pedidos(Requerimientos.IdRequerimiento)as [Pedidos],
 dbo.Requerimientos_Recepciones(Requerimientos.IdRequerimiento)as [Recepciones],
 dbo.Requerimientos_SalidasMateriales(Requerimientos.IdRequerimiento)as [Salidas], 
 (Select Count(*) From DetalleRequerimientos Where DetalleRequerimientos.IdRequerimiento=Requerimientos.IdRequerimiento) as [Cant.Items],
 E1.Nombre as [Liberada por],
 E2.Nombre as [Solicitada por],
 Sectores.Descripcion as [Sector],
 ArchivosATransmitirDestinos.Descripcion as [Origen],
 Requerimientos.FechaImportacionTransmision as [Fecha imp.transm,],
 Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS+' '+Articulos.Descripcion as [Equipo destino],
 Requerimientos.UsuarioAnulacion as [Anulo],
 Requerimientos.FechaAnulacion as [Fecha anulacion],
 Requerimientos.MotivoAnulacion as [Motivo anulacion],
 TiposCompra.Descripcion as [Tipo compra],
 (Select Top 1 Empleados.Nombre From Empleados 
  Where Empleados.IdEmpleado=(Select Top 1 Aut.IdAutorizo From AutorizacionesPorComprobante Aut 
				Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and Aut.IdComprobante=Requerimientos.IdRequerimiento)) as [2da.Firma],
 (Select Top 1 Aut.FechaAutorizacion 
  From AutorizacionesPorComprobante Aut 
  Where Aut.IdFormulario=3 and Aut.OrdenAutorizacion=1 and Aut.IdComprobante=Requerimientos.IdRequerimiento) as [Fecha 2da.Firma],
 (Select Top 1 Empleados.Nombre From Empleados 
  Where Empleados.IdEmpleado=(Select Top 1 Det.IdComprador From DetalleRequerimientos Det 
				Where Det.IdRequerimiento=Requerimientos.IdRequerimiento and Det.IdComprador  is not null)) as [Comprador],
 E3.Nombre as [Importada por],
 Requerimientos.FechaLlegadaImportacion as [Fec.llego SAT],
 dbo.Requerimientos_FechasLiberacion(Requerimientos.IdRequerimiento) as [Fechas de liberacion para compras por item],
 Requerimientos.DetalleImputacion as [Detalle imputacion],
 Requerimientos.Observaciones as [Observaciones],
 Requerimientos.NumeradorEliminacionesFirmas as [Elim.Firmas]

FROM Requerimientos
LEFT OUTER JOIN Obras ON Requerimientos.IdObra=Obras.IdObra
LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto=CentrosCosto.IdCentroCosto
LEFT OUTER JOIN Sectores ON Requerimientos.IdSector=Sectores.IdSector
LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino=Articulos.IdArticulo
LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
LEFT OUTER JOIN Empleados E1 ON E1.IdEmpleado = Requerimientos.Aprobo
LEFT OUTER JOIN Empleados E2 ON E2.IdEmpleado = Requerimientos.IdSolicito
LEFT OUTER JOIN Empleados E3 ON E3.IdEmpleado = Requerimientos.IdImporto


    WHERE IdRequerimiento <= @first_id

AND  FechaRequerimiento between @fechadesde and @fechahasta
and
	CASE @ColumnaParaFiltrar
		WHEN 'Numero' THEN NumeroRequerimiento
	END
		LIKE '%'+@TextoParaFiltrar+'%'


    ORDER BY IdRequerimiento DESC


-----------------------------
-----------------------------
--FALTA UN PEDAZO ENORME SACADO PARA ACELERAR
-----------------------------
-----------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------

SET ROWCOUNT 0



GO
/****** Object:  StoredProcedure [dbo].[wAjustesStock_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  Procedure [dbo].[wAjustesStock_TX_PorIdConDatos]

@IdAjusteStock int

AS 

SELECT 
 AjustesStock.*,
 Case When AjustesStock.TipoAjuste='I' Then 'Inventario' Else 'Ajuste normal' End as [TipoAjuste1],
 ArchivosATransmitirDestinos.Descripcion as [Origen],
 E1.Nombre as [Realizo],
 E2.Nombre as [Libero],
 E3.Nombre as [Ingreso],
 E4.Nombre as [Modifico]
FROM AjustesStock
LEFT OUTER JOIN ArchivosATransmitirDestinos ON AjustesStock.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
LEFT OUTER JOIN Empleados E1 ON AjustesStock.IdRealizo = E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON AjustesStock.IdAprobo = E2.IdEmpleado
LEFT OUTER JOIN Empleados E3 ON AjustesStock.IdUsuarioIngreso = E3.IdEmpleado
LEFT OUTER JOIN Empleados E4 ON AjustesStock.IdUsuarioModifico = E4.IdEmpleado
WHERE (IdAjusteStock=@IdAjusteStock)

GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetRequerimientos_A]
    @IdDetalleRequerimiento INT,
    @IdRequerimiento INT,
    @NumeroItem INT,
    @Cantidad NUMERIC(12, 2),
    @IdUnidad INT,
    @IdArticulo INT,
    @FechaEntrega DATETIME,
    @Observaciones NTEXT,
    @Cantidad1 NUMERIC(12, 2),
    @Cantidad2 NUMERIC(12, 2),
    @IdDetalleLMateriales INT,
    @IdComprador INT,
    @NumeroFacturaCompra1 INT,
    @FechaFacturaCompra DATETIME,
    @ImporteFacturaCompra NUMERIC(12, 2),
    @IdProveedor INT,
    @NumeroFacturaCompra2 INT,
    @Cumplido VARCHAR(2),
    @DescripcionManual VARCHAR(250),
    @IdRequerimientoOriginal INT,
    @IdDetalleRequerimientoOriginal INT,
    @IdOrigenTransmision INT,
    @IdAutorizoCumplido INT,
    @IdDioPorCumplido INT,
    @FechaDadoPorCumplido DATETIME,
    @ObservacionesCumplido NTEXT,
    @Costo NUMERIC(18, 2),
    @OrigenDescripcion INT,
    @TipoDesignacion VARCHAR(3),
    @IdLiberoParaCompras INT,
    @FechaLiberacionParaCompras DATETIME,
    @Recepcionado VARCHAR(2),
    @Pagina INT,
    @Item INT,
    @Figura INT,
    @CodigoDistribucion VARCHAR(3),
    @IdEquipoDestino INT,
    @Entregado VARCHAR(2),
    @FechaAsignacionComprador DATETIME,
    @MoP VARCHAR(1),
    @IdDetalleObraDestino INT,
    @Adjunto VARCHAR(2),
    @ArchivoAdjunto1 VARCHAR(100)
AS 

	if @TipoDesignacion=''  set @tipoDesignacion=null

    IF ISNULL(@IdDetalleRequerimiento, 0) <= 0 
        BEGIN
            INSERT  INTO DetalleRequerimientos
                    (
                      IdRequerimiento,
                      NumeroItem,
                      Cantidad,
                      IdUnidad,
                      IdArticulo,
                      FechaEntrega,
                      Observaciones,
                      Cantidad1,
                      Cantidad2,
                      IdDetalleLMateriales,
                      IdComprador,
                      NumeroFacturaCompra1,
                      FechaFacturaCompra,
                      ImporteFacturaCompra,
                      IdProveedor,
                      NumeroFacturaCompra2,
                      Cumplido,
                      DescripcionManual,
                      IdRequerimientoOriginal,
                      IdDetalleRequerimientoOriginal,
                      IdOrigenTransmision,
                      IdAutorizoCumplido,
                      IdDioPorCumplido,
                      FechaDadoPorCumplido,
                      ObservacionesCumplido,
                      Costo,
                      OrigenDescripcion,
                      TipoDesignacion,
                      IdLiberoParaCompras,
                      FechaLiberacionParaCompras,
                      Recepcionado,
                      Pagina,
                      Item,
                      Figura,
                      CodigoDistribucion,
                      IdEquipoDestino,
                      Entregado,
                      FechaAsignacionComprador,
                      MoP,
                      IdDetalleObraDestino,
                      Adjunto,
                      ArchivoAdjunto1

	              )
            VALUES  (
                      @IdRequerimiento,
                      @NumeroItem,
                      @Cantidad,
                      @IdUnidad,
                      @IdArticulo,
                      @FechaEntrega,
                      @Observaciones,
                      @Cantidad1,
                      @Cantidad2,
                      @IdDetalleLMateriales,
                      @IdComprador,
                      @NumeroFacturaCompra1,
                      @FechaFacturaCompra,
                      @ImporteFacturaCompra,
                      @IdProveedor,
                      @NumeroFacturaCompra2,
                      @Cumplido,
                      @DescripcionManual,
                      @IdRequerimientoOriginal,
                      @IdDetalleRequerimientoOriginal,
                      @IdOrigenTransmision,
                      @IdAutorizoCumplido,
                      @IdDioPorCumplido,
                      @FechaDadoPorCumplido,
                      @ObservacionesCumplido,
                      @Costo,
                      @OrigenDescripcion,
                      @TipoDesignacion,
                      @IdLiberoParaCompras,
                      @FechaLiberacionParaCompras,
                      @Recepcionado,
                      @Pagina,
                      @Item,
                      @Figura,
                      @CodigoDistribucion,
                      @IdEquipoDestino,
                      @Entregado,
                      @FechaAsignacionComprador,
                      @MoP,
                      @IdDetalleObraDestino,
                      @Adjunto,
                      @ArchivoAdjunto1

	              )
	
            SELECT  @IdDetalleRequerimiento = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  DetalleRequerimientos
            SET     IdRequerimiento = @IdRequerimiento,
                    NumeroItem = @NumeroItem,
                    Cantidad = @Cantidad,
                    IdUnidad = @IdUnidad,
                    IdArticulo = @IdArticulo,
                    FechaEntrega = @FechaEntrega,
                    Observaciones = @Observaciones,
                    Cantidad1 = @Cantidad1,
                    Cantidad2 = @Cantidad2,
                    IdDetalleLMateriales = @IdDetalleLMateriales,
                    IdComprador = @IdComprador,
                    NumeroFacturaCompra1 = @NumeroFacturaCompra1,
                    FechaFacturaCompra = @FechaFacturaCompra,
                    ImporteFacturaCompra = @ImporteFacturaCompra,
                    IdProveedor = @IdProveedor,
                    NumeroFacturaCompra2 = @NumeroFacturaCompra2,
                    Cumplido = @Cumplido,
                    DescripcionManual = @DescripcionManual,
                    IdRequerimientoOriginal = @IdRequerimientoOriginal,
                    IdDetalleRequerimientoOriginal = @IdDetalleRequerimientoOriginal,
                    IdOrigenTransmision = @IdOrigenTransmision,
                    IdAutorizoCumplido = @IdAutorizoCumplido,
                    IdDioPorCumplido = @IdDioPorCumplido,
                    FechaDadoPorCumplido = @FechaDadoPorCumplido,
                    ObservacionesCumplido = @ObservacionesCumplido,
                    Costo = @Costo,
                    OrigenDescripcion = @OrigenDescripcion,
                    TipoDesignacion = @TipoDesignacion,
                    IdLiberoParaCompras = @IdLiberoParaCompras,
                    FechaLiberacionParaCompras = @FechaLiberacionParaCompras,
                    Recepcionado = @Recepcionado,
                    Pagina = @Pagina,
                    Item = @Item,
                    Figura = @Figura,
                    CodigoDistribucion = @CodigoDistribucion,
                    IdEquipoDestino = @IdEquipoDestino,
                    Entregado = @Entregado,
                    FechaAsignacionComprador = @FechaAsignacionComprador,
                    MoP = @MoP,
                    IdDetalleObraDestino = @IdDetalleObraDestino,
                    Adjunto = @Adjunto,
                    ArchivoAdjunto1 = @ArchivoAdjunto1
            WHERE   ( IdDetalleRequerimiento = @IdDetalleRequerimiento )
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdDetalleRequerimiento


GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[wDetRequerimientos_E]
    @IdDetalleRequerimiento INT
AS 
    DELETE  [DetalleRequerimientos]
    WHERE   ( IdDetalleRequerimiento = @IdDetalleRequerimiento )


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wArticulos_E]

@IdArticulo int  

AS 

DELETE Articulos
WHERE (IdArticulo=@IdArticulo)



GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetRequerimientos_T]
    @IdDetalleRequerimiento INT
AS 
    SELECT  *
    FROM    [DetalleRequerimientos]
    WHERE   ( IdDetalleRequerimiento = @IdDetalleRequerimiento )


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_PorCodigo]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wArticulos_PorCodigo]
@Codigo varchar(20)
AS 
SELECT *
FROM Articulos
WHERE IsNull(Articulos.Activo,'')<>'NO' and Codigo=@Codigo



GO
/****** Object:  StoredProcedure [dbo].[wDetRequerimientos_TT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetRequerimientos_TT] @IdRequerimiento INT
AS 
    SELECT  DetReq.*,
            Requerimientos.NumeroRequerimiento,
            Requerimientos.FechaRequerimiento,
            Requerimientos.Aprobo,
            Requerimientos.IdObra AS [IdObra],
            Articulos.Descripcion AS [Articulo],
            Articulos.Codigo,
            ISNULL(Unidades.Abreviatura, Unidades.Descripcion) AS [Unidad],
            ( SELECT    SUM(DetRec.Cantidad)
              FROM      DetalleRecepciones DetRec
                        LEFT OUTER JOIN Recepciones ON DetRec.IdRecepcion = Recepciones.IdRecepcion
              WHERE     DetReq.IdDetalleRequerimiento = DetRec.IdDetalleRequerimiento
                        AND ( Recepciones.Anulada IS NULL
                              OR Recepciones.Anulada <> 'SI'
                            )
            ) AS [Entregado],
            DetReq.Cantidad
            - ISNULL(( SELECT   SUM(DetRec.Cantidad)
                       FROM     DetalleRecepciones DetRec
                                LEFT OUTER JOIN Recepciones ON Recepciones.IdRecepcion = DetRec.IdRecepcion
                       WHERE    DetRec.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( Recepciones.Anulada IS NULL
                                      OR Recepciones.Anulada <> 'SI'
                                    )
                     ), 0) AS [Pendiente],
            ISNULL(( SELECT SUM(DetallePedidos.Cantidad)
                     FROM   DetallePedidos
                     WHERE  DetallePedidos.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                            AND ( DetallePedidos.Cumplido IS NULL
                                  OR DetallePedidos.Cumplido <> 'AN'
                                )
                   ), 0) AS [Pedido],
            ISNULL(( SELECT SUM(DetalleValesSalida.Cantidad)
                     FROM   DetalleValesSalida
                     WHERE  DetalleValesSalida.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                            AND ( DetalleValesSalida.Estado IS NULL
                                  OR DetalleValesSalida.Estado <> 'AN'
                                )
                   ), 0) AS [SalidaPorVales],
            0 AS [Reservado],
            Obras.NumeroObra AS [Obra],
            Obras.NumeroObra + ' ' + Obras.Descripcion AS [Obra1],
            Clientes.RazonSocial AS [Cliente],
            Equipos.Descripcion AS [Equipo],
            Rubros.Descripcion AS [Rubro],
            ISNULL(ControlesCalidad.Abreviatura, ControlesCalidad.Descripcion) AS [CC],
            E1.Nombre AS [Libero],
            E2.Nombre AS [Solicito],
            E3.Nombre AS [Comprador],
            Proveedores.RazonSocial AS [ProveedorCompra]
    FROM    DetalleRequerimientos DetReq
            LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento = DetReq.IdRequerimiento
            LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Unidades ON DetReq.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
            LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
            LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
            LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
            LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
            LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
            LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
            LEFT OUTER JOIN Proveedores ON DetReq.IdProveedor = Proveedores.IdProveedor
    WHERE   DetReq.IdRequerimiento = @IdRequerimiento


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_PorId]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wArticulos_PorId]

@IdArticulo int = Null

AS 

SELECT Articulos.*
FROM Articulos
WHERE Articulos.IdArticulo=@IdArticulo and IsNull(Articulos.Activo,'')<>'NO'



GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_T_ByEmployee]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wRequerimientos_T_ByEmployee]
    @IdRequerimiento INT = NULL,
    @IdSolicito INT
AS 
    SET NOCOUNT ON

    SET @IdRequerimiento = ISNULL(@IdRequerimiento, -1)

    DECLARE @ActivarSolicitudMateriales VARCHAR(2)
    SET @ActivarSolicitudMateriales = ISNULL(( SELECT TOP 1
                                                        P.ActivarSolicitudMateriales
                                               FROM     Parametros P
                                               WHERE    P.IdParametro = 1
                                             ), 'NO')

/* PRESUPUESTOS */
    CREATE TABLE #Auxiliar0
        (
          IdRequerimiento INTEGER,
          Presupuestos VARCHAR(100)
        )

    CREATE TABLE #Auxiliar1
        (
          IdRequerimiento INTEGER,
          Presupuesto VARCHAR(13)
        )
    INSERT  INTO #Auxiliar1
            SELECT  DetReq.IdRequerimiento,
                    CONVERT(VARCHAR, Presupuestos.Numero)
                    + CASE WHEN Presupuestos.Subnumero IS NOT NULL
                           THEN '/' + CONVERT(VARCHAR, Presupuestos.Subnumero)
                           ELSE ''
                      END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
                    LEFT OUTER JOIN Presupuestos ON DetallePresupuestos.IdPresupuesto = Presupuestos.IdPresupuesto
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            WHERE   ( @IdRequerimiento = -1
                      OR DetReq.IdRequerimiento = @IdRequerimiento
                    )
                    AND Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.Cumplido <> 'AN'

    CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 ( IdRequerimiento, Presupuesto )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar0
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar1
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @IdRequerimiento1 INT,
        @Presupuesto VARCHAR(13),
        @P VARCHAR(100),
        @Corte INT
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Presupuesto
            FROM    #Auxiliar1
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar0
                            SET     Presupuestos = SUBSTRING(@P, 1, 100)
                            WHERE   #Auxiliar0.IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Presupuesto IS NULL 
                IF PATINDEX('%' + @Presupuesto + ' ' + '%', @P) = 0 
                    SET @P = @P + @Presupuesto + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar0
            SET     Presupuestos = SUBSTRING(@P, 1, 100)
            WHERE   #Auxiliar0.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* COMPARATIVAS */
    CREATE TABLE #Auxiliar2
        (
          IdRequerimiento INTEGER,
          Comparativas VARCHAR(100)
        )

    CREATE TABLE #Auxiliar3
        (
          IdRequerimiento INTEGER,
          Comparativa INTEGER
        )
    INSERT  INTO #Auxiliar3
            SELECT  DetReq.IdRequerimiento,
                    Comparativas.Numero
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
                    LEFT OUTER JOIN DetalleComparativas ON DetallePresupuestos.IdDetallePresupuesto = DetalleComparativas.IdDetallePresupuesto
                    LEFT OUTER JOIN Comparativas ON DetalleComparativas.IdComparativa = Comparativas.IdComparativa
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            WHERE   ( @IdRequerimiento = -1
                      OR DetReq.IdRequerimiento = @IdRequerimiento
                    )
                    AND Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.Cumplido <> 'AN'

    CREATE NONCLUSTERED INDEX IX__Auxiliar3 ON #Auxiliar3 ( IdRequerimiento, Comparativa )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar2
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar3
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Comparativa INT,
        @C VARCHAR(100)
    SET @Corte = 0
    SET @C = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Comparativa
            FROM    #Auxiliar3
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar2
                            SET     Comparativas = SUBSTRING(@C, 1, 100)
                            WHERE   #Auxiliar2.IdRequerimiento = @Corte
                        END
                    SET @C = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Comparativa IS NULL 
                IF PATINDEX('%' + CONVERT(VARCHAR, @Comparativa) + ' ' + '%',
                            @C) = 0 
                    SET @C = @C + CONVERT(VARCHAR, @Comparativa) + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar2
            SET     Comparativas = SUBSTRING(@C, 1, 100)
            WHERE   #Auxiliar2.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* PEDIDOS */
    CREATE TABLE #Auxiliar4
        (
          IdRequerimiento INTEGER,
          Pedidos VARCHAR(100)
        )

    CREATE TABLE #Auxiliar5
        (
          IdRequerimiento INTEGER,
          Pedido VARCHAR(13)
        )
    INSERT  INTO #Auxiliar5
            SELECT  DetReq.IdRequerimiento,
                    CONVERT(VARCHAR, Pedidos.NumeroPedido)
                    + CASE WHEN Pedidos.Subnumero IS NOT NULL
                           THEN '/' + CONVERT(VARCHAR, Pedidos.Subnumero)
                           ELSE ''
                      END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN DetallePedidos ON DetReq.IdDetalleRequerimiento = DetallePedidos.IdDetalleRequerimiento
                    LEFT OUTER JOIN Pedidos ON DetallePedidos.IdPedido = Pedidos.IdPedido
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            WHERE   ( @IdRequerimiento = -1
                      OR DetReq.IdRequerimiento = @IdRequerimiento
                    )
                    AND Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.Cumplido <> 'AN'

    CREATE NONCLUSTERED INDEX IX__Auxiliar5 ON #Auxiliar5 ( IdRequerimiento, Pedido )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar4
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar5
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Pedido VARCHAR(13)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Pedido
            FROM    #Auxiliar5
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar4
                            SET     Pedidos = SUBSTRING(@P, 1, 100)
                            WHERE   #Auxiliar4.IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Pedido IS NULL 
                IF PATINDEX('%' + @Pedido + ' ' + '%', @P) = 0 
                    SET @P = @P + @Pedido + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar4
            SET     Pedidos = SUBSTRING(@P, 1, 100)
            WHERE   #Auxiliar4.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* RECEPCION DE MATERIALES */
    CREATE TABLE #Auxiliar6
        (
          IdRequerimiento INTEGER,
          Recepciones VARCHAR(100)
        )

    CREATE TABLE #Auxiliar7
        (
          IdRequerimiento INTEGER,
          Recepcion VARCHAR(20)
        )
    INSERT  INTO #Auxiliar7
            SELECT  DetReq.IdRequerimiento,
                    CASE WHEN Recepciones.SubNumero IS NOT NULL
                         THEN SUBSTRING(SUBSTRING('0000', 1,
                                                  4
                                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)
                                        + '-' + SUBSTRING('00000000', 1,
                                                          8
                                                          - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)
                                        + '/'
                                        + CONVERT(VARCHAR, Recepciones.SubNumero),
                                        1, 20)
                         ELSE SUBSTRING(SUBSTRING('0000', 1,
                                                  4
                                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)
                                        + '-' + SUBSTRING('00000000', 1,
                                                          8
                                                          - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2),
                                        1, 20)
                    END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN DetalleRecepciones ON DetReq.IdDetalleRequerimiento = DetalleRecepciones.IdDetalleRequerimiento
                    LEFT OUTER JOIN Recepciones ON DetalleRecepciones.IdRecepcion = Recepciones.IdRecepcion
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            WHERE   ( @IdRequerimiento = -1
                      OR DetReq.IdRequerimiento = @IdRequerimiento
                    )
                    AND Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.Cumplido <> 'AN'


    CREATE NONCLUSTERED INDEX IX__Auxiliar7 ON #Auxiliar7 ( IdRequerimiento, Recepcion )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar6
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar7
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Recepcion VARCHAR(20)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Recepcion
            FROM    #Auxiliar7
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar6
                            SET     Recepciones = SUBSTRING(@P, 1, 100)
                            WHERE   IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Recepcion IS NULL 
                IF PATINDEX('%' + @Recepcion + ' ' + '%', @P) = 0 
                    SET @P = @P + @Recepcion + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar6
            SET     Recepciones = SUBSTRING(@P, 1, 100)
            WHERE   IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* SALIDAS DE MATERIALES */
    CREATE TABLE #Auxiliar8
        (
          IdRequerimiento INTEGER,
          Salidas VARCHAR(100)
        )

    CREATE TABLE #Auxiliar9
        (
          IdRequerimiento INTEGER,
          Salida VARCHAR(13)
        )
    INSERT  INTO #Auxiliar9
            SELECT  DetReq.IdRequerimiento,
                    SUBSTRING(SUBSTRING('0000', 1,
                                        4
                                        - LEN(CONVERT(VARCHAR, ISNULL(SalidasMateriales.NumeroSalidaMateriales2, 0))))
                              + CONVERT(VARCHAR, ISNULL(SalidasMateriales.NumeroSalidaMateriales2,
                                                        0)) + '-'
                              + SUBSTRING('00000000', 1,
                                          8
                                          - LEN(CONVERT(VARCHAR, SalidasMateriales.NumeroSalidaMateriales)))
                              + CONVERT(VARCHAR, SalidasMateriales.NumeroSalidaMateriales),
                              1, 13)
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN DetalleValesSalida ON DetReq.IdDetalleRequerimiento = DetalleValesSalida.IdDetalleRequerimiento
                    LEFT OUTER JOIN DetalleSalidasMateriales ON DetalleValesSalida.IdDetalleValeSalida = DetalleSalidasMateriales.IdDetalleValeSalida
                    LEFT OUTER JOIN SalidasMateriales ON DetalleSalidasMateriales.IdSalidaMateriales = SalidasMateriales.IdSalidaMateriales
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            WHERE   ( @IdRequerimiento = -1
                      OR DetReq.IdRequerimiento = @IdRequerimiento
                    )
                    AND Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.Cumplido <> 'AN'


    CREATE NONCLUSTERED INDEX IX__Auxiliar9 ON #Auxiliar9 ( IdRequerimiento, Salida )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar8
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar9
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Salida VARCHAR(13)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Salida
            FROM    #Auxiliar9
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar8
                            SET     Salidas = SUBSTRING(@P, 1, 100)
                            WHERE   IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Salida IS NULL 
                IF PATINDEX('%' + @Salida + ' ' + '%', @P) = 0 
                    SET @P = @P + @Salida + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar8
            SET     Salidas = SUBSTRING(@P, 1, 100)
            WHERE   IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur

    SET NOCOUNT OFF

    SELECT  Requerimientos.*,
            Obras.NumeroObra + ' ' + Obras.Descripcion AS [Obra],
            #Auxiliar0.Presupuestos AS [Presupuestos],
            #Auxiliar2.Comparativas AS [Comparativas],
            #Auxiliar4.Pedidos AS [Pedidos],
            #Auxiliar6.Recepciones AS [Recepciones],
            #Auxiliar8.Salidas AS [Salidas],
            ( SELECT    COUNT(*)
              FROM      DetalleRequerimientos Det
              WHERE     Det.IdRequerimiento = Requerimientos.IdRequerimiento
            ) AS [Items],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.Aprobo = E.IdEmpleado
            ) AS [Libero],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdSolicito = E.IdEmpleado
            ) AS [Solicito],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdComprador = E.IdEmpleado
            ) AS [Comprador],
            Sectores.Descripcion AS [Sector],
            ArchivosATransmitirDestinos.Descripcion AS [Origen],
            Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS
            + ' ' + Articulos.Descripcion AS [EquipoDestino],
            TiposCompra.Descripcion AS [TipoCompra],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     E.IdEmpleado = ( SELECT TOP 1
                                                Aut.IdAutorizo
                                         FROM   AutorizacionesPorComprobante Aut
                                         WHERE  Aut.IdFormulario = 3
                                                AND Aut.OrdenAutorizacion = 1
                                                AND Aut.IdComprobante = Requerimientos.IdRequerimiento
                                       )
            ) AS [SegundaFirma],
            ( SELECT TOP 1
                        Aut.FechaAutorizacion
              FROM      AutorizacionesPorComprobante Aut
              WHERE     Aut.IdFormulario = 3
                        AND Aut.OrdenAutorizacion = 1
                        AND Aut.IdComprobante = Requerimientos.IdRequerimiento
            ) AS [FechaSegundaFirma],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     E.IdEmpleado = ( SELECT TOP 1
                                                Det.IdComprador
                                         FROM   DetalleRequerimientos Det
                                         WHERE  Det.IdRequerimiento = Requerimientos.IdRequerimiento
                                                AND Det.IdComprador IS NOT NULL
                                       )
            ) AS [CompradorItem]
    FROM    Requerimientos
            LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
            LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto = CentrosCosto.IdCentroCosto
            LEFT OUTER JOIN Sectores ON Requerimientos.IdSector = Sectores.IdSector
            LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
            LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino = Articulos.IdArticulo
            LEFT OUTER JOIN #Auxiliar0 ON Requerimientos.IdRequerimiento = #Auxiliar0.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar2 ON Requerimientos.IdRequerimiento = #Auxiliar2.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar4 ON Requerimientos.IdRequerimiento = #Auxiliar4.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar6 ON Requerimientos.IdRequerimiento = #Auxiliar6.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar8 ON Requerimientos.IdRequerimiento = #Auxiliar8.IdRequerimiento
            LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
    WHERE   ( @IdRequerimiento = -1
              OR Requerimientos.IdRequerimiento = @IdRequerimiento
            )
            AND ( Confirmado IS NULL
                  OR Confirmado <> 'NO'
                )
            AND Requerimientos.IdSolicito = @IdSolicito
            AND Requerimientos.Cumplido <> 'AN'
    ORDER BY Requerimientos.FechaRequerimiento DESC,
            Requerimientos.NumeroRequerimiento DESC

    DROP TABLE #Auxiliar0
    DROP TABLE #Auxiliar1
    DROP TABLE #Auxiliar2
    DROP TABLE #Auxiliar3
    DROP TABLE #Auxiliar4
    DROP TABLE #Auxiliar5
    DROP TABLE #Auxiliar6
    DROP TABLE #Auxiliar7
    DROP TABLE #Auxiliar8
    DROP TABLE #Auxiliar9

GO
/****** Object:  StoredProcedure [dbo].[wClientes_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE Procedure wClientes_A

@IdCliente int output,
@RazonSocial	 				varchar(50),
@Direccion 					varchar(50),
@IdLocalidad	 				int,
@CodigoPostal	 				varchar(30),
@IdProvincia	 				int,
@IdPais	 				int,
@Telefono 					varchar(50),
@Fax		 				varchar(50),
@Email 						varchar(200),
@Cuit	 					varchar(13),
@IdCodigoIva	 				tinyint,
@FechaAlta	 				datetime,
@Contacto 					varchar(50),
@EnviarEmail					tinyint,
@DireccionEntrega				varchar(50),
@IdLocalidadEntrega				int,
@IdProvinciaEntrega				int,
@CodigoCliente					int,
@IdCuenta					int,
@Saldo						numeric(18,2),
@SaldoDocumentos				numeric(18,2),
@Vendedor1					int,
@CreditoMaximo				numeric(18,2),
@IGCondicion					int,
@IdCondicionVenta				int,
@IdMoneda					int,
@IBNumeroInscripcion				varchar(20),
@IBCondicion					int,
@TipoCliente					int,
@Codigo					varchar(10),
@IdListaPrecios					int,
@IdIBCondicionPorDefecto 			int,
@Confirmado					varchar(2),
@CodigoPresto					varchar(13),
@Observaciones				ntext,
@Importaciones_NumeroInscripcion		varchar(20),
@Importaciones_DenominacionInscripcion	varchar(10),
@IdCuentaMonedaExt				int,
@Cobrador					int,
@Auxiliar					varchar(50),
@IdIBCondicionPorDefecto2			int,
@IdIBCondicionPorDefecto3			int,
@IdEstado					int,
@NombreFantasia				varchar(50),
@EsAgenteRetencionIVA			varchar(2),
@BaseMinimaParaPercepcionIVA		numeric(18,2),
@PorcentajePercepcionIVA			numeric(6,2),
@IdUsuarioIngreso 				int,
@FechaIngreso 					datetime,
@IdUsuarioModifico 				int,
@FechaModifico 				datetime,
@PorcentajeIBDirecto				numeric(6,2),
@FechaInicioVigenciaIBDirecto			datetime,
@FechaFinVigenciaIBDirecto			datetime,
@GrupoIIBB					int,
@IdBancoDebito int,
@CBU varchar(22),
@PorcentajeIBDirectoCapital numeric(6,2),
@FechaInicioVigenciaIBDirectoCapital datetime,
@FechaFinVigenciaIBDirectoCapital datetime,
@GrupoIIBBCapital int

AS 

INSERT INTO Clientes
(
 RazonSocial,
 Direccion,
 IdLocalidad,
 CodigoPostal,
 IdProvincia,
 IdPais,
 Telefono,
 Fax,
 Email,
 Cuit,
 IdCodigoIva,
 FechaAlta,
 Contacto,
 EnviarEmail,
 DireccionEntrega,
 IdLocalidadEntrega,
 IdProvinciaEntrega,
 CodigoCliente,
 IdCuenta,
 Saldo,
 SaldoDocumentos,
 Vendedor1,
 CreditoMaximo,
 IGCondicion,
 IdCondicionVenta,
 IdMoneda,
 IBNumeroInscripcion,
 IBCondicion,
 TipoCliente,
 Codigo,
 IdListaPrecios,
 IdIBCondicionPorDefecto,
 Confirmado,
 CodigoPresto,
 Observaciones,
 Importaciones_NumeroInscripcion,
 Importaciones_DenominacionInscripcion,
 IdCuentaMonedaExt,
 Cobrador,
 Auxiliar,
 IdIBCondicionPorDefecto2,
 IdIBCondicionPorDefecto3,
 IdEstado,
 NombreFantasia,
 EsAgenteRetencionIVA,
 BaseMinimaParaPercepcionIVA,
 PorcentajePercepcionIVA,
 IdUsuarioIngreso,
 FechaIngreso, 
 IdUsuarioModifico,
 FechaModifico,
 PorcentajeIBDirecto,
 FechaInicioVigenciaIBDirecto,
 FechaFinVigenciaIBDirecto,
 GrupoIIBB,
 IdBancoDebito,
 CBU,
 PorcentajeIBDirectoCapital,
 FechaInicioVigenciaIBDirectoCapital,
 FechaFinVigenciaIBDirectoCapital,
 GrupoIIBBCapital
)
 VALUES 
(
 @RazonSocial,
 @Direccion,
 @IdLocalidad,
 @CodigoPostal,
 @IdProvincia,
 @IdPais,
 @Telefono,
 @Fax,
 @Email,
 @Cuit,
 @IdCodigoIva,
 @FechaAlta,
 @Contacto,
 @EnviarEmail,
 @DireccionEntrega,
 @IdLocalidadEntrega,
 @IdProvinciaEntrega,
 @CodigoCliente,
 @IdCuenta,
 @Saldo,
 @SaldoDocumentos,
 @Vendedor1,
 @CreditoMaximo,
 @IGCondicion,
 @IdCondicionVenta,
 @IdMoneda,
 @IBNumeroInscripcion,
 @IBCondicion,
 @TipoCliente,
 @Codigo,
 @IdListaPrecios,
 @IdIBCondicionPorDefecto,
 @Confirmado,
 @CodigoPresto,
 @Observaciones,
 @Importaciones_NumeroInscripcion,
 @Importaciones_DenominacionInscripcion,
 @IdCuentaMonedaExt,
 @Cobrador,
 @Auxiliar,
 @IdIBCondicionPorDefecto2,
 @IdIBCondicionPorDefecto3,
 @IdEstado,
 @NombreFantasia,
 @EsAgenteRetencionIVA,
 @BaseMinimaParaPercepcionIVA,
 @PorcentajePercepcionIVA,
 @IdUsuarioIngreso,
 @FechaIngreso,
 @IdUsuarioModifico,
 @FechaModifico,
 @PorcentajeIBDirecto,
 @FechaInicioVigenciaIBDirecto,
 @FechaFinVigenciaIBDirecto,
 @GrupoIIBB,
 @IdBancoDebito,
 @CBU,
 @PorcentajeIBDirectoCapital,
 @FechaInicioVigenciaIBDirectoCapital,
 @FechaFinVigenciaIBDirectoCapital,
 @GrupoIIBBCapital
)
SELECT @IdCliente=@@identity
RETURN(@IdCliente)


GO
/****** Object:  StoredProcedure [dbo].[wClientes_M]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  Procedure wClientes_M

@IdCliente					int,
@RazonSocial	 				varchar(50),
@Direccion 					varchar(50),
@IdLocalidad	 				int,
@CodigoPostal	 				varchar(30),
@IdProvincia	 				int,
@IdPais	 				int,
@Telefono 					varchar(50),
@Fax		 				varchar(50),
@Email 						varchar(200),
@Cuit	 					varchar(13),
@IdCodigoIva	 				tinyint,
@FechaAlta	 				datetime,
@Contacto 					varchar(50),
@EnviarEmail					tinyint,
@DireccionEntrega				varchar(50),
@IdLocalidadEntrega				int,
@IdProvinciaEntrega				int,
@CodigoCliente					int,
@IdCuenta					int,
@Saldo						numeric(18,2),
@SaldoDocumentos				numeric(18,2),
@Vendedor1					int,
@CreditoMaximo				numeric(18,2),
@IGCondicion					int,
@IdCondicionVenta				int,
@IdMoneda					int,
@IBNumeroInscripcion				varchar(20),
@IBCondicion					int,
@TipoCliente					int,
@Codigo					varchar(10),
@IdListaPrecios					int,
@IdIBCondicionPorDefecto 			int,
@Confirmado					varchar(2),
@CodigoPresto					varchar(13),
@Observaciones				ntext,
@Importaciones_NumeroInscripcion		varchar(20),
@Importaciones_DenominacionInscripcion	varchar(10),
@IdCuentaMonedaExt				int,
@Cobrador					int,
@Auxiliar					varchar(50),
@IdIBCondicionPorDefecto2			int,
@IdIBCondicionPorDefecto3			int,
@IdEstado					int,
@NombreFantasia				varchar(50),
@EsAgenteRetencionIVA			varchar(2),
@BaseMinimaParaPercepcionIVA		numeric(18,2),
@PorcentajePercepcionIVA			numeric(6,2),
@IdUsuarioIngreso 				int,
@FechaIngreso 					datetime,
@IdUsuarioModifico 				int,
@FechaModifico 				datetime,
@PorcentajeIBDirecto				numeric(6,2),
@FechaInicioVigenciaIBDirecto			datetime,
@FechaFinVigenciaIBDirecto			datetime,
@GrupoIIBB					int,
@IdBancoDebito int,
@CBU varchar(22),
@PorcentajeIBDirectoCapital numeric(6,2),
@FechaInicioVigenciaIBDirectoCapital datetime,
@FechaFinVigenciaIBDirectoCapital datetime,
@GrupoIIBBCapital int

AS 

UPDATE Clientes
SET
 RazonSocial = @RazonSocial,
 Direccion = @Direccion,
 IdLocalidad = @IdLocalidad,
 CodigoPostal = @CodigoPostal,
 IdProvincia = @IdProvincia,
 IdPais = @IdPais,
 Telefono = @Telefono,
 Fax = @Fax,
 Email = @Email,
 Cuit = @Cuit,
 IdCodigoIva = @IdCodigoIva,
 FechaAlta = @FechaAlta,
 Contacto = @Contacto,
 EnviarEmail = @EnviarEmail,
 DireccionEntrega = @DireccionEntrega,
 IdLocalidadEntrega = @IdLocalidadEntrega,
 IdProvinciaEntrega = @IdProvinciaEntrega,
 CodigoCliente = @CodigoCliente,
 IdCuenta = @IdCuenta,
 Saldo = @Saldo,
 SaldoDocumentos = @SaldoDocumentos,
 Vendedor1 = @Vendedor1,
 CreditoMaximo = @CreditoMaximo,
 IGCondicion = @IGCondicion,
 IdCondicionVenta = @IdCondicionVenta,
 IdMoneda = @IdMoneda,
 IBNumeroInscripcion = @IBNumeroInscripcion,
 IBCondicion = @IBCondicion,
 TipoCliente = @TipoCliente,
 Codigo 	= @Codigo,
 IdListaPrecios = @IdListaPrecios,
 IdIBCondicionPorDefecto = @IdIBCondicionPorDefecto,
 Confirmado = @Confirmado,
 CodigoPresto = @CodigoPresto,
 Observaciones = @Observaciones,
 Importaciones_NumeroInscripcion=@Importaciones_NumeroInscripcion,
 Importaciones_DenominacionInscripcion=@Importaciones_DenominacionInscripcion,
 IdCuentaMonedaExt = @IdCuentaMonedaExt,
 Cobrador = @Cobrador,
 Auxiliar	= @Auxiliar,
 IdIBCondicionPorDefecto2 = @IdIBCondicionPorDefecto2,
 IdIBCondicionPorDefecto3 = @IdIBCondicionPorDefecto3,
 IdEstado = @IdEstado,
 NombreFantasia = @NombreFantasia,
 EsAgenteRetencionIVA	= @EsAgenteRetencionIVA,
 BaseMinimaParaPercepcionIVA = @BaseMinimaParaPercepcionIVA,
 PorcentajePercepcionIVA = @PorcentajePercepcionIVA,
 IdUsuarioIngreso = @IdUsuarioIngreso,
 FechaIngreso = @FechaIngreso,
 IdUsuarioModifico = @IdUsuarioModifico,
 FechaModifico = @FechaModifico,
 PorcentajeIBDirecto = @PorcentajeIBDirecto,
 FechaInicioVigenciaIBDirecto = @FechaInicioVigenciaIBDirecto,
 FechaFinVigenciaIBDirecto=@FechaFinVigenciaIBDirecto,
 GrupoIIBB = @GrupoIIBB,
 IdBancoDebito=@IdBancoDebito,
 CBU=@CBU,
 PorcentajeIBDirectoCapital=@PorcentajeIBDirectoCapital,
 FechaInicioVigenciaIBDirectoCapital=@FechaInicioVigenciaIBDirectoCapital,
 FechaFinVigenciaIBDirectoCapital=@FechaFinVigenciaIBDirectoCapital,
 GrupoIIBBCapital=@GrupoIIBBCapital
WHERE [IdCliente]=@IdCliente

RETURN(@IdCliente)


GO
/****** Object:  StoredProcedure [dbo].[wAutorizacionesPorComprobante_TX_DocumentosPorAutoriza]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wAutorizacionesPorComprobante_TX_DocumentosPorAutoriza]

@IdAutoriza int = Null

AS

SET NOCOUNT ON
SET @IdAutoriza=IsNull(@IdAutoriza,-1)
EXEC AutorizacionesPorComprobante_Generar
SET NOCOUNT OFF

SELECT  
 Aut.IdComprobante,
 Case When Aut.IdFormulario=1 Then 101 
	When Aut.IdFormulario=2 Then 102
	When Aut.IdFormulario=3 Then 103
	When Aut.IdFormulario=4 Then 51
	When Aut.IdFormulario=5 Then 105 
	When Aut.IdFormulario=6 Then 106 
	When Aut.IdFormulario=31 Then 11 
	When Aut.IdFormulario=55 Then 107 
	Else 0 
 End as [IdTipoComprobante],
 Aut.TipoComprobante as [Documento],
 Aut.Numero as [Numero],
 Aut.Fecha as [Fecha],
 Case When Aut.IdFormulario=4 Then (Select Top 1 Proveedores.RazonSocial From Proveedores
					Where (Select Top 1 Pedidos.IdProveedor From Pedidos Where Aut.IdComprobante=Pedidos.IdPedido)=Proveedores.IdProveedor)
	When Aut.IdFormulario=31 Then (Select Top 1 Proveedores.RazonSocial From Proveedores
					Where (Select Top 1 cp.IdProveedor From ComprobantesProveedores cp Where Aut.IdComprobante=cp.IdComprobanteProveedor)=Proveedores.IdProveedor)
	Else Null
 End as [Proveedor],
 Case When Aut.IdFormulario=3 Then (Select Top 1 Requerimientos.MontoParaCompra From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)
	When Aut.IdFormulario=4 Then (Select Top 1 Pedidos.TotalPedido From Pedidos Where Aut.IdComprobante=Pedidos.IdPedido)
	When Aut.IdFormulario=31 Then (Select Top 1 cp.TotalComprobante From ComprobantesProveedores cp Where Aut.IdComprobante=cp.IdComprobanteProveedor)
	Else Null
 End as [Monto p/compra],
 Case When Aut.IdFormulario=1 Then (Select Top 1 Acopios.MontoPrevisto From Acopios Where Aut.IdComprobante=Acopios.IdAcopio)
	When Aut.IdFormulario=3 Then (Select Top 1 Requerimientos.MontoPrevisto From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)
	Else Null
 End as [Monto previsto],
 Aut.OrdenAutorizacion as [Orden],
 Case When Aut.IdFormulario=4 Then (Select Top 1 Monedas.Abreviatura From Monedas 
					Where (Select Top 1 Pedidos.IdMoneda From Pedidos Where Aut.IdComprobante=Pedidos.IdPedido)=Monedas.IdMoneda)
	Else Null
 End as [Moneda],
 Case When Aut.IdFormulario=1 Then (Select Top 1 Obras.NumeroObra From Obras Where (Select Acopios.IdObra From Acopios Where Aut.IdComprobante=Acopios.IdAcopio )=Obras.IdObra)
	When Aut.IdFormulario=2 Then (Select Top 1 Obras.NumeroObra From Obras Where (Select LMateriales.IdObra From LMateriales Where Aut.IdComprobante=LMateriales.IdLMateriales )=Obras.IdObra)
	When Aut.IdFormulario=3 Then (Select Top 1 Obras.NumeroObra From Obras
					Where (Select Requerimientos.IdObra From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)=Obras.IdObra)
	When Aut.IdFormulario=4 Then (Select Top 1 Obras.NumeroObra From Obras
					Where (Select Top 1 Requerimientos.IdObra From Requerimientos
						Where Requerimientos.IdRequerimiento=
							(Select Top 1 DR.IdRequerimiento 
							 From DetalleRequerimientos DR 
							 Where DR.IdDetalleRequerimiento=
								(Select Top 1 DP.IdDetalleRequerimiento
								 From DetallePedidos DP 
								 Where DP.IdPedido=Aut.IdComprobante and 
									DP.IdDetalleRequerimiento is not null)))=Obras.IdObra)
	When Aut.IdFormulario=31 Then (Select Top 1 Obras.NumeroObra From Obras Where (Select ComprobantesProveedores.IdObra From ComprobantesProveedores Where Aut.IdComprobante=ComprobantesProveedores.IdComprobanteProveedor)=Obras.IdObra)
	Else Null
 End as [Obra],
 Case When Aut.IdFormulario=3 Then ( Select Top 1 Sectores.Descripcion 
					   From Sectores 
					   Where Sectores.IdSector=(Select Top 1 Requerimientos.IdSector From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento))
	Else Null
 End as [SectorRM],
 Case When Aut.IdFormulario=3 Then (Select Top 1 CentrosCosto.Descripcion From CentrosCosto
					Where (Select Requerimientos.IdCentroCosto From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)=CentrosCosto.IdCentroCosto)
	Else Null
 End as [Centro de costo],
 Case When Aut.IdFormulario=1 Then (Select Top 1 Clientes.RazonSocial From Clientes 
					Where (Select Acopios.IdCliente From Acopios Where Aut.IdComprobante=Acopios.IdAcopio)=Clientes.IdCliente)
	When Aut.IdFormulario=2 Then (Select Top 1 Clientes.RazonSocial From Clientes
					Where (Select LMateriales.IdCliente From LMateriales Where Aut.IdComprobante=LMateriales.IdLMateriales)=Clientes.IdCliente)
	When Aut.IdFormulario=3 Then (Select Top 1 Clientes.RazonSocial From Clientes
					Where (Select Top 1 Obras.IdCliente From Obras
						Where (Select Top 1 Requerimientos.IdObra From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)=Obras.IdObra) = Clientes.IdCliente)
	Else Null
 End as [Cliente],
 Aut.IdFormulario,
 Aut.OrdenAutorizacion as [Nro.Orden],
 Case When Aut.IdFormulario=3 Then (Select Top 1 Requerimientos.IdSector From Requerimientos Where Aut.IdComprobante=Requerimientos.IdRequerimiento)
	When Aut.IdFormulario=4 Then Aut.IdSector 
	Else 0
 End as [SectorEmisor],
 Case When Aut.IdFormulario=4 Then (Select Pedidos.CotizacionMoneda From Pedidos Where Aut.IdComprobante=Pedidos.IdPedido)
	Else Null
 End as [Cotizacion],
 E1.Nombre as [Libero],
 IsNull(E2.Nombre,'_A Designar') as [Autoriza],
 Case When Aut.IdFormulario=4 Then (Select Top 1 Pedidos.TotalIva1 From Pedidos Where Aut.IdComprobante=Pedidos.IdPedido)
	Else Null
 End as [ImporteIva],
 Case When IsNull(Aut.IdAutoriza,0) = -1 Then '_A Designar' Else Sectores.Descripcion End as [Sector]
FROM _TempAutorizaciones Aut
LEFT OUTER JOIN Empleados E1 ON Aut.IdLibero=E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON Aut.IdAutoriza=E2.IdEmpleado
LEFT OUTER JOIN Sectores ON Aut.IdSector=Sectores.IdSector
WHERE Aut.IdAutoriza is not null and (@IdAutoriza=-1 or Aut.IdAutoriza=@IdAutoriza)
ORDER BY [Autoriza], [Sector], [Documento], [Numero], [Orden]

GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wComprobantesProveedores_A]
    @IdComprobanteProveedor INT OUTPUT,
    @IdProveedor INT,
    @IdTipoComprobante INT,
    @FechaComprobante DATETIME,
    @Letra VARCHAR(1),
    @NumeroComprobante1 INT,
    @NumeroComprobante2 INT,
    @NumeroReferencia INT,
    @FechaRecepcion DATETIME,
    @FechaVencimiento DATETIME,
    @TotalBruto NUMERIC(12, 2),
    @TotalIva1 NUMERIC(12, 2),
    @TotalIva2 NUMERIC(12, 2),
    @TotalBonificacion NUMERIC(12, 2),
    @TotalComprobante NUMERIC(12, 2),
    @PorcentajeBonificacion NUMERIC(6, 2),
    @Observaciones NTEXT,
    @DiasVencimiento INT,
    @IdObra INT,
    @IdProveedorEventual INT,
    @IdOrdenPago INT,
    @IdCuenta INT,
    @IdMoneda INT,
    @CotizacionMoneda NUMERIC(18, 4),
    @CotizacionDolar NUMERIC(18, 4),
    @TotalIVANoDiscriminado NUMERIC(18, 2),
    @IdCuentaIvaCompras1 INT,
    @IVAComprasPorcentaje1 NUMERIC(6, 2),
    @IVAComprasImporte1 NUMERIC(18, 2),
    @IdCuentaIvaCompras2 INT,
    @IVAComprasPorcentaje2 NUMERIC(6, 2),
    @IVAComprasImporte2 NUMERIC(18, 2),
    @IdCuentaIvaCompras3 INT,
    @IVAComprasPorcentaje3 NUMERIC(6, 2),
    @IVAComprasImporte3 NUMERIC(18, 2),
    @IdCuentaIvaCompras4 INT,
    @IVAComprasPorcentaje4 NUMERIC(6, 2),
    @IVAComprasImporte4 NUMERIC(18, 2),
    @IdCuentaIvaCompras5 INT,
    @IVAComprasPorcentaje5 NUMERIC(6, 2),
    @IVAComprasImporte5 NUMERIC(18, 2),
    @IdCuentaIvaCompras6 INT,
    @IVAComprasPorcentaje6 NUMERIC(6, 2),
    @IVAComprasImporte6 NUMERIC(18, 2),
    @IdCuentaIvaCompras7 INT,
    @IVAComprasPorcentaje7 NUMERIC(6, 2),
    @IVAComprasImporte7 NUMERIC(18, 2),
    @IdCuentaIvaCompras8 INT,
    @IVAComprasPorcentaje8 NUMERIC(6, 2),
    @IVAComprasImporte8 NUMERIC(18, 2),
    @IdCuentaIvaCompras9 INT,
    @IVAComprasPorcentaje9 NUMERIC(6, 2),
    @IVAComprasImporte9 NUMERIC(18, 2),
    @IdCuentaIvaCompras10 INT,
    @IVAComprasPorcentaje10 NUMERIC(6, 2),
    @IVAComprasImporte10 NUMERIC(18, 2),
    @SubtotalGravado NUMERIC(18, 2),
    @SubtotalExento NUMERIC(18, 2),
    @AjusteIVA NUMERIC(18, 2),
    @PorcentajeIVAAplicacionAjuste NUMERIC(6, 2),
    @BienesOServicios VARCHAR(1),
    @IdDetalleOrdenPagoRetencionIVAAplicada INT,
    @IdIBCondicion INT,
    @PRESTOFactura VARCHAR(13),
    @Confirmado VARCHAR(2),
    @IdProvinciaDestino INT,
    @IdTipoRetencionGanancia INT,
    @NumeroCAI VARCHAR(20),
    @FechaVencimientoCAI DATETIME,
    @IdCodigoAduana INT,
    @IdCodigoDestinacion INT,
    @NumeroDespacho INT,
    @DigitoVerificadorNumeroDespacho VARCHAR(1),
    @FechaDespachoAPlaza DATETIME,
    @IdUsuarioIngreso INT,
    @FechaIngreso DATETIME,
    @IdUsuarioModifico INT,
    @FechaModifico DATETIME,
    @PRESTOProveedor VARCHAR(13),
    @IdCodigoIva INT,
    @CotizacionEuro NUMERIC(18, 4),
    @IdCondicionCompra INT,
    @Importacion_FOB NUMERIC(18, 2),
    @Importacion_PosicionAduana VARCHAR(20),
    @Importacion_Despacho VARCHAR(30),
    @Importacion_Guia VARCHAR(20),
    @Importacion_IdPaisOrigen INT,
    @Importacion_FechaEmbarque DATETIME,
    @Importacion_FechaOficializacion DATETIME,
    @REP_CTAPRO_INS VARCHAR(1),
    @REP_CTAPRO_UPD VARCHAR(1),
    @InformacionAuxiliar VARCHAR(50),
    @GravadoParaSUSS NUMERIC(18, 2),
    @PorcentajeParaSUSS NUMERIC(6, 2),
    @FondoReparo NUMERIC(18, 2),
    @AutoincrementarNumeroReferencia VARCHAR(2),
    @ReintegroImporte NUMERIC(18, 2),
    @ReintegroDespacho VARCHAR(20),
    @ReintegroIdMoneda INT,
    @ReintegroIdCuenta INT,
    @PrestoDestino VARCHAR(20),
    @IdFacturaVenta_RecuperoGastos INT,
    @IdNotaCreditoVenta_RecuperoGastos INT,
    @IdComprobanteImputado INT,
    @IdCuentaOtros INT,
    @PRESTOFechaProceso DATETIME,
    @DestinoPago VARCHAR(1),
    @NumeroRendicionFF INT,
    @Cuit VARCHAR(13),
    @FechaAsignacionPresupuesto DATETIME,
    @Dolarizada VARCHAR(2),
    @NumeroOrdenPagoFondoReparo INT,
    @IdListaPrecios INT,
    @IdComprobanteProveedorOriginal INT,
    @PorcentajeIVAParaMonotributistas NUMERIC(6, 2),
    @IdDiferenciaCambio INT,
    @ConfirmadoPorWeb VARCHAR(2)
AS 
    IF ISNULL(@IdComprobanteProveedor, 0) <= 0 
        BEGIN


            BEGIN TRAN

            IF ISNULL(@AutoincrementarNumeroReferencia, 'SI') = 'SI' 
                BEGIN
                    SET @NumeroReferencia = ISNULL(( SELECT TOP 1
                                                            P.ProximoComprobanteProveedorReferencia
                                                     FROM   Parametros P
                                                     WHERE  P.IdParametro = 1
                                                   ), 1)
                    UPDATE  Parametros
                    SET     ProximoComprobanteProveedorReferencia = @NumeroReferencia
                            + 1
                END

            INSERT  INTO [ComprobantesProveedores]
                    (
                      IdProveedor,
                      IdTipoComprobante,
                      FechaComprobante,
                      Letra,
                      NumeroComprobante1,
                      NumeroComprobante2,
                      NumeroReferencia,
                      FechaRecepcion,
                      FechaVencimiento,
                      TotalBruto,
                      TotalIva1,
                      TotalIva2,
                      TotalBonificacion,
                      TotalComprobante,
                      PorcentajeBonificacion,
                      Observaciones,
                      DiasVencimiento,
                      IdObra,
                      IdProveedorEventual,
                      IdOrdenPago,
                      IdCuenta,
                      IdMoneda,
                      CotizacionMoneda,
                      CotizacionDolar,
                      TotalIVANoDiscriminado,
                      IdCuentaIvaCompras1,
                      IVAComprasPorcentaje1,
                      IVAComprasImporte1,
                      IdCuentaIvaCompras2,
                      IVAComprasPorcentaje2,
                      IVAComprasImporte2,
                      IdCuentaIvaCompras3,
                      IVAComprasPorcentaje3,
                      IVAComprasImporte3,
                      IdCuentaIvaCompras4,
                      IVAComprasPorcentaje4,
                      IVAComprasImporte4,
                      IdCuentaIvaCompras5,
                      IVAComprasPorcentaje5,
                      IVAComprasImporte5,
                      IdCuentaIvaCompras6,
                      IVAComprasPorcentaje6,
                      IVAComprasImporte6,
                      IdCuentaIvaCompras7,
                      IVAComprasPorcentaje7,
                      IVAComprasImporte7,
                      IdCuentaIvaCompras8,
                      IVAComprasPorcentaje8,
                      IVAComprasImporte8,
                      IdCuentaIvaCompras9,
                      IVAComprasPorcentaje9,
                      IVAComprasImporte9,
                      IdCuentaIvaCompras10,
                      IVAComprasPorcentaje10,
                      IVAComprasImporte10,
                      SubtotalGravado,
                      SubtotalExento,
                      AjusteIVA,
                      PorcentajeIVAAplicacionAjuste,
                      BienesOServicios,
                      IdDetalleOrdenPagoRetencionIVAAplicada,
                      IdIBCondicion,
                      PRESTOFactura,
                      Confirmado,
                      IdProvinciaDestino,
                      IdTipoRetencionGanancia,
                      NumeroCAI,
                      FechaVencimientoCAI,
                      IdCodigoAduana,
                      IdCodigoDestinacion,
                      NumeroDespacho,
                      DigitoVerificadorNumeroDespacho,
                      FechaDespachoAPlaza,
                      IdUsuarioIngreso,
                      FechaIngreso,
                      IdUsuarioModifico,
                      FechaModifico,
                      PRESTOProveedor,
                      IdCodigoIva,
                      CotizacionEuro,
                      IdCondicionCompra,
                      Importacion_FOB,
                      Importacion_PosicionAduana,
                      Importacion_Despacho,
                      Importacion_Guia,
                      Importacion_IdPaisOrigen,
                      Importacion_FechaEmbarque,
                      Importacion_FechaOficializacion,
                      REP_CTAPRO_INS,
                      REP_CTAPRO_UPD,
                      InformacionAuxiliar,
                      GravadoParaSUSS,
                      PorcentajeParaSUSS,
                      FondoReparo,
                      AutoincrementarNumeroReferencia,
                      ReintegroImporte,
                      ReintegroDespacho,
                      ReintegroIdMoneda,
                      ReintegroIdCuenta,
                      PrestoDestino,
                      IdFacturaVenta_RecuperoGastos,
                      IdNotaCreditoVenta_RecuperoGastos,
                      IdComprobanteImputado,
                      IdCuentaOtros,
                      PRESTOFechaProceso,
                      DestinoPago,
                      NumeroRendicionFF,
                      Cuit,
                      FechaAsignacionPresupuesto,
                      Dolarizada,
                      NumeroOrdenPagoFondoReparo,
                      IdListaPrecios,
                      IdComprobanteProveedorOriginal,
                      PorcentajeIVAParaMonotributistas,
                      IdDiferenciaCambio,
                      ConfirmadoPorWeb
			  )
            VALUES  (
                      @IdProveedor,
                      @IdTipoComprobante,
                      @FechaComprobante,
                      @Letra,
                      @NumeroComprobante1,
                      @NumeroComprobante2,
                      @NumeroReferencia,
                      @FechaRecepcion,
                      @FechaVencimiento,
                      @TotalBruto,
                      @TotalIva1,
                      @TotalIva2,
                      @TotalBonificacion,
                      @TotalComprobante,
                      @PorcentajeBonificacion,
                      @Observaciones,
                      @DiasVencimiento,
                      @IdObra,
                      @IdProveedorEventual,
                      @IdOrdenPago,
                      @IdCuenta,
                      @IdMoneda,
                      @CotizacionMoneda,
                      @CotizacionDolar,
                      @TotalIVANoDiscriminado,
                      @IdCuentaIvaCompras1,
                      @IVAComprasPorcentaje1,
                      @IVAComprasImporte1,
                      @IdCuentaIvaCompras2,
                      @IVAComprasPorcentaje2,
                      @IVAComprasImporte2,
                      @IdCuentaIvaCompras3,
                      @IVAComprasPorcentaje3,
                      @IVAComprasImporte3,
                      @IdCuentaIvaCompras4,
                      @IVAComprasPorcentaje4,
                      @IVAComprasImporte4,
                      @IdCuentaIvaCompras5,
                      @IVAComprasPorcentaje5,
                      @IVAComprasImporte5,
                      @IdCuentaIvaCompras6,
                      @IVAComprasPorcentaje6,
                      @IVAComprasImporte6,
                      @IdCuentaIvaCompras7,
                      @IVAComprasPorcentaje7,
                      @IVAComprasImporte7,
                      @IdCuentaIvaCompras8,
                      @IVAComprasPorcentaje8,
                      @IVAComprasImporte8,
                      @IdCuentaIvaCompras9,
                      @IVAComprasPorcentaje9,
                      @IVAComprasImporte9,
                      @IdCuentaIvaCompras10,
                      @IVAComprasPorcentaje10,
                      @IVAComprasImporte10,
                      @SubtotalGravado,
                      @SubtotalExento,
                      @AjusteIVA,
                      @PorcentajeIVAAplicacionAjuste,
                      @BienesOServicios,
                      @IdDetalleOrdenPagoRetencionIVAAplicada,
                      @IdIBCondicion,
                      @PRESTOFactura,
                      @Confirmado,
                      @IdProvinciaDestino,
                      @IdTipoRetencionGanancia,
                      @NumeroCAI,
                      @FechaVencimientoCAI,
                      @IdCodigoAduana,
                      @IdCodigoDestinacion,
                      @NumeroDespacho,
                      @DigitoVerificadorNumeroDespacho,
                      @FechaDespachoAPlaza,
                      @IdUsuarioIngreso,
                      @FechaIngreso,
                      @IdUsuarioModifico,
                      @FechaModifico,
                      @PRESTOProveedor,
                      @IdCodigoIva,
                      @CotizacionEuro,
                      @IdCondicionCompra,
                      @Importacion_FOB,
                      @Importacion_PosicionAduana,
                      @Importacion_Despacho,
                      @Importacion_Guia,
                      @Importacion_IdPaisOrigen,
                      @Importacion_FechaEmbarque,
                      @Importacion_FechaOficializacion,
                      @REP_CTAPRO_INS,
                      @REP_CTAPRO_UPD,
                      @InformacionAuxiliar,
                      @GravadoParaSUSS,
                      @PorcentajeParaSUSS,
                      @FondoReparo,
                      @AutoincrementarNumeroReferencia,
                      @ReintegroImporte,
                      @ReintegroDespacho,
                      @ReintegroIdMoneda,
                      @ReintegroIdCuenta,
                      @PrestoDestino,
                      @IdFacturaVenta_RecuperoGastos,
                      @IdNotaCreditoVenta_RecuperoGastos,
                      @IdComprobanteImputado,
                      @IdCuentaOtros,
                      @PRESTOFechaProceso,
                      @DestinoPago,
                      @NumeroRendicionFF,
                      @Cuit,
                      @FechaAsignacionPresupuesto,
                      @Dolarizada,
                      @NumeroOrdenPagoFondoReparo,
                      @IdListaPrecios,
                      @IdComprobanteProveedorOriginal,
                      @PorcentajeIVAParaMonotributistas,
                      @IdDiferenciaCambio,
                      @ConfirmadoPorWeb
			  )

            SELECT  @IdComprobanteProveedor = @@identity

            IF @@ERROR <> 0 
                GOTO AbortTransaction

            COMMIT TRAN
            GOTO EndTransaction

            AbortTransaction:
            ROLLBACK TRAN

            EndTransaction:
        END
    ELSE 
        BEGIN
            UPDATE  ComprobantesProveedores
            SET     IdProveedor = @IdProveedor,
                    IdTipoComprobante = @IdTipoComprobante,
                    FechaComprobante = @FechaComprobante,
                    Letra = @Letra,
                    NumeroComprobante1 = @NumeroComprobante1,
                    NumeroComprobante2 = @NumeroComprobante2,
                    NumeroReferencia = @NumeroReferencia,
                    FechaRecepcion = @FechaRecepcion,
                    FechaVencimiento = @FechaVencimiento,
                    TotalBruto = @TotalBruto,
                    TotalIva1 = @TotalIva1,
                    TotalIva2 = @TotalIva2,
                    TotalBonificacion = @TotalBonificacion,
                    TotalComprobante = @TotalComprobante,
                    PorcentajeBonificacion = @PorcentajeBonificacion,
                    Observaciones = @Observaciones,
                    DiasVencimiento = @DiasVencimiento,
                    IdObra = @IdObra,
                    IdProveedorEventual = @IdProveedorEventual,
                    IdOrdenPago = @IdOrdenPago,
                    IdCuenta = @IdCuenta,
                    IdMoneda = @IdMoneda,
                    CotizacionMoneda = @CotizacionMoneda,
                    CotizacionDolar = @CotizacionDolar,
                    TotalIVANoDiscriminado = @TotalIVANoDiscriminado,
                    IdCuentaIvaCompras1 = @IdCuentaIvaCompras1,
                    IVAComprasPorcentaje1 = @IVAComprasPorcentaje1,
                    IVAComprasImporte1 = @IVAComprasImporte1,
                    IdCuentaIvaCompras2 = @IdCuentaIvaCompras2,
                    IVAComprasPorcentaje2 = @IVAComprasPorcentaje2,
                    IVAComprasImporte2 = @IVAComprasImporte2,
                    IdCuentaIvaCompras3 = @IdCuentaIvaCompras3,
                    IVAComprasPorcentaje3 = @IVAComprasPorcentaje3,
                    IVAComprasImporte3 = @IVAComprasImporte3,
                    IdCuentaIvaCompras4 = @IdCuentaIvaCompras4,
                    IVAComprasPorcentaje4 = @IVAComprasPorcentaje4,
                    IVAComprasImporte4 = @IVAComprasImporte4,
                    IdCuentaIvaCompras5 = @IdCuentaIvaCompras5,
                    IVAComprasPorcentaje5 = @IVAComprasPorcentaje5,
                    IVAComprasImporte5 = @IVAComprasImporte5,
                    IdCuentaIvaCompras6 = @IdCuentaIvaCompras6,
                    IVAComprasPorcentaje6 = @IVAComprasPorcentaje6,
                    IVAComprasImporte6 = @IVAComprasImporte6,
                    IdCuentaIvaCompras7 = @IdCuentaIvaCompras7,
                    IVAComprasPorcentaje7 = @IVAComprasPorcentaje7,
                    IVAComprasImporte7 = @IVAComprasImporte7,
                    IdCuentaIvaCompras8 = @IdCuentaIvaCompras8,
                    IVAComprasPorcentaje8 = @IVAComprasPorcentaje8,
                    IVAComprasImporte8 = @IVAComprasImporte8,
                    IdCuentaIvaCompras9 = @IdCuentaIvaCompras9,
                    IVAComprasPorcentaje9 = @IVAComprasPorcentaje9,
                    IVAComprasImporte9 = @IVAComprasImporte9,
                    IdCuentaIvaCompras10 = @IdCuentaIvaCompras10,
                    IVAComprasPorcentaje10 = @IVAComprasPorcentaje10,
                    IVAComprasImporte10 = @IVAComprasImporte10,
                    SubtotalGravado = @SubtotalGravado,
                    SubtotalExento = @SubtotalExento,
                    AjusteIVA = @AjusteIVA,
                    PorcentajeIVAAplicacionAjuste = @PorcentajeIVAAplicacionAjuste,
                    BienesOServicios = @BienesOServicios,
                    IdDetalleOrdenPagoRetencionIVAAplicada = @IdDetalleOrdenPagoRetencionIVAAplicada,
                    IdIBCondicion = @IdIBCondicion,
                    PRESTOFactura = @PRESTOFactura,
                    Confirmado = @Confirmado,
                    IdProvinciaDestino = @IdProvinciaDestino,
                    IdTipoRetencionGanancia = @IdTipoRetencionGanancia,
                    NumeroCAI = @NumeroCAI,
                    FechaVencimientoCAI = @FechaVencimientoCAI,
                    IdCodigoAduana = @IdCodigoAduana,
                    IdCodigoDestinacion = @IdCodigoDestinacion,
                    NumeroDespacho = @NumeroDespacho,
                    DigitoVerificadorNumeroDespacho = @DigitoVerificadorNumeroDespacho,
                    FechaDespachoAPlaza = @FechaDespachoAPlaza,
                    IdUsuarioIngreso = @IdUsuarioIngreso,
                    FechaIngreso = @FechaIngreso,
                    IdUsuarioModifico = @IdUsuarioModifico,
                    FechaModifico = @FechaModifico,
                    PRESTOProveedor = @PRESTOProveedor,
                    IdCodigoIva = @IdCodigoIva,
                    CotizacionEuro = @CotizacionEuro,
                    IdCondicionCompra = @IdCondicionCompra,
                    Importacion_FOB = @Importacion_FOB,
                    Importacion_PosicionAduana = @Importacion_PosicionAduana,
                    Importacion_Despacho = @Importacion_Despacho,
                    Importacion_Guia = @Importacion_Guia,
                    Importacion_IdPaisOrigen = @Importacion_IdPaisOrigen,
                    Importacion_FechaEmbarque = @Importacion_FechaEmbarque,
                    Importacion_FechaOficializacion = @Importacion_FechaOficializacion,
                    InformacionAuxiliar = @InformacionAuxiliar,
                    GravadoParaSUSS = @GravadoParaSUSS,
                    PorcentajeParaSUSS = @PorcentajeParaSUSS,
                    FondoReparo = @FondoReparo,
                    ReintegroImporte = @ReintegroImporte,
                    ReintegroDespacho = @ReintegroDespacho,
                    ReintegroIdMoneda = @ReintegroIdMoneda,
                    ReintegroIdCuenta = @ReintegroIdCuenta,
                    PrestoDestino = @PrestoDestino,
                    IdFacturaVenta_RecuperoGastos = @IdFacturaVenta_RecuperoGastos,
                    IdNotaCreditoVenta_RecuperoGastos = @IdNotaCreditoVenta_RecuperoGastos,
                    IdComprobanteImputado = @IdComprobanteImputado,
                    IdCuentaOtros = @IdCuentaOtros,
                    PRESTOFechaProceso = @PRESTOFechaProceso,
                    DestinoPago = @DestinoPago,
                    NumeroRendicionFF = @NumeroRendicionFF,
                    Cuit = @Cuit,
                    FechaAsignacionPresupuesto = @FechaAsignacionPresupuesto,
                    Dolarizada = @Dolarizada,
                    NumeroOrdenPagoFondoReparo = @NumeroOrdenPagoFondoReparo,
                    IdListaPrecios = @IdListaPrecios,
                    IdComprobanteProveedorOriginal = @IdComprobanteProveedorOriginal,
                    PorcentajeIVAParaMonotributistas = @PorcentajeIVAParaMonotributistas,
                    IdDiferenciaCambio = @IdDiferenciaCambio,
                    ConfirmadoPorWeb = @ConfirmadoPorWeb
            WHERE   ( IdComprobanteProveedor = @IdComprobanteProveedor )
        END
	

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdComprobanteProveedor



GO
/****** Object:  StoredProcedure [dbo].[wBancos_TX_PosicionFinancieraAFecha]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE PROCEDURE [dbo].[wBancos_TX_PosicionFinancieraAFecha]

@FechaPosicion datetime

AS

SET NOCOUNT ON

CREATE TABLE #Auxiliar20 (IdMoneda INTEGER)
INSERT INTO #Auxiliar20 
 SELECT DISTINCT CuentasBancarias.IdMoneda FROM CuentasBancarias 
UNION ALL 
 SELECT DISTINCT Cajas.IdMoneda FROM Cajas 
UNION ALL 
 SELECT DISTINCT PlazosFijos.IdMoneda FROM PlazosFijos 

CREATE TABLE #Auxiliar21 (IdMoneda INTEGER)
CREATE NONCLUSTERED INDEX IX__Auxiliar21 ON #Auxiliar21 (IdMoneda) ON [PRIMARY]
INSERT INTO #Auxiliar21 
 SELECT IdMoneda FROM #Auxiliar20 GROUP BY IdMoneda ORDER BY IdMoneda


CREATE TABLE #Auxiliar30 
			(
			 MonedaDescripcion VARCHAR(50),
			 EntidadCodigo VARCHAR(15),
			 EntidadNombre VARCHAR(50),
			 CuentaCodigo INTEGER,
			 CuentaBancariaCuenta VARCHAR(50),
			 SaldosContableDiaAnterior NUMERIC(18, 2),
			 IngresosDelDia NUMERIC(18, 2),
			 EgresosDelDia NUMERIC(18, 2),
			 ChequesPosdatadosAnt NUMERIC(18, 2),
			 ChequesPosdatadosDia NUMERIC(18, 2),
			 TransferenciasEntreCuentasPropiasDelDia NUMERIC(18, 2),
			 AportesDelDia NUMERIC(18, 2),
			 GastosBancariosDelDia NUMERIC(18, 2),
			 SaldosContableAFecha NUMERIC(18, 2),
			 SaldosTotal NUMERIC(18, 2)
			)

CREATE TABLE #Auxiliar31 
			(
			 IdCuentaBancaria INTEGER,
			 CuentaBancariaDetalle VARCHAR(50),
			 CuentaBancariaCuenta VARCHAR(50),
			 BancoNombre VARCHAR(50),
			 MonedaDescripcion VARCHAR(50),
			 ProvinciaNombre VARCHAR(50),
			 CuentaCodigo INTEGER,
			 DepositosPendientes NUMERIC(18, 2),
			 TransferenciasEntreCuentasPropiasPendientes NUMERIC(18, 2),
			 ChequesPropiosAFecha NUMERIC(18, 2),
			 ChequesPropiosHastaViernesProximo NUMERIC(18, 2),
			 ChequesPropiosPosterioresAlViernesProximo NUMERIC(18, 2),
			 SaldosContableAFecha NUMERIC(18, 2),
			 DepositosDelDia NUMERIC(18, 2),
			 ChequesPropiosDelDia NUMERIC(18, 2),
			 GastosBancariosDelDia NUMERIC(18, 2),
			 TransferenciasEntreCuentasPropiasDelDia NUMERIC(18, 2),
			 AportesDelDia NUMERIC(18, 2),
			 ChequesPosdatadosAnt NUMERIC(18, 2),
			 ChequesPosdatadosDia NUMERIC(18, 2),
			 SaldosContableDiaAnterior NUMERIC(18, 2)
			)

CREATE TABLE #Auxiliar32 
			(
			 IdCaja INTEGER,
			 IdCuenta INTEGER,
			 CajaNombre VARCHAR(50),
			 MonedaDescripcion VARCHAR(50),
			 CuentaCodigo INTEGER,
			 Saldo NUMERIC(18, 2),
			 SaldosAnterior NUMERIC(18, 2)
			)
CREATE NONCLUSTERED INDEX IX__Auxiliar32 ON #Auxiliar32 (IdCaja) ON [PRIMARY]

CREATE TABLE #Auxiliar33 
			(
			 IdPlazoFijo INTEGER,
			 BancoNombre VARCHAR(50),
			 NumeroCertificado1 INTEGER,
			 DireccionEmisionYPago VARCHAR(50),
			 Titulares VARCHAR(50),
			 CodigoDeposito INTEGER,
			 CodigoClase INTEGER,
			 PlazoEnDias INTEGER,
			 TasaNominalAnual NUMERIC(18, 3),
			 Importe NUMERIC(18, 2),
			 TasaEfectivaMensual NUMERIC(18, 3),
			 FechaVencimiento DATETIME,
			 ImporteIntereses NUMERIC(18, 2),
			 RetencionGanancia NUMERIC(18, 2),
			 Orden VARCHAR(50),
			 Detalle VARCHAR(50),
			 IdPlazoFijoOrigen INTEGER,
			 FechaInicioPlazoFijo DATETIME,
			 MonedaDescripcion VARCHAR(50),
			 CotizacionMonedaAlInicio NUMERIC(18, 4),
			 CotizacionMonedaAlFinal NUMERIC(18, 4),
			 Finalizado VARCHAR(2)
			)

CREATE TABLE #Auxiliar34 
			(
			 Debe1 NUMERIC(18, 2),
			 Haber1 NUMERIC(18, 2),
			 Saldo1 NUMERIC(18, 2),
			 Debe2 NUMERIC(18, 2),
			 Haber2 NUMERIC(18, 2),
			 Saldo2 NUMERIC(18, 2)
			)

DECLARE @IdMoneda int, @Moneda varchar(50), @IdCaja int, @IdCuenta int, @CajaNombre varchar(50), @MonedaDescripcion varchar(50), @CuentaCodigo int, 
		@Saldo numeric(18,2), @SaldosAnterior numeric(18,2), @IngresoDia numeric(18,2), @EgresoDia numeric(18,2), @SaldoFinal numeric(18,2), @IdCuentaValores int

SET @IdCuentaValores=IsNull((Select Top 1 IdCuentaValores From Parametros Where IdParametro=1),0)

DECLARE Cur CURSOR LOCAL FORWARD_ONLY FOR SELECT IdMoneda FROM #Auxiliar21 ORDER BY IdMoneda
OPEN Cur
FETCH NEXT FROM Cur INTO @IdMoneda
WHILE @@FETCH_STATUS = 0
  BEGIN
	SET @Moneda=IsNull((Select Top 1 Nombre From Monedas Where IdMoneda=@IdMoneda),'')

	TRUNCATE TABLE #Auxiliar31
	INSERT INTO #Auxiliar31 EXEC Bancos_TX_PosicionFinancieraAFecha @FechaPosicion, 0, @IdMoneda

	TRUNCATE TABLE #Auxiliar32
	INSERT INTO #Auxiliar32 EXEC Cajas_TX_PosicionFinancieraAFecha @FechaPosicion, @IdMoneda, 'SI'

	TRUNCATE TABLE #Auxiliar33
	INSERT INTO #Auxiliar33 EXEC PlazosFijos_TX_ParaPosicionFinancieraAFecha @FechaPosicion, @IdMoneda

	INSERT INTO #Auxiliar30 
	 SELECT MonedaDescripcion, 'BANCOS', BancoNombre, CuentaCodigo, CuentaBancariaCuenta, SaldosContableDiaAnterior, DepositosDelDia, ChequesPropiosDelDia, 
			ChequesPosdatadosAnt, ChequesPosdatadosDia, TransferenciasEntreCuentasPropiasDelDia, AportesDelDia, GastosBancariosDelDia, SaldosContableAFecha, 0
	 FROM #Auxiliar31

	DECLARE Cur1 CURSOR LOCAL FORWARD_ONLY FOR SELECT IdCaja, IdCuenta, CajaNombre, MonedaDescripcion, CuentaCodigo, Saldo, SaldosAnterior FROM #Auxiliar32 ORDER BY IdCaja
	OPEN Cur1
	FETCH NEXT FROM Cur1 INTO @IdCaja, @IdCuenta, @CajaNombre, @MonedaDescripcion, @CuentaCodigo, @Saldo, @SaldosAnterior
	WHILE @@FETCH_STATUS = 0
	  BEGIN
		IF @IdCaja>0
		  BEGIN
			TRUNCATE TABLE #Auxiliar34
			INSERT INTO #Auxiliar34 EXEC Cajas_TX_PosicionFinancieraAFechaPorIdCaja @IdCaja, @FechaPosicion
			SET @IngresoDia=IsNull((Select Top 1 IsNull(Debe2,0) From #Auxiliar34),0)
			SET @EgresoDia=IsNull((Select Top 1 IsNull(Haber2,0) From #Auxiliar34),0)
			SET @SaldoFinal=@Saldo
		  END
		IF @IdCaja<0
		  BEGIN
			TRUNCATE TABLE #Auxiliar34
			INSERT INTO #Auxiliar34 EXEC Cuentas_TX_MayorPorIdCuentaEntreFechas @IdCuenta, @FechaPosicion, @FechaPosicion
			SET @IngresoDia=IsNull((Select Top 1 IsNull(Debe1,0) From #Auxiliar34),0)
			SET @EgresoDia=IsNull((Select Top 1 IsNull(Haber1,0) From #Auxiliar34),0)
			SET @SaldoFinal=IsNull((Select Top 1 IsNull(Saldo1,0)+IsNull(Saldo2,0) From #Auxiliar34),0)
		  END
		IF @IdCaja=0
		  BEGIN
			TRUNCATE TABLE #Auxiliar34
			INSERT INTO #Auxiliar34 EXEC Cuentas_TX_MayorPorIdCuentaEntreFechas @IdCuentaValores, @FechaPosicion, @FechaPosicion
			SET @IngresoDia=IsNull((Select Top 1 IsNull(Debe1,0) From #Auxiliar34),0)
			SET @EgresoDia=IsNull((Select Top 1 IsNull(Haber1,0) From #Auxiliar34),0)
			SET @SaldoFinal=IsNull((Select Top 1 IsNull(Saldo1,0)+IsNull(Saldo2,0) From #Auxiliar34),0)
		  END

		INSERT INTO #Auxiliar30 
		(MonedaDescripcion, EntidadCodigo, EntidadNombre, CuentaCodigo, SaldosContableDiaAnterior, IngresosDelDia, EgresosDelDia, SaldosContableAFecha)
		VALUES
		(@MonedaDescripcion, 'CAJAS', @CajaNombre, @CuentaCodigo, @SaldosAnterior, @IngresoDia, @EgresoDia, @SaldoFinal)

		FETCH NEXT FROM Cur1 INTO @IdCaja, @IdCuenta, @CajaNombre, @MonedaDescripcion, @CuentaCodigo, @Saldo, @SaldosAnterior
	  END
	CLOSE Cur1
	DEALLOCATE Cur1

	INSERT INTO #Auxiliar30 
	 SELECT MonedaDescripcion, 'INVERSIONES', BancoNombre, Null, Convert(varchar,NumeroCertificado1), IsNull(Importe,0)+IsNull(ImporteIntereses,0)-IsNull(RetencionGanancia,0), 
			Null, Null, Null, Null, Null, Null, Null, IsNull(Importe,0)+IsNull(ImporteIntereses,0)-IsNull(RetencionGanancia,0), 0
	 FROM #Auxiliar33

	FETCH NEXT FROM Cur INTO @IdMoneda
  END
CLOSE Cur
DEALLOCATE Cur

UPDATE #Auxiliar30
SET SaldosTotal=IsNull(SaldosContableDiaAnterior,0)+IsNull(IngresosDelDia,0)+IsNull(EgresosDelDia,0)+IsNull(ChequesPosdatadosDia,0)+
				IsNull(TransferenciasEntreCuentasPropiasDelDia,0)+IsNull(AportesDelDia,0)+IsNull(GastosBancariosDelDia,0)

SET NOCOUNT OFF

SELECT * FROM #Auxiliar30

DROP TABLE #Auxiliar20
DROP TABLE #Auxiliar21
DROP TABLE #Auxiliar30
DROP TABLE #Auxiliar31
DROP TABLE #Auxiliar32
DROP TABLE #Auxiliar33
DROP TABLE #Auxiliar34

GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wComprobantesProveedores_T]
    @IdComprobanteProveedor INT = NULL
AS 
    SET @IdComprobanteProveedor = ISNULL(@IdComprobanteProveedor, -1)

    SELECT  Cab.*,
/*
Substring(Cab.Letra+'-'+Substring('0000',1,4-Len(Convert(varchar,Cab.NumeroComprobante1)))+
	Convert(varchar,Cab.NumeroComprobante1)+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,Cab.NumeroComprobante2)))+
	Convert(varchar,Cab.NumeroComprobante2),1,20) as [Numero],
*/          Cuentas.Descripcion AS [Cuenta],
            Proveedores.RazonSocial AS [Proveedor],
            ProveedoresEventual.RazonSocial AS [ProveedorEventual]
    FROM    ComprobantesProveedores Cab --LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento=DetReq.IdRequerimiento
--LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Cuentas ON Cab.IdCuenta = Cuentas.IdCuenta
--LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
--LEFT OUTER JOIN Obras ON Cab.IdObra = Obras.IdObra
--LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
--LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
--LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
--LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
--LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
--LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
--LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
            LEFT OUTER JOIN Proveedores ON Cab.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Proveedores ProveedoresEventual ON Cab.IdProveedorEventual = ProveedoresEventual.IdProveedor
    WHERE   ( @IdComprobanteProveedor = -1
              OR ( IdComprobanteProveedor = @IdComprobanteProveedor )
            )
    ORDER BY IdComprobanteProveedor DESC


GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_FondosFijos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wComprobantesProveedores_TX_FondosFijos] @IdObra INT = NULL
AS 
    SET @IdObra = ISNULL(@IdObra, -1)

    SELECT  Cab.*,
/*
Substring(Cab.Letra+'-'+Substring('0000',1,4-Len(Convert(varchar,Cab.NumeroComprobante1)))+
	Convert(varchar,Cab.NumeroComprobante1)+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,Cab.NumeroComprobante2)))+
	Convert(varchar,Cab.NumeroComprobante2),1,20) as [Numero],
*/          Cuentas.Descripcion AS [Cuenta],
            Proveedores.RazonSocial AS [Proveedor],
            ProveedoresEventual.RazonSocial AS [ProveedorEventual]
    FROM    ComprobantesProveedores Cab --LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento=DetReq.IdRequerimiento
--LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Cuentas ON Cab.IdCuenta = Cuentas.IdCuenta
--LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
--LEFT OUTER JOIN Obras ON Cab.IdObra = Obras.IdObra
--LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
--LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
--LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
--LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
--LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
--LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
--LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
            LEFT OUTER JOIN Proveedores ON Cab.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Proveedores ProveedoresEventual ON Cab.IdProveedorEventual = ProveedoresEventual.IdProveedor
    WHERE   ( Cab.IdProveedor IS NULL
              AND Cab.IdCuenta IS NOT NULL
            )
            AND ( @IdObra = -1
                  OR @IdObra = Cab.IdObra
                )
		-- and Cab.Confirmado is not null and Cab.Confirmado='NO'   -- Ahora lo filtro en la lista que
																	-- devuelve el manager del BO. 
    ORDER BY IdComprobanteProveedor DESC


GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wComprobantesProveedores_E]
    @IdComprobanteProveedor INT
AS 
    DELETE  ComprobantesProveedores
    WHERE   ( IdComprobanteProveedor = @IdComprobanteProveedor )



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetComprobantesProveedores_A]
    @IdDetalleComprobanteProveedor INT OUTPUT,
    @IdComprobanteProveedor INT,
    @IdArticulo INT,
    @CodigoArticulo VARCHAR(8),
    @IdCuenta INT,
    @CodigoCuenta VARCHAR(10),
    @PorcentajeIvaAplicado NUMERIC(6, 2),
    @Importe NUMERIC(12, 2),
    @IdCuentaGasto INT,
    @IdCuentaIvaCompras1 INT,
    @IVAComprasPorcentaje1 NUMERIC(6, 2),
    @ImporteIVA1 NUMERIC(18, 2),
    @AplicarIVA1 VARCHAR(2),
    @IdCuentaIvaCompras2 INT,
    @IVAComprasPorcentaje2 NUMERIC(6, 2),
    @ImporteIVA2 NUMERIC(18, 2),
    @AplicarIVA2 VARCHAR(2),
    @IdCuentaIvaCompras3 INT,
    @IVAComprasPorcentaje3 NUMERIC(6, 2),
    @ImporteIVA3 NUMERIC(18, 2),
    @AplicarIVA3 VARCHAR(2),
    @IdCuentaIvaCompras4 INT,
    @IVAComprasPorcentaje4 NUMERIC(6, 2),
    @ImporteIVA4 NUMERIC(18, 2),
    @AplicarIVA4 VARCHAR(2),
    @IdCuentaIvaCompras5 INT,
    @IVAComprasPorcentaje5 NUMERIC(6, 2),
    @ImporteIVA5 NUMERIC(18, 2),
    @AplicarIVA5 VARCHAR(2),
    @IdObra INT,
    @Item INT,
    @IdCuentaIvaCompras6 INT,
    @IVAComprasPorcentaje6 NUMERIC(6, 2),
    @ImporteIVA6 NUMERIC(18, 2),
    @AplicarIVA6 VARCHAR(2),
    @IdCuentaIvaCompras7 INT,
    @IVAComprasPorcentaje7 NUMERIC(6, 2),
    @ImporteIVA7 NUMERIC(18, 2),
    @AplicarIVA7 VARCHAR(2),
    @IdCuentaIvaCompras8 INT,
    @IVAComprasPorcentaje8 NUMERIC(6, 2),
    @ImporteIVA8 NUMERIC(18, 2),
    @AplicarIVA8 VARCHAR(2),
    @IdCuentaIvaCompras9 INT,
    @IVAComprasPorcentaje9 NUMERIC(6, 2),
    @ImporteIVA9 NUMERIC(18, 2),
    @AplicarIVA9 VARCHAR(2),
    @IdCuentaIvaCompras10 INT,
    @IVAComprasPorcentaje10 NUMERIC(6, 2),
    @ImporteIVA10 NUMERIC(18, 2),
    @AplicarIVA10 VARCHAR(2),
    @IVAComprasPorcentajeDirecto NUMERIC(6, 2),
    @IdCuentaBancaria INT,
    @PRESTOConcepto VARCHAR(13),
    @PRESTOObra VARCHAR(13),
    @IdDetalleRecepcion INT,
    @TomarEnCalculoDeImpuestos VARCHAR(2),
    @IdRubroContable INT,
    @IdPedido INT,
    @IdDetallePedido INT,
    @Importacion_FOB NUMERIC(18, 2),
    @Importacion_PosicionAduana VARCHAR(20),
    @Importacion_Despacho VARCHAR(30),
    @Importacion_Guia VARCHAR(20),
    @Importacion_IdPaisOrigen INT,
    @Importacion_FechaEmbarque DATETIME,
    @Importacion_FechaOficializacion DATETIME,
    @IdProvinciaDestino1 INT,
    @PorcentajeProvinciaDestino1 NUMERIC(6, 2),
    @IdProvinciaDestino2 INT,
    @PorcentajeProvinciaDestino2 NUMERIC(6, 2),
    @IdDistribucionObra INT,
    @Cantidad NUMERIC(18, 2),
    @IdDetalleObraDestino INT,
    @IdPresupuestoObraRubro INT,
    @IdPedidoAnticipo INT,
    @PorcentajeAnticipo NUMERIC(6, 2),
    @PorcentajeCertificacion NUMERIC(6, 2),
    @IdPresupuestoObrasNodo INT,
    @IdDetalleComprobanteProveedorOriginal INT
AS 
    IF ISNULL(@IdDetalleComprobanteProveedor, 0) <= 0 
        BEGIN




            IF @IdDetalleRecepcion IS NULL
                AND @IdDetallePedido IS NOT NULL 
                BEGIN
                    DECLARE @Letra VARCHAR(1),
                        @NumeroComprobante1 INT,
                        @NumeroComprobante2 INT
                    SET @Letra = ISNULL(( SELECT TOP 1
                                                    Letra
                                          FROM      ComprobantesProveedores
                                          WHERE     IdComprobanteProveedor = @IdComprobanteProveedor
                                        ), '')
                    SET @NumeroComprobante1 = ISNULL(( SELECT TOP 1
                                                                NumeroComprobante1
                                                       FROM     ComprobantesProveedores
                                                       WHERE    IdComprobanteProveedor = @IdComprobanteProveedor
                                                     ), 0)
                    SET @NumeroComprobante2 = ISNULL(( SELECT TOP 1
                                                                NumeroComprobante2
                                                       FROM     ComprobantesProveedores
                                                       WHERE    IdComprobanteProveedor = @IdComprobanteProveedor
                                                     ), 0)

                    DECLARE @DesactivarDarPorCumplidoPedidoSinRecepcionEnCP VARCHAR(2)
                    SET @DesactivarDarPorCumplidoPedidoSinRecepcionEnCP = ISNULL(( SELECT TOP 1
                                                                                            P2.Valor
                                                                                   FROM     Parametros2 P2
                                                                                   WHERE    P2.Campo = 'DesactivarDarPorCumplidoPedidoSinRecepcionEnCP'
                                                                                 ), 'NO')
                    IF @DesactivarDarPorCumplidoPedidoSinRecepcionEnCP = 'NO' 
                        BEGIN
                            UPDATE  DetallePedidos
                            SET     Cumplido = 'SI',
                                    IdDioPorCumplido = 0,
                                    FechaDadoPorCumplido = GETDATE(),
                                    ObservacionesCumplido = 'Comprobante proveedor '
                                    + @Letra + '-' + SUBSTRING('0000', 1, 4 - LEN(CONVERT(VARCHAR, @NumeroComprobante1)))
                                    + CONVERT(VARCHAR, @NumeroComprobante1)
                                    + '-' + SUBSTRING('00000000', 1,
                                                      8
                                                      - LEN(CONVERT(VARCHAR, @NumeroComprobante2)))
                                    + CONVERT(VARCHAR, @NumeroComprobante2)
                            WHERE   IdDetallePedido = @IdDetallePedido
                                    AND ISNULL(Cumplido, 'NO') <> 'AN'
                                    AND ISNULL(Cumplido, 'NO') <> 'SI' 
				
                            EXEC Pedidos_ActualizarEstadoPorIdPedido @IdPedido
                        END
                END



            IF @IdArticulo IS NOT NULL 
                BEGIN
                    DECLARE @FechaComprobante DATETIME,
                        @FechaUltimoCostoReposicion DATETIME,
                        @CotizacionMoneda NUMERIC(18, 4),
                        @CotizacionDolar NUMERIC(18, 4),
                        @CostoReposicion NUMERIC(18, 2),
                        @CostoReposicionDolar NUMERIC(18, 2),
                        @IdMonedaRecepcion INT,
                        @IdMonedaComprobante INT

                    SET @FechaComprobante = ISNULL(( SELECT TOP 1
                                                            FechaComprobante
                                                     FROM   ComprobantesProveedores
                                                     WHERE  IdComprobanteProveedor = @IdComprobanteProveedor
                                                   ),
                                                   CONVERT(DATETIME, '01/01/2000'))
                    SET @CotizacionMoneda = ISNULL(( SELECT TOP 1
                                                            CotizacionMoneda
                                                     FROM   ComprobantesProveedores
                                                     WHERE  IdComprobanteProveedor = @IdComprobanteProveedor
                                                   ), 1)
                    SET @CotizacionDolar = ISNULL(( SELECT TOP 1
                                                            CotizacionDolar
                                                    FROM    ComprobantesProveedores
                                                    WHERE   IdComprobanteProveedor = @IdComprobanteProveedor
                                                  ), 1)
                    SET @IdMonedaComprobante = ISNULL(( SELECT TOP 1
                                                                IdMoneda
                                                        FROM    ComprobantesProveedores
                                                        WHERE   IdComprobanteProveedor = @IdComprobanteProveedor
                                                      ), 1)
                    SET @IdMonedaRecepcion = ISNULL(( SELECT TOP 1
                                                                IdMoneda
                                                      FROM      DetalleRecepciones
                                                      WHERE     DetalleRecepciones.IdDetalleRecepcion = @IdDetalleRecepcion
                                                    ), 1)
                    SET @CostoReposicion = 0
                    SET @CostoReposicionDolar = 0

                    IF ISNULL(@Cantidad, 0) <> 0 
                        SET @CostoReposicion = ROUND(@Importe / @Cantidad
                                                     * @CotizacionMoneda, 2)
			

                    IF ISNULL(@Cantidad, 0) <> 0
                        AND @CotizacionDolar <> 0 
                        SET @CostoReposicionDolar = ROUND(@Importe / @Cantidad
                                                          * @CotizacionMoneda
                                                          / @CotizacionDolar,
                                                          2)
			

                    SET @FechaUltimoCostoReposicion = ISNULL(( SELECT TOP 1
                                                                        Articulos.FechaUltimoCostoReposicion
                                                               FROM     Articulos
                                                               WHERE    Articulos.IdArticulo = @IdArticulo
                                                             ),
                                                             CONVERT(DATETIME, '01/01/2000'))


                    IF @FechaComprobante >= @FechaUltimoCostoReposicion
                        AND @CostoReposicion <> 0
                        AND @CostoReposicionDolar <> 0 
                        UPDATE  Articulos
                        SET     CostoReposicion = @CostoReposicion,
                                CostoReposicionDolar = @CostoReposicionDolar,
                                FechaUltimoCostoReposicion = @FechaComprobante
                        WHERE   Articulos.IdArticulo = @IdArticulo


                    IF ISNULL(@IdDetalleRecepcion, 0) <> 0
                        AND @CotizacionMoneda <> 0
                        AND @IdMonedaComprobante = @IdMonedaRecepcion 
                        UPDATE  DetalleRecepciones
                        SET     CostoUnitario = @CostoReposicion
                                / @CotizacionMoneda
                        WHERE   DetalleRecepciones.IdDetalleRecepcion = @IdDetalleRecepcion
		
                END





            INSERT  INTO [DetalleComprobantesProveedores]
                    (
                      IdComprobanteProveedor,
                      IdArticulo,
                      CodigoArticulo,
                      IdCuenta,
                      CodigoCuenta,
                      PorcentajeIvaAplicado,
                      Importe,
                      IdCuentaGasto,
                      IdCuentaIvaCompras1,
                      IVAComprasPorcentaje1,
                      ImporteIVA1,
                      AplicarIVA1,
                      IdCuentaIvaCompras2,
                      IVAComprasPorcentaje2,
                      ImporteIVA2,
                      AplicarIVA2,
                      IdCuentaIvaCompras3,
                      IVAComprasPorcentaje3,
                      ImporteIVA3,
                      AplicarIVA3,
                      IdCuentaIvaCompras4,
                      IVAComprasPorcentaje4,
                      ImporteIVA4,
                      AplicarIVA4,
                      IdCuentaIvaCompras5,
                      IVAComprasPorcentaje5,
                      ImporteIVA5,
                      AplicarIVA5,
                      IdObra,
                      Item,
                      IdCuentaIvaCompras6,
                      IVAComprasPorcentaje6,
                      ImporteIVA6,
                      AplicarIVA6,
                      IdCuentaIvaCompras7,
                      IVAComprasPorcentaje7,
                      ImporteIVA7,
                      AplicarIVA7,
                      IdCuentaIvaCompras8,
                      IVAComprasPorcentaje8,
                      ImporteIVA8,
                      AplicarIVA8,
                      IdCuentaIvaCompras9,
                      IVAComprasPorcentaje9,
                      ImporteIVA9,
                      AplicarIVA9,
                      IdCuentaIvaCompras10,
                      IVAComprasPorcentaje10,
                      ImporteIVA10,
                      AplicarIVA10,
                      IVAComprasPorcentajeDirecto,
                      IdCuentaBancaria,
                      PRESTOConcepto,
                      PRESTOObra,
                      IdDetalleRecepcion,
                      TomarEnCalculoDeImpuestos,
                      IdRubroContable,
                      IdPedido,
                      IdDetallePedido,
                      Importacion_FOB,
                      Importacion_PosicionAduana,
                      Importacion_Despacho,
                      Importacion_Guia,
                      Importacion_IdPaisOrigen,
                      Importacion_FechaEmbarque,
                      Importacion_FechaOficializacion,
                      IdProvinciaDestino1,
                      PorcentajeProvinciaDestino1,
                      IdProvinciaDestino2,
                      PorcentajeProvinciaDestino2,
                      IdDistribucionObra,
                      Cantidad,
                      IdDetalleObraDestino,
                      IdPresupuestoObraRubro,
                      IdPedidoAnticipo,
                      PorcentajeAnticipo,
                      PorcentajeCertificacion,
                      IdPresupuestoObrasNodo,
                      IdDetalleComprobanteProveedorOriginal
		        )
            VALUES  (
                      @IdComprobanteProveedor,
                      @IdArticulo,
                      @CodigoArticulo,
                      @IdCuenta,
                      @CodigoCuenta,
                      @PorcentajeIvaAplicado,
                      @Importe,
                      @IdCuentaGasto,
                      @IdCuentaIvaCompras1,
                      @IVAComprasPorcentaje1,
                      @ImporteIVA1,
                      @AplicarIVA1,
                      @IdCuentaIvaCompras2,
                      @IVAComprasPorcentaje2,
                      @ImporteIVA2,
                      @AplicarIVA2,
                      @IdCuentaIvaCompras3,
                      @IVAComprasPorcentaje3,
                      @ImporteIVA3,
                      @AplicarIVA3,
                      @IdCuentaIvaCompras4,
                      @IVAComprasPorcentaje4,
                      @ImporteIVA4,
                      @AplicarIVA4,
                      @IdCuentaIvaCompras5,
                      @IVAComprasPorcentaje5,
                      @ImporteIVA5,
                      @AplicarIVA5,
                      @IdObra,
                      @Item,
                      @IdCuentaIvaCompras6,
                      @IVAComprasPorcentaje6,
                      @ImporteIVA6,
                      @AplicarIVA6,
                      @IdCuentaIvaCompras7,
                      @IVAComprasPorcentaje7,
                      @ImporteIVA7,
                      @AplicarIVA7,
                      @IdCuentaIvaCompras8,
                      @IVAComprasPorcentaje8,
                      @ImporteIVA8,
                      @AplicarIVA8,
                      @IdCuentaIvaCompras9,
                      @IVAComprasPorcentaje9,
                      @ImporteIVA9,
                      @AplicarIVA9,
                      @IdCuentaIvaCompras10,
                      @IVAComprasPorcentaje10,
                      @ImporteIVA10,
                      @AplicarIVA10,
                      @IVAComprasPorcentajeDirecto,
                      @IdCuentaBancaria,
                      @PRESTOConcepto,
                      @PRESTOObra,
                      @IdDetalleRecepcion,
                      @TomarEnCalculoDeImpuestos,
                      @IdRubroContable,
                      @IdPedido,
                      @IdDetallePedido,
                      @Importacion_FOB,
                      @Importacion_PosicionAduana,
                      @Importacion_Despacho,
                      @Importacion_Guia,
                      @Importacion_IdPaisOrigen,
                      @Importacion_FechaEmbarque,
                      @Importacion_FechaOficializacion,
                      @IdProvinciaDestino1,
                      @PorcentajeProvinciaDestino1,
                      @IdProvinciaDestino2,
                      @PorcentajeProvinciaDestino2,
                      @IdDistribucionObra,
                      @Cantidad,
                      @IdDetalleObraDestino,
                      @IdPresupuestoObraRubro,
                      @IdPedidoAnticipo,
                      @PorcentajeAnticipo,
                      @PorcentajeCertificacion,
                      @IdPresupuestoObrasNodo,
                      @IdDetalleComprobanteProveedorOriginal
		        )


            SELECT  @IdDetalleComprobanteProveedor = @@identity

        END	
    ELSE 
        BEGIN

            IF @IdDetalleRecepcion IS NULL
                AND @IdDetallePedido IS NOT NULL 
                BEGIN
                    SET @Letra = ISNULL(( SELECT TOP 1
                                                    Letra
                                          FROM      ComprobantesProveedores
                                          WHERE     IdComprobanteProveedor = @IdComprobanteProveedor
                                        ), '')
                    SET @NumeroComprobante1 = ISNULL(( SELECT TOP 1
                                                                NumeroComprobante1
                                                       FROM     ComprobantesProveedores
                                                       WHERE    IdComprobanteProveedor = @IdComprobanteProveedor
                                                     ), 0)
                    SET @NumeroComprobante2 = ISNULL(( SELECT TOP 1
                                                                NumeroComprobante2
                                                       FROM     ComprobantesProveedores
                                                       WHERE    IdComprobanteProveedor = @IdComprobanteProveedor
                                                     ), 0)

                    SET @DesactivarDarPorCumplidoPedidoSinRecepcionEnCP = ISNULL(( SELECT TOP 1
                                                                                            P2.Valor
                                                                                   FROM     Parametros2 P2
                                                                                   WHERE    P2.Campo = 'DesactivarDarPorCumplidoPedidoSinRecepcionEnCP'
                                                                                 ), 'NO')
                    IF @DesactivarDarPorCumplidoPedidoSinRecepcionEnCP = 'NO' 
                        BEGIN
                            UPDATE  DetallePedidos
                            SET     Cumplido = 'SI',
                                    IdDioPorCumplido = 0,
                                    FechaDadoPorCumplido = GETDATE(),
                                    ObservacionesCumplido = 'Comprobante proveedor '
                                    + @Letra + '-' + SUBSTRING('0000', 1, 4 - LEN(CONVERT(VARCHAR, @NumeroComprobante1)))
                                    + CONVERT(VARCHAR, @NumeroComprobante1)
                                    + '-' + SUBSTRING('00000000', 1,
                                                      8
                                                      - LEN(CONVERT(VARCHAR, @NumeroComprobante2)))
                                    + CONVERT(VARCHAR, @NumeroComprobante2)
                            WHERE   IdDetallePedido = @IdDetallePedido
                                    AND ISNULL(Cumplido, 'NO') <> 'AN'
                                    AND ISNULL(Cumplido, 'NO') <> 'SI' 
				
                            EXEC Pedidos_ActualizarEstadoPorIdPedido @IdPedido
                        END
                END

            IF @IdArticulo IS NOT NULL 
                BEGIN
                    SET @FechaComprobante = ISNULL(( SELECT TOP 1
                                                            FechaComprobante
                                                     FROM   ComprobantesProveedores
                                                     WHERE  IdComprobanteProveedor = @IdComprobanteProveedor
                                                   ),
                                                   CONVERT(DATETIME, '01/01/2000'))
                    SET @CotizacionMoneda = ISNULL(( SELECT TOP 1
                                                            CotizacionMoneda
                                                     FROM   ComprobantesProveedores
                                                     WHERE  IdComprobanteProveedor = @IdComprobanteProveedor
                                                   ), 1)
                    SET @CotizacionDolar = ISNULL(( SELECT TOP 1
                                                            CotizacionDolar
                                                    FROM    ComprobantesProveedores
                                                    WHERE   IdComprobanteProveedor = @IdComprobanteProveedor
                                                  ), 1)
                    SET @IdMonedaComprobante = ISNULL(( SELECT TOP 1
                                                                IdMoneda
                                                        FROM    ComprobantesProveedores
                                                        WHERE   IdComprobanteProveedor = @IdComprobanteProveedor
                                                      ), 1)
                    SET @IdMonedaRecepcion = ISNULL(( SELECT TOP 1
                                                                IdMoneda
                                                      FROM      DetalleRecepciones
                                                      WHERE     DetalleRecepciones.IdDetalleRecepcion = @IdDetalleRecepcion
                                                    ), 1)
                    SET @CostoReposicion = 0
                    SET @CostoReposicionDolar = 0
                    IF ISNULL(@Cantidad, 0) <> 0 
                        SET @CostoReposicion = ROUND(@Importe / @Cantidad
                                                     * @CotizacionMoneda, 2)
                    IF ISNULL(@Cantidad, 0) <> 0
                        AND @CotizacionDolar <> 0 
                        SET @CostoReposicionDolar = ROUND(@Importe / @Cantidad
                                                          * @CotizacionMoneda
                                                          / @CotizacionDolar,
                                                          2)
                    SET @FechaUltimoCostoReposicion = ISNULL(( SELECT TOP 1
                                                                        Articulos.FechaUltimoCostoReposicion
                                                               FROM     Articulos
                                                               WHERE    Articulos.IdArticulo = @IdArticulo
                                                             ),
                                                             CONVERT(DATETIME, '01/01/2000'))
                    IF @FechaComprobante >= @FechaUltimoCostoReposicion
                        AND @CostoReposicion <> 0
                        AND @CostoReposicionDolar <> 0 
                        UPDATE  Articulos
                        SET     CostoReposicion = @CostoReposicion,
                                CostoReposicionDolar = @CostoReposicionDolar,
                                FechaUltimoCostoReposicion = @FechaComprobante
                        WHERE   Articulos.IdArticulo = @IdArticulo

                    IF ISNULL(@IdDetalleRecepcion, 0) <> 0
                        AND @CotizacionMoneda <> 0
                        AND @IdMonedaComprobante = @IdMonedaRecepcion 
                        UPDATE  DetalleRecepciones
                        SET     CostoUnitario = @CostoReposicion
                                / @CotizacionMoneda
                        WHERE   DetalleRecepciones.IdDetalleRecepcion = @IdDetalleRecepcion
                END

            UPDATE  DetalleComprobantesProveedores
            SET     IdComprobanteProveedor = @IdComprobanteProveedor,
                    IdArticulo = @IdArticulo,
                    CodigoArticulo = @CodigoArticulo,
                    IdCuenta = @IdCuenta,
                    CodigoCuenta = @CodigoCuenta,
                    PorcentajeIvaAplicado = @PorcentajeIvaAplicado,
                    Importe = @Importe,
                    IdCuentaGasto = @IdCuentaGasto,
                    IdCuentaIvaCompras1 = @IdCuentaIvaCompras1,
                    IVAComprasPorcentaje1 = @IVAComprasPorcentaje1,
                    ImporteIVA1 = @ImporteIVA1,
                    AplicarIVA1 = @AplicarIVA1,
                    IdCuentaIvaCompras2 = @IdCuentaIvaCompras2,
                    IVAComprasPorcentaje2 = @IVAComprasPorcentaje2,
                    ImporteIVA2 = @ImporteIVA2,
                    AplicarIVA2 = @AplicarIVA2,
                    IdCuentaIvaCompras3 = @IdCuentaIvaCompras3,
                    IVAComprasPorcentaje3 = @IVAComprasPorcentaje3,
                    ImporteIVA3 = @ImporteIVA3,
                    AplicarIVA3 = @AplicarIVA3,
                    IdCuentaIvaCompras4 = @IdCuentaIvaCompras4,
                    IVAComprasPorcentaje4 = @IVAComprasPorcentaje4,
                    ImporteIVA4 = @ImporteIVA4,
                    AplicarIVA4 = @AplicarIVA4,
                    IdCuentaIvaCompras5 = @IdCuentaIvaCompras5,
                    IVAComprasPorcentaje5 = @IVAComprasPorcentaje5,
                    ImporteIVA5 = @ImporteIVA5,
                    AplicarIVA5 = @AplicarIVA5,
                    IdObra = @IdObra,
                    Item = @Item,
                    IdCuentaIvaCompras6 = @IdCuentaIvaCompras6,
                    IVAComprasPorcentaje6 = @IVAComprasPorcentaje6,
                    ImporteIVA6 = @ImporteIVA6,
                    AplicarIVA6 = @AplicarIVA6,
                    IdCuentaIvaCompras7 = @IdCuentaIvaCompras7,
                    IVAComprasPorcentaje7 = @IVAComprasPorcentaje7,
                    ImporteIVA7 = @ImporteIVA7,
                    AplicarIVA7 = @AplicarIVA7,
                    IdCuentaIvaCompras8 = @IdCuentaIvaCompras8,
                    IVAComprasPorcentaje8 = @IVAComprasPorcentaje8,
                    ImporteIVA8 = @ImporteIVA8,
                    AplicarIVA8 = @AplicarIVA8,
                    IdCuentaIvaCompras9 = @IdCuentaIvaCompras9,
                    IVAComprasPorcentaje9 = @IVAComprasPorcentaje9,
                    ImporteIVA9 = @ImporteIVA9,
                    AplicarIVA9 = @AplicarIVA9,
                    IdCuentaIvaCompras10 = @IdCuentaIvaCompras10,
                    IVAComprasPorcentaje10 = @IVAComprasPorcentaje10,
                    ImporteIVA10 = @ImporteIVA10,
                    AplicarIVA10 = @AplicarIVA10,
                    IVAComprasPorcentajeDirecto = @IVAComprasPorcentajeDirecto,
                    IdCuentaBancaria = @IdCuentaBancaria,
                    PRESTOConcepto = @PRESTOConcepto,
                    PRESTOObra = @PRESTOObra,
                    IdDetalleRecepcion = @IdDetalleRecepcion,
                    TomarEnCalculoDeImpuestos = @TomarEnCalculoDeImpuestos,
                    IdRubroContable = @IdRubroContable,
                    IdPedido = @IdPedido,
                    IdDetallePedido = @IdDetallePedido,
                    Importacion_FOB = @Importacion_FOB,
                    Importacion_PosicionAduana = @Importacion_PosicionAduana,
                    Importacion_Despacho = @Importacion_Despacho,
                    Importacion_Guia = @Importacion_Guia,
                    Importacion_IdPaisOrigen = @Importacion_IdPaisOrigen,
                    Importacion_FechaEmbarque = @Importacion_FechaEmbarque,
                    Importacion_FechaOficializacion = @Importacion_FechaOficializacion,
                    IdProvinciaDestino1 = @IdProvinciaDestino1,
                    PorcentajeProvinciaDestino1 = @PorcentajeProvinciaDestino1,
                    IdProvinciaDestino2 = @IdProvinciaDestino2,
                    PorcentajeProvinciaDestino2 = @PorcentajeProvinciaDestino2,
                    IdDistribucionObra = @IdDistribucionObra,
                    IdDetalleObraDestino = @IdDetalleObraDestino,
                    IdPresupuestoObraRubro = @IdPresupuestoObraRubro,
                    IdPedidoAnticipo = @IdPedidoAnticipo,
                    PorcentajeAnticipo = @PorcentajeAnticipo,
                    PorcentajeCertificacion = @PorcentajeCertificacion,
                    IdPresupuestoObrasNodo = @IdPresupuestoObrasNodo,
                    IdDetalleComprobanteProveedorOriginal = @IdDetalleComprobanteProveedorOriginal
            WHERE   ( IdDetalleComprobanteProveedor = @IdDetalleComprobanteProveedor )
        END

    RETURN ( @IdDetalleComprobanteProveedor )



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetComprobantesProveedores_T]
    @IdDetalleComprobanteProveedor INT = NULL
AS 
    SELECT  *
    FROM    DetalleComprobantesProveedores
    WHERE   ( IdDetalleComprobanteProveedor = @IdDetalleComprobanteProveedor )



GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE Procedure [dbo].[wComprobantesProveedores_TX_PorIdConDatos]

@IdComprobanteProveedor int

AS 

SET NOCOUNT ON

DECLARE @IdTipoCuentaGrupoIVA int, @IdCtaAdicCol1 int, @IdCtaAdicCol2 int, @IdCtaAdicCol3 int, @IdCtaAdicCol4 int, @IdCtaAdicCol5 int
SET @IdTipoCuentaGrupoIVA=IsNull((Select IdTipoCuentaGrupoIVA From Parametros Where IdParametro=1),0)
SET @IdCtaAdicCol1=IsNull((Select IdCuentaAdicionalIVACompras1 From Parametros Where IdParametro=1),0)
SET @IdCtaAdicCol2=IsNull((Select IdCuentaAdicionalIVACompras2 From Parametros Where IdParametro=1),0)
SET @IdCtaAdicCol3=IsNull((Select IdCuentaAdicionalIVACompras3 From Parametros Where IdParametro=1),0)
SET @IdCtaAdicCol4=IsNull((Select IdCuentaAdicionalIVACompras4 From Parametros Where IdParametro=1),0)
SET @IdCtaAdicCol5=IsNull((Select IdCuentaAdicionalIVACompras5 From Parametros Where IdParametro=1),0)

CREATE TABLE #Auxiliar 
			(
			 IdComprobanteProveedor INTEGER,
			 GravadoIVA NUMERIC(18,2)
			)
INSERT INTO #Auxiliar 
SELECT
 dcp.IdComprobanteProveedor,
 SUM(
	Case When (Cuentas.IdTipoCuentaGrupo is null or Cuentas.IdTipoCuentaGrupo<>@IdTipoCuentaGrupoIVA) and 
			dcp.IdCuenta<>@IdCtaAdicCol1 and dcp.IdCuenta<>@IdCtaAdicCol2 and 
			dcp.IdCuenta<>@IdCtaAdicCol3 and dcp.IdCuenta<>@IdCtaAdicCol4 and 
			dcp.IdCuenta<>@IdCtaAdicCol5 
		Then 	Case 	When dcp.ImporteIVA1=0 and dcp.ImporteIVA2=0 and dcp.ImporteIVA3=0 and 
					dcp.ImporteIVA4=0 and dcp.ImporteIVA5=0 and dcp.ImporteIVA6=0 and 
					dcp.ImporteIVA7=0 and dcp.ImporteIVA8=0 and dcp.ImporteIVA9=0 and 
					dcp.ImporteIVA10=0
				 Then 0
				 Else 	Case When cp.Letra='A' or cp.Letra='M' 
						Then dcp.Importe
						Else dcp.Importe-(dcp.ImporteIVA1+dcp.ImporteIVA2+dcp.ImporteIVA3+dcp.ImporteIVA4+dcp.ImporteIVA5+
								  dcp.ImporteIVA6+dcp.ImporteIVA7+dcp.ImporteIVA8+dcp.ImporteIVA9+dcp.ImporteIVA10)
					End --*cp.CotizacionMoneda  
			End
		Else 0
	 End)
FROM DetalleComprobantesProveedores dcp 
LEFT OUTER JOIN ComprobantesProveedores cp ON dcp.IdComprobanteProveedor=cp.IdComprobanteProveedor
LEFT OUTER JOIN Cuentas ON dcp.IdCuenta=Cuentas.IdCuenta
WHERE dcp.IdComprobanteProveedor=@IdComprobanteProveedor
GROUP BY dcp.IdComprobanteProveedor

SET NOCOUNT OFF

SELECT 
 cp.*,
 Case When P1.IBCondicion is not null and P1.IBCondicion=2
	Then (Select Top 1 dpib.AlicuotaAAplicar From DetalleProveedoresIB dpib Where dpib.IdProveedor=cp.IdProveedor and dpib.IdIBCondicion=cp.IdIBCondicion)
	Else Null
 End as [Alicuota Conv.Mul.],
 (Select Sum(dcp.Importe) From DetalleComprobantesProveedores dcp
  Where dcp.IdComprobanteProveedor=cp.IdComprobanteProveedor and dcp.TomarEnCalculoDeImpuestos is not null and dcp.TomarEnCalculoDeImpuestos='NO') as [RestarAlBruto],
 IsNull(#Auxiliar.GravadoIVA,0) as [GravadoIVA],
 (Select Sum(IsNull(cp1.TotalIva1,0)*IsNull(cp1.CotizacionMoneda,0)) From ComprobantesProveedores cp1 Where cp1.IdComprobanteImputado=cp.IdComprobanteProveedor) as [IvaCreditos],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 E1.Nombre as [Ingreso],
 E2.Nombre as [Modifico],
 P1.RazonSocial as [Proveedor], 
 IsNull(P1.Direccion,'')+IsNull(' '+Localidades.Nombre,'')+IsNull(' '+P1.CodigoPostal,'')+IsNull(' '+Prov1.Nombre,'') as [Domicilio],
 P1.Cuit as [CuitProveedor], 
 cc.Descripcion as [CondicionCompra],
 Substring('0000',1,4-Len(Convert(varchar,cp.NumeroComprobante1)))+Convert(varchar,cp.NumeroComprobante1)+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,cp.NumeroComprobante2)))+Convert(varchar,cp.NumeroComprobante2) as [NumeroCP],
 cp.Letra+'-'+Substring('0000',1,4-Len(Convert(varchar,cp.NumeroComprobante1)))+Convert(varchar,cp.NumeroComprobante1)+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,cp.NumeroComprobante2)))+Convert(varchar,cp.NumeroComprobante2) as [Numero],
 Monedas.Abreviatura as [Moneda],
 IsNull((Select Sum(IsNull(CtaCte.Saldo,0)) From CuentasCorrientesAcreedores CtaCte
	 Left Outer Join TiposComprobante tc On tc.IdTipoComprobante=CtaCte.IdTipoComp
	 Where CtaCte.IdProveedor=cp.IdProveedor and tc.Coeficiente=-1),0) as [AnticiposAAplicar],
 (Select Top 1 E.Nombre+' '+Convert(varchar,ac.FechaAutorizacion,103) From AutorizacionesPorComprobante ac 
  Left Outer Join Empleados E On E.IdEmpleado=ac.IdAutorizo
  Where ac.IdFormulario=31 and ac.IdComprobante=cp.IdComprobanteProveedor
  Order By ac.OrdenAutorizacion Desc) as [UltimoFirmante],
 TiposComprobante.Descripcion as [TipoComprobante],
 IsNull(P1.RazonSocial,C1.Descripcion) as [ProveedorCuenta],
 Case 	When cp.IdProveedor is not null Then 'Cta. cte.' 
	When cp.IdCuenta is not null Then 'F.fijo' 
	When cp.IdCuentaOtros is not null Then 'Otros' 
	Else Null
 End as [Tipo],
 P2.RazonSocial as [ProveedorFF],
 IsNull(diva1.Descripcion,IsNull(diva2.Descripcion,diva3.Descripcion)) as [CondicionIVA],
 IsNull(P1.CodigoEmpresa,P2.CodigoEmpresa) as [CodigoProveedor], 
 OrdenesPago.NumeroOrdenPago as [Vale],
 Prov2.Nombre as [ProvinciaDestino]
FROM ComprobantesProveedores cp 
LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=cp.IdTipoComprobante
LEFT OUTER JOIN Proveedores P1 ON cp.IdProveedor = P1.IdProveedor
LEFT OUTER JOIN Proveedores P2 ON cp.IdProveedorEventual = P2.IdProveedor
LEFT OUTER JOIN Cuentas C1 ON IsNull(cp.IdCuenta,cp.IdCuentaOtros) = C1.IdCuenta
LEFT OUTER JOIN IBCondiciones ON cp.IdIBCondicion=IBCondiciones.IdIBCondicion
LEFT OUTER JOIN #Auxiliar ON cp.IdComprobanteProveedor=#Auxiliar.IdComprobanteProveedor
LEFT OUTER JOIN Obras ON cp.IdObra=Obras.IdObra
LEFT OUTER JOIN Empleados E1 ON cp.IdUsuarioIngreso=E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON cp.IdUsuarioModifico=E2.IdEmpleado
LEFT OUTER JOIN Localidades ON P1.IdLocalidad=Localidades.IdLocalidad 
LEFT OUTER JOIN Provincias Prov1 ON P1.IdProvincia=Prov1.IdProvincia
LEFT OUTER JOIN Provincias Prov2 ON cp.IdProvinciaDestino=Prov2.IdProvincia
LEFT OUTER JOIN Paises ON P1.IdPais=Paises.IdPais
LEFT OUTER JOIN [Condiciones Compra] cc ON cp.IdCondicionCompra=cc.IdCondicionCompra
LEFT OUTER JOIN Monedas ON cp.IdMoneda = Monedas.IdMoneda
LEFT OUTER JOIN DescripcionIva diva1 ON cp.IdCodigoIva = diva1.IdCodigoIva
LEFT OUTER JOIN DescripcionIva diva2 ON P1.IdCodigoIva = diva2.IdCodigoIva
LEFT OUTER JOIN DescripcionIva diva3 ON P2.IdCodigoIva = diva3.IdCodigoIva
LEFT OUTER JOIN OrdenesPago ON cp.IdOrdenPago = OrdenesPago.IdOrdenPago
WHERE (cp.IdComprobanteProveedor=@IdComprobanteProveedor)

DROP TABLE #Auxiliar


GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_TT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetComprobantesProveedores_TT]
    @IdComprobanteProveedor INT
AS 
    SELECT  Det.*,
            CuentasGastos.Descripcion AS [CuentaGastoDescripcion]
    FROM    DetalleComprobantesProveedores Det --LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento=DetReq.IdRequerimiento
            LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN CuentasGastos ON ( Det.IdCuentaGasto = CuentasGastos.IdCuentaGasto )
--LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
--LEFT OUTER JOIN Obras ON Cab.IdObra = Obras.IdObra
--LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
--LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
--LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
--LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
--LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
--LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
--LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
--LEFT OUTER JOIN Proveedores ON DetReq.IdProveedor = Proveedores.IdProveedor
    WHERE   IdComprobanteProveedor = @IdComprobanteProveedor 



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedores_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetComprobantesProveedores_E]
    @IdDetalleComprobanteProveedores INT
AS 
    DELETE  DetalleComprobantesProveedores
    WHERE   ( IdDetalleComprobanteProveedor = @IdDetalleComprobanteProveedores )



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_A]
    @IdDetalleComprobanteProveedorProvincias INT OUTPUT,
    @IdComprobanteProveedor INT,
    @IdProvinciaDestino INT,
    @Porcentaje NUMERIC(6, 2)
AS 
    IF ISNULL(@IdDetalleComprobanteProveedorProvincias, 0) <= 0 
        BEGIN 

            INSERT  INTO [DetalleComprobantesProveedoresProvincias]
                    (
                      IdComprobanteProveedor,
                      IdProvinciaDestino,
                      Porcentaje
		        )
            VALUES  (
                      @IdComprobanteProveedor,
                      @IdProvinciaDestino,
                      @Porcentaje
		        )
        END
    ELSE 
        BEGIN
            UPDATE  [DetalleComprobantesProveedoresProvincias]
            SET     IdComprobanteProveedor = @IdComprobanteProveedor,
                    IdProvinciaDestino = @IdProvinciaDestino,
                    Porcentaje = @Porcentaje
            WHERE   ( IdDetalleComprobanteProveedorProvincias = @IdDetalleComprobanteProveedorProvincias )
        END

    RETURN ( @IdDetalleComprobanteProveedorProvincias )



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_E]
    @IdDetalleComprobanteProveedorProvincias INT
AS 
    DELETE  [DetalleComprobantesProveedoresProvincias]
    WHERE   ( IdDetalleComprobanteProveedorProvincias = @IdDetalleComprobanteProveedorProvincias )



GO
/****** Object:  StoredProcedure [dbo].[wDetComprobantesProveedoresPrv_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wDetComprobantesProveedoresPrv_T]
    @IdDetalleComprobanteProveedorProvincias INT = NULL
AS 
    SELECT  *
    FROM    [DetalleComprobantesProveedoresProvincias]
    WHERE   ( IdDetalleComprobanteProveedorProvincias = @IdDetalleComprobanteProveedorProvincias )



GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesA_TX_SaldosAFechaDetallado]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wCtasCtesA_TX_SaldosAFechaDetallado]

@FechaDesde datetime,
@FechaHasta datetime

AS 

SET NOCOUNT ON

DECLARE @IdTipoComprobanteOrdenPago int

SET @IdTipoComprobanteOrdenPago=(Select Top 1 IdTipoComprobanteOrdenPago From Parametros Where IdParametro=1)

CREATE TABLE #Auxiliar0	(IdProveedor INTEGER, SaldoPesos NUMERIC(18, 2))
INSERT INTO #Auxiliar0 
 SELECT CtaCte.IdProveedor, Sum(IsNull(CtaCte.ImporteTotal,0)*TiposComprobante.Coeficiente*-1)
 FROM CuentasCorrientesAcreedores CtaCte
 LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
 LEFT OUTER JOIN Proveedores ON Proveedores.IdProveedor=CtaCte.IdProveedor
 WHERE CtaCte.Fecha<=@FechaHasta 
 GROUP BY CtaCte.IdProveedor

CREATE TABLE #Auxiliar1	(IdProveedor INTEGER, SaldoPesos NUMERIC(18, 2))
INSERT INTO #Auxiliar1 
 SELECT CtaCte.IdProveedor, Sum(IsNull(CtaCte.ImporteTotal,0)*TiposComprobante.Coeficiente*-1)
 FROM CuentasCorrientesAcreedores CtaCte
 LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
 LEFT OUTER JOIN Proveedores ON Proveedores.IdProveedor=CtaCte.IdProveedor
 WHERE CtaCte.Fecha<@FechaDesde 
 GROUP BY CtaCte.IdProveedor

SET NOCOUNT OFF

SELECT  
 0 as [K_Orden],
 Proveedores.RazonSocial+' ['+Proveedores.CodigoEmpresa COLLATE SQL_Latin1_General_CP1_CI_AS+']' as [Proveedor],
 @FechaDesde as [Fecha],
 Null as [IdTipoComprobante],
 Null as [IdComprobante],
 'SALDO INICIAL AL '+Convert(varchar,@FechaDesde,103) as [Comprobante],
 Null as [Detalle],
 #Auxiliar1.SaldoPesos as [Importe]
FROM #Auxiliar1
LEFT OUTER JOIN #Auxiliar0 ON #Auxiliar0.IdProveedor=#Auxiliar1.IdProveedor
LEFT OUTER JOIN Proveedores ON Proveedores.IdProveedor=#Auxiliar1.IdProveedor
WHERE IsNull(#Auxiliar0.SaldoPesos,0)<>0

UNION ALL

SELECT  
 1 as [K_Orden],
 Proveedores.RazonSocial+' ['+Proveedores.CodigoEmpresa COLLATE SQL_Latin1_General_CP1_CI_AS+']' as [Proveedor],
 CtaCte.Fecha as [Fecha],
 CtaCte.IdTipoComp as [IdTipoComprobante],
 CtaCte.IdComprobante as [IdComprobante],
 Case When CtaCte.IdTipoComp=@IdTipoComprobanteOrdenPago or CtaCte.IdTipoComp=16
	Then 'OP '+Substring('00000000',1,8-Len(Convert(varchar,CtaCte.NumeroComprobante)))+Convert(varchar,CtaCte.NumeroComprobante)
	Else TiposComprobante.DescripcionAb+' '+IsNull(cp.Letra,'?')+'-'+
		Substring('0000',1,4-Len(Convert(varchar,IsNull(cp.NumeroComprobante1,0))))+Convert(varchar,IsNull(cp.NumeroComprobante1,0))+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,IsNull(cp.NumeroComprobante2,CtaCte.NumeroComprobante))))+Convert(varchar,IsNull(cp.NumeroComprobante2,CtaCte.NumeroComprobante))+' '+
		'[ Ref. : '+Convert(varchar,IsNull(cp.NumeroReferencia,0))+' ]'
 End as [Comprobante],
 Case When CtaCte.IdTipoComp=@IdTipoComprobanteOrdenPago or CtaCte.IdTipoComp=16
	Then op.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	Else cp.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
 End as [Detalle],
 CtaCte.ImporteTotal*TiposComprobante.Coeficiente*-1 as [Importe]
FROM CuentasCorrientesAcreedores CtaCte
LEFT OUTER JOIN #Auxiliar0 ON #Auxiliar0.IdProveedor=CtaCte.IdProveedor
LEFT OUTER JOIN Proveedores ON Proveedores.IdProveedor=CtaCte.IdProveedor
LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
LEFT OUTER JOIN ComprobantesProveedores cp ON cp.IdComprobanteProveedor=CtaCte.IdComprobante and Not (CtaCte.IdTipoComp=@IdTipoComprobanteOrdenPago or CtaCte.IdTipoComp=16)
LEFT OUTER JOIN OrdenesPago op ON op.IdOrdenPago=CtaCte.IdComprobante and (CtaCte.IdTipoComp=@IdTipoComprobanteOrdenPago or CtaCte.IdTipoComp=16)
WHERE IsNull(#Auxiliar0.SaldoPesos,0)<>0 and CtaCte.Fecha>=@FechaDesde and CtaCte.Fecha<=@FechaHasta 

ORDER BY [Proveedor], [K_Orden], [Fecha]

DROP TABLE #Auxiliar0
DROP TABLE #Auxiliar1

GO
/****** Object:  StoredProcedure [dbo].[wPedidos_T_ByEmployee]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wPedidos_T_ByEmployee @IdSolicito INT
AS 
    SET NOCOUNT ON

    DECLARE @ActivarSolicitudMateriales VARCHAR(2),
        @FechaInicial DATETIME
    SET @ActivarSolicitudMateriales = ISNULL(( SELECT TOP 1
                                                        P.ActivarSolicitudMateriales
                                               FROM     Parametros P
                                               WHERE    P.IdParametro = 1
                                             ), 'NO')
    SET @FechaInicial = CONVERT(DATETIME, '01/01/2008')

/* PRESUPUESTOS */
    CREATE TABLE #Auxiliar0
        (
          IdRequerimiento INTEGER,
          Presupuestos VARCHAR(100)
        )

    CREATE TABLE #Auxiliar1
        (
          IdRequerimiento INTEGER,
          Presupuesto VARCHAR(13)
        )
    INSERT  INTO #Auxiliar1
            SELECT  DetReq.IdRequerimiento,
                    CONVERT(VARCHAR, Presupuestos.Numero)
                    + CASE WHEN Presupuestos.Subnumero IS NOT NULL
                           THEN '/' + CONVERT(VARCHAR, Presupuestos.Subnumero)
                           ELSE ''
                      END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
                    LEFT OUTER JOIN Presupuestos ON DetallePresupuestos.IdPresupuesto = Presupuestos.IdPresupuesto
            WHERE   Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.FechaRequerimiento >= @FechaInicial

    CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 ( IdRequerimiento, Presupuesto )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar0
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar1
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @IdRequerimiento1 INT,
        @Presupuesto VARCHAR(13),
        @P VARCHAR(100),
        @Corte INT
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Presupuesto
            FROM    #Auxiliar1
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar0
                            SET     Presupuestos = SUBSTRING(@P, 1, 100)
                            WHERE   #Auxiliar0.IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Presupuesto IS NULL 
                IF PATINDEX('%' + @Presupuesto + ' ' + '%', @P) = 0 
                    SET @P = @P + @Presupuesto + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Presupuesto
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar0
            SET     Presupuestos = SUBSTRING(@P, 1, 100)
            WHERE   #Auxiliar0.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* COMPARATIVAS */
    CREATE TABLE #Auxiliar2
        (
          IdRequerimiento INTEGER,
          Comparativas VARCHAR(100)
        )

    CREATE TABLE #Auxiliar3
        (
          IdRequerimiento INTEGER,
          Comparativa INTEGER
        )
    INSERT  INTO #Auxiliar3
            SELECT  DetReq.IdRequerimiento,
                    Comparativas.Numero
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN DetallePresupuestos ON DetReq.IdDetalleRequerimiento = DetallePresupuestos.IdDetalleRequerimiento
                    LEFT OUTER JOIN DetalleComparativas ON DetallePresupuestos.IdDetallePresupuesto = DetalleComparativas.IdDetallePresupuesto
                    LEFT OUTER JOIN Comparativas ON DetalleComparativas.IdComparativa = Comparativas.IdComparativa
            WHERE   Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.FechaRequerimiento >= @FechaInicial

    CREATE NONCLUSTERED INDEX IX__Auxiliar3 ON #Auxiliar3 ( IdRequerimiento, Comparativa )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar2
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar3
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Comparativa INT,
        @C VARCHAR(100)
    SET @Corte = 0
    SET @C = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Comparativa
            FROM    #Auxiliar3
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar2
                            SET     Comparativas = SUBSTRING(@C, 1, 100)
                            WHERE   #Auxiliar2.IdRequerimiento = @Corte
                        END
                    SET @C = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Comparativa IS NULL 
                IF PATINDEX('%' + CONVERT(VARCHAR, @Comparativa) + ' ' + '%',
                            @C) = 0 
                    SET @C = @C + CONVERT(VARCHAR, @Comparativa) + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Comparativa
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar2
            SET     Comparativas = SUBSTRING(@C, 1, 100)
            WHERE   #Auxiliar2.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* PEDIDOS */
    CREATE TABLE #Auxiliar4
        (
          IdRequerimiento INTEGER,
          Pedidos VARCHAR(100)
        )

    CREATE TABLE #Auxiliar5
        (
          IdRequerimiento INTEGER,
          Pedido VARCHAR(13)
        )
    INSERT  INTO #Auxiliar5
            SELECT  DetReq.IdRequerimiento,
                    CONVERT(VARCHAR, Pedidos.NumeroPedido)
                    + CASE WHEN Pedidos.Subnumero IS NOT NULL
                           THEN '/' + CONVERT(VARCHAR, Pedidos.Subnumero)
                           ELSE ''
                      END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN DetallePedidos ON DetReq.IdDetalleRequerimiento = DetallePedidos.IdDetalleRequerimiento
                    LEFT OUTER JOIN Pedidos ON DetallePedidos.IdPedido = Pedidos.IdPedido
            WHERE   Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.FechaRequerimiento >= @FechaInicial

    CREATE NONCLUSTERED INDEX IX__Auxiliar5 ON #Auxiliar5 ( IdRequerimiento, Pedido )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar4
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar5
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Pedido VARCHAR(13)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Pedido
            FROM    #Auxiliar5
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar4
                            SET     Pedidos = SUBSTRING(@P, 1, 100)
                            WHERE   #Auxiliar4.IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Pedido IS NULL 
                IF PATINDEX('%' + @Pedido + ' ' + '%', @P) = 0 
                    SET @P = @P + @Pedido + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Pedido
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar4
            SET     Pedidos = SUBSTRING(@P, 1, 100)
            WHERE   #Auxiliar4.IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* RECEPCION DE MATERIALES */
    CREATE TABLE #Auxiliar6
        (
          IdRequerimiento INTEGER,
          Recepciones VARCHAR(100)
        )

    CREATE TABLE #Auxiliar7
        (
          IdRequerimiento INTEGER,
          Recepcion VARCHAR(20)
        )
    INSERT  INTO #Auxiliar7
            SELECT  DetReq.IdRequerimiento,
                    CASE WHEN Recepciones.SubNumero IS NOT NULL
                         THEN SUBSTRING(SUBSTRING('0000', 1,
                                                  4
                                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)
                                        + '-' + SUBSTRING('00000000', 1,
                                                          8
                                                          - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)
                                        + '/'
                                        + CONVERT(VARCHAR, Recepciones.SubNumero),
                                        1, 20)
                         ELSE SUBSTRING(SUBSTRING('0000', 1,
                                                  4
                                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)
                                        + '-' + SUBSTRING('00000000', 1,
                                                          8
                                                          - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                                        + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2),
                                        1, 20)
                    END
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN DetalleRecepciones ON DetReq.IdDetalleRequerimiento = DetalleRecepciones.IdDetalleRequerimiento
                    LEFT OUTER JOIN Recepciones ON DetalleRecepciones.IdRecepcion = Recepciones.IdRecepcion
            WHERE   Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.FechaRequerimiento >= @FechaInicial

    CREATE NONCLUSTERED INDEX IX__Auxiliar7 ON #Auxiliar7 ( IdRequerimiento, Recepcion )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar6
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar7
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Recepcion VARCHAR(20)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Recepcion
            FROM    #Auxiliar7
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar6
                            SET     Recepciones = SUBSTRING(@P, 1, 100)
                            WHERE   IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Recepcion IS NULL 
                IF PATINDEX('%' + @Recepcion + ' ' + '%', @P) = 0 
                    SET @P = @P + @Recepcion + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Recepcion
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar6
            SET     Recepciones = SUBSTRING(@P, 1, 100)
            WHERE   IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur


/* SALIDAS DE MATERIALES */
    CREATE TABLE #Auxiliar8
        (
          IdRequerimiento INTEGER,
          Salidas VARCHAR(100)
        )

    CREATE TABLE #Auxiliar9
        (
          IdRequerimiento INTEGER,
          Salida VARCHAR(13)
        )
    INSERT  INTO #Auxiliar9
            SELECT  DetReq.IdRequerimiento,
                    SUBSTRING(SUBSTRING('0000', 1,
                                        4
                                        - LEN(CONVERT(VARCHAR, ISNULL(SalidasMateriales.NumeroSalidaMateriales2, 0))))
                              + CONVERT(VARCHAR, ISNULL(SalidasMateriales.NumeroSalidaMateriales2,
                                                        0)) + '-'
                              + SUBSTRING('00000000', 1,
                                          8
                                          - LEN(CONVERT(VARCHAR, SalidasMateriales.NumeroSalidaMateriales)))
                              + CONVERT(VARCHAR, SalidasMateriales.NumeroSalidaMateriales),
                              1, 13)
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN DetalleValesSalida ON DetReq.IdDetalleRequerimiento = DetalleValesSalida.IdDetalleRequerimiento
                    LEFT OUTER JOIN DetalleSalidasMateriales ON DetalleValesSalida.IdDetalleValeSalida = DetalleSalidasMateriales.IdDetalleValeSalida
                    LEFT OUTER JOIN SalidasMateriales ON DetalleSalidasMateriales.IdSalidaMateriales = SalidasMateriales.IdSalidaMateriales
            WHERE   Requerimientos.IdSolicito = @IdSolicito
                    AND Requerimientos.FechaRequerimiento >= @FechaInicial

    CREATE NONCLUSTERED INDEX IX__Auxiliar9 ON #Auxiliar9 ( IdRequerimiento, Salida )
    ON  [PRIMARY]

    INSERT  INTO #Auxiliar8
            SELECT  IdRequerimiento,
                    ''
            FROM    #Auxiliar9
            GROUP BY IdRequerimiento

/*  CURSOR  */
    DECLARE @Salida VARCHAR(13)
    SET @Corte = 0
    SET @P = ''
    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
        FOR SELECT  IdRequerimiento,
                    Salida
            FROM    #Auxiliar9
            ORDER BY IdRequerimiento
    OPEN Cur
    FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
    WHILE @@FETCH_STATUS = 0
        BEGIN
            IF @Corte <> @IdRequerimiento1 
                BEGIN
                    IF @Corte <> 0 
                        BEGIN
                            UPDATE  #Auxiliar8
                            SET     Salidas = SUBSTRING(@P, 1, 100)
                            WHERE   IdRequerimiento = @Corte
                        END
                    SET @P = ''
                    SET @Corte = @IdRequerimiento1
                END
            IF NOT @Salida IS NULL 
                IF PATINDEX('%' + @Salida + ' ' + '%', @P) = 0 
                    SET @P = @P + @Salida + ' '
            FETCH NEXT FROM Cur INTO @IdRequerimiento1, @Salida
        END
    IF @Corte <> 0 
        BEGIN
            UPDATE  #Auxiliar8
            SET     Salidas = SUBSTRING(@P, 1, 100)
            WHERE   IdRequerimiento = @Corte
        END
    CLOSE Cur
    DEALLOCATE Cur

    SET NOCOUNT OFF

    SELECT  Requerimientos.*,
            Obras.NumeroObra + ' ' + Obras.Descripcion AS [Obra],
            #Auxiliar0.Presupuestos AS [Presupuestos],
            #Auxiliar2.Comparativas AS [Comparativas],
            #Auxiliar4.Pedidos AS [Pedidos],
            #Auxiliar6.Recepciones AS [Recepciones],
            #Auxiliar8.Salidas AS [Salidas],
            ( SELECT    COUNT(*)
              FROM      DetalleRequerimientos Det
              WHERE     Det.IdRequerimiento = Requerimientos.IdRequerimiento
            ) AS [Items],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.Aprobo = E.IdEmpleado
            ) AS [Libero],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdSolicito = E.IdEmpleado
            ) AS [Solicito],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     Requerimientos.IdComprador = E.IdEmpleado
            ) AS [Comprador],
            Sectores.Descripcion AS [Sector],
            ArchivosATransmitirDestinos.Descripcion AS [Origen],
            Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS
            + ' ' + Articulos.Descripcion AS [EquipoDestino],
            TiposCompra.Descripcion AS [TipoCompra],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     E.IdEmpleado = ( SELECT TOP 1
                                                Aut.IdAutorizo
                                         FROM   AutorizacionesPorComprobante Aut
                                         WHERE  Aut.IdFormulario = 3
                                                AND Aut.OrdenAutorizacion = 1
                                                AND Aut.IdComprobante = Requerimientos.IdRequerimiento
                                       )
            ) AS [SegundaFirma],
            ( SELECT TOP 1
                        Aut.FechaAutorizacion
              FROM      AutorizacionesPorComprobante Aut
              WHERE     Aut.IdFormulario = 3
                        AND Aut.OrdenAutorizacion = 1
                        AND Aut.IdComprobante = Requerimientos.IdRequerimiento
            ) AS [FechaSegundaFirma],
            ( SELECT TOP 1
                        E.Nombre
              FROM      Empleados E
              WHERE     E.IdEmpleado = ( SELECT TOP 1
                                                Det.IdComprador
                                         FROM   DetalleRequerimientos Det
                                         WHERE  Det.IdRequerimiento = Requerimientos.IdRequerimiento
                                                AND Det.IdComprador IS NOT NULL
                                       )
            ) AS [CompradorItem]
    FROM    Requerimientos
            LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
            LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto = CentrosCosto.IdCentroCosto
            LEFT OUTER JOIN Sectores ON Requerimientos.IdSector = Sectores.IdSector
            LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
            LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino = Articulos.IdArticulo
            LEFT OUTER JOIN #Auxiliar0 ON Requerimientos.IdRequerimiento = #Auxiliar0.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar2 ON Requerimientos.IdRequerimiento = #Auxiliar2.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar4 ON Requerimientos.IdRequerimiento = #Auxiliar4.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar6 ON Requerimientos.IdRequerimiento = #Auxiliar6.IdRequerimiento
            LEFT OUTER JOIN #Auxiliar8 ON Requerimientos.IdRequerimiento = #Auxiliar8.IdRequerimiento
            LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
--WHERE IsNull(Requerimientos.Confirmado,'SI')<>'NO' and Requerimientos.IdSolicito = @IdSolicito and 
--	Requerimientos.FechaRequerimiento>=@FechaInicial
    ORDER BY Requerimientos.FechaRequerimiento DESC,
            Requerimientos.NumeroRequerimiento DESC

    DROP TABLE #Auxiliar0
    DROP TABLE #Auxiliar1
    DROP TABLE #Auxiliar2
    DROP TABLE #Auxiliar3
    DROP TABLE #Auxiliar4
    DROP TABLE #Auxiliar5
    DROP TABLE #Auxiliar6
    DROP TABLE #Auxiliar7
    DROP TABLE #Auxiliar8
    DROP TABLE #Auxiliar9

GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesD_TX_SaldosAFechaDetallado]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wCtasCtesD_TX_SaldosAFechaDetallado]

@FechaDesde datetime,
@FechaHasta datetime

AS 

SET NOCOUNT ON

DECLARE @IdTipoComprobanteFacturaVenta int, @IdTipoComprobanteDevoluciones int, @IdTipoComprobanteNotaDebito int, @IdTipoComprobanteNotaCredito int,
	@IdTipoComprobanteRecibo int

SET @IdTipoComprobanteFacturaVenta=(Select Top 1 IdTipoComprobanteFacturaVenta From Parametros Where IdParametro=1)
SET @IdTipoComprobanteDevoluciones=(Select Top 1 IdTipoComprobanteDevoluciones From Parametros Where IdParametro=1)
SET @IdTipoComprobanteNotaDebito=(Select Top 1 IdTipoComprobanteNotaDebito From Parametros Where IdParametro=1)
SET @IdTipoComprobanteNotaCredito=(Select Top 1 IdTipoComprobanteNotaCredito From Parametros Where IdParametro=1)
SET @IdTipoComprobanteRecibo=(Select Top 1 IdTipoComprobanteRecibo From Parametros Where IdParametro=1)

CREATE TABLE #Auxiliar0 (IdCliente INTEGER, SaldoPesos NUMERIC(18, 2))
CREATE NONCLUSTERED INDEX IX__Auxiliar0 ON #Auxiliar0 (IdCliente) ON [PRIMARY]
INSERT INTO #Auxiliar0 
 SELECT CtaCte.IdCliente, Sum(IsNull(CtaCte.ImporteTotal,0)*TiposComprobante.Coeficiente)
 FROM CuentasCorrientesDeudores CtaCte
 LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
 LEFT OUTER JOIN Clientes ON Clientes.IdCliente=CtaCte.IdCliente
 LEFT OUTER JOIN Facturas Fac ON Fac.IdFactura=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteFacturaVenta
 LEFT OUTER JOIN Devoluciones Dev ON Dev.IdDevolucion=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteDevoluciones
 LEFT OUTER JOIN NotasDebito Deb ON Deb.IdNotaDebito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaDebito
 LEFT OUTER JOIN NotasCredito Cre ON Cre.IdNotaCredito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaCredito
 LEFT OUTER JOIN Recibos Rec ON Rec.IdRecibo=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteRecibo
 WHERE CtaCte.Fecha<=@FechaHasta 
 GROUP BY CtaCte.IdCliente

CREATE TABLE #Auxiliar1 (IdCliente INTEGER, SaldoPesos NUMERIC(18, 2))
INSERT INTO #Auxiliar1 
 SELECT CtaCte.IdCliente, Sum(IsNull(CtaCte.ImporteTotal,0)*TiposComprobante.Coeficiente)
 FROM CuentasCorrientesDeudores CtaCte
 LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
 LEFT OUTER JOIN Clientes ON Clientes.IdCliente=CtaCte.IdCliente
 LEFT OUTER JOIN Facturas Fac ON Fac.IdFactura=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteFacturaVenta
 LEFT OUTER JOIN Devoluciones Dev ON Dev.IdDevolucion=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteDevoluciones
 LEFT OUTER JOIN NotasDebito Deb ON Deb.IdNotaDebito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaDebito
 LEFT OUTER JOIN NotasCredito Cre ON Cre.IdNotaCredito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaCredito
 LEFT OUTER JOIN Recibos Rec ON Rec.IdRecibo=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteRecibo
 WHERE CtaCte.Fecha<@FechaDesde 
 GROUP BY CtaCte.IdCliente

SET NOCOUNT OFF

SELECT  
 0 as [K_Orden],
 Clientes.RazonSocial+' ['+Clientes.Codigo COLLATE SQL_Latin1_General_CP1_CI_AS+']' as [Cliente],
 @FechaDesde as [Fecha],
 Null as [IdTipoComprobante],
 Null as [IdComprobante],
 'SALDO INICIAL AL '+Convert(varchar,@FechaDesde,103) as [Comprobante],
 Null as [Detalle],
 #Auxiliar1.SaldoPesos as [Importe]
FROM #Auxiliar1
LEFT OUTER JOIN #Auxiliar0 ON #Auxiliar0.IdCliente=#Auxiliar1.IdCliente
LEFT OUTER JOIN Clientes ON Clientes.IdCliente=#Auxiliar1.IdCliente
LEFT OUTER JOIN Localidades ON Clientes.IdLocalidad=Localidades.IdLocalidad
LEFT OUTER JOIN Provincias ON Clientes.IdProvincia=Provincias.IdProvincia
WHERE IsNull(#Auxiliar0.SaldoPesos,0)<>0

UNION ALL

SELECT  
 1 as [K_Orden],
 Clientes.RazonSocial+' ['+Clientes.Codigo COLLATE SQL_Latin1_General_CP1_CI_AS+']' as [Cliente],
 CtaCte.Fecha as [Fecha],
 CtaCte.IdTipoComp as [IdTipoComprobante],
 CtaCte.IdComprobante as [IdComprobante],
 Case When CtaCte.IdTipoComp=@IdTipoComprobanteFacturaVenta and IsNull(CtaCte.IdComprobante,0)>0
	 Then TiposComprobante.DescripcionAb+' '+Fac.TipoABC+'-'+
		Substring('0000',1,4-Len(Convert(varchar,Fac.PuntoVenta)))+Convert(varchar,Fac.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,Fac.NumeroFactura)))+Convert(varchar,Fac.NumeroFactura)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
	When CtaCte.IdTipoComp=@IdTipoComprobanteDevoluciones and IsNull(CtaCte.IdComprobante,0)>0
	 Then TiposComprobante.DescripcionAb+' '+Dev.TipoABC+'-'+
		Substring('0000',1,4-Len(Convert(varchar,Dev.PuntoVenta)))+Convert(varchar,Dev.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,Dev.NumeroDevolucion)))+Convert(varchar,Dev.NumeroDevolucion)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
	When CtaCte.IdTipoComp=@IdTipoComprobanteNotaDebito and IsNull(CtaCte.IdComprobante,0)>0
	 Then TiposComprobante.DescripcionAb+' '+Deb.TipoABC+'-'+
		Substring('0000',1,4-Len(Convert(varchar,Deb.PuntoVenta)))+Convert(varchar,Deb.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,Deb.NumeroNotaDebito)))+Convert(varchar,Deb.NumeroNotaDebito)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
	When CtaCte.IdTipoComp=@IdTipoComprobanteNotaCredito and IsNull(CtaCte.IdComprobante,0)>0
	 Then TiposComprobante.DescripcionAb+' '+Cre.TipoABC+'-'+
		Substring('0000',1,4-Len(Convert(varchar,Cre.PuntoVenta)))+Convert(varchar,Cre.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,Cre.NumeroNotaCredito)))+Convert(varchar,Cre.NumeroNotaCredito)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
	When CtaCte.IdTipoComp=@IdTipoComprobanteRecibo and IsNull(CtaCte.IdComprobante,0)>0
	 Then TiposComprobante.DescripcionAb+' '+
		Substring('0000',1,4-Len(Convert(varchar,Rec.PuntoVenta)))+Convert(varchar,Rec.PuntoVenta)+'-'+
		Substring('0000000000',1,10-Len(Convert(varchar,Rec.NumeroRecibo)))+Convert(varchar,Rec.NumeroRecibo)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
	 Else IsNull(TiposComprobante.DescripcionAb,'')+' '+
		Substring('0000000000',1,10-Len(Convert(varchar,CtaCte.NumeroComprobante)))+Convert(varchar,CtaCte.NumeroComprobante)+' '+
		' del '+Convert(varchar,CtaCte.Fecha,103)
 End as [Comprobante],
 Case When CtaCte.IdTipoComp=@IdTipoComprobanteFacturaVenta and IsNull(CtaCte.IdComprobante,0)>0
	 Then Fac.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	When CtaCte.IdTipoComp=@IdTipoComprobanteDevoluciones and IsNull(CtaCte.IdComprobante,0)>0
	 Then Dev.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	When CtaCte.IdTipoComp=@IdTipoComprobanteNotaDebito and IsNull(CtaCte.IdComprobante,0)>0
	 Then Deb.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	When CtaCte.IdTipoComp=@IdTipoComprobanteNotaCredito and IsNull(CtaCte.IdComprobante,0)>0
	 Then Cre.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	When CtaCte.IdTipoComp=@IdTipoComprobanteRecibo and IsNull(CtaCte.IdComprobante,0)>0
	 Then Rec.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS
	 Else Null
 End as [Detalle],
 CtaCte.ImporteTotal * TiposComprobante.Coeficiente as [Importe]
FROM CuentasCorrientesDeudores CtaCte
LEFT OUTER JOIN #Auxiliar0 ON #Auxiliar0.IdCliente=CtaCte.IdCliente
LEFT OUTER JOIN Clientes ON Clientes.IdCliente=CtaCte.IdCliente
LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante=CtaCte.IdTipoComp
LEFT OUTER JOIN Facturas Fac ON Fac.IdFactura=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteFacturaVenta
LEFT OUTER JOIN Devoluciones Dev ON Dev.IdDevolucion=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteDevoluciones
LEFT OUTER JOIN NotasDebito Deb ON Deb.IdNotaDebito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaDebito
LEFT OUTER JOIN NotasCredito Cre ON Cre.IdNotaCredito=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteNotaCredito
LEFT OUTER JOIN Recibos Rec ON Rec.IdRecibo=CtaCte.IdComprobante and CtaCte.IdTipoComp=@IdTipoComprobanteRecibo
WHERE IsNull(#Auxiliar0.SaldoPesos,0)<>0 and CtaCte.Fecha>=@FechaDesde and CtaCte.Fecha<=@FechaHasta 

ORDER BY [Cliente], [K_Orden], [Fecha]

DROP TABLE #Auxiliar0
DROP TABLE #Auxiliar1

GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentas_TL]
AS 
    SELECT  IdCuenta,
            Descripcion + ' ' + CONVERT(VARCHAR, Codigo) AS [Titulo]
    FROM    Cuentas
    WHERE   IdTipoCuenta = 2
            AND LEN(LTRIM(ISNULL(Descripcion, ''))) > 0
    GROUP BY IdCuenta,
            Codigo,
            Descripcion
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorObraCuentaGasto]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentas_TX_PorObraCuentaGasto]
    @IdObra INT,
    @IdCuentaGasto INT,
    @FechaConsulta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @FechaConsulta = ISNULL(@FechaConsulta, GETDATE())

    CREATE TABLE #Auxiliar1
        (
          IdCuenta INTEGER,
          IdCuentaGasto INTEGER,
          Codigo INTEGER,
          Descripcion VARCHAR(100)
        )
    INSERT  INTO #Auxiliar1
            SELECT  Cuentas.IdCuenta,
                    Cuentas.IdCuentaGasto,
                    ISNULL(( SELECT TOP 1
                                    dc.CodigoAnterior
                             FROM   DetalleCuentas dc
                             WHERE  dc.IdCuenta = Cuentas.IdCuenta
                                    AND dc.FechaCambio > @FechaConsulta
                             ORDER BY dc.FechaCambio
                           ), Cuentas.Codigo),
                    ISNULL(( SELECT TOP 1
                                    dc.NombreAnterior
                             FROM   DetalleCuentas dc
                             WHERE  dc.IdCuenta = Cuentas.IdCuenta
                                    AND dc.FechaCambio > @FechaConsulta
                             ORDER BY dc.FechaCambio
                           ), Cuentas.Descripcion)
            FROM    Cuentas
            WHERE   ( IdTipoCuenta = 2
                      OR IdTipoCuenta = 4
                    )
                    AND IdObra = @IdObra
                    AND IdCuentaGasto = @IdCuentaGasto

    SET NOCOUNT OFF

    SELECT TOP 1
            *
    FROM    #Auxiliar1
    WHERE   LEN(LTRIM(Descripcion)) > 0

    DROP TABLE #Auxiliar1

GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_CuentasGastoPorObraParaCombo]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wCuentas_TX_CuentasGastoPorObraParaCombo]
    @IdObra INT,
    @FechaConsulta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @FechaConsulta = ISNULL(@FechaConsulta, GETDATE())

    CREATE TABLE #Auxiliar1
        (
          IdCuenta INTEGER,
          Codigo INTEGER,
          Descripcion VARCHAR(100)
        )
    INSERT  INTO #Auxiliar1
            SELECT  Cuentas.IdCuenta,
                    ISNULL(( SELECT TOP 1
                                    dc.CodigoAnterior
                             FROM   DetalleCuentas dc
                             WHERE  dc.IdCuenta = Cuentas.IdCuenta
                                    AND dc.FechaCambio > @FechaConsulta
                             ORDER BY dc.FechaCambio
                           ), Cuentas.Codigo),
                    ISNULL(( SELECT TOP 1
                                    dc.NombreAnterior
                             FROM   DetalleCuentas dc
                             WHERE  dc.IdCuenta = Cuentas.IdCuenta
                                    AND dc.FechaCambio > @FechaConsulta
                             ORDER BY dc.FechaCambio
                           ), Cuentas.Descripcion)
            FROM    Cuentas
            WHERE   ( Cuentas.IdTipoCuenta = 2
                      OR Cuentas.IdTipoCuenta = 4
                    )
                    AND IdObra = @IdObra
                    AND Cuentas.IdCuentaGasto IS NOT NULL

    SET NOCOUNT OFF

    SELECT DISTINCT
            Cuentas.IdCuentaGasto,
            CuentasGastos.Descripcion + ' '
            + CONVERT(VARCHAR, #Auxiliar1.Codigo) AS [Titulo] 
--	CuentasGastos.Descripcion as [Titulo]
    FROM    #Auxiliar1
            LEFT OUTER JOIN Cuentas ON #Auxiliar1.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN CuentasGastos ON Cuentas.IdCuentaGasto = CuentasGastos.IdCuentaGasto
    WHERE   LEN(LTRIM(#Auxiliar1.Descripcion)) > 0
            AND LEN(LTRIM(CuentasGastos.Descripcion)) > 0
    ORDER BY CuentasGastos.Descripcion + ' '
            + CONVERT(VARCHAR, #Auxiliar1.Codigo)
--ORDER by CuentasGastos.Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_FondosFijos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentas_TX_FondosFijos] @IdCuentaFF INT = NULL
AS 
    DECLARE @IdTipoCuentaGrupoFF INT
    SET @IdTipoCuentaGrupoFF = ( SELECT TOP 1
                                        Parametros.IdTipoCuentaGrupoFF
                                 FROM   Parametros
                                 WHERE  IdParametro = 1
                               )

    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30)
    SET @vector_X = '011133'
    SET @vector_T = '059500'

    SELECT  IdCuenta,
            Descripcion + ' ' + CONVERT(VARCHAR, Codigo) AS [Titulo],
            IdCuenta AS [IdAux],
            NumeroAuxiliar AS [Prox.Nro.Rend.],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    Cuentas
    WHERE   IdTipoCuentaGrupo = @IdTipoCuentaGrupoFF
            AND ( ISNULL(@IdCuentaFF, -1) = -1
                  OR ISNULL(@IdCuentaFF, -1) = IdCuenta
                )
            AND LEN(LTRIM(Descripcion)) > 0
--GROUP By IdCuenta, Codigo, Descripcion
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wCuentasGastos_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentasGastos_TL]
AS 
    SELECT  IdCuentaGasto,
            Descripcion COLLATE SQL_Latin1_General_CP1_CI_AS + ' '
            + CONVERT(VARCHAR, Codigo COLLATE SQL_Latin1_General_CP1_CI_AS) COLLATE SQL_Latin1_General_CP1_CI_AS AS [Titulo]
    FROM    CuentasGastos
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorCodigo]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentas_TX_PorCodigo]
    @Codigo INT,
    @FechaConsulta DATETIME = NULL
AS 
    SET @FechaConsulta = ISNULL(@FechaConsulta, GETDATE())

    SELECT  Cuentas.*,
            ISNULL(( SELECT TOP 1
                            dc.CodigoAnterior
                     FROM   DetalleCuentas dc
                     WHERE  dc.IdCuenta = Cuentas.IdCuenta
                            AND dc.FechaCambio > @FechaConsulta
                     ORDER BY dc.FechaCambio
                   ), Cuentas.Codigo) AS [Codigo1],
            ISNULL(( SELECT TOP 1
                            dc.NombreAnterior
                     FROM   DetalleCuentas dc
                     WHERE  dc.IdCuenta = Cuentas.IdCuenta
                            AND dc.FechaCambio > @FechaConsulta
                     ORDER BY dc.FechaCambio
                   ), Cuentas.Descripcion) AS [Descripcion1]
    FROM    Cuentas
    WHERE   ISNULL(( SELECT TOP 1
                            dc.CodigoAnterior
                     FROM   DetalleCuentas dc
                     WHERE  dc.IdCuenta = Cuentas.IdCuenta
                            AND dc.FechaCambio > @FechaConsulta
                     ORDER BY dc.FechaCambio
                   ), Cuentas.Codigo) = @Codigo

GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wEmpleados_A]
    @IdEmpleado INT OUTPUT,
    @Legajo INT,
    @Nombre VARCHAR(50)
AS 
    IF ISNULL(@IdEmpleado, 0) <= 0 
        BEGIN
            INSERT  INTO Empleados ( Legajo, Nombre )
            VALUES  ( @Legajo, @Nombre )
	
            SELECT  @IdEmpleado = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  Empleados
            SET     Legajo = @Legajo,
                    Nombre = @Nombre
            WHERE   ( IdEmpleado = @IdEmpleado )
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdEmpleado


GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wEmpleados_E] @IdEmpleado INT
AS 
    DELETE  Empleados
    WHERE   ( IdEmpleado = @IdEmpleado )


GO
/****** Object:  StoredProcedure [dbo].[wDepositosBancarios_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wDepositosBancarios_TX_PorIdConDatos]

@IdDepositoBancario int 

AS 

DECLARE @Valores numeric(18,2)

SET @Valores=IsNull((Select Sum(IsNull(Valores.Importe,0)) From DetalleDepositosBancarios DetDep
			Left Outer Join Valores On Valores.IdValor=DetDep.IdValor
			Where DetDep.IdDepositoBancario=@IdDepositoBancario),0)

SELECT 
 DepositosBancarios.*, 
 @Valores as [Valores],
 IsNull(DepositosBancarios.Efectivo,0)+@Valores as [TotalDeposito],
 CuentasBancarias.Detalle as [CuentaBancaria],
 Bancos.Nombre as [Banco],
 Cajas.Descripcion as [CajaEfectivo],
 Monedas.Abreviatura as [MonedaEfectivo]
FROM DepositosBancarios
LEFT OUTER JOIN CuentasBancarias ON CuentasBancarias.IdCuentaBancaria=DepositosBancarios.IdCuentaBancaria
LEFT OUTER JOIN Bancos ON Bancos.IdBanco=DepositosBancarios.IdBanco
LEFT OUTER JOIN Cajas ON Cajas.IdCaja=DepositosBancarios.IdCaja
LEFT OUTER JOIN Monedas ON Monedas.IdMoneda=DepositosBancarios.IdMonedaEfectivo
WHERE DepositosBancarios.IdDepositoBancario=@IdDepositoBancario

GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wEmpleados_T] @IdEmpleado INT = NULL
AS 
    SET @IdEmpleado = ISNULL(@IdEmpleado, -1)

    SELECT  Empleados.*,
            Sectores.Descripcion AS [Sector],
            Cargos.Descripcion AS [Cargo],
            Cuentas.Descripcion AS [FF_Asignado],
            Obras.NumeroObra AS [ObraAsignada]
    FROM    Empleados
            LEFT OUTER JOIN Sectores ON Empleados.IdSector = Sectores.IdSector
            LEFT OUTER JOIN Cargos ON Empleados.IdCargo = Cargos.IdCargo
            LEFT OUTER JOIN Cuentas ON Empleados.IdCuentaFondoFijo = Cuentas.IdCuenta
            LEFT OUTER JOIN Obras ON Empleados.IdObraAsignada = Obras.IdObra
    WHERE   @IdEmpleado = -1
            OR Empleados.IdEmpleado = @IdEmpleado


GO
/****** Object:  StoredProcedure [dbo].[wDescripcionIva_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wDescripcionIva_TL]
AS 
SELECT IdCodigoIva, Descripcion as [Titulo]
FROM DescripcionIva 
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wEmpleados_TL]
AS 
    SELECT  IdEmpleado,
            Nombre AS [Titulo]
    FROM    Empleados
    WHERE   ISNULL(Activo, 'SI') = 'SI'
    ORDER BY Nombre


GO
/****** Object:  StoredProcedure [dbo].[wEmpleados_TX_UsuarioNT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wEmpleados_TX_UsuarioNT] @UsuarioNT VARCHAR(50)
AS 
    SELECT  *
    FROM    Empleados
    WHERE   UsuarioNT = @UsuarioNT
            AND ISNULL(Activo, 'SI') = 'SI'

GO
/****** Object:  StoredProcedure [dbo].[wSectores_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wSectores_TL]
AS 
    SELECT  IdSector,
            Descripcion AS [Titulo]
    FROM    Sectores
    ORDER BY Descripcion


GO
/****** Object:  StoredProcedure [dbo].[wUnidades_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wUnidades_TL]
AS 
    SELECT  IdUnidad,
            Descripcion AS [Titulo]
    FROM    Unidades
    ORDER BY Descripcion


GO
/****** Object:  StoredProcedure [dbo].[wParametros_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wParametros_T]
AS 
    SELECT  *
    FROM    Parametros
    WHERE   ( IdParametro = 1 )


GO
/****** Object:  StoredProcedure [dbo].[wTiposComprobante_TX_ParaComboProveedores]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wTiposComprobante_TX_ParaComboProveedores]
AS 
    SELECT  IdTipoComprobante,
            DescripcionAb + '  ' + Descripcion AS Titulo
    FROM    TiposComprobante
    WHERE   Agrupacion1 = 'PROVEEDORES'
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wObras_TX_DestinosParaComboPorIdObra]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wObras_TX_DestinosParaComboPorIdObra] @IdObra INT
AS 
    SELECT  IdDetalleObraDestino,
            Destino + ' - ' + CONVERT(VARCHAR(60), ISNULL(Detalle, '')) AS [Titulo]
    FROM    DetalleObrasDestinos
    WHERE   @IdObra = -1
            OR IdObra = @IdObra
    ORDER BY Destino

GO
/****** Object:  StoredProcedure [dbo].[wObras_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wObras_TL]
AS 
    SELECT  IdObra
--,NumeroObra as [Titulo]  --version original
            ,
            NumeroObra + ' - ' + Descripcion AS [Titulo] --version mariano 
    FROM    Obras
    WHERE   Obras.FechaFinalizacion IS NULL
            AND Obras.Jerarquia IS NOT NULL
    ORDER BY NumeroObra

GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wDetPedidos_A]

@IdDetallePedido int,
@IdPedido int,
@NumeroItem int,
@Cantidad numeric(12,2),
@IdUnidad int,
@IdArticulo int,
@FechaEntrega datetime,
@Precio numeric(12,4),
@Observaciones ntext,
@IdDetalleAcopios int,
@IdDetalleRequerimiento int,
@Cumplido varchar(2),
@FechaNecesidad datetime,
@IdDetalleLMateriales int,
@IdCuenta int,
@OrigenDescripcion int,
@IdAutorizoCumplido int,
@IdDioPorCumplido int,
@FechaDadoPorCumplido datetime,
@ObservacionesCumplido ntext,
@PorcentajeBonificacion numeric(6,2),
@ImporteBonificacion numeric(18,4),
@PorcentajeIVA numeric(6,2),
@ImporteIVA numeric(18,4),
@ImporteTotalItem numeric(18,4),
@Costo numeric(18,2),
@IdAsignacionCosto int,
@CostoAsignado numeric(18,4),
@IdUsuarioAsignoCosto int,
@FechaAsignacionCosto datetime,
@IdDetallePedidoOriginal int,
@IdPedidoOriginal int,
@IdOrigenTransmision int,
@PlazoEntrega varchar(50),
@CostoAsignadoDolar numeric(18,4),
@IdDetalleComparativa int,
@IdDetalleRequerimientoOriginal int

AS 

IF IsNull(@IdDetallePedido,0)<=0
    BEGIN
	INSERT INTO [DetallePedidos]
	(
	 IdPedido,
	 NumeroItem,
	 Cantidad,
	 IdUnidad,
	 IdArticulo,
	 FechaEntrega,
	 Precio,
	 Observaciones,
	 IdDetalleAcopios,
	 IdDetalleRequerimiento,
	 Cumplido,
	 FechaNecesidad,
	 IdDetalleLMateriales,
	 IdCuenta,
	 OrigenDescripcion,
	 IdAutorizoCumplido,
	 IdDioPorCumplido,
	 FechaDadoPorCumplido,
	 ObservacionesCumplido,
	 PorcentajeBonificacion,
	 ImporteBonificacion,
	 PorcentajeIVA,
	 ImporteIVA,
	 ImporteTotalItem,
	 Costo,
	 IdAsignacionCosto,
	 CostoAsignado,
	 IdUsuarioAsignoCosto,
	 FechaAsignacionCosto,
	 IdDetallePedidoOriginal,
	 IdPedidoOriginal,
	 IdOrigenTransmision,
	 PlazoEntrega,
	 CostoAsignadoDolar,
	 IdDetalleComparativa,
	 IdDetalleRequerimientoOriginal
	)
	VALUES
	(
	 @IdPedido,
	 @NumeroItem,
	 @Cantidad,
	 @IdUnidad,
	 @IdArticulo,
	 @FechaEntrega,
	 @Precio,
	 @Observaciones,
	 @IdDetalleAcopios,
	 @IdDetalleRequerimiento,
	 @Cumplido,
	 @FechaNecesidad,
	 @IdDetalleLMateriales,
	 @IdCuenta,
	 @OrigenDescripcion,
	 @IdAutorizoCumplido,
	 @IdDioPorCumplido,
	 @FechaDadoPorCumplido,
	 @ObservacionesCumplido,
	 @PorcentajeBonificacion,
	 @ImporteBonificacion,
	 @PorcentajeIVA,
	 @ImporteIVA,
	 @ImporteTotalItem,
	 @Costo,
	 @IdAsignacionCosto,
	 @CostoAsignado,
	 @IdUsuarioAsignoCosto,
	 @FechaAsignacionCosto,
	 @IdDetallePedidoOriginal,
	 @IdPedidoOriginal,
	 @IdOrigenTransmision,
	 @PlazoEntrega,
	 @CostoAsignadoDolar,
	 @IdDetalleComparativa,
	 @IdDetalleRequerimientoOriginal
	)
	SELECT @IdDetallePedido=@@identity
    END
ELSE
    BEGIN
	UPDATE [DetallePedidos]
	SET 
	 IdPedido=@IdPedido,
	 NumeroItem=@NumeroItem,
	 Cantidad=@Cantidad,
	 IdUnidad=@IdUnidad,
	 IdArticulo=@IdArticulo,
	 FechaEntrega=@FechaEntrega,
	 Precio=@Precio,
	 Observaciones=@Observaciones,
	 IdDetalleAcopios=@IdDetalleAcopios,
	 IdDetalleRequerimiento=@IdDetalleRequerimiento,
	 Cumplido=@Cumplido,
	 FechaNecesidad=@FechaNecesidad,
	 IdDetalleLMateriales=@IdDetalleLMateriales,
	 IdCuenta=@IdCuenta,
	 OrigenDescripcion=@OrigenDescripcion,
	 IdAutorizoCumplido=@IdAutorizoCumplido,
	 IdDioPorCumplido=@IdDioPorCumplido,
	 FechaDadoPorCumplido=@FechaDadoPorCumplido,
	 ObservacionesCumplido=@ObservacionesCumplido,
	 PorcentajeBonificacion=@PorcentajeBonificacion,
	 ImporteBonificacion=@ImporteBonificacion,
	 PorcentajeIVA=@PorcentajeIVA,
	 ImporteIVA=@ImporteIVA,
	 ImporteTotalItem=@ImporteTotalItem,
	 Costo=@Costo,
	 IdAsignacionCosto=@IdAsignacionCosto,
	 CostoAsignado=@CostoAsignado,
	 IdUsuarioAsignoCosto=@IdUsuarioAsignoCosto,
	 FechaAsignacionCosto=@FechaAsignacionCosto,
	 IdDetallePedidoOriginal=@IdDetallePedidoOriginal,
	 IdPedidoOriginal=@IdPedidoOriginal,
	 IdOrigenTransmision=@IdOrigenTransmision,
	 PlazoEntrega=@PlazoEntrega,
	 CostoAsignadoDolar=@CostoAsignadoDolar,
	 IdDetalleComparativa=@IdDetalleComparativa,
	 IdDetalleRequerimientoOriginal=@IdDetalleRequerimientoOriginal
	WHERE (IdDetallePedido=@IdDetallePedido)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdDetallePedido



GO
/****** Object:  StoredProcedure [dbo].[wObras_TX_PorIdCuentaFFParaCombo]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wObras_TX_PorIdCuentaFFParaCombo]
    @IdCuentaContableFF INT
AS 
    SELECT  IdObra
--,NumeroObra as [Titulo]  --version original
            ,
            NumeroObra + ' - ' + Descripcion AS [Titulo]
    FROM    Obras
    WHERE   ( IdCuentaContableFF = @IdCuentaContableFF )

GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wDetPedidos_E]

@IdDetallePedido int  

AS 

DELETE [DetallePedidos]
WHERE (IdDetallePedido=@IdDetallePedido)



GO
/****** Object:  StoredProcedure [dbo].[wCotizaciones_TX_PorFechaMoneda]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCotizaciones_TX_PorFechaMoneda]
    @Fecha DATETIME,
    @IdMoneda INT
AS 
    SELECT TOP 1
            *
    FROM    Cotizaciones
    WHERE   Fecha = @Fecha
            AND IdMoneda = @IdMoneda

GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wDetPedidos_T]

@IdDetallePedido int

AS 

SELECT *
FROM [DetallePedidos]
WHERE (IdDetallePedido=@IdDetallePedido)



GO
/****** Object:  StoredProcedure [dbo].[wCuentas_TX_PorId]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wCuentas_TX_PorId] @IdCuenta INT
AS 
    SELECT  Cuentas.*,
            TiposCuentaGrupos.EsCajaBanco
    FROM    Cuentas
            LEFT OUTER JOIN TiposCuentaGrupos ON TiposCuentaGrupos.IdTipoCuentaGrupo = Cuentas.IdTipoCuentaGrupo
    WHERE   ( IdCuenta = @IdCuenta )

GO
/****** Object:  StoredProcedure [dbo].[wDetPedidos_TT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[wDetPedidos_TT]

@IdPedido int

AS

SELECT
 DetPed.*,
 Unidades.Abreviatura as  [Unidad],
 ControlesCalidad.Descripcion as [ControlCalidad],
 A1.Codigo as [Codigo],
 A1.Descripcion as [Articulo],
 IsNull(Acopios.IdObra,Requerimientos.IdObra) as [IdObra],
 Obras.NumeroObra,
 Acopios.NumeroAcopio as [NumeroAcopio],
 DetalleAcopios.NumeroItem as [ItemAcopio],
 Requerimientos.NumeroRequerimiento as [NumeroRequerimiento],
 DetalleRequerimientos.NumeroItem as [ItemRequerimiento],
 Clientes.RazonSocial as [Cliente],
 E1.Nombre as [CostoAsignadoPor],
 E1.Nombre as [RMSolicitadaPor],
 A2.Codigo as [CodigoEquipoDestino],
 A2.Descripcion as [EquipoDestino]
FROM DetallePedidos DetPed
LEFT OUTER JOIN ControlesCalidad ON DetPed.IdControlCalidad = ControlesCalidad.IdControlCalidad
LEFT OUTER JOIN DetalleAcopios ON DetPed.IdDetalleAcopios = DetalleAcopios.IdDetalleAcopios
LEFT OUTER JOIN Acopios ON DetalleAcopios.IdAcopio = Acopios.IdAcopio
LEFT OUTER JOIN DetalleRequerimientos ON DetPed.IdDetalleRequerimiento = DetalleRequerimientos.IdDetalleRequerimiento
LEFT OUTER JOIN Requerimientos ON DetalleRequerimientos.IdRequerimiento = Requerimientos.IdRequerimiento
LEFT OUTER JOIN Articulos A1 ON DetPed.IdArticulo = A1.IdArticulo
LEFT OUTER JOIN Articulos A2 ON DetalleRequerimientos.IdEquipoDestino = A2.IdArticulo
LEFT OUTER JOIN Empleados E1 ON DetPed.IdUsuarioAsignoCosto = E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
LEFT OUTER JOIN Unidades ON DetPed.IdUnidad = Unidades.IdUnidad
LEFT OUTER JOIN Obras ON IsNull(Acopios.IdObra,Requerimientos.IdObra)= Obras.IdObra
LEFT OUTER JOIN Clientes ON Obras.IdCliente= Clientes.IdCliente
WHERE (DetPed.IdPedido = @IdPedido)
ORDER by DetPed.NumeroItem



GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TX_UltimoComprobantePorIdProveedor]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [wComprobantesProveedores_TX_UltimoComprobantePorIdProveedor] @IdProveedor INT
AS 
    SELECT TOP 1
            *
    FROM    ComprobantesProveedores cp
    WHERE   cp.IdProveedor = @IdProveedor
            OR cp.IdProveedorEventual = @IdProveedor
    ORDER BY cp.FechaComprobante DESC,
            cp.NumeroComprobante2 DESC


GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_TX_ResumenPorIdCuenta]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wFondosFijos_TX_ResumenPorIdCuenta @IdCuentaFF INT
AS 
    SET NOCOUNT ON

    DECLARE @IdTipoCuentaGrupoFF INT
    SET @IdTipoCuentaGrupoFF = ISNULL(( SELECT TOP 1
                                                IdTipoCuentaGrupoFF
                                        FROM    Parametros
                                        WHERE   IdParametro = 1
                                      ), 0)

    CREATE TABLE #Auxiliar1
        (
          IdCuenta INTEGER,
          Descripcion VARCHAR(100),
          NumeroRendicion INTEGER,
          FondosAsignados NUMERIC(18, 2),
          ReposicionSolicitada NUMERIC(18, 2),
          RendicionesReintegradas NUMERIC(18, 2),
          PagosPendientesReintegrar NUMERIC(18, 2)
        )
    INSERT  INTO #Auxiliar1
            SELECT  Cuentas.IdCuenta,
                    Cuentas.Descripcion + ' ' + CONVERT(VARCHAR, Codigo),
                    Cuentas.NumeroAuxiliar,
                    ISNULL(( SELECT SUM(ISNULL(op.Valores, 0))
                             FROM   OrdenesPago op
                             WHERE  ISNULL(op.IdCuenta, 0) = Cuentas.IdCuenta
                                    AND ISNULL(op.NumeroRendicionFF, 0) = 0
                                    AND ISNULL(op.OPInicialFF, 'NO') = 'SI'
                           ), 0) AS [Fondo asignado],
                    ISNULL(( SELECT SUM(ISNULL(cp.TotalComprobante, 0))
                             FROM   ComprobantesProveedores cp
                             WHERE  ISNULL(cp.Confirmado, 'SI') = 'SI'
                                    AND ISNULL(cp.IdCuenta, 0) = Cuentas.IdCuenta
                                    AND ISNULL(cp.NumeroRendicionFF, 0) = Cuentas.NumeroAuxiliar
                           ), 0) AS [Reposicion solicitada],
                    ( SELECT    SUM(ISNULL(op.Valores, 0))
                      FROM      OrdenesPago op
                      WHERE     ISNULL(op.IdCuenta, 0) = Cuentas.IdCuenta
                                AND ISNULL(op.NumeroRendicionFF, 0) = Cuentas.NumeroAuxiliar
                                AND ISNULL(op.ConfirmacionAcreditacionFF, 'NO') = 'SI'
                    ) AS [Rendiciones reintegradas],
                    ( SELECT    SUM(ISNULL(op.Valores, 0))
                      FROM      OrdenesPago op
                      WHERE     ISNULL(op.IdCuenta, 0) = Cuentas.IdCuenta
                                AND ISNULL(op.NumeroRendicionFF, 0) = Cuentas.NumeroAuxiliar
                                AND ISNULL(op.ConfirmacionAcreditacionFF, 'NO') = 'NO'
                    ) AS [Pagos pendientes de reintegrar]
            FROM    Cuentas
            WHERE   Cuentas.IdTipoCuentaGrupo = @IdTipoCuentaGrupoFF
                    AND LEN(LTRIM(ISNULL(Cuentas.Descripcion, ''))) > 0 

    SET NOCOUNT OFF

    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50) 
    SET @vector_X = '0111111133' 
    SET @vector_T = '0028888800' 

    SELECT  IdCuenta,
            Descripcion AS [Cuenta FF],
            NumeroRendicion AS [Rendicion],
            FondosAsignados AS [Fondos asignados],
            ReposicionSolicitada AS [Reposicion solicitada],
            RendicionesReintegradas AS [Rendiciones reintegradas],
            ISNULL(FondosAsignados, 0) - ISNULL(ReposicionSolicitada, 0)
            + ISNULL(RendicionesReintegradas, 0) AS [Saldo],
            PagosPendientesReintegrar AS [PagosPendientesReintegrar],
            @Vector_T AS [Vector_T],
            @Vector_X AS [Vector_X]
    FROM    #Auxiliar1
    WHERE   IdCuenta = @IdCuentaFF
    ORDER BY Descripcion

    DROP TABLE #Auxiliar1

GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_TX_RendicionesPorIdCuentaParaCombo]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wFondosFijos_TX_RendicionesPorIdCuentaParaCombo @IdCuentaFF INT
AS 
    SET NOCOUNT ON

    SELECT DISTINCT
            cp.NumeroRendicionFF,
            cp.NumeroRendicionFF AS [Titulo]
    FROM    ComprobantesProveedores cp
            LEFT OUTER JOIN Cuentas ON cp.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN CuentasGastos ON Cuentas.IdCuentaGasto = CuentasGastos.IdCuentaGasto



GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE wPresupuestos_A
    @IdPresupuesto INT,
    @Numero INT,
    @IdProveedor INT,
    @FechaIngreso DATETIME,
    @Observaciones NTEXT,
    @Bonificacion NUMERIC(6, 2),
    @Plazo VARCHAR(50),
    @validez VARCHAR(50),
    @IdCondicionCompra INT,
    @Garantia VARCHAR(50),
    @LugarEntrega VARCHAR(50),
    @IdComprador INT,
    @Referencia VARCHAR(50),
    @PorcentajeIva1 NUMERIC(6, 2),
    @PorcentajeIva2 NUMERIC(6, 2),
    @Detalle VARCHAR(100),
    @Contacto VARCHAR(50),
    @ImporteBonificacion MONEY,
    @ImporteIva1 MONEY,
    @ImporteTotal MONEY,
    @SubNumero INT,
    @Aprobo INT,
    @IdMoneda INT,
    @FechaAprobacion DATETIME,
    @DetalleCondicionCompra VARCHAR(200),
    @ArchivoAdjunto1 VARCHAR(100),
    @ArchivoAdjunto2 VARCHAR(100),
    @ArchivoAdjunto3 VARCHAR(100),
    @ArchivoAdjunto4 VARCHAR(100),
    @ArchivoAdjunto5 VARCHAR(100),
    @ArchivoAdjunto6 VARCHAR(100),
    @ArchivoAdjunto7 VARCHAR(100),
    @ArchivoAdjunto8 VARCHAR(100),
    @ArchivoAdjunto9 VARCHAR(100),
    @ArchivoAdjunto10 VARCHAR(100),
    @IdPlazoEntrega INT,
    @CotizacionMoneda NUMERIC(18, 3),
    @CircuitoFirmasCompleto VARCHAR(2),
    @ConfirmadoPorWeb VARCHAR(2),
    @FechaCierreCompulsa DATETIME,
    @NombreUsuarioWeb NVARCHAR(256),
    @FechaRespuestaweb DATETIME
AS 
    IF ISNULL(@IdPresupuesto, 0) <= 0 
        BEGIN 
            INSERT  INTO Presupuestos
                    (
                      Numero,
                      IdProveedor,
                      FechaIngreso,
                      Observaciones,
                      Bonificacion,
                      Plazo,
                      validez,
                      IdCondicionCompra,
                      Garantia,
                      LugarEntrega,
                      IdComprador,
                      Referencia,
                      PorcentajeIva1,
                      PorcentajeIva2,
                      Detalle,
                      Contacto,
                      ImporteBonificacion,
                      ImporteIva1,
                      ImporteTotal,
                      SubNumero,
                      Aprobo,
                      IdMoneda,
                      FechaAprobacion,
                      DetalleCondicionCompra,
                      ArchivoAdjunto1,
                      ArchivoAdjunto2,
                      ArchivoAdjunto3,
                      ArchivoAdjunto4,
                      ArchivoAdjunto5,
                      ArchivoAdjunto6,
                      ArchivoAdjunto7,
                      ArchivoAdjunto8,
                      ArchivoAdjunto9,
                      ArchivoAdjunto10,
                      IdPlazoEntrega,
                      CotizacionMoneda,
                      CircuitoFirmasCompleto,
                      ConfirmadoPorWeb,
                      FechaCierreCompulsa,
                      NombreUsuarioWeb,
                      FechaRespuestaweb
			  )
            VALUES  (
                      @Numero,
                      @IdProveedor,
                      @FechaIngreso,
                      @Observaciones,
                      @Bonificacion,
                      @Plazo,
                      @validez,
                      @IdCondicionCompra,
                      @Garantia,
                      @LugarEntrega,
                      @IdComprador,
                      @Referencia,
                      @PorcentajeIva1,
                      @PorcentajeIva2,
                      @Detalle,
                      @Contacto,
                      @ImporteBonificacion,
                      @ImporteIva1,
                      @ImporteTotal,
                      @SubNumero,
                      @Aprobo,
                      @IdMoneda,
                      @FechaAprobacion,
                      @DetalleCondicionCompra,
                      @ArchivoAdjunto1,
                      @ArchivoAdjunto2,
                      @ArchivoAdjunto3,
                      @ArchivoAdjunto4,
                      @ArchivoAdjunto5,
                      @ArchivoAdjunto6,
                      @ArchivoAdjunto7,
                      @ArchivoAdjunto8,
                      @ArchivoAdjunto9,
                      @ArchivoAdjunto10,
                      @IdPlazoEntrega,
                      @CotizacionMoneda,
                      @CircuitoFirmasCompleto,
                      @ConfirmadoPorWeb,
                      @FechaCierreCompulsa,
                      @NombreUsuarioWeb,
                      @FechaRespuestaweb 
			  )
            SELECT  @IdPresupuesto = @@identity
            RETURN ( @IdPresupuesto )
        END
    ELSE 
        BEGIN
            UPDATE  Presupuestos
            SET     Numero = @Numero,
                    IdProveedor = @IdProveedor,
                    FechaIngreso = @FechaIngreso,
                    Observaciones = @Observaciones,
                    Bonificacion = @Bonificacion,
                    Plazo = @Plazo,
                    validez = @validez,
                    IdCondicionCompra = @IdCondicionCompra,
                    Garantia = @Garantia,
                    LugarEntrega = @LugarEntrega,
                    IdComprador = @IdComprador,
                    Referencia = @Referencia,
                    PorcentajeIva1 = @PorcentajeIva1,
                    PorcentajeIva2 = @PorcentajeIva2,
                    Detalle = @Detalle,
                    Contacto = @Contacto,
                    ImporteBonificacion = @ImporteBonificacion,
                    ImporteIva1 = @ImporteIva1,
                    ImporteTotal = @ImporteTotal,
                    SubNumero = @SubNumero,
                    Aprobo = @Aprobo,
                    IdMoneda = @IdMoneda,
                    FechaAprobacion = @FechaAprobacion,
                    DetalleCondicionCompra = @DetalleCondicionCompra,
                    ArchivoAdjunto1 = @ArchivoAdjunto1,
                    ArchivoAdjunto2 = @ArchivoAdjunto2,
                    ArchivoAdjunto3 = @ArchivoAdjunto3,
                    ArchivoAdjunto4 = @ArchivoAdjunto4,
                    ArchivoAdjunto5 = @ArchivoAdjunto5,
                    ArchivoAdjunto6 = @ArchivoAdjunto6,
                    ArchivoAdjunto7 = @ArchivoAdjunto7,
                    ArchivoAdjunto8 = @ArchivoAdjunto8,
                    ArchivoAdjunto9 = @ArchivoAdjunto9,
                    ArchivoAdjunto10 = @ArchivoAdjunto10,
                    IdPlazoEntrega = @IdPlazoEntrega,
                    CotizacionMoneda = @CotizacionMoneda,
                    CircuitoFirmasCompleto = @CircuitoFirmasCompleto,
                    ConfirmadoPorWeb = @ConfirmadoPorWeb,
                    FechaCierreCompulsa = @FechaCierreCompulsa,
                    NombreUsuarioWeb = @NombreUsuarioWeb,
                    FechaRespuestaweb = @FechaRespuestaweb
            WHERE   ( IdPresupuesto = @IdPresupuesto )
            RETURN ( @IdPresupuesto )
        END


GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wPresupuestos_E @IdPresupuesto INT
AS 
    DELETE  Presupuestos
    WHERE   ( IdPresupuesto = @IdPresupuesto )

GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wPresupuestos_T
    @IdPresupuesto INT = NULL
AS 
    SET @IdPresupuesto = ISNULL(@IdPresupuesto, -1)

    SELECT  *,
            Proveedores.RazonSocial AS [Proveedor]
    FROM    Presupuestos Cab
            LEFT OUTER JOIN Proveedores ON Cab.IdProveedor = Proveedores.IdProveedor
    WHERE   ( @IdPresupuesto = -1
              OR IdPresupuesto = @IdPresupuesto
            )
    ORDER BY idPresupuesto DESC


GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_TT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  Procedure [dbo].[wPresupuestos_TT]

AS

SET NOCOUNT ON

CREATE TABLE #Auxiliar1	
			(
			 IdPresupuesto INTEGER,
			 IdRequerimiento INTEGER
			)
INSERT INTO #Auxiliar1 
 SELECT DISTINCT
  dp.IdPresupuesto,
  dr.IdRequerimiento
 FROM DetallePresupuestos dp
 LEFT OUTER JOIN Presupuestos pr ON dp.IdPresupuesto=pr.IdPresupuesto
 LEFT OUTER JOIN DetalleRequerimientos dr ON dp.IdDetalleRequerimiento=dr.IdDetalleRequerimiento

SET NOCOUNT OFF

Declare @vector_X varchar(30),@vector_T varchar(30)
Set @vector_X='01111111111111111111133'
Set @vector_T='06003423355555553339500'

SELECT 
	Presupuestos.IdPresupuesto,
	Presupuestos.Numero as [Numero Presupuesto],
	Presupuestos.SubNumero as [Orden],
	Case 	When IsNull((Select Count(*) From #Auxiliar1 
				Where #Auxiliar1.IdPresupuesto=Presupuestos.IdPresupuesto),0)=0
		 Then Null
		When IsNull((Select Count(*) From #Auxiliar1 
				Where #Auxiliar1.IdPresupuesto=Presupuestos.IdPresupuesto),0)=1
		 Then Convert(varchar,
			IsNull((Select Top 1 Requerimientos.NumeroRequerimiento
				From #Auxiliar1
				Left Outer Join Requerimientos On #Auxiliar1.IdRequerimiento=Requerimientos.IdRequerimiento
				Where #Auxiliar1.IdPresupuesto=Presupuestos.IdPresupuesto),0))
		 Else 'Varias'
	End as [RM],
	Proveedores.RazonSocial as [Razon social], 
	Presupuestos.FechaIngreso as [Fecha], 
	Presupuestos.Validez as [Validez],
	Presupuestos.Bonificacion as [Bonificacion],
	Presupuestos.Plazo as [Plazo],
	[Condiciones Compra].Descripcion as [Cond. de compra],
	Presupuestos.Garantia as [Garantia],
	Presupuestos.LugarEntrega as [LugarEntrega],
	Empleados.Nombre as [Comprador],
	Presupuestos.Referencia as [Referencia],
	Presupuestos.Detalle as [Detalle],
	Presupuestos.Contacto as [Contacto],
	Presupuestos.ImporteBonificacion as [Bonificacion],
	Presupuestos.ImporteIva1 as [Iva],
	Presupuestos.ImporteTotal as [Total],
	Presupuestos.IdPresupuesto as [IdAux],
	Presupuestos.Aprobo,
	presupuestos.ConfirmadoPorWeb,
	(Select Count(*) From DetallePresupuestos dp 
	 Where dp.IdPresupuesto=Presupuestos.IdPresupuesto) as [Cant.Items],
	@Vector_T as Vector_T,
	@Vector_X as Vector_X
FROM Presupuestos
LEFT OUTER JOIN Proveedores ON Presupuestos.IdProveedor = Proveedores.IdProveedor
LEFT OUTER JOIN [Condiciones Compra] ON Presupuestos.IdCondicionCompra = [Condiciones Compra].IdCondicionCompra
LEFT OUTER JOIN Empleados ON Presupuestos.IdComprador = Empleados.IdEmpleado
ORDER BY Presupuestos.FechaIngreso Desc, 
	Presupuestos.Numero Desc, 
	Presupuestos.SubNumero Desc

DROP TABLE #Auxiliar1


GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE wDetPresupuestos_A
    @IdDetallePresupuesto INT ,
    @IdPresupuesto INT,
    @NumeroItem INT,
    @IdArticulo INT,
    @Cantidad NUMERIC(12, 2),
    @IdUnidad INT,
    @Precio NUMERIC(12, 4),
    @Adjunto VARCHAR(2),
    @ArchivoAdjunto VARCHAR(50),
    @Cantidad1 NUMERIC(18, 2),
    @Cantidad2 NUMERIC(18, 2),
    @Observaciones NTEXT,
    @IdDetalleAcopios INT,
    @IdDetalleRequerimiento INT,
    @OrigenDescripcion INT,
    @IdDetalleLMateriales INT,
    @IdCuenta INT,
    @ArchivoAdjunto1 VARCHAR(100),
    @ArchivoAdjunto2 VARCHAR(100),
    @ArchivoAdjunto3 VARCHAR(100),
    @ArchivoAdjunto4 VARCHAR(100),
    @ArchivoAdjunto5 VARCHAR(100),
    @ArchivoAdjunto6 VARCHAR(100),
    @ArchivoAdjunto7 VARCHAR(100),
    @ArchivoAdjunto8 VARCHAR(100),
    @ArchivoAdjunto9 VARCHAR(100),
    @ArchivoAdjunto10 VARCHAR(100),
    @FechaEntrega DATETIME,
    @IdCentroCosto INT,
    @PorcentajeBonificacion NUMERIC(6, 2),
    @ImporteBonificacion NUMERIC(18, 4),
    @PorcentajeIVA NUMERIC(6, 2),
    @ImporteIVA NUMERIC(18, 4),
    @ImporteTotalItem NUMERIC(18, 4)
AS 
    IF ISNULL(@IdDetallePresupuesto, 0) <= 0 
        BEGIN   
            INSERT  INTO [DetallePresupuestos]
                    (
                      IdPresupuesto,
                      NumeroItem,
                      IdArticulo,
                      Cantidad,
                      IdUnidad,
                      Precio,
                      Adjunto,
                      ArchivoAdjunto,
                      Cantidad1,
                      Cantidad2,
                      Observaciones,
                      IdDetalleAcopios,
                      IdDetalleRequerimiento,
                      OrigenDescripcion,
                      IdDetalleLMateriales,
                      IdCuenta,
                      ArchivoAdjunto1,
                      ArchivoAdjunto2,
                      ArchivoAdjunto3,
                      ArchivoAdjunto4,
                      ArchivoAdjunto5,
                      ArchivoAdjunto6,
                      ArchivoAdjunto7,
                      ArchivoAdjunto8,
                      ArchivoAdjunto9,
                      ArchivoAdjunto10,
                      FechaEntrega,
                      IdCentroCosto,
                      PorcentajeBonificacion,
                      ImporteBonificacion,
                      PorcentajeIVA,
                      ImporteIVA,
                      ImporteTotalItem
		        )
            VALUES  (
                      @IdPresupuesto,
                      @NumeroItem,
                      @IdArticulo,
                      @Cantidad,
                      @IdUnidad,
                      @Precio,
                      @Adjunto,
                      @ArchivoAdjunto,
                      @Cantidad1,
                      @Cantidad2,
                      @Observaciones,
                      @IdDetalleAcopios,
                      @IdDetalleRequerimiento,
                      @OrigenDescripcion,
                      @IdDetalleLMateriales,
                      @IdCuenta,
                      @ArchivoAdjunto1,
                      @ArchivoAdjunto2,
                      @ArchivoAdjunto3,
                      @ArchivoAdjunto4,
                      @ArchivoAdjunto5,
                      @ArchivoAdjunto6,
                      @ArchivoAdjunto7,
                      @ArchivoAdjunto8,
                      @ArchivoAdjunto9,
                      @ArchivoAdjunto10,
                      @FechaEntrega,
                      @IdCentroCosto,
                      @PorcentajeBonificacion,
                      @ImporteBonificacion,
                      @PorcentajeIVA,
                      @ImporteIVA,
                      @ImporteTotalItem
		        )
            SELECT  @IdDetallePresupuesto = @@identity
            RETURN ( @IdDetallePresupuesto )

        END 
    ELSE 
        BEGIN
            UPDATE  [DetallePresupuestos]
            SET     IdPresupuesto = @IdPresupuesto,
                    NumeroItem = @NumeroItem,
                    IdArticulo = @IdArticulo,
                    Cantidad = @Cantidad,
                    IdUnidad = @IdUnidad,
                    Precio = @Precio,
                    Adjunto = @Adjunto,
                    ArchivoAdjunto = @ArchivoAdjunto,
                    Cantidad1 = @Cantidad1,
                    Cantidad2 = @Cantidad2,
                    Observaciones = @Observaciones,
                    IdDetalleAcopios = @IdDetalleAcopios,
                    IdDetalleRequerimiento = @IdDetalleRequerimiento,
                    OrigenDescripcion = @OrigenDescripcion,
                    IdDetalleLMateriales = @IdDetalleLMateriales,
                    IdCuenta = @IdCuenta,
                    ArchivoAdjunto1 = @ArchivoAdjunto1,
                    ArchivoAdjunto2 = @ArchivoAdjunto2,
                    ArchivoAdjunto3 = @ArchivoAdjunto3,
                    ArchivoAdjunto4 = @ArchivoAdjunto4,
                    ArchivoAdjunto5 = @ArchivoAdjunto5,
                    ArchivoAdjunto6 = @ArchivoAdjunto6,
                    ArchivoAdjunto7 = @ArchivoAdjunto7,
                    ArchivoAdjunto8 = @ArchivoAdjunto8,
                    ArchivoAdjunto9 = @ArchivoAdjunto9,
                    ArchivoAdjunto10 = @ArchivoAdjunto10,
                    FechaEntrega = @FechaEntrega,
                    IdCentroCosto = @IdCentroCosto,
                    PorcentajeBonificacion = @PorcentajeBonificacion,
                    ImporteBonificacion = @ImporteBonificacion,
                    PorcentajeIVA = @PorcentajeIVA,
                    ImporteIVA = @ImporteIVA,
                    ImporteTotalItem = @ImporteTotalItem
            WHERE   ( IdDetallePresupuesto = @IdDetallePresupuesto )
            RETURN ( @IdDetallePresupuesto )

        END 



GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE wDetPresupuestos_E
    @IdDetallePresupuesto INT
AS 
    DELETE  [DetallePresupuestos]
    WHERE   ( IdDetallePresupuesto = @IdDetallePresupuesto )


GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wDetPresupuestos_T
    @IdDetallePresupuesto INT
AS 
    SELECT  *
    FROM    [DetallePresupuestos]
    WHERE   ( IdDetallePresupuesto = @IdDetallePresupuesto )

GO
/****** Object:  StoredProcedure [dbo].[wDetPresupuestos_TT]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetPresupuestos_TT] @IdPresupuesto INT
AS 
    SELECT  Det.*,
            Articulos.Descripcion AS [Articulo]
    FROM    DetallePresupuestos Det --LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento=DetReq.IdRequerimiento
            LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
--LEFT OUTER JOIN CuentasGastos ON (Det.IdCuentaGasto = CuentasGastos.IdCuentaGasto)
--LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
--LEFT OUTER JOIN Obras ON Cab.IdObra = Obras.IdObra
--LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
--LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
--LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
--LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
--LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
--LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
--LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
--LEFT OUTER JOIN Proveedores ON DetReq.IdProveedor = Proveedores.IdProveedor
    WHERE   IdPresupuesto = @IdPresupuesto 



GO
/****** Object:  StoredProcedure [dbo].[wCondicionesCompra_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wCondicionesCompra_TL]
AS 
    SELECT  IdCondicionCompra,
            Descripcion AS [Titulo]
    FROM    [Condiciones Compra]
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wMonedas_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wMonedas_TL]
AS 
    SELECT  IdMoneda,
            Nombre AS [Titulo]
    FROM    Monedas
    ORDER BY Nombre

GO
/****** Object:  StoredProcedure [dbo].[wPlazosEntrega_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wPlazosEntrega_TL]
AS 
    SELECT  IdPlazoEntrega,
            Descripcion AS Titulo
    FROM    PlazosEntrega
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TX_PorCuit]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wProveedores_TX_PorCuit] @Cuit VARCHAR(13)
AS 
    SELECT  *
    FROM    Proveedores
    WHERE   Cuit = @Cuit

GO
/****** Object:  StoredProcedure [dbo].[wPresupuestos_TX_PorNumero]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wPresupuestos_TX_PorNumero] @Numero INT
--,@SubNumero int
AS 
    SELECT  Presupuestos.*,
            PlazosEntrega.Descripcion AS [PlazoEntrega]
    FROM    Presupuestos
            LEFT OUTER JOIN PlazosEntrega ON PlazosEntrega.IdPlazoEntrega = Presupuestos.IdPlazoEntrega
    WHERE   Numero = @Numero
 --AND SubNumero=@SubNumero

GO
/****** Object:  StoredProcedure [dbo].[wEstadosProveedores_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wEstadosProveedores_TL]
AS 
SELECT IdEstado, Descripcion as [Titulo]
FROM [Estados Proveedores]
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wFacturas_TX_PorIdConDatos]

@IdFactura int

AS 

SELECT 
 Facturas.*,
 IsNull(Obras.NumeroObra,'') as [NumeroObra],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 Case When IsNull((Select Count(Distinct DetalleRemitos.IdRemito)
			From DetalleFacturasRemitos Det 
			Left Outer Join DetalleRemitos On Det.IdDetalleRemito = DetalleRemitos.IdDetalleRemito
			Where Det.IdFactura=@IdFactura),0)<=1 
	Then IsNull((Select Top 1 Convert(varchar,Remitos.NumeroRemito)
			From DetalleFacturasRemitos Det 
			Left Outer Join DetalleRemitos On Det.IdDetalleRemito = DetalleRemitos.IdDetalleRemito
			Left Outer Join Remitos On DetalleRemitos.IdRemito = Remitos.IdRemito
			Where Det.IdFactura=@IdFactura),'')
	Else 'Varios'
 End as [Remito],
 Clientes.CodigoCliente as [CodigoCliente], 
 Clientes.RazonSocial as [Cliente], 
 DescripcionIva.Descripcion as [CondicionIVA], 
 Clientes.Cuit as [CuitCliente], 
 Monedas.Abreviatura as [Moneda],
 Vendedores.Nombre as [Vendedor],
 E1.Nombre  as [Ingreso],
 Facturas.TipoABC+'-'+Substring('0000',1,4-Len(Convert(varchar,Facturas.PuntoVenta)))+Convert(varchar,Facturas.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,Facturas.NumeroFactura)))+Convert(varchar,Facturas.NumeroFactura) as [Numero],
 cc.Descripcion as [CondicionVenta],
 Facturas.ImporteTotal-Facturas.ImporteIva1-Facturas.ImporteIva2-Facturas.RetencionIBrutos1-Facturas.RetencionIBrutos2-Facturas.RetencionIBrutos3+
	IsNull(Facturas.ImporteBonificacion,0)-IsNull(Facturas.IvaNoDiscriminado,0)-IsNull(Facturas.PercepcionIVA,0)-
	IsNull(Facturas.OtrasPercepciones1,0)-IsNull(Facturas.OtrasPercepciones2,0)-IsNull(Facturas.OtrasPercepciones3,0) as [SubtotalFactura],
 Facturas.ImporteBonificacion as [Bonificacion],
 Facturas.ImporteIva1+IsNull(Facturas.IvaNoDiscriminado,0) as [Iva],
 Facturas.RetencionIBrutos1+Facturas.RetencionIBrutos2+Facturas.RetencionIBrutos3 as [IIBB],
 IsNull(Facturas.OtrasPercepciones1,0)+IsNull(Facturas.OtrasPercepciones2,0)+IsNull(Facturas.OtrasPercepciones3,0) as [OtrasPercepciones],
 Facturas.ImporteTotal as [TotalFactura]
FROM Facturas
LEFT OUTER JOIN Obras ON Obras.IdObra = Facturas.IdObra
LEFT OUTER JOIN Clientes ON Facturas.IdCliente = Clientes.IdCliente
LEFT OUTER JOIN DescripcionIva ON IsNull(Facturas.IdCodigoIva,Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva 
LEFT OUTER JOIN Vendedores ON Clientes.Vendedor1 = Vendedores.IdVendedor
LEFT OUTER JOIN Monedas ON Facturas.IdMoneda = Monedas.IdMoneda
LEFT OUTER JOIN Empleados E1 ON Facturas.IdUsuarioIngreso = E1.IdEmpleado
LEFT OUTER JOIN [Condiciones Compra] cc ON Facturas.IdCondicionVenta=cc.IdCondicionCompra
WHERE (IdFactura=@IdFactura)


GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_A]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wFondosFijos_A]

@IdFondoFijo int,
@IdProveedor int,
@IdTipoComprobante int,
@FechaComprobante datetime,
@Letra varchar(1),
@NumeroComprobante1 int,
@NumeroComprobante2 int,
@TotalBruto numeric(18,2),
@TotalIva1 numeric(18,2),
@TotalComprobante numeric(18,2),
@Observaciones ntext,
@IdObra int,
@IdProveedorEventual int,
@IdCuenta int,
@TotalIvaNoDiscriminado numeric(18,2),
@IVAComprasImporte1 numeric(18,2),
@IdCuentaIvaCompras1 int,
@IvaComprasPorcentaje1 numeric(6,2),
@NumeroCAI varchar(20),
@FechaVencimientoCAI datetime,
@IdUsuarioIngreso int,
@FechaIngreso datetime,
@IdCodigoIva int,
@Cuit varchar(13)

AS

DECLARE @ReturnValue int

IF IsNull(@IdFondoFijo,0)<=0
    BEGIN
	BEGIN TRAN
	INSERT INTO FondosFijos
	(
	 IdProveedor,
	 IdTipoComprobante,
	 FechaComprobante,
	 Letra,
	 NumeroComprobante1,
	 NumeroComprobante2,
	 TotalBruto,
	 TotalIva1,
	 TotalComprobante,
	 Observaciones,
	 IdObra,
	 IdProveedorEventual,
	 IdCuenta,
	 TotalIvaNoDiscriminado,
	 IVAComprasImporte1,
	 IdCuentaIvaCompras1,
	 IvaComprasPorcentaje1,
	 NumeroCAI,
	 FechaVencimientoCAI,
	 IdUsuarioIngreso,
	 FechaIngreso,
	 IdCodigoIva,
	 Cuit
	)
	VALUES
	(
	 @IdProveedor,
	 @IdTipoComprobante,
	 @FechaComprobante,
	 @Letra,
	 @NumeroComprobante1,
	 @NumeroComprobante2,
	 @TotalBruto,
	 @TotalIva1,
	 @TotalComprobante,
	 @Observaciones,
	 @IdObra,
	 @IdProveedorEventual,
	 @IdCuenta,
	 @TotalIvaNoDiscriminado,
	 @IVAComprasImporte1,
	 @IdCuentaIvaCompras1,
	 @IvaComprasPorcentaje1,
	 @NumeroCAI,
	 @FechaVencimientoCAI,
	 @IdUsuarioIngreso,
	 @FechaIngreso,
	 @IdCodigoIva,
	 @Cuit
	)
	
	SELECT @ReturnValue = SCOPE_IDENTITY()
	
	IF @@ERROR <> 0
	    BEGIN
		ROLLBACK TRAN
		RETURN -1
	    END
	ELSE
	    BEGIN
		COMMIT TRAN
	    END
    END
ELSE
    BEGIN
	UPDATE FondosFijos
	SET 
	 IdProveedor=@IdProveedor,
	 IdTipoComprobante=@IdTipoComprobante,
	 FechaComprobante=@FechaComprobante,
	 Letra=@Letra,
	 NumeroComprobante1=@NumeroComprobante1,
	 NumeroComprobante2=@NumeroComprobante2,
	 TotalBruto=@TotalBruto,
	 TotalIva1=@TotalIva1,
	 TotalComprobante=@TotalComprobante,
	 Observaciones=@Observaciones,
	 IdObra=@IdObra,
	 IdProveedorEventual=@IdProveedorEventual,
	 IdCuenta=@IdCuenta,
	 TotalIvaNoDiscriminado=@TotalIvaNoDiscriminado,
	 IVAComprasImporte1=@IVAComprasImporte1,
	 IdCuentaIvaCompras1=@IdCuentaIvaCompras1,
	 IvaComprasPorcentaje1=@IvaComprasPorcentaje1,
	 NumeroCAI=@NumeroCAI,
	 FechaVencimientoCAI=@FechaVencimientoCAI,
	 IdUsuarioIngreso=@IdUsuarioIngreso,
	 FechaIngreso=@FechaIngreso,
	 IdCodigoIva=@IdCodigoIva,
	 Cuit=@Cuit
	WHERE (IdFondoFijo=@IdFondoFijo)

	SELECT @ReturnValue = @IdFondoFijo
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @ReturnValue



GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wFondosFijos_E]

@IdFondoFijo int  

AS 

DELETE FondosFijos
WHERE (IdFondoFijo=@IdFondoFijo)



GO
/****** Object:  StoredProcedure [dbo].[wFondosFijos_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wFondosFijos_T]

@IdFondoFijo int = Null,
@IdUsuarioIngreso int = Null,
@NivelDetalles varchar(10) = Null

AS 

SET NOCOUNT ON

SET @IdFondoFijo=IsNull(@IdFondoFijo,-1)
SET @IdUsuarioIngreso=IsNull(@IdUsuarioIngreso,-1)
SET @NivelDetalles=IsNull(@NivelDetalles,'Detallado')

IF @NivelDetalles='Resumen'
    BEGIN
	DECLARE @rowcount int
	SELECT @rowcount=IsNull((SELECT Count(*) 
					FROM FondosFijos 
					WHERE (@IdFondoFijo=-1 or FondosFijos.IdFondoFijo=@IdFondoFijo) and 
						(@IdUsuarioIngreso=-1 or FondosFijos.IdUsuarioIngreso=@IdUsuarioIngreso)),0)
	SET NOCOUNT OFF
	RETURN @rowcount
    END

SET NOCOUNT OFF

SELECT 
 FondosFijos.*,
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 E1.Nombre as [UsuarioIngreso],
 Proveedores.RazonSocial as [Proveedor],
 TiposComprobante.Descripcion as [TipoComprobante],
 Cuentas.Codigo as [CodigoCuenta],
 Cuentas.Descripcion as [Cuenta],
 DescripcionIva.Descripcion as [CondicionIva]
FROM FondosFijos
LEFT OUTER JOIN Obras ON FondosFijos.IdObra=Obras.IdObra
LEFT OUTER JOIN Proveedores ON FondosFijos.IdProveedor=Proveedores.IdProveedor
LEFT OUTER JOIN Empleados E1 ON FondosFijos.IdUsuarioIngreso=E1.IdEmpleado
LEFT OUTER JOIN TiposComprobante ON FondosFijos.IdTipoComprobante = TiposComprobante.IdTipoComprobante
LEFT OUTER JOIN Cuentas ON FondosFijos.IdCuenta = Cuentas.IdCuenta
LEFT OUTER JOIN DescripcionIva ON FondosFijos.IdCodigoIva = DescripcionIva.IdCodigoIva
WHERE (@IdFondoFijo=-1 or FondosFijos.IdFondoFijo=@IdFondoFijo) and 
	(@IdUsuarioIngreso=-1 or FondosFijos.IdUsuarioIngreso=@IdUsuarioIngreso) 
ORDER BY FondosFijos.FechaComprobante Desc



GO
/****** Object:  StoredProcedure [dbo].[wIBCondiciones_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wIBCondiciones_TL]
AS 
SELECT IdIBCondicion, Descripcion as [Titulo]
FROM IBCondiciones
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wImpuestosDirectos_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wImpuestosDirectos_TL]
AS 
SELECT IdImpuestoDirecto, Descripcion as [Titulo]
FROM ImpuestosDirectos
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_E]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wLocalidades_E]

@IdLocalidad int  

AS 

DELETE Localidades
WHERE (IdLocalidad=@IdLocalidad)



GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_T]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wLocalidades_T]

@IdLocalidad int = Null

AS 

SET @IdLocalidad=IsNull(@IdLocalidad,-1)

IF @IdLocalidad=-2
	SELECT 
	 Localidades.IdLocalidad as [IdLocalidad],
	 Localidades.Nombre as [Localidad],
	 Provincias.Nombre as [Provincia],
	 Paises.Descripcion as [Pais]
	FROM Localidades
	LEFT OUTER JOIN Provincias ON Localidades.IdProvincia=Provincias.IdProvincia
	LEFT OUTER JOIN Paises ON Provincias.IdPais=Paises.IdPais
	ORDER BY Localidades.Nombre
ELSE
	SELECT 
	 Localidades.*,
	 Provincias.Nombre as [Provincia],
	 Provincias.IdPais as [IdPais],
	 Paises.Descripcion as [Pais]
	FROM Localidades
	LEFT OUTER JOIN Provincias ON Localidades.IdProvincia=Provincias.IdProvincia
	LEFT OUTER JOIN Paises ON Provincias.IdPais=Paises.IdPais
	WHERE @IdLocalidad=-1 or Localidades.IdLocalidad=@IdLocalidad
	ORDER BY Localidades.Nombre



GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TL]    Script Date: 10/17/2012 11:13:39 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wLocalidades_TL]
AS 
SELECT IdLocalidad, Nombre as [Titulo]
FROM Localidades 
ORDER BY Nombre



GO
/****** Object:  StoredProcedure [dbo].[wOrdenesPago_TX_EnCajaPorProveedor]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wOrdenesPago_TX_EnCajaPorProveedor] @IdProveedor INT
AS 
    DECLARE @Estado VARCHAR(2)
    SET @Estado = NULL

    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50)

    SELECT  op.IdOrdenPago,
            op.FechaOrdenPago AS [Fecha Pago],
            op.Documentos,
            op.Acreedores,
            op.RetencionIVA AS [RetIVA],
            op.RetencionGanancias AS [RetGan],
            op.RetencionIBrutos AS [RetIngB],
            op.RetencionSUSS AS [RetSUSS],
            op.GastosGenerales AS [Dev.F.F.]
    FROM    OrdenesPago op
            LEFT OUTER JOIN Proveedores ON op.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Cuentas ON op.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN Empleados ON op.IdEmpleadoFF = Empleados.IdEmpleado
            LEFT OUTER JOIN Monedas ON op.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN Obras ON op.IdObra = Obras.IdObra
    WHERE   --op.Estado=@Estado and 
            ( op.Anulada IS NULL
              OR op.Anulada <> 'SI'
            )
            AND ( op.Confirmado IS NULL
                  OR op.Confirmado <> 'NO'
                )
            AND op.IdProveedor = @IdProveedor
    ORDER BY op.FechaOrdenPago DESC,
            op.NumeroOrdenPago DESC


GO
/****** Object:  StoredProcedure [dbo].[wCtasCtesA_TXPorMayorParaInfoProv]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[wCtasCtesA_TXPorMayorParaInfoProv] @IdProveedor INT
AS 
    DECLARE @Todo INT
    DECLARE @FechaLimite DATETIME
    DECLARE @FechaDesde DATETIME
    DECLARE @Consolidar INT

    SET @Todo = -1
    SET @FechaLimite = '1/1/2070'
    SET @FechaDesde = NULL
    SET @Consolidar = NULL


    SET NOCOUNT ON

    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/2000'))
    SET @Consolidar = ISNULL(@Consolidar, -1)

    DECLARE @IdTipoComprobanteOrdenPago INT,
        @SaldoInicial NUMERIC(18, 2)
    SET @IdTipoComprobanteOrdenPago = ( SELECT TOP 1
                                                Parametros.IdTipoComprobanteOrdenPago
                                        FROM    Parametros
                                        WHERE   Parametros.IdParametro = 1
                                      )
    IF @Todo = -1 
        SET @SaldoInicial = 0
    ELSE 
        SET @SaldoInicial = ISNULL(( SELECT SUM(ISNULL(CtaCte.ImporteTotal, 0)
                                                * ISNULL(tc.Coeficiente, 1))
                                     FROM   CuentasCorrientesAcreedores CtaCte
                                            LEFT OUTER JOIN TiposComprobante tc ON tc.IdTipoComprobante = CtaCte.IdTipoComp
                                     WHERE  CtaCte.IdProveedor = @IdProveedor
                                            AND CtaCte.Fecha < @FechaDesde
                                   ), 0)

    CREATE TABLE #Auxiliar1
        (
          IdCtaCte INTEGER,
          IdProveedor INTEGER,
          IdTipoComprobante INTEGER,
          TipoComprobante VARCHAR(5),
          IdComprobante INTEGER,
          NumeroComprobante VARCHAR(15),
          Referencia INTEGER,
          Fecha DATETIME,
          ImporteTotal NUMERIC(18, 2),
          IdMoneda INTEGER
        )
    IF @Todo <> -1 
        INSERT  INTO #Auxiliar1
                SELECT  0,
                        @IdProveedor,
                        0,
                        'INI',
                        0,
                        ' AL ' + CONVERT(VARCHAR, @FechaDesde, 103),
                        0,
                        @FechaDesde,
                        @SaldoInicial,
                        1

    INSERT  INTO #Auxiliar1
            SELECT  CtaCte.IdCtaCte,
                    CtaCte.IdProveedor,
                    CASE WHEN CtaCte.IdTipoComp = 16
                         THEN @IdTipoComprobanteOrdenPago
                         ELSE CtaCte.IdTipoComp
                    END,
                    TiposComprobante.DescripcionAB,
                    CtaCte.IdComprobante,
                    CASE WHEN CtaCte.IdTipoComp = @IdTipoComprobanteOrdenPago
                              OR CtaCte.IdTipoComp = 16
                              OR cp.IdComprobanteProveedor IS NULL
                         THEN SUBSTRING(SUBSTRING('00000000', 1,
                                                  8
                                                  - LEN(CONVERT(VARCHAR, CtaCte.NumeroComprobante)))
                                        + CONVERT(VARCHAR, CtaCte.NumeroComprobante),
                                        1, 15)
                         ELSE SUBSTRING(cp.Letra + '-' + SUBSTRING('0000', 1, 4 - LEN(CONVERT(VARCHAR, cp.NumeroComprobante1)))
                                        + CONVERT(VARCHAR, cp.NumeroComprobante1)
                                        + '-' + SUBSTRING('00000000', 1,
                                                          8
                                                          - LEN(CONVERT(VARCHAR, cp.NumeroComprobante2)))
                                        + CONVERT(VARCHAR, cp.NumeroComprobante2),
                                        1, 15)
                    END,
                    CtaCte.NumeroComprobante,
                    CtaCte.Fecha,
                    CtaCte.ImporteTotal * TiposComprobante.Coeficiente,
                    CtaCte.IdMoneda
            FROM    CuentasCorrientesAcreedores CtaCte
                    LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante = CtaCte.IdTipoComp
                    LEFT OUTER JOIN ComprobantesProveedores cp ON cp.IdComprobanteProveedor = CtaCte.IdComprobante
            WHERE   CtaCte.IdProveedor = @IdProveedor
                    AND ( @Todo = -1
                          OR CtaCte.Fecha BETWEEN @FechaDesde AND @FechaLimite
                        )

    UPDATE  #Auxiliar1
    SET     NumeroComprobante = '00000000'
    WHERE   NumeroComprobante IS NULL

    CREATE TABLE #Auxiliar2
        (
          IdCtaCte INTEGER,
          IdTipoComprobante INTEGER,
          TipoComprobante VARCHAR(5),
          IdComprobante INTEGER,
          NumeroComprobante VARCHAR(15),
          Referencia INTEGER,
          Fecha DATETIME,
          ImporteTotal NUMERIC(18, 2),
          IdMoneda INTEGER
        )
    INSERT  INTO #Auxiliar2
            SELECT  MAX(#Auxiliar1.IdCtaCte),
                    #Auxiliar1.IdTipoComprobante,
                    MAX(#Auxiliar1.TipoComprobante),
                    #Auxiliar1.IdComprobante,
                    #Auxiliar1.NumeroComprobante,
                    MAX(#Auxiliar1.Referencia),
                    MAX(#Auxiliar1.Fecha),
                    SUM(#Auxiliar1.ImporteTotal),
                    #Auxiliar1.IdMoneda
            FROM    #Auxiliar1
            GROUP BY #Auxiliar1.IdTipoComprobante,
                    #Auxiliar1.IdComprobante,
                    #Auxiliar1.NumeroComprobante,
                    #Auxiliar1.IdMoneda

    SET NOCOUNT OFF

    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30),
        @vector_E VARCHAR(1000)
    SET @vector_X = '01111118888151133'
    SET @vector_T = '00997144444453900'
    SET @vector_E = '  |  |  |  | NUM:#COMMA##0.00 | NUM:#COMMA##0.00 | NUM:#COMMA##0.00 | NUM:#COMMA##0.00 |  |  |  '

    SELECT  TipoComprobante,
            NumeroComprobante,
            CONVERT(CHAR(10), Fecha, 103) AS Fecha,
            CONVERT(CHAR(10), FechaComprobante, 103) AS FechaComprobante,
            #Auxiliar2.IdCtaCte,
            #Auxiliar2.TipoComprobante AS [Comp.],
            #Auxiliar2.IdTipoComprobante,
            #Auxiliar2.IdComprobante,
            #Auxiliar2.NumeroComprobante AS [Numero],
            #Auxiliar2.Referencia AS [Ref.],
            #Auxiliar2.Fecha,
            #Auxiliar2.ImporteTotal * -1 AS [Imp.orig.],
            CASE WHEN #Auxiliar2.ImporteTotal < 0
                 THEN #Auxiliar2.ImporteTotal * -1
                 ELSE NULL
            END AS [Debe],
            CASE WHEN #Auxiliar2.ImporteTotal >= 0
                 THEN #Auxiliar2.ImporteTotal
                 ELSE NULL
            END AS [Haber],
            #Auxiliar2.ImporteTotal AS [Saldo],
            CASE WHEN #Auxiliar2.IdTipoComprobante = @IdTipoComprobanteOrdenPago
                      OR #Auxiliar2.IdTipoComprobante = 16 THEN NULL
                 ELSE cp.FechaComprobante
            END AS [Fecha cmp.],
            CASE WHEN #Auxiliar2.IdTipoComprobante = @IdTipoComprobanteOrdenPago
                 THEN ISNULL(CONVERT(VARCHAR(1000), OrdenesPago.Observaciones COLLATE SQL_Latin1_General_CP1_CI_AS),
                             '')
                 ELSE ISNULL(CONVERT(VARCHAR(1000), cp.Observaciones), '')
            END AS [Observaciones],
            Monedas.Abreviatura AS [Mon.origen],
            @Vector_E AS Vector_E,
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    #Auxiliar2
            LEFT OUTER JOIN TiposComprobante ON TiposComprobante.IdTipoComprobante = #Auxiliar2.IdTipoComprobante
            LEFT OUTER JOIN ComprobantesProveedores cp ON cp.IdComprobanteProveedor = #Auxiliar2.IdComprobante
                                                          AND #Auxiliar2.IdTipoComprobante <> @IdTipoComprobanteOrdenPago
                                                          AND #Auxiliar2.IdTipoComprobante <> 16
            LEFT OUTER JOIN OrdenesPago ON OrdenesPago.IdOrdenPago = #Auxiliar2.IdComprobante
                                           AND ( #Auxiliar2.IdTipoComprobante = @IdTipoComprobanteOrdenPago
                                                 OR #Auxiliar2.IdTipoComprobante = 16
                                               )
            LEFT OUTER JOIN Monedas ON #Auxiliar2.IdMoneda = Monedas.IdMoneda
    ORDER BY FechaComprobante DESC



    DROP TABLE #Auxiliar1
    DROP TABLE #Auxiliar2



GO
/****** Object:  StoredProcedure [dbo].[wNotasCredito_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wNotasCredito_TX_PorIdConDatos]

@IdNotaCredito int

AS 

SELECT 
 NotasCredito.*,
 NotasCredito.TipoABC+'-'+Substring('0000',1,4-Len(Convert(varchar,NotasCredito.PuntoVenta)))+Convert(varchar,NotasCredito.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,NotasCredito.NumeroNotaCredito)))+Convert(varchar,NotasCredito.NumeroNotaCredito) as [Numero],
 Clientes.CodigoCliente as [CodigoCliente], 
 Clientes.RazonSocial as [Cliente], 
 DescripcionIva.Descripcion as [CondicionIVA], 
 Clientes.Cuit as [CuitCliente], 
 Monedas.Abreviatura as [Moneda],
 IsNull(Obras.NumeroObra,'') as [NumeroObra],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 (IsNull(NotasCredito.ImporteTotal,0)-IsNull(NotasCredito.ImporteIva1,0)-IsNull(NotasCredito.ImporteIva2,0) - 
	IsNull(NotasCredito.PercepcionIVA,0)-
	IsNull(NotasCredito.RetencionIBrutos1,0)-IsNull(NotasCredito.RetencionIBrutos2,0)-IsNull(NotasCredito.RetencionIBrutos3,0)-
	IsNull(NotasCredito.OtrasPercepciones1,0)-IsNull(NotasCredito.OtrasPercepciones2,0)-IsNull(NotasCredito.OtrasPercepciones3,0)) as [Subtotal],
 NotasCredito.ImporteIva1 as [Iva],
 NotasCredito.RetencionIBrutos1+NotasCredito.RetencionIBrutos2+NotasCredito.RetencionIBrutos3 as [IIBB],
 IsNull(NotasCredito.OtrasPercepciones1,0)+IsNull(NotasCredito.OtrasPercepciones2,0)+IsNull(NotasCredito.OtrasPercepciones3,0) as [OtrasPercepciones]
FROM NotasCredito
LEFT OUTER JOIN Obras ON Obras.IdObra = NotasCredito.IdObra
LEFT OUTER JOIN Clientes ON NotasCredito.IdCliente = Clientes.IdCliente
LEFT OUTER JOIN DescripcionIva ON IsNull(NotasCredito.IdCodigoIva,Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva 
LEFT OUTER JOIN Monedas ON NotasCredito.IdMoneda = Monedas.IdMoneda
WHERE (IdNotaCredito=@IdNotaCredito)

GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wRequerimientos_A]
    @IdRequerimiento INT,
    @NumeroRequerimiento INT,
    @FechaRequerimiento DATETIME,
    @LugarEntrega NTEXT,
    @Observaciones NTEXT,
    
    @IdObra INT,
    @IdSolicito INT,
    @IdSector INT,
    @MontoPrevisto NUMERIC(12, 2),
    @IdComprador INT,
    
    @Aprobo INT,
    @FechaAprobacion DATETIME,
    @MontoParaCompra NUMERIC(12, 2),
    @Cumplido VARCHAR(2),
    @UsuarioAnulacion VARCHAR(6),
    
    @FechaAnulacion DATETIME,
    @MotivoAnulacion NTEXT,
    @IdRequerimientoOriginal INT,
    @IdOrigenTransmision INT,
    @IdAutorizoCumplido INT,
    
    @IdDioPorCumplido INT,
    @FechaDadoPorCumplido DATETIME,
    @ObservacionesCumplido NTEXT,
    @IdMoneda INT,
    @Detalle VARCHAR(50),
    
    @Confirmado VARCHAR(2),    
    @FechaImportacionTransmision DATETIME,
    @IdEquipoDestino INT,
    @Impresa VARCHAR(2),
    @Recepcionado VARCHAR(2),
    
    @Entregado VARCHAR(2),
    @TipoRequerimiento VARCHAR(2),
    @IdOrdenTrabajo INT,
    @IdTipoCompra INT,
    @IdImporto INT,
    
    @FechaLlegadaImportacion DATETIME,
    @CircuitoFirmasCompleto VARCHAR(2),
    @ConfirmadoPorWeb VARCHAR(2),
    @DirectoACompras VARCHAR(2)
AS 
    DECLARE @ReturnValue INT




    IF ISNULL(@IdRequerimiento, 0) <= 0 
        BEGIN
            BEGIN TRAN
	
            SET @NumeroRequerimiento = ISNULL(( SELECT TOP 1
                                                        P.ProximoNumeroRequerimiento
                                                FROM    Parametros P
                                                WHERE   P.IdParametro = 1
                                              ), 1)
            UPDATE  Parametros
            SET     ProximoNumeroRequerimiento = @NumeroRequerimiento + 1
	
            INSERT  INTO Requerimientos
                    (
                      NumeroRequerimiento,
                      FechaRequerimiento,
                      LugarEntrega,
                      Observaciones,
                      IdObra,
                      IdSolicito,
                      IdSector,
                      MontoPrevisto,
                      IdComprador,
                      Aprobo,
                      FechaAprobacion,
                      MontoParaCompra,
                      Cumplido,
                      UsuarioAnulacion,
                      FechaAnulacion,
                      MotivoAnulacion,
                      IdRequerimientoOriginal,
                      IdOrigenTransmision,
                      IdAutorizoCumplido,
                      IdDioPorCumplido,
                      FechaDadoPorCumplido,
                      ObservacionesCumplido,
                      IdMoneda,
                      Detalle,
                      Confirmado,
                      FechaImportacionTransmision,
                      IdEquipoDestino,
                      Impresa,
                      Recepcionado,
                      Entregado,
                      TipoRequerimiento,
                      IdOrdenTrabajo,
                      IdTipoCompra,
                      IdImporto,
                      FechaLlegadaImportacion,
                      CircuitoFirmasCompleto,
                      ConfirmadoPorWeb,
                      DirectoACompras
	              )
            VALUES  (
                      @NumeroRequerimiento,
                      @FechaRequerimiento,
                      @LugarEntrega,
                      @Observaciones,
                      @IdObra,
                      @IdSolicito,
                      @IdSector,
                      @MontoPrevisto,
                      @IdComprador,
                      @Aprobo,
                      @FechaAprobacion,
                      @MontoParaCompra,
                      @Cumplido,
                      @UsuarioAnulacion,
                      @FechaAnulacion,
                      @MotivoAnulacion,
                      @IdRequerimientoOriginal,
                      @IdOrigenTransmision,
                      @IdAutorizoCumplido,
                      @IdDioPorCumplido,
                      @FechaDadoPorCumplido,
                      @ObservacionesCumplido,
                      @IdMoneda,
                      @Detalle,
                      @Confirmado,
                      @FechaImportacionTransmision,
                      @IdEquipoDestino,
                      @Impresa,
                      @Recepcionado,
                      @Entregado,
                      @TipoRequerimiento,
                      @IdOrdenTrabajo,
                      @IdTipoCompra,
                      @IdImporto,
                      @FechaLlegadaImportacion,
                      @CircuitoFirmasCompleto,
                      @ConfirmadoPorWeb,
                      @DirectoACompras
	              )
	
            SELECT  @ReturnValue = SCOPE_IDENTITY()
	
            IF @@ERROR <> 0 
                BEGIN
                    ROLLBACK TRAN
                    RETURN -1
                END
            ELSE 
                BEGIN
                    COMMIT TRAN
                END
        END
    ELSE 
        BEGIN
            UPDATE  Requerimientos
            SET     NumeroRequerimiento = @NumeroRequerimiento,
                    FechaRequerimiento = @FechaRequerimiento,
                    LugarEntrega = @LugarEntrega,
                    Observaciones = @Observaciones,
                    IdObra = @IdObra,
                    IdSolicito = @IdSolicito,
                    IdSector = @IdSector,
                    MontoPrevisto = @MontoPrevisto,
                    IdComprador = @IdComprador,
                    Aprobo = @Aprobo,
                    FechaAprobacion = @FechaAprobacion,
                    MontoParaCompra = @MontoParaCompra,
                    Cumplido = @Cumplido,
                    UsuarioAnulacion = @UsuarioAnulacion,
                    FechaAnulacion = @FechaAnulacion,
                    MotivoAnulacion = @MotivoAnulacion,
                    IdRequerimientoOriginal = @IdRequerimientoOriginal,
                    IdOrigenTransmision = @IdOrigenTransmision,
                    IdAutorizoCumplido = @IdAutorizoCumplido,
                    IdDioPorCumplido = @IdDioPorCumplido,
                    FechaDadoPorCumplido = @FechaDadoPorCumplido,
                    ObservacionesCumplido = @ObservacionesCumplido,
                    IdMoneda = @IdMoneda,
                    Detalle = @Detalle,
                    Confirmado = @Confirmado,
                    FechaImportacionTransmision = @FechaImportacionTransmision,
                    IdEquipoDestino = @IdEquipoDestino,
	-- Impresa=@Impresa
                    Recepcionado = @Recepcionado,
                    Entregado = @Entregado,
                    TipoRequerimiento = @TipoRequerimiento,
                    IdOrdenTrabajo = @IdOrdenTrabajo,
                    IdTipoCompra = @IdTipoCompra,
                    IdImporto = @IdImporto,
                    FechaLlegadaImportacion = @FechaLlegadaImportacion,
                    CircuitoFirmasCompleto = @CircuitoFirmasCompleto,
                    ConfirmadoPorWeb = @ConfirmadoPorWeb,
                    DirectoACompras = @DirectoACompras
            WHERE   ( IdRequerimiento = @IdRequerimiento )

            SELECT  @ReturnValue = @IdRequerimiento
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @ReturnValue



GO
/****** Object:  StoredProcedure [dbo].[wNotasDebito_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wNotasDebito_TX_PorIdConDatos]

@IdNotaDebito int

AS 

SELECT 
 NotasDebito.*,
 NotasDebito.TipoABC+'-'+Substring('0000',1,4-Len(Convert(varchar,NotasDebito.PuntoVenta)))+Convert(varchar,NotasDebito.PuntoVenta)+'-'+
		Substring('00000000',1,8-Len(Convert(varchar,NotasDebito.NumeroNotaDebito)))+Convert(varchar,NotasDebito.NumeroNotaDebito) as [Numero],
 Clientes.CodigoCliente as [CodigoCliente], 
 Clientes.RazonSocial as [Cliente], 
 DescripcionIva.Descripcion as [CondicionIVA], 
 Clientes.Cuit as [CuitCliente], 
 Monedas.Abreviatura as [Moneda],
 IsNull(Obras.NumeroObra,'') as [NumeroObra],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 (IsNull(NotasDebito.ImporteTotal,0)-IsNull(NotasDebito.ImporteIva1,0)-IsNull(NotasDebito.ImporteIva2,0) - 
	IsNull(NotasDebito.PercepcionIVA,0)-
	IsNull(NotasDebito.RetencionIBrutos1,0)-IsNull(NotasDebito.RetencionIBrutos2,0)-IsNull(NotasDebito.RetencionIBrutos3,0)-
	IsNull(NotasDebito.OtrasPercepciones1,0)-IsNull(NotasDebito.OtrasPercepciones2,0)-IsNull(NotasDebito.OtrasPercepciones3,0)) as [Subtotal],
 NotasDebito.ImporteIva1 as [Iva],
 NotasDebito.RetencionIBrutos1+NotasDebito.RetencionIBrutos2+NotasDebito.RetencionIBrutos3 as [IIBB],
 IsNull(NotasDebito.OtrasPercepciones1,0)+IsNull(NotasDebito.OtrasPercepciones2,0)+IsNull(NotasDebito.OtrasPercepciones3,0) as [OtrasPercepciones]
FROM NotasDebito
LEFT OUTER JOIN Obras ON Obras.IdObra = NotasDebito.IdObra
LEFT OUTER JOIN Clientes ON NotasDebito.IdCliente = Clientes.IdCliente
LEFT OUTER JOIN DescripcionIva ON IsNull(NotasDebito.IdCodigoIva,Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva 
LEFT OUTER JOIN Monedas ON NotasDebito.IdMoneda = Monedas.IdMoneda
WHERE (IdNotaDebito=@IdNotaDebito)

GO
/****** Object:  StoredProcedure [dbo].[wComparativas_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wComparativas_A
    @IdComparativa INT OUTPUT,
    @Numero INT,
    @Fecha DATETIME,
    @Observaciones NTEXT,
    @IdConfecciono INT,
    @IdAprobo INT,
    @PresupuestoSeleccionado INT,
    @SubNumeroSeleccionado INT,
    @MontoPrevisto NUMERIC(12, 2),
    @MontoParaCompra NUMERIC(12, 2),
    @NumeroRequerimiento INT,
    @FechaAprobacion DATETIME,
    @Obras VARCHAR(20),
    @CircuitoFirmasCompleto VARCHAR(2)
AS 
    IF ISNULL(@IdComparativa, 0) <= 0 
        BEGIN 
 --insert
            INSERT  INTO Comparativas
                    (
                      Numero,
                      Fecha,
                      Observaciones,
                      IdConfecciono,
                      IdAprobo,
                      PresupuestoSeleccionado,
                      SubNumeroSeleccionado,
                      MontoPrevisto,
                      MontoParaCompra,
                      NumeroRequerimiento,
                      FechaAprobacion,
                      Obras,
                      CircuitoFirmasCompleto
                    )
            VALUES  (
                      @Numero,
                      @Fecha,
                      @Observaciones,
                      @IdConfecciono,
                      @IdAprobo,
                      @PresupuestoSeleccionado,
                      @SubNumeroSeleccionado,
                      @MontoPrevisto,
                      @MontoParaCompra,
                      @NumeroRequerimiento,
                      @FechaAprobacion,
                      @Obras,
                      @CircuitoFirmasCompleto
                    )
            SELECT  @IdComparativa = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  Comparativas
            SET     Numero = @Numero,
                    Fecha = @Fecha,
                    Observaciones = @Observaciones,
                    IdConfecciono = @IdConfecciono,
                    IdAprobo = @IdAprobo,
                    PresupuestoSeleccionado = @PresupuestoSeleccionado,
                    SubNumeroSeleccionado = @SubNumeroSeleccionado,
                    MontoPrevisto = @MontoPrevisto,
                    MontoParaCompra = @MontoParaCompra,
                    NumeroRequerimiento = @NumeroRequerimiento,
                    FechaAprobacion = @FechaAprobacion,
                    Obras = @Obras,
                    CircuitoFirmasCompleto = @CircuitoFirmasCompleto
            WHERE   ( IdComparativa = @IdComparativa )
 
 
        END
  
    RETURN ( @IdComparativa )

GO
/****** Object:  StoredProcedure [dbo].[wObras_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wObras_A]

@IdObra int  output,
@NumeroObra varchar(13),
@IdCliente int,
@FechaInicio datetime,
@FechaFinalizacion datetime,
@Observaciones ntext,
@FechaEntrega datetime,
@Descripcion varchar(50),
@IdJefe int,
@TipoObra int,
@HorasEstimadas int,
@Consorcial varchar(2),
@EnviarEmail tinyint,
@Activa varchar(2),
@ParaInformes varchar(2),
@IdUnidadOperativa int,
@Jerarquia varchar(20),
@ArchivoAdjunto1 varchar(100),
@ArchivoAdjunto2 varchar(100),
@ArchivoAdjunto3 varchar(100),
@ArchivoAdjunto4 varchar(100),
@ArchivoAdjunto5 varchar(100),
@ArchivoAdjunto6 varchar(100),
@ArchivoAdjunto7 varchar(100),
@ArchivoAdjunto8 varchar(100),
@ArchivoAdjunto9 varchar(100),
@ArchivoAdjunto10 varchar(100),
@GeneraReservaStock varchar(2),
@IdGrupoObra int,
@IdArticuloAsociado int,
@Observaciones2 ntext,
@Observaciones3 ntext,
@IdSubjefe int,
@Direccion varchar(50),
@IdLocalidad int,
@IdProvincia int,
@IdPais int,
@CodigoPostal varchar(30),
@Telefono varchar(50),
@LugarPago varchar(50),
@Responsable varchar(50),
@Horario varchar(20),
@Turnos varchar(10),
@Operarios int,
@Zona int,
@Jurisdiccion int,
@IdCuentaContableFF int,
@ValorObra numeric(18,2),
@IdMonedaValorObra int,
@IdJefeRegional int

AS

IF IsNull(@IdObra,0)<=0
    BEGIN
	INSERT INTO [Obras]
	(
	 NumeroObra,
	 IdCliente,
	 FechaInicio,
	 FechaFinalizacion,
	 Observaciones,
	 FechaEntrega,
	 Descripcion,
	 IdJefe,
	 TipoObra,
	 HorasEstimadas,
	 Consorcial,
	 EnviarEmail,
	 Activa,
	 ParaInformes,
	 IdUnidadOperativa,
	 Jerarquia,
	 ArchivoAdjunto1,
	 ArchivoAdjunto2,
	 ArchivoAdjunto3,
	 ArchivoAdjunto4,
	 ArchivoAdjunto5,
	 ArchivoAdjunto6,
	 ArchivoAdjunto7,
	 ArchivoAdjunto8,
	 ArchivoAdjunto9,
	 ArchivoAdjunto10,
	 GeneraReservaStock,
	 IdGrupoObra,
	 IdArticuloAsociado,
	 Observaciones2,
	 Observaciones3,
	 IdSubjefe,
	 Direccion,
	 IdLocalidad,
	 IdProvincia,
	 IdPais,
	 CodigoPostal,
	 Telefono,
	 LugarPago,
	 Responsable,
	 Horario,
	 Turnos,
	 Operarios,
	 Zona,
	 Jurisdiccion,
	 IdCuentaContableFF,
	 ValorObra,
	 IdMonedaValorObra,
	 IdJefeRegional
	)
	VALUES
	(
	 @NumeroObra,
	 @IdCliente,
	 @FechaInicio,
	 @FechaFinalizacion,
	 @Observaciones,
	 @FechaEntrega,
	 @Descripcion,
	 @IdJefe,
	 @TipoObra,
	 @HorasEstimadas,
	 @Consorcial,
	 @EnviarEmail,
	 @Activa,
	 @ParaInformes,
	 @IdUnidadOperativa,
	 @Jerarquia,
	 @ArchivoAdjunto1,
	 @ArchivoAdjunto2,
	 @ArchivoAdjunto3,
	 @ArchivoAdjunto4,
	 @ArchivoAdjunto5,
	 @ArchivoAdjunto6,
	 @ArchivoAdjunto7,
	 @ArchivoAdjunto8,
	 @ArchivoAdjunto9,
	 @ArchivoAdjunto10,
	 @GeneraReservaStock,
	 @IdGrupoObra,
	 @IdArticuloAsociado,
	 @Observaciones2,
	 @Observaciones3,
	 @IdSubjefe,
	 @Direccion,
	 @IdLocalidad,
	 @IdProvincia,
	 @IdPais,
	 @CodigoPostal,
	 @Telefono,
	 @LugarPago,
	 @Responsable,
	 @Horario,
	 @Turnos,
	 @Operarios,
	 @Zona,
	 @Jurisdiccion,
	 @IdCuentaContableFF,
	 @ValorObra,
	 @IdMonedaValorObra,
	 @IdJefeRegional
	)
	SELECT @IdObra=@@identity
    END
ELSE
    BEGIN
	UPDATE Obras
	SET 
	 NumeroObra=@NumeroObra,
	 IdCliente=@IdCliente,
	 FechaInicio=@FechaInicio,
	 FechaFinalizacion=@FechaFinalizacion,
	 Observaciones=@Observaciones,
	 FechaEntrega=@FechaEntrega,
	 Descripcion=@Descripcion,
	 IdJefe=@IdJefe,
	 TipoObra=@TipoObra,
	 HorasEstimadas=@HorasEstimadas,
	 Consorcial=@Consorcial,
	 EnviarEmail=@EnviarEmail,
	 Activa=@Activa,
	 ParaInformes=@ParaInformes,
	 IdUnidadOperativa=@IdUnidadOperativa,
	 Jerarquia=@Jerarquia,
	 ArchivoAdjunto1=@ArchivoAdjunto1,
	 ArchivoAdjunto2=@ArchivoAdjunto2,
	 ArchivoAdjunto3=@ArchivoAdjunto3,
	 ArchivoAdjunto4=@ArchivoAdjunto4,
	 ArchivoAdjunto5=@ArchivoAdjunto5,
	 ArchivoAdjunto6=@ArchivoAdjunto6,
	 ArchivoAdjunto7=@ArchivoAdjunto7,
	 ArchivoAdjunto8=@ArchivoAdjunto8,
	 ArchivoAdjunto9=@ArchivoAdjunto9,
	 ArchivoAdjunto10=@ArchivoAdjunto10,
	 GeneraReservaStock=@GeneraReservaStock,
	 IdGrupoObra=@IdGrupoObra,
	 IdArticuloAsociado=@IdArticuloAsociado,
	 Observaciones2=@Observaciones2,
	 Observaciones3=@Observaciones3,
	 IdSubjefe=@IdSubjefe,
	 Direccion=@Direccion,
	 IdLocalidad=@IdLocalidad,
	 IdProvincia=@IdProvincia,
	 IdPais=@IdPais,
	 CodigoPostal=@CodigoPostal,
	 Telefono=@Telefono,
	 LugarPago=@LugarPago,
	 Responsable=@Responsable,
	 Horario=@Horario,
	 Turnos=@Turnos,
	 Operarios=@Operarios,
	 Zona=@Zona,
	 Jurisdiccion=@Jurisdiccion,
	 IdCuentaContableFF=@IdCuentaContableFF,
	 ValorObra=@ValorObra,
	 IdMonedaValorObra=@IdMonedaValorObra,
	 IdJefeRegional=@IdJefeRegional
	WHERE (IdObra=@IdObra)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdObra



GO
/****** Object:  StoredProcedure [dbo].[wComparativas_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wComparativas_E @IdComparativa INT
AS 
    DELETE  Comparativas
    WHERE   ( IdComparativa = @IdComparativa )

GO
/****** Object:  StoredProcedure [dbo].[wObras_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wObras_E]

@IdObra int  

AS 

DELETE Obras
WHERE (IdObra=@IdObra)



GO
/****** Object:  StoredProcedure [dbo].[wComparativas_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wComparativas_T
    @IdComparativa INT = NULL
AS 
    SET @IdComparativa = ISNULL(@IdComparativa, -1)
  
    SELECT  *,
         Cmp.IdComparativa,
 Cmp.Numero,
 Cmp.Fecha as [Fecha Comparativa],
 Case When IsNull(Cmp.PresupuestoSeleccionado,0)<>-1 Then 'Monopresupuesto' Else 'Multipresupuesto' End as [Tipo seleccion],
 (Select Empleados.Nombre From Empleados Where Cmp.IdConfecciono=Empleados.IdEmpleado) as [Confecciono],
 (Select Empleados.Nombre From Empleados Where Cmp.IdAprobo=Empleados.IdEmpleado) as [Aprobo],
 Cmp.MontoPrevisto as [Monto previsto],
 Cmp.MontoParaCompra,
 --(Select Count(*) From #Auxiliar0 Where #Auxiliar0.IdComparativa=Cmp.IdComparativa) as [Cant.Sol.],
 Cmp.ArchivoAdjunto1 as [Archivo adjunto 1],
 Cmp.ArchivoAdjunto2 as [Archivo adjunto 2]
    FROM    Comparativas Cmp
    WHERE   @IdComparativa = -1
            OR ( IdComparativa = @IdComparativa )
    ORDER BY IdComparativa DESC

GO
/****** Object:  StoredProcedure [dbo].[wObras_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wObras_T]

@IdObra int = Null

AS 

SET @IdObra=IsNull(@IdObra,-1)

SELECT 
 Obras.*,
 Clientes.RazonSocial as [Cliente],
 UnidadesOperativas.Descripcion as [UnidadOperativa],
 E1.Nombre as [JefeObra],
 E2.Nombre as [SubjefeObra],
 E3.Nombre as [JefeRegionalObra],
 Articulos.Descripcion as [ArticuloAsociado],
 Localidades.Nombre as [Localidad], 
 Provincias.Nombre as [Provincia], 
 Paises.Descripcion as [Pais], 
 Cuentas.Codigo as [CodigoCuentaFF],
 Monedas.Abreviatura as [MonedaValorObra],
 GruposObras.Descripcion as [GrupoObra]
FROM Obras
LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
LEFT OUTER JOIN Empleados E1 ON Obras.IdJefe = E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON Obras.IdSubjefe = E2.IdEmpleado
LEFT OUTER JOIN Empleados E3 ON Obras.IdJefeRegional = E3.IdEmpleado
LEFT OUTER JOIN UnidadesOperativas ON Obras.IdUnidadOperativa = UnidadesOperativas.IdUnidadOperativa
LEFT OUTER JOIN Articulos ON Obras.IdArticuloAsociado = Articulos.IdArticulo
LEFT OUTER JOIN Localidades ON Obras.IdLocalidad = Localidades.IdLocalidad 
LEFT OUTER JOIN Provincias ON Obras.IdProvincia = Provincias.IdProvincia
LEFT OUTER JOIN Paises ON Obras.IdPais = Paises.IdPais
LEFT OUTER JOIN Cuentas ON Obras.IdCuentaContableFF = Cuentas.IdCuenta
LEFT OUTER JOIN Monedas ON Obras.IdMonedaValorObra = Monedas.IdMoneda
LEFT OUTER JOIN GruposObras ON Obras.IdGrupoObra = GruposObras.IdGrupoObra
WHERE @IdObra=-1 or Obras.IdObra=@IdObra
ORDER BY Obras.NumeroObra



GO
/****** Object:  StoredProcedure [dbo].[wComparativas_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wComparativas_TL
AS --mono
    SELECT  CONVERT(VARCHAR, Numero) AS Numero,
            CONVERT(VARCHAR, Numero) + ' del ' + CONVERT(VARCHAR, Fecha, 103) AS [Titulo],
            Comparativas.Numero AS Orden
    FROM    Comparativas
    WHERE   PresupuestoSeleccionado IS NOT NULL
            AND PresupuestoSeleccionado <> -1
    UNION

--multi
    SELECT DISTINCT
            CONVERT(VARCHAR, COMP.Numero) + ';'
            + CONVERT(VARCHAR, DETCOMP.idpresupuesto) AS Numero,
            CONVERT(VARCHAR, COMP.Numero) + ' del ' + CONVERT(VARCHAR, Fecha, 103)
            + ' MULTI:' + CONVERT(VARCHAR, DETCOMP.idpresupuesto) + ' '
            + PROV.RazonSocial AS [Titulo],
            COMP.Numero AS Orden
    FROM    detallecomparativas DETCOMP
            INNER JOIN comparativas COMP ON DETCOMP.idcomparativa = COMP.idcomparativa
            INNER JOIN presupuestos PP ON PP.idpresupuesto = DETCOMP.idpresupuesto
            INNER JOIN proveedores PROV ON PP.idproveedor = PROV.idproveedor
    WHERE   DETCOMP.estado = 'MR'
            AND COMP.PresupuestoSeleccionado = -1
    ORDER BY Orden DESC


GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wDetComparativas_A
    @IdDetalleComparativa INT OUTPUT,
    @IdComparativa INT,
    @IdPresupuesto INT,
    @NumeroPresupuesto INT,
    @FechaPresupuesto DATETIME,
    @IdArticulo INT,
    @Cantidad NUMERIC(12, 2),
    @Precio NUMERIC(12, 4),
    @Estado VARCHAR(2),
    @SubNumero INT,
    @Observaciones NTEXT,
    @IdUnidad INT,
    @IdMoneda INT,
    @OrigenDescripcion INT,
    @PorcentajeBonificacion NUMERIC(6, 2),
    @CotizacionMoneda NUMERIC(18, 3),
    @IdDetallePresupuesto INT
AS 
    IF ISNULL(@IdDetalleComparativa, 0) <= 0 
        BEGIN   
    

            INSERT  INTO [DetalleComparativas]
                    (
                      IdComparativa,
                      IdPresupuesto,
                      NumeroPresupuesto,
                      FechaPresupuesto,
                      IdArticulo,
                      Cantidad,
                      Precio,
                      Estado,
                      SubNumero,
                      Observaciones,
                      IdUnidad,
                      IdMoneda,
                      OrigenDescripcion,
                      PorcentajeBonificacion,
                      CotizacionMoneda,
                      IdDetallePresupuesto
		        )
            VALUES  (
                      @IdComparativa,
                      @IdPresupuesto,
                      @NumeroPresupuesto,
                      @FechaPresupuesto,
                      @IdArticulo,
                      @Cantidad,
                      @Precio,
                      @Estado,
                      @SubNumero,
                      @Observaciones,
                      @IdUnidad,
                      @IdMoneda,
                      @OrigenDescripcion,
                      @PorcentajeBonificacion,
                      @CotizacionMoneda,
                      @IdDetallePresupuesto
		        )
            SELECT  @IdDetalleComparativa = @@identity
        END 
    ELSE 
        BEGIN
            UPDATE  [DetalleComparativas]
            SET     IdComparativa = @IdComparativa,
                    IdPresupuesto = @IdPresupuesto,
                    NumeroPresupuesto = @NumeroPresupuesto,
                    FechaPresupuesto = @FechaPresupuesto,
                    IdArticulo = @IdArticulo,
                    Cantidad = @Cantidad,
                    Precio = @Precio,
                    Estado = @Estado,
                    SubNumero = @SubNumero,
                    Observaciones = @Observaciones,
                    IdUnidad = @IdUnidad,
                    IdMoneda = @IdMoneda,
                    OrigenDescripcion = @OrigenDescripcion,
                    PorcentajeBonificacion = @PorcentajeBonificacion,
                    CotizacionMoneda = @CotizacionMoneda,
                    IdDetallePresupuesto = @IdDetallePresupuesto
            WHERE   ( IdDetalleComparativa = @IdDetalleComparativa )
        END

    RETURN ( @IdDetalleComparativa )

GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wDetComparativas_E
    @IdDetalleComparativa INT
AS 
    DELETE  [DetalleComparativas]
    WHERE   ( IdDetalleComparativa = @IdDetalleComparativa )


GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wDetComparativas_T
    @IdDetalleComparativa INT
AS 
    SELECT  Det.*,
            Articulos.Descripcion AS [Articulo],
            Unidades.Descripcion AS [Unidad],
            Prov.RazonSocial AS [ProveedorDelPresupuesto]
    FROM    DetalleComparativas Det
            LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN Presupuestos P ON Det.IdPresupuesto = P.IdPresupuesto
            LEFT OUTER JOIN Proveedores Prov ON P.IdProveedor = Prov.IdProveedor
    WHERE   ( IdDetalleComparativa = @IdDetalleComparativa )

GO
/****** Object:  StoredProcedure [dbo].[wDetComparativas_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetComparativas_TT] @IdComparativa INT
AS 
    SELECT  Det.*,
            Articulos.Descripcion AS [Articulo],
            Unidades.Descripcion AS [Unidad],
            Prov.RazonSocial AS [ProveedorDelPresupuesto]
--,Cuentas.Descripcion as [CuentaGastoDescripcion]
    FROM    DetalleComparativas Det --LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento=DetReq.IdRequerimiento
            LEFT OUTER JOIN Articulos ON Det.IdArticulo = Articulos.IdArticulo
--LEFT OUTER JOIN Cuentas ON Det.IdCuentaGasto = Cuentas.IdCuenta
            LEFT OUTER JOIN Unidades ON Det.IdUnidad = Unidades.IdUnidad
--LEFT OUTER JOIN Obras ON Cab.IdObra = Obras.IdObra
--LEFT OUTER JOIN Clientes ON Obras.IdCliente = Clientes.IdCliente
--LEFT OUTER JOIN Equipos ON DetReq.IdEquipo = Equipos.IdEquipo
--LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
--LEFT OUTER JOIN ControlesCalidad ON DetReq.IdControlCalidad = ControlesCalidad.IdControlCalidad
--LEFT OUTER JOIN Empleados E1 ON Requerimientos.Aprobo = E1.IdEmpleado
--LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
--LEFT OUTER JOIN Empleados E3 ON Requerimientos.IdComprador = E3.IdEmpleado
            LEFT OUTER JOIN Presupuestos P ON Det.IdPresupuesto = P.IdPresupuesto
            LEFT OUTER JOIN Proveedores Prov ON P.IdProveedor = Prov.IdProveedor
    WHERE   @IdComparativa = IdComparativa 


GO
/****** Object:  StoredProcedure [dbo].[wOrdenesPago_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  Procedure [dbo].[wOrdenesPago_TX_PorIdConDatos]

@IdOrdenPago int

AS 

SELECT 
 op.*, 
 Case When op.Tipo='CC' Then 'Cta. cte.' When op.Tipo='FF' Then 'F. fijo' When op.Tipo='OT' Then 'Otros' Else '' End as [Tipo1],
 Case When op.Anulada='SI' Then 'Anulada'
	Else Case When op.Estado='CA' Then 'En caja' When op.Estado='FI' Then 'A la firma' When op.Estado='EN' Then 'Entregado' Else '' End
 End as [Estado1],
 Proveedores.RazonSocial as [Proveedor],
 Cuentas.Descripcion as [Cuenta],
 Monedas.Abreviatura as [Moneda],
 Case When op.Tipo='OT' or op.Anulada='SI' Then Null Else op.DiferenciaBalanceo End as [DiferenciaBalanceo1],
 (Select Top 1 op2.NumeroOrdenPago From OrdenesPago op2 Where op2.IdOrdenPago=op.IdOPComplementariaFF) as [NumeroOrdenPagoComplementaraFF],
 E1.Nombre as [DestinatarioFF1],
 E2.Nombre as [Confecciono],
 E3.Nombre as [Modifico],
 E4.Nombre as [Anulo],
 C1.Descripcion as [ConceptoOPOtros],
 C2.Descripcion as [ClasificacionSinCanc],
 Obras.NumeroObra as [Obra]
FROM OrdenesPago op
LEFT OUTER JOIN Proveedores ON op.IdProveedor = Proveedores.IdProveedor 
LEFT OUTER JOIN Cuentas ON op.IdCuenta = Cuentas.IdCuenta
LEFT OUTER JOIN Monedas ON op.IdMoneda = Monedas.IdMoneda
LEFT OUTER JOIN Conceptos C1 ON op.IdConcepto = C1.IdConcepto
LEFT OUTER JOIN Conceptos C2 ON op.IdConcepto2 = C2.IdConcepto
LEFT OUTER JOIN Empleados E1 ON op.IdEmpleadoFF = E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON op.IdUsuarioIngreso = E2.IdEmpleado
LEFT OUTER JOIN Empleados E3 ON op.IdUsuarioModifico = E3.IdEmpleado
LEFT OUTER JOIN Empleados E4 ON op.IdUsuarioAnulo = E4.IdEmpleado
LEFT OUTER JOIN Obras ON op.IdObra = Obras.IdObra
WHERE (IdOrdenPago=@IdOrdenPago)


GO
/****** Object:  StoredProcedure [dbo].[wPedidos_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wPedidos_A]
    @IdPedido INT,
    @NumeroPedido INT,
    @IdProveedor INT,
    @FechaPedido DATETIME,
    @LugarEntrega NTEXT,
    @FormaPago NTEXT,
    @Observaciones NTEXT,
    @Bonificacion NUMERIC(12, 2),
    @TotalIva1 NUMERIC(12, 2),
    @TotalPedido NUMERIC(12, 2),
    @PorcentajeIva1 NUMERIC(6, 2),
    @IdComprador INT,
    @PorcentajeBonificacion NUMERIC(6, 2),
    @NumeroComparativa INT,
    @Contacto VARCHAR(50),
    @PlazoEntrega NTEXT,
    @Garantia NTEXT,
    @Documentacion NTEXT,
    @Aprobo INT,
    @IdMoneda INT,
    @FechaAprobacion DATETIME,
    @Importante NTEXT,
    @TipoCompra INT,
    @Cumplido VARCHAR(2),
    @DetalleCondicionCompra VARCHAR(200),
    @IdAutorizoCumplido INT,
    @IdDioPorCumplido INT,
    @FechaDadoPorCumplido DATETIME,
    @ObservacionesCumplido NTEXT,
    @SubNumero INT,
    @UsuarioAnulacion VARCHAR(6),
    @FechaAnulacion DATETIME,
    @MotivoAnulacion NTEXT,
    @ImprimeImportante VARCHAR(2),
    @ImprimePlazoEntrega VARCHAR(2),
    @ImprimeLugarEntrega VARCHAR(2),
    @ImprimeFormaPago VARCHAR(2),
    @ImprimeImputaciones VARCHAR(2),
    @ImprimeInspecciones VARCHAR(2),
    @ImprimeGarantia VARCHAR(2),
    @ImprimeDocumentacion VARCHAR(2),
    @CotizacionDolar NUMERIC(18, 3),
    @CotizacionMoneda NUMERIC(18, 3),
    @PedidoExterior VARCHAR(2),
    @IdCondicionCompra INT,
    @IdPedidoOriginal INT,
    @IdOrigenTransmision INT,
    @FechaImportacionTransmision DATETIME,
    @Subcontrato VARCHAR(2),
    @IdPedidoAbierto INT,
    @NumeroLicitacion VARCHAR(20),
    @Transmitir_a_SAT VARCHAR(2),
    @NumeracionAutomatica VARCHAR(2),
    @Impresa VARCHAR(2),
    @EmbarcadoA VARCHAR(50),
    @FacturarA VARCHAR(50),
    @ProveedorExt VARCHAR(50),
    @ImpuestosInternos NUMERIC(18, 2),
    @FechaSalida DATETIME,
    @CodigoControl NUMERIC(10, 0),
    @CircuitoFirmasCompleto VARCHAR(2)
AS 
    DECLARE @ReturnValue INT

    IF ISNULL(@IdPedido, 0) <= 0 
        BEGIN
            BEGIN TRAN
            IF @IdOrigenTransmision IS NULL
                AND ISNULL(@NumeracionAutomatica, 'NO') = 'SI' 
                BEGIN
                    IF @PedidoExterior = 'NO' 
                        BEGIN
                            SET @NumeroPedido = ISNULL(( SELECT TOP 1
                                                                P.ProximoNumeroPedido
                                                         FROM   Parametros P
                                                         WHERE  P.IdParametro = 1
                                                       ), 1)
                            UPDATE  Parametros
                            SET     ProximoNumeroPedido = @NumeroPedido + 1
                        END
                    ELSE 
                        BEGIN
                            SET @NumeroPedido = ISNULL(( SELECT TOP 1
                                                                P.ProximoNumeroPedidoExterior
                                                         FROM   Parametros P
                                                         WHERE  P.IdParametro = 1
                                                       ), 1)
                            UPDATE  Parametros
                            SET     ProximoNumeroPedidoExterior = @NumeroPedido
                                    + 1
                        END
                END
	
            SET @CodigoControl = CONVERT(NUMERIC(10, 0), RAND() * 10000000000)
	
            INSERT  INTO Pedidos
                    (
                      NumeroPedido,
                      IdProveedor,
                      FechaPedido,
                      LugarEntrega,
                      FormaPago,
                      Observaciones,
                      Bonificacion,
                      TotalIva1,
                      TotalPedido,
                      PorcentajeIva1,
                      IdComprador,
                      PorcentajeBonificacion,
                      NumeroComparativa,
                      Contacto,
                      PlazoEntrega,
                      Garantia,
                      Documentacion,
                      Aprobo,
                      IdMoneda,
                      FechaAprobacion,
                      Importante,
                      TipoCompra,
                      Cumplido,
                      DetalleCondicionCompra,
                      IdAutorizoCumplido,
                      IdDioPorCumplido,
                      FechaDadoPorCumplido,
                      ObservacionesCumplido,
                      SubNumero,
                      UsuarioAnulacion,
                      FechaAnulacion,
                      MotivoAnulacion,
                      ImprimeImportante,
                      ImprimePlazoEntrega,
                      ImprimeLugarEntrega,
                      ImprimeFormaPago,
                      ImprimeImputaciones,
                      ImprimeInspecciones,
                      ImprimeGarantia,
                      ImprimeDocumentacion,
                      CotizacionDolar,
                      CotizacionMoneda,
                      PedidoExterior,
                      IdCondicionCompra,
                      IdPedidoOriginal,
                      IdOrigenTransmision,
                      FechaImportacionTransmision,
                      Subcontrato,
                      IdPedidoAbierto,
                      NumeroLicitacion,
                      Transmitir_a_SAT,
                      NumeracionAutomatica,
                      Impresa,
                      EmbarcadoA,
                      FacturarA,
                      ProveedorExt,
                      ImpuestosInternos,
                      FechaSalida,
                      CodigoControl,
                      CircuitoFirmasCompleto
	              )
            VALUES  (
                      @NumeroPedido,
                      @IdProveedor,
                      @FechaPedido,
                      @LugarEntrega,
                      @FormaPago,
                      @Observaciones,
                      @Bonificacion,
                      @TotalIva1,
                      @TotalPedido,
                      @PorcentajeIva1,
                      @IdComprador,
                      @PorcentajeBonificacion,
                      @NumeroComparativa,
                      @Contacto,
                      @PlazoEntrega,
                      @Garantia,
                      @Documentacion,
                      @Aprobo,
                      @IdMoneda,
                      @FechaAprobacion,
                      @Importante,
                      @TipoCompra,
                      @Cumplido,
                      @DetalleCondicionCompra,
                      @IdAutorizoCumplido,
                      @IdDioPorCumplido,
                      @FechaDadoPorCumplido,
                      @ObservacionesCumplido,
                      @SubNumero,
                      @UsuarioAnulacion,
                      @FechaAnulacion,
                      @MotivoAnulacion,
                      @ImprimeImportante,
                      @ImprimePlazoEntrega,
                      @ImprimeLugarEntrega,
                      @ImprimeFormaPago,
                      @ImprimeImputaciones,
                      @ImprimeInspecciones,
                      @ImprimeGarantia,
                      @ImprimeDocumentacion,
                      @CotizacionDolar,
                      @CotizacionMoneda,
                      @PedidoExterior,
                      @IdCondicionCompra,
                      @IdPedidoOriginal,
                      @IdOrigenTransmision,
                      @FechaImportacionTransmision,
                      @Subcontrato,
                      @IdPedidoAbierto,
                      @NumeroLicitacion,
                      @Transmitir_a_SAT,
                      @NumeracionAutomatica,
                      @Impresa,
                      @EmbarcadoA,
                      @FacturarA,
                      @ProveedorExt,
                      @ImpuestosInternos,
                      @FechaSalida,
                      @CodigoControl,
                      @CircuitoFirmasCompleto
	              )

            SELECT  @ReturnValue = SCOPE_IDENTITY()
	
            IF @@ERROR <> 0 
                BEGIN
                    ROLLBACK TRAN
                    RETURN -1
                END
            ELSE 
                BEGIN
                    COMMIT TRAN
                END
        END
    ELSE 
        BEGIN
            UPDATE  Pedidos
            SET     NumeroPedido = @NumeroPedido,
                    IdProveedor = @IdProveedor,
                    FechaPedido = @FechaPedido,
                    LugarEntrega = @LugarEntrega,
                    FormaPago = @FormaPago,
                    Observaciones = @Observaciones,
                    Bonificacion = @Bonificacion,
                    TotalIva1 = @TotalIva1,
                    TotalPedido = @TotalPedido,
                    PorcentajeIva1 = @PorcentajeIva1,
                    IdComprador = @IdComprador,
                    PorcentajeBonificacion = @PorcentajeBonificacion,
                    NumeroComparativa = @NumeroComparativa,
                    Contacto = @Contacto,
                    PlazoEntrega = @PlazoEntrega,
                    Garantia = @Garantia,
                    Documentacion = @Documentacion,
                    Aprobo = @Aprobo,
                    IdMoneda = @IdMoneda,
                    FechaAprobacion = @FechaAprobacion,
                    Importante = @Importante,
                    TipoCompra = @TipoCompra,
                    Cumplido = @Cumplido,
                    DetalleCondicionCompra = @DetalleCondicionCompra,
                    IdAutorizoCumplido = @IdAutorizoCumplido,
                    IdDioPorCumplido = @IdDioPorCumplido,
                    FechaDadoPorCumplido = @FechaDadoPorCumplido,
                    ObservacionesCumplido = @ObservacionesCumplido,
                    SubNumero = @SubNumero,
                    UsuarioAnulacion = @UsuarioAnulacion,
                    FechaAnulacion = @FechaAnulacion,
                    MotivoAnulacion = @MotivoAnulacion,
                    ImprimeImportante = @ImprimeImportante,
                    ImprimePlazoEntrega = @ImprimePlazoEntrega,
                    ImprimeLugarEntrega = @ImprimeLugarEntrega,
                    ImprimeFormaPago = @ImprimeFormaPago,
                    ImprimeImputaciones = @ImprimeImputaciones,
                    ImprimeInspecciones = @ImprimeInspecciones,
                    ImprimeGarantia = @ImprimeGarantia,
                    ImprimeDocumentacion = @ImprimeDocumentacion,
                    CotizacionDolar = @CotizacionDolar,
                    CotizacionMoneda = @CotizacionMoneda,
                    PedidoExterior = @PedidoExterior,
                    IdCondicionCompra = @IdCondicionCompra,
                    IdPedidoOriginal = @IdPedidoOriginal,
                    IdOrigenTransmision = @IdOrigenTransmision,
                    FechaImportacionTransmision = @FechaImportacionTransmision,
                    Subcontrato = @Subcontrato,
                    IdPedidoAbierto = @IdPedidoAbierto,
                    NumeroLicitacion = @NumeroLicitacion,
                    Transmitir_a_SAT = @Transmitir_a_SAT,
                    NumeracionAutomatica = @NumeracionAutomatica,
                    Impresa = @Impresa,
                    EmbarcadoA = @EmbarcadoA,
                    FacturarA = @FacturarA,
                    ProveedorExt = @ProveedorExt,
                    ImpuestosInternos = @ImpuestosInternos,
                    FechaSalida = @FechaSalida,
                    CodigoControl = @CodigoControl,
                    CircuitoFirmasCompleto = @CircuitoFirmasCompleto
            WHERE   ( IdPedido = @IdPedido )

            SELECT  @ReturnValue = @IdPedido
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @ReturnValue


GO
/****** Object:  StoredProcedure [dbo].[wPaises_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wPaises_A]

@IdPais int  output,
@Descripcion varchar(50),
@Codigo varchar(3)

AS

IF IsNull(@IdPais,0)<=0
    BEGIN
	INSERT INTO Paises
	(
	 Descripcion,
	 Codigo
	)
	VALUES
	(
	 @Descripcion,
	 @Codigo
	)
	
	SELECT @IdPais=@@identity
    END
ELSE
    BEGIN
	UPDATE Paises
	SET 
	 Descripcion=@Descripcion,
	 Codigo=@Codigo
	WHERE (IdPais=@IdPais)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdPais



GO
/****** Object:  StoredProcedure [dbo].[wPedidos_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].[wPedidos_T] @IdPedido INT = NULL
AS 
    SET NOCOUNT ON

    SET @IdPedido = ISNULL(@IdPedido, -1)

    CREATE TABLE #Auxiliar0
        (
          IdPedido INTEGER,
          Requerimientos VARCHAR(100),
          Obras VARCHAR(100)
        )

    CREATE TABLE #Auxiliar1
        (
          IdPedido INTEGER,
          NumeroRequerimiento INTEGER,
          NumeroObra VARCHAR(13),
          SAT VARCHAR(1)
        )
    INSERT  INTO #Auxiliar1
            SELECT  DetPed.IdPedido,
                    CASE WHEN Requerimientos.NumeroRequerimiento IS NOT NULL
                         THEN Requerimientos.NumeroRequerimiento
                         ELSE Acopios.NumeroAcopio
                    END,
                    Obras.NumeroObra,
                    CASE WHEN DetalleRequerimientos.IdOrigenTransmision IS NOT NULL
                         THEN 'S'
                         ELSE ''
                    END
            FROM    DetallePedidos DetPed
                    LEFT OUTER JOIN DetalleAcopios ON DetPed.IdDetalleAcopios = DetalleAcopios.IdDetalleAcopios
                    LEFT OUTER JOIN Acopios ON DetalleAcopios.IdAcopio = Acopios.IdAcopio
                    LEFT OUTER JOIN DetalleRequerimientos ON DetPed.IdDetalleRequerimiento = DetalleRequerimientos.IdDetalleRequerimiento
                    LEFT OUTER JOIN Requerimientos ON DetalleRequerimientos.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
            WHERE   @IdPedido = -1
                    OR DetPed.IdPedido = @IdPedido

--Ver como optimizar esto
/*
CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 (IdPedido,NumeroRequerimiento) ON [PRIMARY]

INSERT INTO #Auxiliar0 
 SELECT IdPedido, '', ''
 FROM #Auxiliar1
 GROUP BY IdPedido

DECLARE @IdPedido1 int, @NumeroRequerimiento int, @NumeroObra varchar(13), 
	@RMs varchar(100), @Obras varchar(100), @Corte int, @SAT varchar(1)
SET @Corte=0
SET @RMs=''
SET @Obras=''
DECLARE PedReq CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdPedido, NumeroRequerimiento, NumeroObra, SAT
		FROM #Auxiliar1
		ORDER BY IdPedido
OPEN PedReq
FETCH NEXT FROM PedReq INTO @IdPedido1, @NumeroRequerimiento, @NumeroObra, @SAT
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdPedido1
	   BEGIN
		IF @Corte<>0
		   BEGIN
			UPDATE #Auxiliar0
			SET Requerimientos = SUBSTRING(@RMs,1,100), Obras = SUBSTRING(@Obras,1,100)
			WHERE #Auxiliar0.IdPedido=@Corte
		   END
		SET @RMs=''
		SET @Obras=''
		SET @Corte=@IdPedido1
	   END
	IF NOT @NumeroRequerimiento IS NULL
		IF PATINDEX('%['+CONVERT(VARCHAR,@NumeroRequerimiento)+']'+'%', @RMs)=0
			SET @RMs=@RMs+'['+CONVERT(VARCHAR,@NumeroRequerimiento)+']'+@SAT+' '
	IF NOT @NumeroObra IS NULL
		IF PATINDEX('%'+CONVERT(VARCHAR,@NumeroObra)+' '+'%', @Obras)=0
			SET @Obras=@Obras+@NumeroObra+' '
	FETCH NEXT FROM PedReq INTO @IdPedido1, @NumeroRequerimiento, @NumeroObra, @SAT
   END
 IF @Corte<>0
    BEGIN
	UPDATE #Auxiliar0
	SET Requerimientos = SUBSTRING(@RMs,1,100), Obras = SUBSTRING(@Obras,1,100)
	WHERE #Auxiliar0.IdPedido=@Corte
    END
CLOSE PedReq
DEALLOCATE PedReq

SET NOCOUNT OFF

*/


    SELECT  Pedidos.*,
            #Auxiliar0.Requerimientos AS [RMs],
            #Auxiliar0.Obras AS [Obras],
            Proveedores.RazonSocial AS [Proveedor],
            CASE WHEN TotalIva2 IS NULL
                 THEN TotalPedido - TotalIva1 + Bonificacion
                 ELSE TotalPedido - TotalIva1 - TotalIva2 + Bonificacion
            END AS [NetoGravado],
            Monedas.Abreviatura AS [Moneda],
            E1.Nombre AS [Comprador],
            E2.Nombre AS [Libero],
            ( SELECT    COUNT(*)
              FROM      DetallePedidos
              WHERE     DetallePedidos.IdPedido = Pedidos.IdPedido
            ) AS [CantidadItems],
            PedidosAbiertos.NumeroPedidoAbierto AS [PedidoAbierto],
            ( SELECT TOP 1
                        A.Descripcion
              FROM      Articulos A
              WHERE     A.IdArticulo = ( SELECT TOP 1
                                                Requerimientos.IdEquipoDestino
                                         FROM   DetalleRequerimientos DR
                                                LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento = DR.IdRequerimiento
                                         WHERE  DR.IdDetalleRequerimiento = ( SELECT TOP 1
                                                                                        DP.IdDetalleRequerimiento
                                                                              FROM      DetallePedidos DP
                                                                              WHERE     DP.IdPedido = Pedidos.IdPedido
                                                                                        AND DP.IdDetalleRequerimiento IS NOT NULL
                                                                            )
                                       )
            ) AS [EquipoDestino],
            cc.Descripcion AS [CondicionCompra],
  Pedidos.FechaSalida as [Fecha salida],
 --Pedidos.Cumplido as [Cump.],
 --#Auxiliar0.Requerimientos as [RM's],
 --#Auxiliar0.Obras as [Obras],
 --Proveedores.RazonSocial as [Proveedor],
 --IsNull(Pedidos.TotalPedido,0)-IsNull(Pedidos.TotalIva1,0)+IsNull(Pedidos.Bonificacion,0)-
	--IsNull(Pedidos.ImpuestosInternos,0)-IsNull(Pedidos.OtrosConceptos1,0)-IsNull(Pedidos.OtrosConceptos2,0)-
	--IsNull(Pedidos.OtrosConceptos3,0)-IsNull(Pedidos.OtrosConceptos4,0)-IsNull(Pedidos.OtrosConceptos5,0)as [Neto gravado],
 --Case When Bonificacion=0 Then Null Else Bonificacion End as [Bonificacion],
 Case When TotalIva1=0 Then Null Else TotalIva1 End as [Total Iva],
 IsNull(Pedidos.ImpuestosInternos,0)+IsNull(Pedidos.OtrosConceptos1,0)+IsNull(Pedidos.OtrosConceptos2,0)+
	IsNull(Pedidos.OtrosConceptos3,0)+IsNull(Pedidos.OtrosConceptos4,0)+IsNull(Pedidos.OtrosConceptos5,0)as [Otros Conceptos],
 TotalPedido as [Total pedido],
 --Monedas.Nombre as [Moneda],
 --E1.Nombre as [Comprador],
 E2.Nombre as [Liberado por],
 --(Select Count(*) From DetallePedidos Where DetallePedidos.IdPedido=Pedidos.IdPedido) as [Cant.Items],
 --Pedidos.IdPedido as [IdAux],
 --NumeroComparativa as [Comparativa],
 --Case When Pedidos.TipoCompra=1 Then 'Gestion por compras' When Pedidos.TipoCompra=2 Then 'Gestion por terceros' Else Null End as [Tipo compra],
 --Pedidos.Observaciones,
 --DetalleCondicionCompra as [Aclaracion s/condicion de compra],
 --Case When IsNull(PedidoExterior,'NO')='SI' Then 'SI' Else Null End as [Ext.],
 PedidosAbiertos.NumeroPedidoAbierto as [Pedido abierto],
 Pedidos.NumeroLicitacion as [Nro.Licitacion],
 Pedidos.Impresa as [Impresa],
 Pedidos.UsuarioAnulacion as [Anulo],
 Pedidos.FechaAnulacion as [Fecha anulacion],
 Pedidos.MotivoAnulacion as [Motivo anulacion],
 Pedidos.ImpuestosInternos as [Imp.Internos],
 (Select Top 1 A.Descripcion From Articulos A 
	Where A.IdArticulo=(Select Top 1 Requerimientos.IdEquipoDestino 
				From DetalleRequerimientos DR
				Left Outer Join Requerimientos On Requerimientos.IdRequerimiento=DR.IdRequerimiento
				Where DR.IdDetalleRequerimiento=(Select Top 1 DP.IdDetalleRequerimiento 
								 From DetallePedidos DP 
								 Where DP.IdPedido=Pedidos.IdPedido and 
									DP.IdDetalleRequerimiento is not null))) as [Equipo destino],
 Pedidos.CircuitoFirmasCompleto as [Circuito de firmas completo],
 '' as [Condicion IVA]
 --DescripcionIva.Descripcion as [Condicion IVA]
           
    FROM    Pedidos
            LEFT OUTER JOIN Proveedores ON Pedidos.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Monedas ON Pedidos.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN PedidosAbiertos ON Pedidos.IdPedidoAbierto = PedidosAbiertos.IdPedidoAbierto
            LEFT OUTER JOIN #Auxiliar0 ON Pedidos.IdPedido = #Auxiliar0.IdPedido
            LEFT OUTER JOIN Empleados E1 ON Pedidos.IdComprador = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Pedidos.Aprobo = E2.IdEmpleado
            LEFT OUTER JOIN [Condiciones Compra] cc ON Pedidos.IdCondicionCompra = cc.IdCondicionCompra
    WHERE   @IdPedido = -1
            OR Pedidos.IdPedido = @IdPedido
    ORDER BY NumeroPedido DESC,
            SubNumero DESC

    DROP TABLE #Auxiliar0
    DROP TABLE #Auxiliar1


GO
/****** Object:  StoredProcedure [dbo].[wPaises_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wPaises_E]

@IdPais int  

AS 

DELETE Paises
WHERE IdPais=@IdPais



GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wCartasDePorte_A]
    @IdCartaDePorte INT,
    @NumeroCartaDePorte BIGINT,
    @SubNumeroVagon INT,
    @IdUsuarioIngreso INT,
    @FechaIngreso DATETIME,
    @Anulada VARCHAR(2),
    @IdUsuarioAnulo INT,
    @FechaAnulacion DATETIME,
    @Observaciones VARCHAR(200),
    @Vendedor INT, --REFERENCES Articulos(idArticulo),
    @CuentaOrden1 INT, --REFERENCES Articulos(idArticulo),
    @CuentaOrden2 INT, --REFERENCES Articulos(idArticulo),
    @Corredor INT, --REFERENCES Articulos(idArticulo),
    @Entregador INT, --REFERENCES Articulos(idArticulo),
    @Procedencia VARCHAR(30),
    @Patente VARCHAR(30),	
--------------------------------------------
    @IdArticulo INT,
    @IdStock INT,
    @Partida VARCHAR(20),
    @IdUnidad INT, -- REFERENCES Unidades(idUnidad),
    @IdUbicacion INT,
    @Cantidad NUMERIC(12, 2),
-----------------------------------------
    @Cupo VARCHAR(30),
    @NetoProc NUMERIC(18, 2),
    @Calidad VARCHAR(30),
    @BrutoPto NUMERIC(18, 2),
    @TaraPto NUMERIC(18, 2),
    @NetoPto NUMERIC(18, 2),
    @Acoplado VARCHAR(30),
    @Humedad NUMERIC(18, 2),
    @Merma NUMERIC(18, 2),
    @NetoFinal NUMERIC(18, 2),
    @FechaDeCarga DATETIME,
    @FechaVencimiento DATETIME,
    @CEE VARCHAR(20),
    @IdTransportista INT,
    @TransportistaCUIT VARCHAR(13),--desnormalizado
    @IdChofer INT,
    @ChoferCUIT VARCHAR(13),  --desnormalizado
    @FechaTimeStamp TIMESTAMP,
    @Cosecha VARCHAR(20),
    @CTG INT,
    @Contrato VARCHAR(20),
    @Destino INT,
    @Subcontr1 INT,
    @Subcontr2 INT,
    @Contrato1 INT,
    @contrato2 INT,
    @KmARecorrer NUMERIC(18, 2),
    @Tarifa NUMERIC(18, 2),
    @FechaDescarga DATETIME,
    @Hora DATETIME,
    @NRecibo INT,
    @CalidadDe INT,
    @TaraFinal NUMERIC(18, 2),
    @BrutoFinal NUMERIC(18, 2),
    @Fumigada NUMERIC(18, 2),
    @Secada NUMERIC(18, 2),
    @Exporta VARCHAR(2),
    @NobleExtranos NUMERIC(18, 2),
    @NobleNegros NUMERIC(18, 2),
    @NobleQuebrados NUMERIC(18, 2),
    @NobleDaniados NUMERIC(18, 2),
    @NobleChamico NUMERIC(18, 2),
    @NobleChamico2 NUMERIC(18, 2),
    @NobleRevolcado NUMERIC(18, 2),
    @NobleObjetables NUMERIC(18, 2),
    @NobleAmohosados NUMERIC(18, 2),
    @NobleHectolitrico NUMERIC(18, 2),
    @NobleCarbon NUMERIC(18, 2),
    @NoblePanzaBlanca NUMERIC(18, 2),
    @NoblePicados NUMERIC(18, 2),
    @NobleMGrasa NUMERIC(18, 2),
    @NobleAcidezGrasa NUMERIC(18, 2),
    @NobleVerdes NUMERIC(18, 2),
    @NobleGrado INT,
    @NobleConforme VARCHAR(2),
    @NobleACamara VARCHAR(2),
    @IdFacturaImputada INT,


    @HumedadDesnormalizada NUMERIC(18, 2),
    @Factor NUMERIC(18, 2),
    @PuntoVenta INT,
    @TarifaFacturada NUMERIC(18, 2),
    @TarifaSubcontratista1 NUMERIC(18, 2),
	@TarifaSubcontratista2 NUMERIC(18, 2),
    @FechaArribo DATETIME,
    @MotivoAnulacion VARCHAR(100),
    @Corredor2 INT



	,
	@NumeroSubfijo				INT	,
	@IdEstablecimiento			INT	,
	@EnumSyngentaDivision	VARCHAR (10),

	@FechaModificacion		DATETIME,
	@IdUsuarioModifico			INT,
	@FechaEmision			DATETIME,
	@ExcluirDeSubcontratistas varchar(2),

	@IdTipoMovimiento			INT,

	@AgregaItemDeGastosAdministrativos		varchar(2),
	@IdClienteAFacturarle					INT,
    @SubnumeroDeFacturacion					INT


AS 
    IF ISNULL(@IdCartaDePorte, 0) <= 0 
        BEGIN 
		 --insert
            INSERT  INTO CartasDePorte
                    (
                      NumeroCartaDePorte,
                      SubnumeroVagon,
                      IdUsuarioIngreso,
                      FechaIngreso,
                      Anulada,
                      IdUsuarioAnulo,
                      FechaAnulacion,
                      Observaciones,
                      Vendedor, --REFERENCES Articulos(idArticulo),
                      CuentaOrden1, --REFERENCES Articulos(idArticulo),
                      CuentaOrden2, --REFERENCES Articulos(idArticulo),
                      Corredor, --REFERENCES Articulos(idArticulo),
                      Entregador,
                      Procedencia,
                      Patente,	
--------------------------------------------
                      IdArticulo,
                      IdStock,
                      Partida,
                      IdUnidad, -- REFERENCES Unidades(idUnidad),
                      IdUbicacion,
                      Cantidad,
-----------------------------------------
                      Cupo,
                      NetoProc,
                      Calidad,
                      BrutoPto,
                      TaraPto,
                      NetoPto,
                      Acoplado,
                      Humedad,
                      Merma,
                      NetoFinal,
                      FechaDeCarga,
                      FechaVencimiento,
                      CEE,
                      IdTransportista,
                      TransportistaCUITdesnormalizado,
                      IdChofer,
                      ChoferCUITdesnormalizado,
                      Cosecha,
                      CTG,
                      Contrato,
                      Destino,
                      Subcontr1,
                      Subcontr2,
                      Contrato1,
                      contrato2,
                      KmARecorrer,
                      Tarifa,
                      FechaDescarga,
                      Hora,
                      NRecibo,
                      CalidadDe,
                      TaraFinal,
                      BrutoFinal,
                      Fumigada,
                      Secada,
                      Exporta,
                      NobleExtranos,
                      NobleNegros,
                      NobleQuebrados,
                      NobleDaniados,
                      NobleChamico,
                      NobleChamico2,
                      NobleRevolcado,
                      NobleObjetables,
                      NobleAmohosados,
                      NobleHectolitrico,
                      NobleCarbon,
                      NoblePanzaBlanca,
                      NoblePicados,
                      NobleMGrasa,
                      NobleAcidezGrasa,
                      NobleVerdes,
                      NobleGrado,
                      NobleConforme,
                      NobleACamara,
                      IdFacturaImputada,

					  HumedadDesnormalizada ,
						Factor ,
						PuntoVenta ,
						TarifaFacturada ,
						TarifaSubcontratista1 ,
						TarifaSubcontratista2 ,
						FechaArribo ,
						MotivoAnulacion ,
						Corredor2 
							,NumeroSubfijo,
	IdEstablecimiento,
	EnumSyngentaDivision,

	FechaModificacion		,
	IdUsuarioModifico			,
	FechaEmision			,
	ExcluirDeSubcontratistas,
	IdTipoMovimiento			,


	AgregaItemDeGastosAdministrativos	,
	IdClienteAFacturarle					,
    SubnumeroDeFacturacion					
                    )

            VALUES  (
                      @NumeroCartaDePorte,
                      @SubNumeroVagon,
                      @IdUsuarioIngreso,
                      @FechaIngreso,
                      @Anulada,
                      @IdUsuarioAnulo,
                      @FechaAnulacion,
                      @Observaciones,
                      @Vendedor, --REFERENCES Articulos(idArticulo),
                      @CuentaOrden1, --REFERENCES Articulos(idArticulo),
                      @CuentaOrden2, --REFERENCES Articulos(idArticulo),
                      @Corredor, --REFERENCES Articulos(idArticulo),
                      @Entregador,
                      @Procedencia,
                      @Patente,	
--------------------------------------------
                      @IdArticulo,
                      @IdStock,
                      @Partida,
                      @IdUnidad, -- REFERENCES Unidades(idUnidad),
                      @IdUbicacion,
                      @Cantidad,
-----------------------------------------
                      @Cupo,
                      @NetoProc,
                      @Calidad,
                      @BrutoPto,
                      @TaraPto,
                      @NetoPto,
                      @Acoplado,
                      @Humedad,
                      @Merma,
                      @NetoFinal,
                      @FechaDeCarga,
                      @FechaVencimiento,
                      @CEE,
                      @IdTransportista,
                      @TransportistaCUIT,--desnormalizado
                      @IdChofer,
                      @ChoferCUIT,
                      @Cosecha,
                      @CTG,
                      @Contrato,
                      @Destino,
                      @Subcontr1,
                      @Subcontr2,
                      @Contrato1,
                      @contrato2,
                      @KmARecorrer,
                      @Tarifa,
                      @FechaDescarga,
                      @Hora,
                      @NRecibo,
                      @CalidadDe,
                      @TaraFinal,
                      @BrutoFinal,
                      @Fumigada,
                      @Secada,
                      @Exporta,
                      @NobleExtranos,
                      @NobleNegros,
                      @NobleQuebrados,
                      @NobleDaniados,
                      @NobleChamico,
                      @NobleChamico2,
                      @NobleRevolcado,
                      @NobleObjetables,
                      @NobleAmohosados,
                      @NobleHectolitrico,
                      @NobleCarbon,
                      @NoblePanzaBlanca,
                      @NoblePicados,
                      @NobleMGrasa,
                      @NobleAcidezGrasa,
                      @NobleVerdes,
                      @NobleGrado,
                      @NobleConforme,
                      @NobleACamara,
                      @IdFacturaImputada,

					      @HumedadDesnormalizada,
    @Factor,
    @PuntoVenta,
    @TarifaFacturada,
    @TarifaSubcontratista1,
	@TarifaSubcontratista2,
    @FechaArribo,
    @MotivoAnulacion ,
    @Corredor2 
		,@NumeroSubfijo,
	@IdEstablecimiento,
	@EnumSyngentaDivision,

	@FechaModificacion		,
	@IdUsuarioModifico			,
	@FechaEmision			,
	@ExcluirDeSubcontratistas,
	@IdTipoMovimiento			


	
	,@AgregaItemDeGastosAdministrativos	,
	@IdClienteAFacturarle					,
    @SubnumeroDeFacturacion					
		        )
            SELECT  @IdCartaDePorte = @@identity
        END

    ELSE 
        BEGIN
            DECLARE @FechaTimeStampAnt TIMESTAMP
            SET @FechaTimeStampAnt = ( SELECT TOP 1
                                                FechaTimeStamp
                                       FROM     CartasDePorte
                                       WHERE    IdCartaDePorte = 1
                                     )
		--IF @FechaTimeStampAnt<>@FechaTimeStamp RETURN(-1)


            UPDATE  CartasDePorte
            SET     NumeroCartaDePorte = @NumeroCartaDePorte,
                    SubNumeroVagon = @SubNumeroVagon,
                    IdUsuarioIngreso = @IdUsuarioIngreso,
                    FechaIngreso = @FechaIngreso,
                    Anulada = @Anulada,
                    IdUsuarioAnulo = @IdUsuarioAnulo,
                    FechaAnulacion = @FechaAnulacion,
                    Observaciones = @Observaciones,
                    Vendedor = @Vendedor, --REFERENCES Articulos(idArticulo),
                    CuentaOrden1 = @CuentaOrden1, --REFERENCES Articulos(idArticulo),
                    CuentaOrden2 = @CuentaOrden2, --REFERENCES Articulos(idArticulo),
                    Corredor = @Corredor, --REFERENCES Articulos(idArticulo),
                    Entregador = @Entregador, --REFERENCES Articulos(idArticulo),
                    Procedencia = @Procedencia,
                    Patente = @Patente,	
--------------------------------------------
                    IdArticulo = @IdArticulo,
                    IdStock = @IdStock,
                    Partida = @Partida,
                    IdUnidad = @IdUnidad, -- REFERENCES Unidades(idUnidad),
                    IdUbicacion = @IdUbicacion,
                    Cantidad = @Cantidad,
-----------------------------------------
                    Cupo = @Cupo,
                    NetoProc = @NetoProc,
                    Calidad = @Calidad,
                    BrutoPto = @BrutoPto,
                    TaraPto = @TaraPto,
                    NetoPto = @NetoPto,
                    Acoplado = @Acoplado,
                    Humedad = @Humedad,
                    Merma = @Merma,
                    NetoFinal = @NetoFinal,
                    FechaDeCarga = @FechaDeCarga,
                    FechaVencimiento = @FechaVencimiento,
                    CEE = @CEE,
                    IdTransportista = @IdTransportista,
                    TransportistaCUITdesnormalizado = @TransportistaCUIT,--desnormalizado
                    IdChofer = @IdChofer,
                    ChoferCUITdesnormalizado = @ChoferCUIT,
                    Cosecha = @Cosecha,
                    CTG = @CTG,
                    Contrato = @Contrato,
                    Destino = @Destino,
                    Subcontr1 = @Subcontr1,
                    Subcontr2 = @Subcontr2,
                    Contrato1 = @Contrato1,
                    contrato2 = @contrato2,
                    KmARecorrer = @KmARecorrer,
                    Tarifa = @Tarifa,
                    FechaDescarga = @FechaDescarga,
                    Hora = @Hora,
                    NRecibo = @NRecibo,
                    CalidadDe = @CalidadDe,
                    TaraFinal = @TaraFinal,
                    BrutoFinal = @BrutoFinal,
                    Fumigada = @Fumigada,
                    Secada = @Secada,
                    Exporta = @Exporta,
                    NobleExtranos = @NobleExtranos,
                    NobleNegros = @NobleNegros,
                    NobleQuebrados = @NobleQuebrados,
                    NobleDaniados = @NobleDaniados,
                    NobleChamico = @NobleChamico,
                    NobleChamico2 = @NobleChamico2,
                    NobleRevolcado = @NobleRevolcado,
                    NobleObjetables = @NobleObjetables,
                    NobleAmohosados = @NobleAmohosados,
                    NobleHectolitrico = @NobleHectolitrico,
                    NobleCarbon = @NobleCarbon,
                    NoblePanzaBlanca = @NoblePanzaBlanca,
                    NoblePicados = @NoblePicados,
                    NobleMGrasa = @NobleMGrasa,
                    NobleAcidezGrasa = @NobleAcidezGrasa,
                    NobleVerdes = @NobleVerdes,
                    NobleGrado = @NobleGrado,
                    NobleConforme = @NobleConforme,
                    NobleACamara = @NobleACamara,
                    IdFacturaImputada = @IdFacturaImputada,
					HumedadDesnormalizada = @HumedadDesnormalizada    ,

					Factor= @Factor,
					PuntoVenta= @PuntoVenta,
					TarifaFacturada=@TarifaFacturada ,
					TarifaSubcontratista1=@TarifaSubcontratista1 ,
					TarifaSubcontratista2=@TarifaSubcontratista2 ,
					FechaArribo=@FechaArribo ,
					MotivoAnulacion=@MotivoAnulacion ,
					Corredor2=@Corredor2 
						,NumeroSubfijo=@NumeroSubfijo,
	IdEstablecimiento=@IdEstablecimiento,	
	EnumSyngentaDivision=@EnumSyngentaDivision	,

	FechaModificacion=@FechaModificacion		,
	IdUsuarioModifico=@IdUsuarioModifico			,
	FechaEmision=@FechaEmision	,		
	ExcluirDeSubcontratistas=@ExcluirDeSubcontratistas,
	IdTipoMovimiento=@IdTipoMovimiento			

	
	,
	AgregaItemDeGastosAdministrativos=@AgregaItemDeGastosAdministrativos,
	IdClienteAFacturarle=@IdClienteAFacturarle,
    SubnumeroDeFacturacion=@SubnumeroDeFacturacion	

            WHERE   ( IdCartaDePorte = @IdCartaDePorte )
 

        END
  
    RETURN ( @IdCartaDePorte )

GO
/****** Object:  StoredProcedure [dbo].[wPaises_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wPaises_T]

@IdPais int = Null

AS 

SET @IdPais=IsNull(@IdPais,-1)

IF @IdPais=-2
	SELECT 
	 Paises.IdPais as [IdPais],
	 Paises.Descripcion as [Pais]
	FROM Paises
	ORDER BY Paises.Descripcion
ELSE
	SELECT Paises.*
	FROM Paises
	WHERE @IdPais=-1 or Paises.IdPais=@IdPais
	ORDER BY Paises.Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorte_T
    @IdCartaDePorte INT = NULL

AS 
    SET NOCOUNT ON

    SET @IdCartaDePorte = ISNULL(@IdCartaDePorte, -1)

    if   @IdCartaDePorte=-1
begin
--esto en web no tiene sentido. te estas trayendo TODA la tabla
    SELECT  CDP.*,
            CLIVEN.Razonsocial AS VendedorDesc,
            CLICO1.Razonsocial AS CuentaOrden1Desc,
            CLICO2.Razonsocial AS CuentaOrden2Desc,
            CLICOR.Nombre AS CorredorDesc,
            CLIENT.Razonsocial AS EntregadorDesc,
            CLISC1.Razonsocial AS Subcontr1Desc,
            CLISC2.Razonsocial AS Subcontr2Desc,
            Articulos.Descripcion AS Producto,
            Transportistas.RazonSocial,
--Choferes.RazonSocial,
            LOCORI.Nombre AS ProcedenciaDesc,
            LOCDES.Descripcion AS DestinoDesc,
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano 

--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 
    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
--LEFT OUTER JOIN Choferes ON CDP.IdCliente = Choferes.IdCliente
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
    WHERE   @IdCartaDePorte = -1
            OR ( IdCartaDePorte = @IdCartaDePorte )
    ORDER BY IdCartaDePorte DESC
end
else
begin
    SELECT  CDP.*,
            CLIVEN.Razonsocial AS VendedorDesc,
            CLICO1.Razonsocial AS CuentaOrden1Desc,
            CLICO2.Razonsocial AS CuentaOrden2Desc,
            CLICOR.Nombre AS CorredorDesc,
            CLIENT.Razonsocial AS EntregadorDesc,
            CLISC1.Razonsocial AS Subcontr1Desc,
            CLISC2.Razonsocial AS Subcontr2Desc,
            Articulos.Descripcion AS Producto,
            Transportistas.RazonSocial,
--Choferes.RazonSocial,
            LOCORI.Nombre AS ProcedenciaDesc,
            LOCDES.Descripcion AS DestinoDesc,
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano 

--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 
    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
--LEFT OUTER JOIN Choferes ON CDP.IdCliente = Choferes.IdCliente
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
    WHERE   @IdCartaDePorte = -1
            OR ( IdCartaDePorte = @IdCartaDePorte )

end



GO
/****** Object:  StoredProcedure [dbo].[wPaises_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wPaises_TL]
AS 
SELECT IdPais, Descripcion as [Titulo]
FROM Paises
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wCartasPorte_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wCartasPorte_TTpaginadoYfiltrado
(

	@ColumnaParaFiltrar  nvarchar(50)=null,
	@TextoParaFiltrar    nvarchar(50)=null,
	
	@sortExpression      nvarchar(50),
	
    @startRowIndex int,
    @maximumRows int
)
AS

--<asp:ListItem Text="Numero" Value="NumeroCartaDePorte" />
 --                       <asp:ListItem Text="Arribo" Value="FechaArribo" />
 --                       <asp:ListItem Text="Titular" Value="VendedorDesc" />
 --                       <asp:ListItem Text="Intermediario" Value="CuentaOrden1Desc" />
 --                       <asp:ListItem Text="R.Comercial" Value="CuentaOrden2Desc" />
 --                       <asp:ListItem Text="Corredor" Value="CorredorDesc" />
 --                       <asp:ListItem Text="Destinatario" Value="EntregadorDesc" />
 --                       <asp:ListItem Text="Producto" Value="Producto" />
 --                       <asp:ListItem Text="Origen" Value="ProcedenciaDesc" />
 --                       <asp:ListItem Text="Destino" Value="DestinoDesc" />
 --                       <asp:ListItem Text="Descarga" Value="FechaDescarga" />
 --                       <asp:ListItem Text="Neto" Value="NetoFinal" />
 --                       <asp:ListItem Text="Export" Value="Export" />


-- http://www.4guysfromrolla.com/webtech/042606-1.shtml acá explican cómo paginar 
-- http://www.4guysfromrolla.com/articles/040407-1.aspx y acá explican cómo paginar Y filtrar. Naturalmente, necesitas los (fastidiosos) parametros de filtrado
-- http://stackoverflow.com/questions/149380/dynamic-sorting-within-sql-stored-procedures acá se discute sobre NO usar SQL dinamico 


DECLARE @first_id int, @startRow int
	
set @ColumnaParaFiltrar='NumeroCartaDePorte' 
set @TextoParaFiltrar='' 

-- A check can be added to make sure @startRowIndex isn't > count(1)
-- from employees before doing any actual work unless it is guaranteed
-- the caller won't do that

-- Get the first employeeID for our page of records
SET ROWCOUNT @startRowIndex



SELECT @first_id = IdCartaDePorte 
FROM CartasDePorte 
--WHERE 
--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'

	--CASE @ColumnaParaFiltrar
	--	WHEN 'NumeroCartaDePorte' THEN NumeroCartaDePorte
	--	WHEN 'VendedorDesc' THEN VendedorDesc 
	--END
	--	LIKE '%'+@TextoParaFiltrar+'%'

ORDER BY IdCartaDePorte DESC



-- Now, set the row count to MaximumRows and get
-- all records >= @first_id
SET ROWCOUNT @maximumRows


--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------



SELECT * 
FROM CartasDePorte 
WHERE 


--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'  AND

	--CASE @ColumnaParaFiltrar
	--	WHEN 'NumeroCartaDePorte' THEN NumeroCartaDePorte
	--	WHEN 'VendedorDesc' THEN VendedorDesc 
	--	ELSE NULL
	--END
	--	LIKE '%'+@TextoParaFiltrar+'%'
	
 --	AND 
	
	IdCartaDePorte <= @first_id
ORDER BY IdCartaDePorte DESC



--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------

SET ROWCOUNT 0





 


--IF @DepartmentID IS NULL
--   -- If @DepartmentID is null, then we want to get all employees
--   EXEC dbo.GetEmployeesSubsetSorted @sortExpression, @startRowIndex, @maximumRows
--ELSE
-- BEGIN
--   -- Otherwise we want to get just those employees in the specified department
--   IF LEN(@sortExpression) = 0
--      SET @sortExpression = 'EmployeeID'

--   -- Since @startRowIndex is zero-based in the data Web control, but one-based w/ROW_NUMBER(), increment
--   SET @startRowIndex = @startRowIndex + 1


--   --dios mio, como puede ser que sean necesarias estas sentencias dinamicas....

--   -- Issue query
--   DECLARE @sql nvarchar(4000)
--   SET @sql = 'SELECT EmployeeID, LastName, FirstName, DepartmentID, Salary, 
--            HireDate, DepartmentName
--   FROM
--      (SELECT EmployeeID, LastName, FirstName, e.DepartmentID, Salary, 
--            HireDate, d.Name as DepartmentName,
--            ROW_NUMBER() OVER(ORDER BY ' + @sortExpression + ') as RowNum
--       FROM Employees e
--         INNER JOIN Departments d ON
--            e.DepartmentID = d.DepartmentID
--       WHERE e.DepartmentID = ' + CONVERT(nvarchar(10), @DepartmentID) + '
--      ) as EmpInfo
--   WHERE RowNum BETWEEN ' + CONVERT(nvarchar(10), @startRowIndex) + 
--               ' AND (' + CONVERT(nvarchar(10), @startRowIndex) + ' + ' 
--               + CONVERT(nvarchar(10), @maximumRows) + ') - 1'
      
--   -- Execute the SQL query
--   EXEC sp_executesql @sql
-- END







GO
/****** Object:  StoredProcedure [dbo].[wPedidos_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wPedidos_E]

@IdPedido int  

AS 

DELETE Pedidos 
WHERE (IdPedido=@IdPedido)



GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_FacturacionAutomatica]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wCartasDePorte_TX_FacturacionAutomatica]

@PuntoVenta int

AS

select distinct  

--ColumnaTilde ,
--IdCartaDePorte,
-- IdArticulo,
-- NumeroCartaDePorte, 
-- SubNumeroVagon,
-- SubnumeroDeFacturacion,  FechaArribo,  FechaDescarga,   FacturarselaA,  
-- IdFacturarselaA              		  ,Confirmado,           
-- IdCodigoIVA 		  , CUIT,            ClienteSeparado ,  		 
--  TarifaFacturada            ,
--  Producto,          KgNetos,  IdCorredor, 
--  IdTitular ,      IdIntermediario ,   IdRComercial, 
--  IdDestinatario,             		 
-- Titular  ,        
--   Intermediario  ,  [R. Comercial]  ,        
-- Corredor    ,  		  Destinatario,          
-- DestinoDesc  		 ,        
--   		[Procedcia.] ,            
-- IdDestino   

ColumnaTilde ,
cast (ISNULL(IdCartaDePorte,0) as int)  as IdCartaDePorte, 
cast (ISNULL( IdArticulo,0) as int) as IdArticulo,
ISNULL( NumeroCartaDePorte,0) as NumeroCartaDePorte,
cast (ISNULL( SubNumeroVagon,0) as int) as SubNumeroVagon,
cast (ISNULL( SubnumeroDeFacturacion,0) as int) as SubnumeroDeFacturacion, 
ISNULL( FechaArribo,0) as FechaArribo, 
ISNULL( FechaDescarga,0) as FechaDescarga,  
ISNULL( FacturarselaA,'') as FacturarselaA,  
cast (ISNULL( IdFacturarselaA ,0) as int) as   IdFacturarselaA          		  ,
Confirmado,           
 cast (ISNULL(IdCodigoIVA ,0) as int) as	IdCodigoIVA	  , 
 ISNULL(CUIT,'') as CUIT,            
 ClienteSeparado ,  		 
ISNULL(dbo.wTarifaWilliams(CDP.IdFacturarselaA ,CDP.IdArticulo,CDP.IdDestino , case when isnull(Exporta,'NO')='SI' then 1 else 0 end   ),0) as TarifaFacturada  ,
  ISNULL(Producto,'') as Producto ,        
  ISNULL(  KgNetos,0.0) as KgNetos, 
  cast (ISNULL( IdCorredor,0) as int) as IdCorredor, 
 cast (ISNULL( IdTitular,0) as int) as IdTitular ,    
 cast (ISNULL(  IdIntermediario,0) as int) as IdIntermediario ,  
 cast (ISNULL( IdRComercial,0) as int) as IdRComercial, 
 cast (ISNULL( IdDestinatario,0) as int) as IdDestinatario,             		 
 ISNULL(Titular,'') as Titular ,        
  ISNULL( Intermediario,'')  as Intermediario,  
  ISNULL([R. Comercial],'') as [R. Comercial] ,        
 ISNULL(Corredor,'')  as  Corredor,  		 
 ISNULL( Destinatario,'') as Destinatario,          
 ISNULL(DestinoDesc ,'')  as	DestinoDesc	 ,        
ISNULL(  		[Procedcia.],'')  as [Procedcia.],            
cast (ISNULL( IdDestino,0) as int) as  IdDestino ,
cast (ISNULL( IdCartaOriginal,0) as int) as IdCartaOriginal,
 ISNULL( AgregaItemDeGastosAdministrativos,'') as AgregaItemDeGastosAdministrativos

 
from (          

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--tit
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde ,IdCartaDePorte, CDP.IdArticulo,               NumeroCartaDePorte, 
SubNumeroVagon,CDP.SubnumeroDeFacturacion, FechaArribo, FechaDescarga,  CLIVEN.razonsocial as FacturarselaA,  CLIVEN.idcliente as IdFacturarselaA              		  ,isnull(CLIVEN.Confirmado,'NO') as Confirmado,           CLIVEN.IdCodigoIVA  		  ,CLIVEN.CUIT,           '' as ClienteSeparado ,  		 
0.0 as TarifaFacturada            ,Articulos.Descripcion as  Producto,         NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,    CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,             		 CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,     		 CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],      		 CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc  		 ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino   , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
  from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLIVEN.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino    
-- INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
 where CLIVEN.SeLeFacturaCartaPorteComoTitular='SI'    and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta

union ALL
   

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--co1 intermediario
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, 
SubNumeroVagon,CDP.SubnumeroDeFacturacion   , FechaArribo,        FechaDescarga  ,      CLICO1.razonsocial as FacturarselaA,  CLICO1.idcliente as IdFacturarselaA    	  ,isnull(CLICO1.Confirmado,'NO') as Confirmado,           CLICO1.IdCodigoIVA    		  ,CLICO1.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,     CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,              CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino    , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
 from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLICO1.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino    
-- INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
 where CLICO1.SeLeFacturaCartaPorteComoIntermediario='SI'   and isnull(CDP.IdClienteAFacturarle,-1) <= 0            
 and cdp.puntoVenta=@PuntoVenta


union ALL
   

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--co2 rem comercial
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, SubNumeroVagon ,CDP.SubnumeroDeFacturacion  , 
FechaArribo,        FechaDescarga  ,      CLICO2.razonsocial as FacturarselaA,  CLICO2.idcliente as IdFacturarselaA    	  ,isnull(CLICO2.Confirmado,'NO') as Confirmado,           CLICO2.IdCodigoIVA    		  ,CLICO2.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,    CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,               CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino   , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
  from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLICO2.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta   
 where CLICO2.SeLeFacturaCartaPorteComoRemComercial='SI'   and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta


union ALL

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--cliente auxiliar
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, SubNumeroVagon ,CDP.SubnumeroDeFacturacion  , 
FechaArribo,        FechaDescarga  ,      CLIAUX.razonsocial as FacturarselaA,  CLIAUX.idcliente as IdFacturarselaA    	  ,isnull(CLICO2.Confirmado,'NO') as Confirmado,           CLICO2.IdCodigoIVA    		  ,CLICO2.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor,
 Vendedor as IdTitular,    CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario, 
               CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,     
			      CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,   
				        		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino   , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
  from CartasDePorte CDP    
  LEFT OUTER JOIN Clientes CLIAUX ON CDP.IdClienteAuxiliar = CLIAUX.IdCliente     
  LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     
  LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLICO2.idListaPrecios = LPD.idListaPrecios    
  LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     
  LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     
  LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     
  LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     
  LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     
  LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista    
   LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     
   LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     
   LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta   
 where CLIAUX.SeLeFacturaCartaPorteComoClienteAuxiliar='SI'   and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta


union ALL

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--destinatario local
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////

SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, 
SubNumeroVagon  ,CDP.SubnumeroDeFacturacion , FechaArribo,        FechaDescarga  ,      CLIENT.razonsocial as FacturarselaA,  CLIENT.idcliente as IdFacturarselaA    	  ,isnull(CLIENT.Confirmado,'NO') as Confirmado,           CLIENT.IdCodigoIVA    		  ,CLIENT.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,   CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,                CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos    ,cdp.exporta
from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLIENT.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
where CLIENT.SeLeFacturaCartaPorteComoDestinatario='SI' and isnull(CDP.Exporta,'NO')='NO'
 and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta


union ALL
  

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--destinatario exportador
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, 
SubNumeroVagon  ,CDP.SubnumeroDeFacturacion , FechaArribo,        FechaDescarga  ,      CLIENT.razonsocial as FacturarselaA,  CLIENT.idcliente as IdFacturarselaA    	  ,isnull(CLIENT.Confirmado,'NO') as Confirmado,           CLIENT.IdCodigoIVA    		  ,CLIENT.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,   CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,                CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
    from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLIENT.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
where CLIENT.SeLeFacturaCartaPorteComoDestinatarioExportador='SI' and CDP.Exporta='SI'
	and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta


union ALL
  

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--corredor
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, 
SubNumeroVagon,CDP.SubnumeroDeFacturacion   , FechaArribo,        FechaDescarga  ,      CLICORCLI.razonsocial as FacturarselaA,  CLICORCLI.idcliente as IdFacturarselaA    	  ,isnull(CLICORCLI.Confirmado,'NO') as Confirmado,           CLICORCLI.IdCodigoIVA    		  ,CLICORCLI.CUIT,           '' as ClienteSeparado ,  		 
0.0  as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, 
Vendedor as IdTitular,  CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,                 CLIVEN.Razonsocial as   Titular  ,        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],       CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino     , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
from CartasDePorte CDP    LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     
LEFT OUTER JOIN ListasPreciosDetalle LPD ON CLICORCLI.idListaPrecios = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
where CLICORCLI.SeLeFacturaCartaPorteComoCorredor='SI'   and isnull(CDP.IdClienteAFacturarle,-1) <= 0  and isnull(IdFacturaImputada,0)<=0            
 and cdp.puntoVenta=@PuntoVenta


union ALL


--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--cliente explicito (originales)
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,IdCartaDePorte, CDP.IdArticulo,    NumeroCartaDePorte, SubNumeroVagon ,
CDP.SubnumeroDeFacturacion  , FechaArribo,        FechaDescarga  ,      CLIENT.razonsocial as FacturarselaA,  CLIENT.idcliente as IdFacturarselaA    	  ,isnull(CLIENT.Confirmado,'NO') as Confirmado,           CLIENT.IdCodigoIVA    		  ,CLIENT.CUIT,           '' as ClienteSeparado ,  		 
0.0 as TarifaFacturada       ,Articulos.Descripcion as  Producto,    NetoFinal  as  KgNetos , Corredor as IdCorredor, Vendedor as IdTitular,      CDP.CuentaOrden1 as IdIntermediario, CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,             CLIVEN.Razonsocial as   Titular  ,
        CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],      
		 CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 
		 LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino   , 0 as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta
		 from CartasDePorte CDP    LEFT OUTER JOIN Clientes CLIENT ON CDP.IdClienteAFacturarle = CLIENT.IdCliente     LEFT OUTER JOIN ListasPreciosDetalle LPD ON isnull(CLIENT.idListaPrecios,1 ) = LPD.idListaPrecios    LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
where CDP.IdClienteAFacturarle > 0            
 and cdp.puntoVenta=@PuntoVenta


union ALL

--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
--cliente explicito (duplicados)
--/////////////////////////////////////////////////////
--/////////////////////////////////////////////////////
SELECT DISTINCT 0 as ColumnaTilde    ,CDPduplicadas.IdCartaDePorte, CDP.IdArticulo,    CDP.NumeroCartaDePorte, 
	CDP.SubNumeroVagon ,CDPduplicadas.SubnumeroDeFacturacion  , CDP.FechaArribo,        CDP.FechaDescarga  ,      
	CLIENT.razonsocial as FacturarselaA,  CLIENT.idcliente as IdFacturarselaA    
		  ,isnull(CLIENT.Confirmado,'NO') as Confirmado,
    CLIENT.IdCodigoIVA    		  ,CLIENT.CUIT,           '' as ClienteSeparado ,  		 
	0.0 as TarifaFacturada       ,Articulos.Descripcion as  Producto,    CDP.NetoFinal  as  KgNetos , 
	CDP.Corredor as IdCorredor, CDP.Vendedor as IdTitular,   CDP.CuentaOrden1 as IdIntermediario, 
	CDP.CuentaOrden2 as IdRComercial, CDP.Entregador as IdDestinatario,          CLIVEN.Razonsocial as   Titular  ,        
	CLICO1.Razonsocial as   Intermediario  ,      CLICO2.Razonsocial as   [R. Comercial]  ,        CLICOR.Nombre as    [Corredor ],
    CLIENT.Razonsocial  as  [Destinatario],          LOCDES.Descripcion   as  DestinoDesc    ,         		 
	LOCORI.Nombre as    [Procedcia.] ,            CDP.Destino as IdDestino    ,
	CDP.IdCartaDePorte as IdCartaOriginal,CDP.AgregaItemDeGastosAdministrativos,cdp.exporta

from CartasDePorte CDP    
LEFT OUTER JOIN CartasDePorte CDPduplicadas ON CDP.NumeroCartaDePorte = CDPduplicadas.NumeroCartaDePorte and  CDP.SubNumeroVagon = CDPduplicadas.SubNumeroVagon and CDPduplicadas.SubnumeroDeFacturacion>0    
LEFT OUTER JOIN Clientes CLIENT ON CDPduplicadas.IdClienteAFacturarle = CLIENT.IdCliente     
LEFT OUTER JOIN ListasPreciosDetalle LPD ON isnull(CLIENT.idListaPrecios,1 ) = LPD.idListaPrecios    
LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente     
LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente     LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente     LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor     LEFT OUTER JOIN Clientes CLICORCLI ON CLICORCLI.idcliente  = (select top 1 idcliente from clientes c1 where c1.RazonSocial = CLICOR.Nombre)     LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo     LEFT OUTER JOIN Transportistas TRANS ON CDP.IdTransportista = TRANS.IdTransportista     LEFT OUTER JOIN Choferes CHOF ON CDP.IdChofer = CHOF.IdChofer     LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad     LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino     
--INNER JOIN  #temptab on  CDP.IdCartaDePorte=#temptab.IdCarta    
where CDP.IdClienteAFacturarle > 0     
 and cdp.puntoVenta=@PuntoVenta


)  as CDP 



GO
/****** Object:  StoredProcedure [dbo].[wPedidos_TX_DetPendientesTodos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wPedidos_TX_DetPendientesTodos]

AS

SET NOCOUNT ON

DECLARE @IdProveedorTransporte int, @CantReg int, @TomarPedidosSinLiberar varchar(2), @Formato int, @IdProveedor int, @IdTransportista int

SET @Formato=IsNull(@Formato,0)
SET @IdProveedor=IsNull(@IdProveedor,0)
SET @IdTransportista=IsNull(@IdTransportista,0)
SET @IdProveedorTransporte=IsNull((Select Top 1 IdProveedor From Transportistas Where IdTransportista=@IdTransportista),0)
SET @TomarPedidosSinLiberar=Isnull((Select Top 1 ProntoIni.Valor From ProntoIni 
					Left Outer Join ProntoIniClaves pic On pic.IdProntoIniClave=ProntoIni.IdProntoIniClave
					Where pic.Clave='Permitir emision de pedido sin liberar'),'')

CREATE TABLE #Auxiliar (IdProveedor INTEGER)
IF @IdProveedor>0
	INSERT INTO #Auxiliar 
	 SELECT IdProveedor FROM Proveedores WHERE IdProveedor=@IdProveedor
IF @IdProveedorTransporte>0
	INSERT INTO #Auxiliar 
	 SELECT IdProveedor FROM Proveedores WHERE IdProveedor=@IdProveedorTransporte

SET @CantReg=(Select Count(*) From #Auxiliar)

SET NOCOUNT OFF

SELECT
 Convert(varchar,Pedidos.NumeroPedido)+IsNull(' / '+Convert(varchar,Pedidos.SubNumero),'') as [Pedido],
 DetPed.NumeroItem as [Item],
 Pedidos.FechaPedido as [Fecha],
 Proveedores.RazonSocial as [Proveedor],
 Proveedores.Telefono1 as [Telefono],
 Proveedores.Email as [Email],
 Proveedores.Contacto as [Contacto],
 Empleados.Nombre as [Comprador],
 DetPed.FechaEntrega as [F.entrega],
 Articulos.Codigo as [Codigo],
 Articulos.Descripcion as [Articulo],
 DetPed.Observaciones as [Observaciones],
 DetPed.Cantidad as [Cant.],
 Unidades.Abreviatura as  [Unidad],
 (Select Sum(DetRec.Cantidad) From DetalleRecepciones DetRec
  Left Outer Join Recepciones On DetRec.IdRecepcion = Recepciones.IdRecepcion
  Where DetPed.IdDetallePedido=DetRec.IdDetallePedido and (Recepciones.Anulada is null or Recepciones.Anulada<>'SI')) as [Entregado],
 DetPed.Cantidad - Isnull((Select Sum(DetRec.Cantidad) From DetalleRecepciones DetRec 
				Left Outer Join Recepciones On Recepciones.IdRecepcion=DetRec.IdRecepcion
				Where DetRec.IdDetallePedido=DetPed.IdDetallePedido and (Recepciones.Anulada is null or Recepciones.Anulada<>'SI')),0) as [Pendiente],
 Requerimientos.NumeroRequerimiento as [NumeroRequerimiento],
 DetalleRequerimientos.NumeroItem as [NumeroItemRM],
 Acopios.NumeroAcopio as [NumeroAcopio],
 DetalleAcopios.NumeroItem as [NumeroItemLA],
 Obras.NumeroObra as [Obra],
 TiposCompra.Descripcion as [TipoCompra],
 DetalleRequerimientos.Observaciones as [ObservacionItemRM]
FROM DetallePedidos DetPed
LEFT OUTER JOIN Pedidos ON DetPed.IdPedido = Pedidos.IdPedido
LEFT OUTER JOIN Proveedores ON Pedidos.IdProveedor = Proveedores.IdProveedor
LEFT OUTER JOIN Articulos ON DetPed.IdArticulo = Articulos.IdArticulo
LEFT OUTER JOIN DetalleAcopios ON DetPed.IdDetalleAcopios = DetalleAcopios.IdDetalleAcopios
LEFT OUTER JOIN Acopios ON DetalleAcopios.IdAcopio = Acopios.IdAcopio
LEFT OUTER JOIN DetalleRequerimientos ON DetPed.IdDetalleRequerimiento = DetalleRequerimientos.IdDetalleRequerimiento
LEFT OUTER JOIN Requerimientos ON DetalleRequerimientos.IdRequerimiento = Requerimientos.IdRequerimiento
LEFT OUTER JOIN Empleados ON Pedidos.IdComprador = Empleados.IdEmpleado
LEFT OUTER JOIN DetalleLMateriales ON DetalleRequerimientos.IdDetalleLMateriales = DetalleLMateriales.IdDetalleLMateriales
LEFT OUTER JOIN LMateriales ON DetalleLMateriales.IdLMateriales=LMateriales.IdLMateriales
LEFT OUTER JOIN Equipos ON LMateriales.IdEquipo=Equipos.IdEquipo
LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
LEFT OUTER JOIN Unidades ON Unidades.IdUnidad = DetPed.IdUnidad
LEFT OUTER JOIN Obras ON Obras.IdObra = IsNull(Requerimientos.IdObra,Acopios.IdObra)
WHERE IsNull(DetPed.Cumplido,'')<>'SI' and IsNull(DetPed.Cumplido,'')<>'AN' and IsNull(Pedidos.Cumplido,'')<>'SI' and 
	(@CantReg=0 or Exists(Select Top 1 IdProveedor From #Auxiliar Where #Auxiliar.IdProveedor=Pedidos.IdProveedor)) and 
	(@TomarPedidosSinLiberar='SI' or Pedidos.Aprobo is not null)
ORDER By Pedidos.NumeroPedido,Pedidos.SubNumero,DetPed.NumeroItem

DROP TABLE #Auxiliar

GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorteMovimientos_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorteMovimientos_TT
    
AS 
    SET NOCOUNT ON

    
      
    SELECT  * from vistaCartasPorteMovimientos 
			

GO
/****** Object:  StoredProcedure [dbo].[wPedidos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wPedidos_TX_PorIdConDatos]

@IdPedido int

AS

SELECT 
 Pedidos.*,
 Substring('0000',1,4-Len(Convert(varchar,IsNull(Pedidos.PuntoVenta,0))))+Convert(varchar,IsNull(Pedidos.PuntoVenta,0))+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,Pedidos.NumeroPedido)))+Convert(varchar,Pedidos.NumeroPedido)+IsNull(' / '+Convert(varchar,Pedidos.SubNumero),'') as [Pedido],
 IsNull(Pedidos.TotalPedido,0)-IsNull(Pedidos.TotalIva1,0)+IsNull(Pedidos.Bonificacion,0)-
	IsNull(Pedidos.ImpuestosInternos,0)-IsNull(Pedidos.OtrosConceptos1,0)-IsNull(Pedidos.OtrosConceptos2,0)-
	IsNull(Pedidos.OtrosConceptos3,0)-IsNull(Pedidos.OtrosConceptos4,0)-IsNull(Pedidos.OtrosConceptos5,0) as [SubTotal],
 IsNull(Pedidos.ImpuestosInternos,0)+IsNull(Pedidos.OtrosConceptos1,0)+IsNull(Pedidos.OtrosConceptos2,0)+
	IsNull(Pedidos.OtrosConceptos3,0)+IsNull(Pedidos.OtrosConceptos4,0)+IsNull(Pedidos.OtrosConceptos5,0) as [OtrosConceptos],
 Case When Pedidos.TipoCompra=1 Then 'Gestion por compras' When Pedidos.TipoCompra=2 Then 'Gestion por terceros' Else Null End as [TipoCompra1],
 dbo.Pedidos_Requerimientos(Pedidos.IdPedido) as [RM's],
 dbo.Pedidos_Obras(Pedidos.IdPedido) as [Obras],
 Proveedores.RazonSocial as [Proveedor],
 Proveedores.Direccion as [Direccion], 
 Localidades.Nombre as [Localidad], 
 Proveedores.CodigoPostal as [CodigoPostal], 
 Provincias.Nombre as [Provincia], 
 Paises.Descripcion as [Pais], 
 Proveedores.Telefono1 as [Telefono], 
 Proveedores.Fax as [Fax], 
 Proveedores.Email as [Email], 
 Proveedores.Cuit as [Cuit], 
 DescripcionIva.Descripcion as [CondicionIVA],
 Monedas.Abreviatura as [Moneda],
 E1.Nombre as [Comprador],
 E2.Nombre as [Libero],
 cc.Descripcion as [DescripcionCondicionPago],
 (Select Top 1 A.Descripcion From Articulos A 
	Where A.IdArticulo=(Select Top 1 Requerimientos.IdEquipoDestino 
				From DetalleRequerimientos DR
				Left Outer Join Requerimientos On Requerimientos.IdRequerimiento=DR.IdRequerimiento
				Where DR.IdDetalleRequerimiento=(Select Top 1 DP.IdDetalleRequerimiento 
								 From DetallePedidos DP 
								 Where DP.IdPedido=Pedidos.IdPedido and 
									DP.IdDetalleRequerimiento is not null))) as [EquipoDestino]
FROM Pedidos
LEFT OUTER JOIN Proveedores ON Pedidos.IdProveedor=Proveedores.IdProveedor
LEFT OUTER JOIN DescripcionIva ON Proveedores.IdCodigoIva = DescripcionIva.IdCodigoIva 
LEFT OUTER JOIN Monedas ON Pedidos.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN PedidosAbiertos ON Pedidos.IdPedidoAbierto=PedidosAbiertos.IdPedidoAbierto
LEFT OUTER JOIN Empleados E1 ON Pedidos.IdComprador=E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON Pedidos.Aprobo=E2.IdEmpleado
LEFT OUTER JOIN Localidades ON Proveedores.IdLocalidad = Localidades.IdLocalidad 
LEFT OUTER JOIN Provincias ON Proveedores.IdProvincia = Provincias.IdProvincia
LEFT OUTER JOIN Paises ON Proveedores.IdPais = Paises.IdPais
LEFT OUTER JOIN [Condiciones Compra] cc ON cc.IdCondicionCompra = Pedidos.IdCondicionCompra
WHERE Pedidos.IdPedido=@IdPedido

GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_InformesLiviano]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wCartasDePorte_TX_InformesLiviano
    
	@IdCartaDePorte INT = NULL,
    @FechaDesde DATETIME = NULL,
    @FechaHasta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @IdCartaDePorte = ISNULL(@IdCartaDePorte, -1)
    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/1900'))
    SET @FechaHasta = ISNULL(@FechaHasta, CONVERT(DATETIME, '1/1/2100'))


      
    SELECT   
	cast (cdp.NumeroCartaDePorte as varchar) +'  '
				+cast (cdp.numerosubfijo as varchar) +'/'
				+cast (cdp.subnumerovagon as varchar) 	
				as NumeroCartaDePorte,
	Exporta, Vendedor,cdp.IdArticulo,cdp.corredor,cuentaorden2,entregador,procedencia,destino,
    NetoFinal,cdp.Anulada,netopto,cdp.Humedad,cdp.HumedadDesnormalizada,cdp.Observaciones,cdp.puntoventa,
     NRecibo, Hora,
    cdp.FechaArribo,cdp.FechaDescarga,cdp.Contrato,cdp.Merma,NetoProc,
            
            CLIVEN.Razonsocial AS VendedorDesc,
            CLICO1.Razonsocial AS CuentaOrden1Desc,
            CLICO2.Razonsocial AS CuentaOrden2Desc,
			
            CASE WHEN CLICOR2.Nombre IS NULL THEN 
						CLICOR.Nombre
                 ELSE 
						CLICOR.Nombre + ' - '+ CLICOR2.Nombre
            END 
				AS CorredorDesc,

            CLIENT.Razonsocial AS EntregadorDesc,
            CLISC1.Razonsocial AS Subcontr1Desc,
            CLISC2.Razonsocial AS Subcontr2Desc,
            Articulos.Descripcion AS Producto,
            Transportistas.RazonSocial AS TransportistaDesc,
--Choferes.RazonSocial,



            isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
		isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,

            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			 isnull(LOCDES.CodigoONCAA,'') AS DestinoCodigoONCAA,    
   
               			DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            --FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-'
            --+ CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            --FAC.FechaFactura,
            --CLIFAC.RazonSocial AS ClienteFacturado,
            Calidades.Descripcion AS CalidadDesc,
			IdCartaDePorte





--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 
    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Vendedores CLICOR2 ON CDP.Corredor2 = CLICOR2.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
--LEFT OUTER JOIN Choferes ON CDP.IdCliente = Choferes.IdCliente
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
    WHERE   --@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
            NOT ( Vendedor IS NULL
                  OR CLIVEN.Razonsocial = ''
                  OR Corredor IS NULL
                  OR Entregador IS NULL
                  OR CDP.IdArticulo IS NULL
                )
            AND ISNULL(NetoFinal, 0) > 0
            AND ISNULL(CDP.Anulada, 'NO') <> 'SI'
            AND ISNULL(CDP.SubnumeroDeFacturacion, 0) <= 0
            AND ( ISNULL(FechaDescarga, '1/1/1753') BETWEEN @FechaDesde
                                                    AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
    ORDER BY IdCartaDePorte DESC



GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Informes]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].[wCartasDePorte_TX_Informes]
    @IdCartaDePorte INT = NULL,
    @FechaDesde DATETIME = NULL,
    @FechaHasta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @IdCartaDePorte = ISNULL(@IdCartaDePorte, -1)
    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/1900'))
    SET @FechaHasta = ISNULL(@FechaHasta, CONVERT(DATETIME, '1/1/2100'))

      
    SELECT  CDP.*,
			CodigoSAJPYA,	
            CLIVEN.Razonsocial AS VendedorDesc,
            CLICO1.Razonsocial AS CuentaOrden1Desc,
            CLICO2.Razonsocial AS CuentaOrden2Desc,
			
            CASE WHEN CLICOR2.Nombre IS NULL THEN 
						CLICOR.Nombre
                 ELSE 
						CLICOR.Nombre + ' - '+ CLICOR2.Nombre
            END 
				AS CorredorDesc,

            CLIENT.Razonsocial AS EntregadorDesc,
            CLISC1.Razonsocial AS Subcontr1Desc,
            CLISC2.Razonsocial AS Subcontr2Desc,
            Articulos.Descripcion AS Producto,


            Transportistas.RazonSocial AS TransportistaDesc,
			 Transportistas.cuit as  TransportistaCUIT,
 choferes.cuil as  choferCUIT,
--Choferes.RazonSocial,

  isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
			isnull(LOCORI.CodigoPostal,'') AS ProcedenciaCodigoPostal,
		isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,

            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			--LOCDES.CodigoPostal AS  DestinoCodigoPostal,
			LOCDES.codigoONCAA AS  DestinoCodigoONCAA,

            
   
               			DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-'
            + CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            FAC.FechaFactura,
            CLIFAC.RazonSocial AS ClienteFacturado,
            Calidades.Descripcion AS CalidadDesc



--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 
    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Vendedores CLICOR2 ON CDP.Corredor2 = CLICOR2.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
			LEFT OUTER JOIN Choferes ON CDP.IdChofer = Choferes.IdChofer
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
    WHERE   --@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
            NOT ( Vendedor IS NULL
                  OR CLIVEN.Razonsocial = ''
                  OR Corredor IS NULL
                  OR Entregador IS NULL
                  OR CDP.IdArticulo IS NULL
                )
            AND ISNULL(NetoFinal, 0) > 0
            AND ISNULL(CDP.Anulada, 'NO') <> 'SI'
            AND ISNULL(CDP.SubnumeroDeFacturacion, 0) <= 0
            AND ( ISNULL(FechaDescarga, '1/1/1753') BETWEEN @FechaDesde
                                                    AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
    ORDER BY IdCartaDePorte DESC





GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Todas]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorte_TX_Todas
    @IdCartaDePorte INT = NULL,
    @FechaDesde DATETIME = NULL,
    @FechaHasta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @IdCartaDePorte = ISNULL(@IdCartaDePorte, -1)
    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/1753'))
    SET @FechaHasta = ISNULL(@FechaHasta, CONVERT(DATETIME, '1/1/2100'))

      
    SELECT  CDP.*,
			
			cast (cdp.NumeroCartaDePorte as varchar) +
					CASE WHEN cdp.numerosubfijo<>0 OR cdp.subnumerovagon<>0 THEN 
						'  ' + cast (cdp.numerosubfijo as varchar) + '/' +cast (cdp.subnumerovagon as varchar) 	
					ELSE 
						''
					END							
				as NumeroCompleto,
		
			datediff(minute,cdp.FechaModificacion,GETDATE()) as MinutosModifico,


 			ISNULL(Articulos.AuxiliarString5,'') AS EspecieONCAA,	
 			ISNULL(Articulos.AuxiliarString6,'') AS CodigoSAJPYA,	
 			ISNULL(Articulos.AuxiliarString7,'') AS txtCodigoZeni,	
         


			isnull(CLIVEN.Razonsocial,'') AS TitularDesc,
            isnull(CLIVEN.cuit,'') AS TitularCUIT,
            
			isnull(CLICO1.Razonsocial,'') AS IntermediarioDesc,
            isnull(CLICO1.cuit,'') AS IntermediarioCUIT,
            
			isnull(CLICO2.Razonsocial,'') AS RComercialDesc,
            isnull(CLICO2.cuit,'') AS RComercialCUIT,
            
			isnull(CLICOR.Nombre,'') AS CorredorDesc,
            isnull(CLICOR.cuit,'') AS CorredorCUIT,
            
			isnull(CLIENT.Razonsocial,'') AS DestinatarioDesc,
            isnull(CLIENT.cuit,'') AS DestinatarioCUIT,
            


			isnull(CLISC1.Razonsocial,'') AS Subcontr1Desc,
            isnull(CLISC2.Razonsocial,'') AS Subcontr2Desc,
   
               isnull(Articulos.Descripcion,'') AS Producto,



			 Transportistas.cuit as  TransportistaCUIT,
            isnull(Transportistas.RazonSocial,'') AS TransportistaDesc,
			
			choferes.cuil as  ChoferCUIT,
			choferes.Nombre as  ChoferDesc,

			

            
            isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
			isnull(LOCORI.CodigoPostal,'') AS ProcedenciaCodigoPostal,
			isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,


            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			--LOCDES.CodigoPostal AS  DestinoCodigoPostal,
		 	'' AS  DestinoCodigoPostal,
			isnull(LOCDES.codigoONCAA,'') AS  DestinoCodigoONCAA,

  
              
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            
         	FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-' + CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            FAC.FechaFactura,
            isnull(CLIFAC.RazonSocial,'') AS ClienteFacturado,
            isnull(CLIFAC.cuit,'') AS ClienteFacturadoCUIT,

            
            			Calidades.Descripcion AS CalidadDesc,


						E1.Nombre as UsuarioIngreso
						,		isnull(ESTAB.Descripcion,'') + ' ' + Convert(varchar(200),isnull(ESTAB.AuxiliarString1,'')  COLLATE SQL_Latin1_General_CP1_CI_AS)+ ' ' + Convert(varchar(200),isnull(ESTAB.AuxiliarString2,'')  COLLATE SQL_Latin1_General_CP1_CI_AS ) as EstablecimientoDesc

--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 


    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
			LEFT OUTER JOIN Choferes ON CDP.IdChofer = Choferes.IdChofer
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
			LEFT OUTER JOIN CDPEstablecimientos ESTAB ON CDP.IdEstablecimiento = ESTAB.IdEstablecimiento
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
  LEFT OUTER JOIN Empleados E1 ON CDP.IdUsuarioIngreso = E1.IdEmpleado

                    
    WHERE   1=1
		--@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
          
            --AND ( ISNULL(FechaArribo, '1/1/1753') BETWEEN @FechaDesde  AND     @FechaHasta )

            AND ( ISNULL(FechaDescarga, FechaArribo) BETWEEN @FechaDesde AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
    ORDER BY IdCartaDePorte DESC





GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_Posiciones]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorte_TX_Posiciones
    @FechaDesde DATETIME = NULL,
    @FechaHasta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/1753'))
    SET @FechaHasta = ISNULL(@FechaHasta, CONVERT(DATETIME, '1/1/2100'))

      
    SELECT  CDP.*,
			
			cast (cdp.NumeroCartaDePorte as varchar) +
					CASE WHEN cdp.numerosubfijo<>0 OR cdp.subnumerovagon<>0 THEN 
						'  ' + cast (cdp.numerosubfijo as varchar) + '/' +cast (cdp.subnumerovagon as varchar) 	
					ELSE 
						''
					END							
				as NumeroCompleto,
		
			datediff(minute,cdp.FechaModificacion,GETDATE()) as MinutosModifico,


 			ISNULL(Articulos.AuxiliarString5,'') AS EspecieONCAA,	
 			ISNULL(Articulos.AuxiliarString6,'') AS CodigoSAJPYA,	
 			ISNULL(Articulos.AuxiliarString7,'') AS txtCodigoZeni,	
         


			isnull(CLIVEN.Razonsocial,'') AS TitularDesc,
            isnull(CLIVEN.cuit,'') AS TitularCUIT,
            
			isnull(CLICO1.Razonsocial,'') AS IntermediarioDesc,
            isnull(CLICO1.cuit,'') AS IntermediarioCUIT,
            
			isnull(CLICO2.Razonsocial,'') AS RComercialDesc,
            isnull(CLICO2.cuit,'') AS RComercialCUIT,
            
			isnull(CLICOR.Nombre,'') AS CorredorDesc,
            isnull(CLICOR.cuit,'') AS CorredorCUIT,
            
			isnull(CLIENT.Razonsocial,'') AS DestinatarioDesc,
            isnull(CLIENT.cuit,'') AS DestinatarioCUIT,
            


			isnull(CLISC1.Razonsocial,'') AS Subcontr1Desc,
            isnull(CLISC2.Razonsocial,'') AS Subcontr2Desc,
   
               isnull(Articulos.Descripcion,'') AS Producto,



			 Transportistas.cuit as  TransportistaCUIT,
            isnull(Transportistas.RazonSocial,'') AS TransportistaDesc,
			
			choferes.cuil as  ChoferCUIT,
			choferes.Nombre as  ChoferDesc,

			

            
            isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
			isnull(LOCORI.CodigoPostal,'') AS ProcedenciaCodigoPostal,
			isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,


            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			--LOCDES.CodigoPostal AS  DestinoCodigoPostal,
		 	'' AS  DestinoCodigoPostal,
			isnull(LOCDES.codigoONCAA,'') AS  DestinoCodigoONCAA,

  
              
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            
         	FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-' + CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            FAC.FechaFactura,
            isnull(CLIFAC.RazonSocial,'') AS ClienteFacturado,
            isnull(CLIFAC.cuit,'') AS ClienteFacturadoCUIT,

            
            			Calidades.Descripcion AS CalidadDesc,


						E1.Nombre as UsuarioIngreso


--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 


    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
			LEFT OUTER JOIN Choferes ON CDP.IdChofer = Choferes.IdChofer
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
  LEFT OUTER JOIN Empleados E1 ON CDP.IdUsuarioIngreso = E1.IdEmpleado

                    
    WHERE   1=1
		--@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
          
            --AND ( ISNULL(FechaArribo, '1/1/1753') BETWEEN @FechaDesde  AND     @FechaHasta )

            AND ( ISNULL(FechaDescarga, FechaArribo) BETWEEN @FechaDesde AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
            AND NOT (Vendedor IS NULL OR Corredor IS NULL OR Entregador IS NULL OR CDP.IdArticulo IS NULL) 
			AND ISNULL(NetoProc,0)=0 AND ISNULL(IdFacturaImputada,0)=0 AND ISNULL(CDP.Anulada,'NO')<>'SI' 


    ORDER BY IdCartaDePorte DESC





GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_DescargasDeHoyMasTodasLasPosiciones]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorte_TX_DescargasDeHoyMasTodasLasPosiciones
    @FechaHoy DATETIME = NULL
    
AS 
    SET NOCOUNT ON

    SET @FechaHoy = ISNULL(@FechaHoy, GETDATE())
      
    SELECT  CDP.*,
			
			cast (cdp.NumeroCartaDePorte as varchar) +
					CASE WHEN cdp.numerosubfijo<>0 OR cdp.subnumerovagon<>0 THEN 
						'  ' + cast (cdp.numerosubfijo as varchar) + '/' +cast (cdp.subnumerovagon as varchar) 	
					ELSE 
						''
					END							
				as NumeroCompleto,
		
			datediff(minute,cdp.FechaModificacion,GETDATE()) as MinutosModifico,


 			ISNULL(Articulos.AuxiliarString5,'') AS EspecieONCAA,	
 			ISNULL(Articulos.AuxiliarString6,'') AS CodigoSAJPYA,	
 			ISNULL(Articulos.AuxiliarString7,'') AS txtCodigoZeni,	
         


			isnull(CLIVEN.Razonsocial,'') AS TitularDesc,
            isnull(CLIVEN.cuit,'') AS TitularCUIT,
            
			isnull(CLICO1.Razonsocial,'') AS IntermediarioDesc,
            isnull(CLICO1.cuit,'') AS IntermediarioCUIT,
            
			isnull(CLICO2.Razonsocial,'') AS RComercialDesc,
            isnull(CLICO2.cuit,'') AS RComercialCUIT,
            
			isnull(CLICOR.Nombre,'') AS CorredorDesc,
            isnull(CLICOR.cuit,'') AS CorredorCUIT,
            
			isnull(CLIENT.Razonsocial,'') AS DestinatarioDesc,
            isnull(CLIENT.cuit,'') AS DestinatarioCUIT,
            


			isnull(CLISC1.Razonsocial,'') AS Subcontr1Desc,
            isnull(CLISC2.Razonsocial,'') AS Subcontr2Desc,
   
               isnull(Articulos.Descripcion,'') AS Producto,



			 Transportistas.cuit as  TransportistaCUIT,
            isnull(Transportistas.RazonSocial,'') AS TransportistaDesc,
			
			choferes.cuil as  ChoferCUIT,
			choferes.Nombre as  ChoferDesc,

			

            
            isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
			isnull(LOCORI.CodigoPostal,'') AS ProcedenciaCodigoPostal,
			isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,


            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			--LOCDES.CodigoPostal AS  DestinoCodigoPostal,
		 	'' AS  DestinoCodigoPostal,
			isnull(LOCDES.codigoONCAA,'') AS  DestinoCodigoONCAA,

  
              
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            
         	FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-' + CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            FAC.FechaFactura,
            isnull(CLIFAC.RazonSocial,'') AS ClienteFacturado,
            isnull(CLIFAC.cuit,'') AS ClienteFacturadoCUIT,

            
            			Calidades.Descripcion AS CalidadDesc,


						E1.Nombre as UsuarioIngreso


--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 


    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
			LEFT OUTER JOIN Choferes ON CDP.IdChofer = Choferes.IdChofer
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
  LEFT OUTER JOIN Empleados E1 ON CDP.IdUsuarioIngreso = E1.IdEmpleado

                    
    WHERE   1=1
		--@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
          
            --AND ( ISNULL(FechaArribo, '1/1/1753') BETWEEN @FechaDesde  AND     @FechaHasta )

--            AND ( ISNULL(FechaDescarga, FechaArribo) BETWEEN @FechaDesde AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
   AND 
        (                                               
            ( NOT (Vendedor IS NULL OR Corredor IS NULL OR Entregador IS NULL OR CDP.IdArticulo IS NULL) 
				AND 
			  ISNULL(NetoProc,0)=0 AND ISNULL(IdFacturaImputada,0)=0 AND ISNULL(CDP.Anulada,'NO')<>'SI' 
			 ) 
        OR                                              
            ( ISNULL(NetoProc,0)>0 AND fechadescarga >=@FechaHoy  )
        ) 

    ORDER BY IdCartaDePorte DESC

	

GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_PorIdFactura]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE  PROCEDURE [dbo].wCartasDePorte_TX_PorIdFactura
    @IdFactura INT 
AS 

select 


			CDP.IdCartaDePorte,
			CDP.NumeroCartaDePorte,
			detfac.iddetallefactura,
			detfac.observaciones as detobs,
			
			isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			CDP.destino,
			CDP.entregador as destinatario,
			
			CDP.IdArticulo, 
			CDP.NetoFinal as Cantidad, --uso el de antes de quitarle las mermas

			
			CDP.Contrato,
			CDP.NetoFinal,
			CDP.FechaDescarga,
			CDP.AgregaItemDeGastosAdministrativos,


			CABFAC.IdFactura, 
			CABFAC.NumeroFactura,
			CABFAC.FechaFactura,
			CLIFAC.RazonSocial,
			CLIFAC.Direccion,
			CLIFAC.CodigoPostal,
			CABFAC.IdCodigoIva,
			CABFAC.Observaciones,

		
			/*
			DETFAC.IdArticulo,
			DETFAC.Observaciones as DetObservaciones,
			DETFAC.PrecioUnitario,
			DETFAC.Cantidad,
			DETFAC.PrecioUnitarioTotal,
			*/
         
			isnull(CLIVEN.Razonsocial,'') AS TitularDesc,
            isnull(CLIVEN.cuit,'') AS TitularCUIT,
        	isnull(CLICO1.Razonsocial,'') AS IntermediarioDesc,
            isnull(CLICO1.cuit,'') AS IntermediarioCUIT,
        	isnull(CLICO2.Razonsocial,'') AS RComercialDesc,
            isnull(CLICO2.cuit,'') AS RComercialCUIT,
        	isnull(CLICOR.Nombre,'') AS CorredorDesc,
            isnull(CLICOR.cuit,'') AS CorredorCUIT,
        	isnull(CLIENT.Razonsocial,'') AS DestinatarioDesc,
            isnull(CLIENT.cuit,'') AS DestinatarioCUIT,
			isnull(Articulos.Descripcion,'') AS Producto,
		 	'' AS  DestinoCodigoPostal,
			isnull(LOCDES.codigoONCAA,'') AS  DestinoCodigoONCAA,

substring(cabfac.NumeroExpedienteCertificacionObra,4,1) as AgrupacionUsada

from facturas CABFAC
left join CartasDePorte CDP on CDP.IdFacturaImputada=CABFAC.IdFactura  
LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
LEFT OUTER JOIN Log PRONTOLOG ON CABFAC.Idfactura = PRONTOLOG.Idcomprobante and prontolog.Detalle like 'Factura de CartasPorte%'
left OUTER  join detallefacturas DETFAC 
				on
				( 
					CABFAC.IdFactura=DETFAC.idFactura 
					and CDP.IdArticulo = DETFAC.IdArticulo
					and  charindex(Articulos.Descripcion, 'CAMBIO DE CARTA')=0 					 --
					and  charindex(LOCDES.Descripcion  COLLATE SQL_Latin1_General_CP1_CI_AS, detfac.Observaciones)>0  --el destino
					and 
					(
						(				
							substring(cabfac.NumeroExpedienteCertificacionObra,4,1)<>'4' --no es CANJE
							AND
							(
								LOCDES.Descripcion = cast(detfac.Observaciones as nvarchar(300)) + ' '
								or 
								charindex(CLIVEN.Razonsocial  COLLATE SQL_Latin1_General_CP1_CI_AS, detfac.Observaciones)>0
							)
						)
						or
						(
							--es canje (se agrupa por CLICO1 y CLICO2)
							substring(cabfac.NumeroExpedienteCertificacionObra,4,1)='4' --es CANJE
							AND
							charindex( CAST( isnull(CLICO1.IdCliente,-1) as varchar)  +  ' ' + CAST( isnull(CLICO2.IdCliente,-1) as varchar)     , detfac.Observaciones)>0
							--charindex(CLICO1.Razonsocial  COLLATE SQL_Latin1_General_CP1_CI_AS, PRONTOLOG.detalle )>0
							--or
							--charindex(CLICO2.Razonsocial  COLLATE SQL_Latin1_General_CP1_CI_AS, PRONTOLOG.detalle)>0
						)
					)
				)	
--cómo sé a qué item del detalle de la factura le corresponde cuál carta?
--qué agrupamientos de cartas son posibles en la factura?
-- -en las observaciones del item pongo la agrupacion (destino-destinatario/titular-etc) separando solamente con un espacio,asi
-- q no puedo saber 

LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
LEFT OUTER JOIN Choferes ON CDP.IdChofer = Choferes.IdChofer
LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = CABFAC.IdCliente


where CABFAC.idFactura=@idFactura
order by IdDetalleFactura --para q esten ordenados como en la factura    NumeroCartaDePorte







GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_InformesCorregido]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].wCartasDePorte_TX_InformesCorregido
    @IdCartaDePorte INT = NULL,
    @FechaDesde DATETIME = NULL,
    @FechaHasta DATETIME = NULL
AS 
    SET NOCOUNT ON

    SET @IdCartaDePorte = ISNULL(@IdCartaDePorte, -1)
    SET @FechaDesde = ISNULL(@FechaDesde, CONVERT(DATETIME, '1/1/1900'))
    SET @FechaHasta = ISNULL(@FechaHasta, CONVERT(DATETIME, '1/1/2100'))

      
    SELECT  
			CDP.*,

			ISNULL(Articulos.AuxiliarString5,'') AS EspecieONCAA,	
 			ISNULL(Articulos.AuxiliarString6,'') AS CodigoSAJPYA,	
 			ISNULL(Articulos.AuxiliarString7,'') AS txtCodigoZeni,	

            
			isnull(CLIVEN.Razonsocial,'') AS TitularDesc,
            isnull(CLIVEN.cuit,'') AS TitularCUIT,
            
			isnull(CLICO1.Razonsocial,'') AS IntermediarioDesc,
            isnull(CLICO1.cuit,'') AS IntermediarioCUIT,
            
			isnull(CLICO2.Razonsocial,'') AS RComercialDesc,
            isnull(CLICO2.cuit,'') AS RComercialCUIT,
            
			isnull(CLICOR.Nombre,'') AS CorredorDesc,
            isnull(CLICOR.cuit,'') AS CorredorCUIT,
            
			isnull(CLIENT.Razonsocial,'') AS DestinatarioDesc,
            isnull(CLIENT.cuit,'') AS DestinatarioCUIT,
            


			isnull(CLISC1.Razonsocial,'') AS Subcontr1Desc,
            isnull(CLISC2.Razonsocial,'') AS Subcontr2Desc,
   
               isnull(Articulos.Descripcion,'') AS Producto,
            isnull(Transportistas.RazonSocial,'') AS TransportistaDesc,
            isnull(Choferes.Nombre,'') AS ChoferDesc,

--Choferes.RazonSocial,
            


            isnull(LOCORI.Nombre,'') AS ProcedenciaDesc,
			isnull(LOCORI.CodigoPostal,'') AS ProcedenciaCodigoPostal,
		isnull(LOCORI.CodigoONCAA,'') AS ProcedenciaCodigoONCAA,
		isnull(LOCORI.CodigoWilliams,'') AS ProcedenciaCodigoWilliams,

            isnull(LOCDES.Descripcion,'') AS DestinoDesc,
			--LOCDES.CodigoPostal AS  DestinoCodigoPostal,
			isnull(LOCDES.CodigoPostal,'') AS  DestinoCodigoPostal,
			isnull(LOCDES.codigoONCAA,'') AS  DestinoCodigoONCAA, 
		isnull(LOCDES.CodigoWilliams,'') 	 AS  DestinoCodigoWilliams, 
		isnull(LOCDES.CUIT,'') 	 AS  DestinoCUIT, 

 choferes.cuil as  choferCUIT,
 Transportistas.cuit as  TransportistaCUIT,
              
            DATENAME(month, FechaDescarga) AS Mes,
            DATEPART(year, FechaDescarga) AS Ano, 

--null as TarifaSubcontratista1,
--null as TarifaSubcontratista2,
            
         	FAC.TipoABC + '-' + CAST(FAC.PuntoVenta AS VARCHAR) + '-' + CAST(FAC.NumeroFactura AS VARCHAR) AS Factura,
            FAC.FechaFactura,
            isnull(CLIFAC.RazonSocial,'') AS ClienteFacturado,
            isnull(CLIFAC.cuit,'') AS ClienteFacturadoCUIT,

            
            Calidades.Descripcion AS CalidadDesc,
			ExcluirDeSubcontratistas


--IdCartaDePorte,NumeroCartaDePorte,Arribo,Hora,Exporta,Producto, 
    FROM    CartasDePorte CDP
            LEFT OUTER JOIN Clientes CLIVEN ON CDP.Vendedor = CLIVEN.IdCliente
            LEFT OUTER JOIN Clientes CLICO1 ON CDP.CuentaOrden1 = CLICO1.IdCliente
            LEFT OUTER JOIN Clientes CLICO2 ON CDP.CuentaOrden2 = CLICO2.IdCliente
            LEFT OUTER JOIN Vendedores CLICOR ON CDP.Corredor = CLICOR.IdVendedor
            LEFT OUTER JOIN Clientes CLIENT ON CDP.Entregador = CLIENT.IdCliente
            LEFT OUTER JOIN Clientes CLISC1 ON CDP.Subcontr1 = CLISC1.IdCliente
            LEFT OUTER JOIN Clientes CLISC2 ON CDP.Subcontr2 = CLISC2.IdCliente
            LEFT OUTER JOIN Articulos ON CDP.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Calidades ON CDP.CalidadDe = Calidades.IdCalidad
            LEFT OUTER JOIN Transportistas ON CDP.IdTransportista = Transportistas.IdTransportista
			LEFT OUTER JOIN Choferes ON CDP.Idchofer = Choferes.Idchofer
            LEFT OUTER JOIN Localidades LOCORI ON CDP.Procedencia = LOCORI.IdLocalidad
            LEFT OUTER JOIN WilliamsDestinos LOCDES ON CDP.Destino = LOCDES.IdWilliamsDestino
            LEFT OUTER JOIN Facturas FAC ON CDP.idFacturaImputada = FAC.IdFactura
            LEFT OUTER JOIN Clientes CLIFAC ON CLIFAC.IdCliente = FAC.IdCliente
  
  
  

                    
    WHERE   --@IdCartaDePorte=-1 or 
		--(IdCartaDePorte=@IdCartaDePorte) AND 
            NOT ( Vendedor IS NULL
                  OR CLIVEN.Razonsocial = ''
                  OR Corredor IS NULL
                  OR Entregador IS NULL
                  OR CDP.IdArticulo IS NULL
                )
            AND ISNULL(NetoFinal, 0) > 0
            AND ISNULL(CDP.Anulada, 'NO') <> 'SI'
            AND ( ISNULL(FechaDescarga, '1/1/1753') BETWEEN @FechaDesde
                                                    AND     @FechaHasta )

--solo incluir las descargas (tambien las descargas facturadas
    ORDER BY IdCartaDePorte DESC





GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wCartasDePorte_E @IdCartaDePorte INT
AS 
    DELETE  CartasDePorte
    WHERE   ( IdCartaDePorte = @IdCartaDePorte )

GO
/****** Object:  StoredProcedure [dbo].[wCartasDePorte_TX_PorNumero]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].wCartasDePorte_TX_PorNumero
    @Numero BIGINT,
    @SubNumeroVagon INT = NULL
	--,@NumeroSubFijo  INT = NULL
AS 
    SELECT  *
    FROM    CartasDePorte
    WHERE   NumeroCartaDePorte = @Numero --AND SubNumero=@SubNumero
            AND SubNumeroVagon = ISNULL(@SubnumeroVagon, SubNumeroVagon)
            --AND NumeroSubFijo = ISNULL(@NumeroSubFijo, NumeroSubFijo)
			--AND isnull(Anulada,'NO')<>'SI'
	order by subnumerodefacturacion desc

GO
/****** Object:  StoredProcedure [dbo].[wMailsFiltros_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wMailsFiltros_TTpaginadoYfiltrado
(

	@ColumnaParaFiltrar  nvarchar(50)=null,
	@TextoParaFiltrar    nvarchar(50)=null,
	@PuntoVenta			 integer=null,

	@sortExpression      nvarchar(50),
	
    @startRowIndex int,
    @maximumRows int
)
AS

                --<asp:ListItem Text="Titular" Value="VendedorDesc" />
                --<asp:ListItem Text="Emails" Value="Emails" />
                --<asp:ListItem Text="Intermediario" Value="CuentaOrden1Desc" />
                --<asp:ListItem Text="R.Comercial" Value="CuentaOrden2Desc" />
                --<asp:ListItem Text="Corredor" Value="CorredorDesc" />
                --<asp:ListItem Text="Destinatario" Value="EntregadorDesc" />
                --<asp:ListItem Text="Producto" Value="Producto" />
                --<asp:ListItem Text="Origen" Value="ProcedenciaDesc" />
                --<asp:ListItem Text="Destino" Value="DestinoDesc" />


-- http://www.4guysfromrolla.com/webtech/042606-1.shtml acá explican cómo paginar 
-- http://www.4guysfromrolla.com/articles/040407-1.aspx y acá explican cómo paginar Y filtrar. Naturalmente, necesitas los (fastidiosos) parametros de filtrado
-- http://stackoverflow.com/questions/149380/dynamic-sorting-within-sql-stored-procedures acá se discute sobre NO usar SQL dinamico 


DECLARE @first_id int, @startRow int
	

-- A check can be added to make sure @startRowIndex isn't > count(1)
-- from employees before doing any actual work unless it is guaranteed
-- the caller won't do that

-- Get the first employeeID for our page of records
SET ROWCOUNT @startRowIndex



SELECT @first_id = IdWilliamsMailFiltro 
FROM WilliamsMailFiltros 
WHERE 
--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'
	isnull(PuntoVenta,0)=isnull(@PuntoVenta,0)  
	
	AND

	CASE @ColumnaParaFiltrar
		WHEN 'Emails' THEN Emails 
		ELSE '%'+@TextoParaFiltrar+'%'
	END
		LIKE '%'+@TextoParaFiltrar+'%'


ORDER BY IdWilliamsMailFiltro DESC



-- Now, set the row count to MaximumRows and get
-- all records >= @first_id
SET ROWCOUNT @maximumRows


--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------



SELECT MAILS.*, 
    CLIVEN.Razonsocial as VendedorDesc,
    CLICO1.Razonsocial as CuentaOrden1Desc,
    CLICO2.Razonsocial as CuentaOrden2Desc,
    CLICOR.Nombre as CorredorDesc,
    CLIENT.Razonsocial as EntregadorDesc, 
    Articulos.Descripcion as Producto, 
    LOCORI.Nombre as ProcedenciaDesc, 
    LOCDES.Descripcion as DestinoDesc 
    FROM WilliamsMailFiltros MAILS
    LEFT OUTER JOIN Clientes CLIVEN ON MAILS.Vendedor = CLIVEN.IdCliente
    LEFT OUTER JOIN Clientes CLICO1 ON MAILS.CuentaOrden1 = CLICO1.IdCliente 
    LEFT OUTER JOIN Clientes CLICO2 ON MAILS.CuentaOrden2 = CLICO2.IdCliente 
    LEFT OUTER JOIN Vendedores CLICOR ON MAILS.Corredor = CLICOR.IdVendedor 
    LEFT OUTER JOIN Clientes CLIENT ON MAILS.Entregador = CLIENT.IdCliente
    LEFT OUTER JOIN Articulos ON MAILS.IdArticulo = Articulos.IdArticulo 
    LEFT OUTER JOIN Localidades LOCORI ON MAILS.Procedencia = LOCORI.IdLocalidad 
	LEFT OUTER JOIN WilliamsDestinos LOCDES ON MAILS.Destino = LOCDES.IdWilliamsDestino	

WHERE 


--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'  AND
	isnull(PuntoVenta,0)=isnull(@PuntoVenta,0)  
	
	AND

	CASE @ColumnaParaFiltrar
		WHEN 'Emails' THEN Emails 
		ELSE '%'+@TextoParaFiltrar+'%'
	END
		LIKE '%'+@TextoParaFiltrar+'%'
	
 	AND 
	
	IdWilliamsMailFiltro <= @first_id
ORDER BY IdWilliamsMailFiltro DESC



--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------

SET ROWCOUNT 0





 


--IF @DepartmentID IS NULL
--   -- If @DepartmentID is null, then we want to get all employees
--   EXEC dbo.GetEmployeesSubsetSorted @sortExpression, @startRowIndex, @maximumRows
--ELSE
-- BEGIN
--   -- Otherwise we want to get just those employees in the specified department
--   IF LEN(@sortExpression) = 0
--      SET @sortExpression = 'EmployeeID'

--   -- Since @startRowIndex is zero-based in the data Web control, but one-based w/ROW_NUMBER(), increment
--   SET @startRowIndex = @startRowIndex + 1


--   --dios mio, como puede ser que sean necesarias estas sentencias dinamicas....

--   -- Issue query
--   DECLARE @sql nvarchar(4000)
--   SET @sql = 'SELECT EmployeeID, LastName, FirstName, DepartmentID, Salary, 
--            HireDate, DepartmentName
--   FROM
--      (SELECT EmployeeID, LastName, FirstName, e.DepartmentID, Salary, 
--            HireDate, d.Name as DepartmentName,
--            ROW_NUMBER() OVER(ORDER BY ' + @sortExpression + ') as RowNum
--       FROM Employees e
--         INNER JOIN Departments d ON
--            e.DepartmentID = d.DepartmentID
--       WHERE e.DepartmentID = ' + CONVERT(nvarchar(10), @DepartmentID) + '
--      ) as EmpInfo
--   WHERE RowNum BETWEEN ' + CONVERT(nvarchar(10), @startRowIndex) + 
--               ' AND (' + CONVERT(nvarchar(10), @startRowIndex) + ' + ' 
--               + CONVERT(nvarchar(10), @maximumRows) + ') - 1'
      
--   -- Execute the SQL query
--   EXEC sp_executesql @sql
-- END







GO
/****** Object:  StoredProcedure [dbo].[wMailsFiltros_TTpaginadoTotalCount]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wMailsFiltros_TTpaginadoTotalCount
AS
SELECT COUNT(*) FROM dbo.Requerimientos

GO
/****** Object:  StoredProcedure [dbo].[wClientes_TTpaginadoYfiltrado]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE  PROCEDURE [dbo].wClientes_TTpaginadoYfiltrado
(

	@ColumnaParaFiltrar  nvarchar(50)=null,
	@TextoParaFiltrar    nvarchar(50)=null,
	
	@sortExpression      nvarchar(50),
	
    @startRowIndex int,
    @maximumRows int
)
AS

--<asp:ListItem Text="Numero" Value="NumeroCartaDePorte" />
 --                       <asp:ListItem Text="Arribo" Value="FechaArribo" />
 --                       <asp:ListItem Text="Titular" Value="VendedorDesc" />
 --                       <asp:ListItem Text="Intermediario" Value="CuentaOrden1Desc" />
 --                       <asp:ListItem Text="R.Comercial" Value="CuentaOrden2Desc" />
 --                       <asp:ListItem Text="Corredor" Value="CorredorDesc" />
 --                       <asp:ListItem Text="Destinatario" Value="EntregadorDesc" />
 --                       <asp:ListItem Text="Producto" Value="Producto" />
 --                       <asp:ListItem Text="Origen" Value="ProcedenciaDesc" />
 --                       <asp:ListItem Text="Destino" Value="DestinoDesc" />
 --                       <asp:ListItem Text="Descarga" Value="FechaDescarga" />
 --                       <asp:ListItem Text="Neto" Value="NetoFinal" />
 --                       <asp:ListItem Text="Exporta" Value="Exporta" />


-- http://www.4guysfromrolla.com/webtech/042606-1.shtml acá explican cómo paginar 
-- http://www.4guysfromrolla.com/articles/040407-1.aspx y acá explican cómo paginar Y filtrar. Naturalmente, necesitas los (fastidiosos) parametros de filtrado
-- http://stackoverflow.com/questions/149380/dynamic-sorting-within-sql-stored-procedures acá se discute sobre NO usar SQL dinamico 


DECLARE @first_id int, @startRow int
	
set @ColumnaParaFiltrar='NumeroCartaDePorte' 
set @TextoParaFiltrar='' 

-- A check can be added to make sure @startRowIndex isn't > count(1)
-- from employees before doing any actual work unless it is guaranteed
-- the caller won't do that

-- Get the first employeeID for our page of records
SET ROWCOUNT @startRowIndex



SELECT @first_id = IdCartaDePorte 
FROM VistaCartasPorte 
WHERE 
--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'

	CASE @ColumnaParaFiltrar
		WHEN 'NumeroCartaDePorte' THEN NumeroCartaDePorte
		WHEN 'VendedorDesc' THEN VendedorDesc 
	END
		LIKE '%'+@TextoParaFiltrar+'%'

ORDER BY IdCartaDePorte DESC



-- Now, set the row count to MaximumRows and get
-- all records >= @first_id
SET ROWCOUNT @maximumRows


--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------



SELECT * 
FROM VistaCartasPorte 
WHERE 


--NumeroCartaDePorte LIKE '*'+@TextoParaFiltrar+'*'  AND

	CASE @ColumnaParaFiltrar
		WHEN 'NumeroCartaDePorte' THEN NumeroCartaDePorte
		WHEN 'VendedorDesc' THEN VendedorDesc 
		ELSE NULL
	END
		LIKE '%'+@TextoParaFiltrar+'%'
	
 	AND 
	
	IdCartaDePorte <= @first_id
ORDER BY IdCartaDePorte DESC



--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------
--------------------------------------------------------------------------

SET ROWCOUNT 0





 


--IF @DepartmentID IS NULL
--   -- If @DepartmentID is null, then we want to get all employees
--   EXEC dbo.GetEmployeesSubsetSorted @sortExpression, @startRowIndex, @maximumRows
--ELSE
-- BEGIN
--   -- Otherwise we want to get just those employees in the specified department
--   IF LEN(@sortExpression) = 0
--      SET @sortExpression = 'EmployeeID'

--   -- Since @startRowIndex is zero-based in the data Web control, but one-based w/ROW_NUMBER(), increment
--   SET @startRowIndex = @startRowIndex + 1


--   --dios mio, como puede ser que sean necesarias estas sentencias dinamicas....

--   -- Issue query
--   DECLARE @sql nvarchar(4000)
--   SET @sql = 'SELECT EmployeeID, LastName, FirstName, DepartmentID, Salary, 
--            HireDate, DepartmentName
--   FROM
--      (SELECT EmployeeID, LastName, FirstName, e.DepartmentID, Salary, 
--            HireDate, d.Name as DepartmentName,
--            ROW_NUMBER() OVER(ORDER BY ' + @sortExpression + ') as RowNum
--       FROM Employees e
--         INNER JOIN Departments d ON
--            e.DepartmentID = d.DepartmentID
--       WHERE e.DepartmentID = ' + CONVERT(nvarchar(10), @DepartmentID) + '
--      ) as EmpInfo
--   WHERE RowNum BETWEEN ' + CONVERT(nvarchar(10), @startRowIndex) + 
--               ' AND (' + CONVERT(nvarchar(10), @startRowIndex) + ' + ' 
--               + CONVERT(nvarchar(10), @maximumRows) + ') - 1'
      
--   -- Execute the SQL query
--   EXEC sp_executesql @sql
-- END







GO
/****** Object:  StoredProcedure [dbo].[wClientes_TTprimerapagina]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wClientes_TTprimerapagina
AS 
    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50)
    SET @vector_X = '01111111111111111111111111111133'
    SET @vector_T = '05120211555514521162222514142200'

    SELECT  TOP 210
			Clientes.IdCliente as Id,
            Clientes.RazonSocial AS [Razon social],
            Clientes.Codigo AS [Codigo],
            Clientes.Direccion,
            L1.Nombre AS [Localidad],
            Clientes.CodigoPostal,
            P1.Nombre AS [Provincia],
            Paises.Descripcion AS [Pais],
            Clientes.Telefono,
            Clientes.Fax,
            Clientes.Email,
            Clientes.Cuit,
            DescripcionIva.Descripcion AS [Condicion IVA],
            Clientes.FechaAlta AS [Fecha alta],
            Clientes.Contacto,
            Clientes.DireccionEntrega AS [Direccion de entrega],
            L2.Nombre AS [Localidad (entrega)],
            P2.Nombre AS [Provincia (entrega)],
            Clientes.CodigoPresto AS [Codigo PRESTO],
            V1.Nombre AS [Vendedor],
            V2.Nombre AS [Cobrador],
            [Estados Proveedores].Descripcion AS [Estado],
            Clientes.NombreFantasia AS [Nombre comercial],
            Clientes.Observaciones,
            E1.Nombre AS [Ingreso],
            Clientes.FechaIngreso AS [Fecha ing.],
            E2.Nombre AS [Modifico],
            Clientes.FechaModifico AS [Fecha modif.],
            C1.Descripcion AS [Cuenta contable],
            C2.Descripcion AS [Cuenta contable (ext.)],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    Clientes
            LEFT OUTER JOIN DescripcionIva ON Clientes.IdCodigoIva = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Localidades L1 ON Clientes.IdLocalidad = L1.IdLocalidad
            LEFT OUTER JOIN Localidades L2 ON Clientes.IdLocalidadEntrega = L2.IdLocalidad
            LEFT OUTER JOIN Provincias P1 ON Clientes.IdProvincia = P1.IdProvincia
            LEFT OUTER JOIN Provincias P2 ON Clientes.IdProvincia = P2.IdProvincia
            LEFT OUTER JOIN Vendedores V1 ON Clientes.Vendedor1 = V1.IdVendedor
            LEFT OUTER JOIN Vendedores V2 ON Clientes.Cobrador = V2.IdVendedor
            LEFT OUTER JOIN Paises ON Clientes.IdPais = Paises.IdPais
            LEFT OUTER JOIN Empleados E1 ON Clientes.IdUsuarioIngreso = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Clientes.IdUsuarioModifico = E2.IdEmpleado
            LEFT OUTER JOIN [Estados Proveedores] ON Clientes.IdEstado = [Estados Proveedores].IdEstado
            LEFT OUTER JOIN Cuentas C1 ON Clientes.IdCuenta = C1.IdCuenta
            LEFT OUTER JOIN Cuentas C2 ON Clientes.IdCuentaMonedaExt = C2.IdCuenta
--WHERE IsNull(Clientes.Confirmado,'SI')='SI'
    ORDER BY IdCliente DESC -- Clientes.RazonSocial


GO
/****** Object:  StoredProcedure [dbo].[wProvincias_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wProvincias_A]

@IdProvincia int  output,
@Nombre varchar(50),
@Codigo varchar(2),
@IdPais int

AS

IF IsNull(@IdProvincia,0)<=0
    BEGIN
	INSERT INTO Provincias
	(
	 Nombre,
	 Codigo,
	 IdPais
	)
	VALUES
	(
	 @Nombre,
	 @Codigo,
	 @IdPais
	)
	SELECT @IdProvincia=@@identity
    END
ELSE
    BEGIN
	UPDATE Provincias
	SET 
	 Nombre=@Nombre,
	 Codigo=@Codigo,
	 IdPais=@IdPais
	WHERE (IdProvincia=@IdProvincia)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdProvincia



GO
/****** Object:  StoredProcedure [dbo].[wClientes_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[wClientes_TT]
AS 
    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50)
    SET @vector_X = '01111111111111111111111111111133'
    SET @vector_T = '05120211555514521162222514142200'

    SELECT  Clientes.IdCliente,
            Clientes.RazonSocial AS [Razon social],
            Clientes.Codigo AS [Codigo],
            Clientes.Direccion,
            L1.Nombre AS [Localidad],
            Clientes.CodigoPostal,
            P1.Nombre AS [Provincia],
            Paises.Descripcion AS [Pais],
            Clientes.Telefono,
            Clientes.Fax,
            Clientes.Email,
            Clientes.Cuit,
            DescripcionIva.Descripcion AS [Condicion IVA],
            Clientes.FechaAlta AS [Fecha alta],
            Clientes.Contacto,
            Clientes.DireccionEntrega AS [Direccion de entrega],
            L2.Nombre AS [Localidad (entrega)],
            P2.Nombre AS [Provincia (entrega)],
            Clientes.CodigoPresto AS [Codigo PRESTO],
            V1.Nombre AS [Vendedor],
            V2.Nombre AS [Cobrador],
            [Estados Proveedores].Descripcion AS [Estado],
            Clientes.NombreFantasia AS [Nombre comercial],
            Clientes.Observaciones,
            E1.Nombre AS [Ingreso],
            Clientes.FechaIngreso AS [Fecha ing.],
            E2.Nombre AS [Modifico],
            Clientes.FechaModifico AS [Fecha modif.],
            C1.Descripcion AS [Cuenta contable],
            C2.Descripcion AS [Cuenta contable (ext.)],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    Clientes
            LEFT OUTER JOIN DescripcionIva ON Clientes.IdCodigoIva = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Localidades L1 ON Clientes.IdLocalidad = L1.IdLocalidad
            LEFT OUTER JOIN Localidades L2 ON Clientes.IdLocalidadEntrega = L2.IdLocalidad
            LEFT OUTER JOIN Provincias P1 ON Clientes.IdProvincia = P1.IdProvincia
            LEFT OUTER JOIN Provincias P2 ON Clientes.IdProvincia = P2.IdProvincia
            LEFT OUTER JOIN Vendedores V1 ON Clientes.Vendedor1 = V1.IdVendedor
            LEFT OUTER JOIN Vendedores V2 ON Clientes.Cobrador = V2.IdVendedor
            LEFT OUTER JOIN Paises ON Clientes.IdPais = Paises.IdPais
            LEFT OUTER JOIN Empleados E1 ON Clientes.IdUsuarioIngreso = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Clientes.IdUsuarioModifico = E2.IdEmpleado
            LEFT OUTER JOIN [Estados Proveedores] ON Clientes.IdEstado = [Estados Proveedores].IdEstado
            LEFT OUTER JOIN Cuentas C1 ON Clientes.IdCuenta = C1.IdCuenta
            LEFT OUTER JOIN Cuentas C2 ON Clientes.IdCuentaMonedaExt = C2.IdCuenta
--WHERE IsNull(Clientes.Confirmado,'SI')='SI'
ORDER BY IdCliente DESC 
    --ORDER BY Clientes.RazonSocial


GO
/****** Object:  StoredProcedure [dbo].[wProvincias_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wProvincias_E]

@IdProvincia int  

AS 

DELETE Provincias
WHERE (IdProvincia=@IdProvincia)



GO
/****** Object:  StoredProcedure [dbo].[wClientes_TX_Busqueda]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[wClientes_TX_Busqueda] @Busqueda VARCHAR(100)
AS 
    
    
    SELECT TOP 100
            IdCliente,
            RazonSocial,
            Cuit
    FROM    Clientes
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
--IsNull(Confirmado,'NO')<>'NO' and
            RazonSocial LIKE @Busqueda + '%'

			
--RazonSocial like '%'+@Busqueda+'%'  --busca en el medio. tarda mas en buscar, y mas aun en transmitirse
    
    
      ORDER BY RazonSocial

    

GO
/****** Object:  StoredProcedure [dbo].[wProvincias_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wProvincias_T]

@IdProvincia int = Null

AS 

SET @IdProvincia=IsNull(@IdProvincia,-1)

IF @IdProvincia=-2
	SELECT 
	 Provincias.IdProvincia as [IdProvincia],
	 Provincias.Nombre as [Provincia],
	 Paises.Descripcion as [Pais]
	FROM Provincias
	LEFT OUTER JOIN Paises ON Provincias.IdPais=Paises.IdPais
	ORDER BY Provincias.Nombre
ELSE
	SELECT 
	 Provincias.*,
	 Paises.Descripcion as [Pais]
	FROM Provincias
	LEFT OUTER JOIN Paises ON Provincias.IdPais=Paises.IdPais
	WHERE @IdProvincia=-1 or Provincias.IdProvincia=@IdProvincia
	ORDER BY Provincias.Nombre



GO
/****** Object:  StoredProcedure [dbo].[wClientes_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wClientes_TX_BusquedaConCUIT @Busqueda VARCHAR(100)
AS 
    
    
    SELECT TOP 100
            IdCliente,
            isnull(RazonSocial,'') + ' ' + isnull(Cuit,'') COLLATE Modern_Spanish_ci_as as RazonSocial,
            Cuit
    FROM    Clientes
    WHERE   			
			-- http://stackoverflow.com/questions/156954/search-for-words-in-sql-server-index
			RazonSocial like '%[^A-z^0-9]' + @Busqueda + '%' -- In the middle of a sentence
			OR RazonSocial like  @Busqueda + '%'            -- At the beginning of a sentence


--RazonSocial like '%'+@Busqueda+'%'  --busca en el medio. tarda mas en buscar, y mas aun en transmitirse
    
    
    union

    SELECT TOP 100
            IdCliente,
            isnull(Cuit,'') + ' ' + isnull(RazonSocial,'') COLLATE Modern_Spanish_ci_as  as RazonSocial,
            Cuit
    FROM    Clientes
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            (Cuit LIKE @Busqueda + '%')
            OR
            REPLACE(Cuit,'-','') LIKE @Busqueda + '%'



    ORDER BY RazonSocial

    

GO
/****** Object:  StoredProcedure [dbo].[wProvincias_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wProvincias_TL]
AS 
SELECT IdProvincia, Nombre as [Titulo]
FROM Provincias 
ORDER BY Nombre



GO
/****** Object:  StoredProcedure [dbo].[wVendedores_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wVendedores_TX_BusquedaConCUIT @Busqueda VARCHAR(100)
AS 
    
    
    SELECT TOP 100
            IdVendedor,
            Nombre,
            Cuit
    FROM    Vendedores
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
--IsNull(Confirmado,'NO')<>'NO' and
            Nombre LIKE @Busqueda + '%'
--RazonSocial like '%'+@Busqueda+'%'  --busca en el medio. tarda mas en buscar, y mas aun en transmitirse
    
    
    union

    SELECT TOP 100
            IdVendedor,
            Cuit COLLATE SQL_Latin1_General_CP1_CI_AS + ' ' + nombre COLLATE SQL_Latin1_General_CP1_CI_AS,
            Cuit
    FROM    Vendedores
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            (Cuit LIKE @Busqueda + '%')
            OR
            REPLACE(Cuit,'-','') LIKE @Busqueda + '%'



    ORDER BY Nombre

    

GO
/****** Object:  StoredProcedure [dbo].[wRecibos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE Procedure [dbo].[wRecibos_TX_PorIdConDatos]

@IdRecibo int

AS 

SELECT 
 Recibos.*, 
 Case When Recibos.Tipo='CC' Then 'Cta. cte.' 
	When Recibos.Tipo='OT' Then 'Otros' 
	Else ''
 End as [TipoRecibo],
 Clientes.CodigoCliente as [CodigoCliente], 
 Clientes.RazonSocial as [Cliente],
 Monedas.Abreviatura as [Moneda],
 IsNull(Recibos.Otros1,0)+IsNull(Recibos.Otros2,0)+IsNull(Recibos.Otros3,0)+IsNull(Recibos.Otros4,0)+IsNull(Recibos.Otros5,0)+ 
	IsNull(Recibos.Otros6,0)+IsNull(Recibos.Otros7,0)+IsNull(Recibos.Otros8,0)+IsNull(Recibos.Otros9,0)+IsNull(Recibos.Otros10,0) as [OtrosConceptos],
 Cuentas.Descripcion as [Cuenta],
 IsNull(Obras.NumeroObra,'') as [NumeroObra],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra]
FROM Recibos
LEFT OUTER JOIN Clientes ON Recibos.IdCliente = Clientes.IdCliente 
LEFT OUTER JOIN Cuentas ON Recibos.IdCuenta = Cuentas.IdCuenta
LEFT OUTER JOIN Monedas ON Recibos.IdMoneda = Monedas.IdMoneda
LEFT OUTER JOIN Obras ON Obras.IdObra = Recibos.IdObra
WHERE (Recibos.IdRecibo=@IdRecibo)


GO
/****** Object:  StoredProcedure [dbo].[wTransportistas_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wTransportistas_TX_BusquedaConCUIT @Busqueda VARCHAR(100)
AS 
    
    
    SELECT TOP 100
            IdTransportista,
            RazonSocial,
            Cuit
    FROM    Transportistas
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
--IsNull(Confirmado,'NO')<>'NO' and
            RazonSocial LIKE @Busqueda + '%'
--RazonSocial like '%'+@Busqueda+'%'  --busca en el medio. tarda mas en buscar, y mas aun en transmitirse
    
    
    union

    SELECT TOP 100
            IdTransportista,
            Cuit + ' ' + RazonSocial,
            Cuit
    FROM    Transportistas
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            (Cuit LIKE @Busqueda + '%')
            OR
            REPLACE(Cuit,'-','') LIKE @Busqueda + '%'



    ORDER BY RazonSocial

    

GO
/****** Object:  StoredProcedure [dbo].[wChoferes_TX_BusquedaConCUIT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wChoferes_TX_BusquedaConCUIT @Busqueda VARCHAR(100)
AS 
    
    
    SELECT TOP 100
            IdChofer,
              Nombre,
            Cuil
    FROM    Choferes
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
--IsNull(Confirmado,'NO')<>'NO' and
            nombre LIKE @Busqueda + '%'
--RazonSocial like '%'+@Busqueda+'%'  --busca en el medio. tarda mas en buscar, y mas aun en transmitirse
    
    
    union

    SELECT TOP 100
            IdChofer,
            CUIL + ' ' + nombre,
            Cuil
    FROM    Choferes
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            (Cuil LIKE @Busqueda + '%')
            OR
            REPLACE(Cuil,'-','') LIKE @Busqueda + '%'



    ORDER BY nombre

    

GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wRequerimientos_E]

@IdRequerimiento int  

AS 

DELETE Requerimientos
WHERE (IdRequerimiento=@IdRequerimiento)



GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TX_Busqueda]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[wLocalidades_TX_Busqueda] @Busqueda VARCHAR(100)
AS 
    SELECT TOP 200
            IdLocalidad,
            Nombre,
            CodigoPostal
    FROM    Localidades
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            Nombre LIKE '%' + @Busqueda + '%'
    ORDER BY Nombre


GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TXFecha]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


 CREATE PROCEDURE [dbo].[wFacturas_TXFecha]  
  
@Desde datetime,  
@Hasta datetime,  
@IdAbonos varchar(100)  
  
AS  
  
DECLARE @vector_X varchar(50),@vector_T varchar(50)  
SET @vector_X='0111111111111111111111111111111111133'  
SET @vector_T='00912114055BB544444425126703433533400'   
  
SELECT   
 Facturas.IdFactura,   
 Facturas.TipoABC as [A/B/E],  
 Facturas.IdFactura as [IdAux],   
 Facturas.PuntoVenta as [Pto.vta.],   
 Facturas.NumeroFactura as [Factura],   
 Facturas.Anulada as [Anulada],  
 Clientes.CodigoCliente as [Cod.Cli.],   
 Clientes.RazonSocial as [Cliente],   
 DescripcionIva.Descripcion as [Condicion IVA],   
 Clientes.Cuit as [Cuit],   
 Facturas.FechaFactura as [Fecha Factura],   
 dbo.Facturas_OrdenesCompra(Facturas.IdFactura) as [Ordenes de compra],  
 dbo.Facturas_Remitos(Facturas.IdFactura) as [Remitos],  
 Facturas.ImporteTotal-Facturas.ImporteIva1-Facturas.ImporteIva2-Facturas.RetencionIBrutos1-Facturas.RetencionIBrutos2-Facturas.RetencionIBrutos3+  
 IsNull(Facturas.ImporteBonificacion,0)-IsNull(Facturas.IvaNoDiscriminado,0)-IsNull(Facturas.PercepcionIVA,0) as [Subtotal],  
 Facturas.ImporteBonificacion as [Bonificacion],  
 Facturas.ImporteIva1+IsNull(Facturas.IvaNoDiscriminado,0) as [Iva],  
 Facturas.AjusteIva as [Ajuste IVA],  
 Facturas.RetencionIBrutos1+Facturas.RetencionIBrutos2+Facturas.RetencionIBrutos3 as [IIBB],  
 Facturas.PercepcionIVA as [Perc.IVA],  
 Facturas.ImporteTotal as [Total factura],  
 Monedas.Abreviatura as [Mon.],  
 Clientes.Telefono as [Telefono del cliente],   
 Vendedores.Nombre as [Vendedor],  
 Empleados.Nombre  as [Ingreso],  
 Facturas.FechaIngreso as [Fecha ingreso],  
 Obras.NumeroObra as [Obra (x defecto)],  
 Provincias.Nombre as [Provincia destino],  
 (Select Count(*) From DetalleFacturas df Where df.IdFactura=Facturas.IdFactura) as [Cant.Items],  
 (Select Count(*) From DetalleFacturas df Where df.IdFactura=Facturas.IdFactura and Patindex('%'+Convert(varchar,df.IdArticulo)+'%', @IdAbonos)<>0) as [Cant.Abonos],  
 'Grupo '+Convert(varchar,  
 (Select Top 1 oc.Agrupacion2Facturacion   
 From DetalleFacturasOrdenesCompra dfoc   
 Left Outer Join DetalleOrdenesCompra doc On doc.IdDetalleOrdenCompra=dfoc.IdDetalleOrdenCompra  
 Left Outer Join OrdenesCompra oc On oc.IdOrdenCompra=doc.IdOrdenCompra  
 Where dfoc.IdFactura=Facturas.IdFactura)) as [Grupo facturacion automatica],  
 Facturas.ActivarRecuperoGastos as [Act.Rec.Gtos.],  
 Case When IsNull(ContabilizarAFechaVencimiento,'NO')='NO' Then Facturas.FechaFactura Else Facturas.FechaVencimiento End as [Fecha Contab.],  
 Facturas.CAE as [CAE],  
 Facturas.RechazoCAE as [Rech.CAE],  
 Facturas.FechaVencimientoORechazoCAE as [Fecha vto.CAE],  
 @Vector_T as Vector_T,  
 @Vector_X as Vector_X  
FROM Facturas   
LEFT OUTER JOIN Clientes ON Facturas.IdCliente = Clientes.IdCliente  
LEFT OUTER JOIN DescripcionIva ON IsNull(Facturas.IdCodigoIva,Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva   
--LEFT OUTER JOIN Vendedores ON Clientes.Vendedor1 = Vendedores.IdVendedor  
LEFT OUTER JOIN Vendedores ON Facturas.IdVendedor = Vendedores.IdVendedor  
LEFT OUTER JOIN Monedas ON Facturas.IdMoneda = Monedas.IdMoneda  
LEFT OUTER JOIN Obras ON Facturas.IdObra = Obras.IdObra  
LEFT OUTER JOIN Provincias ON Facturas.IdProvinciaDestino = Provincias.IdProvincia  
LEFT OUTER JOIN Empleados ON Facturas.IdUsuarioIngreso = Empleados.IdEmpleado  
WHERE Facturas.FechaFactura between @Desde and @hasta and IsNull(FacturaContado,'NO')='NO'  
ORDER BY Facturas.FechaFactura,Facturas.NumeroFactura  

GO
/****** Object:  StoredProcedure [dbo].[wFacturas_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wFacturas_TT
AS 
    SET NOCOUNT ON


    DECLARE @IdAbonos VARCHAR(100)
    SET @IdAbonos = ''

/*
--Para qué es todo esto? 


CREATE TABLE #Auxiliar1 
			(
			 IdFactura INTEGER,
			 OCompras VARCHAR(500)
			)

CREATE TABLE #Auxiliar2 
			(
			 IdFactura INTEGER,
			 OCompra VARCHAR(8)
			)
INSERT INTO #Auxiliar2 
 SELECT Det.IdFactura, Substring('00000000',1,8-Len(Convert(varchar,OrdenesCompra.NumeroOrdenCompra)))+Convert(varchar,OrdenesCompra.NumeroOrdenCompra)
 FROM DetalleFacturas Det
 LEFT OUTER JOIN DetalleFacturasOrdenesCompra ON Det.IdDetalleFactura = DetalleFacturasOrdenesCompra.IdDetalleFactura
 LEFT OUTER JOIN Facturas ON Det.IdFactura = Facturas.IdFactura
 LEFT OUTER JOIN DetalleOrdenesCompra ON DetalleFacturasOrdenesCompra.IdDetalleOrdenCompra = DetalleOrdenesCompra.IdDetalleOrdenCompra
 LEFT OUTER JOIN OrdenesCompra ON DetalleOrdenesCompra.IdOrdenCompra = OrdenesCompra.IdOrdenCompra
 WHERE IsNull(FacturaContado,'NO')='NO'

CREATE NONCLUSTERED INDEX IX__Auxiliar2 ON #Auxiliar2 (IdFactura,OCompra) ON [PRIMARY]

INSERT INTO #Auxiliar1 
 SELECT IdFactura, ''
 FROM #Auxiliar2
 GROUP BY IdFactura

--  CURSOR  
DECLARE @IdFactura int, @OCompra varchar(8), @Corte int, @P varchar(500)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdFactura, OCompra
		FROM #Auxiliar2
		ORDER BY IdFactura
OPEN Cur
FETCH NEXT FROM Cur INTO @IdFactura, @OCompra
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdFactura
	   BEGIN
		IF @Corte<>0
			UPDATE #Auxiliar1
			SET OCompras = SUBSTRING(@P,1,500)
			WHERE IdFactura=@Corte
		SET @P=''
		SET @Corte=@IdFactura
	   END
	IF NOT @OCompra IS NULL
		IF PATINDEX('%'+@OCompra+' '+'%', @P)=0
			SET @P=@P+@OCompra+' '
	FETCH NEXT FROM Cur INTO @IdFactura, @OCompra
   END
   IF @Corte<>0
	UPDATE #Auxiliar1
	SET OCompras = SUBSTRING(@P,1,500)
	WHERE IdFactura=@Corte
CLOSE Cur
DEALLOCATE Cur

CREATE TABLE #Auxiliar3 
			(
			 IdFactura INTEGER,
			 Remitos VARCHAR(500)
			)

CREATE TABLE #Auxiliar4 
			(
			 IdFactura INTEGER,
			 Remito VARCHAR(13)
			)
INSERT INTO #Auxiliar4 
 SELECT Det.IdFactura, 
	Substring('0000',1,4-Len(Convert(varchar,IsNull(Remitos.PuntoVenta,0))))+
		Convert(varchar,IsNull(Remitos.PuntoVenta,0))+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,Remitos.NumeroRemito)))+
		Convert(varchar,Remitos.NumeroRemito)
 FROM DetalleFacturas Det
 LEFT OUTER JOIN DetalleFacturasRemitos ON Det.IdDetalleFactura = DetalleFacturasRemitos.IdDetalleFactura
 LEFT OUTER JOIN Facturas ON Det.IdFactura = Facturas.IdFactura
 LEFT OUTER JOIN DetalleRemitos ON DetalleFacturasRemitos.IdDetalleRemito = DetalleRemitos.IdDetalleRemito
 LEFT OUTER JOIN Remitos ON DetalleRemitos.IdRemito = Remitos.IdRemito
 WHERE IsNull(FacturaContado,'NO')='NO'

CREATE NONCLUSTERED INDEX IX__Auxiliar4 ON #Auxiliar4 (IdFactura,Remito) ON [PRIMARY]

INSERT INTO #Auxiliar3 
 SELECT IdFactura, ''
 FROM #Auxiliar4
 GROUP BY IdFactura

--  CURSOR  
DECLARE @Remito varchar(13)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdFactura, Remito
		FROM #Auxiliar4
		ORDER BY IdFactura
OPEN Cur
FETCH NEXT FROM Cur INTO @IdFactura, @Remito
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdFactura
	   BEGIN
		IF @Corte<>0
			UPDATE #Auxiliar3
			SET Remitos = SUBSTRING(@P,1,500)
			WHERE IdFactura=@Corte
		SET @P=''
		SET @Corte=@IdFactura
	   END
	IF NOT @Remito IS NULL
		IF PATINDEX('%'+@Remito+' '+'%', @P)=0
			SET @P=@P+@Remito+' '
	FETCH NEXT FROM Cur INTO @IdFactura, @Remito
   END
   IF @Corte<>0
	UPDATE #Auxiliar3
	SET Remitos = SUBSTRING(@P,1,500)
	WHERE IdFactura=@Corte
CLOSE Cur
DEALLOCATE Cur

SET NOCOUNT OFF
*/








    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50)
    SET @vector_X = '011111111111111111111111111111111133'
    SET @vector_T = '00912114055BB54444425126703433533400'

    SELECT  Facturas.IdFactura,
            Facturas.TipoABC AS [A/B/E],
            Facturas.IdFactura AS [IdAux],
            Facturas.PuntoVenta AS [Pto.vta.],
            Facturas.NumeroFactura AS [Factura],
            Facturas.Anulada AS [Anulada],
            Clientes.CodigoCliente AS [Cod.Cli.],
            Clientes.RazonSocial AS [Cliente],
            DescripcionIva.Descripcion AS [Condicion IVA],
            Clientes.Cuit AS [Cuit],
            Facturas.FechaFactura AS [Fecha Factura], 
 --#Auxiliar1.OCompras as [Ordenes de compra],
 --#Auxiliar3.Remitos as [Remitos],
            Facturas.ImporteTotal - Facturas.ImporteIva1
            - Facturas.ImporteIva2 - Facturas.RetencionIBrutos1
            - Facturas.RetencionIBrutos2 - Facturas.RetencionIBrutos3
            + ISNULL(Facturas.ImporteBonificacion, 0)
            - ISNULL(Facturas.IvaNoDiscriminado, 0)
            - ISNULL(Facturas.PercepcionIVA, 0) AS [Neto gravado],
            Facturas.ImporteBonificacion AS [Bonificacion],
            Facturas.ImporteIva1 + ISNULL(Facturas.IvaNoDiscriminado, 0) AS [Iva],
            Facturas.RetencionIBrutos1 + Facturas.RetencionIBrutos2
            + Facturas.RetencionIBrutos3 AS [IIBB],
            Facturas.PercepcionIVA AS [Perc.IVA],
            Facturas.ImporteTotal AS [Total factura],
            Monedas.Abreviatura AS [Mon.],
            Clientes.Telefono AS [Telefono del cliente],
            Vendedores.Nombre AS [Vendedor],
            Empleados.Nombre AS [Ingreso],
            Facturas.FechaIngreso AS [Fecha ingreso],
            Obras.NumeroObra AS [Obra (x defecto)],
            Provincias.Nombre AS [Provincia destino],
            ( SELECT    COUNT(*)
              FROM      DetalleFacturas df
              WHERE     df.IdFactura = Facturas.IdFactura
            ) AS [Cant.Items],
            ( SELECT    COUNT(*)
              FROM      DetalleFacturas df
              WHERE     df.IdFactura = Facturas.IdFactura
                        AND PATINDEX('%' + CONVERT(VARCHAR, df.IdArticulo)
                                     + '%', @IdAbonos) <> 0
            ) AS [Cant.Abonos],
 --'Grupo '+Convert(varchar,
 --(Select Top 1 oc.Agrupacion2Facturacion 
	--From DetalleFacturasOrdenesCompra dfoc 
	--Left Outer Join DetalleOrdenesCompra doc On doc.IdDetalleOrdenCompra=dfoc.IdDetalleOrdenCompra
	--Left Outer Join OrdenesCompra oc On oc.IdOrdenCompra=doc.IdOrdenCompra
	--Where dfoc.IdFactura=Facturas.IdFactura)) as [Grupo facturacion automatica],
 --Facturas.ActivarRecuperoGastos as [Act.Rec.Gtos.],
 --Case When IsNull(ContabilizarAFechaVencimiento,'NO')='NO' 
	--Then Facturas.FechaFactura
	--Else Facturas.FechaVencimiento
 --End as [Fecha Contab.],
            Facturas.CAE AS [CAE],
            Facturas.RechazoCAE AS [Rech.CAE],
            Facturas.FechaVencimientoORechazoCAE AS [Fecha vto.CAE]
 --@Vector_T as Vector_T,
 --@Vector_X as Vector_X
    FROM    Facturas
            LEFT OUTER JOIN Clientes ON Facturas.IdCliente = Clientes.IdCliente
            LEFT OUTER JOIN DescripcionIva ON ISNULL(Facturas.IdCodigoIva,
                                                     Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Vendedores ON Clientes.Vendedor1 = Vendedores.IdVendedor
            LEFT OUTER JOIN Monedas ON Facturas.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN Obras ON Facturas.IdObra = Obras.IdObra
            LEFT OUTER JOIN Provincias ON Facturas.IdProvinciaDestino = Provincias.IdProvincia
            LEFT OUTER JOIN Empleados ON Facturas.IdUsuarioIngreso = Empleados.IdEmpleado
--LEFT OUTER JOIN #Auxiliar1 ON Facturas.IdFactura=#Auxiliar1.IdFactura
--LEFT OUTER JOIN #Auxiliar3 ON Facturas.IdFactura=#Auxiliar3.IdFactura
    WHERE   ISNULL(FacturaContado, 'NO') = 'NO'
    ORDER BY Facturas.FechaFactura,
            Facturas.NumeroFactura

/*
DROP TABLE #Auxiliar1
DROP TABLE #Auxiliar2
DROP TABLE #Auxiliar3
DROP TABLE #Auxiliar4
*/


GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  Procedure [dbo].[wRequerimientos_TX_PorIdConDatos]

@IdRequerimiento int

AS 

SELECT 
 Requerimientos.*,
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 dbo.Requerimientos_Presupuestos(Requerimientos.IdRequerimiento)as [Presupuestos],
 dbo.Requerimientos_Comparativas(Requerimientos.IdRequerimiento)as [Comparativas],
 dbo.Requerimientos_Pedidos(Requerimientos.IdRequerimiento)as [Pedidos],
 dbo.Requerimientos_Recepciones(Requerimientos.IdRequerimiento)as [Recepciones],
 dbo.Requerimientos_SalidasMateriales(Requerimientos.IdRequerimiento)as [Salidas], 
 E1.Nombre as [Libero],
 E2.Nombre as [Solicito],
 Sectores.Descripcion as [Sector],
 ArchivosATransmitirDestinos.Descripcion as [Origen],
 Articulos.NumeroInventario COLLATE SQL_Latin1_General_CP1_CI_AS+' '+Articulos.Descripcion as [EquipoDestino],
 TiposCompra.Descripcion as [TipoCompra],
 (Select Top 1 Empleados.Nombre From Empleados 
  Where Empleados.IdEmpleado=(Select Top 1 Det.IdComprador 
				From DetalleRequerimientos Det 
				Where Det.IdRequerimiento=Requerimientos.IdRequerimiento and Det.IdComprador  is not null)) as [Comprador],
 dbo.Requerimientos_FechasLiberacion(Requerimientos.IdRequerimiento) as [FechasLiberacionParaCompras],
 OrdenesTrabajo.NumeroOrdenTrabajo as [NumeroOrdenTrabajo]
FROM Requerimientos
LEFT OUTER JOIN Obras ON Requerimientos.IdObra=Obras.IdObra
LEFT OUTER JOIN CentrosCosto ON Requerimientos.IdCentroCosto=CentrosCosto.IdCentroCosto
LEFT OUTER JOIN Sectores ON Requerimientos.IdSector=Sectores.IdSector
LEFT OUTER JOIN Monedas ON Requerimientos.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN ArchivosATransmitirDestinos ON Requerimientos.IdOrigenTransmision = ArchivosATransmitirDestinos.IdArchivoATransmitirDestino
LEFT OUTER JOIN Articulos ON Requerimientos.IdEquipoDestino=Articulos.IdArticulo
LEFT OUTER JOIN TiposCompra ON Requerimientos.IdTipoCompra = TiposCompra.IdTipoCompra
LEFT OUTER JOIN Empleados E1 ON E1.IdEmpleado=Requerimientos.Aprobo
LEFT OUTER JOIN Empleados E2 ON E2.IdEmpleado=Requerimientos.IdSolicito
LEFT OUTER JOIN OrdenesTrabajo ON OrdenesTrabajo.IdOrdenTrabajo=Requerimientos.IdOrdenTrabajo
WHERE Requerimientos.IdRequerimiento=@IdRequerimiento

GO
/****** Object:  StoredProcedure [dbo].[wFacturas_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wFacturas_A
    @IdFactura INT OUTPUT,
    @NumeroFactura INT,
    @TipoABC VARCHAR(1),
    @PuntoVenta SMALLINT,
    @IdCliente INT,
    @FechaFactura DATETIME,
    @IdCondicionVenta SMALLINT,
    @IdVendedor TINYINT,
    @IdTransportista1 TINYINT,
    @IdTransportista2 TINYINT,
    @ItemDireccion TINYINT,
    @OrdenCompra VARCHAR(20),
    @TipoPedidoConsignacion VARCHAR(1),
    @Anulada VARCHAR(2),
    @FechaAnulacion DATETIME,
    @Observaciones NTEXT,
    @IdRemito INT,
    @NumeroRemito INT,
    @IdPedido INT,
    @NumeroPedido INT,
    @ImporteTotal NUMERIC(18, 2),
    @ImporteIva1 NUMERIC(18, 2),
    @ImporteIva2 NUMERIC(18, 2),
    @ImporteBonificacion NUMERIC(18, 2),
    @RetencionIBrutos1 NUMERIC(18, 2),
    @PorcentajeIBrutos1 NUMERIC(6, 2),
    @RetencionIBrutos2 NUMERIC(18, 2),
    @PorcentajeIBrutos2 NUMERIC(6, 2),
    @ConvenioMultilateral VARCHAR(2),
    @RetencionIBrutos3 NUMERIC(18, 2),
    @PorcentajeIBrutos3 NUMERIC(6, 2),
    @IdTipoVentaC SMALLINT,
    @ImporteIvaIncluido NUMERIC(18, 2),
    @CotizacionDolar NUMERIC(18, 3),
    @EsMuestra VARCHAR(2),
    @CotizacionADolarFijo NUMERIC(18, 3),
    @ImporteParteEnDolares NUMERIC(18, 2),
    @ImporteParteEnPesos NUMERIC(18, 2),
    @PorcentajeIva1 NUMERIC(6, 2),
    @PorcentajeIva2 NUMERIC(6, 2),
    @FechaVencimiento DATETIME,
    @IVANoDiscriminado NUMERIC(18, 2),
    @IdMoneda INT,
    @CotizacionMoneda NUMERIC(18, 4),
    @PorcentajeBonificacion NUMERIC(6, 2),
    @OtrasPercepciones1 NUMERIC(18, 2),
    @OtrasPercepciones1Desc VARCHAR(15),
    @OtrasPercepciones2 NUMERIC(18, 2),
    @OtrasPercepciones2Desc VARCHAR(15),
    @IdProvinciaDestino INT,
    @IdIBCondicion INT,
    @IdAutorizaAnulacion INT,
    @IdPuntoVenta INT,
    @NumeroCAI NUMERIC(19, 0),
    @FechaVencimientoCAI DATETIME,
    @NumeroCertificadoPercepcionIIBB INT,
    @NumeroTicketInicial INT,
    @NumeroTicketFinal INT,
    @IdUsuarioIngreso INT,
    @FechaIngreso DATETIME,
    @IdObra INT,
    @IdIBCondicion2 INT,
    @IdIBCondicion3 INT,
    @IdCodigoIva INT,
    @Exportacion_FOB NUMERIC(18, 2),
    @Exportacion_PosicionAduana VARCHAR(20),
    @Exportacion_Despacho VARCHAR(30),
    @Exportacion_Guia VARCHAR(20),
    @Exportacion_IdPaisDestino INT,
    @Exportacion_FechaEmbarque DATETIME,
    @Exportacion_FechaOficializacion DATETIME,
    @OtrasPercepciones3 NUMERIC(18, 2),
    @OtrasPercepciones3Desc VARCHAR(15),
    @NoIncluirEnCubos VARCHAR(2),
    @PercepcionIVA NUMERIC(18, 2),
    @PorcentajePercepcionIVA NUMERIC(6, 2),
    @ActivarRecuperoGastos VARCHAR(2),
    @IdAutorizoRecuperoGastos INT,
    @ContabilizarAFechaVencimiento VARCHAR(2),
    @FacturaContado VARCHAR(2),
    @IdReciboContado INT,
    @EnviarEmail INT,
    @IdOrigenTransmision INT,
    @IdFacturaOriginal INT,
    @FechaImportacionTransmision DATETIME,
    @CuitClienteTransmision VARCHAR(13),
    @IdReciboContadoOriginal INT,
    @DevolucionAnticipo VARCHAR(2),
    @PorcentajeDevolucionAnticipo NUMERIC(18, 10),
    @CAE VARCHAR(14),
    @RechazoCAE VARCHAR(11),
    @FechaVencimientoORechazoCAE DATETIME,
    @IdListaPrecios INT,
    @IdIdentificacionCAE INT
AS 
    INSERT  INTO [Facturas]
            (
              NumeroFactura,
              TipoABC,
              PuntoVenta,
              IdCliente,
              FechaFactura,
              IdCondicionVenta,
              IdVendedor,
              IdTransportista1,
              IdTransportista2,
              ItemDireccion,
              OrdenCompra,
              TipoPedidoConsignacion,
              Anulada,
              FechaAnulacion,
              Observaciones,
              IdRemito,
              NumeroRemito,
              IdPedido,
              NumeroPedido,
              ImporteTotal,
              ImporteIva1,
              ImporteIva2,
              ImporteBonificacion,
              RetencionIBrutos1,
              PorcentajeIBrutos1,
              RetencionIBrutos2,
              PorcentajeIBrutos2,
              ConvenioMultilateral,
              RetencionIBrutos3,
              PorcentajeIBrutos3,
              IdTipoVentaC,
              ImporteIvaIncluido,
              CotizacionDolar,
              EsMuestra,
              CotizacionADolarFijo,
              ImporteParteEnDolares,
              ImporteParteEnPesos,
              PorcentajeIva1,
              PorcentajeIva2,
              FechaVencimiento,
              IVANoDiscriminado,
              IdMoneda,
              CotizacionMoneda,
              PorcentajeBonificacion,
              OtrasPercepciones1,
              OtrasPercepciones1Desc,
              OtrasPercepciones2,
              OtrasPercepciones2Desc,
              IdProvinciaDestino,
              IdIBCondicion,
              IdAutorizaAnulacion,
              IdPuntoVenta,
              NumeroCAI,
              FechaVencimientoCAI,
              NumeroCertificadoPercepcionIIBB,
              NumeroTicketInicial,
              NumeroTicketFinal,
              IdUsuarioIngreso,
              FechaIngreso,
              IdObra,
              IdIBCondicion2,
              IdIBCondicion3,
              IdCodigoIva,
              Exportacion_FOB,
              Exportacion_PosicionAduana,
              Exportacion_Despacho,
              Exportacion_Guia,
              Exportacion_IdPaisDestino,
              Exportacion_FechaEmbarque,
              Exportacion_FechaOficializacion,
              OtrasPercepciones3,
              OtrasPercepciones3Desc,
              NoIncluirEnCubos,
              PercepcionIVA,
              PorcentajePercepcionIVA,
              ActivarRecuperoGastos,
              IdAutorizoRecuperoGastos,
              ContabilizarAFechaVencimiento,
              FacturaContado,
              IdReciboContado,
              EnviarEmail,
              IdOrigenTransmision,
              IdFacturaOriginal,
              FechaImportacionTransmision,
              CuitClienteTransmision,
              IdReciboContadoOriginal,
              DevolucionAnticipo,
              PorcentajeDevolucionAnticipo,
              CAE,
              RechazoCAE,
              FechaVencimientoORechazoCAE,
              IdListaPrecios,
              IdIdentificacionCAE
            )
    VALUES  (
              @NumeroFactura,
              @TipoABC,
              @PuntoVenta,
              @IdCliente,
              @FechaFactura,
              @IdCondicionVenta,
              @IdVendedor,
              @IdTransportista1,
              @IdTransportista2,
              @ItemDireccion,
              @OrdenCompra,
              @TipoPedidoConsignacion,
              @Anulada,
              @FechaAnulacion,
              @Observaciones,
              @IdRemito,
              @NumeroRemito,
              @IdPedido,
              @NumeroPedido,
              @ImporteTotal,
              @ImporteIva1,
              @ImporteIva2,
              @ImporteBonificacion,
              @RetencionIBrutos1,
              @PorcentajeIBrutos1,
              @RetencionIBrutos2,
              @PorcentajeIBrutos2,
              @ConvenioMultilateral,
              @RetencionIBrutos3,
              @PorcentajeIBrutos3,
              @IdTipoVentaC,
              @ImporteIvaIncluido,
              @CotizacionDolar,
              @EsMuestra,
              @CotizacionADolarFijo,
              @ImporteParteEnDolares,
              @ImporteParteEnPesos,
              @PorcentajeIva1,
              @PorcentajeIva2,
              @FechaVencimiento,
              @IVANoDiscriminado,
              @IdMoneda,
              @CotizacionMoneda,
              @PorcentajeBonificacion,
              @OtrasPercepciones1,
              @OtrasPercepciones1Desc,
              @OtrasPercepciones2,
              @OtrasPercepciones2Desc,
              @IdProvinciaDestino,
              @IdIBCondicion,
              @IdAutorizaAnulacion,
              @IdPuntoVenta,
              @NumeroCAI,
              @FechaVencimientoCAI,
              @NumeroCertificadoPercepcionIIBB,
              @NumeroTicketInicial,
              @NumeroTicketFinal,
              @IdUsuarioIngreso,
              @FechaIngreso,
              @IdObra,
              @IdIBCondicion2,
              @IdIBCondicion3,
              @IdCodigoIva,
              @Exportacion_FOB,
              @Exportacion_PosicionAduana,
              @Exportacion_Despacho,
              @Exportacion_Guia,
              @Exportacion_IdPaisDestino,
              @Exportacion_FechaEmbarque,
              @Exportacion_FechaOficializacion,
              @OtrasPercepciones3,
              @OtrasPercepciones3Desc,
              @NoIncluirEnCubos,
              @PercepcionIVA,
              @PorcentajePercepcionIVA,
              @ActivarRecuperoGastos,
              @IdAutorizoRecuperoGastos,
              @ContabilizarAFechaVencimiento,
              @FacturaContado,
              @IdReciboContado,
              @EnviarEmail,
              @IdOrigenTransmision,
              @IdFacturaOriginal,
              @FechaImportacionTransmision,
              @CuitClienteTransmision,
              @IdReciboContadoOriginal,
              @DevolucionAnticipo,
              @PorcentajeDevolucionAnticipo,
              @CAE,
              @RechazoCAE,
              @FechaVencimientoORechazoCAE,
              @IdListaPrecios,
              @IdIdentificacionCAE
            )

    SELECT  @IdFactura = @@identity
    RETURN ( @IdFactura )


GO
/****** Object:  StoredProcedure [dbo].[wFacturas_M]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wFacturas_M
    @IdFactura INT,
    @NumeroFactura INT,
    @TipoABC VARCHAR(1),
    @PuntoVenta SMALLINT,
    @IdCliente INT,
    @FechaFactura DATETIME,
    @IdCondicionVenta SMALLINT,
    @IdVendedor TINYINT,
    @IdTransportista1 TINYINT,
    @IdTransportista2 TINYINT,
    @ItemDireccion TINYINT,
    @OrdenCompra VARCHAR(20),
    @TipoPedidoConsignacion VARCHAR(1),
    @Anulada VARCHAR(2),
    @FechaAnulacion DATETIME,
    @Observaciones NTEXT,
    @IdRemito INT,
    @NumeroRemito INT,
    @IdPedido INT,
    @NumeroPedido INT,
    @ImporteTotal NUMERIC(18, 2),
    @ImporteIva1 NUMERIC(18, 2),
    @ImporteIva2 NUMERIC(18, 2),
    @ImporteBonificacion NUMERIC(18, 2),
    @RetencionIBrutos1 NUMERIC(18, 2),
    @PorcentajeIBrutos1 NUMERIC(6, 2),
    @RetencionIBrutos2 NUMERIC(18, 2),
    @PorcentajeIBrutos2 NUMERIC(6, 2),
    @ConvenioMultilateral VARCHAR(2),
    @RetencionIBrutos3 NUMERIC(18, 2),
    @PorcentajeIBrutos3 NUMERIC(6, 2),
    @IdTipoVentaC SMALLINT,
    @ImporteIvaIncluido NUMERIC(18, 2),
    @CotizacionDolar NUMERIC(18, 3),
    @EsMuestra VARCHAR(2),
    @CotizacionADolarFijo NUMERIC(18, 3),
    @ImporteParteEnDolares NUMERIC(18, 2),
    @ImporteParteEnPesos NUMERIC(18, 2),
    @PorcentajeIva1 NUMERIC(6, 2),
    @PorcentajeIva2 NUMERIC(6, 2),
    @FechaVencimiento DATETIME,
    @IVANoDiscriminado NUMERIC(18, 2),
    @IdMoneda INT,
    @CotizacionMoneda NUMERIC(18, 4),
    @PorcentajeBonificacion NUMERIC(6, 2),
    @OtrasPercepciones1 NUMERIC(18, 2),
    @OtrasPercepciones1Desc VARCHAR(15),
    @OtrasPercepciones2 NUMERIC(18, 2),
    @OtrasPercepciones2Desc VARCHAR(15),
    @IdProvinciaDestino INT,
    @IdIBCondicion INT,
    @IdAutorizaAnulacion INT,
    @IdPuntoVenta INT,
    @NumeroCAI NUMERIC(19, 0),
    @FechaVencimientoCAI DATETIME,
    @NumeroCertificadoPercepcionIIBB INT,
    @NumeroTicketInicial INT,
    @NumeroTicketFinal INT,
    @IdUsuarioIngreso INT,
    @FechaIngreso DATETIME,
    @IdObra INT,
    @IdIBCondicion2 INT,
    @IdIBCondicion3 INT,
    @IdCodigoIva INT,
    @Exportacion_FOB NUMERIC(18, 2),
    @Exportacion_PosicionAduana VARCHAR(20),
    @Exportacion_Despacho VARCHAR(30),
    @Exportacion_Guia VARCHAR(20),
    @Exportacion_IdPaisDestino INT,
    @Exportacion_FechaEmbarque DATETIME,
    @Exportacion_FechaOficializacion DATETIME,
    @OtrasPercepciones3 NUMERIC(18, 2),
    @OtrasPercepciones3Desc VARCHAR(15),
    @NoIncluirEnCubos VARCHAR(2),
    @PercepcionIVA NUMERIC(18, 2),
    @PorcentajePercepcionIVA NUMERIC(6, 2),
    @ActivarRecuperoGastos VARCHAR(2),
    @IdAutorizoRecuperoGastos INT,
    @ContabilizarAFechaVencimiento VARCHAR(2),
    @FacturaContado VARCHAR(2),
    @IdReciboContado INT,
    @EnviarEmail INT,
    @IdOrigenTransmision INT,
    @IdFacturaOriginal INT,
    @FechaImportacionTransmision DATETIME,
    @CuitClienteTransmision VARCHAR(13),
    @IdReciboContadoOriginal INT,
    @DevolucionAnticipo VARCHAR(2),
    @PorcentajeDevolucionAnticipo NUMERIC(18, 10),
    @CAE VARCHAR(14),
    @RechazoCAE VARCHAR(11),
    @FechaVencimientoORechazoCAE DATETIME,
    @IdListaPrecios INT,
    @IdIdentificacionCAE INT
AS 
    UPDATE  Facturas
    SET     NumeroFactura = @NumeroFactura,
            TipoABC = @TipoABC,
            PuntoVenta = @PuntoVenta,
            IdCliente = @IdCliente,
            FechaFactura = @FechaFactura,
            IdCondicionVenta = @IdCondicionVenta,
            IdVendedor = @IdVendedor,
            IdTransportista1 = @IdTransportista1,
            IdTransportista2 = @IdTransportista2,
            ItemDireccion = @ItemDireccion,
            OrdenCompra = @OrdenCompra,
            TipoPedidoConsignacion = @TipoPedidoConsignacion,
            Anulada = @Anulada,
            FechaAnulacion = @FechaAnulacion,
            Observaciones = @Observaciones,
            IdRemito = @IdRemito,
            NumeroRemito = @NumeroRemito,
            IdPedido = @IdPedido,
            NumeroPedido = @NumeroPedido,
            ImporteTotal = @ImporteTotal,
            ImporteIva1 = @ImporteIva1,
            ImporteIva2 = @ImporteIva2,
            ImporteBonificacion = @ImporteBonificacion,
            RetencionIBrutos1 = @RetencionIBrutos1,
            PorcentajeIBrutos1 = @PorcentajeIBrutos1,
            RetencionIBrutos2 = @RetencionIBrutos2,
            PorcentajeIBrutos2 = @PorcentajeIBrutos2,
            ConvenioMultilateral = @ConvenioMultilateral,
            RetencionIBrutos3 = @RetencionIBrutos3,
            PorcentajeIBrutos3 = @PorcentajeIBrutos3,
            IdTipoVentaC = @IdTipoVentaC,
            ImporteIvaIncluido = @ImporteIvaIncluido,
            CotizacionDolar = @CotizacionDolar,
            EsMuestra = @EsMuestra,
            CotizacionADolarFijo = @CotizacionADolarFijo,
            ImporteParteEnDolares = @ImporteParteEnDolares,
            ImporteParteEnPesos = @ImporteParteEnPesos,
            PorcentajeIva1 = @PorcentajeIva1,
            PorcentajeIva2 = @PorcentajeIva2,
            FechaVencimiento = @FechaVencimiento,
            IVANoDiscriminado = @IVANoDiscriminado,
            IdMoneda = @IdMoneda,
            CotizacionMoneda = @CotizacionMoneda,
            PorcentajeBonificacion = @PorcentajeBonificacion,
            OtrasPercepciones1 = @OtrasPercepciones1,
            OtrasPercepciones1Desc = @OtrasPercepciones1Desc,
            OtrasPercepciones2 = @OtrasPercepciones2,
            OtrasPercepciones2Desc = @OtrasPercepciones2Desc,
            IdProvinciaDestino = @IdProvinciaDestino,
            IdIBCondicion = @IdIBCondicion,
            IdAutorizaAnulacion = @IdAutorizaAnulacion,
            IdPuntoVenta = @IdPuntoVenta,
            NumeroCAI = @NumeroCAI,
            FechaVencimientoCAI = @FechaVencimientoCAI,
            NumeroCertificadoPercepcionIIBB = @NumeroCertificadoPercepcionIIBB,
            NumeroTicketInicial = @NumeroTicketInicial,
            NumeroTicketFinal = @NumeroTicketFinal,
            IdUsuarioIngreso = @IdUsuarioIngreso,
            FechaIngreso = @FechaIngreso,
            IdObra = @IdObra,
            IdIBCondicion2 = @IdIBCondicion2,
            IdIBCondicion3 = @IdIBCondicion3,
            IdCodigoIva = @IdCodigoIva,
            Exportacion_FOB = @Exportacion_FOB,
            Exportacion_PosicionAduana = @Exportacion_PosicionAduana,
            Exportacion_Despacho = @Exportacion_Despacho,
            Exportacion_Guia = @Exportacion_Guia,
            Exportacion_IdPaisDestino = @Exportacion_IdPaisDestino,
            Exportacion_FechaEmbarque = @Exportacion_FechaEmbarque,
            Exportacion_FechaOficializacion = @Exportacion_FechaOficializacion,
            OtrasPercepciones3 = @OtrasPercepciones3,
            OtrasPercepciones3Desc = @OtrasPercepciones3Desc,
            NoIncluirEnCubos = @NoIncluirEnCubos,
            PercepcionIVA = @PercepcionIVA,
            PorcentajePercepcionIVA = @PorcentajePercepcionIVA,
            ActivarRecuperoGastos = @ActivarRecuperoGastos,
            IdAutorizoRecuperoGastos = @IdAutorizoRecuperoGastos,
            ContabilizarAFechaVencimiento = @ContabilizarAFechaVencimiento,
            FacturaContado = @FacturaContado,
            IdReciboContado = @IdReciboContado,
            EnviarEmail = @EnviarEmail,
            IdOrigenTransmision = @IdOrigenTransmision,
            IdFacturaOriginal = @IdFacturaOriginal,
            FechaImportacionTransmision = @FechaImportacionTransmision,
            CuitClienteTransmision = @CuitClienteTransmision,
            IdReciboContadoOriginal = @IdReciboContadoOriginal,
            DevolucionAnticipo = @DevolucionAnticipo,
            PorcentajeDevolucionAnticipo = @PorcentajeDevolucionAnticipo,
            CAE = @CAE,
            RechazoCAE = @RechazoCAE,
            FechaVencimientoORechazoCAE = @FechaVencimientoORechazoCAE,
            IdListaPrecios = @IdListaPrecios,
            IdIdentificacionCAE = @IdIdentificacionCAE
    WHERE   ( IdFactura = @IdFactura )

    RETURN ( @IdFactura )


GO
/****** Object:  StoredProcedure [dbo].[wRubros_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wRubros_A]

@IdRubro int  output,
@Descripcion varchar(50),
@Abreviatura varchar(15),
@IdCuenta int,
@IdCuentaCompras int

AS

IF IsNull(@IdRubro,0)<=0
    BEGIN
	INSERT INTO Rubros
	(
	 Descripcion,
	 Abreviatura,
	 IdCuenta,
	 IdCuentaCompras
	)
	VALUES
	(
	 @Descripcion,
	 @Abreviatura,
	 @IdCuenta,
	 @IdCuentaCompras
	)
	
	SELECT @IdRubro=@@identity
    END
ELSE
    BEGIN
	UPDATE Rubros
	SET 
	 Descripcion=@Descripcion,
	 Abreviatura=@Abreviatura,
	 IdCuenta=@IdCuenta,
	 IdCuentaCompras=@IdCuentaCompras
	WHERE (IdRubro=@IdRubro)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdRubro



GO
/****** Object:  StoredProcedure [dbo].[wNotasCredito_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wNotasCredito_TT
AS 
    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30)
    SET @vector_X = '0111111111111111111111111133'
    SET @vector_T = '0290144114065555551638172600'

    SELECT  NotasCredito.IdNotaCredito,
            CASE WHEN ( NotasCredito.CtaCte = 'SI'
                        OR NotasCredito.CtaCte IS NULL
                      )
                      AND IdFacturaVenta_RecuperoGastos IS NULL THEN 'Normal'
                 ELSE 'Interna'
            END AS [Tipo],
            NotasCredito.IdNotaCredito AS [IdAux],
            NotasCredito.TipoABC AS [A/B/E],
            NotasCredito.PuntoVenta AS [Pto.vta.],
            NotasCredito.NumeroNotaCredito AS [Nota credito],
            NotasCredito.FechaNotaCredito AS [Fecha credito],
            NotasCredito.Anulada AS [Anulada],
            Clientes.CodigoCliente AS [Cod.Cli.],
            Clientes.RazonSocial AS [Cliente],
            DescripcionIva.Descripcion AS [Condicion IVA],
            Clientes.Cuit AS [Cuit],
            ( ISNULL(NotasCredito.ImporteTotal, 0)
              - ISNULL(NotasCredito.ImporteIva1, 0)
              - ISNULL(NotasCredito.ImporteIva2, 0)
              - ISNULL(NotasCredito.PercepcionIVA, 0)
              - ISNULL(NotasCredito.RetencionIBrutos1, 0)
              - ISNULL(NotasCredito.RetencionIBrutos2, 0)
              - ISNULL(NotasCredito.RetencionIBrutos3, 0)
              - ISNULL(NotasCredito.OtrasPercepciones1, 0)
              - ISNULL(NotasCredito.OtrasPercepciones2, 0)
              - ISNULL(NotasCredito.OtrasPercepciones3, 0) ) AS [Neto gravado],
            NotasCredito.ImporteIva1 AS [Iva],
            ISNULL(NotasCredito.RetencionIBrutos1, 0)
            + ISNULL(NotasCredito.RetencionIBrutos2, 0)
            + ISNULL(NotasCredito.RetencionIBrutos3, 0) AS [Ing.Brutos],
            NotasCredito.PercepcionIVA AS [Perc.IVA],
            ISNULL(NotasCredito.OtrasPercepciones1, 0)
            + ISNULL(NotasCredito.OtrasPercepciones2, 0)
            + ISNULL(NotasCredito.OtrasPercepciones3, 0) AS [Otras perc.],
            NotasCredito.ImporteTotal AS [Total credito],
            Monedas.Abreviatura AS [Mon.],
            Obras.NumeroObra AS [Obra],
            Provincias.Nombre AS [Provincia destino],
            NotasCredito.Observaciones,
            Vendedores.Nombre AS [Vendedor],
            NotasCredito.FechaAnulacion AS [Fecha anulacion],
            Empleados.Nombre AS [Ingreso],
            NotasCredito.FechaIngreso AS [Fecha ingreso]
--	@Vector_T as Vector_T,
--	@Vector_X as Vector_X
    FROM    NotasCredito
            LEFT OUTER JOIN Clientes ON NotasCredito.IdCliente = Clientes.IdCliente
            LEFT OUTER JOIN DescripcionIva ON ISNULL(NotasCredito.IdCodigoIva,
                                                     Clientes.IdCodigoIva) = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Obras ON NotasCredito.IdObra = Obras.IdObra
            LEFT OUTER JOIN Vendedores ON NotasCredito.IdVendedor = Vendedores.IdVendedor
            LEFT OUTER JOIN Monedas ON NotasCredito.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN Provincias ON NotasCredito.IdProvinciaDestino = Provincias.IdProvincia
            LEFT OUTER JOIN Empleados ON NotasCredito.IdUsuarioIngreso = Empleados.IdEmpleado
    ORDER BY NotasCredito.NumeroNotaCredito


GO
/****** Object:  StoredProcedure [dbo].[wRubros_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wRubros_E]

@IdRubro int  

AS 

DELETE Rubros
WHERE (IdRubro=@IdRubro)



GO
/****** Object:  StoredProcedure [dbo].[wLocalidades_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wLocalidades_TT
AS 
    SELECT  IdLocalidad,
            Localidades.Nombre AS [Localidad],
            Localidades.CodigoPostal AS [Codigo postal],
            Provincias.Nombre AS [Provincia],
            Paises.Descripcion AS [Pais],
            CodigoONCAA as CodigoONCAA, CodigoWilliams,CodigoLosGrobo
    FROM    Localidades
            LEFT OUTER JOIN Provincias ON Provincias.IdProvincia = Localidades.IdProvincia
            LEFT OUTER JOIN Paises ON Paises.IdPais = Provincias.IdPais
    ORDER BY Localidades.Nombre


GO
/****** Object:  StoredProcedure [dbo].[wRubros_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wRubros_T]

@IdRubro int = Null

AS 

SET @IdRubro=IsNull(@IdRubro,-1)

IF @IdRubro=-2
	SELECT 
	 Rubros.IdRubro as [IdRubro],
	 Rubros.Descripcion as [Descripcion],
	 Rubros.Abreviatura as [Abrev.],
	 C1.Descripcion+' - [ '+Convert(varchar,C1.Codigo)+' ]' as [Cta.Ventas],
	 C2.Descripcion+' - [ '+Convert(varchar,C2.Codigo)+' ]' as [Cta.Compras]
	FROM Rubros
	LEFT OUTER JOIN Cuentas C1 ON Rubros.IdCuenta=C1.IdCuenta
	LEFT OUTER JOIN Cuentas C2 ON Rubros.IdCuentaCompras=C2.IdCuenta
	ORDER BY Rubros.Descripcion
ELSE
	SELECT 
	 Rubros.*,
	 C1.Descripcion as [CuentaVentas],
	 C2.Descripcion as [CuentaCompras]
	FROM Rubros
	LEFT OUTER JOIN Cuentas C1 ON Rubros.IdCuenta=C1.IdCuenta
	LEFT OUTER JOIN Cuentas C2 ON Rubros.IdCuentaCompras=C2.IdCuenta
	WHERE @IdRubro=-1 or Rubros.IdRubro=@IdRubro
	ORDER BY Rubros.Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wDetOrdenesCompra_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [wDetOrdenesCompra_T] @IdOrdenCompra INT
AS 
    SELECT  doc.IdDetalleOrdenCompra,
            doc.IdOrdenCompra,
            doc.TipoCancelacion,
            ISNULL(doc.FacturacionAutomatica, 'NO') AS [FacturacionAutomatica],
            doc.NumeroItem AS [Item],
            Articulos.IdArticulo,
            Articulos.Codigo AS [Codigo],
            Articulos.Descripcion AS [Articulo],
            Colores.Descripcion AS [Color],
            doc.Cantidad AS [Cant.],
            Unidades.Abreviatura AS [Un.],
            doc.Precio AS [Precio],
            doc.PorcentajeBonificacion AS [% Bon],
            doc.OrigenDescripcion,
            ( doc.Cantidad * doc.Precio ) * ISNULL(doc.PorcentajeBonificacion,
                                                   0) / 100 AS [Bonificacion],
            ( doc.Cantidad * doc.Precio ) * ( 1
                                              - ISNULL(doc.PorcentajeBonificacion,
                                                       0) / 100 ) AS [Importe],
            ( SELECT    SUM(ISNULL(Stock.CantidadUnidades, 0))
              FROM      Stock
              WHERE     Stock.IdArticulo = doc.IdArticulo
            ) AS [Stock],
            doc.FechaNecesidad AS [Fecha nec.],
            doc.FechaEntrega AS [Fecha ent.],
            doc.Observaciones,
            doc.Cumplido AS [Cum]
    FROM    DetalleOrdenesCompra doc
            LEFT OUTER JOIN Articulos ON doc.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Unidades ON doc.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN Colores ON doc.IdColor = Colores.IdColor
    WHERE   ( doc.IdOrdenCompra = @IdOrdenCompra )
    ORDER BY doc.NumeroItem


GO
/****** Object:  StoredProcedure [dbo].[wRubros_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[wRubros_TL]
AS 
SELECT IdRubro, Descripcion as [Titulo]
FROM Rubros
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wComprobantesProveedores_TXFecha]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[wComprobantesProveedores_TXFecha]

@Desde datetime,
@Hasta datetime,
@IdUsuario int

AS

SET NOCOUNT ON

DECLARE @IdUsuarioFF int
SET @IdUsuarioFF=IsNull((Select Top 1 E.IdEmpleado From Empleados E 
				Where E.IdEmpleado=@IdUsuario and E.IdCuentaFondoFijo is not null),-1)

CREATE TABLE #Auxiliar1 (IdComprobanteProveedor INTEGER, IdCuenta INTEGER)
INSERT INTO #Auxiliar1 
 SELECT cp.IdComprobanteProveedor, 
	(Select Top 1 dcp.IdCuenta From DetalleComprobantesProveedores dcp 
	 Where dcp.IdComprobanteProveedor=cp.IdComprobanteProveedor)
 FROM ComprobantesProveedores cp
 WHERE (cp.FechaRecepcion Between @Desde And @Hasta) and 
	(cp.Confirmado is null or cp.Confirmado<>'NO')

SET NOCOUNT OFF

Declare @vector_X varchar(50),@vector_T varchar(50)
Set @vector_X='0111111111111111111111111111111111133'
Set @vector_T='0093634441221012111111023126263222800'

SELECT 
 cp.IdComprobanteProveedor, 
 TiposComprobante.Descripcion as [Tipo comp.],
 cp.IdComprobanteProveedor as [IdAux ], 
 cp.NumeroReferencia as [Nro.interno],
 Substring(cp.Letra+'-'+Substring('0000',1,4-Len(Convert(varchar,cp.NumeroComprobante1)))+
	Convert(varchar,cp.NumeroComprobante1)+'-'+Substring('00000000',1,8-Len(Convert(varchar,cp.NumeroComprobante2)))+Convert(varchar,cp.NumeroComprobante2),1,20) as [Numero],
 Case 	When cp.IdProveedor is not null Then 'Cta. cte.' 
	When cp.IdCuenta is not null Then 'F.fijo' 
	When cp.IdCuentaOtros is not null Then 'Otros' 
	Else Null
 End as [Tipo],
 cp.FechaComprobante as [Fecha comp.], 
 cp.FechaRecepcion as [Fecha recep.],
 cp.FechaVencimiento as [Fecha vto.],
 IsNull(P1.CodigoEmpresa,P2.CodigoEmpresa) as [Cod.Prov.], 
 IsNull(P1.RazonSocial,C1.Descripcion) as [Proveedor / Cuenta], IsNull(P1.RazonSocial,C1.Descripcion) as [Cuenta],
 P2.RazonSocial as [Proveedor FF],
 OrdenesPago.NumeroOrdenPago as [Vale],
 IsNull(diva1.Descripcion,IsNull(diva2.Descripcion,diva3.Descripcion)) as [Condicion IVA], 
 cp.IdObra, cp.IdCuenta, cp.Confirmado,cp.NumeroRendicionFF, cp.NumeroReferencia ,FechaComprobante,
 Convert(varchar,Obras.NumeroObra)+' '+Obras.Descripcion as [Obra],
 C2.Descripcion as [Cuenta contable],
 cp.TotalBruto as [Subtotal],
 cp.TotalIva1 as [IVA 1],
 cp.TotalIva2 as [IVA 2],
 cp.AjusteIVA as [Aj.IVA],
 cp.TotalBonificacion as [Imp.bonif.],
 cp.TotalComprobante as [Total],
 Monedas.Abreviatura as [Mon.],
 cp.CotizacionDolar as [Cotiz. dolar],
 Provincias.Nombre as [Provincia destino],
 cp.Observaciones,
 E1.Nombre as [Ingreso],
 cp.FechaIngreso as [Fecha ingreso],
 E2.Nombre  as [Modifico],
 cp.FechaModifico as [Fecha modif.],
 Case 	When DestinoPago='A' Then 'ADM'
	When DestinoPago='O' Then 'OBRA'
	Else Null
 End as [Dest.Pago],
 cp.NumeroRendicionFF as [Nro.Rend.FF],
 (Select Top 1 DetObra.Destino
	From DetalleComprobantesProveedores Det 
	Left Outer Join DetalleObrasDestinos DetObra On DetObra.IdDetalleObraDestino=Det.IdDetalleObraDestino
	Where Det.IdComprobanteProveedor=cp.IdComprobanteProveedor and Det.IdDetalleObraDestino is not null) as [Etapa],
 (Select Top 1 por.Descripcion
	From DetalleComprobantesProveedores Det 
	Left Outer Join PresupuestoObrasRubros por On por.IdPresupuestoObraRubro=Det.IdPresupuestoObraRubro
	Where Det.IdComprobanteProveedor=cp.IdComprobanteProveedor and Det.IdPresupuestoObraRubro is not null) as [Rubro],
 cp.CircuitoFirmasCompleto as [Circuito de firmas completo],
 cp.ConfirmadoPorWeb
 FROM ComprobantesProveedores cp
LEFT OUTER JOIN Proveedores P1 ON cp.IdProveedor = P1.IdProveedor
LEFT OUTER JOIN Proveedores P2 ON cp.IdProveedorEventual = P2.IdProveedor
LEFT OUTER JOIN Cuentas C1 ON IsNull(cp.IdCuenta,cp.IdCuentaOtros) = C1.IdCuenta
LEFT OUTER JOIN TiposComprobante ON cp.IdTipoComprobante = TiposComprobante.IdTipoComprobante
LEFT OUTER JOIN Obras ON cp.IdObra = Obras.IdObra
LEFT OUTER JOIN OrdenesPago ON cp.IdOrdenPago = OrdenesPago.IdOrdenPago
LEFT OUTER JOIN Monedas ON cp.IdMoneda = Monedas.IdMoneda
LEFT OUTER JOIN Provincias ON cp.IdProvinciaDestino = Provincias.IdProvincia
LEFT OUTER JOIN DescripcionIva diva1 ON cp.IdCodigoIva = diva1.IdCodigoIva
LEFT OUTER JOIN DescripcionIva diva2 ON P1.IdCodigoIva = diva2.IdCodigoIva
LEFT OUTER JOIN DescripcionIva diva3 ON P2.IdCodigoIva = diva3.IdCodigoIva
LEFT OUTER JOIN Empleados E1 ON cp.IdUsuarioIngreso = E1.IdEmpleado
LEFT OUTER JOIN Empleados E2 ON cp.IdUsuarioModifico = E2.IdEmpleado
LEFT OUTER JOIN #Auxiliar1 ON cp.IdComprobanteProveedor = #Auxiliar1.IdComprobanteProveedor
LEFT OUTER JOIN Cuentas C2 ON #Auxiliar1.IdCuenta = C2.IdCuenta
WHERE (cp.FechaRecepcion Between @Desde And @Hasta) and 
	--(cp.Confirmado is null or cp.Confirmado<>'NO') and 
	(@IdUsuarioFF=-1 or @IdUsuarioFF=cp.IdUsuarioIngreso)
ORDER BY cp.FechaRecepcion,cp.NumeroReferencia

DROP TABLE #Auxiliar1


GO
/****** Object:  StoredProcedure [dbo].[wRemitos_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRemitos_A
    @IdRemito INT OUTPUT,
    @NumeroRemito INT,
    @IdCliente INT,
    @FechaRemito DATETIME,
    @IdCondicionVenta INT,
    @Anulado VARCHAR(2),
    @FechaAnulacion DATETIME,
    @Observaciones NTEXT,
    @ArchivoAdjunto1 VARCHAR(100),
    @ArchivoAdjunto2 VARCHAR(100),
    @ArchivoAdjunto3 VARCHAR(100),
    @ArchivoAdjunto4 VARCHAR(100),
    @ArchivoAdjunto5 VARCHAR(100),
    @ArchivoAdjunto6 VARCHAR(100),
    @ArchivoAdjunto7 VARCHAR(100),
    @ArchivoAdjunto8 VARCHAR(100),
    @ArchivoAdjunto9 VARCHAR(100),
    @ArchivoAdjunto10 VARCHAR(100),
    @Destino INT,
    @IdProveedor INT,
    @IdTransportista INT,
    @TotalBultos INT,
    @ValorDeclarado NUMERIC(18, 2),
    @FechaRegistracion DATETIME,
    @IdAutorizaAnulacion INT,
    @IdPuntoVenta INT,
    @PuntoVenta INT,
    @Patente VARCHAR(25),
    @Chofer VARCHAR(50),
    @NumeroDocumento VARCHAR(30),
    @OrdenCarga VARCHAR(10),
    @OrdenCompra VARCHAR(10),
    @COT VARCHAR(20),
    @IdEquipo INT,
    @IdObra INT,
    @IdListaPrecios INT,
    @IdDetalleClienteLugarEntrega INT
AS 
    INSERT  INTO Remitos
            (
              NumeroRemito,
              IdCliente,
              FechaRemito,
              IdCondicionVenta,
              Anulado,
              FechaAnulacion,
              Observaciones,
              ArchivoAdjunto1,
              ArchivoAdjunto2,
              ArchivoAdjunto3,
              ArchivoAdjunto4,
              ArchivoAdjunto5,
              ArchivoAdjunto6,
              ArchivoAdjunto7,
              ArchivoAdjunto8,
              ArchivoAdjunto9,
              ArchivoAdjunto10,
              Destino,
              IdProveedor,
              IdTransportista,
              TotalBultos,
              ValorDeclarado,
              FechaRegistracion,
              IdAutorizaAnulacion,
              IdPuntoVenta,
              PuntoVenta,
              Patente,
              Chofer,
              NumeroDocumento,
              OrdenCarga,
              OrdenCompra,
              COT,
              IdEquipo,
              IdObra,
              IdListaPrecios,
              IdDetalleClienteLugarEntrega
            )
    VALUES  (
              @NumeroRemito,
              @IdCliente,
              @FechaRemito,
              @IdCondicionVenta,
              @Anulado,
              @FechaAnulacion,
              @Observaciones,
              @ArchivoAdjunto1,
              @ArchivoAdjunto2,
              @ArchivoAdjunto3,
              @ArchivoAdjunto4,
              @ArchivoAdjunto5,
              @ArchivoAdjunto6,
              @ArchivoAdjunto7,
              @ArchivoAdjunto8,
              @ArchivoAdjunto9,
              @ArchivoAdjunto10,
              @Destino,
              @IdProveedor,
              @IdTransportista,
              @TotalBultos,
              @ValorDeclarado,
              GETDATE(),
              @IdAutorizaAnulacion,
              @IdPuntoVenta,
              @PuntoVenta,
              @Patente,
              @Chofer,
              @NumeroDocumento,
              @OrdenCarga,
              @OrdenCompra,
              @COT,
              @IdEquipo,
              @IdObra,
              @IdListaPrecios,
              @IdDetalleClienteLugarEntrega
            )

    SELECT  @IdRemito = @@identity
    RETURN ( @IdRemito )


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wArticulos_A]
    @IdArticulo INT,
    @Codigo VARCHAR(20),
    @NumeroInventario VARCHAR(20),
    @Descripcion VARCHAR(256),
    @IdRubro INT,
    @IdSubrubro INT,
    @IdUnidad INT,
    @AlicuotaIVA NUMERIC(6, 2),
    @CostoPPP NUMERIC(18, 2),
    @CostoPPPDolar NUMERIC(18, 2),
    @CostoReposicion NUMERIC(18, 2),
    @CostoReposicionDolar NUMERIC(18, 2),
    @Observaciones NTEXT,
    @AuxiliarString5 VARCHAR(50),
    @AuxiliarString6 VARCHAR(50),
    @AuxiliarString7 VARCHAR(50)
AS 
    IF ISNULL(@IdArticulo, 0) <= 0 
        BEGIN
            INSERT  INTO Articulos
                    (
                      Codigo,
                      NumeroInventario,
                      Descripcion,
                      IdRubro,
                      IdSubrubro,
                      IdUnidad,
                      AlicuotaIVA,
                      CostoPPP,
                      CostoPPPDolar,
                      CostoReposicion,
                      CostoReposicionDolar,
                      Observaciones,
                      AuxiliarString5,
                      AuxiliarString6,
                      AuxiliarString7
	              )
            VALUES  (
                      @Codigo,
                      @NumeroInventario,
                      @Descripcion,
                      @IdRubro,
                      @IdSubrubro,
                      @IdUnidad,
                      @AlicuotaIVA,
                      @CostoPPP,
                      @CostoPPPDolar,
                      @CostoReposicion,
                      @CostoReposicionDolar,
                      @Observaciones,
                      @AuxiliarString5,
                      @AuxiliarString6,
                      @AuxiliarString7
	              )
	
            SELECT  @IdArticulo = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  Articulos
            SET     Codigo = @Codigo,
                    NumeroInventario = @NumeroInventario,
                    Descripcion = @Descripcion,
                    IdRubro = @IdRubro,
                    IdSubrubro = @IdSubrubro,
                    IdUnidad = @IdUnidad,
                    AlicuotaIVA = @AlicuotaIVA,
                    CostoPPP = @CostoPPP,
                    CostoPPPDolar = @CostoPPPDolar,
                    CostoReposicion = @CostoReposicion,
                    CostoReposicionDolar = @CostoReposicionDolar,
                    Observaciones = @Observaciones,
                    AuxiliarString5 = @AuxiliarString5,
                    AuxiliarString6 = @AuxiliarString6,
                    AuxiliarString7 = @AuxiliarString7
            WHERE   ( IdArticulo = @IdArticulo )
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdArticulo

GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wSubrubros_A]

@IdSubrubro int  output,
@Descripcion varchar(50),
@Abreviatura varchar(15)

AS

IF IsNull(@IdSubrubro,0)<=0
    BEGIN
	INSERT INTO Subrubros
	(
	 Descripcion,
	 Abreviatura
	)
	VALUES
	(
	 @Descripcion,
	 @Abreviatura
	)
	
	SELECT @IdSubrubro=@@identity
    END
ELSE
    BEGIN
	UPDATE Subrubros
	SET 
	 Descripcion=@Descripcion,
	 Abreviatura=@Abreviatura
	WHERE (IdSubrubro=@IdSubrubro)
    END

IF @@ERROR <> 0
	RETURN -1
ELSE
	RETURN @IdSubrubro



GO
/****** Object:  StoredProcedure [dbo].[wRemitos_M]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRemitos_M
    @IdRemito INT,
    @NumeroRemito INT,
    @IdCliente INT,
    @FechaRemito DATETIME,
    @IdCondicionVenta INT,
    @Anulado VARCHAR(2),
    @FechaAnulacion DATETIME,
    @Observaciones NTEXT,
    @ArchivoAdjunto1 VARCHAR(100),
    @ArchivoAdjunto2 VARCHAR(100),
    @ArchivoAdjunto3 VARCHAR(100),
    @ArchivoAdjunto4 VARCHAR(100),
    @ArchivoAdjunto5 VARCHAR(100),
    @ArchivoAdjunto6 VARCHAR(100),
    @ArchivoAdjunto7 VARCHAR(100),
    @ArchivoAdjunto8 VARCHAR(100),
    @ArchivoAdjunto9 VARCHAR(100),
    @ArchivoAdjunto10 VARCHAR(100),
    @Destino INT,
    @IdProveedor INT,
    @IdTransportista INT,
    @TotalBultos INT,
    @ValorDeclarado NUMERIC(18, 2),
    @FechaRegistracion DATETIME,
    @IdAutorizaAnulacion INT,
    @IdPuntoVenta INT,
    @PuntoVenta INT,
    @Patente VARCHAR(25),
    @Chofer VARCHAR(50),
    @NumeroDocumento VARCHAR(30),
    @OrdenCarga VARCHAR(10),
    @OrdenCompra VARCHAR(10),
    @COT VARCHAR(20),
    @IdEquipo INT,
    @IdObra INT,
    @IdListaPrecios INT,
    @IdDetalleClienteLugarEntrega INT
AS 
    UPDATE  Remitos
    SET     NumeroRemito = @NumeroRemito,
            IdCliente = @IdCliente,
            FechaRemito = @FechaRemito,
            IdCondicionVenta = @IdCondicionVenta,
            Anulado = @Anulado,
            FechaAnulacion = @FechaAnulacion,
            Observaciones = @Observaciones,
            ArchivoAdjunto1 = @ArchivoAdjunto1,
            ArchivoAdjunto2 = @ArchivoAdjunto2,
            ArchivoAdjunto3 = @ArchivoAdjunto3,
            ArchivoAdjunto4 = @ArchivoAdjunto4,
            ArchivoAdjunto5 = @ArchivoAdjunto5,
            ArchivoAdjunto6 = @ArchivoAdjunto6,
            ArchivoAdjunto7 = @ArchivoAdjunto7,
            ArchivoAdjunto8 = @ArchivoAdjunto8,
            ArchivoAdjunto9 = @ArchivoAdjunto9,
            ArchivoAdjunto10 = @ArchivoAdjunto10,
            Destino = @Destino,
            IdProveedor = @IdProveedor,
            IdTransportista = @IdTransportista,
            TotalBultos = @TotalBultos,
            ValorDeclarado = @ValorDeclarado,
            FechaRegistracion = @FechaRegistracion,
            IdAutorizaAnulacion = @IdAutorizaAnulacion,
            IdPuntoVenta = @IdPuntoVenta,
            PuntoVenta = @PuntoVenta,
            Patente = @Patente,
            Chofer = @Chofer,
            NumeroDocumento = @NumeroDocumento,
            OrdenCarga = @OrdenCarga,
            OrdenCompra = @OrdenCompra,
            COT = @COT,
            IdEquipo = @IdEquipo,
            IdObra = @IdObra,
            IdListaPrecios = @IdListaPrecios,
            IdDetalleClienteLugarEntrega = @IdDetalleClienteLugarEntrega
    WHERE   ( IdRemito = @IdRemito )

    RETURN ( @IdRemito )


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wArticulos_T] @IdArticulo INT = NULL
AS 
    SET @IdArticulo = ISNULL(@IdArticulo, -1)

    SELECT top 10 Articulos.*,
            Rubros.Descripcion AS [Rubro],
            Subrubros.Descripcion AS [Subrubro],
            ( SELECT    SUM(Stock.CantidadUnidades)
              FROM      Stock
              WHERE     Stock.IdArticulo = Articulos.IdArticulo
            ) AS [Stock actual],
            ( SELECT TOP 1
                        Unidades.Abreviatura
              FROM      Unidades
              WHERE     Articulos.IdUnidad = Unidades.IdUnidad
            ) AS [Un],
            ISNULL(Depositos.Abreviatura, Depositos.Descripcion) + ISNULL(', ' + Ubicaciones.Descripcion, '')
            + ISNULL(' - Est.:' + Ubicaciones.Estanteria, '')
            + ISNULL(' - Mod.:' + Ubicaciones.Modulo, '') + ISNULL(' - Gab.:' + Ubicaciones.Gabeta, '') AS [Ubicacion],
            Unidades.Abreviatura AS [Unidad],
			
 Articulos.Codigo as [Codigo material],  
 Articulos.Descripcion,  
 Articulos.IdArticulo as [Identificador],  
 Rubros.Descripcion as [Rubro],  
 Subrubros.Descripcion as [Subrubro],  
 Articulos.NumeroInventario as [Nro.inv.],  
 Articulos.AlicuotaIVA as [% IVA],  
 Case When Articulos.CostoPPP=0 Then Null Else Articulos.CostoPPP End as [Costo PPP],  
 Case When Articulos.CostoPPPDolar=0 Then Null Else Articulos.CostoPPPDolar End as [Costo PPP u$s],  
 Case When Articulos.CostoReposicion=0 Then Null Else Articulos.CostoReposicion End as [Costo Rep.],  
 Case When Articulos.CostoReposicionDolar=0 Then Null Else Articulos.CostoReposicionDolar End as [Costo Rep u$s],  
 Articulos.StockMinimo as [Stock Min.],  
 Articulos.StockReposicion as [Stock Rep.],  
 (Select Sum(Stock.CantidadUnidades) From Stock Where Stock.IdArticulo=Articulos.IdArticulo) as [Stock actual],  
 (Select Top 1 Unidades.Abreviatura From Unidades Where Articulos.IdUnidad=Unidades.IdUnidad) as [En],  
 IsNull(Depositos.Abreviatura,Depositos.Descripcion COLLATE SQL_Latin1_General_CP1_CI_AS)+  
 IsNull(', '+Ubicaciones.Descripcion COLLATE SQL_Latin1_General_CP1_CI_AS,'')+  
 IsNull(' - Est.:'+Ubicaciones.Estanteria COLLATE SQL_Latin1_General_CP1_CI_AS,'')+  
 IsNull(' - Mod.:'+Ubicaciones.Modulo COLLATE SQL_Latin1_General_CP1_CI_AS,'')+  
 IsNull(' - Gab.:'+Ubicaciones.Gabeta COLLATE SQL_Latin1_General_CP1_CI_AS,'') as [Ubicacion],  
 Articulos.FechaAlta as [Fecha alta],  
 Articulos.UsuarioAlta as [Usuario alta],  
 Articulos.FechaUltimaModificacion as [Fecha ult.modif.],  
 Articulos.ParaMantenimiento as [p/mant.],  
 Articulos.AuxiliarString10 as [NMC]  
 --Cuentas.Codigo as [Cod.Cta.Compras],  
 --Cuentas.Descripcion as [Cuenta de compras]
    FROM    Articulos
            LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro
            LEFT OUTER JOIN Subrubros ON Articulos.IdSubrubro = Subrubros.IdSubrubro
            LEFT OUTER JOIN Ubicaciones ON Articulos.IdUbicacionStandar = Ubicaciones.IdUbicacion
            LEFT OUTER JOIN Depositos ON Ubicaciones.IdDeposito = Depositos.IdDeposito
            LEFT OUTER JOIN Unidades ON Articulos.IdUnidad = Unidades.IdUnidad
    WHERE   ( @IdArticulo = -1
              OR Articulos.IdArticulo = @IdArticulo
            ) --and IsNull(Articulos.Activo,'')<>'NO'
    ORDER BY Rubros.Descripcion,
            Subrubros.Descripcion,
            Articulos.Codigo


GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wSubrubros_E]

@IdSubrubro int  

AS 

DELETE Subrubros
WHERE (IdSubrubro=@IdSubrubro)



GO
/****** Object:  StoredProcedure [dbo].[wDetRemitos_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE wDetRemitos_A
    @IdDetalleRemito INT OUTPUT,
    @IdRemito INT,
    @NumeroItem INT,
    @Cantidad NUMERIC(18, 2),
    @IdUnidad INT,
    @IdArticulo INT,
    @Precio NUMERIC(18, 2),
    @Observaciones NTEXT,
    @PorcentajeCertificacion NUMERIC(6, 2),
    @OrigenDescripcion INT,
    @IdDetalleOrdenCompra INT,
    @TipoCancelacion INT,
    @IdUbicacion INT,
    @IdObra INT,
    @Partida VARCHAR(20),
    @DescargaPorKit VARCHAR(2),
    @NumeroCaja INT
AS 
    BEGIN TRAN

    DECLARE @Anulado VARCHAR(2),
        @IdStock1 INT

--en Web no puedo dejar esta linea, se traba la transaccion si voy a buscar el ID del encabezado que estoy editando
--SET @Anulado=IsNull((Select Top 1 Anulado From Remitos Where IdRemito=@IdRemito),'NO')

    IF @Anulado <> 'SI' 
        BEGIN
            IF ISNULL(@DescargaPorKit, 'NO') <> 'SI' 
                BEGIN
                    SET @IdStock1 = ISNULL(( SELECT TOP 1
                                                    Stock.IdStock
                                             FROM   Stock
                                             WHERE  IdArticulo = @IdArticulo
                                                    AND Partida = @Partida
                                                    AND IdUbicacion = @IdUbicacion
                                                    AND IdObra = @IdObra
                                                    AND IdUnidad = @IdUnidad
                                                    AND ISNULL(NumeroCaja, 0) = ISNULL(@NumeroCaja, 0)
                                           ), 0)
                    IF @IdStock1 > 0 
                        UPDATE  Stock
                        SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                - @Cantidad
                        WHERE   IdStock = @IdStock1
                    ELSE 
                        INSERT  INTO Stock
                                (
                                  IdArticulo,
                                  Partida,
                                  CantidadUnidades,
                                  CantidadAdicional,
                                  IdUnidad,
                                  IdUbicacion,
                                  IdObra,
                                  NumeroCaja
                                )
                        VALUES  (
                                  @IdArticulo,
                                  @Partida,
                                  @Cantidad * -1,
                                  NULL,
                                  @IdUnidad,
                                  @IdUbicacion,
                                  @IdObra,
                                  @NumeroCaja
                                )
                END
            ELSE 
                BEGIN
                    SET NOCOUNT ON
                    CREATE TABLE #Auxiliar1
                        (
                          IdArticuloConjunto INTEGER,
                          IdUnidadConjunto INTEGER,
                          CantidadConjunto NUMERIC(18, 3)
                        )
                    INSERT  INTO #Auxiliar1
                            SELECT  dc.IdArticulo,
                                    dc.IdUnidad,
                                    ISNULL(dc.Cantidad, 0)
                            FROM    DetalleConjuntos dc
                                    LEFT OUTER JOIN Conjuntos ON dc.IdConjunto = Conjuntos.IdConjunto
                            WHERE   ( Conjuntos.IdArticulo = @IdArticulo )

                    DECLARE @IdArticuloConjunto INT,
                        @IdUnidadConjunto INT,
                        @CantidadConjunto NUMERIC(18, 3)
                    CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 ( IdArticuloConjunto )
                    ON  [PRIMARY]
                    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
                        FOR SELECT  IdArticuloConjunto,
                                    IdUnidadConjunto,
                                    CantidadConjunto
                            FROM    #Auxiliar1
                            ORDER BY IdArticuloConjunto
                    OPEN Cur
                    FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                        @IdUnidadConjunto, @CantidadConjunto
                    WHILE @@FETCH_STATUS = 0
                        BEGIN
                            SET @IdStock1 = ISNULL(( SELECT TOP 1
                                                            Stock.IdStock
                                                     FROM   Stock
                                                     WHERE  IdArticulo = @IdArticuloConjunto
                                                            AND Partida = ''
                                                            AND IdUbicacion = @IdUbicacion
                                                            AND IdObra = @IdObra
                                                            AND IdUnidad = @IdUnidadConjunto
                                                   ), 0)
                            IF @IdStock1 > 0 
                                UPDATE  Stock
                                SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                        - ( @Cantidad * @CantidadConjunto )
                                WHERE   IdStock = @IdStock1
                            ELSE 
                                INSERT  INTO Stock
                                        (
                                          IdArticulo,
                                          Partida,
                                          CantidadUnidades,
                                          CantidadAdicional,
                                          IdUnidad,
                                          IdUbicacion,
                                          IdObra
                                        )
                                VALUES  (
                                          @IdArticuloConjunto,
                                          0,
                                          ( @Cantidad * @CantidadConjunto )
                                          * -1,
                                          NULL,
                                          @IdUnidadConjunto,
                                          @IdUbicacion,
                                          @IdObra
                                        )
                            FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                                @IdUnidadConjunto, @CantidadConjunto
                        END
                    CLOSE Cur
                    DEALLOCATE Cur

                    DROP TABLE #Auxiliar1
                    SET NOCOUNT OFF
                END
        END

    INSERT  INTO [DetalleRemitos]
            (
              IdRemito,
              NumeroItem,
              Cantidad,
              IdUnidad,
              IdArticulo,
              Precio,
              Observaciones,
              PorcentajeCertificacion,
              OrigenDescripcion,
              IdDetalleOrdenCompra,
              TipoCancelacion,
              IdUbicacion,
              IdObra,
              Partida,
              DescargaPorKit,
              NumeroCaja
            )
    VALUES  (
              @IdRemito,
              @NumeroItem,
              @Cantidad,
              @IdUnidad,
              @IdArticulo,
              @Precio,
              @Observaciones,
              @PorcentajeCertificacion,
              @OrigenDescripcion,
              @IdDetalleOrdenCompra,
              @TipoCancelacion,
              @IdUbicacion,
              @IdObra,
              @Partida,
              @DescargaPorKit,
              @NumeroCaja
            )

    SELECT  @IdDetalleRemito = @@identity

    IF @@ERROR <> 0 
        GOTO AbortTransaction

    COMMIT TRAN
    GOTO EndTransaction

    AbortTransaction:
    ROLLBACK TRAN

    EndTransaction:
    RETURN ( @IdDetalleRemito )


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wArticulos_TL]
AS 
    SELECT  IdArticulo,
            Descripcion AS [Titulo]
    FROM    Articulos
    ORDER BY Descripcion

GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wSubrubros_T]

@IdSubrubro int = Null

AS 

SET @IdSubrubro=IsNull(@IdSubrubro,-1)

IF @IdSubrubro=-2
	SELECT 
	 Subrubros.IdSubrubro as [IdSubrubro],
	 Subrubros.Descripcion as [Subrubro],
	 Subrubros.Abreviatura as [Abrev.]
	FROM Subrubros
	ORDER BY Subrubros.Descripcion
ELSE
	SELECT Subrubros.*
	FROM Subrubros
	WHERE @IdSubrubro=-1 or Subrubros.IdSubrubro=@IdSubrubro
	ORDER BY Subrubros.Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wDetRemitos_M]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wDetRemitos_M
    @IdDetalleRemito INT,
    @IdRemito INT,
    @NumeroItem INT,
    @Cantidad NUMERIC(18, 2),
    @IdUnidad INT,
    @IdArticulo INT,
    @Precio NUMERIC(18, 2),
    @Observaciones NTEXT,
    @PorcentajeCertificacion NUMERIC(6, 2),
    @OrigenDescripcion INT,
    @IdDetalleOrdenCompra INT,
    @TipoCancelacion INT,
    @IdUbicacion INT,
    @IdObra INT,
    @Partida VARCHAR(20),
    @DescargaPorKit VARCHAR(2),
    @NumeroCaja INT
AS 
    BEGIN TRAN

    DECLARE @IdStockAnt INT,
        @IdArticuloAnt INT,
        @PartidaAnt VARCHAR(20),
        @CantidadUnidadesAnt NUMERIC(18, 2),
        @IdUnidadAnt INT,
        @IdUbicacionAnt INT,
        @IdObraAnt INT,
        @NumeroCajaAnt INT,
        @IdStock1 INT,
        @Anulado VARCHAR(2)

--en Web no puedo dejar esta linea, se traba la transaccion si voy a buscar el ID del encabezado que estoy editando
--SET @Anulado=IsNull((Select Top 1 Anulado From Remitos Where IdRemito=@IdRemito),'NO')
    IF @Anulado <> 'SI' 
        BEGIN
            SET @IdArticuloAnt = ISNULL(( SELECT TOP 1
                                                    IdArticulo
                                          FROM      DetalleRemitos
                                          WHERE     IdDetalleRemito = @IdDetalleRemito
                                        ), 0)
            SET @PartidaAnt = ISNULL(( SELECT TOP 1
                                                Partida
                                       FROM     DetalleRemitos
                                       WHERE    IdDetalleRemito = @IdDetalleRemito
                                     ), '')
            SET @CantidadUnidadesAnt = ISNULL(( SELECT TOP 1
                                                        Cantidad
                                                FROM    DetalleRemitos
                                                WHERE   IdDetalleRemito = @IdDetalleRemito
                                              ), 0)
            SET @IdUnidadAnt = ISNULL(( SELECT TOP 1
                                                IdUnidad
                                        FROM    DetalleRemitos
                                        WHERE   IdDetalleRemito = @IdDetalleRemito
                                      ), 0)
            SET @IdUbicacionAnt = ISNULL(( SELECT TOP 1
                                                    IdUbicacion
                                           FROM     DetalleRemitos
                                           WHERE    IdDetalleRemito = @IdDetalleRemito
                                         ), 0)
            SET @IdObraAnt = ISNULL(( SELECT TOP 1
                                                IdObra
                                      FROM      DetalleRemitos
                                      WHERE     IdDetalleRemito = @IdDetalleRemito
                                    ), 0)
            SET @NumeroCajaAnt = ISNULL(( SELECT TOP 1
                                                    NumeroCaja
                                          FROM      DetalleRemitos
                                          WHERE     IdDetalleRemito = @IdDetalleRemito
                                        ), 0)

            IF ISNULL(@DescargaPorKit, 'NO') <> 'SI' 
                BEGIN
                    SET @IdStockAnt = ISNULL(( SELECT TOP 1
                                                        Stock.IdStock
                                               FROM     Stock
                                               WHERE    IdArticulo = @IdArticuloAnt
                                                        AND Partida = @PartidaAnt
                                                        AND IdUbicacion = @IdUbicacionAnt
                                                        AND IdObra = @IdObraAnt
                                                        AND IdUnidad = @IdUnidadAnt
                                                        AND ISNULL(NumeroCaja, 0) = ISNULL(@NumeroCajaAnt, 0)
                                             ), 0)
                    IF @IdStockAnt > 0 
                        UPDATE  Stock
                        SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                + @CantidadUnidadesAnt
                        WHERE   IdStock = @IdStockAnt
                    ELSE 
                        INSERT  INTO Stock
                                (
                                  IdArticulo,
                                  Partida,
                                  CantidadUnidades,
                                  CantidadAdicional,
                                  IdUnidad,
                                  IdUbicacion,
                                  IdObra,
                                  NumeroCaja
                                )
                        VALUES  (
                                  @IdArticuloAnt,
                                  @PartidaAnt,
                                  @CantidadUnidadesAnt,
                                  NULL,
                                  @IdUnidadAnt,
                                  @IdUbicacionAnt,
                                  @IdObraAnt,
                                  @NumeroCajaAnt
                                )
		
                    SET @IdStock1 = ISNULL(( SELECT TOP 1
                                                    Stock.IdStock
                                             FROM   Stock
                                             WHERE  IdArticulo = @IdArticulo
                                                    AND Partida = @Partida
                                                    AND IdUbicacion = @IdUbicacion
                                                    AND IdObra = @IdObra
                                                    AND IdUnidad = @IdUnidad
                                                    AND ISNULL(NumeroCaja, 0) = ISNULL(@NumeroCaja, 0)
                                           ), 0)
                    IF @IdStock1 > 0 
                        UPDATE  Stock
                        SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                - @Cantidad
                        WHERE   IdStock = @IdStock1
                    ELSE 
                        INSERT  INTO Stock
                                (
                                  IdArticulo,
                                  Partida,
                                  CantidadUnidades,
                                  CantidadAdicional,
                                  IdUnidad,
                                  IdUbicacion,
                                  IdObra,
                                  NumeroCaja
                                )
                        VALUES  (
                                  @IdArticulo,
                                  @Partida,
                                  @Cantidad * -1,
                                  NULL,
                                  @IdUnidad,
                                  @IdUbicacion,
                                  @IdObra,
                                  @NumeroCaja
                                )
                END
            ELSE 
                BEGIN
                    SET NOCOUNT ON
                    DECLARE @IdArticuloConjunto INT,
                        @IdUnidadConjunto INT,
                        @CantidadConjunto NUMERIC(18, 2)

                    CREATE TABLE #Auxiliar1
                        (
                          IdArticuloConjunto INTEGER,
                          IdUnidadConjunto INTEGER,
                          CantidadConjunto NUMERIC(18, 2)
                        )
                    INSERT  INTO #Auxiliar1
                            SELECT  dc.IdArticulo,
                                    dc.IdUnidad,
                                    ISNULL(dc.Cantidad, 0)
                            FROM    DetalleConjuntos dc
                                    LEFT OUTER JOIN Conjuntos ON dc.IdConjunto = Conjuntos.IdConjunto
                            WHERE   ( Conjuntos.IdArticulo = @IdArticuloAnt )

                    CREATE NONCLUSTERED INDEX IX__Auxiliar1 ON #Auxiliar1 ( IdArticuloConjunto )
                    ON  [PRIMARY]
                    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
                        FOR SELECT  IdArticuloConjunto,
                                    IdUnidadConjunto,
                                    CantidadConjunto
                            FROM    #Auxiliar1
                            ORDER BY IdArticuloConjunto
                    OPEN Cur
                    FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                        @IdUnidadConjunto, @CantidadConjunto
                    WHILE @@FETCH_STATUS = 0
                        BEGIN
                            SET @IdStock1 = ISNULL(( SELECT TOP 1
                                                            Stock.IdStock
                                                     FROM   Stock
                                                     WHERE  IdArticulo = @IdArticuloConjunto
                                                            AND Partida = ''
                                                            AND IdUbicacion = @IdUbicacion
                                                            AND IdObra = @IdObra
                                                            AND IdUnidad = @IdUnidadConjunto
                                                   ), 0)
                            IF @IdStock1 > 0 
                                UPDATE  Stock
                                SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                        + ( @Cantidad * @CantidadConjunto )
                                WHERE   IdStock = @IdStock1
                            ELSE 
                                INSERT  INTO Stock
                                        (
                                          IdArticulo,
                                          Partida,
                                          CantidadUnidades,
                                          CantidadAdicional,
                                          IdUnidad,
                                          IdUbicacion,
                                          IdObra
                                        )
                                VALUES  (
                                          @IdArticuloConjunto,
                                          0,
                                          ( @Cantidad * @CantidadConjunto ),
                                          NULL,
                                          @IdUnidadConjunto,
                                          @IdUbicacion,
                                          @IdObra
                                        )
                            FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                                @IdUnidadConjunto, @CantidadConjunto
                        END
                    CLOSE Cur
                    DEALLOCATE Cur
                    DROP TABLE #Auxiliar1

                    CREATE TABLE #Auxiliar2
                        (
                          IdArticuloConjunto INTEGER,
                          IdUnidadConjunto INTEGER,
                          CantidadConjunto NUMERIC(18, 2)
                        )
                    INSERT  INTO #Auxiliar2
                            SELECT  dc.IdArticulo,
                                    dc.IdUnidad,
                                    ISNULL(dc.Cantidad, 0)
                            FROM    DetalleConjuntos dc
                                    LEFT OUTER JOIN Conjuntos ON dc.IdConjunto = Conjuntos.IdConjunto
                            WHERE   ( Conjuntos.IdArticulo = @IdArticulo )

                    CREATE NONCLUSTERED INDEX IX__Auxiliar2 ON #Auxiliar2 ( IdArticuloConjunto )
                    ON  [PRIMARY]
                    DECLARE Cur CURSOR LOCAL FORWARD_ONLY
                        FOR SELECT  IdArticuloConjunto,
                                    IdUnidadConjunto,
                                    CantidadConjunto
                            FROM    #Auxiliar2
                            ORDER BY IdArticuloConjunto
                    OPEN Cur
                    FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                        @IdUnidadConjunto, @CantidadConjunto
                    WHILE @@FETCH_STATUS = 0
                        BEGIN
                            SET @IdStock1 = ISNULL(( SELECT TOP 1
                                                            Stock.IdStock
                                                     FROM   Stock
                                                     WHERE  IdArticulo = @IdArticuloConjunto
                                                            AND Partida = ''
                                                            AND IdUbicacion = @IdUbicacion
                                                            AND IdObra = @IdObra
                                                            AND IdUnidad = @IdUnidadConjunto
                                                   ), 0)
                            IF @IdStock1 > 0 
                                UPDATE  Stock
                                SET     CantidadUnidades = ISNULL(CantidadUnidades, 0)
                                        - ( @Cantidad * @CantidadConjunto )
                                WHERE   IdStock = @IdStock1
                            ELSE 
                                INSERT  INTO Stock
                                        (
                                          IdArticulo,
                                          Partida,
                                          CantidadUnidades,
                                          CantidadAdicional,
                                          IdUnidad,
                                          IdUbicacion,
                                          IdObra
                                        )
                                VALUES  (
                                          @IdArticuloConjunto,
                                          0,
                                          ( @Cantidad * @CantidadConjunto )
                                          * -1,
                                          NULL,
                                          @IdUnidadConjunto,
                                          @IdUbicacion,
                                          @IdObra
                                        )
                            FETCH NEXT FROM Cur INTO @IdArticuloConjunto,
                                @IdUnidadConjunto, @CantidadConjunto
                        END
                    CLOSE Cur
                    DEALLOCATE Cur
                    DROP TABLE #Auxiliar2
                    SET NOCOUNT OFF
                END
        END

    UPDATE  [DetalleRemitos]
    SET     IdRemito = @IdRemito,
            NumeroItem = @NumeroItem,
            Cantidad = @Cantidad,
            IdUnidad = @IdUnidad,
            IdArticulo = @IdArticulo,
            Precio = @Precio,
            Observaciones = @Observaciones,
            PorcentajeCertificacion = @PorcentajeCertificacion,
            OrigenDescripcion = @OrigenDescripcion,
            IdDetalleOrdenCompra = @IdDetalleOrdenCompra,
            TipoCancelacion = @TipoCancelacion,
            IdUbicacion = @IdUbicacion,
            IdObra = @IdObra,
            Partida = @Partida,
            DescargaPorKit = @DescargaPorKit
    WHERE   ( IdDetalleRemito = @IdDetalleRemito )

    IF @@ERROR <> 0 
        GOTO AbortTransaction

    COMMIT TRAN
    GOTO EndTransaction

    AbortTransaction:
    ROLLBACK TRAN

    EndTransaction:
    RETURN ( @IdDetalleRemito )


GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_N]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wRequerimientos_N] @IdRequerimiento INT
AS 
    UPDATE  Requerimientos
    SET     Cumplido = 'AN'
    WHERE   IdRequerimiento = @IdRequerimiento
    UPDATE  DetalleRequerimientos
    SET     Cumplido = 'AN'
    WHERE   IdRequerimiento = @IdRequerimiento

GO
/****** Object:  StoredProcedure [dbo].[wSubrubros_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE PROCEDURE [dbo].[wSubrubros_TL]
AS 
SELECT IdSubrubro, Descripcion as [Titulo]
FROM Subrubros
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wOrdenesCompra_TX_DetallesPendientesDeFacturarPorIdCliente]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE wOrdenesCompra_TX_DetallesPendientesDeFacturarPorIdCliente @IdCliente INT
AS 
    SET NOCOUNT ON
    CREATE TABLE #Auxiliar1
        (
          IdDetalleOrdenCompra INTEGER,
          Pendiente NUMERIC(18, 2)
        )
    INSERT  INTO #Auxiliar1
            SELECT  doc.IdDetalleOrdenCompra,
                    CASE WHEN doc.TipoCancelacion = 1
                         THEN doc.Cantidad
                              - ISNULL(( SELECT SUM(ISNULL(df.Cantidad, 0))
                                         FROM   DetalleFacturasOrdenesCompra dfoc
                                                LEFT OUTER JOIN DetalleFacturas df ON df.IdDetalleFactura = dfoc.IdDetalleFactura
                                                LEFT OUTER JOIN Facturas fa ON fa.IdFactura = df.IdFactura
                                         WHERE  dfoc.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                AND ( fa.Anulada IS NULL
                                                      OR fa.Anulada <> 'SI'
                                                    )
                                       ), 0)
                              + ISNULL(( SELECT SUM(ISNULL(dncoc.Cantidad, 0))
                                         FROM   DetalleNotasCreditoOrdenesCompra dncoc
                                                LEFT OUTER JOIN NotasCredito nc ON nc.IdNotaCredito = dncoc.IdNotaCredito
                                         WHERE  dncoc.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                AND ( nc.Anulada IS NULL
                                                      OR nc.Anulada <> 'SI'
                                                    )
                                       ), 0)
                         ELSE 100
                              - ISNULL(( SELECT SUM(ISNULL(df.PorcentajeCertificacion,
                                                           0))
                                         FROM   DetalleFacturasOrdenesCompra dfoc
                                                LEFT OUTER JOIN DetalleFacturas df ON df.IdDetalleFactura = dfoc.IdDetalleFactura
                                                LEFT OUTER JOIN Facturas fa ON fa.IdFactura = df.IdFactura
                                         WHERE  dfoc.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                AND ( fa.Anulada IS NULL
                                                      OR fa.Anulada <> 'SI'
                                                    )
                                       ), 0)
                              + ISNULL(( SELECT SUM(ISNULL(dncoc.PorcentajeCertificacion,
                                                           0))
                                         FROM   DetalleNotasCreditoOrdenesCompra dncoc
                                                LEFT OUTER JOIN NotasCredito nc ON nc.IdNotaCredito = dncoc.IdNotaCredito
                                         WHERE  dncoc.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                AND ( nc.Anulada IS NULL
                                                      OR nc.Anulada <> 'SI'
                                                    )
                                       ), 0)
                    END
            FROM    DetalleOrdenesCompra doc
                    LEFT OUTER JOIN OrdenesCompra ON doc.IdOrdenCompra = OrdenesCompra.IdOrdenCompra
            WHERE   OrdenesCompra.IdCliente = @IdCliente
                    AND ISNULL(OrdenesCompra.Anulada, 'NO') <> 'SI'
                    AND ISNULL(doc.Cumplido, 'NO') = 'NO'

    SET NOCOUNT OFF

    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30),
        @Entregado NUMERIC,
        @Pedido NUMERIC
    SET @vector_X = '01111111111111133'
    SET @vector_T = '03904HD0192209100'

    SELECT  0,
            OrdenesCompra.NumeroOrdenCompra AS [OCompra],
            doc.IdDetalleOrdenCompra,
            OrdenesCompra.NumeroOrdenCompraCliente AS [OC(Cli)],
            Obras.NumeroObra AS [Obra],
            doc.NumeroItem AS [Item],
            Articulos.Descripcion + ISNULL(' ' + Colores.Descripcion COLLATE Modern_Spanish_CI_AS,
                                           '') AS [Articulo],
            doc.Cantidad AS [Cant.],
            Unidades.Abreviatura AS [Unidad],
            doc.IdArticulo,
            doc.Precio AS [Precio],
            doc.PorcentajeBonificacion AS [% Bon],
            doc.Cantidad * doc.Precio * ( 1
                                          - ISNULL(doc.PorcentajeBonificacion,
                                                   0) / 100 ) AS [Importe],
            CASE WHEN doc.TipoCancelacion = 1 THEN #Auxiliar1.Pendiente
                 ELSE #Auxiliar1.Pendiente
            END AS [AFacturar],
            CASE WHEN doc.TipoCancelacion = 1
                 THEN CONVERT(VARCHAR, #Auxiliar1.Pendiente)
                 ELSE CONVERT(VARCHAR, #Auxiliar1.Pendiente) + ' %'
            END AS [Pendfacturar],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    DetalleOrdenesCompra doc
            LEFT OUTER JOIN OrdenesCompra ON doc.IdOrdenCompra = OrdenesCompra.IdOrdenCompra
            LEFT OUTER JOIN Articulos ON doc.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Unidades ON doc.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN Obras ON OrdenesCompra.IdObra = Obras.IdObra
            LEFT OUTER JOIN #Auxiliar1 ON doc.IdDetalleOrdenCompra = #Auxiliar1.IdDetalleOrdenCompra
            LEFT OUTER JOIN Colores ON doc.IdColor = Colores.IdColor
    WHERE   OrdenesCompra.IdCliente = @IdCliente
            AND ISNULL(OrdenesCompra.Anulada, '') <> 'SI'
            AND ISNULL(#Auxiliar1.Pendiente, 0) > 0
    DROP TABLE #Auxiliar1


GO
/****** Object:  StoredProcedure [dbo].[wProveedores_A]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wProveedores_A]
    @IdProveedor INT,
    @RazonSocial VARCHAR(50),
    @Direccion VARCHAR(50),
    @IdLocalidad SMALLINT,
    @CodigoPostal VARCHAR(30),
    @IdProvincia TINYINT,
    @IdPais INT,
    @Telefono1 VARCHAR(50),
    @Telefono2 VARCHAR(50),
    @Fax VARCHAR(50),
    @Email VARCHAR(50),
    @Cuit VARCHAR(13),
    @IdCodigoIva TINYINT,
    @FechaAlta DATETIME,
    @FechaUltimaCompra DATETIME,
    @Excencion NUMERIC(6, 2),
    @IdCondicionCompra INT,
    @Contacto VARCHAR(50),
    @IdActividad INT,
    @Nif VARCHAR(30),
    @IdEstado INT,
    @EstadoFecha DATETIME,
    @EstadoUsuario VARCHAR(20),
    @AltaUsuario VARCHAR(20),
    @CodigoEmpresa VARCHAR(20),
    @Nombre1 VARCHAR(100),
    @Nombre2 VARCHAR(100),
    @NombreFantasia VARCHAR(50),
    @IGCondicion INT,
    @IGCertificadoAutoretencion VARCHAR(2),
    @IGCertificadoNORetencion VARCHAR(2),
    @IGFechaCaducidadExencion DATETIME,
    @IGPorcentajeNORetencion NUMERIC(6, 2),
    @IvaAgenteRetencion VARCHAR(2),
    @IvaExencionRetencion VARCHAR(2),
    @IvaFechaCaducidadExencion DATETIME,
    @IvaPorcentajeExencion NUMERIC(6, 2),
    @IBNumeroInscripcion VARCHAR(20),
    @IBCondicion INT,
    @IBFechaCaducidadExencion DATETIME,
    @IBPorcentajeExencion NUMERIC(6, 2),
    @SSFechaCaducidadExencion DATETIME,
    @SSPorcentajeExcencion NUMERIC(6, 2),
    @PaginaWeb VARCHAR(50),
    @Habitual VARCHAR(2),
    @Observaciones NTEXT,
    @Saldo NUMERIC(18, 2),
    @CodigoProveedor INT,
    @IdCuenta INT,
    @IdMoneda INT,
    @LimiteCredito NUMERIC(18, 2),
    @TipoProveedor INT,
    @Eventual VARCHAR(2),
    @IdTipoRetencionGanancia INT,
    @Confirmado VARCHAR(2),
    @CodigoPresto VARCHAR(13),
    @BienesOServicios VARCHAR(1),
    @IdIBCondicionPorDefecto INT,
    @RetenerSUSS VARCHAR(2),
    @ChequesALaOrdenDe VARCHAR(50),
    @FechaLimiteExentoGanancias DATETIME,
    @FechaLimiteExentoIIBB DATETIME,
    @IdImpuestoDirectoSUSS INT,
    @Importaciones_NumeroInscripcion VARCHAR(20),
    @Importaciones_DenominacionInscripcion VARCHAR(10),
    @EnviarEmail TINYINT,
    @InformacionAuxiliar VARCHAR(50),
    @CoeficienteIIBBUnificado NUMERIC(6, 2),
    @FechaUltimaPresentacionDocumentacion DATETIME,
    @ObservacionesPresentacionDocumentacion NTEXT,
    @FechaLimiteCondicionIVA DATETIME,
    @CodigoSituacionRetencionIVA VARCHAR(1),
    @SUSSFechaCaducidadExencion DATETIME,
    @Calificacion INT,
    @IdUsuarioIngreso INT,
    @FechaIngreso DATETIME,
    @IdUsuarioModifico INT,
    @FechaModifico DATETIME,
    @Exterior VARCHAR(2),
    @SujetoEmbargado VARCHAR(2),
    @SaldoEmbargo NUMERIC(18, 2),
    @DetalleEmbargo VARCHAR(50),
    @PorcentajeIBDirecto NUMERIC(6, 2),
    @FechaInicioVigenciaIBDirecto DATETIME,
    @FechaFinVigenciaIBDirecto DATETIME,
    @GrupoIIBB INT
AS 
    IF ISNULL(@IdProveedor, 0) <= 0 
        BEGIN
            INSERT  INTO Proveedores
                    (
                      RazonSocial,
                      Direccion,
                      IdLocalidad,
                      CodigoPostal,
                      IdProvincia,
                      IdPais,
                      Telefono1,
                      Telefono2,
                      Fax,
                      Email,
                      Cuit,
                      IdCodigoIva,
                      FechaAlta,
                      FechaUltimaCompra,
                      Excencion,
                      IdCondicionCompra,
                      Contacto,
                      IdActividad,
                      Nif,
                      IdEstado,
                      EstadoFecha,
                      EstadoUsuario,
                      AltaUsuario,
                      CodigoEmpresa,
                      Nombre1,
                      Nombre2,
                      NombreFantasia,
                      IGCondicion,
                      IGCertificadoAutoretencion,
                      IGCertificadoNORetencion,
                      IGFechaCaducidadExencion,
                      IGPorcentajeNORetencion,
                      IvaAgenteRetencion,
                      IvaExencionRetencion,
                      IvaFechaCaducidadExencion,
                      IvaPorcentajeExencion,
                      IBNumeroInscripcion,
                      IBCondicion,
                      IBFechaCaducidadExencion,
                      IBPorcentajeExencion,
                      SSFechaCaducidadExencion,
                      SSPorcentajeExcencion,
                      PaginaWeb,
                      Habitual,
                      Observaciones,
                      Saldo,
                      CodigoProveedor,
                      IdCuenta,
                      IdMoneda,
                      LimiteCredito,
                      TipoProveedor,
                      Eventual,
                      IdTipoRetencionGanancia,
                      Confirmado,
                      CodigoPresto,
                      BienesOServicios,
                      IdIBCondicionPorDefecto,
                      RetenerSUSS,
                      ChequesALaOrdenDe,
                      FechaLimiteExentoGanancias,
                      FechaLimiteExentoIIBB,
                      IdImpuestoDirectoSUSS,
                      Importaciones_NumeroInscripcion,
                      Importaciones_DenominacionInscripcion,
                      EnviarEmail,
                      InformacionAuxiliar,
                      CoeficienteIIBBUnificado,
                      FechaUltimaPresentacionDocumentacion,
                      ObservacionesPresentacionDocumentacion,
                      FechaLimiteCondicionIVA,
                      CodigoSituacionRetencionIVA,
                      SUSSFechaCaducidadExencion,
                      Calificacion,
                      IdUsuarioIngreso,
                      FechaIngreso,
                      IdUsuarioModifico,
                      FechaModifico,
                      Exterior,
                      SujetoEmbargado,
                      SaldoEmbargo,
                      DetalleEmbargo,
                      PorcentajeIBDirecto,
                      FechaInicioVigenciaIBDirecto,
                      FechaFinVigenciaIBDirecto,
                      GrupoIIBB
	              )
            VALUES  (
                      @RazonSocial,
                      @Direccion,
                      @IdLocalidad,
                      @CodigoPostal,
                      @IdProvincia,
                      @IdPais,
                      @Telefono1,
                      @Telefono2,
                      @Fax,
                      @Email,
                      @Cuit,
                      @IdCodigoIva,
                      @FechaAlta,
                      @FechaUltimaCompra,
                      @Excencion,
                      @IdCondicionCompra,
                      @Contacto,
                      @IdActividad,
                      @Nif,
                      @IdEstado,
                      @EstadoFecha,
                      @EstadoUsuario,
                      @AltaUsuario,
                      @CodigoEmpresa,
                      @Nombre1,
                      @Nombre2,
                      @NombreFantasia,
                      @IGCondicion,
                      @IGCertificadoAutoretencion,
                      @IGCertificadoNORetencion,
                      @IGFechaCaducidadExencion,
                      @IGPorcentajeNORetencion,
                      @IvaAgenteRetencion,
                      @IvaExencionRetencion,
                      @IvaFechaCaducidadExencion,
                      @IvaPorcentajeExencion,
                      @IBNumeroInscripcion,
                      @IBCondicion,
                      @IBFechaCaducidadExencion,
                      @IBPorcentajeExencion,
                      @SSFechaCaducidadExencion,
                      @SSPorcentajeExcencion,
                      @PaginaWeb,
                      @Habitual,
                      @Observaciones,
                      @Saldo,
                      @CodigoProveedor,
                      @IdCuenta,
                      @IdMoneda,
                      @LimiteCredito,
                      @TipoProveedor,
                      @Eventual,
                      @IdTipoRetencionGanancia,
                      @Confirmado,
                      @CodigoPresto,
                      @BienesOServicios,
                      @IdIBCondicionPorDefecto,
                      @RetenerSUSS,
                      @ChequesALaOrdenDe,
                      @FechaLimiteExentoGanancias,
                      @FechaLimiteExentoIIBB,
                      @IdImpuestoDirectoSUSS,
                      @Importaciones_NumeroInscripcion,
                      @Importaciones_DenominacionInscripcion,
                      @EnviarEmail,
                      @InformacionAuxiliar,
                      @CoeficienteIIBBUnificado,
                      @FechaUltimaPresentacionDocumentacion,
                      @ObservacionesPresentacionDocumentacion,
                      @FechaLimiteCondicionIVA,
                      @CodigoSituacionRetencionIVA,
                      @SUSSFechaCaducidadExencion,
                      @Calificacion,
                      @IdUsuarioIngreso,
                      @FechaIngreso,
                      @IdUsuarioModifico,
                      @FechaModifico,
                      @Exterior,
                      @SujetoEmbargado,
                      @SaldoEmbargo,
                      @DetalleEmbargo,
                      @PorcentajeIBDirecto,
                      @FechaInicioVigenciaIBDirecto,
                      @FechaFinVigenciaIBDirecto,
                      @GrupoIIBB
	              )
            SELECT  @IdProveedor = @@identity
        END
    ELSE 
        BEGIN
            UPDATE  Proveedores
            SET     RazonSocial = @RazonSocial,
                    Direccion = @Direccion,
                    IdLocalidad = @IdLocalidad,
                    CodigoPostal = @CodigoPostal,
                    IdProvincia = @IdProvincia,
                    IdPais = @IdPais,
                    Telefono1 = @Telefono1,
                    Telefono2 = @Telefono2,
                    Fax = @Fax,
                    Email = @Email,
                    Cuit = @Cuit,
                    IdCodigoIva = @IdCodigoIva,
                    FechaAlta = @FechaAlta,
                    FechaUltimaCompra = @FechaUltimaCompra,
                    Excencion = @Excencion,
                    IdCondicionCompra = @IdCondicionCompra,
                    Contacto = @Contacto,
                    IdActividad = @IdActividad,
                    Nif = @Nif,
                    IdEstado = @IdEstado,
                    EstadoFecha = @EstadoFecha,
                    EstadoUsuario = @EstadoUsuario,
                    AltaUsuario = @AltaUsuario,
                    CodigoEmpresa = @CodigoEmpresa,
                    Nombre1 = @Nombre1,
                    Nombre2 = @Nombre2,
                    NombreFantasia = @NombreFantasia,
                    IGCondicion = @IGCondicion,
                    IGCertificadoAutoretencion = @IGCertificadoAutoretencion,
                    IGCertificadoNORetencion = @IGCertificadoNORetencion,
                    IGFechaCaducidadExencion = @IGFechaCaducidadExencion,
                    IGPorcentajeNORetencion = @IGPorcentajeNORetencion,
                    IvaAgenteRetencion = @IvaAgenteRetencion,
                    IvaExencionRetencion = @IvaExencionRetencion,
                    IvaFechaCaducidadExencion = @IvaFechaCaducidadExencion,
                    IvaPorcentajeExencion = @IvaPorcentajeExencion,
                    IBNumeroInscripcion = @IBNumeroInscripcion,
                    IBCondicion = @IBCondicion,
                    IBFechaCaducidadExencion = @IBFechaCaducidadExencion,
                    IBPorcentajeExencion = @IBPorcentajeExencion,
                    SSFechaCaducidadExencion = @SSFechaCaducidadExencion,
                    SSPorcentajeExcencion = @SSPorcentajeExcencion,
                    PaginaWeb = @PaginaWeb,
                    Habitual = @Habitual,
                    Observaciones = @Observaciones,
                    Saldo = @Saldo,
                    CodigoProveedor = @CodigoProveedor,
                    IdCuenta = @IdCuenta,
                    IdMoneda = @IdMoneda,
                    LimiteCredito = @LimiteCredito,
                    TipoProveedor = @TipoProveedor,
                    Eventual = @Eventual,
                    IdTipoRetencionGanancia = @IdTipoRetencionGanancia,
                    Confirmado = @Confirmado,
                    CodigoPresto = @CodigoPresto,
                    BienesOServicios = @BienesOServicios,
                    IdIBCondicionPorDefecto = @IdIBCondicionPorDefecto,
                    RetenerSUSS = @RetenerSUSS,
                    ChequesALaOrdenDe = @ChequesALaOrdenDe,
                    FechaLimiteExentoGanancias = @FechaLimiteExentoGanancias,
                    FechaLimiteExentoIIBB = @FechaLimiteExentoIIBB,
                    IdImpuestoDirectoSUSS = @IdImpuestoDirectoSUSS,
                    Importaciones_NumeroInscripcion = @Importaciones_NumeroInscripcion,
                    Importaciones_DenominacionInscripcion = @Importaciones_DenominacionInscripcion,
                    EnviarEmail = @EnviarEmail,
                    InformacionAuxiliar = @InformacionAuxiliar,
                    CoeficienteIIBBUnificado = @CoeficienteIIBBUnificado,
                    FechaUltimaPresentacionDocumentacion = @FechaUltimaPresentacionDocumentacion,
                    ObservacionesPresentacionDocumentacion = @ObservacionesPresentacionDocumentacion,
                    FechaLimiteCondicionIVA = @FechaLimiteCondicionIVA,
                    CodigoSituacionRetencionIVA = @CodigoSituacionRetencionIVA,
                    SUSSFechaCaducidadExencion = @SUSSFechaCaducidadExencion,
                    Calificacion = @Calificacion,
                    IdUsuarioIngreso = @IdUsuarioIngreso,
                    FechaIngreso = @FechaIngreso,
                    IdUsuarioModifico = @IdUsuarioModifico,
                    FechaModifico = @FechaModifico,
                    Exterior = @Exterior,
                    SujetoEmbargado = @SujetoEmbargado,
                    SaldoEmbargo = @SaldoEmbargo,
                    DetalleEmbargo = @DetalleEmbargo,
                    PorcentajeIBDirecto = @PorcentajeIBDirecto,
                    FechaInicioVigenciaIBDirecto = @FechaInicioVigenciaIBDirecto,
                    FechaFinVigenciaIBDirecto = @FechaFinVigenciaIBDirecto,
                    GrupoIIBB = @GrupoIIBB
            WHERE   ( IdProveedor = @IdProveedor )
        END

    IF @@ERROR <> 0 
        RETURN -1
    ELSE 
        RETURN @IdProveedor


GO
/****** Object:  StoredProcedure [dbo].[wTablasGenerales_ParaCombo]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wTablasGenerales_ParaCombo]

@Tabla varchar(50)

AS 

IF @Tabla='DescripcionIva'
	SELECT IdCodigoIva, Descripcion as [Titulo]
	FROM DescripcionIva 
	ORDER BY Descripcion

IF @Tabla='TiposComprobante'
	SELECT IdTipoComprobante, Descripcion as [Titulo]
	FROM TiposComprobante 
	ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wRemitos_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE wRemitos_TT
AS 
    SET NOCOUNT ON

--esto tarda banda. lo saqué para que prontoweb no llegara al timeout
/*
CREATE TABLE #Auxiliar1 
			(
			 IdRemito INTEGER,
			 Obras VARCHAR(100)
			)

CREATE TABLE #Auxiliar2 
			(
			 IdRemito INTEGER,
			 NumeroObra VARCHAR(13)
			)
INSERT INTO #Auxiliar2 
 SELECT Det.IdRemito, Obras.NumeroObra
 FROM DetalleRemitos Det
 LEFT OUTER JOIN Remitos ON Det.IdRemito = Remitos.IdRemito
 LEFT OUTER JOIN Obras ON Det.IdObra = Obras.IdObra

CREATE NONCLUSTERED INDEX IX__Auxiliar2 ON #Auxiliar2 (IdRemito,NumeroObra) ON [PRIMARY]

INSERT INTO #Auxiliar1
 SELECT IdRemito, ''
 FROM #Auxiliar2
 GROUP BY IdRemito


DECLARE @IdRemito int, @NumeroObra varchar(13), @Obras varchar(100), @Corte int
SET @Corte=0
SET @Obras=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRemito, NumeroObra
		FROM #Auxiliar2
		ORDER BY IdRemito
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRemito, @NumeroObra
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRemito
	   BEGIN
		IF @Corte<>0
			UPDATE #Auxiliar1
			SET Obras = SUBSTRING(@Obras,1,100)
			WHERE #Auxiliar1.IdRemito=@Corte
		SET @Obras=''
		SET @Corte=@IdRemito
	   END
	IF NOT @NumeroObra IS NULL
		IF PATINDEX('%'+CONVERT(VARCHAR,@NumeroObra)+' '+'%', @Obras)=0
			SET @Obras=@Obras+@NumeroObra+' '
	FETCH NEXT FROM Cur INTO @IdRemito, @NumeroObra
   END
 IF @Corte<>0
    BEGIN
	UPDATE #Auxiliar1
	SET Obras = SUBSTRING(@Obras,1,100)
	WHERE #Auxiliar1.IdRemito=@Corte
    END
CLOSE Cur
DEALLOCATE Cur

CREATE TABLE #Auxiliar3 
			(
			 IdRemito INTEGER,
			 OCompras VARCHAR(500)
			)

CREATE TABLE #Auxiliar4 
			(
			 IdRemito INTEGER,
			 OCompra VARCHAR(8)
			)
INSERT INTO #Auxiliar4 
 SELECT Det.IdRemito, 
	Substring('00000000',1,8-Len(Convert(varchar,OrdenesCompra.NumeroOrdenCompra)))+
		Convert(varchar,OrdenesCompra.NumeroOrdenCompra)
 FROM DetalleRemitos Det
 LEFT OUTER JOIN Remitos ON Det.IdRemito = Remitos.IdRemito
 LEFT OUTER JOIN DetalleOrdenesCompra ON Det.IdDetalleOrdenCompra = DetalleOrdenesCompra.IdDetalleOrdenCompra
 LEFT OUTER JOIN OrdenesCompra ON DetalleOrdenesCompra.IdOrdenCompra = OrdenesCompra.IdOrdenCompra

CREATE NONCLUSTERED INDEX IX__Auxiliar4 ON #Auxiliar4 (IdRemito,OCompra) ON [PRIMARY]

INSERT INTO #Auxiliar3 
 SELECT IdRemito, ''
 FROM #Auxiliar4
 GROUP BY IdRemito


DECLARE @OCompra varchar(8), @P varchar(500)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRemito, OCompra
		FROM #Auxiliar4
		ORDER BY IdRemito
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRemito, @OCompra
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRemito
	   BEGIN
		IF @Corte<>0
			UPDATE #Auxiliar3
			SET OCompras = SUBSTRING(@P,1,500)
			WHERE IdRemito=@Corte
		SET @P=''
		SET @Corte=@IdRemito
	   END
	IF NOT @OCompra IS NULL
		IF PATINDEX('%'+@OCompra+' '+'%', @P)=0
			SET @P=@P+@OCompra+' '
	FETCH NEXT FROM Cur INTO @IdRemito, @OCompra
   END
   IF @Corte<>0
	UPDATE #Auxiliar3
	SET OCompras = SUBSTRING(@P,1,500)
	WHERE IdRemito=@Corte
CLOSE Cur
DEALLOCATE Cur

CREATE TABLE #Auxiliar5 
			(
			 IdRemito INTEGER,
			 Facturas VARCHAR(500)
			)

CREATE TABLE #Auxiliar6 
			(
			 IdRemito INTEGER,
			 Factura VARCHAR(15)
			)
INSERT INTO #Auxiliar6 
 SELECT Det.IdRemito, 
	Facturas.TipoABC+'-'+
	Substring('0000',1,4-Len(Convert(varchar,IsNull(Facturas.PuntoVenta,0))))+
		Convert(varchar,IsNull(Facturas.PuntoVenta,0))+'-'+
	Substring('00000000',1,8-Len(Convert(varchar,Facturas.NumeroFactura)))+
		Convert(varchar,Facturas.NumeroFactura)
 FROM DetalleRemitos Det
 LEFT OUTER JOIN Remitos ON Det.IdRemito = Remitos.IdRemito
 LEFT OUTER JOIN DetalleFacturasRemitos ON Det.IdDetalleRemito = DetalleFacturasRemitos.IdDetalleRemito
 LEFT OUTER JOIN Facturas ON DetalleFacturasRemitos.IdFactura = Facturas.IdFactura

CREATE NONCLUSTERED INDEX IX__Auxiliar6 ON #Auxiliar6 (IdRemito,Factura) ON [PRIMARY]

INSERT INTO #Auxiliar5 
 SELECT IdRemito, ''
 FROM #Auxiliar6
 GROUP BY IdRemito

DECLARE @Factura varchar(15)
SET @Corte=0
SET @P=''
DECLARE Cur CURSOR LOCAL FORWARD_ONLY 
	FOR	SELECT IdRemito, Factura
		FROM #Auxiliar6
		ORDER BY IdRemito
OPEN Cur
FETCH NEXT FROM Cur INTO @IdRemito, @Factura
WHILE @@FETCH_STATUS = 0
   BEGIN
	IF @Corte<>@IdRemito
	   BEGIN
		IF @Corte<>0
			UPDATE #Auxiliar5
			SET Facturas = SUBSTRING(@P,1,500)
			WHERE IdRemito=@Corte
		SET @P=''
		SET @Corte=@IdRemito
	   END
	IF NOT @Factura IS NULL
		IF PATINDEX('%'+@Factura+' '+'%', @P)=0
			SET @P=@P+@Factura+' '
	FETCH NEXT FROM Cur INTO @IdRemito, @Factura
   END
   IF @Corte<>0
	UPDATE #Auxiliar5
	SET Facturas = SUBSTRING(@P,1,500)
	WHERE IdRemito=@Corte
CLOSE Cur
DEALLOCATE Cur
*/

    SET NOCOUNT OFF

    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30)
    SET @vector_X = '0111111111111111533'
    SET @vector_T = '0E94122EBB432225300'

    SELECT  Remitos.IdRemito,
            SUBSTRING('0000', 1,
                      4 - LEN(CONVERT(VARCHAR, ISNULL(Remitos.PuntoVenta, 0))))
            + CONVERT(VARCHAR, ISNULL(Remitos.PuntoVenta, 0)) + '-'
            + SUBSTRING('00000000', 1,
                        8 - LEN(CONVERT(VARCHAR, Remitos.NumeroRemito)))
            + CONVERT(VARCHAR, Remitos.NumeroRemito) AS [Remito],
            Remitos.IdRemito AS [IdAux],
            Remitos.FechaRemito [Fecha],
            Remitos.Anulado AS [Anulado],
            Clientes.RazonSocial AS [Cliente],
            Proveedores.RazonSocial AS [Proveedor],
 --#Auxiliar1.Obras as [Obras],
 --#Auxiliar3.OCompras as [Ordenes de compra],
 --#Auxiliar5.Facturas as [Facturas],
            CASE WHEN Remitos.Destino = 1 THEN 'A facturar'
                 WHEN Remitos.Destino = 2 THEN 'A proveedor p/fabricar'
                 WHEN Remitos.Destino = 3 THEN 'Con cargo devolucion'
                 WHEN Remitos.Destino = 4 THEN 'Muestra'
                 WHEN Remitos.Destino = 5 THEN 'A prestamo'
                 WHEN Remitos.Destino = 6 THEN 'Traslado'
                 ELSE ''
            END AS [Tipo de remito],
            cc.Descripcion AS [Condicion de venta],
            Transportistas.RazonSocial AS [Transportista],
            Remitos.TotalBultos AS [Bultos],
            Remitos.ValorDeclarado AS [Valor decl.],
            ( SELECT    COUNT(*)
              FROM      DetalleRemitos
              WHERE     DetalleRemitos.IdRemito = Remitos.IdRemito
            ) AS [Cant.Items],
            Remitos.Observaciones,
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    Remitos
            LEFT OUTER JOIN Clientes ON Remitos.IdCliente = Clientes.IdCliente
            LEFT OUTER JOIN Proveedores ON Remitos.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Transportistas ON Remitos.IdTransportista = Transportistas.IdTransportista
            LEFT OUTER JOIN [Condiciones Compra] cc ON Remitos.IdCondicionVenta = cc.IdCondicionCompra
--LEFT OUTER JOIN #Auxiliar1 ON Remitos.IdRemito=#Auxiliar1.IdRemito
--LEFT OUTER JOIN #Auxiliar3 ON Remitos.IdRemito=#Auxiliar3.IdRemito
--LEFT OUTER JOIN #Auxiliar5 ON Remitos.IdRemito=#Auxiliar5.IdRemito
    ORDER BY Remitos.NumeroRemito

--DROP TABLE #Auxiliar1
--DROP TABLE #Auxiliar2
--DROP TABLE #Auxiliar3
--DROP TABLE #Auxiliar4
--DROP TABLE #Auxiliar5
--DROP TABLE #Auxiliar6


GO
/****** Object:  StoredProcedure [dbo].[wProveedores_E]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wProveedores_E] @IdProveedor INT
AS 
    DELETE  Proveedores
    WHERE   ( IdProveedor = @IdProveedor )


GO
/****** Object:  StoredProcedure [dbo].[wOrdenesCompra_TX_ItemsPendientesDeRemitirPorIdCliente]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wOrdenesCompra_TX_ItemsPendientesDeRemitirPorIdCliente @IdCliente INT
AS 
    DECLARE @vector_X VARCHAR(30),
        @vector_T VARCHAR(30)
    SET @vector_X = '00111111111111133'
    SET @vector_T = '00641010022205100'

    SELECT  doc.IdDetalleOrdenCompra,
            doc.IdOrdenCompra,
            OrdenesCompra.NumeroOrdenCompra AS [Orden de compra],
            OrdenesCompra.FechaOrdenCompra [Fecha],
            Clientes.RazonSocial AS [Cliente],
            doc.NumeroItem AS [Item],
            Articulos.Descripcion AS [Articulo],
            doc.Cantidad AS [Cant.],
            Unidades.Descripcion AS [Unidad],
            doc.Precio AS [Precio],
            doc.Cantidad * doc.Precio * ( 1
                                          - ISNULL(doc.PorcentajeBonificacion,
                                                   0) / 100 ) AS [Importe],
            CASE WHEN doc.TipoCancelacion = 1
                 THEN CONVERT(VARCHAR, ISNULL(( SELECT  SUM(ISNULL(drm.Cantidad, 0))
                                                FROM    DetalleRemitos drm
                                                        LEFT OUTER JOIN Remitos ON drm.IdRemito = Remitos.IdRemito
                                                WHERE   drm.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                        AND ( Remitos.Anulado IS NULL
                                                              OR Remitos.Anulado <> 'SI'
                                                            )
                                              ), 0))
                 ELSE CONVERT(VARCHAR, ISNULL(( SELECT  SUM(ISNULL(drm.PorcentajeCertificacion, 0))
                                                FROM    DetalleRemitos drm
                                                        LEFT OUTER JOIN Remitos ON drm.IdRemito = Remitos.IdRemito
                                                WHERE   drm.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                                        AND ( Remitos.Anulado IS NULL
                                                              OR Remitos.Anulado <> 'SI'
                                                            )
                                              ), 0)) + ' %'
            END AS [Remitido],
            CASE WHEN doc.TipoCancelacion = 1
                 THEN CONVERT(VARCHAR, doc.Cantidad
                      - ISNULL(( SELECT SUM(ISNULL(drm.Cantidad, 0))
                                 FROM   DetalleRemitos drm
                                        LEFT OUTER JOIN Remitos ON drm.IdRemito = Remitos.IdRemito
                                 WHERE  drm.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                        AND ( Remitos.Anulado IS NULL
                                              OR Remitos.Anulado <> 'SI'
                                            )
                               ), 0))
                 ELSE CONVERT(VARCHAR, 100
                      - ISNULL(( SELECT SUM(ISNULL(drm.PorcentajeCertificacion,
                                                   0))
                                 FROM   DetalleRemitos drm
                                        LEFT OUTER JOIN Remitos ON drm.IdRemito = Remitos.IdRemito
                                 WHERE  drm.IdDetalleOrdenCompra = doc.IdDetalleOrdenCompra
                                        AND ( Remitos.Anulado IS NULL
                                              OR Remitos.Anulado <> 'SI'
                                            )
                               ), 0)) + ' %'
            END AS [Pend.remitir],
            doc.Observaciones,
            doc.PorcentajeBonificacion AS [% Bon],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    DetalleOrdenesCompra doc
            LEFT OUTER JOIN OrdenesCompra ON doc.IdOrdenCompra = OrdenesCompra.IdOrdenCompra
            LEFT OUTER JOIN Clientes ON OrdenesCompra.IdCliente = Clientes.IdCliente
            LEFT OUTER JOIN Articulos ON doc.IdArticulo = Articulos.IdArticulo
            LEFT OUTER JOIN Unidades ON doc.IdUnidad = Unidades.IdUnidad
    WHERE   ISNULL(OrdenesCompra.Anulada, '') <> 'SI'
            AND ( OrdenesCompra.IdCliente = @IdCliente
                  OR @idcliente = -1
                )


GO
/****** Object:  StoredProcedure [dbo].[wProveedores_T]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE  PROCEDURE [dbo].[wProveedores_T]
    @IdProveedor INT = NULL
AS 
    SET @IdProveedor = ISNULL(@IdProveedor, -1)

    SELECT  Proveedores.*,
            Localidades.Nombre AS [Localidad],
            Provincias.Nombre AS [Provincia],
            Provincias.PlantillaRetencionIIBB,
            Paises.Descripcion AS [Pais],
            DescripcionIva.Descripcion AS [CondicionIVA],
            [Estados Proveedores].Descripcion AS [Estado],
            [Actividades Proveedores].Descripcion AS [Actividad],
            [Condiciones Compra].Descripcion AS [CondicionCompra],
            CASE WHEN IGCondicion IS NULL
                      OR IGCondicion = 1 THEN NULL
                 ELSE TiposRetencionGanancia.Descripcion
            END AS [CategoriaGanancias],
            CASE WHEN ISNULL(Proveedores.IBCondicion, 1) = 1 THEN 'Exento'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 2 THEN 'Conv.Mult.'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 3
                 THEN 'Juris.Local'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 4
                 THEN 'No alcanzado'
                 ELSE NULL
            END AS [SituacionIIBB],
            IBCondiciones.Descripcion AS [CategoriaIIBB],
            Cuentas.Descripcion AS [CuentaContable],
            Monedas.Abreviatura AS [MonedaHabitual],
            ImpuestosDirectos.Descripcion AS [ImpuestoDirectoSUSS],
            E1.Nombre AS [UsuarioIngreso],
            E2.Nombre AS [UsuarioModifico]
    FROM    Proveedores
            LEFT OUTER JOIN DescripcionIva ON Proveedores.IdCodigoIva = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Localidades ON Proveedores.IdLocalidad = Localidades.IdLocalidad
            LEFT OUTER JOIN Provincias ON Proveedores.IdProvincia = Provincias.IdProvincia
            LEFT OUTER JOIN Paises ON Proveedores.IdPais = Paises.IdPais
            LEFT OUTER JOIN [Estados Proveedores] ON Proveedores.IdEstado = [Estados Proveedores].IdEstado
            LEFT OUTER JOIN [Actividades Proveedores] ON Proveedores.IdActividad = [Actividades Proveedores].IdActividad
            LEFT OUTER JOIN [Condiciones Compra] ON Proveedores.IdCondicionCompra = [Condiciones Compra].IdCondicionCompra
            LEFT OUTER JOIN TiposRetencionGanancia ON Proveedores.IdTipoRetencionGanancia = TiposRetencionGanancia.IdTipoRetencionGanancia
            LEFT OUTER JOIN Cuentas ON Proveedores.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN IBCondiciones ON Proveedores.IdIBCondicionPorDefecto = IBCondiciones.IdIBCondicion
            LEFT OUTER JOIN Monedas ON Proveedores.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN ImpuestosDirectos ON Proveedores.IdImpuestoDirectoSUSS = ImpuestosDirectos.IdImpuestoDirecto
            LEFT OUTER JOIN Empleados E1 ON Proveedores.IdUsuarioIngreso = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Proveedores.IdUsuarioModifico = E2.IdEmpleado
    WHERE   ( @IdProveedor = -1
              OR IdProveedor = @IdProveedor
            ) 
--and IsNull(Eventual,'NO')<>'SI'
    ORDER BY Proveedores.RazonSocial

GO
/****** Object:  StoredProcedure [dbo].[wTiposRetencionGanancia_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO


CREATE Procedure [dbo].[wTiposRetencionGanancia_TL]
AS 
SELECT IdTipoRetencionGanancia, Descripcion as [Titulo]
FROM TiposRetencionGanancia 
ORDER BY Descripcion



GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TX_Busqueda]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].[wProveedores_TX_Busqueda] @Busqueda VARCHAR(100)
AS 
    SELECT  Proveedores.*,
            Localidades.Nombre AS [Localidad],
            Provincias.Nombre AS [Provincia],
            Provincias.PlantillaRetencionIIBB,
            Paises.Descripcion AS [Pais],
            DescripcionIva.Descripcion AS [CondicionIVA],
            [Estados Proveedores].Descripcion AS [Estado],
            [Actividades Proveedores].Descripcion AS [Actividad],
            [Condiciones Compra].Descripcion AS [CondicionCompra],
            CASE WHEN IGCondicion IS NULL
                      OR IGCondicion = 1 THEN NULL
                 ELSE TiposRetencionGanancia.Descripcion
            END AS [CategoriaGanancias],
            CASE WHEN ISNULL(Proveedores.IBCondicion, 1) = 1 THEN 'Exento'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 2 THEN 'Conv.Mult.'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 3
                 THEN 'Juris.Local'
                 WHEN ISNULL(Proveedores.IBCondicion, 1) = 4
                 THEN 'No alcanzado'
                 ELSE NULL
            END AS [SituacionIIBB],
            IBCondiciones.Descripcion AS [CategoriaIIBB],
            Cuentas.Descripcion AS [CuentaContable],
            Monedas.Abreviatura AS [MonedaHabitual],
            ImpuestosDirectos.Descripcion AS [ImpuestoDirectoSUSS],
            E1.Nombre AS [UsuarioIngreso],
            E2.Nombre AS [UsuarioModifico]
    FROM    Proveedores
            LEFT OUTER JOIN DescripcionIva ON Proveedores.IdCodigoIva = DescripcionIva.IdCodigoIva
            LEFT OUTER JOIN Localidades ON Proveedores.IdLocalidad = Localidades.IdLocalidad
            LEFT OUTER JOIN Provincias ON Proveedores.IdProvincia = Provincias.IdProvincia
            LEFT OUTER JOIN Paises ON Proveedores.IdPais = Paises.IdPais
            LEFT OUTER JOIN [Estados Proveedores] ON Proveedores.IdEstado = [Estados Proveedores].IdEstado
            LEFT OUTER JOIN [Actividades Proveedores] ON Proveedores.IdActividad = [Actividades Proveedores].IdActividad
            LEFT OUTER JOIN [Condiciones Compra] ON Proveedores.IdCondicionCompra = [Condiciones Compra].IdCondicionCompra
            LEFT OUTER JOIN TiposRetencionGanancia ON Proveedores.IdTipoRetencionGanancia = TiposRetencionGanancia.IdTipoRetencionGanancia
            LEFT OUTER JOIN Cuentas ON Proveedores.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN IBCondiciones ON Proveedores.IdIBCondicionPorDefecto = IBCondiciones.IdIBCondicion
            LEFT OUTER JOIN Monedas ON Proveedores.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN ImpuestosDirectos ON Proveedores.IdImpuestoDirectoSUSS = ImpuestosDirectos.IdImpuestoDirecto
            LEFT OUTER JOIN Empleados E1 ON Proveedores.IdUsuarioIngreso = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Proveedores.IdUsuarioModifico = E2.IdEmpleado
    WHERE   --IsNull(Eventual,'NO')<>'SI' and  --por qué saqué el filtro de eventuales?
            ISNULL(Confirmado, 'NO') <> 'NO'
            AND Proveedores.RazonSocial LIKE @Busqueda + '%'
--Proveedores.RazonSocial like '%'+@Busqueda+'%'
    ORDER BY Proveedores.RazonSocial

GO
/****** Object:  StoredProcedure [dbo].[wAnticiposAlPersonal_TX_Asiento]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[wAnticiposAlPersonal_TX_Asiento]

@IdAsiento int

AS

declare @vector_X varchar(30),@vector_T varchar(30)
set @vector_X='011111133'
set @vector_T='022222500'

SELECT
 AP.IdAnticipoAlPersonal,
 Empleados.Legajo as [Legajo],
 Empleados.Nombre as [Nombre],
 Empleados.IdEmpleado,
 AP.Importe as [Importe],
 AP.CantidadCuotas as [Cuotas],
 AP.Detalle as [Detalle],
 Empleados.CuentaBancaria as [Cuenta banco],
 @Vector_T as Vector_T,
 @Vector_X as Vector_X
FROM AnticiposAlPersonal AP
LEFT OUTER JOIN Empleados ON AP.IdEmpleado = Empleados.IdEmpleado
WHERE (AP.IdAsiento = @IdAsiento)


GO
/****** Object:  StoredProcedure [dbo].[wArticulos_TX_Busqueda]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE  PROCEDURE [dbo].wArticulos_TX_Busqueda @Busqueda VARCHAR(100)
AS 
    SELECT TOP 100
            IdArticulo,
            Descripcion
    FROM    Articulos
    WHERE   ( Articulos.Descripcion LIKE '' + @Busqueda + '%' )
    ORDER BY Articulos.Descripcion

/*
SELECT TOP 250
Articulos.IdArticulo,

--METODO PARA BUSCAR TAMBIEN POR CODIGO
--(isnull(Articulos.Codigo,'') COLLATE SQL_Latin1_General_CP1_CI_AS+' '+
--	isnull(Articulos.Descripcion,'') COLLATE SQL_Latin1_General_CP1_CI_AS) as Descripcion,
Articulos.Descripcion, 
Articulos.IdCodigo, 
Articulos.Codigo,
Articulos.IdInventario,
Articulos.NumeroInventario,
Articulos.IdRubro,
Articulos.IdUnidad,
Articulos.AlicuotaIVA,
Articulos.CostoPPP,
Articulos.CostoPPPDolar,
Articulos.CostoReposicion,
Articulos.CostoReposicionDolar,
Articulos.Observaciones,
Articulos.IdSubrubro,
 Rubros.Descripcion as [Rubro],
 Subrubros.Descripcion as [Subrubro],
 (Select Sum(Stock.CantidadUnidades) From Stock 
	Where Stock.IdArticulo=Articulos.IdArticulo) as [Stock actual],
 (Select Top 1 Unidades.Abreviatura From Unidades 
	Where Articulos.IdUnidad=Unidades.IdUnidad) as [Un],
 IsNull(Depositos.Abreviatura,Depositos.Descripcion)+
	IsNull(', '+Ubicaciones.Descripcion,'')+
	IsNull(' - Est.:'+Ubicaciones.Estanteria,'')+
	IsNull(' - Mod.:'+Ubicaciones.Modulo,'')+
	IsNull(' - Gab.:'+Ubicaciones.Gabeta,'') as [Ubicacion],
 Unidades.Abreviatura as [Unidad]
FROM Articulos
LEFT OUTER JOIN Rubros ON Articulos.IdRubro = Rubros.IdRubro 
LEFT OUTER JOIN Subrubros ON Articulos.IdSubrubro = Subrubros.IdSubrubro 
LEFT OUTER JOIN Ubicaciones ON Articulos.IdUbicacionStandar = Ubicaciones.IdUbicacion
LEFT OUTER JOIN Depositos ON Ubicaciones.IdDeposito = Depositos.IdDeposito
LEFT OUTER JOIN Unidades ON Articulos.IdUnidad = Unidades.IdUnidad
WHERE IsNull(Articulos.Activo,'')<>'NO' 
--METODO PARA BUSCAR TAMBIEN POR CODIGO
--and (Articulos.Descripcion like '%'+@Busqueda+'%' or Articulos.Codigo like '%'+@Busqueda+'%') 
--ORDER BY Articulos.Codigo COLLATE SQL_Latin1_General_CP1_CI_AS + Articulos.Descripcion
and (Articulos.Descripcion like '%'+@Busqueda+'%') 
ORDER BY Articulos.Descripcion

*/


GO
/****** Object:  StoredProcedure [dbo].[wValores_TX_GastosPorIdConDatos]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS OFF
GO
SET QUOTED_IDENTIFIER OFF
GO

CREATE  Procedure [dbo].[wValores_TX_GastosPorIdConDatos]

@IdValor int

AS

SELECT 
 Valores.*,
 IsNull(Valores.Importe,0)-IsNull(Valores.Iva,0) as [Subtotal],
 TiposComprobante.Descripcion as [TipoComprobante], 
 Bancos.Nombre as [Banco],
 Monedas.Abreviatura as [Moneda],
 IsNull(Valores.Conciliado,'NO') as [Conciliado1],
 IsNull(Valores.MovimientoConfirmadoBanco,'NO') as [MovimientoConfirmadoBanco1],
 CuentasBancarias.Cuenta as [CuentaBancaria],
 Conciliaciones.Numero as [NumeroExtracto],
 Conciliaciones.FechaIngreso as [FechaExtracto],
 E1.Nombre as [Confecciono],
 E2.Nombre as [Modifico],
 Obras.NumeroObra as [NumeroObra],
 Obras.NumeroObra+' '+Obras.Descripcion as [Obra],
 Cuentas.Codigo as [CodigoCuentaIva],
 Cuentas.Descripcion as [CuentaIva]
FROM Valores 
LEFT OUTER JOIN CuentasBancarias ON Valores.IdCuentaBancaria=CuentasBancarias.IdCuentaBancaria
LEFT OUTER JOIN Bancos ON CuentasBancarias.IdBanco=Bancos.IdBanco
LEFT OUTER JOIN TiposComprobante ON Valores.IdTipoComprobante=TiposComprobante.IdTipoComprobante
LEFT OUTER JOIN Conciliaciones ON Valores.IdConciliacion=Conciliaciones.IdConciliacion
LEFT OUTER JOIN Monedas ON Valores.IdMoneda=Monedas.IdMoneda
LEFT OUTER JOIN Empleados E1 ON E1.IdEmpleado=Valores.IdUsuarioIngreso
LEFT OUTER JOIN Empleados E2 ON E2.IdEmpleado=Valores.IdUsuarioModifico
LEFT OUTER JOIN Obras ON Valores.IdObra=Obras.IdObra
LEFT OUTER JOIN Cuentas ON Cuentas.IdCuenta=Valores.IdCuentaIVA
WHERE Valores.IdValor=@IdValor

GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PendientesDeAsignacion]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRequerimientos_TX_PendientesDeAsignacion
AS 
    DECLARE @IdObraStockDisponible INT,
        @IdDepositoCentral INT,
        @FirmasLiberacion INT

    SET @IdObraStockDisponible = ISNULL(( SELECT TOP 1
                                                    P.IdObraStockDisponible
                                          FROM      Parametros P
                                          WHERE     P.IdParametro = 1
                                        ), 0)
    SET @IdDepositoCentral = ISNULL(( SELECT TOP 1
                                                P2.Valor
                                      FROM      Parametros2 P2
                                      WHERE     P2.Campo = 'IdDepositoCentral'
                                    ), -1)
    SET @FirmasLiberacion = ISNULL(( SELECT TOP 1
                                            CONVERT(INTEGER, Valor)
                                     FROM   Parametros2
                                     WHERE  Campo = 'AprobacionesRM'
                                   ), 1)

    DECLARE @vector_X VARCHAR(50),
        @vector_T VARCHAR(50)
    SET @vector_X = '011111111111111111111111133'
    SET @vector_T = '029999H101115511F4132135200'

    SELECT  DetReq.IdDetalleRequerimiento,
            Requerimientos.NumeroRequerimiento AS [Req.Nro.],
            DetReq.IdDetalleRequerimiento AS [IdAux1],
            DetReq.IdRequerimiento AS [IdAux2],
            ISNULL(Requerimientos.IdObra, LMateriales.IdObra) AS [IdAux3],
            DetReq.TipoDesignacion AS [IdAux4],
            DetReq.NumeroItem AS [Item],
            DetReq.Cantidad AS [Cant.],
            ISNULL(Unidades.Abreviatura, Unidades.Descripcion) AS [Unidad en],
            T.CantidadVales AS [Vales],
            T.CantidadPedida AS [Cant.Ped.],
            T.CantidadRecibida AS [Recibido],
            CASE WHEN DetReq.TipoDesignacion = 'REC'
                 THEN SUBSTRING(SUBSTRING('0000', 1,
                                          4
                                          - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                                + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)
                                + '-' + SUBSTRING('00000000', 1,
                                                  8
                                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                                + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)
                                + '/'
                                + CONVERT(VARCHAR, ISNULL(Recepciones.SubNumero,
                                                          0)), 1, 20)
                 ELSE NULL
            END AS [Recepcion],
            SUBSTRING(SUBSTRING('0000', 1,
                                4
                                - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion1)))
                      + CONVERT(VARCHAR, Recepciones.NumeroRecepcion1) + '-'
                      + SUBSTRING('00000000', 1,
                                  8
                                  - LEN(CONVERT(VARCHAR, Recepciones.NumeroRecepcion2)))
                      + CONVERT(VARCHAR, Recepciones.NumeroRecepcion2) + '/'
                      + CONVERT(VARCHAR, ISNULL(Recepciones.SubNumero, 0)), 1,
                      20) AS [Ult.Recepcion],
            T.CantidadEnStock AS [En stock],
            A1.StockMinimo AS [Stk.min.],
            A1.Descripcion AS Articulo,
            DetReq.FechaEntrega AS [F.entrega],
            E2.Nombre AS [Solicito],
            CASE WHEN ISNULL(Requerimientos.TipoRequerimiento, '') = 'OP'
                 THEN ISNULL(Requerimientos.TipoRequerimiento, '')
                      + CONVERT(VARCHAR, ISNULL(' - '
                                                + ( SELECT TOP 1
                                                            A.NumeroInventario
                                                    FROM    Articulos A
                                                    WHERE   DetReq.IdEquipoDestino = A.IdArticulo
                                                  ), ''))
                 WHEN ISNULL(Requerimientos.TipoRequerimiento, '') = 'OT'
                      OR ISNULL(Requerimientos.TipoRequerimiento, '') = 'ST'
                 THEN ISNULL(Requerimientos.TipoRequerimiento, '')
                      + CONVERT(VARCHAR, ISNULL(' - '
                                                + ( SELECT TOP 1
                                                            OT.NumeroOrdenTrabajo
                                                    FROM    OrdenesTrabajo OT
                                                    WHERE   Requerimientos.IdOrdenTrabajo = OT.IdOrdenTrabajo
                                                  ), ''))
                 ELSE ISNULL(Requerimientos.TipoRequerimiento, '')
            END AS [Tipo Req.],
            Obras.NumeroObra + ' ' + Obras.Descripcion AS [Obra],
            DetReq.Cumplido AS [Cump.],
            DetReq.Recepcionado AS [Recibido],
            DetReq.Observaciones AS [Observaciones item],
            Depositos.Descripcion AS [Deposito],
            @Vector_T AS Vector_T,
            @Vector_X AS Vector_X
    FROM    _Temp_Requerimientos_TX_PendientesDeAsignar T
            LEFT OUTER JOIN DetalleRequerimientos DetReq ON T.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
            LEFT OUTER JOIN Articulos A1 ON DetReq.IdArticulo = A1.IdArticulo
            LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
            LEFT OUTER JOIN DetalleLMateriales ON DetReq.IdDetalleLMateriales = DetalleLMateriales.IdDetalleLMateriales
            LEFT OUTER JOIN LMateriales ON DetalleLMateriales.IdLMateriales = LMateriales.IdLMateriales
            LEFT OUTER JOIN Empleados E1 ON DetReq.IdComprador = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Requerimientos.IdSolicito = E2.IdEmpleado
            LEFT OUTER JOIN Cuentas ON DetReq.IdCuenta = Cuentas.IdCuenta
            LEFT OUTER JOIN Unidades ON DetReq.IdUnidad = Unidades.IdUnidad
            LEFT OUTER JOIN Obras ON ISNULL(Requerimientos.IdObra,
                                            LMateriales.IdObra) = Obras.IdObra
            LEFT OUTER JOIN DetalleRecepciones DetRec ON T.IdDetalleRecepcion = DetRec.IdDetalleRecepcion
            LEFT OUTER JOIN Recepciones ON DetRec.IdRecepcion = Recepciones.IdRecepcion
            LEFT OUTER JOIN Ubicaciones ON DetRec.IdUbicacion = Ubicaciones.IdUbicacion
            LEFT OUTER JOIN Depositos ON Ubicaciones.IdDeposito = Depositos.IdDeposito
    WHERE   ( DetReq.TipoDesignacion IS NOT NULL
              AND ( DetReq.TipoDesignacion = 'S/D'
                    OR ( DetReq.TipoDesignacion = 'REC'
                         AND Requerimientos.IdObra <> @IdObraStockDisponible
                       )
                    OR ( DetReq.TipoDesignacion = 'STK'
                         AND DetReq.Cantidad > ISNULL(T.CantidadVales, 0)
                       )
                  )
            )
    ORDER BY Requerimientos.NumeroRequerimiento,
            DetReq.NumeroItem



GO
/****** Object:  StoredProcedure [dbo].[wProveedores_TL]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[wProveedores_TL]
AS 
    SELECT  IdProveedor,
            RazonSocial AS [Titulo]
    FROM    Proveedores
--WHERE IsNull(Eventual,'NO')='NO' and IsNull(Confirmado,'SI')='SI'
    ORDER BY RazonSocial

GO
/****** Object:  StoredProcedure [dbo].[wRequerimientos_TX_PendientesDeAsignacion_SubRecalculoRM]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE wRequerimientos_TX_PendientesDeAsignacion_SubRecalculoRM
AS 
    SET NOCOUNT ON


    DECLARE @Depositos VARCHAR(100)

--IF @Depositos is null or Len(@Depositos)=0
    SET @Depositos = '-1'

    DECLARE @IdObraStockDisponible INT,
        @IdDepositoCentral INT,
        @FirmasLiberacion INT

    SET @IdObraStockDisponible = ISNULL(( SELECT TOP 1
                                                    P.IdObraStockDisponible
                                          FROM      Parametros P
                                          WHERE     P.IdParametro = 1
                                        ), 0)
    SET @IdDepositoCentral = ISNULL(( SELECT TOP 1
                                                P2.Valor
                                      FROM      Parametros2 P2
                                      WHERE     P2.Campo = 'IdDepositoCentral'
                                    ), -1)
    SET @FirmasLiberacion = ISNULL(( SELECT TOP 1
                                            CONVERT(INTEGER, Valor)
                                     FROM   Parametros2
                                     WHERE  Campo = 'AprobacionesRM'
                                   ), 1)

--http://www.orafaq.com/forum/t/23267/2/
-- y si pongo un indice o algo?

/*
Use stacked queries instead of subqueries. Create a separate saved query for JET 
to execute first, and use it as an input "table" for your main query. This 
pre-processing is usually (but not always) faster than a subquery. Likewise, 
try performing aggregation in one query, and then create another query that operates 
on the aggregated results. This post-processing can be orders of magnitude faster 
than a query that tries to do everything in a single query with subqueries.
*/

    CREATE TABLE #Auxiliar1
        (
          IdDetalleRequerimiento INTEGER,
          CantidadPedida NUMERIC(18, 2),
          CantidadRecibida NUMERIC(18, 2),
          CantidadVales NUMERIC(18, 2),
          CantidadEnStock NUMERIC(18, 2),
          IdDetalleRecepcion INTEGER
        )
    CREATE TABLE #Auxiliar2
        (
          IdDetalleRequerimiento INTEGER,
          CantidadPedida NUMERIC(18, 2),
          CantidadRecibida NUMERIC(18, 2),
          CantidadVales NUMERIC(18, 2),
          CantidadEnStock NUMERIC(18, 2),
          IdDetalleRecepcion INTEGER
        )			
			
    INSERT  INTO #Auxiliar2
            SELECT  DetReq.IdDetalleRequerimiento,

--esta que hace? trae los PEDIDOS que estan relacionados con este item de rm
                    ( SELECT    SUM(ISNULL(DetallePedidos.Cantidad, 0))
                      FROM      DetallePedidos
                      WHERE     DetallePedidos.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( DetallePedidos.Cumplido IS NULL
                                      OR DetallePedidos.Cumplido <> 'AN'
                                    )
                    ),
                    0,
                    0,
                    0,
                    0
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo



--Las RECEPCIONES (el detalle)
    INSERT  INTO #Auxiliar2
            SELECT  DetReq.IdDetalleRequerimiento,
                    0,
                    ( SELECT    SUM(ISNULL(DetRec.CantidadCC, 0))
                      FROM      DetalleRecepciones DetRec
                                LEFT OUTER JOIN Recepciones ON Recepciones.IdRecepcion = DetRec.IdRecepcion
                      WHERE     DetRec.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ISNULL(Recepciones.Anulada, 'NO') <> 'SI'
                                AND ISNULL(DetRec.IdDetalleSalidaMateriales, 0) = 0
                    ),
                    0,
                    0,
                    0
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo





--Los VALES
    INSERT  INTO #Auxiliar2
            SELECT  DetReq.IdDetalleRequerimiento,
                    0,
                    0,
                    ( SELECT    SUM(ISNULL(DetalleValesSalida.Cantidad, 0))
                      FROM      DetalleValesSalida
                      WHERE     DetalleValesSalida.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ( DetalleValesSalida.Estado IS NULL
                                      OR DetalleValesSalida.Estado <> 'AN'
                                    )
                    ),
                    0,
                    0
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo



--trae el STOCK
    INSERT  INTO #Auxiliar2
            SELECT  DetReq.IdDetalleRequerimiento,
                    0,
                    0,
                    CASE WHEN ISNULL(Articulos.RegistrarStock, 'SI') = 'SI'
                         THEN ( SELECT  SUM(ISNULL(Stock.CantidadUnidades, 0))
                                FROM    Stock
                                        LEFT OUTER JOIN Ubicaciones ON Stock.IdUbicacion = Ubicaciones.IdUbicacion
                                WHERE   DetReq.IdArticulo = Stock.IdArticulo
                              )
                         ELSE NULL
                    END,
                    0,
                    0
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo


--RECEPCIONES (el encabezado)
    INSERT  INTO #Auxiliar2
            SELECT  DetReq.IdDetalleRequerimiento,
                    0,
                    0,
                    ( SELECT TOP 1
                                DetRec.IdDetalleRecepcion
                      FROM      DetalleRecepciones DetRec
                                LEFT OUTER JOIN Recepciones ON DetRec.IdRecepcion = Recepciones.IdRecepcion
                      WHERE     DetRec.IdDetalleRequerimiento = DetReq.IdDetalleRequerimiento
                                AND ISNULL(Recepciones.Anulada, 'NO') <> 'SI'
                                AND ISNULL(DetRec.IdDetalleSalidaMateriales, 0) = 0
                      ORDER BY  Recepciones.NumeroRecepcionAlmacen DESC
                    ),
                    0,
                    0
            FROM    DetalleRequerimientos DetReq
                    LEFT OUTER JOIN Requerimientos ON DetReq.IdRequerimiento = Requerimientos.IdRequerimiento
                    LEFT OUTER JOIN Articulos ON DetReq.IdArticulo = Articulos.IdArticulo





--////////////////////////////////

    DELETE  _Temp_Requerimientos_TX_PendientesDeAsignar


    INSERT  INTO _Temp_Requerimientos_TX_PendientesDeAsignar
            SELECT  IdDetalleRequerimiento,
                    SUM(CantidadPedida) AS CantidadPedida,
                    SUM(CantidadRecibida) AS CantidadRecibida,
                    SUM(CantidadVales) AS CantidadVales,
                    SUM(CantidadEnStock) AS CantidadEnStock,
                    IdDetalleRecepcion
            FROM    #Auxiliar2
            GROUP BY IdDetalleRequerimiento,
                    IdDetalleRecepcion
            ORDER BY IdDetalleRequerimiento




GO
/****** Object:  StoredProcedure [dbo].[wDetProveedoresContactos_TT]    Script Date: 10/17/2012 11:13:40 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[wDetProveedoresContactos_TT] @IdProveedor INT
AS 
    SELECT  Det.*
    FROM    DetalleProveedores Det
            LEFT OUTER JOIN Proveedores ON Proveedores.IdProveedor = Det.IdProveedor
    WHERE   Det.IdProveedor = @IdProveedor


GO
/****** Object:  View [dbo].[wVistaPedidos]    Script Date: 10/17/2012 11:13:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[wVistaPedidos]
as	


    --CREATE TABLE #Auxiliar0
    --    (
    --      IdPedido INTEGER,
    --      Requerimientos VARCHAR(100),
    --      Obras VARCHAR(100)
    --    )

    --CREATE TABLE #Auxiliar1
    --    (
    --      IdPedido INTEGER,
    --      NumeroRequerimiento INTEGER,
    --      NumeroObra VARCHAR(13),
    --      SAT VARCHAR(1)
    --    )
    --INSERT  INTO #Auxiliar1
    --        SELECT  DetPed.IdPedido,
    --                CASE WHEN Requerimientos.NumeroRequerimiento IS NOT NULL
    --                     THEN Requerimientos.NumeroRequerimiento
    --                     ELSE Acopios.NumeroAcopio
    --                END,
    --                Obras.NumeroObra,
    --                CASE WHEN DetalleRequerimientos.IdOrigenTransmision IS NOT NULL
    --                     THEN 'S'
    --                     ELSE ''
    --                END
    --        FROM    DetallePedidos DetPed
    --                LEFT OUTER JOIN DetalleAcopios ON DetPed.IdDetalleAcopios = DetalleAcopios.IdDetalleAcopios
    --                LEFT OUTER JOIN Acopios ON DetalleAcopios.IdAcopio = Acopios.IdAcopio
    --                LEFT OUTER JOIN DetalleRequerimientos ON DetPed.IdDetalleRequerimiento = DetalleRequerimientos.IdDetalleRequerimiento
    --                LEFT OUTER JOIN Requerimientos ON DetalleRequerimientos.IdRequerimiento = Requerimientos.IdRequerimiento
    --                LEFT OUTER JOIN Obras ON Requerimientos.IdObra = Obras.IdObra
    --        WHERE   @IdPedido = -1
    --                OR DetPed.IdPedido = @IdPedido




    SELECT  Pedidos.*,
            '' AS [RMs],
            '' AS [Obras],
            Proveedores.RazonSocial AS [Proveedor],
            CASE WHEN TotalIva2 IS NULL
                 THEN TotalPedido - TotalIva1 + Bonificacion
                 ELSE TotalPedido - TotalIva1 - TotalIva2 + Bonificacion
            END AS [NetoGravado],
            Monedas.Abreviatura AS [Moneda],
            E1.Nombre AS [Comprador],
            E2.Nombre AS [Libero],
            ( SELECT    COUNT(*)
              FROM      DetallePedidos
              WHERE     DetallePedidos.IdPedido = Pedidos.IdPedido
            ) AS [CantidadItems],
            PedidosAbiertos.NumeroPedidoAbierto AS [PedidoAbierto],
            ( SELECT TOP 1
                        A.Descripcion
              FROM      Articulos A
              WHERE     A.IdArticulo = ( SELECT TOP 1
                                                Requerimientos.IdEquipoDestino
                                         FROM   DetalleRequerimientos DR
                                                LEFT OUTER JOIN Requerimientos ON Requerimientos.IdRequerimiento = DR.IdRequerimiento
                                         WHERE  DR.IdDetalleRequerimiento = ( SELECT TOP 1
                                                                                        DP.IdDetalleRequerimiento
                                                                              FROM      DetallePedidos DP
                                                                              WHERE     DP.IdPedido = Pedidos.IdPedido
                                                                                        AND DP.IdDetalleRequerimiento IS NOT NULL
                                                                            )
                                       )
            ) AS [EquipoDestino],
            cc.Descripcion AS [CondicionCompra],
  Pedidos.FechaSalida as [Fecha salida],

 Case When TotalIva1=0 Then Null Else TotalIva1 End as [Total Iva],
 IsNull(Pedidos.ImpuestosInternos,0)+IsNull(Pedidos.OtrosConceptos1,0)+IsNull(Pedidos.OtrosConceptos2,0)+
	IsNull(Pedidos.OtrosConceptos3,0)+IsNull(Pedidos.OtrosConceptos4,0)+IsNull(Pedidos.OtrosConceptos5,0)as [Otros Conceptos],
 TotalPedido as [Total pedido],
 E2.Nombre as [Liberado por],
 PedidosAbiertos.NumeroPedidoAbierto as [Pedido abierto],
 Pedidos.NumeroLicitacion as [Nro.Licitacion],
 --Pedidos.Impresa as [Impresa],
 Pedidos.UsuarioAnulacion as [Anulo],
 Pedidos.FechaAnulacion as [Fecha anulacion],
 Pedidos.MotivoAnulacion as [Motivo anulacion],
 Pedidos.ImpuestosInternos as [Imp.Internos],
 (Select Top 1 A.Descripcion From Articulos A 
	Where A.IdArticulo=(Select Top 1 Requerimientos.IdEquipoDestino 
				From DetalleRequerimientos DR
				Left Outer Join Requerimientos On Requerimientos.IdRequerimiento=DR.IdRequerimiento
				Where DR.IdDetalleRequerimiento=(Select Top 1 DP.IdDetalleRequerimiento 
								 From DetallePedidos DP 
								 Where DP.IdPedido=Pedidos.IdPedido and 
									DP.IdDetalleRequerimiento is not null))) as [Equipo destino],
 Pedidos.CircuitoFirmasCompleto as [Circuito de firmas completo],
 '' as [Condicion IVA]
 --DescripcionIva.Descripcion as [Condicion IVA]
           
    FROM    Pedidos
            LEFT OUTER JOIN Proveedores ON Pedidos.IdProveedor = Proveedores.IdProveedor
            LEFT OUTER JOIN Monedas ON Pedidos.IdMoneda = Monedas.IdMoneda
            LEFT OUTER JOIN PedidosAbiertos ON Pedidos.IdPedidoAbierto = PedidosAbiertos.IdPedidoAbierto
--            LEFT OUTER JOIN #Auxiliar0 ON Pedidos.IdPedido = #Auxiliar0.IdPedido
            LEFT OUTER JOIN Empleados E1 ON Pedidos.IdComprador = E1.IdEmpleado
            LEFT OUTER JOIN Empleados E2 ON Pedidos.Aprobo = E2.IdEmpleado
            LEFT OUTER JOIN [Condiciones Compra] cc ON Pedidos.IdCondicionCompra = cc.IdCondicionCompra



GO
/****** Object:  UserDefinedFunction [dbo].[wExistenciasCartaPorteMovimientos]    Script Date: 10/17/2012 11:13:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[wExistenciasCartaPorteMovimientos]
(
	@Fecha datetime,
	@IdArticulo int, 
	@IdDestinoPuerto int
)

RETURNS INT
AS
BEGIN


	RETURN 0

END


GO
/****** Object:  UserDefinedFunction [dbo].[wFuncionBusqueda]    Script Date: 10/17/2012 11:13:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION wFuncionBusqueda (@q VARCHAR(50))



RETURNS TABLE AS
RETURN (

--si sacas los ORDER, parece que no anda en SQL2000/5
--si sacas los ORDER, parece que no anda en SQL2000/5
--si sacas los ORDER, parece que no anda en SQL2000/5

--ademas, el order DESC debiera ser por FechaModificacion!, y no por Id (aunque se parecerán)


	SELECT TOP 100 IdCliente as ID,isnull(Cuit,'') +' ' + isnull(RazonSocial  COLLATE Modern_Spanish_ci_as,'')  as Numero
				,'Cliente' AS Tipo,  FechaAlta as fecha,
				isnull(Telefono,'') + CHAR(13)+CHAR(10) + isnull(Email,'') as item1 
	FROM dbo.Clientes 
	WHERE  	-- http://stackoverflow.com/questions/156954/search-for-words-in-sql-server-index
			RazonSocial like '%[^A-z^0-9]' + @q + '%' -- In the middle of a sentence
			OR RazonSocial like  @q + '%'            -- At the beginning of a sentence


		   or 
		   Cuit LIKE @q+'%'  
		   or 
		   isnull(Cuit,'') +' ' + isnull(RazonSocial COLLATE Modern_Spanish_ci_as,'') LIKE @q+'%' 

	UNION

	SELECT TOP 100 IdCartaDePorte as ID, 
				CAST(NumeroCartaDePorte as varchar(100))+' ' + CAST(NumeroSubFijo as varchar) + '-'+ CAST(SubNumeroVagon as varchar) as Numero,
			'Carta de porte' AS Tipo, FechaModificacion as fecha
				, '...........con.arribo.el.' +  CONVERT(VARCHAR(8), FechaArribo, 3) AS item1

	FROM dbo.CartasDePorte 
	WHERE  
			isnull(SubNumeroDeFacturacion,0)<=0 
			AND
			(
			NumeroCartaDePorte LIKE @q+'%'
			OR
		   SubNumeroVagon LIKE @q+'%'
		   OR
		   CAST(NumeroCartaDePorte as varchar(100))+' ' + CAST(NumeroSubFijo as varchar) + '-'+ CAST(SubNumeroVagon as varchar)   LIKE @q+'%' 
		   )

	--UNION


	--SELECT TOP 100 IdAsiento as ID,CAST(NumeroAsiento as varchar(100)),'Asiento' AS Tipo, asientos.FechaAsiento as fecha
	--			, '' as item1
	--FROM dbo.Asientos 
	--WHERE  asientos.NumeroAsiento LIKE @q+'%'
	----ORDER BY fechaasiento desc   --si sacas los ORDER, parece que no anda en SQL2000/5

	--UNION

	--SELECT TOP 100 IdComprobanteProveedor as ID,CAST(NumeroComprobante2 as varchar(100)),'Cmpbte proveedor' AS Tipo, FechaComprobante as fecha
	--			, '' as item1
	--FROM dbo.ComprobantesProveedores
	--WHERE  NumeroComprobante2 LIKE @q+'%'
	----ORDER BY IdComprobanteProveedor desc

	UNION

	SELECT TOP 100 IdRequerimiento,CAST(NumeroRequerimiento  as varchar(100)),'Requerimiento' AS Tipo, FechaRequerimiento as fecha
				, '' as item1
	FROM requerimientos
	WHERE NumeroRequerimiento LIKE @q+'%'
	ORDER BY IdRequerimiento desc --si sacas los ORDER, parece que no anda en SQL2000/5

	UNION

	SELECT TOP 100 IdArticulo,CAST(Descripcion  as varchar(100)),'Articulo' AS Tipo, FechaAlta as fecha
				, '' as item1
	FROM Articulos
	WHERE codigo LIKE @q+'%'or
		  Descripcion LIKE @q+'%' or
		  Descripcion like '%[^A-z^0-9]' + @q + '%' -- In the middle of a sentence
	ORDER BY IdArticulo desc --si sacas los ORDER, parece que no anda en SQL2000/5

	--UNION

	--SELECT TOP 100 IdPedido,CAST(NumeroPedido  as varchar(100)),'Pedido' AS Tipo,FechaPedido as fecha
	--			, '' as item1
	--FROM pedidos
	--WHERE NumeroPedido LIKE @q+'%'
	----ORDER BY IdPedido desc

	UNION

	SELECT TOP 100 IdFactura,CAST(NumeroFactura  as varchar(100)),'Factura' AS Tipo, FechaFactura as fecha
				, '' as item1
	FROM dbo.Facturas
	WHERE NumeroFactura LIKE @q+'%'
	ORDER BY IdFactura desc

	--UNION

	--SELECT TOP 100 IdRemito,CAST(NumeroRemito as varchar(100)),'Remito' AS Tipo, FechaRemito as fecha
	--			, '' as item1
	--FROM remitos
	--WHERE NumeroRemito LIKE @q+'%'
	----ORDER BY IdRemito desc--si sacas los ORDER, parece que no anda en SQL2000/5


	--UNION

	--SELECT TOP 100 IdSalidaMateriales,CAST(NumeroSalidaMateriales as varchar(100)),'Salida de materiales' AS Tipo, FechaSalidaMateriales
	--			, '' as item1
	--FROM salidasmateriales
	--WHERE NumeroSalidaMateriales LIKE @q+'%'
	----ORDER BY IdSalidaMateriales desc--si sacas los ORDER, parece que no anda en SQL2000/5

	--UNION

	--SELECT TOP 100 IdRecepcion,CAST(NumeroRecepcion2 as varchar(100)),'Recepción' AS Tipo,FechaRecepcion
	--			, '' as item1
	--FROM Recepciones
	--WHERE NumeroRecepcion2 LIKE @q+'%'
	----ORDER BY IdRecepcion desc--si sacas los ORDER, parece que no anda en SQL2000/5

	--UNION

	--SELECT TOP 100 IdOrdenPago,  CAST(NumeroOrdenPago as varchar(100)),'Orden de pago' AS Tipo, FechaOrdenPago
	--			, '' as item1
	--FROM  dbo.OrdenesPago
	--WHERE NumeroOrdenPago LIKE @q+'%'
	----ORDER BY IdOrdenPago desc--si sacas los ORDER, parece que no anda en SQL2000/5

               ) 

               

GO
/****** Object:  UserDefinedFunction [dbo].[wTarifaWilliams]    Script Date: 10/17/2012 11:13:41 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION [dbo].[wTarifaWilliams]
(
	@idCliente int,
	@IdArticulo int, 
	@IdDestino int,
	
	@TipoTarifa int=NULL   -- 0 normal (default)/ 1 exportacion / 2 embarque
)

RETURNS money
AS
BEGIN

SET @TipoTarifa = ISNULL(@TipoTarifa, 0)

declare @idlistaPrecio int
declare @Precio money
declare @PrecioRepetidoPeroConPrecision money
declare @PrecioExportacion money
declare @PrecioEmbarque money
	
            SELECT TOP 1 @idlistaPrecio=idListaPrecios FROM Clientes WHERE idCliente=@idCliente

            --If dt1.Rows.Count > 0 Then
            --    idlistaPrecio = iisNull(dt1.Rows(0).Item("idListaPrecios"), 0)
            --    If idlistaPrecio = 0 Then Return 0
            --Else
            --    Return 0
            --End If


			SELECT TOP 1 @Precio=precio,@PrecioRepetidoPeroConPrecision=PrecioRepetidoPeroConPrecision
						,@PrecioExportacion=PrecioExportacion, @PrecioEmbarque=PrecioEmbarque
			FROM ListasPreciosDetalle
			WHERE idListaPrecios=@idlistaPrecio AND idArticulo=@idArticulo
						 AND (ISNULL(IdDestinoDeCartaDePorte,0)=@idDestino OR IdDestinoDeCartaDePorte IS NULL)
			ORDER BY IdDestinoDeCartaDePorte DESC

            --If dt.Rows.Count > 0 Then
            --    Tarifa = iisNull(dt.Rows(0).Item("PrecioRepetidoPeroConPrecision"), ArticuloManager.GetItem(SC, idArticulo).CostoPPP)
            --    If Tarifa = 0 Then
            --        Tarifa = iisNull(dt.Rows(0).Item("Precio"), ArticuloManager.GetItem(SC, idArticulo).CostoPPP)
            --    End If
            --Else
            --    Tarifa = 0
            --End If

			if @TipoTarifa=1 begin return @PrecioExportacion end
			if @TipoTarifa=2 begin return @PrecioEmbarque end

			return isnull(@PrecioRepetidoPeroConPrecision,@Precio)



end
						

GO
